<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1761810060">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Book_8054_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Enhancement"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Enhancement</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Enhancement"> <strong>Summary</strong><br>Add robust multi-file save. When the user requests "Save all tables" under a common prefix (e.g. <code>Book_8052</code>), the client saves each table as a separate Markdown file (<code>Book_8052_01.md</code>, <code>Book_8052_02.md</code>, ...) into the server <code>STORAGE_PATH</code>. Files are written atomically and indexed for later loading by prefix.                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Enhancement"> <strong>Goal</strong><br>Produce reproducible per-table <code>.md</code> files. Support bulk save in one action. Avoid overwrites. Make files discoverable by the list/loader.                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Enhancement"> <strong>New/Updated Endpoints</strong><br><code>POST /save-md</code> (extended): accepts single <code>{ markdown, filename }</code> or batch <code>{ prefix, tables: [{ markdown }, ...], start_index?: number }</code>. <code>GET /saved/index</code> returns file list. <code>GET /saved/&lt;file&gt;</code> unchanged.                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Enhancement"> <strong>Batch Payload (client → server)</strong><br>Preferred JSON: <code>{ &quot;prefix&quot;:&quot;Book_8052&quot;, &quot;tables&quot;:[ {&quot;markdown&quot;:&quot;...&quot;} , {&quot;markdown&quot;:&quot;...&quot;} ], &quot;start_index&quot;: null }</code>. Form/multipart also supported but JSON preferred for batch.                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Enhancement"> <strong>Server Response (batch success)</strong><br><code>201 Created</code> JSON: <code>{ &quot;ok&quot;: true, &quot;saved&quot;: [ &quot;Book_8052_01.md&quot;,&quot;Book_8052_02.md&quot; ], &quot;ids&quot;:[ &quot;...&quot;, &quot;...&quot; ] }</code>. Partial success returns <code>207 Multi-Status</code> or <code>200</code> with per-file status objects.                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Enhancement"> <strong>Filename scheme</strong><br><code>&lt;safe_prefix&gt;_&lt;NN&gt;.md</code> where <code>NN</code> is zero-padded to 2 digits (<code>01</code>, <code>02</code>, ...). Prefix sanitized via <code>secure_filename</code> and validated (max 32 chars, allowed chars <code>[A-Za-z0-9_\- ]</code> after sanitization).                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Enhancement"> <strong>Indexing & start index</strong><br>Server scans <code>STORAGE_PATH</code> for existing names with same prefix to compute next available index. <code>start_index</code> optional to override. Ensures no overwrite.                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Enhancement"> <strong>Atomic write</strong><br>Write each file to a temp file in the same directory then <code>os.replace(tmp, dest)</code> to guarantee atomic commit. Set file permissions to <code>0o644</code>.                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Enhancement"> <strong>Collision handling</strong><br>If computed filename exists despite checks, append <code>-&lt;uuid4hex&gt;</code> before <code>.md</code> or increment index further. Server returns final filenames to client.                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Enhancement"> <strong>Validation rules</strong><br>Reject invalid prefix (empty, length >32, or contains path separators) with <code>400</code>. Reject empty table content with <code>400</code> or skip with warning. Enforce <code>MAX_PASTE_SIZE</code> per-table in bytes.                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Enhancement"> <strong>Security checks</strong><br>Use <code>secure_filename</code>. Resolve <code>dest_abspath</code> and ensure <code>commonpath([storage_abs, dest_abspath]) == storage_abs</code>. Do not accept absolute paths. Limit accepted extensions to <code>.md</code>.                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Enhancement"> <strong>Error codes & semantics</strong><br><code>201</code> success; <code>207</code> partial; <code>400</code> bad request; <code>413</code> payload too large; <code>403</code> or <code>500</code> for write errors. Responses include per-file <code>ok</code>/<code>error</code> details.                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Enhancement"> <strong>Logs & audit</strong><br>Log each file saved: uid, final filename, size in bytes, client IP, timestamp. Log skipped/failed entries with stack traces at DEBUG/ERROR level.                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Enhancement"> <strong>Client behavior (save.js)</strong><br>Detect multiple tables in DOM (selectors like <code>.tv-table</code> or <code>.table-container</code>). Build <code>tables</code> array of markdown per table. Prompt for prefix if not provided. POST batch JSON to <code>/save-md</code>. On response show per-file toast and update status.                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Enhancement"> <strong>Fallback client behavior</strong><br>If server does not accept batch, fallback to sequential single-file saves: call <code>/save-md</code> per-table with suggested generated filenames. Retry up to N times on transient network errors.                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Enhancement"> <strong>Integration with list/loader</strong><br>Saved files appear under <code>GET /saved/index</code>. Client groups files by first 9 chars. Loader uses prefix group to fetch all files and auto-convert.                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Enhancement"> <strong>Testing checklist</strong><br>1. Create 3 tables in UI; choose prefix <code>Book_8052</code>; click Save All.  <br>2. Verify <code>Book_8052_01.md</code>..<code>_03.md</code> exist.  <br>3. Call <code>GET /saved/index</code> returns names and URLs.  <br>4. Select prefix in UI list → paste receives concatenated markdown; auto-convert runs.  <br>5. Re-save same prefix → new files start at next index.  <br>6. Test large table > MAX_PASTE_SIZE → expect <code>413</code>.  <br>7. Test invalid prefix <code>../foo</code> → expect <code>400</code>.  <br>8. Simulate disk full/perm error → server returns error and no partial files left uncommitted (atomic). </td></tr><tr><td data-label="Enhancement"> <strong>Performance & limits</strong><br>Enforce <code>MAX_PASTE_SIZE</code> per table. Recommend server limit for directory listing (default 1000). For >100 tables client should upload in chunks to avoid long blocking operations.                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Enhancement"> <strong>Observability & metrics</strong><br>Track counts: batch saves/sec, files written, avg file size, save error rate. Emit logs for audit and troubleshooting.                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Enhancement"> <strong>Rollback & safety</strong><br>If batch partially fails, server leaves successfully written files and returns per-file statuses. Client surfaces which files failed and allows retry. Full rollback requires transactional filesystem or archive step; not implemented.                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Enhancement"> <strong>Backward compatibility</strong><br>Single-file saves (<code>{markdown,filename}</code>) continue to work unchanged. Batch activated only when <code>tables</code> array present.                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Enhancement"> <strong>Migration notes</strong><br>No DB changes. Existing naming conventions still supported. Existing loaders that group by first 9 chars continue to work.                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Enhancement"> <strong>Dev plan & code pointers</strong><br>Implement server-side loop in <code>save_md()</code> that: validate prefix, compute next index, write each table atomically, collect results, return JSON. Add unit tests for edge cases and permission failures. Update <code>script.save.js</code> to detect multiple tables and call batch API.                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Enhancement"> <strong>Next immediate action</strong><br>I will produce exact patched <code>save_md()</code> server code and updated <code>assets/script.save.js</code> batch logic ready to paste if you confirm or request changes.                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr></tbody></table></div><div class="row-count">Rows: 24</div></div><div class="table-caption" id="Table2" data-table="Book_8054_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by #"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">#</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Cause"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Cause</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by What happens"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">What happens</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Fix"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Fix</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="#"> <strong>1</strong> </td><td data-label="Cause"> The DOM doesn’t actually contain multiple <code>&lt;table&gt;</code> elements when the save button is clicked </td><td data-label="What happens"> <code>collectTablesFromDOM()</code> returns 0 or 1 → script goes to single-save path                                               </td><td data-label="Fix"> Inspect DOM: <code>document.querySelectorAll(&#x27;table&#x27;).length</code> should be ≥ 2 before clicking <strong>Save</strong>                                        </td></tr><tr><td data-label="#"> <strong>2</strong> </td><td data-label="Cause"> Tables exist, but they’re <em>nested inside</em> one container or shadow DOM                        </td><td data-label="What happens"> The code explicitly avoids nested duplicates (<code>if (nodes[k].contains(el)) skip = true</code>)                                 </td><td data-label="Fix"> Flatten your markup: ensure each <code>&lt;table&gt;</code> you expect to save is a top-level table, not inside another <code>&lt;table&gt;</code>                       </td></tr><tr><td data-label="#"> <strong>3</strong> </td><td data-label="Cause"> Core script replaced or re-attached its own handler first                                    </td><td data-label="What happens"> Core’s <code>data-__tv_save_attached</code> prevents <code>script.save.js</code> attaching → your button runs core’s “single-save” logic only </td><td data-label="Fix"> Check in console: <code>document.getElementById(&#x27;saveBtn&#x27;).dataset</code> should show <code>__ptt_save_md_attached</code>, <strong>not only</strong> <code>__tv_save_attached</code> </td></tr><tr><td data-label="#"> <strong>4</strong> </td><td data-label="Cause"> <code>window.__tv_utils.tableToMarkdownLines</code> missing or broken                                   </td><td data-label="What happens"> <code>tableDomToMarkdown()</code> fails silently → collected tables array ends empty → falls back to single save                   </td><td data-label="Fix"> Open console → <code>window.__tv_utils</code> should exist and contain <code>tableToMarkdownLines</code>                                                     </td></tr><tr><td data-label="#"> <strong>5</strong> </td><td data-label="Cause"> You’re triggering <code>window.PTT_SAVE.save()</code> directly instead of clicking the button           </td><td data-label="What happens"> That API defaults to single-file save unless you pass <code>{ tables: [...] }</code>                                               </td><td data-label="Fix"> Call: <br><code>window.PTT_SAVE.save({ tables: collectTablesFromDOM(), prefix:&#x27;Book_8052&#x27; })</code>                                               </td></tr><tr><td data-label="#"> <strong>6</strong> </td><td data-label="Cause"> The user cancelled the batch prompts                                                         </td><td data-label="What happens"> Cancelling prefix prompt resets to single                                                                               </td><td data-label="Fix"> Confirm you click <strong>OK</strong> in both confirm & prompt dialogs                                                                              </td></tr></tbody></table></div><div class="row-count">Rows: 6</div></div><div class="table-caption" id="Table3" data-table="Book_8054_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by File"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">File</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Role"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Role</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by What can break multi-save"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">What can break multi-save</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by What to inspect"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">What to inspect</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="File"> <strong>assets/script.save.js</strong> </td><td data-label="Role"> Detect & send batch             </td><td data-label="What can break multi-save"> Only sends single-file JSON (<code>{markdown, filename}</code>) </td><td data-label="What to inspect"> Browser Network tab → check JSON payload                        </td></tr><tr><td data-label="File"> <strong>server.py</strong>             </td><td data-label="Role"> Receive batch & write per table </td><td data-label="What can break multi-save"> Ignores <code>tables</code> key or overwrites same filename     </td><td data-label="What to inspect"> Look for <code>for t in data[&quot;tables&quot;]:</code> loop in <code>/save-md</code> endpoint </td></tr></tbody></table></div><div class="row-count">Rows: 2</div></div><div class="table-caption" id="Table4" data-table="Book_8054_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Enhancement"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Enhancement</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Enhancement"> <strong>Overview:</strong> Fix client-side save.js to correctly handle multiple tables in DOM for batch save. </td></tr><tr><td data-label="Enhancement"> <strong>Detect multiple tables:</strong> Use selectors <code>.tv-table</code> or <code>.table-container</code> to build <code>tablesArray</code>. </td></tr><tr><td data-label="Enhancement"> <strong>User prompt:</strong> Ask for prefix once if multiple tables detected. </td></tr><tr><td data-label="Enhancement"> <strong>Batch save:</strong> Call <code>doSaveAction({ tables: tablesArray, prefix: userPrefix })</code> instead of single-file save. </td></tr><tr><td data-label="Enhancement"> <strong>Skip fallback:</strong> Ensure single-file fallback is not triggered when batch is active. </td></tr><tr><td data-label="Enhancement"> <strong>onSaveButtonClick fix:</strong> Integrate detection, prompt, and batch call logic before any single-file save logic. </td></tr><tr><td data-label="Enhancement"> <strong>Toast/status update:</strong> After batch save, display per-file confirmation messages and update UI status. </td></tr><tr><td data-label="Enhancement"> <strong>Optional:</strong> Retain single-file save behavior only if <code>tablesArray.length === 1</code>. </td></tr><tr><td data-label="Enhancement"> <strong>Result:</strong> Users saving multiple tables will now get one Markdown file per table with proper indexed filenames without modifying server code. </td></tr></tbody></table></div><div class="row-count">Rows: 9</div></div><div class="table-caption" id="Table5" data-table="Book_8054_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Explanation"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Explanation</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Explanation"> <strong>Enhancement summary</strong><br>Multi-file batch save per group/prefix. Client generates separate Markdown files for each table using <code>&lt;prefix&gt;_&lt;NN&gt;.md</code> scheme. Conceptually sound. </td></tr><tr><td data-label="Explanation"> <strong>Goal</strong><br>Reproducible per-table <code>.md</code>, bulk save, avoid overwrites, discoverable by list/loader. Clear and achievable. </td></tr><tr><td data-label="Explanation"> <strong>Endpoints</strong><br>POST <code>/save-md</code> extended for single or batch; GET <code>/saved/index</code> for listing; GET <code>/saved/&lt;file&gt;</code> unchanged. API backwards-compatible. </td></tr><tr><td data-label="Explanation"> <strong>Batch payload</strong><br>JSON preferred: <code>{ &quot;prefix&quot;:&quot;Book_8052&quot;, &quot;tables&quot;:[{&quot;markdown&quot;:...}, ...], &quot;start_index&quot;:null }</code>. Simple, structured, extensible. </td></tr><tr><td data-label="Explanation"> <strong>Server response</strong>201 for full success, 207 or 200 with per-file status for partial. Returns filenames and IDs. Provides full client feedback. </td></tr><tr><td data-label="Explanation"> <strong>Filename scheme</strong><br><code>&lt;safe_prefix&gt;_&lt;NN&gt;.md</code>, zero-padded 2 digits, sanitized to allowed chars, max 32. Avoids collisions. </td></tr><tr><td data-label="Explanation"> <strong>Indexing & start index</strong><br>Server scans existing files with same prefix to compute next index. Optional <code>start_index</code> to override. Prevents overwrites. </td></tr><tr><td data-label="Explanation"> <strong>Atomic write</strong><br>Temp file + <code>os.replace(tmp,dest)</code>, perms <code>0o644</code>. Guarantees atomic commit; avoids partial writes. </td></tr><tr><td data-label="Explanation"> <strong>Collision handling</strong><br>Append <code>-&lt;uuid4hex&gt;</code> or increment index if filename exists. Ensures uniqueness. </td></tr><tr><td data-label="Explanation"> <strong>Validation rules</strong><br>Reject invalid prefix (>32, empty, path separators), empty tables, per-table MAX_PASTE_SIZE. Robust input validation. </td></tr><tr><td data-label="Explanation"> <strong>Security checks</strong><br><code>secure_filename</code>, ensure path within storage, limit extensions to <code>.md</code>. Avoids path traversal and unauthorized writes. </td></tr><tr><td data-label="Explanation"> <strong>Error codes & semantics</strong>201 success, 207 partial, 400 bad request, 413 payload too large, 403/500 for write errors. Per-file details included. Clear, consistent. </td></tr><tr><td data-label="Explanation"> <strong>Logs & audit</strong><br>Log uid, filename, size, IP, timestamp, skipped/failed entries at DEBUG/ERROR. Sufficient observability. </td></tr><tr><td data-label="Explanation"> <strong>Client behavior</strong><br>Detect multiple tables (<code>.tv-table</code> or <code>.table-container</code>), build array, prompt prefix, POST batch JSON, show per-file toast, update status. User-friendly, integrates with existing workflow. </td></tr><tr><td data-label="Explanation"> <strong>Fallback client behavior</strong><br>Sequential single-file saves if batch unsupported; retry on network errors. Maintains backward compatibility. </td></tr><tr><td data-label="Explanation"> <strong>Integration with list/loader</strong><br>Saved files appear in <code>/saved/index</code>, grouped by prefix; loader fetches by prefix to auto-convert. Fits existing loader model. </td></tr><tr><td data-label="Explanation"> <strong>Testing checklist</strong><br>Covers creation, indexing, GET index, auto-convert, retries, large table, invalid prefix, disk/permission errors, atomicity. Thorough coverage. </td></tr><tr><td data-label="Explanation"> <strong>Performance & limits</strong><br>MAX_PASTE_SIZE per table; directory listing limit 1000; >100 tables uploaded in chunks. Prevents blocking & large payload issues. </td></tr><tr><td data-label="Explanation"> <strong>Observability & metrics</strong><br>Track batch saves/sec, files written, avg file size, error rate. Supports monitoring. </td></tr><tr><td data-label="Explanation"> <strong>Rollback & safety</strong><br>Partial batch failure leaves successful files; per-file statuses returned; full rollback optional (not implemented). Safe and predictable. </td></tr><tr><td data-label="Explanation"> <strong>Backward compatibility</strong><br>Single-file saves continue to work unchanged; batch only triggered when <code>tables</code> array present. No breaking changes. </td></tr><tr><td data-label="Explanation"> <strong>Migration notes</strong><br>No DB changes; existing naming conventions preserved; loader grouping continues to work. Minimal disruption. </td></tr><tr><td data-label="Explanation"> <strong>Dev plan & code pointers</strong><br>Server-side: validate prefix, compute index, atomic write per table, return JSON. Client-side: detect multiple tables, call batch API. Unit tests for edge cases. Clear implementation path. </td></tr><tr><td data-label="Explanation"> <strong>Next immediate action</strong><br>Prepare patched <code>save_md()</code> server code and updated <code>script.save.js</code> batch logic, ready for production integration. Sequential step confirmed. </td></tr></tbody></table></div><div class="row-count">Rows: 24</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>