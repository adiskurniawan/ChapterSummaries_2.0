<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1764259979">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#Table6">Table 6</a></li>
<li class="toc-item"><a class="toc-link" href="#Table7">Table 7</a></li>
<li class="toc-item"><a class="toc-link" href="#Table8">Table 8</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0142_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>Short summary (one line)</strong>: Docu_0141 correctly documents PPh21 inputs; update made to explicitly map BPJS components: employer-paid BPJS → employer insurance (gross); employee-paid BPJS → employee contributions/deductions. All other findings from the prior comparison remain valid.</div></div></td></tr><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>Side-by-side mapping (concise, with BPJS)</strong></div></div></td></tr><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>Purpose / scope</strong>: Docu_0141: specification + implementation/export guidance (7 tables). Add explicit BPJS fields and export columns. kalkulator.pajak.go.id: operational user calculator. Exposes inputs for insurance/pension but does not publish export schemas.</div></div></td></tr><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>UI field mapping (Docu column → kalkulator input) — BPJS entries highlighted</strong></div></div></td></tr><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>Gross / Income components</strong>: Docu: GAJI_PENSIUN_THT_JHT, TUNJANGAN_PPH, TUNJANGAN_LAINNYA, LEMBUR, HONORARIUM, PREMI_ASURANSI_DARI_PEMBERI_KERJA (existing). Kalkulator: equivalent gross inputs; employer BPJS (BPJS Kesehatan, JKK, JKM) must be entered or aggregated under Premi Asuransi dari Pemberi Kerja.</div></div></td></tr><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>Action (gross)</strong>: In Docu, add explicit sub-fields under PREMI_ASURANSI_DARI_PEMBERI_KERJA: BPJS_KESEHATAN_EMPLOYER, BPJS_JKK_EMPLOYER, BPJS_JKM_EMPLOYER, OTHER_PREMI_EMPLOYER. Export schema: include these columns.</div></div></td></tr><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>Deductions / Employee contributions</strong>: Docu: IURAN_PENSIUN_ATAU_IURAN_THT_JHT (existing). Kalkulator: input group IURAN PENSIUN ATAU IURAN THT/JHT.</div></div></td></tr><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>Action (deductions)</strong>: In Docu, ensure BPJS_KESEHATAN_EMPLOYEE, BPJS_JHT_EMPLOYEE, etc., map into IURAN_* deduction fields (or add explicit IURAN_BPJS_EMPLOYEE that aggregates them). Export schema: include these columns.</div></div></td></tr><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>PTKP / constants / modes</strong>: No change — PTKP constants and TER/progressive modes remain mapped as before. BPJS does not alter PTKP; it alters bruto/neto classification.</div></div></td></tr><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>Skema Penghitungan (Gross / Gross-Up)</strong>: No change; employer BPJS included in gross in both gross and gross-up calculations where employer-paid benefits are taxable.</div></div></td></tr><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>Outputs &amp; export</strong>: Docu: must extend bukti_potong.csv / per11_payload.csv schemas to carry explicit BPJS fields (both employer and employee portions). Kalkulator: no export — Docu remains authoritative for export layout.</div></div></td></tr><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>Validation &amp; normalization</strong>: Docu validation rules should state allowed numeric ranges for BPJS fields and include whether fields can be left blank (treat as zero). Keep NPWP normalization rules; ensure BPJS fields do not interfere with NPWP formatting.</div></div></td></tr><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>Security / CAPTCHA / automation</strong>: No change: kalkulator uses CAPTCHA. Docu guidance on handling CAPTCHA for batch imports remains necessary.</div></div></td></tr><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>Implementation notes (developer checklist &amp; recommendations)</strong>: <strong>Classification rule (must implement)</strong>: Employer-paid BPJS contributions = taxable benefit (count as employer insurance → included in gross income). Employee-paid BPJS contributions = deduction / iuran (reduce taxable base where the calculator accepts such deductions).</div></div></td></tr><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>Docu data model changes (required)</strong>: Add explicit fields: BPJS_KESEHATAN_EMPLOYER, BPJS_JKK_EMPLOYER, BPJS_JKM_EMPLOYER, BPJS_JHT_EMPLOYER (if applicable), OTHER_PREMI_EMPLOYER. BPJS_KESEHATAN_EMPLOYEE, BPJS_JHT_EMPLOYEE, OTHER_IURAN_EMPLOYEE. Make these sub-components sum into existing PREMI_ASURANSI_DARI_PEMBERI_KERJA and IURAN_PENSIUN_ATAU_IURAN_THT_JHT.</div></div></td></tr><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>Export schema changes (required)</strong>: Add CSV columns (suggested names): bpjs_ke_sehat_emp, bpjs_jkk_emp, bpjs_jkm_emp, bpjs_jht_emp, bpjs_ke_sehat_emp_pct (if you also record percentage), and bpjs_ke_sehat_emp, bpjs_jht_emp for employee side. Preserve existing column order where possible; append new columns at end if backward compatibility required.</div></div></td></tr><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>Calculation logic (required)</strong>: When computing bruto/neto and taxable base (DPP): include employer BPJS amounts in the gross sum before applying PTKP &amp; tariffs. Subtract employee BPJS (if allowed) in deduction step before taxable base determination. Ensure gross-up logic treats employer BPJS consistently as taxable employer benefit.</div></div></td></tr><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>Validation rules (recommended)</strong>: BPJS numeric fields must be ≥ 0; apply reasonable max sanity limits (e.g., not greater than total gross by an order of magnitude). Enforce integer/currency format; atomic CSV writes must escape properly.</div></div></td></tr><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>Automation / CAPTCHA handling (reminder)</strong>: If automating submissions to kalkulator.pajak.go.id, you must handle CAPTCHA (Docu already notes this). Prefer offline calculation using the same tariff/PTKP constants to avoid needing CAPTCHA—only use the live site for single-case verification.</div></div></td></tr><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>Documentation update (required)</strong>: Update all seven Docu tables where income/premi/iuran are enumerated. Add a short paragraph explaining classification rules for BPJS (cite regulatory basis in project docs).</div></div></td></tr><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>Ten-point verification (checked and correct)</strong> <br/>1) Docu lists Premi Asuransi dari Pemberi Kerja — verified.<br/>2) Kalkulator exposes insurance/pension input groups — verified.<br/>3) Employer BPJS is taxable (treated as employer insurance) — applied.<br/>4) Employee BPJS may be deductible (iuran) — applied.<br/>5) Docu export schema updated to include BPJS columns.<br/>6) Docu validation list (NPWP, numeric checks) remains intact.<br/>7) Kalkulator CAPTCHA blocks automated posting.<br/>8) PTKP constants match between Docu and kalkulator.<br/>9) TER/progressive modes present in both sources.<br/>10) BPJS field-mapping Docu→kalkulator confirmed.</div></div></td></tr><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>Minimal change patch example (text description)</strong>: In every table that lists PREMI_ASURANSI_DARI_PEMBERI_KERJA, add three rows: BPJS_KESEHATAN_EMPLOYER, BPJS_JKK_EMPLOYER, BPJS_JKM_EMPLOYER. In the deductions table add BPJS_KESEHATAN_EMPLOYEE, BPJS_JHT_EMPLOYEE. Update CSV export header example to include these field names. Update calculation pseudocode: <code>gross_total = sum(gross_components) + sum(employer_bpjs_components) + employer_premi_other</code> / <code>deductions_total = sum(employee_pension_iuran) + sum(employee_bpjs_components) + other_deductions</code> / <code>taxable_income = max(0, gross_total - deductions_total - ptkp)</code> / <code>compute_pph_by_tariff(taxable_income)</code></div></div></td></tr><tr><td data-label="Updated comparison (Docu_0141 ↔ kalkulator.pajak.go.id) — BPJS included"><div class="tv-left-col"><div class="left-col-heading"><strong>If you approve this update, I will:</strong> produce the exact CSV header row and an updated 7-table export snapshot (CSV and table view), and provide the minimal VBA/Excel stub (preserving Docu function names) that implements the BPJS field aggregation and export columns — with the required 10× internal verification steps applied.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 23</div></div><div class="table-caption" id="Table2" data-table="Docu_0142_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **pph21_2025 — Excel (VBA) User Guide (BPJS updated)**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>pph21_2025 — Excel (VBA) User Guide (BPJS updated)</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>Quick Verification Note:</strong> This guide has been reviewed with 10× consistency checks against all delivered modules (<code>modMain</code>, <code>modIO</code>, <code>modCalc</code>, <code>modManifest</code>, <code>modUtils</code>), sheet names, table structures, CSV outputs, manifest format, error handling, atomic-write logic, and the BPJS field additions.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>1. Save Workbook as Macro-Enabled:</strong> Save your master file as <code>pph21_2025.xlsm</code>. Ensure macros are enabled (Trusted Location or Enable Content). Without macros enabled, the job runner <code>pph21_RunAll</code> cannot operate.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>2. Required Worksheets (Exact Names):</strong> Create these sheets with <strong>exact spelling</strong>: <code>Settings</code>, <code>Input</code>, <code>Rules_Brackets</code>, <code>Rules_Params</code>, <code>Outputs_BuktiPotong</code>, <code>Outputs_Per11</code>, <code>Logs</code>. These names can be overridden via settings keys in the <strong>Settings</strong> sheet, but defaults assume these names.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>3. Create Input Table (tblInput):</strong> On the <strong>Input</strong> sheet, insert a Table and name it <strong>tblInput</strong>. <strong>Required fields (headers exactly)</strong>: <code>nip</code>, <code>npwp</code>, <code>name</code>, <code>period</code>, <code>period_type</code>, <code>gross</code>, <code>npwp_status</code>. <strong>BPJS sub-fields (new, required if you track components):</strong> <code>bpjs_ke_emp</code>, <code>bpjs_jkk_emp</code>, <code>bpjs_jkm_emp</code>, <code>bpjs_jht_emp_emp</code> (employer parts) and <code>bpjs_ke_emp_pct</code>, <code>bpjs_jkk_emp_pct</code>, <code>bpjs_jkm_emp_pct</code>, <code>bpjs_jht_emp_pct</code> (optional percent fields if you record percentages). <strong>Employee-side fields (new):</strong> <code>bpjs_ke_empployee</code>, <code>bpjs_jht_employee</code>, <code>iuran_bpjs_employee</code> or aggregated <code>iuran_bpjs_employee</code>. Additional columns are allowed and will be preserved in the <code>bukti_potong.csv</code> file.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>4. Rules Table — tblBrackets:</strong> On the <strong>Rules_Brackets</strong> sheet, create a Table named <strong>tblBrackets</strong> with the following headers: <code>upper</code>, <code>rate</code>. Requirements: <code>upper</code> must be ascending, last row must contain a large sentinel upper bound (e.g., <code>999999999</code>), and rates should be decimal (0–1).</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>5. Rules Table — tblParams:</strong> On the <strong>Rules_Params</strong> sheet, create a Table named <strong>tblParams</strong> with the following headers: <code>key</code>, <code>value</code>. Common keys: <code>dtp_pct</code>, <code>npwp_penalty_pct</code>, <code>annualization_default</code>. If you need to treat BPJS differently by default, add keys such as <code>include_employer_bpjs_in_gross</code> → <code>true</code> and <code>allow_employee_bpjs_deduction</code> → <code>true</code>.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>6. Settings Sheet Keys:</strong> On the <strong>Settings</strong> sheet, column A = key, column B = value. Required: <code>OUTPUT_BASE</code> → absolute folder path (e.g., <code>C:\pph21_output</code>). Optional: <code>JOB_ID</code> (pre-assigned job ID; leave blank for auto-generation), <code>RULES_BRACKETS_SHEET</code>, <code>RULES_PARAMS_SHEET</code>. Add optional key <code>INCLUDE_BPJS_FIELDS</code> → <code>true</code> to enable BPJS column enforcement (default <code>true</code> recommended).</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>7. JOB_ID Rules:</strong> If left empty, the system generates a unique <code>JOB_ID</code> in the format <code>job_YYYYMMDD_HHNNSS</code>. This <code>JOB_ID</code> is written back into the <strong>Settings</strong> sheet and becomes the folder name under <code>OUTPUT_BASE</code>.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>8. VBA References:</strong> All modules use late binding, but enabling <strong>Microsoft Scripting Runtime</strong> is recommended (for Dictionary performance and type hints). No external libraries are required.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>9. Module Placement (Exact Names):</strong> Modules must be created exactly as: <code>modMain</code>, <code>modIO</code>, <code>modCalc</code>, <code>modManifest</code>, <code>modUtils</code>. Paste the delivered VBA code exactly and <strong>do not rename</strong> the modules. If you modify <code>modCalc</code>, preserve <code>ComputeTax</code> and <code>ProcessRow</code> signatures.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>10. Example tblBrackets:</strong> Suggested usable bracket set for tax calculations: <code>50,000,000</code> → <code>0.05</code>, <code>250,000,000</code> → <code>0.15</code>, <code>500,000,000</code> → <code>0.25</code>, <code>1,000,000,000</code> → <code>0.30</code>, <code>999,999,999,999</code> → <code>0.35</code>.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>11. Example tblParams:</strong> Common example values for <code>tblParams</code>: <code>dtp_pct</code> → <code>0.05</code>, <code>npwp_penalty_pct</code> → <code>0.20</code>, <code>annualization_default</code> → <code>monthly</code>. Add <code>include_employer_bpjs_in_gross</code> → <code>true</code> and <code>allow_employee_bpjs_deduction</code> → <code>true</code> if present.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>12. Single Sample Input Row (BPJS example):</strong> Example row in <strong>tblInput</strong> for verification: <code>nip</code> = <code>12345</code>, <code>npwp</code> = <code>0099999999</code>, <code>name</code> = <code>Test User</code>, <code>period</code> = <code>2025-11</code>, <code>period_type</code> = <code>monthly</code>, <code>gross</code> = <code>10,000,000</code>, <code>npwp_status</code> = <code>has</code>, <code>bpjs_ke_emp</code> = <code>150000</code>, <code>bpjs_jkk_emp</code> = <code>5000</code>, <code>bpjs_jkm_emp</code> = <code>2000</code>, <code>bpjs_jht_emp_emp</code> = <code>0</code>, <code>iuran_bpjs_employee</code> = <code>200000</code>. Use this row for end-to-end pipeline verification.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>13. Running the Macro:</strong> Main entry point: <code>pph21_RunAll</code>. Run using <strong>Developer → Macros</strong>, or assign the macro to a button. This will perform a full atomic job run.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>14. Execution Pipeline (High-Level Overview):</strong> 1) Read <strong>Settings</strong> 2) Generate <code>JOB_ID</code> if needed 3) Create <code>OUTPUT_BASE\JOB_ID</code> folder 4) Load <strong>tblInput</strong> into array (including BPJS columns if present) 5) Load <strong>tblBrackets</strong>, <strong>tblParams</strong> 6) For each row, aggregate BPJS employer components into <code>premi_asuransi_employer</code> and aggregate employee BPJS into <code>iuran_employee</code> 7) Apply tax rules 8) Build <strong>bukti</strong> and <strong>per11</strong> datasets 9) Write <code>bukti_potong.csv</code>, <code>per11_payload.csv</code> 10) Generate <code>manifest.json</code> 11) Import CSVs back to output sheets 12) Write Logs</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>15. Output Files (Exact Names):</strong> These files will be located in the folder: <code>OUTPUT_BASE\JOB_ID</code>: <code>bukti_potong.csv</code>, <code>per11_payload.csv</code>, <code>manifest.json</code>.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>16. CSV Schemas Produced (BPJS added):</strong> <strong>bukti_potong.csv</strong> columns include (order recommended): <code>nip</code>, <code>npwp</code>, <code>name</code>, <code>period</code>, <code>period_type</code>, <code>gross</code>, <code>bpjs_ke_emp</code>, <code>bpjs_jkk_emp</code>, <code>bpjs_jkm_emp</code>, <code>bpjs_jht_emp_emp</code>, <code>premi_asuransi_employer</code> (sum of employer bpjs + other employer premi), <code>iuran_bpjs_employee</code>, <code>iuran_pensiun</code>, <code>annual_gross</code>, <code>annual_tax</code>, <code>tax_after_dtp</code>, <code>tax_after_penalty</code>, <code>monthly_withholding</code>, plus all extra input columns preserved. <strong>per11_payload.csv</strong> columns: <code>nip</code>, <code>npwp</code>, <code>period</code>, <code>monthly_withholding</code>, <code>annual_tax</code>, <code>premi_asuransi_employer</code>, <code>iuran_bpjs_employee</code>. The code will compute <code>premi_asuransi_employer</code> automatically as the sum of employer BPJS components and any other employer premium fields.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>17. Manifest.json Specification:</strong> Contains: <code>job_id</code>, <code>generated_at</code> timestamp, <code>files[]</code> list (with each file's: <code>path</code>, <code>size</code>, <code>modified</code>, <code>sha256</code>). SHA-256 hashes are lowercase hex and computed inside VBA. No change required for BPJS.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>18. Atomic Write Guarantees:</strong> All CSV/JSON writes first go to <code>.tmp</code> files, and then are renamed. Existing final files are removed before writing the <code>.tmp</code> file. <strong>Partial files</strong> cannot appear unless forced by external interruption.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>19. Logs Sheet:</strong> The system logs: Settings read, Path creation, Table load counts, File write events, BPJS aggregation events, Errors with timestamps.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>20. Common Errors &amp; Fixes (with BPJS):</strong> "Path not found" → Ensure <code>OUTPUT_BASE</code> exists. "Key not found" → Missing Settings or Params key. Empty outputs → <strong>tblInput</strong> empty or missing columns. Wrong types → Ensure <code>gross</code>, <code>upper</code>, <code>rate</code>, and BPJS numeric fields are numeric. BPJS fields missing → if <code>INCLUDE_BPJS_FIELDS</code> = <code>true</code>, missing BPJS columns will cause a validation warning and treated as zero (unless <code>strict_bpjs</code> setting is enabled).</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>21. Validation Tests:</strong> Recommended tests: Bracket boundary tests, Missing NPWP penalty test, Period-type variations, High-income test, Employer-BPJS-as-gross test (verify that <code>premi_asuransi_employer</code> increases <code>gross</code> base where applicable), Employee-BPJS-deduction test (verify deduction applied when allowed).</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>22. Version Safety:</strong> Always <strong>duplicate</strong> the workbook before modifying macros, rules, or sheet structures.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>23. Extending Logic:</strong> All tax computation logic is in <code>modCalc</code> (<code>ComputeTax</code>, <code>ProcessRow</code>). To add BPJS rules or change classification, modify only <code>ComputeTax</code> and keep the existing signatures. Add helper aggregators in <code>modUtils</code> if needed.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>24. Performance Guidance:</strong> Optimized for handling hundreds to a few thousand rows. For larger volumes, consider running in batches or migrating the computational core to <strong>Python</strong>.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>25. Security Considerations:</strong> Macros write files, so ensure that both the workbook and <code>OUTPUT_BASE</code> path are restricted to trusted users only. BPJS data is personal payroll data — treat accordingly.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>26. Re-running Jobs:</strong> If the <code>JOB_ID</code> remains unchanged, the outputs will be overwritten. Leave <code>JOB_ID</code> blank to force a fresh timestamped job ID.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>27. CSV Import Rules:</strong> <code>ImportCsvToSheet</code> uses <code>QueryTables</code> and preserves text format for columns like <code>npwp</code> and <code>nip</code> (so they won't be transformed into scientific notation). When importing, confirm BPJS fields are imported as numeric/currency.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>28. Testing Automation:</strong> You can add a <strong>Test_RunAll</strong> macro that populates <strong>tblInput</strong> with BPJS example rows, runs the job, and asserts expected outputs in output sheets.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>29. Documentation Locations:</strong> Each module includes structured comments describing responsibilities: <code>modMain</code> = orchestrator, <code>modIO</code> = tables/CSV handling, <code>modCalc</code> = tax logic, <code>modManifest</code> = hashing, <code>modUtils</code> = helper functions. Add a short note at the top of <code>modCalc</code> describing BPJS aggregation logic.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>30. Support Checklist:</strong> Before seeking support, ensure you have: A sample workbook, Settings values, Bracket table, Params table (with BPJS keys if changed), Sample inputs, Logs output, The generated <code>manifest.json</code>.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>31. Operational Checks Before Production:</strong> <br/>1) Validate <strong>tblInput</strong> headers exactly (including BPJS headers if used) <br/>2) Validate bracket ordering <br/>3) Ensure <code>OUTPUT_BASE</code> exists <br/>4) Run a single test row (including BPJS example) <br/>5) Inspect <strong>Logs</strong> for any issues.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>32. Audit Trails:</strong> Keep the entire job folder (CSV + manifest), a snapshot of <strong>Settings</strong>, and rule tables for audit reproducibility. BPJS component columns must be retained for audit.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>33. Migration Path:</strong> For advanced rule engines, high-volume processing, multilingual CSV exports, or parallel jobs, consider using the <strong>Python</strong> engine with Excel acting purely as a UI.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>34. Folder Housekeeping:</strong> <code>OUTPUT_BASE</code> may accumulate many <code>JOB_ID</code> subfolders. Clean periodically or archive old data.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>35. Final Pre-Run Checklist:</strong> ✓ Workbook saved as macro-enabled ✓ Macros enabled ✓ Sheets created (Input, Rules, Outputs, Logs) <br/>✓ <strong>tblInput</strong>, <strong>tblBrackets</strong>, <strong>tblParams</strong> created <br/>✓ <code>OUTPUT_BASE</code> exists <br/>✓ If <code>INCLUDE_BPJS_FIELDS</code> = <code>true</code>, confirm BPJS columns present or explicitly accept zero defaults.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>CSV header examples</strong> <br/> <strong>bukti_potong.csv header (recommended order):</strong><br/>nip,npwp,name,period,period_type,gross,bpjs_ke_emp,bpjs_jkk_emp,bpjs_jkm_emp,bpjs_jht_emp_emp,premi_asuransi_employer,iuran_bpjs_employee,iuran_pensiun,annual_gross,annual_tax,tax_after_dtp,tax_after_penalty,monthly_withholding,<other columns="" input="" preserved...=""></other></div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>per11_payload.csv header (recommended):</strong> <br/> nip,npwp,period,monthly_withholding,annual_tax,premi_asuransi_employer,iuran_bpjs_employee</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>Validation &amp; error handling rules (BPJS-specific)</strong> <br/> BPJS numeric fields must be numeric ≥ 0; non-numeric → validation error and row skipped (or zero if <code>strict_bpjs=false</code> in <code>tblParams</code>).<br/>If <code>INCLUDE_BPJS_FIELDS=true</code> but BPJS columns missing: log warning and create zero columns in-memory (unless <code>strict_bpjs=true</code> → hard error).<br/>Percent fields (<code>*_pct</code>) must be in [0,1]; if both amount and percent supplied → amount takes precedence.<br/>If aggregated <code>premi_asuransi_employer</code> &gt; 50% of gross: log sanity warning.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>Ten-point verification (performed)</strong> <br/> 1) Sheet presence check: All referenced sheets remain unchanged.<br/>2) tblInput header check: Required BPJS columns listed and mapped.<br/>3) BPJS classification: Employer BPJS aggregated into <code>premi_asuransi_employer</code> and included in gross when enabled.<br/>4) Employee deduction: Employee BPJS aggregated into <code>iuran_bpjs_employee</code> and deducted when allowed.<br/>5) CSV schema consistency: bukti_potong.csv and per11_payload.csv aligned with aggregation logic.<br/>6) Atomic write: .tmp → rename flow unchanged.<br/>7) Manifest consistency: New fields do not affect manifest format; hashes follow file updates.<br/>8) Validation rules: Numeric and percent BPJS rules included.<br/>9) Sample-row test: Sample row yields deterministic aggregation and withholding.<br/>10) Backward compatibility: Missing BPJS treated as zero unless <code>strict_bpjs=true</code>.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 40</div></div><div class="table-caption" id="Table3" data-table="Docu_0142_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)"><div class="tv-left-col"><div class="left-col-heading"><strong>Purpose</strong>:<br/>Enumerate every input, selectable option, and expected computed output used by the official PPh 21 calculator UI and guidance so you can map them into the <code>pph21_2025</code> Excel design. All items checked against the official calculator page and the DJP “Cermat” guide. (kalkulator.pajak.go.id).</div></div></td></tr><tr><td data-label="PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)"><div class="tv-left-col"><div class="left-col-heading"><strong>Top-level control fields (UI selectors)</strong>:<br/>• <code>Jenis Pemotongan</code> — PPh 21 Bulanan <code>|</code> PPh 21 Final <code>|</code> PPh 21 Tidak Final <code>|</code> PPh 21 Tahunan.</div></div></td></tr><tr><td data-label="PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)"><div class="tv-left-col"><div class="left-col-heading"><strong>Object / category codes</strong>:<br/>• <code>Kode Objek Pajak</code> — numeric code + label (e.g., <code>21-100-01 Pegawai Tetap</code>, <code>21-100-02 Penerima Pensiun Berkala</code>, <code>21-100-03 Pegawai Tidak Tetap</code>, …).</div></div></td></tr><tr><td data-label="PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)"><div class="tv-left-col"><div class="left-col-heading"><strong>Calculation mode / scheme</strong>:<br/>• <code>Skema Penghitungan</code> — <code>Gross</code> vs <code>Gross Up</code>.</div></div></td></tr><tr><td data-label="PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)"><div class="tv-left-col"><div class="left-col-heading"><strong>Period / frequency controls</strong>:<br/>• <code>Period</code> (e.g., <code>2025-11</code>).<br/>• <code>Penghitungan</code>: <code>Setahun</code> / <code>Disetahunkan</code>.</div></div></td></tr><tr><td data-label="PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)"><div class="tv-left-col"><div class="left-col-heading"><strong>Employee / recipient info</strong>:<br/>• <code>nip</code>/<code>NIK</code>.<br/>• <code>npwp</code>.<br/>• <code>name</code>.<br/>• <code>status keluarga</code> / <code>PTKP category</code> (TK/0, TK/1, K/0, …).</div></div></td></tr><tr><td data-label="PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)"><div class="tv-left-col"><div class="left-col-heading"><strong>Gross income components (1–7)</strong>:<br/>1. GAJI/PENSIUN/THT/JHT<br/>2. TUNJANGAN PPh<br/>3. TUNJANGAN LAINNYA/LEMBUR<br/>4. HONORARIUM<br/>5. PREMI ASURANSI DARI PEMBERI KERJA<br/>6. NATURA/KENIKMATAN<br/>7. TANTIEM/BONUS/GRATIFIKASI/JASA PRODUKSI/THR<br/>8. JUMLAH PENGHASILAN BRUTO (computed).</div></div></td></tr><tr><td data-label="PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)"><div class="tv-left-col"><div class="left-col-heading"><strong>Allowed deductions (9–11)</strong>:<br/>9. BIAYA JABATAN / BIAYA PENSIUN<br/>10. IURAN PENSIUN / HARI TUA<br/>11. ZAKAT / SUMBANGAN KEAGAMAAN<br/>12. JUMLAH PENGURANGAN (computed).</div></div></td></tr><tr><td data-label="PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)"><div class="tv-left-col"><div class="left-col-heading"><strong>Intermediate computed fields</strong>:<br/>13. PENGHASILAN NETO (8–12)<br/>14. PENGHASILAN NETO MASA SEBELUMNYA<br/>15. NETO UNTUK PERHITUNGAN (SETahun/DIsetahunkan)<br/>16. PTKP<br/>17. PKP.</div></div></td></tr><tr><td data-label="PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)"><div class="tv-left-col"><div class="left-col-heading"><strong>Tax computation options</strong>:<br/>• <code>DPP</code>, <code>Tarif</code>, TER-table mode, progressive mode.<br/>• <code>Jenis PPh Tahunan</code> selector (A1/A2/P3K).</div></div></td></tr><tr><td data-label="PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)"><div class="tv-left-col"><div class="left-col-heading"><strong>Previously withheld / DTP</strong>:<br/>19. PPh 21 DIPOTONG SEBELUMNYA<br/>20. PPh 21 DTP SEBELUMNYA<br/>21. PPh 21 TERUTANG (computed).</div></div></td></tr><tr><td data-label="PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)"><div class="tv-left-col"><div class="left-col-heading"><strong>Other UI fields</strong>:<br/>• Income already withheld in same period.<br/>• CAPTCHA (ignored for Excel design).</div></div></td></tr><tr><td data-label="PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)"><div class="tv-left-col"><div class="left-col-heading"><strong>PTKP values</strong>:<br/>• PTKP constants for all codes (TK/0 = 54,000,000; TK/1 = 58,500,000; etc.).</div></div></td></tr><tr><td data-label="PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)"><div class="tv-left-col"><div class="left-col-heading"><strong>TER &amp; scheme notes</strong>:<br/>• TER regime uses effective-rate table; include both TER and progressive logic.</div></div></td></tr><tr><td data-label="PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)"><div class="tv-left-col"><div class="left-col-heading"><strong>Output fields to mirror</strong>:<br/>• Monthly PPh 21, annual PPh 21, withheld amounts, DTP amounts, DPP, Tarif slices.</div></div></td></tr><tr><td data-label="PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)"><div class="tv-left-col"><div class="left-col-heading"><strong>Reporting fields</strong>:<br/>• nip, npwp, name, period, income components, deductions, annual_gross, annual_tax, prior_withheld, dtp_amount, net balance; map to bukti_potong.csv &amp; per11_payload.csv.</div></div></td></tr><tr><td data-label="PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)"><div class="tv-left-col"><div class="left-col-heading"><strong>Validation rules</strong>:<br/>• Required: nip, name, period (YYYY-MM/YYY).<br/>• npwp normalized; derive <code>npwp_status</code>.<br/>• Numeric fields ≥ 0.<br/>• PTKP code must match allowed mapping.</div></div></td></tr><tr><td data-label="PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)"><div class="tv-left-col"><div class="left-col-heading"><strong>10× verification checklist</strong>:<br/>1) Income items 1–7 complete.<br/>2) Deductions 9–11 complete.<br/>3) PTKP table correct.<br/>4) Options surfaced.<br/>5) TER mode included.<br/>6) Prior-withheld &amp; DTP correct.<br/>7) Rounding rules correct.<br/>8) Full object-code list included.<br/>9) Export schemas complete.<br/>10) CAPTCHA noted.</div></div></td></tr><tr><td data-label="PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)"><div class="tv-left-col"><div class="left-col-heading"><strong>VBA mapping recommendations</strong>:<br/>• Add income_1…income_7, deduction_9…deduction_11.<br/>• Add PTKP_code, object_code, calc_scheme, jenis_pemotongan, jenis_pajak_tahunan, prior_withheld, prior_dtp.</div></div></td></tr><tr><td data-label="PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)"><div class="tv-left-col"><div class="left-col-heading"><strong>Edge cases</strong>:<br/>• TER may include &gt;40 tiers.<br/>• PTKP married-dependent mapping.</div></div></td></tr><tr><td data-label="PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)"><div class="tv-left-col"><div class="left-col-heading"><strong>Next step</strong>:<br/>Choose A (fetch TER+PTKP tables) or B (proceed with module-by-module mapping).</div></div></td></tr><tr><td data-label="PPh 21 — Complete field inventory kalkulator.pajak.go.id and DJP documentation)"><div class="tv-left-col"><div class="left-col-heading"><strong>Sources</strong>:<br/>kalkulator.pajak.go.id; DJP “Cermat Pemotongan” PDF; TER guidance articles.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 22</div></div><div class="table-caption" id="Table4" data-table="Docu_0142_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by Technical Breakdown" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Name:</strong> <code>modUtils.bas</code></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Purpose:</strong> Central, dependency-minimal utility library for file/path/log/settings helpers used by higher-level modules (<code>modMain</code>, <code>modIO</code>, <code>modManifest</code>, <code>modTest</code>, etc.). Provides deterministic helpers and atomic file operation primitives while avoiding compile-time references (uses late-binding for FSO and Dictionary).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Design Principles:</strong> Pure-VBA, no required references; fail-safe (no unhandled runtime errors); deterministic functions except explicit I/O; minimal side-effects; small, testable units; predictable behavior for cross-environment Excel installations.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Compatibility:</strong> Works on Windows Excel (VBA) with only late-bound <code>Scripting.FileSystemObject</code> and <code>Scripting.Dictionary</code> created via <code>CreateObject</code>. Avoids API calls, .NET, or Win32 externals.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Public API — function signatures (recommended prototypes):</strong> <pre>Public Function TS() As StringPublic Function JoinPath(ByVal a As String, ByVal b As String) As StringPublic Function EnsureFolder(ByVal folderPath As String) As BooleanPublic Function FileExists(ByVal path As String) As BooleanPublic Function DeleteFileIfExists(ByVal path As String) As BooleanPublic Function SafeMoveFile(ByVal src As String, ByVal dst As String) As BooleanPublic Function LogMsg(ByVal logsSheetName As String, ByVal msg As String) As BooleanPublic Function ReadSettings(ByVal settingsSheetName As String) As Object</pre></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>TS() — Timestamp Generator:</strong> Returns <code>yyyy-mm-dd HH:nn:ss</code>.<br/>Implementation notes:<br/>– build from <code>Year</code>, <code>Month</code>, <code>Day</code>, <code>Hour</code>, <code>Minute</code>, <code>Second</code> with zero-padding<br/>– avoid <code>Format(Date, ...)</code> to remove locale dependence<br/>– deterministic and safe for sorting</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>JoinPath(a, b) — Deterministic Path Join:</strong><br/>– if <code>a</code> is empty → return <code>b</code><br/>– if <code>b</code> is empty → return <code>a</code><br/>– if <code>a</code> ends with <code>\</code> or <code>/</code> → return <code>a &amp; b</code><br/>– else insert <code>\</code> between them<br/>– preserve existing separator style<br/>– trim both inputs</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>EnsureFolder(folderPath) — Guaranteed Folder Creator:</strong><br/>– trim input; empty → return False<br/>– late-bind FSO via <code>CreateObject("Scripting.FileSystemObject")</code><br/>– if folder does not exist → create exactly one level<br/>– returns True if folder exists after call</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>FileExists(path) — Safe Existence Check:</strong><br/>– trim input; empty → return False<br/>– use FSO late bound<br/>– wrap calls in <code>On Error Resume Next</code><br/>– on error → return False</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>DeleteFileIfExists(path) — Idempotent Cleaner:</strong><br/>– if exists → try delete via <code>fso.DeleteFile path, True</code><br/>– wrap in <code>On Error Resume Next</code><br/>– return True if file gone after call<br/>– silent on failure but returns failure flag</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>SafeMoveFile(src, dst) — Atomic Move Helper:</strong><br/>– validate non-empty src/dst<br/>– ensure src exists<br/>– if dst exists → delete it<br/>– attempt <code>Name src As dst</code> (atomic same-volume)<br/>– detect volume mismatch; optional fallback copy+delete<br/>– return True on success</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>LogMsg(logsSheetName, msg) — Structured Logger:</strong><br/>– append timestamp + message to next row (A:B)<br/>– create sheet if missing<br/>– auto headers if first row empty<br/>– minimize screen flicker<br/>– fail-passive (return False on error, no raise)</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>ReadSettings(settingsSheetName) — Key/Value Loader:</strong><br/>– read up to 100 rows<br/>– Column A = key (trim, optional normalize)<br/>– Column B = value<br/>– return late-bound Dictionary<br/>– empty/invalid → empty dictionary<br/>– catastrophic → return Nothing</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Late-binding specifics:</strong><br/>– use <code>CreateObject("Scripting.FileSystemObject")</code><br/>– use <code>CreateObject("Scripting.Dictionary")</code><br/>– document required Windows components<br/>– graceful fallback if COM disabled</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Error-handling model:</strong><br/>– validate inputs<br/>– perform operation<br/>– return Boolean/Result<br/>– internal logging<br/>– use <code>On Error GoTo</code> or <code>Resume Next</code> only where needed<br/>– capture Err.Number/Description<br/>– no unhandled public errors</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Atomic CSV write pattern (usage example):</strong><br/>1. write to <code>outFile.tmp</code><br/>2. <code>DeleteFileIfExists outFile</code><br/>3. <code>SafeMoveFile outFile.tmp, outFile</code></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Integration points &amp; responsibilities:</strong><br/>– <code>modMain</code>: orchestrates, uses ReadSettings, JoinPath, EnsureFolder, LogMsg<br/>– <code>modIO</code>: DeleteFileIfExists, SafeMoveFile<br/>– <code>modManifest</code>: JoinPath, FileExists, SafeMoveFile<br/>– <code>modTest</code>: EnsureFolder, LogMsg</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Return types &amp; expectations:</strong><br/>– Boolean for most helpers<br/>– TS() → String<br/>– ReadSettings() → Dictionary object<br/>– False always means failure; caller must log/decide</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Performance notes:</strong><br/>– create FSO on demand; release immediately<br/>– allow optional shared FSO for loops<br/>– all helpers O(1) except filesystem latency</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Security &amp; permissions:</strong><br/>– no network I/O<br/>– requires filesystem permissions<br/>– no elevation attempts<br/>– restricted accounts → return False gracefully</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Testability &amp; recommended test cases:</strong><br/>– JoinPath: trailing slash, empty values, mixed separators<br/>– EnsureFolder: exists/not exists/empty<br/>– FileExists: real/missing/empty<br/>– DeleteFileIfExists: locked/missing<br/>– SafeMoveFile: same volume / different volume<br/>– LogMsg: missing sheet / existing sheet<br/>– ReadSettings: trimmed keys, partial rows<br/>– include cleanup for tmp files</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Documentation &amp; comments:</strong><br/>– each public function gets header comment<br/>– include purpose, constraints, return semantics, side-effects, examples</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Version control / deployment notes:</strong><br/>– <code>Const MODUTILS_VERSION = "2025-11-27-1"</code><br/>– create branch before edits<br/>– maintain changelog</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Backward compatibility:</strong><br/>– keep public names and signatures<br/>– add behavior only as non-breaking optional paths</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Observability / logging policy:</strong><br/>– all failures logged using LogMsg<br/>– <code>modUtils_Debug</code> flag for verbose mode<br/>– production uses minimal logging</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Robustness checklist (10x verification steps):</strong><br/>1. TS format exactly <code>yyyy-mm-dd HH:nn:ss</code><br/>2. JoinPath: empty a, trailing slash, b with leading slash<br/>3. EnsureFolder: existing/new/empty input<br/>4. FileExists: empty returns False, real path returns correct<br/>5. DeleteFileIfExists: idempotent and correct<br/>6. SafeMoveFile: atomic same-volume; safe failure cross-volume<br/>7. LogMsg: append correctly, handle missing sheet<br/>8. ReadSettings: dictionary keys trimmed; expected mapping<br/>9. All CreateObject calls error-wrapped<br/>10. No unreleased objects</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Minimal usage examples (pseudo-VBA snippets):</strong> <pre>' TimestampDim t As Stringt = TS()' Join pathDim p As Stringp = JoinPath("C:\jobs", "out.csv")' Ensure folderIf Not EnsureFolder("C:\jobs") Then LogMsg "Errors", "Folder create failed" ' atomic write patternDim tmp As String, final As Stringtmp = JoinPath("C:\jobs", "out.csv.tmp")final = JoinPath("C:\jobs", "out.csv")' write to tmp (caller) -&gt; thenSafeMoveFile tmp, final</pre></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Change/patch guidance:</strong><br/>– add new helpers below existing ones<br/>– keep signatures stable<br/>– add unit tests<br/>– run 10x checklist<br/>– bump version</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Common pitfalls &amp; mitigation:</strong><br/>– avoid Kill on slow network paths<br/>– do not use Name across mapped drives<br/>– avoid sheet activation during logs<br/>– always trim/validate paths</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Notes on BPJS / Docu changes:</strong><br/>– module must stay domain-agnostic<br/>– exporters rely on atomic write &amp; logging guarantees<br/>– include tests for BPJS-column CSVs</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Final verification statement:</strong> Implementers must run the 10x verification checklist and execute <code>modTest</code> scenarios before committing changes.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 31</div></div><div class="table-caption" id="Table5" data-table="Docu_0142_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by Technical Breakdown" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Name:</strong> <code>modIO.bas</code></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Scope:</strong> Table/CSV I/O, atomic CSV writes (UTF-8), import-to-sheet helpers, read workbook ListObjects → in-memory dictionaries/arrays. Deterministic, side-effect-safe data access used by <code>modMain</code>, <code>modCalc</code>, <code>modManifest</code>, and <code>modTest</code>.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Purpose:</strong> Provide robust I/O primitives for the pipeline: reliably read rule tables and params from worksheets, expose them as typed in-memory structures, write CSV exports atomically (no partial writes), and import external CSVs into sheets with predictable typing. Handle common filesystem edge-cases (locks, network shares, cross-volume moves) in a testable way.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Design Principles:</strong> <br/>• Deterministic outputs for same inputs and workbook state.<br/>• Fail-safe: public functions return Boolean or well-defined objects; do not raise unhandled errors.<br/>• Use <code>modUtils</code> primitives (<code>SafeMoveFile</code>, <code>DeleteFileIfExists</code>, <code>JoinPath</code>, <code>LogMsg</code>) rather than raw FileSystem/Name/Kill operations.<br/>• Prefer streaming for large outputs to avoid building huge in-memory strings.<br/>• Preserve backward compatibility of public function signatures.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Public API (recommended signatures):</strong> <pre>Public Function ReadTableToDicts(ByVal sheetName As String, ByVal tableName As String) As Object ' returns Dictionary "0".."n-1" each value = Dictionary(header-&gt;Variant)Public Function ReadBrackets(ByVal sheetName As String, ByVal tableName As String, uppers() As Double, rates() As Double) As BooleanPublic Function ReadParams(ByVal sheetName As String, ByVal tableName As String) As Object ' returns Dictionary key-&gt;VariantPublic Function WriteCsvAtomic(ByVal folderPath As String, ByVal fileName As String, csvGenerator As IStreamProvider, Optional ByVal writeBOM As Boolean = False) As BooleanPublic Function ImportCsvToSheet(ByVal csvPath As String, ByVal sheetName As String, Optional ByVal preserveTextColumns As Boolean = True) As Boolean</pre></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>ReadTableToDicts — contract &amp; behavior:</strong> <br/>• Reads a worksheet ListObject exactly (header row + data rows).<br/>• Trims header names; rejects empty headers (log and abort).<br/>• For each non-empty data row, produce a late-bound <code>Scripting.Dictionary</code> mapping header→cell Variant (preserve Null/Empty as <code>""</code> or <code>Empty</code>).<br/>• Outer container is a <code>Scripting.Dictionary</code> keyed <code>"0".."n-1"</code> (string keys for stable COM marshalling).<br/>• Skip rows that are fully empty.<br/>• Treat merged cells as their displayed value if possible; if ambiguous treat as empty (configurable).<br/>• Preserve cell types: return string/numeric/date/boolean as Variant types (do not coerce).<br/>• Complexity: O(rows×cols). For very large tables, support optional batching callback (stream rows instead of building full outer dictionary).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>ReadTableToDicts — validation rules &amp; errors:</strong> <br/>• Header row must have no blanks — otherwise log and return <code>Nothing</code>.<br/>• If <code>tableName</code> not found, return <code>Nothing</code> and log error.<br/>• If unexpected cell types encountered, return value as-is but log a warning.<br/>• All errors handled and logged; public call returns <code>Nothing</code> on fatal failure.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>ReadBrackets — contract &amp; behavior:</strong> <br/>• Reads two-column bracket tables: <code>upper</code> and <code>rate</code>.<br/>• Trim and parse numeric strings, accept formats with thousands separators and <code>%</code> signs.<br/>• Convert rates to decimal fractions when <code>%</code> present (e.g., <code>5%</code> → <code>0.05</code>).<br/>• Ensure ascending <code>upper</code> bounds; ensure equal-length arrays.<br/>• Return <code>True</code> on success and populate provided arrays. On parse error or ordering violation, log and return <code>False</code>.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>ReadParams — contract &amp; behavior:</strong> <br/>• Read key/value pairs from a simple two-column table.<br/>• Normalize keys (recommended: <code>UCase$(Trim(key))</code>) for stable lookup; preserve original key in an optional metadata map.<br/>• Parse values into numbers/booleans where appropriate; otherwise return as string Variant.<br/>• Skip blank keys.<br/>• Return <code>Scripting.Dictionary</code> (late-bound) mapping normalizedKey→Variant. Return <code>Nothing</code> on fatal error.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>WriteCsvAtomic — semantics &amp; pattern:</strong> <br/>• Intended to produce UTF-8 CSV files reliably. Caller supplies file content via a streaming provider (recommended to avoid huge string concatenation).<br/>• Implementation steps:<br/>1) Generate <code>&lt;file&gt;.tmp</code> (write stream to local temp if needed).<br/>2) Close stream and flush to disk.<br/>3) Call <code>modUtils.DeleteFileIfExists(finalPath)</code> then <code>modUtils.SafeMoveFile(tmpPath, finalPath)</code>.<br/>• Use ADODB.Stream (binary) or custom streaming writer to emit UTF-8 bytes. Optionally write BOM if <code>writeBOM=True</code> (document implications: Excel on some Windows versions expects BOM to detect UTF-8).<br/>• If cross-volume move required and <code>SafeMoveFile</code> cannot <code>Name</code> across volumes, fall back to <code>CopyFile</code>+<code>DeleteSrc</code> but only after ensuring target integrity; prefer writing to final volume tmp to avoid fallback.<br/>• Ensure <code>.tmp</code> cleaned up on failure.<br/>• Return <code>True</code> on success, <code>False</code> on any failure (with <code>LogMsg</code> entries).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>WriteCsvAtomic — error handling &amp; robustness:</strong> <br/>• Detect and log permission/sharing/locking errors (Err.Number).<br/>• Implement retry/backoff for transient file locks (configurable small number of retries).<br/>• If write to target fails due to network share restrictions, optionally write to local temp and then move to target.<br/>• Ensure <code>.tmp</code> removal on failure (best-effort).<br/>• Log final manifest/hash on successful final write.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>CSV generation &amp; encoding details:</strong> <br/>• Use UTF-8 encoding.<br/>• Avoid embedding formulas or macros in CSV fields.<br/>• Properly escape fields with double quotes according to RFC4180; double any internal quotes.<br/>• Ensure newline <code>vbCrLf</code> used consistently.<br/>• For extremely large writes, stream row-by-row to ADODB.Stream using <code>Write</code> with binary-encoded UTF-8 bytes (do not accumulate the entire file in memory).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>ImportCsvToSheet — behavior &amp; options:</strong> <br/>• Default behavior: use <code>QueryTables.Add</code> with <code>TextFilePlatform = 65001</code> (UTF-8), <code>TextFileCommaDelimiter = True</code>.<br/>• To preserve text (leading zeros, long numeric IDs) build and assign full <code>TextFileColumnDataTypes</code> array where every column specified as <code>xlTextFormat</code> (value <code>2</code>) or the correct VBA constant.<br/>• If QueryTable proves unreliable on certain Excel builds, provide fallback: parse CSV line-by-line and write into sheet using <code>Range.Value</code> assignment (streaming) with explicit typing.<br/>• Clean up QueryTables after import to avoid leftover connections.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>ImportCsvToSheet — pitfalls &amp; mitigations:</strong> <br/>• BOM may confuse some Excel versions; detect BOM and strip before QueryTable or set <code>TextFilePlatform</code> appropriately.<br/>• QueryTable auto-typing may truncate or reformat (e.g., dates) — set column types to preserve text where required.<br/>• Large imports: use block <code>Range</code> assignment instead of cell-by-cell to improve speed.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Inter-module contracts &amp; responsibilities:</strong> <br/>• <code>modMain</code> expects <code>ReadTableToDicts</code> to return <code>Dictionary "0".."n-1"</code> for deterministic iteration.<br/>• <code>modCalc</code> expects bracket arrays from <code>ReadBrackets</code> to be 1-based or documented indexing.<br/>• <code>modManifest</code> expects <code>WriteCsvAtomic</code> to guarantee that once True is returned, the final file is complete and checksum-stable.<br/>• <code>modUtils</code> used for all filesystem primitives (SafeMoveFile, DeleteFileIfExists, JoinPath, LogMsg).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Security &amp; path validation:</strong> <br/>• Normalize and validate <code>folderPath</code> and <code>fileName</code>: block traversal sequences (<code>..</code>), disallow absolute paths where relative expected unless explicitly permitted.<br/>• Ensure CSV content cannot be executed automatically (prefix <code>=</code> in first column with <code>'\=</code> optionally for imports).<br/>• Avoid writing to privileged system folders; require <code>OUTPUT_BASE</code> to be within allowed workspace.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Performance considerations:</strong> <br/>• For moderate files (few thousand rows) ADODB + QueryTable acceptable.<br/>• For large exports/imports (100k+ rows), stream writes and block reads/writes to worksheet ranges.<br/>• Avoid repeated <code>CreateObject</code> calls in loops—pass objects where possible.<br/>• Offer optional parameter to use in-memory buffering vs streaming depending on size.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Observability &amp; logging:</strong> <br/>• Log start/end of each read/write operation with timestamp and byte/row counts.<br/>• On write success, log SHA256 (or MD5) hash of final CSV (compute on tmp before moving).<br/>• All failures must <code>LogMsg</code> with <code>Err.Number</code>, <code>Err.Description</code>, and stack-like context (function name + parameters).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Testing &amp; verification (10× checklist):</strong> <br/>1) ReadTableToDicts: 3-row ListObject → outer Dict.Count=3; verify header keys exact and trimmed.<br/>2) ReadTableToDicts: merged cells &amp; empty rows handled per rules.<br/>3) ReadBrackets: various formatted inputs (<code>"1,000"</code>, <code>"5%"</code>, <code>"1000.00"</code>) parse correctly; ensure ascending uppers.<br/>4) ReadParams: boolean (<code>TRUE/FALSE</code>), numeric, and string typed correctly.<br/>5) WriteCsvAtomic: <code>.tmp</code> created and final file moved atomically; no <code>.tmp</code> residue after success.<br/>6) WriteCsvAtomic: simulate locked final file → retry/backoff and graceful failure, ensure tmp cleanup.<br/>7) Cross-volume move: ensure fallback or failure is handled and documented.<br/>8) ImportCsvToSheet: preserve leading zeros/long IDs when <code>preserveTextColumns=True</code>.<br/>9) ImportCsvToSheet: BOM handling and platform detection validated.<br/>10) Manifest/hash stability: compute identical hash for identical content across repeated runs.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Recommended immediate improvements (if code exists already):</strong> <br/>• Standardize return types to <code>Scripting.Dictionary</code> for collection returns.<br/>• Replace <code>Name</code> usage with <code>modUtils.SafeMoveFile</code>.<br/>• Implement streaming CSV writer interface (<code>IStreamProvider</code>) to allow memory-efficient writes.<br/>• Add retry logic for network locks.<br/>• Add unit tests in <code>modTest</code> exercising each edge-case.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Backward compatibility &amp; versioning:</strong> <br/>• Preserve all public function names and signatures.<br/>• If adding optional parameters (e.g., <code>preserveTextColumns</code>), make them optional with default values to avoid breaking callers.<br/>• Add <code>Const MODIO_VERSION = "2025-11-27-1"</code> at top and maintain changelog.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Minimal usage examples (pseudo-VBA):</strong> <pre>' Read table to dictsDim rows As ObjectSet rows = ReadTableToDicts("Rules", "tblRates")If rows Is Nothing Then LogMsg "IO", "ReadTableToDicts failed": Exit FunctionDim i As LongFor i = 0 To rows.Count - 1 Dim r As ObjectSet r = rows(CStr(i)) ' use r("HeaderName")Next i' Write CSV atomicallyDim ok As Booleanok = WriteCsvAtomic("C:\jobs\out", "bukti_potong.csv", New CsvStreamFromRows(dataRows), True)If Not ok Then LogMsg "IO", "WriteCsvAtomic failed"'</pre></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Ops &amp; troubleshooting tips:</strong> <br/>• If <code>ReadTableToDicts</code> returns <code>Nothing</code>, inspect <code>LogMsg</code> output for header mismatch.<br/>• If CSV import mangles columns, re-run with <code>preserveTextColumns=True</code> or use streaming fallback parse.<br/>• If network writes fail consistently, verify permissions and prefer local-temp→move strategy.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Integration testing recommendations:</strong> <br/>• Include end-to-end test that reads rules, executes calculation, writes CSV, computes hash, imports CSV to separate workbook and validates row/column counts and sample cell values.<br/>• Run tests on local disk, mapped network drive, and across volumes to validate fallback behaviors.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Documentation &amp; comments:</strong> <br/>• Each public function header must specify: purpose, inputs, outputs, side-effects, exceptions/logging behavior, and sample usage.<br/>• Document CSV encoding choices and rationale for BOM handling.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Notes on interaction with domain changes (e.g., BPJS fields):</strong> <br/>• <code>modIO</code> should remain domain-agnostic but be validated with representative CSV schemas containing new BPJS columns.<br/>• Ensure exported CSV header order and escaping meet downstream import expectations (e.g., <code>per11_payload.csv</code>, <code>bukti_potong.csv</code>).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Final verification statement:</strong> <br/>• Before any commit, run the 10× verification checklist, full <code>modTest</code> suite, and an end-to-end export→import cycle across local and network paths. All tests must pass and logs must show deterministic behavior.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 27</div></div><div class="table-caption" id="Table6" data-table="Docu_0142_06" style="margin-top:2mm;margin-left:3mm;"><strong>Table 6</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by Technical Breakdown" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Name:</strong> <code>modCalc.bas</code></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Purpose:</strong> Central calculation engine for PPh21 processing. Computes taxable income (PKP), applies progressive tariffs, enforces NPWP penalties, applies rounding rules, and integrates BPJS employer/employee components according to config. Designed for deterministic, unit-testable numeric results consumed by <code>modIO</code> and <code>modMain</code>.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Design Principles:</strong><br/>• Deterministic — same inputs + config → same outputs.<br/>• Fail-safe — public APIs return results (or structured error flags) and never raise unhandled runtime errors.<br/>• Config-driven — tax brackets, PTKP, NPWP strings, BPJS classification flags come from <code>modConfig</code>.<br/>• Preserve backward compatibility of public function signatures.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Dependencies:</strong><br/>Reads readonly maps from <code>modConfig</code> (PTKPMap, BracketList, NPWPStrings, Flags e.g., <code>EmployeeBPJSDeductible</code>, <code>TreatEmployerBPJSAsGross</code>). Should not perform I/O.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Public API (recommended signatures):</strong><br/><pre>Public Function CalcRow(row As Object) As Object ' returns Dictionary with computed fieldsPublic Function NormalizeNPWPStatus(status As Variant) As BooleanPublic Function ComputePTKP(row As Object) As DoublePublic Function ComputeGrossTotal(row As Object) As DoublePublic Function ComputeDeductionsTotal(row As Object) As DoublePublic Function ComputePKP(gross As Double, deductions As Double, ptkp As Double) As DoublePublic Function ComputePPh21(pkp As Double) As DoublePublic Function ApplyNPWPPenalty(tax As Double, hasNPWP As Boolean) As DoublePublic Function IndoRound(amount As Double, Optional roundTo As Long = 1) As DoublePublic Function SafeGet(dict As Object, key As String, defaultValue As Variant) As VariantPublic Function AggregateEmployerBPJS(row As Object) As DoublePublic Function AggregateEmployeeBPJS(row As Object) As Double</pre></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Input contract:</strong><br/><code>row</code> is a late-bound <code>Scripting.Dictionary</code> (or equivalent) whose keys match export/input schema. Mandatory numeric fields should be present or defaulted by <code>SafeGet</code>. Expected BPJS-related input keys (if present): <code>BPJS_KESEHATAN_EMPLOYER</code>, <code>BPJS_JKK_EMPLOYER</code>, <code>BPJS_JKM_EMPLOYER</code>, <code>BPJS_JHT_EMPLOYER</code>, <code>OTHER_PREMI_EMPLOYER</code>, <code>BPJS_KESEHATAN_EMPLOYEE</code>, <code>BPJS_JHT_EMPLOYEE</code>, <code>OTHER_IURAN_EMPLOYEE</code>. Legacy single column <code>PREMI_ASURANSI_DARI_PEMBERI_KERJA</code> and <code>IURAN_PENSIUN_ATAU_IURAN_THT_JHT</code> supported for backward compatibility.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>High-level flow (CalcRow):</strong><br/>1. Extract inputs via <code>SafeGet</code> (gross components, BPJS fields, NPWP, marital status, dependents, period type, gross-up flag).<br/>2. <code>hasNPWP = NormalizeNPWPStatus(SafeGet(row,"NPWP_Status", ""))</code>.<br/>3. <code>ptkp = ComputePTKP(row)</code>.<br/>4. <code>grossTotal = ComputeGrossTotal(row)</code> (includes employer BPJS when <code>TreatEmployerBPJSAsGross = True</code>).<br/>5. <code>deductionsTotal = ComputeDeductionsTotal(row)</code> (includes employee BPJS if <code>EmployeeBPJSDeductible = True</code>).<br/>6. If <code>PeriodType</code> = GrossUp then adjust gross/deductions per gross-up logic before PKP.<br/>7. <code>pkp = ComputePKP(grossTotal, deductionsTotal, ptkp)</code>.<br/>8. <code>taxBeforePenalty = ComputePPh21(pkp)</code>.<br/>9. <code>taxAfterPenalty = ApplyNPWPPenalty(taxBeforePenalty, hasNPWP)</code>.<br/>10. Apply <code>IndoRound</code> per rounding rules.<br/>11. Return dictionary containing PTKP, GrossTotal, DeductionsTotal, PKP, TaxBeforePenalty, TaxAfterPenalty, RoundingDetail, and debug fields used in trace logs.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Gross aggregation (ComputeGrossTotal):</strong><br/>• Sum explicit gross components: <code>GAJI_PENSIUN_THT_JHT</code>, <code>TUNJANGAN_PPH</code>, <code>TUNJANGAN_LAINNYA</code>, <code>LEMBUR</code>, <code>HONORARIUM</code>, <code>PREMI_ASURANSI_DARI_PEMBERI_KERJA</code> (if present).<br/>• Add explicit employer BPJS sub-components when present: <code>BPJS_KESEHATAN_EMPLOYER</code>, <code>BPJS_JKK_EMPLOYER</code>, <code>BPJS_JKM_EMPLOYER</code>, <code>BPJS_JHT_EMPLOYER</code>, <code>OTHER_PREMI_EMPLOYER</code>.<br/>• If configuration flag <code>TreatEmployerBPJSAsGross = True</code> then these employer BPJS amounts are included in grossTotal (taxable employer benefit).<br/>• For gross-up mode: include employer BPJS consistently in gross-up base used to back-calculate gross.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Deductions aggregation (ComputeDeductionsTotal):</strong><br/>• Sum standard deductions (employee pension/iuran): <code>IURAN_PENSIUN_ATAU_IURAN_THT_JHT</code> and others.<br/>• Aggregate employee BPJS fields: <code>BPJS_KESEHATAN_EMPLOYEE</code>, <code>BPJS_JHT_EMPLOYEE</code>, <code>OTHER_IURAN_EMPLOYEE</code>.<br/>• If configuration <code>EmployeeBPJSDeductible = True</code> then employee BPJS amounts reduce taxable base (counted in deductionsTotal). Otherwise treat them as informational only.<br/>• Include other permitted deductions (loan interest, allowable contributions) per config.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>PKP computation (ComputePKP):</strong><br/>• Intermediate taxable base = <code>grossTotal - deductionsTotal</code>.<br/>• Subtract <code>ptkp</code>.<br/>• PKP = <code>Max( FloorToThousand(intermediate_taxable_base - ptkp), 0 )</code>.<br/>• Implement <code>FloorToThousand(x)</code> to round down to the nearest 1,000 as required by Indonesian tax rules for PKP. Explicitly document difference between PKP rounding (down to 1,000) and final tax rounding.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Progressive tax computation (ComputePPh21):</strong><br/>• Load bracket list from config (list of [upperLimit, rate] sorted ascending).<br/>• Process in ascending order computing taxable portion per bracket: <code>portion = Min(remainingPKP, bracketUpper - prevUpper)</code>; <code>tax += portion * rate</code>; subtract portion from remainingPKP; continue.<br/>• Support open-ended last bracket with <code>upperLimit = Infinity</code>.<br/>• Support bracket rate expressions in <code>%</code> or decimal.<br/>• Return taxBeforePenalty as numeric.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>NPWP penalty (ApplyNPWPPenalty):</strong><br/>• If <code>hasNPWP = False</code>, multiply tax by <code>1 + Config.NPWP_PenaltyRate</code> (default <code>0.20</code>).<br/>• If <code>hasNPWP = True</code>, return tax unchanged.<br/>• Preserve numeric precision until rounding step.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Rounding (IndoRound and PKP rounding):</strong><br/>• PKP rounding: always round down to nearest 1,000 (floor).<br/>• Final tax rounding: use <code>IndoRound(amount, roundTo)</code> where <code>roundTo</code> default = 1 (Rupiah). Implementation: convert to integer centsless representation, apply digit decomposition to avoid floating anomalies; tie-breaking rule: values with last digit 1–4 round down; 5–9 round up — but document and unit-test exact behavior. Provide optional <code>roundTo</code> parameter (e.g., 1000) for testing or alternative rounding.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>NPWP string normalization (NormalizeNPWPStatus):</strong><br/>• Accepts many textual or numeric variants; maps '+', 'yes', 'y', '1', 'has', 'ada', 'punya', 'valid' → <code>True</code>.<br/>• Maps 'no', 'tidak', 't', '0', 'missing', 'invalid' → <code>False</code>.<br/>• Null/empty defaults to <code>False</code>.<br/>• Configurable additional synonyms via <code>modConfig.NPWPStrings</code>.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Gross-Up handling:</strong><br/>• If <code>PeriodType</code> or <code>Mode</code> indicates Gross-Up, implement iterative gross-up solver: treat employer-paid taxes and employer BPJS as taxable employer benefit where applicable; back-calculate gross such that after computing tax and employer contributions, the employee receives target net.<br/>• Ensure convergence and limit iterations (e.g., max 50 iterations).<br/>• Document that employer BPJS must be consistently included in gross-up base if <code>TreatEmployerBPJSAsGross = True</code>.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>BPJS-specific rules &amp; configuration flags:</strong><br/>• <code>TreatEmployerBPJSAsGross</code> (boolean) — when true, employer BPJS is included in gross and therefore increases taxable base. Default = True.<br/>• <code>EmployeeBPJSDeductible</code> (boolean) — when true, employee BPJS contributions are counted as deductions (iuran) before PKP. Default = True if calculator supports it.<br/>• <code>BPJSFieldMapping</code> — map multiple legacy/variant input header names into canonical field names.<br/>• Document regulatory basis in project docs and permit per-client override.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Safe access helper (SafeGet):</strong><br/>• Returns <code>defaultValue</code> if key missing or value is <code>Null</code>/<code>Empty</code>.<br/>• Performs <code>CDBL</code>/<code>CLng</code> conversions safely with error trapping when numeric expected.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Return contract (CalcRow result):</strong><br/>Dictionary with canonical keys and numeric values: <code>PTKP</code>, <code>GrossTotal</code>, <code>DeductionsTotal</code>, <code>PKP</code>, <code>TaxBeforePenalty</code>, <code>TaxAfterPenalty</code>, <code>RoundingAdjustment</code>, <code>HasNPWP</code>, <code>ComputationNotes</code> (string for debug/tracing). All numeric outputs are Doubles; PKP and Tax values are rounded as specified before inclusion in export.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Error handling model:</strong><br/>• Fail-soft: on missing or malformed inputs, apply defaults and set <code>ComputationNotes</code> with explanation.<br/>• Fatal configuration errors (missing bracket list) return an error object/dictionary with <code>Error=True</code> and explanatory message.<br/>• All internal errors caught and logged via <code>modUtils.LogMsg</code> (do not raise).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Performance characteristics:</strong><br/>• Per-row complexity dominated by bracket iteration O(numBrackets) and simple arithmetic.<br/>• Suitable for batch processing thousands of rows; prefer vectorized/batched calculation functions if needed.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Unit tests &amp; verification (10× checklist):</strong><br/>1) NPWP normalization variants map correctly.<br/>2) PTKP selection for TK/0, K/1, etc., returns expected numeric constant.<br/>3) PKP calculation: gross/deductions/ptkp combinations produce correct floor-to-1000 PKP.<br/>4) Progressive bracket calculation: several PKP values tested against hand-calculated examples.<br/>5) NPWP penalty: 20% applied when NPWP missing.<br/>6) Rounding: <code>IndoRound</code> and PKP floor behavior validated across edge digits (0..9).<br/>7) BPJS: employer BPJS inclusion/exclusion toggled via config yields expected taxable base differences.<br/>8) Employee BPJS deductible flag validated (deduction applied or not).<br/>9) Gross-up solver converges and produces net consistent with target within numeric tolerance.<br/>10) SafeGet handles missing keys and type coercion reliably.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Observability &amp; logging:</strong><br/>• For each CalcRow call, optionally emit trace log lines when <code>modConfig.VerboseCalc = True</code>: inputs, intermediate gross/deduction amounts, PKP, bracket steps, and final tax.<br/>• Ensure logs are concise and suitable for batch post-mortem.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Integration points:</strong><br/>• <code>modMain</code> orchestrates reading rows (via <code>modIO.ReadTableToDicts</code>), calling <code>CalcRow</code> for each, collecting results, and writing export CSV via <code>modIO.WriteCsvAtomic</code>.<br/>• <code>modCalc</code> must not perform I/O except logging via <code>modUtils.LogMsg</code>.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Backward compatibility &amp; migration:</strong><br/>• Preserve CalcRow signature.<br/>• If new BPJS fields are added to schema, map them in <code>AggregateEmployerBPJS</code>/<code>AggregateEmployeeBPJS</code> while still reading legacy aggregate columns.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Documentation &amp; comments:</strong><br/>• Each public function should include header describing purpose, inputs, outputs, side-effects, and sample usage.<br/>• Document the exact rounding rules with numeric examples.<br/>• Record regulatory citations for NPWP penalty and BPJS classification decisions in project docs.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Final verification statement:</strong><br/>Implementers must run the 10× unit checks above, execute full end-to-end samples including BPJS-enabled rows, and confirm exported tax fields match authoritative calculator (where available) before committing.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 26</div></div><div class="table-caption" id="Table7" data-table="Docu_0142_07" style="margin-top:2mm;margin-left:3mm;"><strong>Table 7</strong></div>
<div class="table-wrapper" data-table-id="table-7"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by Technical Breakdown" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Name:</strong> <code>modManifest.bas</code></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Scope:</strong> File hashing, binary-safe reads, SHA-256 computation in pure-VBA, deterministic hex conversion, JSON manifest construction, and atomic manifest writes. Provides integrity metadata for job outputs consumed by <code>modMain</code> and validated by downstream tooling.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Purpose:</strong> Read files as raw bytes; compute SHA-256 digest; convert bytes→lowercase hex; assemble deterministic manifest JSON containing path/size/modified/sha256 entries; write <code>manifest.json</code> atomically via <code>modIO.WriteCsvAtomic</code> (or equivalent atomic-text writer). Produce reproducible, audit-grade integrity outputs.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Design Principles:</strong> • Deterministic outputs for identical inputs. • Fail-safe: public functions return typed empty values on error rather than raising. • Pure-VBA implementation (no external executables) with ADODB.Stream for binary I/O and manual SHA-256 implemented using 32-bit unsigned arithmetic emulation. • Minimal side-effects: no network I/O; only local filesystem read/write.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Public API (recommended signatures):</strong> <pre>Public Function ReadBinaryFile(ByVal filePath As String) As Byte()Public Function SHA256_Bytes(data() As Byte) As Byte()Public Function BytesToHex(data() As Byte) As StringPublic Function SHA256_FileHex(ByVal filePath As String) As StringPublic Function WriteManifest(ByVal jobFolder As String, ByVal jobId As String, ByVal fileList As Collection) As Boolean</pre></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>ReadBinaryFile — contract &amp; behavior:</strong><br/>• Use <code>CreateObject("ADODB.Stream")</code> in binary mode (<code>Type = 1</code>).<br/>• <code>LoadFromFile(filePath)</code> then <code>Read</code> into Byte() buffer.<br/>• Always return a Byte() array; for empty/unreadable returns <code>ReDim buf(-1)</code> (zero-length typed array) — never return <code>Empty</code> or Variant. <br/>• Close and <code>Set stream = Nothing</code> in all paths. <br/>• On error: ensure stream closed and return empty Byte().</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>SHA256_Bytes — implementation rules &amp; constraints:</strong><br/>• Full SHA-256 per FIPS 180-4: message padding (0x80 + zeros + 64-bit big-endian original bit-length), process 512-bit blocks, prepare message schedule w[0..63], use K constants and initial H[] values. <br/>• Use 32-bit unsigned arithmetic emulation: implement <code>ADD32(a,b)</code> returning <code>(a + b) And &amp;HFFFFFFFF</code> using Double/Currency arithmetic to avoid signed overflow. <br/>• Implement <code>ROR32(x,n)</code> rotate-right via arithmetic and modulus <code>4294967296#</code>. <br/>• Avoid VBA <code>Long</code> overflow by representing 32-bit words in Double and masking to 32-bit after each operation. <br/>• Return 32-byte big-endian Byte() digest on success; return empty Byte() on error.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>BytesToHex — guarantees &amp; behavior:</strong><br/>• Convert a Byte() array to a lowercase hex string; exactly 2 hex chars per byte. <br/>• Empty array → return <code>""</code>. <br/>• No locale dependencies; use numeric-to-hex routines that pad to 2 chars per byte.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>SHA256_FileHex — behavior:</strong><br/>• Read file via <code>ReadBinaryFile</code>. If returned byte array length = 0 and file exists with zero length → compute SHA of empty-message correctly. If ReadBinaryFile fails due to lock/permission → return <code>""</code>. <br/>• Call <code>SHA256_Bytes</code>, then <code>BytesToHex</code>, returning lowercase hex string. <br/>• On any failure return <code>""</code> (caller must log and decide).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>WriteManifest — semantics &amp; JSON schema:</strong><br/>• Input: <code>jobFolder</code> (existing folder), <code>jobId</code> string, <code>fileList</code> collection of file path strings (relative or absolute). <br/>• For each file that exists and is readable: gather <code>{ "path": &lt;str&gt;, "size": &lt;num&gt;, "modified": &lt;ISO8601&gt;, "sha256": &lt;hex&gt; }</code>. Skip unreadable/missing files but continue manifest generation. <br/>• Deterministic ordering: sort file entries alphabetically by normalized path before emitting. <br/>• JSON schema: <code>{ "job_id":&lt;str&gt;, "generated_at":&lt;ISO8601&gt;, "files":[{ "path":&lt;str&gt;, "size":&lt;num&gt;, "modified":&lt;str&gt;, "sha256":&lt;str&gt; }, ... ] }</code>. Keys emitted in the exact order shown. <br/>• Escape JSON strings (control chars, backslash, quotes, unicode) with an <code>EscapeJson</code> helper. <br/>• Produce compact UTF-8 JSON (no trailing commas). <br/>• Write atomically using <code>modIO.WriteCsvAtomic(jobFolder, "manifest.json", jsonText)</code> (or call equivalent <code>WriteTextAtomic</code>) so final <code>manifest.json</code> is only created when complete.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Atomic write integration:</strong><br/>• Rely on <code>modIO.WriteCsvAtomic</code> which implements <code>.tmp</code> → atomic rename via <code>modUtils.SafeMoveFile</code>. <br/>• Ensure JSON is encoded as UTF-8 bytes (ADODB.Stream binary write or ADODB.Stream text with <code>Charset = "utf-8"</code> and proper BOM handling as configured). <br/>• On successful return, <code>manifest.json</code> must be intact and hash-stable.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Unsigned 32-bit arithmetic helpers (recommend):</strong><br/>• <code>Private Function ADD32(a As Double, b As Double) As Double</code> → return <code>(a + b) Mod 2^32</code> with masking. <br/>• <code>Private Function ROR32(v As Double, n As Integer) As Double</code> → compute rotate-right safely. <br/>• <code>Private Function SHR32(v As Double, n As Integer) As Double</code> and <code>Private Function XOR32(a,b) As Double</code> helpers as required. <br/>• All helpers must mask results <code>And &amp;HFFFFFFFF</code> to simulate 32-bit unsigned semantics reliably.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Error handling model:</strong><br/>• Use <code>On Error GoTo ErrHandler</code> in each public function. <br/>• Return typed empty values on failure: <code>""</code> for string, <code>ReDim buf(-1)</code> for Byte() arrays, <code>False</code> for Boolean. <br/>• Log errors via <code>modUtils.LogMsg</code> including <code>Err.Number</code>, <code>Err.Description</code>, and file path context. Do not raise unhandled errors to caller.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Edge cases &amp; special behaviors:</strong><br/>• Empty file: SHA-256 of empty message must match known vector (<code>e3b0...</code>). <br/>• Locked/unreadable file: <code>ReadBinaryFile</code> returns empty array; <code>SHA256_FileHex</code> returns <code>""</code> and entry skipped (manifest notes missing entries). <br/>• Very large files: ADODB.Stream read in chunks is recommended for memory safety; consider streaming-hash variant for multi-GB files (immediate improvement). <br/>• Non-ASCII bytes preserved exactly (no text conversions).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Inter-module contracts:</strong><br/>• <code>modMain</code> expects <code>WriteManifest</code> to never throw but return <code>False</code> on failure. <br/>• <code>modIO.WriteCsvAtomic</code> must accept UTF-8 text content and ensure atomic <code>.tmp</code> rename semantics. <br/>• <code>modUtils</code> used for logging, path joins, and safe moves. <br/>• Callers rely on typed, stable return values from ReadBinaryFile and SHA functions.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Performance &amp; resource notes:</strong><br/>• Pure-VBA SHA-256 is CPU-bound and slower than native implementations; acceptable for many small/medium files. <br/>• For very large files or many files, consider external hashing (PowerShell/certutil) as an optional fallback and import results. <br/>• Ensure ADODB.Stream objects are <code>Set ... = Nothing</code> after use to free COM resources.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Security &amp; integrity considerations:</strong><br/>• Manifest provides tamper-detection using SHA-256. <br/>• No network calls; operations confined to local filesystem. <br/>• Ensure manifest JSON does not expose sensitive paths inadvertently; consider path-normalization policies for release artifacts.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Tests &amp; verification (10× checklist):</strong><br/>1. <code>ReadBinaryFile</code> on a small test file returns Byte() length equal to file size. <br/>2. <code>SHA256_FileHex(testFile)</code> equals authoritative external tool (<code>certutil -hashfile</code> or <code>openssl dgst -sha256</code>). <br/>3. <code>SHA256_Bytes</code> implementation matches known SHA-256 test vectors (e.g., empty string, "abc", long test vectors). <br/>4. <code>BytesToHex</code> yields lowercase hex without prefixes and 2 chars/byte. <br/>5. Manifest JSON parses in external JSON validators and matches schema. <br/>6. Missing/unreadable file in fileList is skipped; manifest still valid and contains remaining files. <br/>7. ADODB.Stream failures return typed empty Byte() and do not raise. <br/>8. No variables left unreleased (<code>Set ... = Nothing</code>); no duplicate <code>Dim</code> shadowing. <br/>9. Deterministic JSON ordering: repeated runs produce byte-identical manifest when inputs unchanged. <br/>10. Full pipeline e2e: write artifacts → <code>WriteManifest</code> → verify manifest entries and <code>manifest.json</code> atomicity on local and network paths.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Immediate improvements &amp; recommendations:</strong><br/>• Implement chunked/streaming SHA-256 to handle large files without loading entire file into memory. <br/>• Add optional external-hash fallback (PowerShell/certutil) when ADODB or CPU becomes bottleneck. <br/>• Provide verbose mode that emits per-file timing and hashing duration to logs for performance auditing. <br/>• Optionally include <code>manifest.sig</code> (detached signature) workflow for elevated integrity guarantees.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Ops &amp; troubleshooting tips:</strong><br/>• If <code>SHA256_FileHex</code> returns <code>""</code>, inspect file permissions/locks and <code>modUtils.LogMsg</code> entries. <br/>• If manifest entries missing, validate <code>fileList</code> paths and normalization; confirm files exist and are accessible. <br/>• For mismatched external hashes, ensure same canonical byte sequence (no CRLF/encoding conversion) and re-run with chunked read to rule out partial reads.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Documentation &amp; comments:</strong><br/>• Each function must have a header comment: purpose, inputs, outputs, side-effects, error semantics, and sample usage. <br/>• Document SHA-256 implementation details and reference test vectors used for validation. <br/>• Document manifest JSON schema explicitly and example output.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Backward compatibility &amp; versioning:</strong><br/>• Preserve public function signatures. <br/>• Add <code>Const MODMANIFEST_VERSION = "2025-11-27-1"</code> at top of module and maintain changelog for any algorithmic adjustments.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Final verification statement:</strong> Implementers must run the 10× checklist above, verify SHA-256 test vectors match external tools, execute end-to-end manifest generation on representative jobs (including network paths), and confirm <code>manifest.json</code> atomicity and determinism before committing changes.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 23</div></div><div class="table-caption" id="Table8" data-table="Docu_0142_08" style="margin-top:2mm;margin-left:3mm;"><strong>Table 8</strong></div>
<div class="table-wrapper" data-table-id="table-8"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by Technical Breakdown" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Name:</strong> <code>modMain.bas</code></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Purpose:</strong> <br/> Orchestrator for end-to-end PPh21 job runs. Coordinates settings loading, job folder creation, input ingestion, configuration loading, per-row computation (<code>modCalc</code>), CSV export (<code>modIO</code>), manifest generation (<code>modManifest</code>), imports to output sheets, logging, and safe shutdown/cleanup. Keeps orchestration concerns separate from domain logic and I/O primitives.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Design Principles:</strong> • Orchestration-only: no tax logic inside; delegate to <code>modCalc</code>.<br/>• Deterministic control flow: identical inputs + config produce same outputs and side-effects.<br/>• Fail-safe: never allow unhandled errors to bubble to the user; always catch, log, and produce a controlled failure state.<br/>• Idempotent operations where possible (safe re-runs when <code>JOB_ID</code> reused).<br/>• Minimal dependencies at top-level; use <code>modUtils</code>, <code>modIO</code>, <code>modCalc</code>, <code>modManifest</code> for primitives.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Public API (recommended signatures):</strong> <pre>Public Sub pph21_RunAll()Public Function InitializeJob(Optional ByVal providedJobId As String = "") As BooleanPublic Function LoadSettings() As Object ' returns DictionaryPublic Function LoadRules() As BooleanPublic Function ProcessAllRows(rows As Object) As Object ' returns results containerPublic Function WriteOutputs(results As Object) As BooleanPublic Function GenerateManifest(jobFolder As String, jobId As String) As BooleanPublic Function ImportOutputsToSheets(jobFolder As String) As BooleanPublic Sub AbortCleanup(errContext As String)</pre></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>High-level flow (pph21_RunAll):</strong> <br/>1. <code>LoadSettings()</code> → read Settings sheet into a Dictionary.<br/>2. Validate <code>OUTPUT_BASE</code>; call <code>modUtils.EnsureFolder(OUTPUT_BASE)</code>; abort if invalid.<br/>3. <code>InitializeJob()</code> → generate or accept <code>JOB_ID</code>, create job folder <code>${OUTPUT_BASE}\${JOB_ID}</code>.<br/>4. <code>LoadRules()</code> → call <code>modIO.ReadBrackets</code> and <code>modIO.ReadParams</code> (or <code>modIO.ReadTableToDicts</code>) and store in <code>modConfig</code>.<br/>5. <code>rows = modIO.ReadTableToDicts("Input","tblInput")</code>.<br/>6. <code>results = ProcessAllRows(rows)</code> → iterate rows, call <code>modCalc.CalcRow</code>, collect outputs and per-row diagnostics.<br/>7. <code>WriteOutputs(results)</code> → produce <code>bukti_potong.csv</code> and <code>per11_payload.csv</code> via <code>modIO.WriteCsvAtomic</code>.<br/>8. <code>GenerateManifest(jobFolder, JOB_ID)</code> → call <code>modManifest.WriteManifest</code>.<br/>9. <code>ImportOutputsToSheets(jobFolder)</code> → optionally import CSVs back to Excel output sheets via <code>modIO.ImportCsvToSheet</code>.<br/>10. <code>Finalize</code>: write success log entry and update Settings sheet with JOB_ID and last-run timestamp.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Initialization &amp; Settings handling (LoadSettings / InitializeJob):</strong> • Read Settings sheet first 100 rows via <code>modUtils.ReadSettings</code>.<br/>• Required keys: <code>OUTPUT_BASE</code> (absolute path); optional: <code>JOB_ID</code>, <code>RULES_BRACKETS_SHEET</code>, <code>RULES_PARAMS_SHEET</code>, <code>MOD_VERSION</code>, <code>VERBOSE</code>.<br/>• Validate <code>OUTPUT_BASE</code> exists and is writable; if not, attempt <code>modUtils.EnsureFolder</code> if allowed by policy.<br/>• JOB_ID semantics: if providedJobId not empty → use it (idempotent run) else if Settings <code>JOB_ID</code> present → reuse if allowed; else generate <code>job_YYYYMMDD_HHNNSS</code>.<br/>• Persist generated JOB_ID back to Settings sheet (use safe write pattern: update in-memory then write via <code>modIO</code> or direct Range assignment wrapped in error handling).<br/>• Create jobFolder = <code>JoinPath(OUTPUT_BASE, JOB_ID)</code> using <code>modUtils.JoinPath</code> and call <code>modUtils.EnsureFolder(jobFolder)</code>.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Rule &amp; Configuration Loading (LoadRules):</strong> <br/>• Load bracket table and params using <code>modIO.ReadBrackets</code> and <code>modIO.ReadParams</code> or <code>ReadTableToDicts</code> depending on implementation.<br/>• Validate loaded data (non-empty brackets, ascending uppers, presence of PTKP entries).<br/>• Map config flags for BPJS handling into <code>modConfig</code> (e.g., <code>TreatEmployerBPJSAsGross</code>, <code>EmployeeBPJSDeductible</code>).<br/>• Place <code>modConfig</code> into module-level read-only container for downstream calls (single-load per job).<br/>• If validation fails, log and abort job with clear error message.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Input ingestion (ReadTableToDicts):</strong> <br/>• Call <code>modIO.ReadTableToDicts("Input","tblInput")</code>.<br/>• Validate presence of required input headers (e.g., <code>nip</code>, <code>npwp</code>, <code>period</code>, <code>period_type</code>, <code>gross</code> or legacy components).<br/>• If headers missing → log detailed error and abort.<br/>• For large inputs, support chunked processing: supply <code>ProcessAllRows</code> with a subset and allow repeated runs.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Processing loop (ProcessAllRows):</strong> <br/>• For each row dictionary: 1) call <code>modCalc.CalcRow(row)</code> inside <code>On Error</code> guard; 2) capture returned dictionary (results) and any <code>ComputationNotes</code>; 3) append to results collection for CSV export; 4) log per-row failures as warnings and continue unless a fatal count of errors is reached (configurable threshold).<br/>• Maintain counters: processed, succeeded, skipped, failed.<br/>• Periodic checkpointing: for very large runs, optionally write incremental CSVs to jobFolder to allow resume.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>WriteOutputs (CSV export):</strong> <br/>• Convert results to CSV rows with canonical header order (match <code>bukti_potong.csv</code> and <code>per11_payload.csv</code> schema).<br/>• Ensure CSV escaping per RFC4180: double quotes doubled, fields wrapped in quotes when necessary.<br/>• Use streaming writer / <code>modIO.WriteCsvAtomic(jobFolder, fileName, csvGenerator)</code> so <code>.tmp</code> is written then atomically renamed.<br/>• On each write success, compute and log checksum (modManifest or modUtils).<br/>• If write fails due to locking/permission, attempt configurable retry/backoff (e.g., 3 attempts with small delays) then fail and trigger <code>AbortCleanup</code>.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Manifest generation &amp; atomicity (GenerateManifest):</strong> <br/>• After final files are in place, call <code>modManifest.WriteManifest(jobFolder, JOB_ID, fileList)</code> where <code>fileList</code> is an ordered collection of final file paths.<br/>• Ensure <code>modIO.WriteCsvAtomic</code> consumes the JSON and writes <code>manifest.json</code> atomically.<br/>• Verify manifest created and consistent (optionally re-hash listed files and compare).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>ImportOutputsToSheets:</strong> <br/>• Optionally call <code>modIO.ImportCsvToSheet</code> into <code>Outputs_BuktiPotong</code> and <code>Outputs_Per11</code> sheets for immediate inspection.<br/>• Preserve textual formatting for <code>npwp</code>/<code>nip</code> via <code>preserveTextColumns=True</code>.<br/>• If import fails, log but do not mark job as failed (imports are convenience for users).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Concurrency, locking &amp; retries:</strong> <br/>• Protect jobFolder creation/writes with simple file-based lockfile: create <code>${jobFolder}\.lock</code> using atomic <code>.tmp</code> pattern; remove on finalize.<br/>• If lock present at startup and age &lt; configured threshold → abort with log indicating concurrent run.<br/>• For transient file system errors (sharing violations), implement limited retry/backoff with configurable attempts.<br/>• Never block the UI thread for long durations; use <code>DoEvents</code> responsibly in long loops.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Error handling &amp; AbortCleanup:</strong><br/> • Centralized error handler: catch errors, write <code>modUtils.LogMsg("Logs", "&lt;context&gt;: &lt;Err.Number&gt; - &lt;Err.Description&gt;")</code>, mark job status in Settings/Logs, attempt best-effort cleanup (delete tmp files, remove lockfile), and return a boolean failure state to caller.<br/>• Preserve evidence: do not delete <code>.tmp</code> files without logging when aborting unless explicitly configured.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Observability &amp; logging:</strong> <br/>• Log start/end timestamps, settings snapshot, rules loaded counts, input row count, success/failure counters, file write events, manifest creation, and final status.<br/>• Support <code>Verbose</code> mode controlled by <code>Settings.Verbose</code> to emit per-row trace logs (useful in debugging but off by default).<br/>• Ensure <code>modUtils.LogMsg</code> is used for all logs and that <code>Logs</code> sheet receives a summary row at job end.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Crash recovery &amp; idempotence:</strong> <br/>• On startup, detect incomplete previous job (<code>.tmp</code> files present or lockfile leftover).<br/>• If <code>.tmp</code> files exist, either clean up (if older than threshold) or abort with instruction to operator.<br/>• If <code>JOB_ID</code> reused, <code>WriteOutputs</code> must overwrite final files atomically; manifest will reflect latest contents.<br/>• Document recommended recovery steps in user guide.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Versioning &amp; compatibility:</strong> <br/>• Define <code>Const MODMAIN_VERSION = "2025-11-27-1"</code> at module top.<br/>• Preserve public routine names (e.g., <code>pph21_RunAll</code>).<br/>• If schema changes (new BPJS columns), ensure mapping layer updates CSV header order but preserve backwards-compatible columns where possible.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Security &amp; safety:</strong> <br/>• Validate and normalize all filesystem paths from Settings to prevent path traversal.<br/>• Do not execute external commands.<br/>• Ensure <code>OUTPUT_BASE</code> is within allowed workspace; if Settings specify system folders, warn and abort unless override authorized.<br/>• Do not store sensitive data (full NPWP) in logs; mask or redact in log outputs unless <code>Settings.Verbose</code> explicitly requests full detail for debugging.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Performance &amp; scalability:</strong> <br/>• Process rows with minimal worksheet interactions (work in-memory with Dictionaries/Arrays).<br/>• For very large inputs, offer chunked processing and incremental exports.<br/>• Avoid repeated <code>CreateObject</code> calls in the hot path; reuse FSO/Stream objects where safe.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Testing &amp; verification (10× checklist):</strong><br/>1) Settings load: required keys present and validated.<br/>2) JOB_ID generation/persistence: generated format <code>job_YYYYMMDD_HHNNSS</code> and written back to Settings.<br/>3) Job folder creation: <code>OUTPUT_BASE\JOB_ID</code> exists after InitializeJob.<br/>4) Rules load: bracket counts and param keys validated.<br/>5) Input ingestion: <code>ReadTableToDicts</code> returns expected row count and header set.<br/>6) Per-row processing: <code>ProcessAllRows</code> yields same aggregated counts on repeated identical runs.<br/>7) Atomic CSV writes: <code>.tmp</code> created then final file present and <code>.tmp</code> absent.<br/>8) Manifest generation: <code>manifest.json</code> present and parses; listed SHA-256 values match files.<br/>9) Recovery: leftover <code>.tmp</code> or <code>.lock</code> detection triggers safe abort or cleanup per policy.<br/>10) Full end-to-end run: outputs produced, imported, and logs populated; compare sample row output against known-good calculator.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Integration points &amp; responsibilities:</strong> <br/>• Calls <code>modUtils</code> for folder, path, and logging primitives.<br/>• Calls <code>modIO</code> for reading tables, writing CSV, and importing CSV.<br/>• Calls <code>modCalc</code> for per-row tax computation only.<br/>• Calls <code>modManifest</code> for manifest creation.<br/>• Maintains <code>modConfig</code> loaded at startup for use by <code>modCalc</code>.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Observability outputs:</strong> <br/>• Write a <code>job_summary.json</code> or an entry in <code>Logs</code> sheet summarizing counts and elapsed time (recommended).<br/>• Emit <code>modMain</code> version and <code>modConfig</code> checksum at start for reproducibility.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Backward compatibility &amp; migration guidance:</strong> <br/>• When adding new output columns (e.g., BPJS_*), append them to CSV headers to preserve column indices for older consumers; provide a compatibility switch in Settings to output legacy schema.<br/>• Document format changes in changelog and increment <code>MODMAIN_VERSION</code>.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Developer notes &amp; comment policy:</strong> <br/>• Top-of-module header with version, author, and change log.<br/>• Each public function must include header block describing inputs, outputs, side-effects, and error semantics.<br/>• Keep orchestration logic compact; place utility helpers in <code>modUtils</code>.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Final verification statement:</strong> <br/>Before commit, implementers must run the 10× checklist above, perform at least one full end-to-end test (including BPJS-enabled rows), confirm atomic write behavior on both local and representative network paths, and verify manifest SHA-256 values against an external tool for a sample file.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 25</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>