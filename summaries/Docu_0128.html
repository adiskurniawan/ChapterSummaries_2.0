<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1763746935">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0128_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4 • script.toc.js</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical breakdown (script.toc.js)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical breakdown (script.toc.js)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Overview & intent</strong><br>Lightweight, defensive Table-of-Contents (TOC) and caption-injection module for PasteToTable. Responsibilities: discover headings/tables, compute stable IDs, build minimal DOM TOC fragments, idempotently update UI (diff + signature), inject or reuse table captions from external label data, throttle and debounce rebuilds/injections to reduce flicker, and auto-select a likely first table. Maintains backward-compatible public surface (<code>window.PTToc</code>, <code>PTToc.build</code>, <code>PTToc.init</code>, <code>PTToc.reloadLabels</code>, <code>PTToc.getLabels</code>, <code>PTToc.applyLabelsNow</code>, <code>PTToc.scheduleTocRefresh</code>). Designed for resilience (try/catch) and minimal visual churn.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>High-level architecture</strong><br>1. <strong>Singleton guard & config</strong> — top-level IIFE prevents double-install via <code>window.__pt_toc_installed</code>. <code>PTToc.config</code> centralizes selectors, label paths, timings, and feature flags (<code>deferLabelsReload</code>, <code>autoSelectTable1Enabled</code>).<br>2. <strong>Label subsystem</strong> — <code>reloadLabels</code>, <code>getLabels</code>, <code>normalizeLabels</code>, and a lazy install IIFE <code>installLabelsHelpers()</code> that wires <code>PTToc._reloadPromise</code> and global aliases (<code>window.__ptt_labels_reload_promise</code>, <code>window.__ptt_labels_injected</code>).<br>3. <strong>Fetch helpers</strong> — <code>fetchJsonOnce</code> uses <code>fetch</code> + <code>AbortController</code> (if available) with a per-request timeout and returns <code>null</code> on any failure; <code>fetchLabels</code> is a simple sequential candidate fetch fallback without explicit timeout handling.<br>4. <strong>ID & caption helpers</strong> — <code>ensureId</code>, <code>canonKey</code>, <code>captionFor</code>, <code>injectCaptionForElement</code> provide stable id generation, canonicalization of label keys, label lookup, and throttled caption injection/reuse.<br>5. <strong>TOC builder</strong> — <code>buildItemsFromSingleTable</code>, <code>buildItemsFromHeadings</code>, <code>itemsSignature</code>, <code>buildOnce</code>, <code>debounceBuild</code> assemble item lists and apply DOM changes only when signature differs.<br>6. <strong>Minimal DOM-apply layer</strong> — <code>applyFragmentIfChanged</code> performs a shallow compare of existing vs new child nodes then atomically replaces children only when necessary.<br>7. <strong>Event wiring & lifecycle</strong> — <code>attachDelegatedHandlers</code> attaches delegated click/hash handlers and conversion-button listener; <code>observeMutations</code> monitors content root and debounces rebuilds; init flow (<code>PTToc.init</code>) supports deferred label warm/cold flows and background label warming.<br>8. <strong>Network instrumentation</strong> — <code>installGroupLoadInterceptor</code> safely wraps <code>fetch</code> and <code>XMLHttpRequest</code> once to trigger <code>scheduleTocRefresh</code> on <code>/api/group/load</code> or <code>/api/convert</code> traffic.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Key functions & responsibilities (concise)</strong><br><strong>ensureId(el, prefix)</strong> — produce a stable element id from element text, normalize and sanitize, truncate to 60 chars; avoid collisions by suffixing numeric increments; assigns id to element.<br><strong>_normalize_heading_text(raw)</strong> — strip tags/linebreaks and collapse whitespace for id/text normalization.<br><strong>makeLink(id, text, extraClass)</strong> — DOM helper: create <code>&lt;li&gt;&lt;a&gt;</code> with <code>href=#id</code>, <code>data-pt-target</code> and aria attributes.<br><strong>fetchJsonOnce(url, timeoutMs)</strong> — safe fetch with optional AbortController timeout; returns parsed JSON or <code>null</code> on any error; logs via <code>dbg</code>.<br><strong>canonKey(s)</strong> — minimal canonicalization for label keys: trims, collapses spaces, strips non-alphanumeric at ends, lowercases.<br><strong>normalizeLabels(raw)</strong> — flattens nested label objects and maps keys through <code>canonKey</code>, producing <code>PTToc._labels</code> map.<br><strong>installLabelsHelpers() / PTToc.reloadLabels(opts)</strong> — sequence over candidate <code>labelsPaths</code> (expanded by <code>__tv_base</code>), optional cache-bust, sequential probe with per-candidate timeout (uses <code>fetchJsonOnce</code>), sets <code>_labels</code> and calls <code>PTToc.build()</code> when successful.<br><strong>PTToc.getLabels() / PTToc.applyLabelsNow(labelsObj)</strong> — read and write helpers; <code>applyLabelsNow</code> replaces <code>_labels</code> and rebuilds immediately.<br><strong>fetchLabels(paths)</strong> — fallback sequential fetcher returning first JSON body; lacks per-request timeout; used where <code>reloadLabels</code> not present.<br><strong>captionFor(labelsObj, bookPrefix, idx)</strong> — multiple lookup strategies (flat key variants, nested book prefix, padded numbers, canonKey) to return caption string or <code>null</code>.<br><strong>injectCaptionForElement(anchorEl, bookPrefix, idx, captionText)</strong> — idempotent caption injection with suppression window (<code>injectionSuppressMs</code>), reuses existing caption nodes, updates text if changed, avoids heavy churn, assigns <code>data-ptt-injected</code>, inline styling and generated id <code>TableNN</code> (with collision resolution).<br><strong>buildItemsFromSingleTable(table, labels, bookPrefix)</strong> — iterate rows (tbody precedence), ensure row ids, resolve caption label for each row or fall back to <code>rowLabelPrefix</code>.<br><strong>buildItemsFromHeadings(labels, bookPrefix)</strong> — collect configured headings, ensure ids, normalize text, optionally inject captions for matched headings.<br><strong>itemsSignature(items)</strong> — create compact signature string from id::label pairs used to detect changes.<br><strong>applyFragmentIfChanged(container, frag)</strong> — shallow compare childNodes (textContent and first anchor href), replace only if necessary; atomic replacement via clearChildren+appendChild.<br><strong>buildOnce()</strong> — orchestrates table/heading discovery, label-driven caption injection, signature check, fragment creation, minimal apply, highlight current location, and pending auto-select handling.<br><strong>debounceBuild()</strong> — debounce timer wrapper for <code>buildOnce</code> using <code>_debounceMs</code>.<br><strong>highlightCurrentFromLocation()</strong> — set <code>aria-current</code> on matching TOC link based on <code>location.hash</code>.<br><strong>onTocClick(ev)</strong> — delegated click handler: smooth scroll to target accounting for sticky header offset, prevent default, update history/hash and call <code>highlightCurrentFromLocation</code> after scroll.<br><strong>selectTable1()</strong> — heuristic auto-click of first Table1 candidate (by <code>data-pt-target</code> or visible text); throttle via <code>autoSelectThrottleMs</code> and <code>_lastAutoSelectAt</code>.<br><strong>scheduleTocRefresh(opts)</strong> — guarded scheduled refresh that can perform two label reload attempts (firstDelay, secondDelay), builds expanded candidate lists with <code>__tv_base</code>, uses cache-busted variants, updates <code>_labels</code> and calls <code>PTToc.build()</code>; deduplicates concurrent scheduling via <code>_scheduledRefreshFlag</code>.<br><strong>installGroupLoadInterceptor()</strong> — wraps global <code>fetch</code> and <code>XMLHttpRequest</code> once; when targets match <code>/api/group/load</code> or <code>/api/convert</code> triggers <code>scheduleTocRefresh({autoSelect:true})</code> on load/error; sets flags <code>_fetchWrapped</code>/<code>_xhrWrapped</code> to avoid double-wrapping.<br><strong>attachDelegatedHandlers() / observeMutations()</strong> — wire up document-level click, hashchange, mutation observer on content root (childList + subtree), and convert-click listener. <br><strong>PTToc.init(options)</strong> — merge runtime options into config, attach handlers, either do deferred build + background label warm (if <code>deferLabelsReload</code>) or block for initial <code>reloadLabels</code> then <code>buildOnce</code> and <code>observeMutations</code>. </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Defensive & resilience patterns used</strong><br>- Systematic <code>try/catch</code> around nearly every operation to avoid throwing and breaking host page.<br>- Singleton guard (<code>window.__pt_toc_installed</code>) and idempotent wrapper flags for wrappers and helpers.<br>- Feature-detection: <code>AbortController</code>, <code>MutationObserver</code>, <code>window.fetch</code>, <code>XMLHttpRequest</code> before using them.<br>- Timeouts for <code>fetchJsonOnce</code> to avoid long hangs; cache-bust query-params for label warming.<br>- Debounce (build) and throttle (auto-select, injectionSuppressMs) to reduce UI thrash and CPU load.<br>- DOM diffing (<code>itemsSignature</code>, <code>applyFragmentIfChanged</code>) to minimize repaint/DOM churn.<br>- Reuse of existing caption nodes when possible (<code>data-ptt-injected</code> marking) to reduce destructive DOM operations.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Notable behaviors & compatibility choices</strong><br>- <code>injectCaptionForElement</code> uses generated caption id <code>TableNN</code> — matches legacy expectations but may collide with existing pages using same id naming.<br>- <code>installGroupLoadInterceptor</code> watches for <code>/api/group/load</code> and <code>/api/convert</code> by substring — easy to trigger on similarly named endpoints; wrapper returns original Promise to callers to preserve behavior.<br>- <code>reloadLabels</code> expands relative candidates using global <code>__tv_base</code> if present to support deployments behind base paths.<br>- <code>deferLabelsReload</code> default <code>true</code> prefers fast initial UI paint and warms labels in background to avoid blocking page load.<br>- <code>PTToc</code> exposes <code>.build()</code> so host pages can force rebuilds; many globals used for cross-module coordination (<code>window.__ptt_labels_reload_promise</code>, <code>window.__ptt_labels_injected</code>).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Performance & scalability notes</strong><br>- Designed for small-to-medium pages: DOM diffing and debounce reduce cost of frequent changes.<br>- <code>fetchJsonOnce</code> per-candidate timeout prevents long stalls; <code>reloadLabels</code> is sequential—worst-case time = sum of per-candidate timeouts. For many label candidates this can be slow; <code>scheduleTocRefresh</code> mitigates by running two attempts spaced by <code>firstDelay</code>/<code>secondDelay</code>.<br>- <code>applyFragmentIfChanged</code> does shallow child-level comparison only (textContent/href), so it is cheap but can produce false positives on attribute-only changes requiring full replace.<br>- <code>injectCaptionForElement</code> suppression map (<code>_lastInjectionAt</code>) prevents repeated DOM ops but the per-target key is derived from <code>dataset.pttAnchorId</code> which may be newly generated — if anchors are re-created frequently, suppression loses effect.<br>- MutationObserver covers entire content root subtree which can be noisy on highly dynamic pages; debounce prevents excessive rebuilds but repeated large subtree mutations may still cause CPU work. Consider scoped observers or attribute filters if needed.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Security, integration & side-effect considerations</strong><br>- <strong>Global patching</strong>: overrides <code>window.fetch</code> and <code>window.XMLHttpRequest</code> (once) — may interact poorly with other instrumentation or polyfills. Flags <code>_fetchWrapped</code> / <code>_xhrWrapped</code> mitigate multi-wrap, but wrapping order with other libraries is unpredictable.<br>- <strong>DOM id generation</strong>: <code>ensureId</code> writes ids to host DOM; collisions are resolved but altering host markup may break other code depending on original node structure/ids.<br>- <strong>Inline styles</strong>: <code>injectCaptionForElement</code> sets <code>style.marginTop</code>/<code>marginLeft</code> inline — may violate strict CSP that blocks inline styles; recommend CSS classes instead.<br>- <strong>Logging</strong>: conditional <code>dbg</code>/<code>warn</code> rely on <code>window.tvDebug</code> — safe, but leaking debug output in production could reveal internal behavior.<br>- <strong>Label data trust</strong>: fetched <code>labels</code> are JSON and normalized into DOM text via <code>escapeHtml</code> in injection — good, but ensure <code>build</code>/<code>inject</code> paths always call escapeHtml before innerHTML insertion (they do in this file).<br>- <strong>History mutation</strong>: <code>onTocClick</code> uses <code>history.replaceState</code> without preserving scroll/rest state — acceptable but host should be aware.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Bugs, risky assumptions & edge cases</strong><br>1. <strong>fetchLabels lacks timeout</strong> — <code>fetchLabels</code> uses plain <code>fetch</code> and iterates sequentially; a single slow endpoint can delay fallback resolution. Use <code>fetchJsonOnce</code> or add per-request timeouts. <br>2. <strong>canonKey lossy</strong> — <code>canonKey</code> strips non-alphanumeric only at ends; internal punctuation remains and might produce inconsistent canonical keys across different label sources; consider full-normalization using Unicode <code>\p{L}\p{N}</code> and <code>String.prototype.normalize(&#x27;NFKC&#x27;)</code> for robust matching.<br>3. <strong>ID uniqueness assumptions</strong> — <code>ensureId</code> truncates to 60 chars then linear-probes <code>document.getElementById</code> for collisions. On very large DOMs this loop could be slow; also generating ids from textContent may produce unstable ids if host updates text frequently.<br>4. <strong>injection key instability</strong> — <code>injectCaptionForElement</code> uses <code>dataset.pttAnchorId</code> but assigns it lazily; if anchor elements are re-created (e.g., virtual DOM) keys are lost and suppression may not prevent thrash.<br>5. <strong>overbroad fetch/XHR detection</strong> — substring matching <code>&#x27;/api/group/load&#x27;</code> or <code>&#x27;/api/convert&#x27;</code> may match unrelated endpoints (e.g., <code>/internal/api/group/loadstats</code>) causing extra reloads; consider stricter matching or configurable patterns.<br>6. <strong>applyFragmentIfChanged shallow compare</strong> — it only compares textContent and first anchor href; structural or attribute-only changes will be considered equal and skipped even when they matter (e.g., <code>data-*</code> changes).<br>7. <strong>Unclear error recovery for reloadLabels promise</strong> — code resets <code>window.__ptt_labels_reload_promise</code> in places; concurrent callers may race. Use a single canonical promise and explicit cancelation semantics.<br>8. <strong>MutationObserver scope & filters</strong> — observes entire content root subtree without attribute filters and may trigger on unrelated mutations; heavy pages could see many debounce cycles. Consider <code>characterData</code>/<code>subtree</code> tuning or filtering by added/removed nodes that match selectors.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Maintainability observations</strong><br>- File is well-commented inline and uses consistent defensive style; however pervasive try/catch adds noise and can mask root causes during debugging.<br>- Many globals exposed/used (<code>window.__ptt_labels_reload_promise</code>, <code>window.__ptt_labels_injected</code>, <code>window.PTToc</code>, <code>window.__pt_toc_installed</code>) — document these integration contracts.<br>- Inline style operations and manual DOM creation repeats patterns (e.g., link creation, caption building) — factor into small helpers to reduce duplication.<br>- Wrapping native APIs (<code>fetch</code>, <code>XMLHttpRequest</code>) has maintenance burden and risks; consider event-based hooks (emit/dispatch) instead of global monkey-patching where possible.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Concrete recommended fixes (priority order)</strong><br><strong>High-priority</strong><br>- Replace <code>fetchLabels</code> with a timeout-aware variant (use <code>fetchJsonOnce</code> or add AbortController). <br>- Make <code>/api/*</code> trigger patterns configurable via <code>PTToc.config</code> and use stricter matching (exact path or regex).<br>- Move inline caption styles to CSS class and allow host to override via config, to avoid CSP and styling inconsistencies.<br>- Stabilize injection keys: compute stable keys from element <code>id</code> (ensureId) rather than ephemeral dataset generation; expose a cancellation API for pending injections if node removed. <br><strong>Medium-priority</strong><br>- Strengthen <code>canonKey</code> using <code>String.prototype.normalize(&#x27;NFKC&#x27;)</code> and Unicode-aware normalization; ensure key-matching tests cover non-ASCII scripts.<br>- Improve <code>applyFragmentIfChanged</code> to compare attributes or include a digest (e.g., text+href+dataset keys) to reduce false-negatives/positives.<br><strong>Low-priority / nice-to-have</strong><br>- Consider using <code>Element.replaceChildren()</code> when available for clearer semantics.<br>- Expose <code>PTToc.on(&#x27;labelsUpdated&#x27;, fn)</code> event so hosts can react instead of relying on global mutation scheduling.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Suggested tests</strong><br><strong>Unit</strong>: <code>ensureId</code> uniqueness & determinism with repeated runs and special characters; <code>canonKey</code> normalization across inputs (ASCII & Unicode); <code>normalizeLabels</code> flattening edge cases; <code>captionFor</code> lookup precedence (flat, prefix, padded); <code>itemsSignature</code> stability with whitespace changes. <br><strong>Integration</strong>: <code>fetchJsonOnce</code> timeout behavior; <code>reloadLabels</code> candidate fallback order and cache-bust handling; <code>injectCaptionForElement</code> reuse vs update vs collision path; <code>applyFragmentIfChanged</code> no-op vs replace behavior. <br><strong>E2E</strong>: Page with many dynamic nodes (virtual DOM or frequent mutations) to confirm debounce/injection suppression prevents flicker; pages with CSP forbidding inline-style to verify caption styling still shows when using CSS class fallback.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Compatibility & integration checklist</strong><br>- Document global names and side effects: <code>window.PTToc</code>, <code>window.__ptt_labels_reload_promise</code>, <code>window.__ptt_labels_injected</code>, <code>window.__pt_toc_installed</code>.<br>- Allow overriding of: label candidate list (<code>config.labelsPaths</code>), base expansion (<code>__tv_base</code> used by code), trigger patterns for refresh, debounce/throttle timings, and <code>injectionSuppressMs</code> for tight UIs.<br>- Provide opt-out for network instrumentation (a <code>PTToc.config.disableNetworkWrap = true</code>) to avoid interfering with other global wrappers.<br>- Provide a CSS snippet for <code>.table-caption</code> to avoid reliance on inline styles, and include a class-based fallback path in injection.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Potential regressions to watch for when changing code</strong><br>- Changing <code>ensureId</code> output format or truncation length will break any host code or bookmarks that rely on stable ids.<br>- Altering caption id strategy away from <code>TableNN</code> may break external anchors, legacy links, or host page automation expecting that id format.<br>- Removing or altering fetch/XHR wrappers will change auto-refresh behaviour for conversions and group-loads; document the change and provide migration path.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Final concise verdict</strong><br>Robust, pragmatic TOC/caption module emphasizing non-destructive updates, debouncing, and defensive coding. Well-suited for embedding in varied hosting contexts. Key improvements needed before large-scale deployment: add timeouts to all network fallbacks, harden key/canonicalization for Unicode, make network instrumentation configurable/safer, remove inline styles in favor of CSS classes, and stabilize injection keys to handle dynamic DOM frameworks. After those fixes and a small test-suite (ID/caption/injection/label-load), the module is production-ready for typical documentation and table-heavy pages.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr></tbody></table></div><div class="row-count">Rows: 14</div></div><div class="table-caption" id="Table2" data-table="Docu_0128_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5 • script.save.js</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical breakdown (script.save.js)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical breakdown (script.save.js)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Overview & intent</strong><br>Small, self-contained client-side module that provides a safe, UX-friendly flow for saving Markdown to a server endpoint (<code>/save-md</code>). Responsibilities: read Markdown from page elements, enforce a client-side max payload, prompt for a filename (sanitizing it), POST JSON to the save endpoint, present user-visible status updates (ARIA-friendly), emit namespaced CustomEvents for request/response, and expose a minimal programmatic API (<code>window.PTT_SAVE</code>). Designed to be drop-in via <code>&lt;script src=&quot;assets/script.save.js&quot; defer&gt;&lt;/script&gt;</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>High-level architecture</strong><br>1. <strong>Top-level config constants</strong> — <code>DEFAULT_MAX_PASTE_SIZE</code>, <code>SAVE_ENDPOINT</code>, DOM ID constants, and namespaced event names (<code>ptt:save-md-request</code>, <code>ptt:save-md-response</code>).<br>2. <strong>Utilities</strong> — small helpers for safe string trimming, element text extraction, meta lookup, UTF-8 byte-length calculation, filename sanitization, and debug logging.<br>3. <strong>Network layer</strong> — <code>postSaveMarkdown(markdown, filename, opts)</code> wraps <code>fetch</code> to POST JSON and normalizes server response to <code>{status, ok, json}</code> (JSON parsed with try/catch, non-JSON handled as <code>invalid_server_response</code>).<br>4. <strong>High-level save flow</strong> — <code>doSaveAction(opts)</code> coordinates validation, size enforcement, filename selection, calls <code>postSaveMarkdown</code>, updates status UI, dispatches response events, and returns Promises resolving to result objects for programmatic consumers.<br>5. <strong>Event wiring & host integration</strong> — <code>onSaveButtonClick</code> dispatches a cancelable <code>EVENT_REQUEST_MD</code> to allow integration interception; <code>attachHandlers</code> wires button click, window event listener for programmatic requests, and exposes <code>window.PTT_SAVE</code> API.<br>6. <strong>Initialization</strong> — <code>ready(fn)</code> executes <code>attachHandlers</code> on DOM ready.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Key functions (concise)</strong><br><strong>logDebug(...args)</strong> — Console debug wrapper using <code>console.debug</code> if present; defensive <code>apply</code> call. Useful only in development; no-op when console is absent. <br><strong>safeTrim(s)</strong> — Null-safe <code>String(s).trim()</code> wrapper with try/catch; always returns string. Protects callers from unexpected types or throwing <code>toString</code>. <br><strong>readElementText(id)</strong> — Safely reads an element by ID; returns <code>.value</code> when present, otherwise <code>textContent</code>/<code>innerText</code>, trimmed; returns <code>null</code> on error or if element missing. Used as primary content source for <code>PASTE_ID</code> and fallback area. <br><strong>getMeta(name)</strong> — Returns <code>&lt;meta name=&quot;...&quot;&gt;</code> <code>content</code> attribute or <code>null</code>; defensive try/catch. Used to override client max size via <code>ptt-max-paste-size</code> meta tag. <br><strong>getClientMaxSize()</strong> — Resolution order: <code>window.PTT_CONFIG.MAX_PASTE_SIZE</code> (only when that property is already a finite number), then <code>meta[name=&quot;ptt-max-paste-size&quot;]</code> parsed as int, otherwise <code>DEFAULT_MAX_PASTE_SIZE</code>. Returns integer bytes. <br><strong>utf8BytesLength(str)</strong> — Returns UTF-8 byte length. Preferred implementation uses <code>TextEncoder</code>; fallback uses <code>unescape(encodeURIComponent(str)).length</code>. Defensive try/catch for legacy environments. <br><strong>ensureMdSuffix(filename)</strong> — Ensures <code>.md</code> suffix (case-insensitive) using <code>String.prototype.endsWith</code>. Returns <code>undefined</code>-safe result. <br><strong>promptFilename(defaultName)</strong> — Uses <code>window.prompt</code> to get filename; trims, replaces path separators (<code>[\\/]+</code>) with <code>-</code>, then replaces characters outside <code>[a-zA-Z0-9._\- \u00A0-\uFFFF]</code> with <code>-</code>, caps length at 200, and appends <code>.md</code> if missing. Returns <code>null</code> when cancelled or invalid. Robust for basic localization due to <code>\u00A0-\uFFFF</code> unicode allowance. <br><strong>updateStatus(message, isError)</strong> — Writes message to element with id <code>STATUS_ID</code> if present; otherwise creates a visually-hidden but ARIA-live div (<code>ptt-live-status</code>) and sets <code>textContent</code>. Adds <code>role=&quot;alert&quot;</code> when <code>isError</code> to make screen-readers prioritize. Uses inline styles to hide offscreen element. <br><strong>dispatchResponseEvent(detail)</strong> — Creates and <code>window.dispatchEvent(new CustomEvent(EVENT_RESPONSE_MD, { detail }))</code>. Wraps in try/catch and logs failures. Response event is non-cancelable and bubbles. <br><strong>postSaveMarkdown(markdown, filename, opts)</strong> — Posts <code>{&quot;markdown&quot;, &quot;filename&quot;}</code> as JSON to <code>SAVE_ENDPOINT</code> via <code>fetch</code>. Uses <code>credentials</code> default <code>&#x27;same-origin&#x27;</code>, <code>cache: &#x27;no-store&#x27;</code>. Parses response as text then tries <code>JSON.parse</code>; on parse failure returns <code>{ok:false,error:invalid_server_response}</code> shape inside <code>json</code>. Always resolves a Promise with <code>{status, ok, json}</code>; network errors bubble to <code>.catch</code> in caller. <br><strong>doSaveAction(opts)</strong> — High-level flow: read markdown (from opts or DOM), validate presence, enforce size limit using <code>getClientMaxSize</code> and <code>utf8BytesLength</code>, determine filename (opts → prompt using document title fallback → cancellation handling), update status, call <code>postSaveMarkdown</code>, handle success (update status, create link if <code>json.url</code> present, dispatch response event with success detail), handle server error and network error paths. Errors are returned as resolved Promises with consistent error objects to simplify host code. Wraps most operations in try/catch and returns <code>Promise.resolve(...)</code> on synchronous errors. <br><strong>onSaveButtonClick(e)</strong> — Prevents default, dispatches a cancelable <code>EVENT_REQUEST_MD</code> (integrators may call <code>preventDefault()</code> on that event to cancel save). If not canceled, reads <code>detail.markdown</code> or UI sources and <code>detail.filename</code>, then calls <code>doSaveAction</code>. Catches and logs handler errors. <br><strong>attachHandlers()</strong> — Finds save button by <code>SAVE_BTN_ID</code> and attaches <code>onSaveButtonClick</code> unless <code>btn.dataset.__tv_save_attached</code> indicates core claimed it, or this script already attached <code>__ptt_save_md_attached</code>. Adds a global <code>window</code> listener for <code>EVENT_REQUEST_MD</code> allowing programmatic saves (<code>{ markdown, filename }</code>). Exposes <code>window.PTT_SAVE</code> API with <code>save(opts)</code> and <code>getClientMaxSize()</code>, or if <code>PTT_SAVE</code> already exists, attaches <code>saveMd</code>. Defensive dataset writes wrapped in try/catch. <br><strong>ready(fn)</strong> — DOM ready helper: if <code>document.readyState</code> is <code>&#x27;complete&#x27;</code> or <code>&#x27;interactive&#x27;</code> call <code>fn</code> via <code>setTimeout(fn,0)</code> else attach <code>DOMContentLoaded</code> with <code>{ once: true }</code>. </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Defensive patterns used</strong><br>- <strong>Widespread <code>try/catch</code></strong> around operations that touch DOM, <code>prompt</code>, <code>fetch</code>, <code>TextEncoder</code>, or <code>console</code>.<br>- <strong>Fail-safe return shapes</strong>: functions like <code>postSaveMarkdown</code> and <code>doSaveAction</code> always resolve with an object describing success or failure instead of throwing — simplifies host integration.<br>- <strong>Feature detection</strong>: <code>TextEncoder</code> usage guarded with try/catch; <code>console.debug</code> used only when available; safe checks for <code>btn.dataset</code> existence.<br>- <strong>Input sanitization</strong>: <code>promptFilename</code> removes path separators and strips disallowed characters; <code>ensureMdSuffix</code> guards filename extension.<br>- <strong>ARIA fallback</strong>: <code>updateStatus</code> uses a hidden ARIA-live element when <code>STATUS_ID</code> is absent so screen readers still receive updates.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Notable behaviors & compatibility choices</strong><br>- <code>getClientMaxSize</code> only accepts <code>window.PTT_CONFIG.MAX_PASTE_SIZE</code> if it is already a numeric primitive (uses <code>Number.isFinite</code>), ignoring numeric strings. Meta tag <code>ptt-max-paste-size</code> is supported and parsed via <code>parseInt</code>.<br>- <code>utf8BytesLength</code> prefers <code>TextEncoder</code> but falls back to <code>unescape(encodeURIComponent(...))</code> for older browsers — a tried pattern for byte counting.<br>- Uses <code>CustomEvent</code> (may need polyfill on older IE).<br>- Default <code>fetch</code> credentials include cookies (<code>same-origin</code>), meaning server-side CSRF protections should be present; module does not add CSRF headers itself.<br>- The module expects reasonably modern browsers (ES6 methods like <code>endsWith</code>, <code>Number.isFinite</code>, <code>TextEncoder</code>) but keeps defensive fallbacks for some features.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Performance & scalability notes</strong><br>- All work is synchronous or single-request per save; memory/CPU impact negligible for typical Markdown sizes under configured limit.<br>- <code>utf8BytesLength</code> fallback builds an encoded string and counts length — O(n) CPU and memory proportional to the text; acceptable within default max (1,000,000 bytes) but large payloads could be heavier on low-memory devices.<br>- No streaming or chunked upload support — entire Markdown payload sent in a single JSON body. For very large content consider file-upload endpoint or multipart/form-data to avoid JSON size limits.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Security, privacy & CSP considerations</strong><br>- <strong>CSRF:</strong> <code>fetch</code> uses <code>credentials: &#x27;same-origin&#x27;</code> so cookies will be sent. Server must validate CSRF tokens or use same-site cookies. The script does not automatically include an <code>X-CSRF-Token</code> header; consider reading a meta tag (e.g., <code>&lt;meta name=&quot;csrf-token&quot;&gt;</code>) and sending it in <code>postSaveMarkdown</code> when present.<br>- <strong>Filename sanitization:</strong> <code>promptFilename</code> removes slashes and disallowed characters but still allows <code>.</code> and <code>..</code> sequences in principle (though slashes are removed); server MUST validate and canonicalize <code>filename</code> and reject attempts to write outside allowed directories.<br>- <strong>XSS exposure in status area:</strong> <code>updateStatus</code> uses <code>textContent</code> (safe). When constructing an anchor in success path, it sets <code>href</code> directly from server <code>json.url</code>; if server is untrusted it could contain <code>javascript:</code> — recommend validating/normalizing server-provided URLs before inserting into DOM or set <code>a.rel=&#x27;noopener noreferrer&#x27;</code> (already set) and rely on <code>a.target=&#x27;_blank&#x27;</code> to open in new tab. The code sets <code>rel</code> and <code>target</code> appropriately. <br>- <strong>Prompt dialog</strong> can be abused by the hosting page or extensions; limiting filename character set is good practice. <br>- <strong>CSP:</strong> <code>updateStatus</code> injects a visually-hidden div and uses inline <code>style</code> assignments. In strict CSP environments that disallow inline styles this will still work because style is set via <code>el.style</code> (which is allowed), but if inserting inline <code>innerHTML</code> were used it could be blocked — this script does not use <code>innerHTML</code> for status.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Bugs / risky assumptions / edge cases</strong><br>1. <strong><code>getClientMaxSize</code> strict numeric check</strong> — The condition <code>Number.isFinite(window.PTT_CONFIG.MAX_PASTE_SIZE)</code> requires a numeric primitive. If integrators set <code>window.PTT_CONFIG.MAX_PASTE_SIZE = &quot;1000000&quot;</code> (string) it will be ignored; consider using <code>Number(window.PTT_CONFIG.MAX_PASTE_SIZE)</code> and <code>Number.isFinite</code> on the result.<br>2. <strong><code>endsWith</code> and <code>Number.isFinite</code> compatibility</strong> — These ES6 APIs are used without polyfill; older browsers (IE11) may fail. The script partially guards some features but not all. <br>3. <strong>CustomEvent and fetch assumptions</strong> — <code>CustomEvent</code> and <code>fetch</code> are broadly supported in modern browsers but not in very old ones; integration requiring legacy browser support will need polyfills. <br>4. <strong>Server non-JSON responses</strong> — <code>postSaveMarkdown</code> treats non-JSON server responses as <code>invalid_server_response</code> but still returns 200/ok if fetch succeeded; callers may expect structured error codes — ensure server returns predictable JSON. <br>5. <strong>Filename length & character set</strong> — <code>promptFilename</code> allows many Unicode characters up to <code>\uFFFF</code> but server/OS filesystems may not accept them. Server-side validation is required. <br>6. <strong>No cancellation for in-flight save</strong> — There is no AbortController or cancel API. If user closes the page or wants to cancel an ongoing save, no client-side cancellation exists. <br>7. <strong>No progress UI</strong> — <code>updateStatus(&#x27;Saving…&#x27;)</code> is textual only; network progress feedback (percent) not available for <code>fetch</code> JSON body requests. <br>8. <strong>Potential double-dispatch semantics</strong> — The module both dispatches <code>EVENT_REQUEST_MD</code> from <code>onSaveButtonClick</code> and listens for window <code>EVENT_REQUEST_MD</code> in <code>attachHandlers</code>. These have different intents (one is a cancelable outward event; the other listens for programmatic inbound requests). It's correct but could confuse integrators expecting symmetrical semantics.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Maintainability observations</strong><br>- File is short (~200–300 LOC) and well compartmentalized — good for maintenance.<br>- Clear separation between utilities, network, flow, and event wiring.<br>- Many <code>try/catch</code> blocks increase resilience but can hide bugs during development; consider enabling <code>logDebug</code> behind a runtime flag for better diagnostics.<br>- Global names introduced: <code>window.PTT_SAVE</code>, <code>ptt:save-md-request</code>, <code>ptt:save-md-response</code>, and <code>ptt-live-status</code>. Document these in integration docs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Concrete recommended fixes (priority order)</strong><br><strong>High-priority</strong><br>- <strong>Accept numeric-string config</strong>: change <code>getClientMaxSize</code> to coerce <code>window.PTT_CONFIG.MAX_PASTE_SIZE</code> using <code>Number(...)</code> then test <code>Number.isFinite(result)</code> so integrators using strings are supported.<br>- <strong>CSRF token support</strong>: read common meta names (e.g., <code>meta[name=&quot;csrf-token&quot;]</code>) and send an <code>X-CSRF-Token</code> header in <code>postSaveMarkdown</code> if present. Document server expectations. <br>- <strong>Filename server-side validation reminder</strong>: Add explicit comment/documentation warning that server must validate <code>filename</code> and not rely solely on client sanitization. <br><strong>Medium-priority</strong><br>- <strong>Add cancel API</strong>: expose a cancel mechanism (e.g., return an object from <code>doSaveAction</code> that includes an <code>abort()</code> using <code>AbortController</code> wired into <code>fetch</code>) so callers can cancel in-flight saves.<br>- <strong>Polyfills or graceful degradation for older browsers</strong>: either polyfill <code>CustomEvent</code>, <code>fetch</code>, <code>TextEncoder</code>, <code>endsWith</code>, <code>Number.isFinite</code> or detect and provide a clear no-op fallback and a console warning. <br>- <strong>Configurable endpoint</strong>: make <code>SAVE_ENDPOINT</code> overrideable via <code>window.PTT_CONFIG.SAVE_ENDPOINT</code> to avoid hardcoding. <br><strong>Low-priority / nice-to-have</strong><br>- Provide progress UI (upload progress) by switching to <code>XMLHttpRequest</code> for large payloads or use <code>fetch</code> with <code>ReadableStream</code> when supported.<br>- Allow injecting a <code>statusElement</code> or callback for host apps that want custom UI handling.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Suggested tests</strong><br><strong>Unit tests</strong>: <code>safeTrim</code> with edge types; <code>readElementText</code> on inputs and non-input elements; <code>getClientMaxSize</code> with numeric primitive, numeric string, meta tag present/absent; <code>utf8BytesLength</code> against known Unicode strings (ASCII, multi-byte, emojis); <code>ensureMdSuffix</code> with <code>.MD</code> uppercase; <code>promptFilename</code> sanitization for path-traversal chars and long names; <code>postSaveMarkdown</code> mock <code>fetch</code> returning JSON and non-JSON (text) to verify normalization.<br><strong>Integration tests</strong>: full <code>doSaveAction</code> flow against a test server verifying cookies/CSRF handling, saved file metadata returned, and link creation behavior; test <code>EVENT_REQUEST_MD</code> cancelation via <code>preventDefault()</code> on request event.<br><strong>E2E / load</strong>: attempt saving a near-limit payload (just under <code>MAX_PASTE_SIZE</code>) and one just above, confirm client rejects large payload; test upload on mobile/low-memory devices.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Compatibility & integration checklist</strong><br>- Document global API and events: <code>ptt:save-md-request</code> (cancelable), <code>ptt:save-md-response</code> (non-cancelable), and <code>window.PTT_SAVE.save(opts)</code> / <code>getClientMaxSize()</code>.<br>- Document server contract: expected JSON shape on success (<code>{ ok:true, filename, url, size, id, rel_path }</code>) and on error; require server to validate filename and enforce write paths.<br>- Recommend server return <code>Content-Type: application/json; charset=utf-8</code> and meaningful <code>status</code> codes for easier client diagnostics.<br>- Provide guidance for integrators that want to supply custom <code>SAVE_ENDPOINT</code>, custom status element id, or to opt out of prompt UX.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Potential regressions to watch for when changing code</strong><br>- Relaxing filename sanitization may introduce filesystem/path risks if server code relies on client sanitization (server must remain authoritative).<br>- Changing <code>getClientMaxSize</code> behavior may allow much larger payloads to be attempted — ensure server and network path can handle them.<br>- Introducing AbortController without fallback could break older browsers unless guarded.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Final concise verdict</strong><br>Well-scoped, defensive, and pragmatic save helper suitable for modern browsers. It correctly balances UX (prompt + status + ARIA) and robustness (many try/catch blocks, normalized fetch responses). Priorities before production hardening: accept numeric-string <code>PTT_CONFIG</code> values, add CSRF header support, and expose cancellation for in-flight saves. After those changes and adding a small integration note about server-side filename validation, the module is production-ready for single-page sites and progressive integrations.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr></tbody></table></div><div class="row-count">Rows: 14</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>