<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1763908802">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0128_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1 • script.table.js</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical breakdown (script.table.js)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical breakdown (script.table.js)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Overview & intent</strong><br>Client-side table utilities for PasteToTable focused on read-only caption safety, robust copying/export, TOC building, search/highlight, sorting, UI optimization, and multi-format export (CSV/JSON/XLSX/PDF). Designed to be defensive and interoperable with optional host utilities (<code>window.tvUtils</code>, <code>window.PTToc</code>, <code>window.XLSX</code>, <code>window.tvConfig</code>). The module avoids creating caption DOM (reads server-rendered captions only), prefers non-destructive operations (stores <code>data-orig-html</code>), and provides idempotent initialization via <code>initRenderedContent</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>High-level architecture</strong><br>1. <strong>Feature-detection wrappers</strong> — lightweight <code>safe</code>, <code>isString</code>, and fallbacks for clipboard/download/toast/debounce. <br>2. <strong>DOM helpers & locators</strong> — <code>getContentRoot</code>, <code>_findTocBarUl</code>, <code>safeGetTBody</code>, <code>getTableFromButton</code>, <code>getWrapperTitle</code>. <br>3. <strong>TOC builders</strong> — <code>buildSingleTableToc</code>, <code>buildTocFromCaptions</code>, <code>buildTocs</code> (prefers <code>window.PTToc</code>). <br>4. <strong>Row / sort state management</strong> — <code>_ensureRowUidsAndSnapshot</code>, <code>sortStates</code>, <code>originalRowOrders</code>, <code>updateHeaderSortUI</code>, <code>sortTableByColumn</code>, <code>headerSortButtonClicked</code>. <br>5. <strong>Collapse/expand & controls</strong> — <code>toggleTable</code>, <code>toggleAllTables</code>, <code>optimizeTableControls</code>, responsive adjustments and control re-parenting. <br>6. <strong>Search & highlighting</strong> — <code>normalizeForSearchLocal</code>, <code>buildNormalizedMapForCell</code>, <code>highlightMatches</code>, <code>clearHighlights</code>, <code>searchTable</code>. <br>7. <strong>Copy / export</strong> — <code>copyTablePlain</code>, <code>copyTableMarkdown</code>, <code>tableToMarkdownLines</code>, <code>formatCellForMarkdown</code>, <code>exportTableCSV</code>, <code>exportTableJSON</code>, <code>exportTableXLSX</code>, <code>exportTablePDF</code>, <code>exportAllBtnHandler</code>. <br>8. <strong>Source snapshot & mapping</strong> — IIFE <code>attachSourceSnapshotters</code>, <code>getPreferredSourceForTable</code>, <code>findMarkdownTableBlocks</code>, <code>splitSourceByBlankLines</code>. <br>9. <strong>Init & events</strong> — <code>initRenderedContent</code>, DOMContentLoaded/ready path, global click delegations for sort and TOC links, keybindings (<code>/</code>, <code>Escape</code>), <code>backToTop</code>. <br>10. <strong>Exports & integration</strong> — exposes <code>PasteToTable.initRenderedContent</code>, <code>PTTable.buildTocs</code>, and many <code>window.*</code> helpers for host usage.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Key functions (concise per-function notes)</strong><br><strong>safe(fn)</strong> — wrapper executes <code>fn()</code> catching exceptions; returns <code>undefined</code> on error. Use: protect optional one-off calls.<br><strong>isString(x)</strong> — strict <code>typeof x === &quot;string&quot;</code> predicate used across markdown/source helpers.<br><strong>copyToClipboard(text)</strong> — adaptive copy: uses <code>navigator.clipboard.writeText</code> when available; falls back to hidden <code>&lt;textarea&gt;</code> + <code>document.execCommand(&#x27;copy&#x27;)</code>. Returns Promise; rejects on failure. Handles focus/select and cleans up element. <br><strong>downloadBlob(blob, filename)</strong> — creates <code>ObjectURL</code>, injects hidden <code>&lt;a download&gt;</code>, clicks, schedules cleanup + revoke. Best-effort; silent on error. <br><strong>showToast(...)</strong> — delegates to host <code>tvUtils.showToast</code> or global <code>showToast</code>; final fallback logs to console. Used for user feedback on exports/copy. <br><strong>debounce(fn, wait)</strong> — fallback debounce (simple timeout) if host <code>tvUtils.debounce</code> absent. <br><strong>sanitizeText(s)</strong> — safe trimming with try/catch. <br><strong>getContentRoot()</strong> — returns content container (<code>#content</code>, <code>#tables-viewer</code>, or <code>document.body</code>) with try/catch fallback. <br><strong>_findTocBarUl(tocBar)</strong> — ensures a <code>&lt;ul&gt;</code> exists inside tocBar; returns existing <code>#tocBarList</code> or creates one. Defensive about nulls. <br><strong>buildSingleTableToc()</strong> — when a single table exists, finds canonical wrapper and table rows, creates stable per-row anchors (<code>tv-row-N</code>), sets <code>tabindex=-1</code>, builds list items in <code>#tocBar</code> with click handlers that smooth-scroll and focus target. Idempotent: clears existing <code>ul</code> children. Avoids inventing captions; uses row text summarization for labels. <br><strong>buildTocFromCaptions()</strong> — reads server-provided caption-like nodes (<code>.table-caption</code>, <code>.table-title</code>, <code>.table-heading</code>), ensures unique IDs without creating caption nodes, builds TOC entries in <code>#toc</code> and <code>#tocBar</code> by cloning list nodes. If none found, clears existing TOC lists. Click handlers similar to <code>buildSingleTableToc</code>. <br><strong>buildTocs()</strong> — integration entry that prefers <code>window.PTToc.init/build()</code> with specific selectors; falls back to <code>buildSingleTableToc</code> and <code>buildTocFromCaptions</code> and schedules delayed re-runs for dynamic content. <br><strong>safeGetTBody(table)</strong> — returns first <code>tBodies[0]</code> or <code>null</code> safely. <br><strong>_ensureRowUidsAndSnapshot(table, tableIdx)</strong> — assigns stable <code>data-tv-uid</code> to each row and stores original order into <code>originalRowOrders[tableIdx]</code> for stable restore; increments <code>_tv_row_uid_counter</code>. <br><strong>updateHeaderSortUI(tableIdx)</strong> — updates header button classes (<code>sort-state-0/1/2</code>), sets <code>aria-sort</code>, and swaps inline SVGs inside <code>.sort-icon</code> according to <code>sortStates</code>. Defensive DOM checks. <br><strong>sortTableByColumn(tableIdx, colIdx)</strong> — three-state sort cycle: (0) default → ascending numeric/lexicographic, (1) ascending → descending, (2) descending → restore original order using <code>originalRowOrders</code>. Numeric detection: <code>parseFloat</code> after removing commas/spaces. Preserves <code>data-orig-html</code> for cells, appends rows to tbody in new order, normalizes other header states to <code>0</code>, updates UI and row counts. <br><strong>headerSortButtonClicked(tableIdx, colIdx, btnEl)</strong> — simple wrapper to call <code>sortTableByColumn</code> and focus the button. Exposed on <code>window</code>. <br><strong>toggleTable(btn)</strong> — collapse/expand a single wrapper's tbody by toggling <code>display: none</code> and ARIA label & button text; updates <code>toggleAllBtn</code> text and calls <code>updateRowCounts</code>. Exposed. <br><strong>toggleAllTables()</strong> — toggles all wrappers collapsed/expanded collectively; updates per-wrapper toggle labels and <code>toggleAllBtn</code> label; calls <code>updateRowCounts</code>. Exposed. <br><strong>updateRowCounts()</strong> — per-wrapper row counting UI: writes "Showing X rows" or "Showing V of T rows" into <code>.row-count</code> elements; accounts for hidden rows (display: none). Robust to missing wrappers. <br><strong>formatCellForMarkdown(cell)</strong> — escapes pipe <code>|</code> with <code>\|</code>, replaces newlines with <code>&lt;br&gt;</code> and returns string suitable for inline pipe-markdown cell. Used by <code>tableToMarkdownLines</code>. <br><strong>tableToMarkdownLines(table, title)</strong> — builds array of markdown lines: optional bold title, header row from <code>rows[0]</code>, separator <code>---</code>, then data rows using <code>formatCellForMarkdown</code>; safe for empty tables. <br><strong>attachSourceSnapshotters() (IIFE)</strong> — binds input listener on <code>#paste</code> to set <code>window.__tv_last_source</code> on edits; captures click on convert buttons to snapshot and set <code>__tv_last_source_ts</code>. Idempotent and defensive. <br><strong>findMarkdownTableBlocks(source)</strong> — parses raw source into contiguous pipe-table blocks using header+separator detection; returns <code>[{start,end,lines}]</code>. Conservative rules: looks for <code>|</code> lines and <code>-</code> separator. <br><strong>splitSourceByBlankLines(source)</strong> — splits source on blank-line blocks and trims entries; used to match preferred source per table. <br><strong>getPreferredSourceForTable(table)</strong> — attempts to map <code>window.__tv_last_source</code> blocks to a DOM table: strategies — (a) if number of <code>.table-container table</code> equals number of source blocks, pick corresponding indexed block; (b) match by wrapper title proximity to lines near block start; (c) match by header cell content (token/length heuristics); (d) fallback to single block or source with <code>|</code>. Returns block string or <code>null</code>. Defensive: many fall-through heuristics and try/catch wrappers; returns null if uncertain. <br><strong>getWrapperTitle(wrapper)</strong> — read-only lookup for wrapper caption: checks <code>.table-caption</code>, h3/h2/h1, <code>aria-label</code>, and <code>data-table-id</code> dataset attributes; returns empty string if nothing found. Important: does NOT create caption nodes. <br><strong>getTableFromButton(btn)</strong> — resolves table by <code>data-tv-table-index</code> dataset (preferred) or nearest wrapper (<code>.table-wrapper</code>, <code>.table-container</code>, <code>[data-table-id]</code>) and returns the table element. Defensive parsing of dataset. <br><strong>copyTablePlain(btn)</strong> — copies tab-separated table text: builds title + rows (cells joined by <code>\t</code>), tries <code>tvUtils.showCopyModal</code> if available, else <code>copyToClipboard</code> then toasts success/failure with fallback to show modal on failure. If no table, falls back to <code>window.__tv_last_source</code>. Shows warnings if nothing to copy. Exposed on <code>window</code>. <br><strong>copyTableMarkdown(btn)</strong> — tries <code>getPreferredSourceForTable</code> first and copies raw markdown when available; otherwise builds markdown via <code>tableToMarkdownLines</code> and copies it; falls back to <code>__tv_last_source</code> if table absent. Uses same modal/copy/toast pattern as plain copy. Exposed. <br><strong>sanitizeFileName(name)</strong> — strips invalid filesystem characters, trims to 160 chars, default "table". Used by exports. <br><strong>exportTableCSV(btn, { filename } )</strong> — builds CSV from table rows with proper quoting for <code>&quot;</code> and <code>,</code> and newline handling; prepends BOM <code>\uFEFF</code>; uses <code>downloadBlob</code> to trigger save. Uses wrapper title or provided filename. Toasts. Exposed. <br><strong>exportTableJSON(btn, { filename })</strong> — extracts headers from <code>thead</code> or first row fallback <code>ColN</code>, builds array of objects (keys→cell text), stringifies prettily, creates Blob and triggers <code>downloadBlob</code>. Exposed. <br><strong>exportTableXLSX(btn, { filename })</strong> — attempts true XLSX export via SheetJS (<code>window.XLSX.utils</code>) if available (supports <code>writeFile</code> or <code>write</code> paths). If SheetJS missing, falls back to TSV saved with Excel-compatible MIME and warns. Uses <code>aoa</code> conversion of table rows. Exposed. <br><strong>exportTablePDF(btn, { filename })</strong> — builds small standalone HTML doc (inline styles), opens new window/tab, writes document and calls <code>print()</code> to let user save as PDF; toasts on failure. Exposed. <br><strong>clearHighlights(cell)</strong> — restores <code>cell.innerHTML</code> from <code>data-orig-html</code> if present, else unwraps <code>&lt;mark&gt;</code> elements by replacing them with text nodes. Non-destructive. <br><strong>normalizeForSearchLocal(s)</strong> — Unicode-aware normalization: prefers host <code>__tv_utils.normalizeForSearchLocal</code>; otherwise attempts <code>toLowerCase().normalize(&quot;NFD&quot;)</code>, strips diacritics, removes non-letter/number/space using <code>\p{L}\p{N}</code> with <code>u</code> flag, falls back to <code>\w</code>. Defensive try/catch branches for environment support. <br><strong>buildNormalizedMapForCell(cell)</strong> — builds a normalized string and a positional <code>map</code> linking each normalized character back to a specific text node and offset. Uses a TreeWalker to collect text nodes, iterates by codepoints (handles surrogate pairs), applies NFD decomposition and diacritic stripping, and preserves per-character mapping for accurate highlight insertion. Returns <code>{normStr, map, nodes}</code>. <br><strong>highlightMatches(cell, filterNorm)</strong> — uses <code>buildNormalizedMapForCell</code> to find matches of normalized needle inside <code>normStr</code>, computes start/end node/offsets for each match, then wraps matched text ranges in <code>&lt;mark&gt;</code> elements. Works backward from end to start to preserve offsets; supports matches spanning multiple text nodes by extracting and moving nodes under <code>&lt;mark&gt;</code>. Respects <code>data-orig-html</code> to reset first. <br><strong>searchTable()</strong> — main search entry: reads search input (multiple selectors), computes <code>filterNorm</code>, iterates tables and rows, clears previous highlights, hides non-matching rows (<code>display: none</code>), applies <code>highlightMatches</code> if <code>window.tvConfig.highlight</code> truthy, scrolls to firstMatch smoothly, requests table virtualizer refresh if present, and updates row counts. Exposed. <br><strong>optimizeTableControls()</strong> — responsive control layout adjustments: detects mobile via <code>(max-width:600px)</code>, moves copy buttons into <code>.copy-buttons</code> container, repositions toggle button to left, applies per-button inline style adjustments for mobile vs desktop. Uses best-effort DOM mutations; non-destructive. Debounced and bound to <code>resize</code>/<code>matchMedia</code> change. <br><strong>initRenderedContent()</strong> — consolidated initialization: wraps standalone tables into <code>.table-container</code> if missing, calls <code>buildTocs</code>, ensures row uids/snapshots, caches <code>data-orig-html</code>, updates header UI icons, sets toggle button labels, creates <code>backToTop</code> if missing, wires search box listeners (debounced), attaches per-table handlers for copy/export/toggle buttons (idempotent via dataset flags), calls <code>optimizeTableControls</code>, <code>updateRowCounts</code>, and scrolls first table into view. Idempotent and safe to call multiple times. Exposed via <code>PasteToTable.initRenderedContent</code>. <br><strong>exportAllBtnHandler()</strong> — collects all <code>.table-wrapper</code> tables and does multi-sheet XLSX export if SheetJS present; otherwise concatenates markdown for all tables and downloads as <code>all_tables.md</code>. Uses <code>getWrapperTitle</code> for sheet names (limited to 31 chars). Exposed. <br><strong>backToTop()</strong> — smooth scroll to top; exposed and bound to <code>backToTop</code> button. <br><strong>Event delegations & global listeners</strong> — two delegated <code>document.click</code> handlers: (1) sorting via <code>.sort-btn</code> / <code>.th-with-sort</code> detection which maps to <code>headerSortButtonClicked</code>; (2) TOC link clicks under <code>#tocBar</code> to smooth-scroll to id or wrapper. <code>window.scroll</code> listener toggles <code>#backToTop</code> visibility. Keydown listener (<code>/</code> to focus search; <code>Escape</code> triggers backToTop) bound on init. Many listeners are defensive and wrapped.                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Defensive patterns used</strong><br>- Ubiquitous <code>try/catch</code> to avoid breaking host pages.<br>- Feature detection for <code>navigator.clipboard</code>, <code>window.XLSX</code>, <code>window.PTToc</code>, <code>window.tvUtils</code>, <code>window.__tv_utils</code>.<br>- Idempotent init: uses dataset flags (<code>tvBound</code>, <code>tvHandlerAttached</code>) and checks for existing wrappers/elements before creation.<br>- Non-destructive content handling: caches original HTML in <code>data-orig-html</code> and uses it to restore highlights; does not create caption elements (read-only principle).<br>- Unicode-aware processing with fallbacks: uses <code>\p{L}\p{N}</code> where supported, falls back to <code>\w</code> when not. Handles surrogate pairs and diacritics explicitly. <br>- Accessibility considerations: sets <code>tabindex=-1</code> on row anchors, <code>aria-sort</code> proper values, <code>aria-label</code> on anchors, and updates <code>aria-expanded</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Notable behaviors & integration choices</strong><br>- <strong>Caption safety</strong>: intentionally reads caption-like nodes only; never creates captions; avoids content injection. <br>- <strong>Source-first copy</strong>: <code>copyTableMarkdown</code> prefers the original source block (<code>__tv_last_source</code>) when it confidently maps to a table — preserves author intent and runtime provenance. <br>- <strong>SheetJS optional</strong>: XLSX exports prefer SheetJS but provide TSV fallback for environments where SheetJS isn't loaded. <br>- <strong>UI styling</strong>: many inline style manipulations inside <code>optimizeTableControls</code> to ensure control layout without requiring external CSS; acceptable but may clash with strict CSP or theming. <br>- <strong>Search tokenization</strong>: <code>normalizeForSearchLocal</code> aggressively strips punctuation but attempts robust Unicode normalization; this behavior affects what is considered a match (good for accent-insensitive search). <br>- <strong>Non-blocking UX</strong>: debounced search, delayed re-builds (<code>setTimeout</code>), and best-effort layout moves reduce layout thrashing on init.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Performance & scalability notes</strong><br>- <strong>Highlighting complexity</strong>: <code>buildNormalizedMapForCell</code> iterates every text node and every character by codepoint; for very large cells or tables with thousands of rows, highlighting can be CPU-heavy. Consider throttling or virtualizing highlight operations for very large tables. <br>- <strong>Sorting stability</strong>: restoring original order relies on <code>originalRowOrders</code> captured on init; subsequent DOM mutations (rows added/removed) may desynchronize snapshots — callers must re-run <code>initRenderedContent</code> when tables change. <br>- <strong>I/O & Blob generation</strong>: export functions create in-memory strings/blobs; exporting extremely large tables may cause memory spikes. Suggest streaming exports for huge datasets or server-side export endpoints. <br>- <strong>DOM reflows</strong>: <code>optimizeTableControls</code> manipulates inline styles and element insertion per-wrapper; on pages with many wrappers this can cause layout churn. Debounced invocation mitigates but consider batching or CSS-only approach.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Security, privacy & CSP considerations</strong><br>- <strong>CSP</strong>: inline <code>style</code> assignments and <code>innerHTML</code> usage for SVG icons and <code>table.outerHTML</code> in PDF export may be blocked by CSP policies. Recommend providing CSS classes and using safe DOM methods for icons (SVG <code>&lt;use&gt;</code> or CSS). <br>- <strong>HTML injection risk</strong>: <code>updateHeaderSortUI</code> uses <code>innerHTML</code> to insert SVG markup; it's low-risk but ensure the SVG strings are constant and not influenced by user input. <br>- <strong>Clipboard fallback</strong>: using <code>document.execCommand(&#x27;copy&#x27;)</code> relies on DOM insertion of a textarea; some environments may restrict clipboard access — fallback shows copy modal when available. <br>- <strong>Open window printing</strong>: <code>exportTablePDF</code> opens a new window and writes <code>table.outerHTML</code> into it. If a host page's table contains sensitive inline scripts or event handlers, those are serialized to HTML but not executed in the new doc; still verify sanitized content if host requires strict privacy.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr></tbody></table></div><div class="row-count">Rows: 7</div></div><div class="table-caption" id="Table2" data-table="Docu_0128_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2 • script.save.js</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical breakdown (script.save.js)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical breakdown (script.save.js)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Overview & intent</strong> — Self-contained client-side module responsible for saving Markdown to a server endpoint (<code>/save-md</code>). Reads Markdown from page elements, enforces a max payload, prompts for a sanitized filename, POSTs JSON, updates status UI (ARIA-safe), emits namespaced events, and exposes <code>window.PTT_SAVE</code>. Designed for drop-in inclusion via <code>&lt;script src=&quot;assets/script.save.js&quot; defer&gt;</code>. </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>High-level architecture</strong> — (1) Top-level config constants: max size, IDs, event names. (2) Utilities for trimming, text extraction, meta lookup, UTF-8 byte counting, filename sanitization, debug logging. (3) Network call wrapper <code>postSaveMarkdown</code>. (4) Orchestrator <code>doSaveAction</code>. (5) Event wiring + programmatic API exposure. (6) DOM-ready initialization via <code>ready()</code>. </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Key functions (concise)</strong> — <code>logDebug</code> (safe console debug); <code>safeTrim</code> (null-safe trimming); <code>readElementText</code> (safe ID fetch for Markdown text); <code>getMeta</code> (meta lookup); <code>getClientMaxSize</code> (derive max bytes via config → meta → default); <code>utf8BytesLength</code> (byte count using <code>TextEncoder</code> with fallback); <code>ensureMdSuffix</code> (append <code>.md</code> if missing); <code>promptFilename</code> (prompt, sanitize, enforce 200-char cap, ensure suffix); <code>updateStatus</code> (write to status element or ARIA-live fallback); <code>dispatchResponseEvent</code> (emit non-cancelable response event); <code>postSaveMarkdown</code> (POST JSON, normalize response); <code>doSaveAction</code> (full validation + POST + UI updates); <code>onSaveButtonClick</code> (UI entrypoint, cancelable request event); <code>attachHandlers</code> (bind events, expose API); <code>ready</code> (DOM-ready helper). </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Defensive patterns</strong> — Extensive try/catch around DOM, fetch, prompt, console. Consistent resolved Promise shapes for error paths. Feature detection for <code>TextEncoder</code> and console. Sanitization of filenames and removal of separators. ARIA-live fallback when status element missing. </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Notable behaviors & compatibility</strong> — <code>getClientMaxSize</code> accepts numeric config only when already finite; meta override parsed via <code>parseInt</code>. UTF-8 length calculation has robust fallback. Uses <code>CustomEvent</code> (polyfill needed on very old browsers). <code>fetch</code> uses <code>same-origin</code> credentials. Relies on modern JS but includes fallback logic for key areas. </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Performance & scalability notes</strong> — All operations are synchronous or single-request-per-save. <code>utf8BytesLength</code> performs an O(n) encode/count fallback; acceptable under the configured byte limit (default 1,000,000). No chunked/streaming upload; large Markdown bodies are sent as a single JSON payload. </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Security, privacy & CSP considerations</strong> — Uses <code>credentials: &#x27;same-origin&#x27;</code>; server must enforce CSRF protection. No automatic <code>X-CSRF-Token</code> header; can be added via meta lookup. Filename sanitization strips slashes but server must still validate and canonicalize. Status uses <code>textContent</code> (safe). <code>href</code> uses server-provided URL; recommend validating/normalizing responses and relying on <code>rel=&quot;noopener noreferrer&quot;</code>. Inline style assignments are CSP-safe because they use <code>el.style</code>. </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Bugs / risky assumptions / edge cases</strong> — 1) <code>getClientMaxSize</code> ignores numeric strings; coercion recommended. 2) Uses ES6 APIs without polyfills; older browsers may break. 3) <code>CustomEvent</code>/<code>fetch</code> assumptions require modern environments. 4) Non-JSON server responses treated generically. 5) Filename Unicode may be unsupported server-side. 6) No cancellation via AbortController. 7) No progress UI. 8) Confusing dual semantics of save request/response events. </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Maintainability observations</strong> — Compact file with clear separation of utilities, network, and flow. Heavy try/catch increases resilience but can obscure development errors; optional debug logging flag recommended. Global symbols (<code>PTT_SAVE</code>, <code>ptt:save-md-request</code>, <code>ptt:save-md-response</code>, <code>ptt-live-status</code>) should be documented. </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Concrete recommended fixes (priority order)</strong> — <strong>High:</strong> numeric-string config acceptance; CSRF token header support; explicitly document required server-side filename validation. <strong>Medium:</strong> provide cancel API using <code>AbortController</code>; add polyfills or graceful degradation; allow configurable endpoint. <strong>Low:</strong> optional progress UI; pluggable status callback. </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Suggested tests</strong> — <strong>Unit:</strong> <code>safeTrim</code>; <code>readElementText</code>; <code>getClientMaxSize</code> variants; <code>utf8BytesLength</code> on ASCII/Unicode/emoji; <code>ensureMdSuffix</code>; filename sanitization; <code>postSaveMarkdown</code> JSON vs non-JSON. <strong>Integration:</strong> full save flow with CSRF handling; event cancelation via <code>preventDefault</code>. <strong>E2E/load:</strong> near-limit and over-limit payloads on mobile/low-memory devices. </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Compatibility & integration checklist</strong> — Document global API/events; specify server JSON contract and error codes; recommend server <code>Content-Type: application/json</code>; advise integrators on custom endpoints, status element overrides, and opting out of prompt UX. </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Potential regressions to watch</strong> — Looser filename sanitization may cause filesystem/path issues; larger configured limits may exceed server capabilities; AbortController usage must have fallback for older browsers. </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Final concise verdict</strong> — The module is robust and production-suitable with small targeted improvements: numeric-string config handling, CSRF header support, and an abort mechanism. With these applied and server-side filename validation enforced, the helper is ready for integration. </td></tr></tbody></table></div><div class="row-count">Rows: 14</div></div><div class="table-caption" id="Table3" data-table="Docu_0128_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3 • script.toc.js</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical breakdown (script.toc.js)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical breakdown (script.toc.js)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Overview & intent</strong><br>Lightweight, defensive Table-of-Contents (TOC) and caption-injection module for PasteToTable. Responsibilities: discover headings/tables, compute stable IDs, build minimal DOM TOC fragments, idempotently update UI (diff + signature), inject or reuse table captions from external label data, throttle and debounce rebuilds/injections to reduce flicker, and auto-select a likely first table. Maintains backward-compatible public surface (<code>window.PTToc</code>, <code>PTToc.build</code>, <code>PTToc.init</code>, <code>PTToc.reloadLabels</code>, <code>PTToc.getLabels</code>, <code>PTToc.applyLabelsNow</code>, <code>PTToc.scheduleTocRefresh</code>). Designed for resilience (try/catch) and minimal visual churn.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>High-level architecture</strong><br>1. <strong>Singleton guard & config</strong> — top-level IIFE prevents double-install via <code>window.__pt_toc_installed</code>. <code>PTToc.config</code> centralizes selectors, label paths, timings, and feature flags (<code>deferLabelsReload</code>, <code>autoSelectTable1Enabled</code>).<br>2. <strong>Label subsystem</strong> — <code>reloadLabels</code>, <code>getLabels</code>, <code>normalizeLabels</code>, and a lazy install IIFE <code>installLabelsHelpers()</code> that wires <code>PTToc._reloadPromise</code> and global aliases (<code>window.__ptt_labels_reload_promise</code>, <code>window.__ptt_labels_injected</code>).<br>3. <strong>Fetch helpers</strong> — <code>fetchJsonOnce</code> uses <code>fetch</code> + <code>AbortController</code> (if available) with a per-request timeout and returns <code>null</code> on any failure; <code>fetchLabels</code> is a simple sequential candidate fetch fallback without explicit timeout handling.<br>4. <strong>ID & caption helpers</strong> — <code>ensureId</code>, <code>canonKey</code>, <code>captionFor</code>, <code>injectCaptionForElement</code> provide stable id generation, canonicalization of label keys, label lookup, and throttled caption injection/reuse.<br>5. <strong>TOC builder</strong> — <code>buildItemsFromSingleTable</code>, <code>buildItemsFromHeadings</code>, <code>itemsSignature</code>, <code>buildOnce</code>, <code>debounceBuild</code> assemble item lists and apply DOM changes only when signature differs.<br>6. <strong>Minimal DOM-apply layer</strong> — <code>applyFragmentIfChanged</code> performs a shallow compare of existing vs new child nodes then atomically replaces children only when necessary.<br>7. <strong>Event wiring & lifecycle</strong> — <code>attachDelegatedHandlers</code> attaches delegated click/hash handlers and conversion-button listener; <code>observeMutations</code> monitors content root and debounces rebuilds; init flow (<code>PTToc.init</code>) supports deferred label warm/cold flows and background label warming.<br>8. <strong>Network instrumentation</strong> — <code>installGroupLoadInterceptor</code> safely wraps <code>fetch</code> and <code>XMLHttpRequest</code> once to trigger <code>scheduleTocRefresh</code> on <code>/api/group/load</code> or <code>/api/convert</code> traffic.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Key functions & responsibilities (concise)</strong><br><strong>ensureId(el, prefix)</strong> — produce a stable element id from element text, normalize and sanitize, truncate to 60 chars; avoid collisions by suffixing numeric increments; assigns id to element.<br><strong>_normalize_heading_text(raw)</strong> — strip tags/linebreaks and collapse whitespace for id/text normalization.<br><strong>makeLink(id, text, extraClass)</strong> — DOM helper: create <code>&lt;li&gt;&lt;a&gt;</code> with <code>href=#id</code>, <code>data-pt-target</code> and aria attributes.<br><strong>fetchJsonOnce(url, timeoutMs)</strong> — safe fetch with optional AbortController timeout; returns parsed JSON or <code>null</code> on any error; logs via <code>dbg</code>.<br><strong>canonKey(s)</strong> — minimal canonicalization for label keys: trims, collapses spaces, strips non-alphanumeric at ends, lowercases.<br><strong>normalizeLabels(raw)</strong> — flattens nested label objects and maps keys through <code>canonKey</code>, producing <code>PTToc._labels</code> map.<br><strong>installLabelsHelpers() / PTToc.reloadLabels(opts)</strong> — sequence over candidate <code>labelsPaths</code> (expanded by <code>__tv_base</code>), optional cache-bust, sequential probe with per-candidate timeout (uses <code>fetchJsonOnce</code>), sets <code>_labels</code> and calls <code>PTToc.build()</code> when successful.<br><strong>PTToc.getLabels() / PTToc.applyLabelsNow(labelsObj)</strong> — read and write helpers; <code>applyLabelsNow</code> replaces <code>_labels</code> and rebuilds immediately.<br><strong>fetchLabels(paths)</strong> — fallback sequential fetcher returning first JSON body; lacks per-request timeout; used where <code>reloadLabels</code> not present.<br><strong>captionFor(labelsObj, bookPrefix, idx)</strong> — multiple lookup strategies (flat key variants, nested book prefix, padded numbers, canonKey) to return caption string or <code>null</code>.<br><strong>injectCaptionForElement(anchorEl, bookPrefix, idx, captionText)</strong> — idempotent caption injection with suppression window (<code>injectionSuppressMs</code>), reuses existing caption nodes, updates text if changed, avoids heavy churn, assigns <code>data-ptt-injected</code>, inline styling and generated id <code>TableNN</code> (with collision resolution).<br><strong>buildItemsFromSingleTable(table, labels, bookPrefix)</strong> — iterate rows (tbody precedence), ensure row ids, resolve caption label for each row or fall back to <code>rowLabelPrefix</code>.<br><strong>buildItemsFromHeadings(labels, bookPrefix)</strong> — collect configured headings, ensure ids, normalize text, optionally inject captions for matched headings.<br><strong>itemsSignature(items)</strong> — create compact signature string from id::label pairs used to detect changes.<br><strong>applyFragmentIfChanged(container, frag)</strong> — shallow compare childNodes (textContent and first anchor href), replace only if necessary; atomic replacement via clearChildren+appendChild.<br><strong>buildOnce()</strong> — orchestrates table/heading discovery, label-driven caption injection, signature check, fragment creation, minimal apply, highlight current location, and pending auto-select handling.<br><strong>debounceBuild()</strong> — debounce timer wrapper for <code>buildOnce</code> using <code>_debounceMs</code>.<br><strong>highlightCurrentFromLocation()</strong> — set <code>aria-current</code> on matching TOC link based on <code>location.hash</code>.<br><strong>onTocClick(ev)</strong> — delegated click handler: smooth scroll to target accounting for sticky header offset, prevent default, update history/hash and call <code>highlightCurrentFromLocation</code> after scroll.<br><strong>selectTable1()</strong> — heuristic auto-click of first Table1 candidate (by <code>data-pt-target</code> or visible text); throttle via <code>autoSelectThrottleMs</code> and <code>_lastAutoSelectAt</code>.<br><strong>scheduleTocRefresh(opts)</strong> — guarded scheduled refresh that can perform two label reload attempts (firstDelay, secondDelay), builds expanded candidate lists with <code>__tv_base</code>, uses cache-busted variants, updates <code>_labels</code> and calls <code>PTToc.build()</code>; deduplicates concurrent scheduling via <code>_scheduledRefreshFlag</code>.<br><strong>installGroupLoadInterceptor()</strong> — wraps global <code>fetch</code> and <code>XMLHttpRequest</code> once; when targets match <code>/api/group/load</code> or <code>/api/convert</code> triggers <code>scheduleTocRefresh({autoSelect:true})</code> on load/error; sets flags <code>_fetchWrapped</code>/<code>_xhrWrapped</code> to avoid double-wrapping.<br><strong>attachDelegatedHandlers() / observeMutations()</strong> — wire up document-level click, hashchange, mutation observer on content root (childList + subtree), and convert-click listener. <br><strong>PTToc.init(options)</strong> — merge runtime options into config, attach handlers, either do deferred build + background label warm (if <code>deferLabelsReload</code>) or block for initial <code>reloadLabels</code> then <code>buildOnce</code> and <code>observeMutations</code>. </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Defensive & resilience patterns used</strong><br>- Systematic <code>try/catch</code> around nearly every operation to avoid throwing and breaking host page.<br>- Singleton guard (<code>window.__pt_toc_installed</code>) and idempotent wrapper flags for wrappers and helpers.<br>- Feature-detection: <code>AbortController</code>, <code>MutationObserver</code>, <code>window.fetch</code>, <code>XMLHttpRequest</code> before using them.<br>- Timeouts for <code>fetchJsonOnce</code> to avoid long hangs; cache-bust query-params for label warming.<br>- Debounce (build) and throttle (auto-select, injectionSuppressMs) to reduce UI thrash and CPU load.<br>- DOM diffing (<code>itemsSignature</code>, <code>applyFragmentIfChanged</code>) to minimize repaint/DOM churn.<br>- Reuse of existing caption nodes when possible (<code>data-ptt-injected</code> marking) to reduce destructive DOM operations.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Notable behaviors & compatibility choices</strong><br>- <code>injectCaptionForElement</code> uses generated caption id <code>TableNN</code> — matches legacy expectations but may collide with existing pages using same id naming.<br>- <code>installGroupLoadInterceptor</code> watches for <code>/api/group/load</code> and <code>/api/convert</code> by substring — easy to trigger on similarly named endpoints; wrapper returns original Promise to callers to preserve behavior.<br>- <code>reloadLabels</code> expands relative candidates using global <code>__tv_base</code> if present to support deployments behind base paths.<br>- <code>deferLabelsReload</code> default <code>true</code> prefers fast initial UI paint and warms labels in background to avoid blocking page load.<br>- <code>PTToc</code> exposes <code>.build()</code> so host pages can force rebuilds; many globals used for cross-module coordination (<code>window.__ptt_labels_reload_promise</code>, <code>window.__ptt_labels_injected</code>).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Performance & scalability notes</strong><br>- Designed for small-to-medium pages: DOM diffing and debounce reduce cost of frequent changes.<br>- <code>fetchJsonOnce</code> per-candidate timeout prevents long stalls; <code>reloadLabels</code> is sequential—worst-case time = sum of per-candidate timeouts. For many label candidates this can be slow; <code>scheduleTocRefresh</code> mitigates by running two attempts spaced by <code>firstDelay</code>/<code>secondDelay</code>.<br>- <code>applyFragmentIfChanged</code> does shallow child-level comparison only (textContent/href), so it is cheap but can produce false positives on attribute-only changes requiring full replace.<br>- <code>injectCaptionForElement</code> suppression map (<code>_lastInjectionAt</code>) prevents repeated DOM ops but the per-target key is derived from <code>dataset.pttAnchorId</code> which may be newly generated — if anchors are re-created frequently, suppression loses effect.<br>- MutationObserver covers entire content root subtree which can be noisy on highly dynamic pages; debounce prevents excessive rebuilds but repeated large subtree mutations may still cause CPU work. Consider scoped observers or attribute filters if needed.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Security, integration & side-effect considerations</strong><br>- <strong>Global patching</strong>: overrides <code>window.fetch</code> and <code>window.XMLHttpRequest</code> (once) — may interact poorly with other instrumentation or polyfills. Flags <code>_fetchWrapped</code> / <code>_xhrWrapped</code> mitigate multi-wrap, but wrapping order with other libraries is unpredictable.<br>- <strong>DOM id generation</strong>: <code>ensureId</code> writes ids to host DOM; collisions are resolved but altering host markup may break other code depending on original node structure/ids.<br>- <strong>Inline styles</strong>: <code>injectCaptionForElement</code> sets <code>style.marginTop</code>/<code>marginLeft</code> inline — may violate strict CSP that blocks inline styles; recommend CSS classes instead.<br>- <strong>Logging</strong>: conditional <code>dbg</code>/<code>warn</code> rely on <code>window.tvDebug</code> — safe, but leaking debug output in production could reveal internal behavior.<br>- <strong>Label data trust</strong>: fetched <code>labels</code> are JSON and normalized into DOM text via <code>escapeHtml</code> in injection — good, but ensure <code>build</code>/<code>inject</code> paths always call escapeHtml before innerHTML insertion (they do in this file).<br>- <strong>History mutation</strong>: <code>onTocClick</code> uses <code>history.replaceState</code> without preserving scroll/rest state — acceptable but host should be aware.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Bugs, risky assumptions & edge cases</strong><br>1. <strong>fetchLabels lacks timeout</strong> — <code>fetchLabels</code> uses plain <code>fetch</code> and iterates sequentially; a single slow endpoint can delay fallback resolution. Use <code>fetchJsonOnce</code> or add per-request timeouts. <br>2. <strong>canonKey lossy</strong> — <code>canonKey</code> strips non-alphanumeric only at ends; internal punctuation remains and might produce inconsistent canonical keys across different label sources; consider full-normalization using Unicode <code>\p{L}\p{N}</code> and <code>String.prototype.normalize(&#x27;NFKC&#x27;)</code> for robust matching.<br>3. <strong>ID uniqueness assumptions</strong> — <code>ensureId</code> truncates to 60 chars then linear-probes <code>document.getElementById</code> for collisions. On very large DOMs this loop could be slow; also generating ids from textContent may produce unstable ids if host updates text frequently.<br>4. <strong>injection key instability</strong> — <code>injectCaptionForElement</code> uses <code>dataset.pttAnchorId</code> but assigns it lazily; if anchor elements are re-created (e.g., virtual DOM) keys are lost and suppression may not prevent thrash.<br>5. <strong>overbroad fetch/XHR detection</strong> — substring matching <code>&#x27;/api/group/load&#x27;</code> or <code>&#x27;/api/convert&#x27;</code> may match unrelated endpoints (e.g., <code>/internal/api/group/loadstats</code>) causing extra reloads; consider stricter matching or configurable patterns.<br>6. <strong>applyFragmentIfChanged shallow compare</strong> — it only compares textContent and first anchor href; structural or attribute-only changes will be considered equal and skipped even when they matter (e.g., <code>data-*</code> changes).<br>7. <strong>Unclear error recovery for reloadLabels promise</strong> — code resets <code>window.__ptt_labels_reload_promise</code> in places; concurrent callers may race. Use a single canonical promise and explicit cancelation semantics.<br>8. <strong>MutationObserver scope & filters</strong> — observes entire content root subtree without attribute filters and may trigger on unrelated mutations; heavy pages could see many debounce cycles. Consider <code>characterData</code>/<code>subtree</code> tuning or filtering by added/removed nodes that match selectors.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Maintainability observations</strong><br>- File is well-commented inline and uses consistent defensive style; however pervasive try/catch adds noise and can mask root causes during debugging.<br>- Many globals exposed/used (<code>window.__ptt_labels_reload_promise</code>, <code>window.__ptt_labels_injected</code>, <code>window.PTToc</code>, <code>window.__pt_toc_installed</code>) — document these integration contracts.<br>- Inline style operations and manual DOM creation repeats patterns (e.g., link creation, caption building) — factor into small helpers to reduce duplication.<br>- Wrapping native APIs (<code>fetch</code>, <code>XMLHttpRequest</code>) has maintenance burden and risks; consider event-based hooks (emit/dispatch) instead of global monkey-patching where possible.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Concrete recommended fixes (priority order)</strong><br><strong>High-priority</strong><br>- Replace <code>fetchLabels</code> with a timeout-aware variant (use <code>fetchJsonOnce</code> or add AbortController). <br>- Make <code>/api/*</code> trigger patterns configurable via <code>PTToc.config</code> and use stricter matching (exact path or regex).<br>- Move inline caption styles to CSS class and allow host to override via config, to avoid CSP and styling inconsistencies.<br>- Stabilize injection keys: compute stable keys from element <code>id</code> (ensureId) rather than ephemeral dataset generation; expose a cancellation API for pending injections if node removed. <br><strong>Medium-priority</strong><br>- Strengthen <code>canonKey</code> using <code>String.prototype.normalize(&#x27;NFKC&#x27;)</code> and Unicode-aware normalization; ensure key-matching tests cover non-ASCII scripts.<br>- Improve <code>applyFragmentIfChanged</code> to compare attributes or include a digest (e.g., text+href+dataset keys) to reduce false-negatives/positives.<br><strong>Low-priority / nice-to-have</strong><br>- Consider using <code>Element.replaceChildren()</code> when available for clearer semantics.<br>- Expose <code>PTToc.on(&#x27;labelsUpdated&#x27;, fn)</code> event so hosts can react instead of relying on global mutation scheduling.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Suggested tests</strong><br><strong>Unit</strong>: <code>ensureId</code> uniqueness & determinism with repeated runs and special characters; <code>canonKey</code> normalization across inputs (ASCII & Unicode); <code>normalizeLabels</code> flattening edge cases; <code>captionFor</code> lookup precedence (flat, prefix, padded); <code>itemsSignature</code> stability with whitespace changes. <br><strong>Integration</strong>: <code>fetchJsonOnce</code> timeout behavior; <code>reloadLabels</code> candidate fallback order and cache-bust handling; <code>injectCaptionForElement</code> reuse vs update vs collision path; <code>applyFragmentIfChanged</code> no-op vs replace behavior. <br><strong>E2E</strong>: Page with many dynamic nodes (virtual DOM or frequent mutations) to confirm debounce/injection suppression prevents flicker; pages with CSP forbidding inline-style to verify caption styling still shows when using CSS class fallback.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Compatibility & integration checklist</strong><br>- Document global names and side effects: <code>window.PTToc</code>, <code>window.__ptt_labels_reload_promise</code>, <code>window.__ptt_labels_injected</code>, <code>window.__pt_toc_installed</code>.<br>- Allow overriding of: label candidate list (<code>config.labelsPaths</code>), base expansion (<code>__tv_base</code> used by code), trigger patterns for refresh, debounce/throttle timings, and <code>injectionSuppressMs</code> for tight UIs.<br>- Provide opt-out for network instrumentation (a <code>PTToc.config.disableNetworkWrap = true</code>) to avoid interfering with other global wrappers.<br>- Provide a CSS snippet for <code>.table-caption</code> to avoid reliance on inline styles, and include a class-based fallback path in injection.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Potential regressions to watch for when changing code</strong><br>- Changing <code>ensureId</code> output format or truncation length will break any host code or bookmarks that rely on stable ids.<br>- Altering caption id strategy away from <code>TableNN</code> may break external anchors, legacy links, or host page automation expecting that id format.<br>- Removing or altering fetch/XHR wrappers will change auto-refresh behaviour for conversions and group-loads; document the change and provide migration path.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Final concise verdict</strong><br>Robust, pragmatic TOC/caption module emphasizing non-destructive updates, debouncing, and defensive coding. Well-suited for embedding in varied hosting contexts. Key improvements needed before large-scale deployment: add timeouts to all network fallbacks, harden key/canonicalization for Unicode, make network instrumentation configurable/safer, remove inline styles in favor of CSS classes, and stabilize injection keys to handle dynamic DOM frameworks. After those fixes and a small test-suite (ID/caption/injection/label-load), the module is production-ready for typical documentation and table-heavy pages.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr></tbody></table></div><div class="row-count">Rows: 14</div></div><div class="table-caption" id="Table4" data-table="Docu_0128_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4 • script.core.js</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical breakdown (script.core.js)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical breakdown (script.core.js)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Overview & intent</strong><br>Central client-side core for PasteToTable. Responsibilities: bootstrapping runtime configuration, locating auxiliary assets (index/worker/extra scripts), providing safe utility primitives (debounce, clipboard, download, toasts), wiring UI actions (convert/clear/save/export), performing the conversion request to <code>/api/render</code> (<code>__tv_do_convert</code>), routing/rendering server HTML into the viewer (<code>processRenderedHtml</code>), applying injected captions and TOC initialization when appropriate, and coordinating scroll behavior. The file emphasizes defensive programming, feature-detection, non-breaking fallbacks, and progressive enhancement for environments lacking modern APIs. Designed to integrate with optional global collaborators (<code>window.PasteToTable</code>, <code>window.PTToc</code>, external <code>script.toc.js</code>, <code>labels_injected.json</code>). </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>High-level architecture & modules</strong><br>1. Config & bootstrap — <code>defaultConfig</code>, <code>window.tvConfig</code>, <code>detectScriptBase</code>, <code>ensureIndexAndWorkerAttrs</code>, <code>startExtraLoader</code>.<br>2. Scroll coordination shim — <code>PTTScroll</code>.<br>3. Loader utilities — sequential loaders, TOC loader, label loader.<br>4. Utility primitives — debounce, normalize, clipboard, filename sanitization, download helpers.<br>5. Toast system — queued lightweight notifications.<br>6. Caption & TOC orchestration — install/inject helpers.<br>7. Conversion pipeline — <code>__tv_do_convert</code>, <code>processRenderedHtml</code>.<br>8. Event wiring — action dispatcher, header wiring. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Global contracts & exposed API</strong><br><code>window.tvConfig</code>, <code>window.tvIndexUrl</code>, <code>window.tvWorkerUrl</code>, <code>window.__tv_base</code>, <code>window.tvUtils</code>, <code>window.__tv_utils</code>, <code>window.__ptt_apply_injected_captions</code>, <code>window.__ptt_labels_injected</code>, <code>window.__ptt_toc_and_labels_installed</code>, <code>window.PasteToTable.processRenderedHtml</code>, <code>window.__tv_do_convert</code>, <code>window.convertButtonHandler</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>detectScriptBase()</strong><br>Purpose: determine script base URL. Uses <code>document.currentScript</code>, scans <code>&lt;script&gt;</code> tags, or falls back to <code>location.origin + path</code>. Returns <code>&#x27;/&#x27;</code> on failure. Handles missing <code>currentScript</code>, relative paths, malformed DOM. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>ensureIndexAndWorkerAttrs(base)</strong><br>Purpose: ensure <code>&lt;body&gt;</code> has <code>data-index-url</code> and <code>data-worker-url</code>. Computes defaults from base. Writes DOM attrs and assigns globals. Swallows CSP failures. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>PTTScroll (IIFE)</strong><br>Purpose: neutral scroll coordinator. Methods: <code>enable</code>, <code>disable</code>, <code>isEnabled</code>, <code>initObserver</code>, <code>scrollToTop</code> (noop). MutationObserver emits <code>ptt:renderStable</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>createScriptElement(src, opts)</strong><br>Creates a <code>&lt;script&gt;</code> with optional flags. Returns element for caller to append. Empty <code>src</code> tolerated. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>loadExtraSequentially(possiblePaths, onDone, onAllFailed)</strong><br>Sequential script loader. Appends candidate; on error removes and tries next. Reduces race conditions. Worst-case latency O(N). </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>startExtraLoader()</strong><br>Guards against duplicates, checks for existing extras, invokes sequential loader, logs success/failure. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>joinUrl(base, rel)</strong> — Robust absolute-URL builder using <code>new URL(rel, base).href</code> with string-concat fallback on failure; handles malformed inputs via fallback. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>normalizeForSearchLocal(s)</strong> — Unicode-aware normalizer. Tries <code>Shared.normalizeForSearchLocal</code>; default lowercases, NFD-decomposes, strips combining marks, removes non-letter/number/space with <code>\p{}</code> regex, collapses whitespace; safe fallback when Unicode regex unsupported. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>debounce(fn, wait)</strong> — Debounces a function using timer; prefers <code>Shared.debounce</code>; preserves <code>this</code> via <code>apply</code>; <code>wait</code> defaults to <code>tvConfig.debounceMs</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>copyToClipboard(text) / tryLegacyCopy(t)</strong> — Clipboard copy using <code>navigator.clipboard.writeText</code>; falls back to hidden <code>&lt;textarea&gt;</code> + <code>execCommand(&#x27;copy&#x27;)</code>; Promise-based; handles CSP/UA failures. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>sanitizeFileName(name)</strong> — Produces safe filename: replaces invalid chars, compresses spaces, trims to ≤200 chars; returns <code>&#x27;download&#x27;</code> if empty; <code>Shared.sanitizeFileName</code> override supported. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>downloadBlob(blob, filename)</strong> — Client-side download using <code>URL.createObjectURL</code> + anchor click; revokes URL after 150 ms; returns success boolean; supports <code>Shared.downloadBlob</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Toast system</strong> — <code>_ensureToastContainer</code>, <code>_computeToastDuration</code>, <code>showToast</code>, <code>showToastOnce</code>, <code>_processToastQueue</code>, <code>_hideActiveToast</code>, <code>_dismissToastById</code>.<br>Creates ARIA-aware toast container; queue-based display; auto-dismiss; duplicate-prevention; DOM creation, animation, cleanup; inline style usage; relies on CSS vars for colors. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>getSearchEl()</strong> — Returns search input element by checking ids: <code>searchBox</code>, <code>searchInput</code>, <code>search</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>tvUtils / __tv_utils export block</strong> — Exposes utilities globally (<code>copyToClipboard</code>, <code>debounce</code>, <code>sanitizeFileName</code>, <code>downloadBlob</code>, <code>getSearchEl</code>, <code>formatCellForMarkdown</code>, <code>tableToMarkdownLines</code>, <code>normalizeForSearchLocal</code>); respects existing definitions and <code>Shared</code> hooks. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>ID & escape helpers</strong> — <code>_normalizeKey</code>, <code>buildPrefixCandidatesFromLabels</code>, <code>sanitizeForId</code>, <code>ensureId</code>, <code>escapeHtml</code>.<br><code>ensureId</code> builds deterministic unique IDs from label text; <code>escapeHtml</code> escapes <code>&amp;&lt;&gt;\&quot;&#x27;</code> for safe caption/content usage. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>fetchJsonWithTimeout(url, timeoutMs)</strong> — Fetch JSON with timeout; uses AbortController or manual timeout; always resolves <code>null</code> on error; no-store, same-origin. Defensive but could return richer diagnostics. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>tryLoadLabels(candidates)</strong> — Sequentially tests label URLs using <code>fetchJsonWithTimeout</code>; returns first non-empty object or <code>{}</code>; fully error-tolerant; O(N) latency. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>installTocScript(candidates)</strong> — Tries to load <code>script.toc.js</code> candidates in order; resolves <code>true</code> on first success else <code>false</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>captionFor(labelsObj, bookPrefix, idx)</strong> — Resolves caption text through multiple permutations: flat keys, nested objects, underscore/dash variants, padded/unpadded indices; returns string or <code>null</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>inferBookPrefix()</strong> — Picks prefix from <code>data-file</code>/<code>data-source</code>, or URL filename, or sanitized document title. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>injectCaptionForElement(anchorEl, bookPrefix, idx, captionText)</strong> — Inserts or updates a <code>&lt;div.table-caption&gt;</code> before a table/anchor; ensures unique <code>Table{n}</code> ID; reuses existing caption when present; uses inline styles; primarily uses <code>innerHTML</code> with escaped input. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>installTocAndLabels()</strong> — One-time installer for TOC script and labels; guarded by global flag; loads TOC, then labels; stores <code>window.__ptt_labels_injected</code> and installation status. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>__ptt_apply_injected_captions()</strong> — Scans all tables; builds candidate prefix list; finds caption by trying permutations; enforces unique IDs; reuses or injects caption nodes; reports whether any caption was inserted or updated. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>processRenderedHtml(responseData)</strong> — Main renderer and post-processor:<br>1. Normalizes HTML string.<br>2. Parses metadata (e.g., <code>fromList</code>).<br>3. Sets skip-scroll flag.<br>4. Routes HTML via <code>PasteToTable.routeHtmlToAreas</code> with fallback to innerHTML injection.<br>5. Calls <code>PasteToTable.initRenderedContent()</code> twice (timing guard).<br>6. If <code>fromList</code>: ensures TOC/labels installed; applies captions; initializes TOC (<code>__tv_init_pttoc_from_core</code> or <code>PTToc.build</code>).<br>7. Attempts TOC init unconditionally.<br>8. Performs multiple scroll-to-top attempts with fail-safe clearing of skip flag.<br>Returns <code>true</code>/<code>false</code> based on handled success. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>__tv_do_convert(opts)</strong> — Primary conversion pipeline. Posts pasted text to <code>/api/render</code>, receives HTML/JSON, delegates to <code>processRenderedHtml</code>, manages UI state, and performs auto-selection of Table 1. Key steps: guard reentrancy; extract/validate text; dual-mode fetch (JSON then form fallback); handle non-OK responses; normalize payload (JSON or wrapped HTML); delegate to <code>window.PasteToTable.processRenderedHtml</code> if present; sanitize <code>fromList</code>; inject HTML on fallback path; toast status; deferred multi-strategy TOC auto-select; final cleanup of flags. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>convertButtonHandler(ev)</strong> — UI wrapper calling <code>__tv_do_convert</code>. Checks concurrency flag, then awaits conversion. Exposed as <code>window.convertButtonHandler</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>convert click delegation (IIFE)</strong> — Global click capture to route clicks on <code>#convertBtn</code> or <code>[data-action=&quot;convert&quot;]</code> to conversion handler. Prevents duplicate handling via <code>ev.__tv_convert_handled</code>. Attaches direct click listener as fallback. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>attachActionDispatcher()</strong> — Universal <code>[data-action]</code> dispatcher. Single bubbling click listener finds the nearest <code>[data-action]</code> and dispatches to <code>window.__tv_action_handlers[action]</code>. Pre-registers <code>&#x27;convert&#x27;</code> if available. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>clearButtonHandler()</strong> — Clears <code>#paste</code>, <code>#tables-viewer</code>, <code>#page-area</code>, resets <code>#status</code>, and shows toast. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>saveHtmlHandler(ev)</strong> — Saves current rendered HTML. Detects visible area (<code>#page-area</code> or <code>#tables-viewer</code>), builds minimal HTML document, and attempts server-side save via <code>window.PasteToTable.save</code>. On failure, falls back to <code>downloadBlob</code>. Uses sanitized filename from <code>document.title</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>attachHeaderHandlersOnce()</strong> — Attaches header button handlers (<code>convert</code>, <code>clear</code>, <code>save</code>, <code>exportAllBtn</code>, <code>renderBtn</code>) once. Uses internal <code>_attached</code> and dataset flags for idempotence. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Action dispatcher & final wiring</strong> — Exports <code>showToast</code>, <code>downloadBlob</code>, <code>copyToClipboard</code>, <code>sanitizeFileName</code>. Wires <code>window.PasteToTable.processRenderedHtml</code>. Logs final environment info. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Defensive patterns</strong> — Extensive <code>try/catch</code>; idempotent event binding; robust fallback logic; global coordination flags (<code>__tv_convert_in_progress</code>, <code>__tv_skip_scroll</code>, etc.); tolerant fetch helpers returning <code>null</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Compatibility & security choices</strong> — Uses <code>innerHTML</code> for injection (trusted server required); inline styles may conflict with CSP; fetch defaults keep same-origin cookies; avoids assuming modern APIs by feature detection. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Performance & scalability notes</strong><br>- Asset discovery (<code>loadExtraSequentially</code>, <code>tryLoadLabels</code>) is sequential — predictable but adds cumulative latency; acceptable for small candidate lists.<br>- Toast rendering & DOM ops are lightweight.<br>- Caption injection loops over all <code>table</code> nodes — O(T); for extremely large documents consider throttling or incremental insertion. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Bugs / risky assumptions / edge cases</strong><br>1. innerHTML vs textContent inconsistency — risk of double-escaping or missed sanitization.<br>2. ID collision detection limited — only global check, not table-scoped.<br>3. Sequential candidate probing latency — cumulative timeout cost.<br>4. TOC coupling assumptions — new TOC implementations may break auto-select.<br>5. Scroll coordination race — shared flag <code>__tv_skip_scroll</code> may conflict with other scripts.<br>6. Ambiguous <code>fromList</code> semantics — caller must set correctly.<br>7. Toast focus side-effect — may steal focus in SPAs. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Maintainability observations</strong><br>- Large file with many responsibilities; split into modules.<br>- Global variable proliferation; document global API contract.<br>- Inline style use and duplicated utility functions; factor into shared helpers. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Concrete recommended fixes / improvements</strong><br><strong>High priority</strong>: replace innerHTML caption insertion with DOM-safe construction; externalize styles; add cancellation hooks.<br><strong>Medium</strong>: improve discovery concurrency; structured error returns.<br><strong>Low</strong>: config entry-point for URLs; centralize utilities. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Suggested tests</strong><br><strong>Unit</strong>: unicode normalization, filename sanitization, HTML escaping, caption generation, timeout behavior.<br><strong>Integration</strong>: complex DOM caption injection, routing logic, convert flow with varying server responses.<br><strong>E2E</strong>: verify TOC behaviors, performance on large table counts. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Compatibility & integration checklist</strong><br>- Document global hooks (PasteToTable, PTToc).<br>- Ensure server <code>/api/render</code> is trusted or avoid innerHTML injection.<br>- Provide tvConfig pre-init override pattern; describe CSP considerations. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Potential regressions to watch</strong><br>- Caption ID naming changes break TOC.<br>- innerHTML → DOM refactor may affect whitespace/layout.<br>- Refactoring event wiring may double-bind handlers; preserve guards. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Final concise verdict</strong><br>Strong defensive design with good fallbacks. Main issues: innerHTML reliance, inline styles, sequential probing, duplicated helpers. Implement recommended fixes for production readiness. </td></tr></tbody></table></div><div class="row-count">Rows: 46</div></div><div class="table-caption" id="Table5" data-table="Docu_0128_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5 • script.list.js</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical breakdown (script.list.js) — per-function"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical breakdown (script.list.js) — per-function</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Overview & intent (expanded)</strong><br>Client-side module that: discovers server-side saved file indexes; normalizes metadata; builds groups; provides searchable modal UI; executes deterministic search; fetches selected files in parallel while preserving order; exposes immutable captions; invokes conversion pipeline (preferred API or fallback); applies captions into DOM with retry heuristics; provides robust copy/paste delegation. Design goals: preserve public names/signatures/events; deterministic tokenization; bounded CPU/memory; safe fallbacks; staged feature flags; rich test hooks and telemetry. This document enumerates all functions, behaviors, inputs/outputs, edge cases, and rollback notes. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Global constants & flags</strong><br><strong>Identifiers:</strong> <code>LIST_BTN_ID</code>, <code>PASTE_ID</code>, <code>STATUS_ID</code>.<br><strong>Discovery lists:</strong> <code>LIVE_FILES_ENDPOINTS</code>, <code>GROUPS_JSON_CANDIDATES</code>, <code>LABELS_JSON_CANDIDATES</code> — ordered, do not reorder.<br><strong>Timeouts & limits:</strong> <code>FILE_FETCH_TIMEOUT_MS</code>, <code>INDEX_FETCH_TIMEOUT_MS</code>, <code>GROUPS_FETCH_TIMEOUT_MS</code>, <code>LABELS_FETCH_TIMEOUT_MS</code>, <code>MAX_LIST_ITEMS</code>.<br><strong>Flags / Tunables:</strong> <code>ENABLE_CACHE_BUSTER</code>, <code>ENABLE_INVERTED_INDEX</code>, <code>ENABLE_WORKER_SCORING</code>, <code>WORKER_THRESHOLD</code>, <code>WORKER_TIMEOUT_MS</code>, <code>MAX_CANDIDATES_FROM_INDEX</code>, plus internal engine limits (<code>MAX_POSTINGS</code>, <code>MAX_CANDIDATES</code>, <code>QUERY_CACHE_SIZE</code>, <code>phraseBound</code>, <code>prefixScanLimit</code>, <code>cheapDLMaxLen</code>).<br><strong>Notes:</strong> Defaults remain conservative; options surfaced via <code>opts</code>; emergency override available via <code>window.__ptt_search_disable_new = true</code>. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Utility primitives</strong> </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>dbg(...)</code> — gated debug logger; no-op unless <code>DEBUG</code> is true.<br><strong>Purpose:</strong> lightweight trace logging.<br><strong>Inputs:</strong> variadic args.<br><strong>Side-effects:</strong> <code>console.log</code> only when enabled.<br><strong>Tests:</strong> toggle flag; confirm logging only when expected. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>safeTrim(s)</code> — defensive trim utility.<br><strong>Edge cases:</strong> null, undefined, objects; returns empty string or trimmed stringified form. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>basenameFromPath(p)</code> — returns last path segment.<br><strong>Edge cases:</strong> trailing slash, empty strings. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Utility primitives (continuation)</strong> </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>removeExtension(name)</code> — strips the final <code>.&lt;ext&gt;</code> segment.<br><strong>Edge cases:</strong> multiple dots, no dot. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>encodedSavedUrlFor(relPath)</code> — encodes each path segment and prepends <code>/saved/</code> unless absolute URL.<br><strong>Security:</strong> blocks traversal fragments; encodes spaces and Unicode.<br><strong>Tests:</strong> <code>../</code>, unicode, empty segments. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>stripBOM(s)</code> — removes leading Unicode BOM when present. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>updateStatus(msg, isError)</code> — sets status text; falls back to hidden aria-live div when <code>STATUS_ID</code> is missing.<br><strong>Accessibility:</strong> applies <code>role=&quot;alert&quot;</code> on errors.<br><strong>Tests:</strong> behavior when status element absent. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>showToastOrStatus(msg, opts)</code> — uses <code>window.showToast</code> if defined; otherwise delegates to <code>updateStatus</code>. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>generateClientReqId()</code> — produces unique-ish request id for telemetry. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Fetch helpers (network reliability layer)</strong> </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>fetchWithTimeout(url, timeoutMs)</code> — <strong>normalized probe</strong> for index endpoints.<br><strong>Purpose:</strong> robust probing for <code>/saved/index</code> etc. always returns resolved object and never throws (resolves with <code>{ok:false}</code> on failure).<br><strong>Behavior:</strong> uses <code>AbortController</code> if available, attaches cache-buster if enabled, <code>fetch(..., {cache:&#x27;no-store&#x27;, credentials:&#x27;same-origin&#x27;, signal})</code>, <code>res.text()</code> on success.<br><strong>Return shape:</strong> <code>{ ok:Boolean, status:Number, url:String, body:String|null, err?:String }</code>.<br><strong>Complexities & tests:</strong> endpoints returning JSON array, JSON object <code>{files:[]}</code>, plain newline list, empty body, non-200 statuses, forced timeout, double-resolve prevention. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>fetchFileWithTimeout(url, timeoutMs)</code> — <strong>per-file fetch (preserves legacy semantics)</strong>.<br><strong>Purpose:</strong> used by <code>loadFilesSequentialAndHideForm</code> to fetch file content; preserves legacy behavior (resolve with text, reject on failure).<br><strong>Behavior:</strong> uses <code>AbortController</code>; rejects on non-OK HTTP.<br><strong>Tests:</strong> large file, 404, aborted fetch. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Index parsing & normalization</strong> </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>tryParseListBodyAsArray(txt)</code> — attempts <code>JSON.parse</code> into an array or <code>{files:[...]}</code>.<br>Returns <code>null</code> on non-JSON.<br><strong>Tests:</strong> JSON array, <code>{files:[...]}</code>, invalid JSON, no thrown exceptions. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>normalizeIndexData(raw)</code> — canonicalizes possible index shapes into array of <code>{name, url, path, description}</code>.<br><strong>Inputs:</strong> array-of-strings, array-of-objects, object with <code>.files</code>.<br><strong>Outputs:</strong> normalized array capped by <code>MAX_LIST_ITEMS</code>.<br><strong>Edge cases:</strong> missing names, strings that look like URLs vs bare filenames.<br><strong>Tests:</strong> diverse index formats ensuring compatibility with group-building. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Discovery orchestration</strong> </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>fetchLiveFilesSequential(endpoints)</code> — probe endpoints sequentially until one yields usable index data.<br><strong>Contract:</strong> returns <code>{ ok, data, source }</code>.<br><strong>Requirement:</strong> strict sequential order; no parallelization or reordering, preserving intended fallback semantics.<br><strong>Tests:</strong> first endpoint invalid, second valid; confirm returned <code>source</code> matches the successful endpoint. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Labels & group descriptions</strong> </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>keyVariants(base)</code> — generate normalization variants for keys (space/underscore/dash/no-space, numeric-suffix permutations). Validate against cases like <code>Book_01</code>, <code>Book01</code>. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>canonKey(s)</code> — produce lowercase ASCII-like key stripped of leading/trailing non-alphanumerics and collapsed whitespace. Ensures stable matching. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>buildLabelIndex(raw)</code> — converts loaded <code>labels.json</code> into map of canonical keys → caption text.<br><strong>Cache:</strong> stored in <code>__ptt_labels_cache</code>.<br><strong>Tests:</strong> ambiguous keys, numeric suffix variants, validation of <code>canonKey</code> coverage. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>loadLabels()</code> — sequentially tries <code>LABELS_JSON_CANDIDATES</code>, parses JSON, returns index map or empty map; must not throw.<br><strong>Tests:</strong> missing files, corrupted JSON. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>loadGroupDescriptions()</code> — loads <code>groups.json</code> candidates; supports <code>{ groups:[{id,name}] }</code> and raw object map. Returns normalized mapping.<br><strong>Tests:</strong> varied schema shapes. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>resolveCaptionFor(baseName, labelIndex)</code> — resolves human caption using multiple normalized key variants, substring heuristics, and longest-first match ordering. Fallback scans <code>Object.keys(labelIndex)</code> only when needed.<br><strong>Tests:</strong> small vs large label sets, correct preference for specific matches. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Grouping heuristics</strong> </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>groupKeyFromPath(pathOrName)</code> — derive grouping key via heuristics: if path contains <code>/</code>, use first segment; otherwise infer from filename base using <code>_</code>-split patterns; fallback <code>&#x27;Ungrouped&#x27;</code>.<br><strong>Tests:</strong> <code>books/book_a.md</code>, <code>Book_01.md</code>, <code>alpha_beta_01.md</code>, <code>name.ext</code>. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>safeGroupName(s)</code> — sanitize group name; fallback <code>&#x27;Ungrouped&#x27;</code>. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <code>buildGroupsFromLive(liveFiles, labelsIndex)</code> — generate groups: <code>[{ name, description?, files:[{name,url,path,caption}], count }]</code>, with <code>&#x27;Ungrouped&#x27;</code> sorted last.<br><strong>Edge cases:</strong> missing path or url; caption priority = explicit description → labels lookup → blank.<br><strong>Tests:</strong> validate file counts, ordering, caption resolution. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Search engine — <code>createFileSearchEngine(items, opts)</code> (core of requested improvements)</strong> </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Purpose & constraints:</strong> produce a search engine exposing <code>candidatesForQuery(q)</code> and <code>scoreFiles(q, candidateIdxs)</code> while preserving existing API and behavior. Postings remain plain arrays so external <code>.slice()</code> / <code>Array.isArray</code> logic stays valid. Deterministic tokenization for index and queries. Provide LRU cache, thresholds, deterministic ordering, complexity guards, and safe worker-offload handshake. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Inputs:</strong> <code>items</code> — objects from <code>presentGroupsOnly</code> (<code>idx, groupIdx, fileIndex, name, caption, path, desc, full</code>).<br><code>opts</code> — tunables: <code>maxPostings</code>, <code>maxCandidates</code>, <code>intersectionHashThreshold</code>, <code>prefixScanLimit</code>, <code>phraseBound</code>, <code>queryCacheSize</code>, <code>cacheTTLMs</code>, <code>cheapDLMaxLen</code>, etc. Defaults remain conservative. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Index-build steps:</strong><br>1. Build <code>lite[]</code> with <code>tokens = tokenize(full)</code>, <code>triArr = trigramsOf(full)</code>, plus metadata.<br>2. Add postings: for each token push to <code>inverted[token]</code>; caption tokens use <code>c:</code> prefix; file-name tokens use <code>f:</code> prefix. <code>addPosting(token,id)</code> enforces <code>MAX_POSTINGS</code> caps.<br>3. Normalize postings: dedupe with seen-map, sort ascending, preserve plain arrays. Enables efficient merge-intersection and deterministic output.<br><strong>Complexity:</strong> inverted-index build ~O(total tokens); dedupe ~O(sum posting lengths). </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Tokenizer and retrieval internals</strong> </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Tokenizer <code>tokenize(s)</code></strong> — deterministic; lowercase; remove punctuation blocks and Unicode general-punctuation; replace with space; collapse spaces; trim; split; cap token count (e.g., first 50).<br><strong>Edge cases:</strong> accents, diacritics, emoji, underscores, dashes, numeric tokens, long tokens.<br><strong>Verification:</strong> same tokenizer used for index and queries; unit tests compare canonical seeds. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Trigrams <code>trigramsOf(s)</code></strong> — create 3-char shingles from <code>&#x27;  &#x27;+s+&#x27;  &#x27;</code> with padding; collapse spaces; return a <code>Set</code>.<br><strong>Use:</strong> fuzzy trigram overlap scoring.<br><strong>Tests:</strong> short strings, expected trigrams, matching behavior. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>cheapDL(a,b)</strong> — bounded Damerau-like Levenshtein with transpositions; compute only up to cutoff; if <code>|len(a)-len(b)| &gt; threshold</code> return sentinel (e.g., 4).<br>Applied only when tokens ≤ <code>cheapDLMaxLen</code> and candidate count small.<br><strong>Tests:</strong> correctness on small tokens; confirm cutoffs avoid heavy compute. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Query cache (LRU)</strong> — <code>queryCache</code> + <code>queryCacheOrder[]</code>; default size 128. <code>cacheSet</code> / <code>cacheGet</code> enforce copy-on-read so callers may mutate without affecting cache.<br>TTL optional; fully cleared on index rebuild via <code>dispose()</code>.<br><strong>Tests:</strong> hit/miss behavior and deep-copy validation. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>candidatesForQuery(q)</strong> — main retrieval path.<br><strong>Flow:</strong> normalize → tokenize (preserve quotes for phrase path) → for each token use union of <code>inverted[t]</code>, <code>inverted[&#x27;c:&#x27;+t]</code>, <code>inverted[&#x27;f:&#x27;+t]</code> respecting <code>MAX_POSTINGS</code>.<br>If single token → bounded posting.<br>Else sort postings by length asc. Use hash-intersection when small (<code>intersectionHashThreshold</code>), merge-intersection when large.<br>If empty or <4 results → fallback to union-dedupe bounded to <code>MAX_CANDIDATES</code>.<br>Deterministically sort output; cache by normalized token sequence.<br><strong>Tests:</strong> posting-size variation, intersection correctness, fallback behavior, deterministic order, copy-on-read safety. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Phrase support (quoted queries)</strong> — detect quoted phrase; run phrase-first path:<br>bounded candidate set via phrase-token postings or prefix scan (<code>phraseBound</code>); exact substring test against each candidate’s <code>full</code> text; keep only matches.<brFallback to normal path if none match.<br><strong>Tests:</strong> phrase present vs absent; performance constraints. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Prefix matching</strong> — tokens length 3–6 treated as prefixes; limited vocabulary scan (<code>prefixScanLimit</code>) to find keys starting with prefix; union postings with caps.<br><strong>Rationale:</strong> improved UX for partial queries.<br><strong>Tests:</strong> cap enforcement, per-query performance. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Scoring, complexity, and lifecycle</strong> </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Complexity guard</strong> — if any token’s posting list exceeds <code>MAX_POSTINGS</code> or final candidate count exceeds <code>complexityLimit</code>, return a bounded candidate set plus a flag for “refine query”. Guard triggers recorded in debug metrics.<br><strong>Tests:</strong> high-frequency tokens, verify guard activation and UI message path. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>scoreFiles(query, candidateIdxs)</strong> — ranking pipeline.<br><strong>Inputs:</strong> raw <code>query</code> and <code>candidateIdxs</code> (optional).<br><strong>Signals:</strong><br>• Exact quoted-phrase match → large bonus.<br>• Caption substring → +220.<br>• Filename substring → +140.<br>• Matched-token count × weight (e.g., 28).<br>• Prefix bonuses for beginning-of-word matches.<br>• Trigram overlap normalized by query trigram count × trigramWeight (≤60).<br>• cheapDL bonus when DL ≤ threshold for short tokens.<br>• Length penalty/boost based on <code>full.length</code>.<br><strong>Tie-breaker:</strong> <code>(groupIdx, fileIndex, name, idx)</code> for deterministic order.<br><strong>Complexity:</strong> O(candidates × scoring_cost). Worker offload recommended when large.<br><strong>Tests:</strong> sorted output; phrase boost validated; trigram normalization stable. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Worker scoring handshake</strong> — if <code>ENABLE_WORKER_SCORING</code> and candidate size ≥ threshold and <code>window.Worker</code> exists, send scoring job to worker; set timeout. On worker error/timeout, fall back to main-thread scorer.<br><strong>Contract:</strong> input/output shapes identical.<br><strong>Tests:</strong> worker success, thrown error, silent timeout → correct fallback. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Search engine API & lifecycle</strong> — API returns <code>{ candidatesForQuery, scoreFiles, lite, dispose }</code>.<br><code>dispose()</code> clears caches and worker instance; invoked when modal closes to avoid leaks.<br><strong>Tests:</strong> open/close modal cycles with no memory growth. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>createModal(contentEl, title)</strong> — UI shell builder.<br>Creates accessible dialog overlay with sticky header, close button, ESC handler, and focus restoration. Moves existing search input into header when present; if deeply nested, clone or leave in place.<br><strong>Tests:</strong> ESC behavior, focus fallback, aria correctness. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>presentGroupsOnly(groups, descriptions)</strong> — full UI + search glue (preserves existing public behavior).<br><strong>Inputs:</strong> <code>groups</code> from <code>buildGroupsFromLive</code>; <code>descriptions</code> from <code>loadGroupDescriptions</code>.<br><strong>Flow:</strong><br>1. Build <code>FILE_ITEMS</code> and <code>groupMap</code>.<br>2. <code>engine = createFileSearchEngine(FILE_ITEMS, opts)</code>.<br>3. Build search UI (search input, expandAllBtn).<br>4. Debounced <code>doSearch</code> → <code>engine.candidatesForQuery(q)</code> → <code>engine.scoreFiles(q, cand)</code>; fallback substring scan when engine returns empty.<br>5. <code>renderGroupsFromFileResults</code> populates DOM; clears when query empty.<br>6. Group rows built via <code>createGroupRowForRender</code>; file clicks call <code>loadFilesSequentialAndHideForm</code> preserving legacy semantics.<br>7. Modal created via <code>createModal</code>; returned handle's <code>close()</code> disposes engine.<br><strong>Tests:</strong> empty query restore; group visibility toggles; expandAll sync; large groups (performance). </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>createGroupRowForRender(groupIdx, fileSlice, q)</strong> — constructs group DOM.<br><strong>Outputs:</strong> header + fileList; wired toggle and load handlers; preserves <code>data-caption</code>.<br><strong>Accessibility:</strong> header <code>role=button</code>, toggle <code>aria-expanded</code>.<br><strong>Tests:</strong> header click loads group via <code>loadFilesSequentialAndHideForm</code>; load button → <code>trySendActiveGroupMetadata</code> → delayed load; correct file order preserved. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>renderGroupsFromFileResults(fileResults, q)</strong> — group-level aggregation + rendering.<br><strong>Flow:</strong> convert file scores → group map; compute each group's top score; sort groups; slice per-group top files (cap 200); patch DOM with clean replacement and preserved handlers.<br><strong>Tests:</strong> correct group ordering; per-group limit respected; DOM replaced cleanly. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>highlight(text, q)</strong> — safe token highlighter.<br><strong>Behavior:</strong> escape HTML → wrap matched token substrings with <code>&lt;mark&gt;</code>; tokens from <code>tokenize(q)</code>.<br><strong>Security:</strong> must escape before inserting <code>&lt;mark&gt;</code>.<br><strong>Tests:</strong> captions/filenames with special chars, XSS prevention. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>loadFilesSequentialAndHideForm(listOfFiles)</strong> — preserved name + expanded robustness.<br><strong>Purpose:</strong> parallel fetch while preserving original order; assemble combined raw + captioned text; write into paste/page area; call convert; apply runtime captions; dispatch <code>ptt:groupLoaded</code>.<br><strong>Flow:</strong><br>1. <strong>Validation & status:</strong> empty list → status error; otherwise “Fetching N file(s)…”.<br>2. <strong>runtimeCaptions:</strong> derive captions from items; default <code>&quot;Table N&quot;</code>; dedupe; freeze as <code>window.__ptt_runtime_captions</code>.<br>3. <strong>fetchPromises:</strong> build URL <code>(f.url or encodedSavedUrlFor(f.path or f.name))</code>; call <code>fetchFileWithTimeout</code>; return <code>{ idx, ok, body, name, caption, err }</code>; missing URL → resolved <code>{ok:false}</code> placeholder.<br>4. <strong>Parallel fetch + ordered assemble:</strong> <code>Promise.all</code> → sort by <code>idx</code>; assemble <code>accMarked</code> (<code>&lt;!-- caption: ... --&gt;</code>, <code>### caption</code>) and <code>accRaw</code>; failures get <code>&lt;!-- failed to fetch: ... --&gt;</code>. Write to paste area or page area; update <code>window.__tv_last_source</code> + timestamp.<br>5. <strong>convert invocation:</strong> prefer <code>window.__tv_do_convert({text,metadata})</code>; else <code>window.convert(text)</code>; else hidden textarea fallback. Non-blocking, no await.<br>6. <strong>caption application retry loop:</strong> repeated attempts (<code>maxRetries</code>, <code>intervalMs</code>) to locate caption nodes (<code>.table-caption</code>, headings, <code>id=TableN</code>, heading text “Table N”); apply <code>&lt;strong&gt;escapedCaption&lt;/strong&gt;</code>; set IDs; remove empty default headings; mark completion and toast.<br>7. <strong>dispatch event:</strong> <code>queueMicrotask</code> → <code>CustomEvent(&#x27;ptt:groupLoaded&#x27;, {detail:{runtimeCaptions,count}})</code>.<br><strong>Edge cases:</strong> convert failures do not block caption application; missing paste element fallback; fetch failures produce readable notes; large files handled with timeout protection. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>loadFilesSequentialAndHideForm(listOfFiles)</strong> — preserved name & expanded robustness.<br><strong>Purpose:</strong> parallel fetch while keeping original order; assemble raw + captioned text; write into paste/page area; invoke convert; apply runtime captions; dispatch <code>ptt:groupLoaded</code>.<br><strong>Flow:</strong><br>1. Validation & status updates.<br>2. Compute runtime captions (defaults <code>&quot;Table N&quot;</code>; dedupe; freeze as <code>window.__ptt_runtime_captions</code>).<br>3. Build <code>fetchPromises</code> using <code>f.url</code> or <code>encodedSavedUrlFor(f.path/f.name)</code>; call <code>fetchFileWithTimeout</code>; missing URLs yield <code>{ok:false}</code> placeholders.<br>4. <code>Promise.all</code> → ordered assembly of marked/raw text; failures recorded as <code>&lt;!-- failed to fetch --&gt;</code>; write to paste/page area; update source/timestamps.<br>5. Convert invocation: prefer <code>window.__tv_do_convert</code>, then <code>window.convert</code>, else hidden-textarea fallback; non-blocking.<br>6. Caption application retry loop: locate caption nodes (<code>.table-caption</code>, headings, <code>id=TableN</code>); inject <code>&lt;strong&gt;escapedCaption&lt;/strong&gt;</code>; set IDs; remove empty headings; signal completion and toast.<br>7. Dispatch <code>ptt:groupLoaded</code> via <code>queueMicrotask</code> with <code>{runtimeCaptions,count}</code>.<br><strong>Edge cases:</strong> convert failures ignored; missing paste element fallback; network failures produce readable notes; large files allowed within timeout. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>sanitizeCaptionForInjection(c) & safeMarkdownHeading(s)</strong> — caption sanitizers.<br><strong>Behavior:</strong> strip HTML comments, script blocks, HTML tags, unsafe fragments; escape output. <code>safeMarkdownHeading</code> removes leading hashes/special chars then returns <code>&quot;### &quot; + t</code>.<br><strong>Security:</strong> prevents script injection in assembled markdown.<br><strong>Tests:</strong> captions containing <code>&lt;script&gt;</code>, comments, malformed HTML. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>trySendActiveGroupMetadata(groupObj, client_req_id)</strong> — non-blocking telemetry.<br><strong>Behavior:</strong> extract <code>group_id</code>, sanitize <code>files</code> array, guarded <code>JSON.stringify</code>, POST to <code>/api/group/load</code>, log errors without blocking.<br><strong>Tests:</strong> missing/invalid groupObj, server 500, malformed shapes. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>triggerConvertIfAvailable()</strong> — probe for convert API existence; does not invoke convert.<br><strong>Usage:</strong> determine readiness only. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>attachListHandler()</strong> — attach click handler to <code>LIST_BTN_ID</code> to call <code>buildAndPresent</code>.<br><strong>Behavior:</strong> idempotent via <code>dataset.__ptt_list_attached</code>; works pre/post DOM load.<br><strong>Tests:</strong> double-attach attempts, DOM timing differences. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>attachPasteSync()</strong> — attaches <code>input</code> listener to paste textarea; updates <code>window.__tv_last_source</code> and timestamp; preserves passive options.<br><strong>Tests:</strong> manual edits update last-source fields. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>copy/clipboard subsystem (delegation & fallback)</strong> — end-to-end copy support.<br><strong>Selectors:</strong> <code>COPY_MARKDOWN_SELECTORS</code>, <code>COPY_PLAIN_SELECTORS</code>.<br><code>getRawPasteText()</code> pulls text from paste textarea, page-area, or hidden-convert fallback.<br><code>copyTextToClipboard(text)</code> uses <code>navigator.clipboard.writeText</code>, else <code>execCommand</code> with temporary hidden textarea.<br><code>findFirstMarkdownBlockInSource(src)</code> heuristically detects first markdown table: header row + separator, otherwise contiguous <code>|</code> rows.<br><code>document.click</code> delegates to renderer’s <code>copyTableMarkdown</code>/<code>copyTablePlain</code> (unless force-raw). If delegation fails, fallback copies raw. Exposes <code>window.__ptt_copy_raw_from_paste()</code> and <code>window.__ptt_set_force_raw_copy()</code>.<br><strong>Tests:</strong> clipboard API availability, execCommand fallback, renderer delegation, raw fallback. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>buildAndPresent()</strong> — orchestrates modal creation and group rendering.<br><strong>Flow:</strong><br>1. <code>updateStatus(&#x27;Resolving live files&#x27;)</code>.<br>2. <code>Promise.all([fetchLiveFilesSequential(), loadGroupDescriptions(), loadLabels()])</code>.<br>3. Validate <code>liveRes.ok</code> and <code>data</code>; normalize into <code>{name,url,path,description}</code>.<br>4. <code>buildGroupsFromLive(liveFiles, labels)</code>.<br>5. Update status and call <code>presentGroupsOnly(groups, descriptions)</code>.<br><strong>Edge cases:</strong> no live files → status error; mixed endpoints returning JSON or newline lists.<br><strong>Tests:</strong> endpoints unreachable, multi-shape responses, correct normalization. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Lifecycle & cleanup</strong> — <code>modalHandle.close</code> is overridden to invoke <code>engine.dispose()</code> before removing DOM nodes to prevent memory leaks and stale caches. Provide <code>clearQueryCache()</code> and <code>rebuildIndex()</code> for development use. <strong>Tests:</strong> repeatedly open/close modal and verify no retained memory growth and no lingering event handlers. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Debug & metrics (disabled by default)</strong> — when <code>DEBUG</code> is true, engine records latency, candidate counts, <code>cacheHit</code>, <code>intersectionStrategy</code>, <code>phraseScanCount</code>, <code>cheapDLCount</code>, <code>complexityGuardHits</code>. Expose <code>window.__ptt_stats()</code> and <code>window.__ptt_reset_stats()</code>. Ensure all metrics guarded by <code>DEBUG</code>. <strong>Tests:</strong> enable DEBUG and validate metric availability. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Public API invariants (must be preserved)</strong> — keep function names and signatures unchanged: <code>createFileSearchEngine</code>, <code>presentGroupsOnly</code>, <code>loadFilesSequentialAndHideForm</code>, <code>buildAndPresent</code>, <code>attachListHandler</code>. <code>createFileSearchEngine</code> returns <code>{ candidatesForQuery, scoreFiles, lite, dispose }</code>. Worker messaging contract unchanged. Event <code>ptt:groupLoaded</code> emitted with <code>{ runtimeCaptions, count }</code>. <strong>Tests:</strong> symbol grep, integration calls, consumer event handling unchanged. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Comprehensive test plan (executable checklist)</strong> — <strong>Unit tests:</strong> tokenizer parity; index normalization; label/group load; search engine behaviors (single-token, multi-token, phrase, prefix, miss cases); cache behaviors (LRU, invalidation); cheapDL triggers; phrase/prefix boundaries. <strong>Integration/E2E:</strong> regression vs legacy engine; A/B evaluation; worker fallback; fetch/assembly; caption application; stress and complexity-guard tests; accessibility checks. <strong>Operational checks:</strong> feature flags default off; legacy override <code>window.__ptt_search_disable_new</code>; engine disposal; copy/clipboard smoke tests. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Rollout & rollback plan</strong> — stage under feature flags; run full checklist; enable components stepwise (LRU → intersection → prefix → phrase → cheapDL → worker scoring); rollback via flags; provide dev hooks for cache/index invalidation; maintain legacy path until sign-off. </td></tr><tr><td data-label="Technical breakdown (script.list.js) — per-function"> <strong>Risks, mitigations & final notes</strong> — prefix/phrase potential O(V) mitigated via caps; LRU masking mitigated via rebuild invalidation; scoring deltas mitigated via A/B; worker silent failures mitigated via timeout+main-thread fallback. Final verification confirms all functions, side-effects, complexities, invariants, and rollback hooks covered. </td></tr></tbody></table></div><div class="row-count">Rows: 69</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>