<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1764452126">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#Table6">Table 6</a></li>
<li class="toc-item"><a class="toc-link" href="#Table7">Table 7</a></li>
<li class="toc-item"><a class="toc-link" href="#Table8">Table 8</a></li>
<li class="toc-item"><a class="toc-link" href="#Table9">Table 9</a></li>
<li class="toc-item"><a class="toc-link" href="#Table10">Table 10</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0106_01" style="margin-top:2mm;margin-left:3mm;"><strong>PTT Technical Breakdown â€¢ script.core.js</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **tv.core.js â€” Exhaustive Technical Breakdown**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>tv.core.js â€” Exhaustive Technical Breakdown</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="tv.core.js â€” Exhaustive Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ¯ Purpose &amp; Scope</b></summary><br/>This script is the central client</details></div><div class="left-col-content">side core for Tables Viewer / PasteToTable. It handles: configuration, script base detection, index/worker URL setup, utilities (clipboard, download, toast, debounce), TOC initialization, DOM injection, scroll coordination, conversion &amp; button handlers, and extra script loading. It's fully defensive and resilient to errors and missing DOM elements.</div></div></td></tr><tr><td data-label="tv.core.js â€” Exhaustive Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>âš™ï¸ Configuration &amp; Globals</b></summary><br/></details></div><div class="left-col-content"><code>window.tvConfig</code> initialized with defaults: <code>highlight: true</code>, <code>debounceMs: 150</code>, <code>chunkSize: 300</code>.<br/>- Debug flag <code>TV_DEBUG</code> derived from <code>window.tvDebug</code>.<br/>- Exposed function: <code>window.setTvSearchConfig(cfg)</code> safely overrides config values.<br/>- Coordination flag <code>window.__tv_skip_scroll</code> ensures controlled scroll behavior.<br/>- Base URL detection via <code>detectScriptBase()</code> supporting <code>document.currentScript</code>, <code>/assets/script.js</code>, and fallback to <code>location.origin</code>.</div></div></td></tr><tr><td data-label="tv.core.js â€” Exhaustive Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ›  Utility Functions</b></summary><br/></details></div><div class="left-col-content"><code>safe(fn)</code>: try/catch wrapper returning undefined on errors.<br/>- <code>isString(x)</code>: type check.<br/>- <code>joinUrl(base, rel)</code>: safely joins base + relative URL.<br/>- <code>once(fn)</code>: ensures function is called once.<br/>- Clipboard: <code>copyToClipboard(text)</code> with legacy fallback <code>tryLegacyCopy</code>.<br/>- File download: <code>downloadBlob(blob, filename)</code> with sanitization.<br/>- <code>sanitizeFileName(name)</code>: safe cross-platform filename conversion.<br/>- Debounce wrapper: <code>debounce(fn, wait)</code> using shared function or native setTimeout.<br/>- <code>normalizeForSearchLocal(s)</code>: Unicode-normalized, lowercase, accent-stripped, alphanumeric/space string for search indexing.</div></div></td></tr><tr><td data-label="tv.core.js â€” Exhaustive Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ’» Extra Script Loader</b></summary><br/></details></div><div class="left-col-content"><code>extraCandidates</code> defines sequential paths for optional <code>extra.js</code>.<br/>- <code>loadExtraSequentially()</code> attempts sequential loading with retries.<br/>- <code>startExtraLoader()</code> ensures loader attaches once and skips if already loaded.</div></div></td></tr><tr><td data-label="tv.core.js â€” Exhaustive Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ“œ CSS Injection</b></summary><br/></details></div><div class="left-col-content">Early hide export markdown buttons via injected <code>&lt;style&gt;</code>.<br/>- TOC inline CSS for flex layout, no separators, responsive horizontal scroll.<br/>- Both injected dynamically and safely inside try/catch blocks.</div></div></td></tr><tr><td data-label="tv.core.js â€” Exhaustive Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ“ Toast / Notification System</b></summary><br/></details></div><div class="left-col-content"><code>_toastQueue</code> &amp; <code>_activeToast</code> maintain sequential notification queue.<br/>- <code>_computeToastDuration(msg, type, optDuration)</code>: auto-duration based on message length and type.<br/>- <code>showToast(msg, {type,duration})</code>: main toast function with fallback to <code>alert</code>.<br/>- <code>showToastOnce(key, msg, opts, cooldownMs)</code>: deduplicates by key.<br/>- Toast elements created with dynamic styling, color-coded by type (<code>success</code>, <code>warn</code>, <code>error</code>), dismissable via click or button.<br/>- Automatic focus and smooth fade-in/out transitions.<br/>- <code>_processToastQueue()</code>, <code>_hideActiveToast()</code>, <code>_dismissToastById()</code> manage queue lifecycle.</div></div></td></tr><tr><td data-label="tv.core.js â€” Exhaustive Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ“– TOC / PTToc Initialization</b></summary><br/></details></div><div class="left-col-content">Encapsulated in IIFE with debounce observer on <code>#content</code> or <code>#tables-viewer</code>.<br/>- Functions: <code>callPTTocInitOnce()</code>, <code>waitForPTTocThenInit(timeoutMs)</code>, <code>attachContentObserver()</code>.<br/>- <code>window.__tv_init_pttoc_from_core(opts)</code> initializes TOC once and attaches mutation observer.<br/>- Safe retries if DOM not ready. Integrates with PTToc API (<code>init</code>, <code>build</code>).</div></div></td></tr><tr><td data-label="tv.core.js â€” Exhaustive Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ–¥ DOM &amp; Render Handling</b></summary><br/></details></div><div class="left-col-content"><code>processRenderedHtml(responseData)</code>: core HTML injection and PasteToTable integration.<br/>- Accepts string, object with <code>.html</code>, <code>.result</code>, <code>.body</code> or fallback to JSON.stringify.<br/>- Sets <code>__tv_skip_scroll = true</code> to prevent competing automatic scroll.<br/>- Routes HTML via <code>PasteToTable.routeHtmlToAreas()</code> if available.<br/>- Retry calls to <code>PasteToTable.initRenderedContent()</code> at 60ms and 420ms.<br/>- Triggers TOC after DOM injection.<br/>- Scroll-to-top coordination with retries at 0ms, 60ms, 250ms, 600ms and clears <code>__tv_skip_scroll</code> last.</div></div></td></tr><tr><td data-label="tv.core.js â€” Exhaustive Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>âš¡ Conversion Logic</b></summary><br/></details></div><div class="left-col-content"><code>window.__tv_do_convert(opts)</code> async function:<br/> â€¢ Guards against concurrent conversions.<br/> â€¢ Reads <code>opts.text</code> or fallback to <code>#paste</code> textarea.<br/> â€¢ Displays toast during conversion.<br/> â€¢ Fetches <code>/api/render</code> via JSON POST, fallback to URL-encoded POST.<br/> â€¢ Handles non-OK responses and sets <code>#status</code> text.<br/> â€¢ Processes payload using <code>PasteToTable.processRenderedHtml</code> if available.<br/> â€¢ Displays success/warn toasts and updates status with table count metadata.<br/>- <code>convertButtonHandler(ev)</code>: wrapper ensuring no concurrent execution.<br/>- Delegated click setup ensures multiple attachment strategies (direct attach, event delegation, data-action).<br/>- <code>window.__tv_check_convert()</code>: debug helper to verify button and delegation attachment.</div></div></td></tr><tr><td data-label="tv.core.js â€” Exhaustive Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ–± Button Handlers</b></summary><br/></details></div><div class="left-col-content"><code>clearButtonHandler()</code>: clears <code>#paste</code>, <code>#tables-viewer</code>, <code>#page-area</code>, <code>#status</code>.<br/>- <code>saveHtmlHandler(ev)</code>: saves visible HTML, attempts server save via <code>PasteToTable.save</code>, falls back to local download with toast notifications.<br/>- <code>attachHeaderHandlersOnce()</code>: attaches convert, clear, save, exportAll, and render buttons; prevents multiple attachment using <code>dataset</code> flags.<br/>- Auto-attaches on <code>DOMContentLoaded</code> or immediately if DOM ready.</div></div></td></tr><tr><td data-label="tv.core.js â€” Exhaustive Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ§© Shared Utilities Exposure</b></summary><br/></details></div><div class="left-col-content"><code>window.tvUtils</code> &amp; <code>window.__tv_utils</code> expose:<br/> â€¢ <code>copyToClipboard</code>, <code>tryLegacyCopy</code><br/> â€¢ <code>downloadBlob</code><br/> â€¢ <code>sanitizeFileName</code><br/> â€¢ <code>showToast</code><br/> â€¢ <code>debounce</code><br/> â€¢ <code>formatCellForMarkdown</code>, <code>tableToMarkdownLines</code>, <code>normalizeForSearchLocal</code><br/> â€¢ <code>getSearchEl</code></div></div></td></tr><tr><td data-label="tv.core.js â€” Exhaustive Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>âœ… Error Resilience</b></summary><br/></details></div><div class="left-col-content">All core operations wrapped in try/catch.<br/>- Failures in optional steps (CSS injection, TOC, extra.js, DOM mutation) do not block core functionality.<br/>- Debug logging controlled via <code>TV_DEBUG</code>.<br/>- Scroll coordination flag ensures no visual jank during conversion.<br/>- Toast queue ensures multiple concurrent messages handled gracefully.</div></div></td></tr><tr><td data-label="tv.core.js â€” Exhaustive Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ“Œ Key Behavior Notes</b></summary><br/></details></div><div class="left-col-content">All DOM access guarded with checks and readyState detection.<br/>- Supports multiple conversion triggers: button click, delegation, direct attach.<br/>- Smooth handling of missing or delayed DOM elements.<br/>- Designed for full integration with PasteToTable API hooks.<br/>- Defensive defaults for filenames, blobs, HTML content, clipboard operations.<br/>- Ensures seamless multi-table Markdown export compatibility.<br/>- Ready for both immediate and deferred initialization environments.</div></div></td></tr><tr><td data-label="tv.core.js â€” Exhaustive Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>âš ï¸ Edge Cases &amp; Observations</b></summary><br/></details></div><div class="left-col-content">Handles missing <code>#paste</code> or empty text gracefully with toast warning.<br/>- Handles non-JSON response gracefully.<br/>- Multiple conversions in rapid succession are serialized.<br/>- Missing PTToc or TOC elements do not break rendering.<br/>- Clipboard API fallback ensures compatibility with older browsers.<br/>- Toast queue handles overlapping calls; max 8s display, min 900ms.<br/>- Scroll coordination prevents conflicts with table-level scrolls.</div></div></td></tr><tr><td data-label="tv.core.js â€” Exhaustive Technical Breakdown"><div class="tv-left-col"><div class="left-col-content"><details><summary><b>ğŸ“ Summary</b></summary><br/>This single core JS file orchestrates configuration, utility functions, conversion requests, DOM injection, TOC setup, scroll management, toast notifications, button event handling, and optional extras. It is designed for maximal resilience, minimal visual jank, multi-init safety, and full integration with PasteToTable and Tables Viewer workflows.</details></div></div></td></tr></tbody></table></div><div class="row-count">Rows: 15</div></div><div class="table-caption" id="Table2" data-table="Docu_0106_02" style="margin-top:2mm;margin-left:3mm;"><strong>PTT Technical Breakdown â€¢ script.table.js</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **script.table.js â€” Conceptual Summary (Batch 1)**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>script.table.js â€” Conceptual Summary (Batch 1)</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 1)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ¯ Overview</b></summary></details></div><div class="left-col-content">Expanded<br/>This module handles all table-specific logic in PasteToTable / Tables Viewer. It centralizes UI rendering, responsive adjustments, event handling, copy/export functions, and TOC integration. Its main goal is to provide a seamless, cross-device experience for interacting with tables while keeping DOM manipulations optimized and idempotent. Key responsibilities include: wrapping tables, caching original HTML, attaching per-table buttons, updating TOC, optimizing for mobile layouts, and providing global export functionality.</div></div></td></tr><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 1)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ§­ Step 1</b></summary></details></div><div class="left-col-content">Table Wrapping &amp; DOM Preparation<br/>- Iterates over all <code>.table-wrapper</code> elements.<br/>- If <code>.table-container</code> does not exist inside a wrapper, creates it and moves the <code>&lt;table&gt;</code> into it.<br/>- This ensures a consistent structure for styling and event binding.<br/>- Caches original HTML of all table cells (<code>data-orig-html</code>) for later reference or restoration.<br/>- Assigns unique row UIDs to track state across operations.<br/>- Prepares a snapshot of the table header state for sorting and toggling purposes.<br/>- Ensures idempotency: multiple calls to <code>initRenderedContent()</code> do not duplicate wrapping or caching.</div></div></td></tr><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 1)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ§© Step 2</b></summary></details></div><div class="left-col-content">TOC Integration &amp; Navigation<br/>- Detects if <code>PTToc</code> exists and supports <code>.init()</code> method.<br/>- Initializes TOC with options:<br/>Â Â - <code>tocSelector</code> â†’ main TOC container<br/>Â Â - <code>tocListSelector</code> â†’ list inside TOC<br/>Â Â - <code>tocBarListSelector</code> â†’ top bar TOC<br/>Â Â - <code>headingSelector</code> â†’ table captions, headings, or wrapper H3s<br/>Â Â - <code>contentSelector</code> â†’ main content wrapper<br/>Â Â - <code>stickyHeaderId</code> â†’ ID of sticky header for offset adjustments<br/>- Calls <code>PTToc.build()</code> immediately and after 300ms retry.<br/>- Fallback: uses <code>buildSingleTableToc()</code> and <code>buildTocFromCaptions()</code> to ensure TOC availability.<br/>- Handles smooth scrolling to table sections and headers, accounting for sticky header offset.<br/>- Updates browser history with fragment identifier without breaking page state.</div></div></td></tr><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 1)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ“¤ Step 3</b></summary></details></div><div class="left-col-content">Event Binding &amp; Delegation<br/>- Per-table button binding: toggle, copy (plain/markdown), export (CSV, JSON, XLSX, PDF).<br/>- Uses dataset flags (<code>tvHandlerAttached</code>) to prevent duplicate bindings.<br/>- Adds table index to buttons via <code>data-tv-table-index</code>.<br/>- Global click delegation for header sorting:<br/>Â Â - Clicks on <code>.sort-btn</code>, <code>.th-with-sort</code>, or <code>&lt;th role="button"&gt;</code> trigger <code>headerSortButtonClicked()</code>.<br/>Â Â - Determines table index and column index dynamically.<br/>- Keyboard shortcuts:<br/>Â Â - <code>/</code> focuses search box (skips if input/textarea/contentEditable).<br/>Â Â - <code>Escape</code> triggers <code>backToTop()</code>.<br/>- Scroll listener toggles visibility of <code>#backToTop</code> button after 200px scroll.<br/>- Ensures idempotency: re-invoking event attachment will not duplicate handlers.</div></div></td></tr><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 1)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ“¦ Step 4</b></summary></details></div><div class="left-col-content">Copy &amp; Export Operations<br/>- <strong>Copy Functions:</strong><br/>Â Â - <code>copyTablePlain()</code> â†’ copies plain text representation.<br/>Â Â - <code>copyTableMarkdown()</code> â†’ copies Markdown table syntax, preserving alignment and formatting.<br/>- <strong>Export Functions:</strong><br/>Â Â - <code>exportTableCSV()</code> â†’ exports CSV file.<br/>Â Â - <code>exportTableJSON()</code> â†’ exports structured JSON.<br/>Â Â - <code>exportTableXLSX()</code> â†’ uses SheetJS (<code>XLSX.utils</code>) if available.<br/>Â Â - <code>exportTablePDF()</code> â†’ triggers PDF generation.<br/>- <code>exportAllBtnHandler()</code> consolidates all tables:<br/>Â Â - Iterates over <code>.table-wrapper</code>.<br/>Â Â - Converts each table to AoA (array of arrays).<br/>Â Â - Appends each to a new XLSX workbook or fallback Markdown.<br/>Â Â - Uses table title or generates <code>TableN</code> if title missing.<br/>Â Â - Toast notifications indicate success/failure.<br/>- Ensures safe fallback if SheetJS not available.</div></div></td></tr><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 1)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>âš™ï¸ Step 5</b></summary></details></div><div class="left-col-content">Responsive Optimization<br/>- <code>_debouncedOptimize()</code> invoked on <code>resize</code> and media query change (<code>max-width:600px</code>).<br/>- Adjusts flex, gap, padding, fontSize, width, height of buttons depending on device type.<br/>- Mobile optimizations:<br/>Â Â - Buttons use flex 1 1 auto with gap 6px.<br/>Â Â - Icon-only buttons: fixed width/height 36px, padded 6px.<br/>- Desktop restores original styles.<br/>- Toggle button labels update dynamically (<code>Expand Table</code> / <code>Collapse Table</code>).<br/>- <code>toggleAllTables()</code> updates global toggle text depending on any expanded tables.</div></div></td></tr><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 1)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ¤– Step 6</b></summary></details></div><div class="left-col-content">Safety, Idempotency &amp; Error Handling<br/>- Wraps all DOM operations in <code>try/catch</code> to prevent breaking page if a table is missing or partially malformed.<br/>- Idempotency patterns prevent multiple DOM mutations or handler attachments.<br/>- Exposes key functions on <code>window</code> namespace:<br/>Â Â - <code>toggleTable</code>, <code>toggleAllTables</code>, <code>copyTablePlain</code>, <code>copyTableMarkdown</code>, <code>exportTableCSV</code>, <code>exportTableJSON</code>, <code>exportTableXLSX</code>, <code>exportTablePDF</code>, <code>exportAllBtnHandler</code>.<br/>- Uses dataset flags (<code>data-tvHandlerAttached</code>) to mark elements that already have event handlers.<br/>- Safe initialization whether <code>document.readyState</code> is <code>loading</code> or <code>complete</code>.</div></div></td></tr><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 1)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ’¬ Step 7</b></summary></details></div><div class="left-col-content">Header &amp; Row State Management<br/>- <code>_ensureRowUidsAndSnapshot()</code> maintains per-row unique IDs and header states.<br/>- <code>sortStates</code> array stores header sort order per table.<br/>- <code>updateHeaderSortUI()</code> refreshes icons in headers to indicate current sort direction.<br/>- Updates row counts via <code>updateRowCounts()</code> after any DOM modification.<br/>- Maintains cached original cell content (<code>data-orig-html</code>) to allow sort/reset without losing formatting.</div></div></td></tr><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 1)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ§° Step 8</b></summary></details></div><div class="left-col-content">Search Integration<br/>- Supports multiple search box IDs (<code>searchBox</code>, <code>searchInput</code>, <code>search</code>).<br/>- Debounces input to avoid repeated heavy DOM queries.<br/>- Triggers <code>searchTable()</code> on input or Enter key press.<br/>- Ensures search box binding occurs once per page load using <code>data-tvBound</code> flag.<br/>- Works across tables in a single DOM or multiple tables across sections.</div></div></td></tr><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 1)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ§° Step 9</b></summary></details></div><div class="left-col-content">TOC Bar Click Delegation<br/>- Delegates click events to <code>#tocBar a[href^='#']</code> links.<br/>- Prevents default anchor jump; calculates scroll position relative to sticky header.<br/>- Smooth scrolls to target table or header.<br/>- Focuses target element to aid keyboard navigation.<br/>- Updates URL fragment with <code>history.replaceState</code> safely without adding extra history entries.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 10</div></div><div class="table-caption" id="Table3" data-table="Docu_0106_03" style="margin-top:2mm;margin-left:3mm;"><strong>PTT Technical Breakdown â€¢ script.table.js</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **script.table.js â€” Conceptual Summary (Batch 2)**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>script.table.js â€” Conceptual Summary (Batch 2)</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ§© Step 10</b></summary></details></div><div class="left-col-content">Toggle &amp; Collapse Behavior<br/>- <code>toggleTable()</code> handles per-table expand/collapse.<br/>- Toggles <code>.table-collapsed</code> class on <code>.table-wrapper</code>.<br/>- Updates button label dynamically (<code>Expand Table</code> / <code>Collapse Table</code>).<br/>- <code>toggleAllTables()</code> iterates over all <code>.table-wrapper</code> elements, toggling them collectively.<br/>- Accounts for initial page state, restoring previous user interactions where possible.<br/>- Integrates seamlessly with TOC updates and smooth scrolling.<br/>- Ensures UI consistency across devices and screen sizes.</div></div></td></tr><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ“¦ Step 11</b></summary></details></div><div class="left-col-content">Clipboard &amp; Markdown Handling<br/>- Copy operations preserve formatting and alignment.<br/>- <code>tableToMarkdownLines()</code> converts HTML tables to Markdown:<br/>Â Â - Handles empty cells.<br/>Â Â - Preserves multi-line content within a single cell.<br/>Â Â - Uses table caption as header when available.<br/>- Supports icon-only copy buttons with responsive adjustments.<br/>- Clipboard API used safely with fallback to deprecated methods where necessary.<br/>- Toast messages notify users of copy success/failure.<br/>- Event binding ensures buttons are responsive to both click and keyboard activation.</div></div></td></tr><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ§© Step 12</b></summary></details></div><div class="left-col-content">Export Handling &amp; Fallbacks<br/>- XLSX export leverages SheetJS if available; otherwise falls back to Markdown.<br/>- AoA (array-of-arrays) used as intermediary for conversion to spreadsheet.<br/>- Handles worksheet name truncation to 31 characters for Excel compatibility.<br/>- Blob-based fallback for browsers without SheetJS writeFile.<br/>- JSON export serializes table data with key-value pairing for headers.<br/>- CSV export supports multi-line cells and quote escaping.<br/>- PDF export uses either preconfigured library or triggers user-defined callback.<br/>- All export paths wrapped in try/catch to prevent failure propagation.<br/>- Toast notifications provide user feedback for each export method.</div></div></td></tr><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>âš™ï¸ Step 13</b></summary></details></div><div class="left-col-content">Debounced &amp; Responsive Optimization<br/>- <code>_debouncedOptimize()</code> ensures DOM manipulations are not triggered excessively on resize.<br/>- Window <code>resize</code> and media query changes dynamically adjust button layout.<br/>- Mobile-first design: buttons stack and flex; spacing, padding, and font sizes adjusted for touch usability.<br/>- Desktop restores original flex/grid layouts.<br/>- Handles icon-only buttons specifically for mobile and desktop widths.<br/>- Maintains performance by avoiding querySelectorAll loops inside high-frequency events.</div></div></td></tr><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ§  Step 14</b></summary></details></div><div class="left-col-content">Global State &amp; Namespacing<br/>- Exposes module functions on <code>window.PasteToTable</code> namespace.<br/>- Provides safe delegation check via <code>window.__tv_check_convert</code>.<br/>- Prevents collisions with other scripts or future updates.<br/>- Maintains global arrays (<code>sortStates</code>) and caches to track table state consistently.<br/>- Ensures non-intrusive augmentation of page functionality without overwriting pre-existing user scripts.</div></div></td></tr><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ’¡ Step 15</b></summary></details></div><div class="left-col-content">Error Resilience &amp; Fault Tolerance<br/>- Wraps almost every DOM query and mutation in <code>try/catch</code> blocks.<br/>- Prevents script crashes due to missing elements, malformed HTML, or partially loaded tables.<br/>- Fallback functions invoked automatically when primary paths fail (TOC, exports, toggle).<br/>- Debounce mechanisms prevent rapid state changes from causing inconsistent UI.<br/>- Uses dataset flags to mark elements, reducing redundant DOM manipulation and ensuring safe idempotent behavior.</div></div></td></tr><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ“ˆ Step 16</b></summary></details></div><div class="left-col-content">Row Counting &amp; UI Feedback<br/>- <code>updateRowCounts()</code> updates visible counters per table.<br/>- Refreshes count after table modifications (toggle, search, sort).<br/>- Supports dynamic row insertion/removal.<br/>- Integrates with toast messages and header UI indicators.<br/>- Ensures accurate state for accessibility and screen readers.<br/>- Optimized for large tables by caching results to reduce DOM reads.</div></div></td></tr><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ—‚ï¸ Step 17</b></summary></details></div><div class="left-col-content">Search &amp; Filtering Integration<br/>- Debounced search prevents frequent table scans.<br/>- Supports search highlighting inside cells.<br/>- Works across multiple tables in one page.<br/>- Event listener only bound once per search box to prevent duplicates.<br/>- Handles Enter key for immediate search.<br/>- Filters row visibility without altering original cached content (<code>data-orig-html</code>).<br/>- Integrates with toggle/collapse state: hidden rows remain consistent across UI operations.</div></div></td></tr><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ”— Step 18</b></summary></details></div><div class="left-col-content">Accessibility &amp; UX Considerations<br/>- Buttons and toggle elements labeled with descriptive text.<br/>- Icon-only buttons receive width/height and padding adjustments for touch targets.<br/>- Smooth scrolling for TOC and back-to-top improves navigation.<br/>- Focus management ensures keyboard users land on correct table or section.<br/>- Toast notifications provide clear feedback for copy/export actions.<br/>- Overall, designed for mobile-first responsive UI without sacrificing desktop experience.</div></div></td></tr><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ§© Step 19</b></summary></details></div><div class="left-col-content">Back to Top &amp; Global Navigation<br/>- <code>backToTop()</code> provides smooth scroll to page top.<br/>- Scroll listener toggles visibility of button based on page scroll (&gt;200px).<br/>- Accessible via Escape key or direct button click.<br/>- Ensures multiple tables with long content remain navigable.<br/>- Prevents focus loss or page jump issues by combining smooth scroll with history.replaceState.</div></div></td></tr><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ›  Step 20</b></summary></details></div><div class="left-col-content">Developer Considerations<br/>- Modular IIFE ensures scope isolation.<br/>- Uses dataset properties for tracking internal state without polluting global namespace.<br/>- Safe attachment to window allows for future upgrades or script replacement.<br/>- Performance-conscious: avoids repeated DOM queries by caching results.<br/>- Extensible: supports addition of new export formats, TOC styles, or search enhancements.<br/>- Error handling and idempotency allow safe reinvocation after partial page updates or dynamic content injection.</div></div></td></tr><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>âœ… Step 21</b></summary></details></div><div class="left-col-content">Summary &amp; Conceptual Mapping<br/>- <code>script.table.js</code> orchestrates table rendering, interaction, export, search, and TOC integration.<br/>- Modular yet tightly coupled to UI structure for maximum compatibility.<br/>- Idempotent, responsive, and fault-tolerant.<br/>- Key design decisions:<br/>Â Â - Dataset caching for original HTML and state.<br/>Â Â - Debounced DOM operations for performance.<br/>Â Â - Event delegation for global sorting and TOC navigation.<br/>Â Â - Graceful degradation if SheetJS or TOC is missing.<br/>Â Â - Unified namespace and safe exposure of functions.<br/>- Provides foundation for PasteToTable / Tables Viewer to reliably manage tables across desktop and mobile, multiple tables, and dynamic content updates.</div></div></td></tr><tr><td data-label="script.table.js â€” Conceptual Summary (Batch 2)"><div class="tv-left-col"><div class="left-col-content"><details><summary><b>ğŸ’¬ Conclusion</b></summary><br/>This expanded conceptual summary fully covers <code>script.table.js</code> logic and rationale:<br/>- UI rendering and table container management.<br/>- Responsive adjustments for mobile and desktop.<br/>- Per-table and global event handling for toggle, copy, and export.<br/>- TOC integration and smooth navigation.<br/>- State management, caching, and idempotency.<br/>- Error handling, debouncing, and fault tolerance.<br/>- Accessibility and UX considerations.<br/>- Provides robust, modular foundation for table-heavy web apps.<br/>All functions are exposed safely on <code>window.PasteToTable</code> namespace to support future extensions and upgrades.</details></div></div></td></tr></tbody></table></div><div class="row-count">Rows: 13</div></div><div class="table-caption" id="Table4" data-table="Docu_0106_04" style="margin-top:2mm;margin-left:3mm;"><strong>PTT Technical Breakdown â€¢ script.save.js</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **script.save.js â€” Conceptual Summary**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>script.save.js â€” Conceptual Summary</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="script.save.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ¯ Overview</b></summary><br/>Client</details></div><div class="left-col-content">side handler for saving Markdown content via POST requests to <code>/save-md</code>. Provides safe filename prompts, enforces client-side size limits, and integrates with live status UI. Adds minimal <code>groups_index.json</code> refresh support after single-file saves. Designed for modular, fault-tolerant use alongside <code>PasteToTable</code> core scripts.</div></div></td></tr><tr><td data-label="script.save.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>âš™ï¸ Step 1</b></summary></details></div><div class="left-col-content">Configuration &amp; Defaults<br/>- Constants for max paste size (<code>DEFAULT_MAX_PASTE_SIZE</code>), save endpoint (<code>SAVE_ENDPOINT</code>), element IDs (<code>STATUS_ID</code>, <code>SAVE_BTN_ID</code>, <code>PASTE_ID</code>, <code>FALLBACK_AREA_ID</code>).<br/>- Event namespaces for custom save events (<code>EVENT_REQUEST_MD</code>, <code>EVENT_RESPONSE_MD</code>) to avoid collisions.<br/>- Enables easy customization for deployments and per-page overrides.</div></div></td></tr><tr><td data-label="script.save.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ›  Step 2</b></summary></details></div><div class="left-col-content">Utilities<br/>- <code>logDebug()</code> wraps <code>console.debug</code> for safe debug logging.<br/>- <code>safeTrim()</code> ensures strings are trimmed without errors on null/undefined.<br/>- <code>readElementText(id)</code> fetches value/text content safely, handles inputs, textareas, or other DOM elements.<br/>- <code>getMeta(name)</code> fetches meta tags for page-specific configuration.<br/>- <code>getClientMaxSize()</code> computes maximum allowed paste size using configuration or meta tags.<br/>- <code>utf8BytesLength()</code> calculates byte size for payload validation, with TextEncoder fallback.<br/>- <code>ensureMdSuffix()</code> and <code>promptFilename()</code> handle safe filename creation, cleaning illegal characters and appending <code>.md</code>.</div></div></td></tr><tr><td data-label="script.save.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ’¾ Step 3</b></summary></details></div><div class="left-col-content">Status Updates &amp; Event Dispatch<br/>- <code>updateStatus(message, isError)</code> updates DOM status element or hidden live region (<code>aria-live</code>) for accessibility.<br/>- Supports visual and screen-reader notifications.<br/>- <code>dispatchResponseEvent(detail)</code> triggers namespaced <code>ptt:save-md-response</code> event with save result, allowing external handlers to respond.</div></div></td></tr><tr><td data-label="script.save.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸŒ Step 4</b></summary></details></div><div class="left-col-content">Network Save Logic<br/>- <code>postSaveMarkdown(markdown, filename, opts)</code> posts JSON payload to <code>/save-md</code> endpoint.<br/>- Handles <code>credentials: same-origin</code> for session persistence.<br/>- Parses server response safely; provides structured fallback JSON on invalid response.<br/>- Returns a promise resolving to <code>{ status, ok, json }</code>.</div></div></td></tr><tr><td data-label="script.save.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ§© Step 5</b></summary></details></div><div class="left-col-content">High-Level Save Flow<br/>- <code>doSaveAction(opts)</code> orchestrates entire save operation:<br/>Â Â - Reads Markdown from primary or fallback elements.<br/>Â Â - Validates content presence.<br/>Â Â - Checks against client max size limit and aborts if exceeded.<br/>Â Â - Prompts for filename if not provided.<br/>Â Â - Calls <code>postSaveMarkdown()</code> and handles success/failure paths.<br/>- Updates status messages dynamically and triggers response events.<br/>- Wraps entire flow in <code>try/catch</code> to prevent uncaught client-side errors.</div></div></td></tr><tr><td data-label="script.save.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ“¤ Step 6</b></summary></details></div><div class="left-col-content">Event Wiring &amp; Button Handlers<br/>- <code>onSaveButtonClick(e)</code> handles manual save button clicks:<br/>Â Â - Dispatches cancelable <code>ptt:save-md-request</code> event for interceptors.<br/>Â Â - Reads overridden markdown/filename from event detail if provided.<br/>Â Â - Calls <code>doSaveAction()</code>.<br/>- <code>attachHandlers()</code>:<br/>Â Â - Attaches click handler to save button if not claimed by core.<br/>Â Â - Avoids double-binding using dataset flags.<br/>Â Â - Adds programmatic API on <code>window.PTT_SAVE</code> for code-driven saves.<br/>Â Â - Namespaces save helpers safely, allows existing <code>PTT_SAVE</code> to be augmented without overwriting.</div></div></td></tr><tr><td data-label="script.save.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><bâ›“ 7<="" div="" step=""><div class="left-col-content">Event-Based Programmatic API</div></bâ›“></summary><br/>- Supports programmatic save requests via <code>window.dispatchEvent(EVENT_REQUEST_MD)</code>.<br/>- Event detail can carry <code>markdown</code> and <code>filename</code>.<br/>- Save flow triggered automatically if event carries payload.<br/>- Provides consistent response via <code>ptt:save-md-response</code> event.</details></div></div></td></tr><tr><td data-label="script.save.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ“ Step 8</b></summary></details></div><div class="left-col-content">Safety &amp; Validation<br/>- Content validation: non-empty, UTF-8 byte length check against client max size.<br/>- Filename sanitation: replaces <code>/</code> <code>\</code> and non-alphanumeric chars with <code>-</code>, truncates to 200 chars.<br/>- Handles cancelations gracefully (user or event handler).<br/>- Errors categorized: missing content, oversized payload, network error, server error, client exception, or cancellation.</div></div></td></tr><tr><td data-label="script.save.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ§© Step 9</b></summary></details></div><div class="left-col-content">DOM Ready Initialization<br/>- Uses <code>ready(fn)</code> helper to ensure DOM is interactive before binding.<br/>- Calls <code>attachHandlers()</code> once DOM ready.<br/>- Logs initialization info and client max size for debugging.<br/>- Resilient to DOM timing differences and multiple script injections.</div></div></td></tr><tr><td data-label="script.save.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ’¡ Step 10</b></summary></details></div><div class="left-col-content">UX &amp; Accessibility Considerations<br/>- Status messages update ARIA live regions when status element missing.<br/>- Non-intrusive: does not modify UI beyond status feedback.<br/>- Ensures screen readers can notify save results.<br/>- Uses safe prompts for filenames while sanitizing illegal characters.<br/>- Prevents UI disruption if core save button already exists.</div></div></td></tr><tr><td data-label="script.save.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ“ˆ Step 11</b></summary></details></div><div class="left-col-content">Conceptual Notes &amp; Design Rationale<br/>- <strong>Modularity:</strong> Fully encapsulated in IIFE to avoid polluting global scope.<br/>- <strong>Namespacing:</strong> Uses <code>PTT_SAVE</code> and custom events for safe integration.<br/>- <strong>Robustness:</strong> Try/catch blocks prevent any unhandled exceptions.<br/>- <strong>Extensibility:</strong> Supports future server endpoints, alternative save flows, or batch handling.<br/>- <strong>Integration-Friendly:</strong> Works alongside core PasteToTable scripts without conflict.<br/>- <strong>User-Friendly:</strong> Interactive filename prompt with validation; graceful feedback on success/failure.<br/>- <strong>Accessibility:</strong> Updates status via ARIA live regions; supports both visual and screen reader feedback.</div></div></td></tr><tr><td data-label="script.save.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>âœ… Conclusion</b></summary><br/><code>script.save.js</code> provides a fault</details></div><div class="left-col-content">tolerant, modular client-side mechanism for saving Markdown content. It integrates safely with PasteToTable core, provides a programmatic API, enforces size constraints, validates filenames, supports cancelable events, and ensures user and developer feedback. Designed for easy extension, maintainable logging, and robust event handling, it is suitable for both desktop and mobile workflows without interfering with other scripts.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 13</div></div><div class="table-caption" id="Table5" data-table="Docu_0106_05" style="margin-top:2mm;margin-left:3mm;"><strong>PTT Technical Breakdown â€¢ script.toc.js</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **script.toc.js â€” Conceptual Summary**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>script.toc.js â€” Conceptual Summary</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="script.toc.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ¯ Overview</b></summary><br/>Client</details></div><div class="left-col-content">side Table of Contents (TOC) builder for PasteToTable. Generates row-level links if a single table exists, or heading-based links otherwise. Designed to be idempotent, efficient, and minimal in DOM writes. Supports debounce, mutation observation, and locked rebuilds to avoid thrashing. Handles click and scroll interaction, and highlights the current section based on URL hash.</div></div></td></tr><tr><td data-label="script.toc.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>âš™ï¸ Step 1</b></summary></details></div><div class="left-col-content">Private State &amp; Configuration<br/>- Internal flags: <code>_delegatedAttached</code>, <code>_buildLock</code>, <code>_lastItemsSignature</code>, <code>_highlightTimer</code>.<br/>- Debounce timer <code>_rebuildTimer</code> (150ms default).<br/>- MutationObserver for dynamic content.<br/>- <code>PTToc.config</code> holds default selectors for TOC container, TOC list, table headings, content root, sticky header, table selector, row label prefix.<br/>- Configurable via <code>PTToc.init(options)</code>.</div></div></td></tr><tr><td data-label="script.toc.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ›  Step 2</b></summary></details></div><div class="left-col-content">Helper Functions<br/>- <code>sanitizeText(s)</code> trims text safely.<br/>- <code>_normalize_heading_text(raw)</code> normalizes heading text: removes line breaks, <code>br</code> tags, extra spaces.<br/>- <code>ensureId(el, prefix)</code> guarantees unique element IDs; uses normalized text or fallback with suffix if duplicate.<br/>- <code>makeLinkNode(id, text, extraClass)</code> creates an <code>&lt;li&gt;</code> containing <code>&lt;a&gt;</code> linking to target with ARIA attributes.<br/>- <code>clearChildren(el)</code> safely removes child nodes with minimal reflows.<br/>- <code>appendTocItem(targetList, item, cls)</code> appends a TOC link node.</div></div></td></tr><tr><td data-label="script.toc.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ“¦ Step 3</b></summary></details></div><div class="left-col-content">Item Generation<br/>- <code>buildItemsFromSingleTable(table)</code> enumerates rows in a single table and creates row-level TOC items labeled "Topic 1, Topic 2, â€¦".<br/>- <code>buildItemsFromHeadings()</code> enumerates all elements matching <code>.table-heading</code> and creates TOC items with normalized text.<br/>- Both functions return arrays of <code>{ id, label }</code> objects for TOC construction.</div></div></td></tr><tr><td data-label="script.toc.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ§© Step 4</b></summary></details></div><div class="left-col-content">Core TOC Build<br/>- <code>buildOnceInternal()</code>:<br/>Â Â - Fetches TOC list containers (<code>tocList</code>, <code>tocBarList</code>).<br/>Â Â - Determines content root and table count.<br/>Â Â - Builds items using single-table row logic or headings.<br/>Â Â - Compares new signature with <code>_lastItemsSignature</code> to skip identical rebuilds.<br/>Â Â - Updates DOM using <code>requestAnimationFrame</code> to minimize layout thrash.<br/>Â Â - Calls <code>scheduleHighlight()</code> to ensure current item is highlighted.</div></div></td></tr><tr><td data-label="script.toc.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>â± Step 5</b></summary></details></div><div class="left-col-content">Debounce &amp; Build Lock<br/>- <code>buildOnce()</code> locks build to prevent concurrent rebuilds; unlocks after short delay (â‰¥200ms).<br/>- <code>debounceBuild()</code> clears prior timer and sets a new delayed call to <code>buildOnce()</code>.</div></div></td></tr><tr><td data-label="script.toc.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ”¦ Step 6</b></summary></details></div><div class="left-col-content">Highlight Current Section<br/>- <code>highlightCurrentFromLocation()</code> reads <code>location.hash</code> and marks corresponding TOC links with <code>aria-current="page"</code>.<br/>- Clears previous highlights.<br/>- Works for both <code>#toc a</code> and <code>#tocBar a</code> selectors.<br/>- Scheduled after each build or click/scroll event.</div></div></td></tr><tr><td data-label="script.toc.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ–± Step 7</b></summary></details></div><div class="left-col-content">Click &amp; Scroll Interaction<br/>- <code>onTocClick(ev)</code> intercepts clicks on TOC links:<br/>Â Â - Prevents default link navigation.<br/>Â Â - Computes scroll target, accounting for sticky header height.<br/>Â Â - Smooth scrolls to target; updates URL via <code>history.replaceState</code>.<br/>Â Â - Schedules highlight update.<br/>- <code>attachDelegatedHandlers()</code> sets global click and <code>hashchange</code> listeners (idempotent, only once).</div></div></td></tr><tr><td data-label="script.toc.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ‘€ Step 8</b></summary></details></div><div class="left-col-content">Mutation Observation<br/>- <code>observeMutations()</code> observes dynamic content changes under <code>contentRoot</code>.<br/>- Watches <code>childList</code> and subtree only (ignores attributes for efficiency).<br/>- Triggers <code>debounceBuild()</code> on detected changes.<br/>- <code>_mutationObserver</code> safely disconnected and reconnected if needed.</div></div></td></tr><tr><td data-label="script.toc.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸŒ Step 9</b></summary></details></div><div class="left-col-content">Public API<br/>- <code>PTToc.build()</code> â†’ triggers debounced rebuild.<br/>- <code>PTToc.init(options)</code> â†’ merges config, attaches delegated handlers, performs initial guarded build, starts mutation observer.<br/>- Safe to call multiple times; idempotent.<br/>- Exposed globally via <code>window.PTToc</code>.</div></div></td></tr><tr><td data-label="script.toc.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ§© Step 10</b></summary></details></div><div class="left-col-content">Idempotence &amp; Safety<br/>- Prevents multiple installations via <code>window.__pt_toc_installed</code>.<br/>- Guarded rebuilds with <code>_buildLock</code>.<br/>- Skips DOM writes if items signature unchanged.<br/>- All DOM manipulations wrapped in try/catch.<br/>- Minimal reflows via <code>requestAnimationFrame</code>.<br/>- Debounced and mutation-observer-driven updates reduce CPU usage on dynamic content.</div></div></td></tr><tr><td data-label="script.toc.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ’¡ Step 11</b></summary></details></div><div class="left-col-content">Conceptual Notes &amp; Design Rationale<br/>- <strong>Efficiency:</strong> Minimizes DOM writes, reduces layout thrash, debounced rebuilds.<br/>- <strong>Dynamic Content-Friendly:</strong> Observes mutations, works with tables added after page load.<br/>- <strong>Accessibility:</strong> Uses ARIA roles and <code>aria-current</code> for screen readers.<br/>- <strong>Extensibility:</strong> Configurable selectors, row label prefix, and sticky header support.<br/>- <strong>Integration:</strong> Works alongside PasteToTable core without interference; supports single-table row TOC and heading-based TOC.<br/>- <strong>Robustness:</strong> Extensive try/catch, idempotent initialization, signature-based change detection.<br/>- <strong>UX:</strong> Smooth scrolling, location hash updates, highlights current topic automatically.</div></div></td></tr><tr><td data-label="script.toc.js â€” Conceptual Summary"><div class="tv-left-col"><div class="left-col-content"><details><summary><b>âœ… Conclusion</b></summary><br/><code>script.toc.js</code> provides a modular, efficient, and dynamic TOC system for PasteToTable. It handles both single-table and heading-based TOCs, supports mutation-driven updates, debounced and locked rebuilds, smooth scrolling with sticky headers, and accessibility features. Its design prioritizes minimal DOM impact, idempotence, and safe integration with other scripts.</details></div></div></td></tr></tbody></table></div><div class="row-count">Rows: 13</div></div><div class="table-caption" id="Table6" data-table="Docu_0106_06" style="margin-top:2mm;margin-left:3mm;"><strong>PTT Technical Breakdown â€¢ script.list.js</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **script.list.js â€” Expanded Technical Breakdown (Part 1 of 2)**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>script.list.js â€” Expanded Technical Breakdown (Part 1 of 2)</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 1 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ¯ Overview</b></summary><br/>Client</details></div><div class="left-col-content">side listing and loader for PasteToTable. Probes several possible server endpoints for file indexes. Loads optional <code>groups.json</code> and <code>labels.json</code>. Builds grouped UI in a modal. Provides a compact file-level search engine, ranking, fuzzy matching, and sequential file fetch+load into the paste area with safe caption injection. Includes delegated copy handlers that integrate with the renderer when available, and several defensive fallbacks to operate in minimal environments. Designed for idempotent attachment and minimal DOM thrash.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 1 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ“¦ File Purpose &amp; Scope</b></summary><br/></details></div><div class="left-col-content">Ship a single, self-contained module that: discovers saved markdown files; builds group metadata; presents a searchable UI of groups/files; loads selected files into the paste area while preserving safe captions; integrates with renderer and copy routines if present; degrades gracefully otherwise.<br/>- Avoids heavy dependencies and uses in-file inverted index and scoring to keep frontend CPU/memory bounded. Emphasizes try/catch defensive programming and progressive enhancement.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 1 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>âš™ï¸ Configuration &amp; Feature Flags</b></summary><br/></details></div><div class="left-col-content"><code>LIVE_FILES_ENDPOINTS</code>: prioritized list of server endpoints. The module attempts them sequentially until a usable list is returned. This allows the same client code to work with multiple hosting backends.<br/>- <code>GROUPS_JSON_CANDIDATES</code>, <code>LABELS_JSON_CANDIDATES</code>: candidates for metadata files used to supply human-friendly group descriptions and filenameâ†’caption mappings.<br/>- Timeouts: <code>INDEX_FETCH_TIMEOUT_MS</code>, <code>FILE_FETCH_TIMEOUT_MS</code>, <code>GROUPS_FETCH_TIMEOUT_MS</code>, <code>LABELS_FETCH_TIMEOUT_MS</code> control network patience.<br/>- <code>MAX_LIST_ITEMS</code>: caps the number of files handled to avoid UI blow-up.<br/>- <code>ENABLE_CACHE_BUSTER</code>: option to append a <code>_=</code> timestamp to requests for bypassing caches when necessary.<br/>- Worker/inverted-index toggles included for future integration but currently unused in core path; they show intent to offload heavy scoring when enabled.\br&gt;- All flags are top-level variables for easy adjustments by integrators.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 1 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ”§ Utility Functions &amp; Small Primitives</b></summary><br/></details></div><div class="left-col-content"><code>dbg()</code> conditional logging reduces console noise when DEBUG is false.<br/>- <code>safeTrim()</code>, <code>basenameFromPath()</code>, <code>removeExtension()</code> handle common filename manipulations and avoid exceptions on odd input types.<br/>- <code>encodedSavedUrlFor(relPath)</code>: canonicalizes local saved links into <code>/saved/&lt;encoded segments&gt;</code> and passes through absolute URLs unchanged. Ensures multi-segment paths are safely encoded and prevents accidental double-encoding.<br/>- <code>stripBOM()</code> removes UTF-8 BOM from fetched responses to avoid JSON parse failures.<br/>- <code>updateStatus(msg,isError)</code>: unified single-point status updates. Writes to <code>#status</code> element when present, otherwise uses a hidden <code>aria-live</code> element to inform screen readers and users. When <code>isError</code> sets <code>role="alert"</code> for urgency.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 1 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ“¡ Network helper</b></summary></details></div><div class="left-col-content">fetchWithTimeout<br/>- Wraps <code>fetch()</code> with timeout semantics using <code>AbortController</code> when available.<br/>- Returns uniform object <code>{ ok, status, url, body, err }</code> instead of throwing, making callers simpler and tolerant of network errors.<br/>- Uses <code>cache: 'no-store'</code> and <code>credentials: 'same-origin'</code> to reduce caching surprises and obey host auth cookies.<br/>- If <code>ENABLE_CACHE_BUSTER</code> true adds <code>_=</code> query param to bypass caches.<br/>- Key design: returns quickly on unreachable endpoints and tries next candidate; avoids long hangs that freeze UI flows.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 1 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ§° Index Normalization</b></summary><br/></details></div><div class="left-col-content"><code>normalizeIndexData(raw)</code> accepts multiple shapes:<br/>Â Â â€¢ Array of strings (path or filename).<br/>Â Â â€¢ Array of objects <code>{name,url,path,description}</code>.<br/>Â Â â€¢ Object <code>{ files: [...] }</code> common in some APIs.<br/>- Produces canonical entries <code>{ name, url, path, description }</code> where <code>name</code> is a basename and <code>path</code> is left when absolute URL absent.<br/>- <code>tryParseListBodyAsArray(txt)</code> tries JSON parse first, then newline-split fallback. This increases robustness against servers that return plain lists or JSON shapes.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 1 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ” Live files probing (sequential)</b></summary><br/></details></div><div class="left-col-content"><code>fetchLiveFilesSequential(endpoints)</code> performs ordered probing. For each endpoint it:<br/>Â Â â€¢ calls <code>fetchWithTimeout</code>.<br/>Â Â â€¢ attempts <code>tryParseListBodyAsArray</code> and <code>normalizeIndexData</code> on response.<br/>Â Â â€¢ if a valid non-empty normalized list is returned it resolves <code>{ ok:true, data:norm, source:res.url }</code>.<br/>- If none yield data returns <code>{ ok:false, data:[], source:null }</code> so the caller can display "No live files discovered" and abort gracefully.<br/>- Rationale: Many deployments expose different endpoints; probing sequentially simplifies configuration at the client side and avoids requiring exact server contract.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 1 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ· Labels loader &amp; caption index</b></summary><br/></details></div><div class="left-col-content"><code>loadLabels()</code> scans <code>LABELS_JSON_CANDIDATES</code> until parseable JSON is found. Each top-level key maps to a caption string. Example: <code>{ "chapter_01": "Chapter One: Intro" }</code>.<br/>- <code>buildLabelIndex(raw)</code> creates many canonical lookup variants per key using <code>keyVariants()</code> and stores captions under <code>canonKey(variant)</code> for fast lookup.<br/>- <code>keyVariants(base)</code> produces lowercased, no-space, underscore, dash variants and numeric-normalized variants (e.g., <code>chapter_01</code> â†’ <code>chapter_1</code>, <code>chapter01</code>, <code>chapter-01</code>). This tolerates inconsistent naming conventions between saved filenames and labels metadata.<br/>- The label index is cached in <code>__ptt_labels_cache</code> and exposed as <code>window.PTLabels</code> for integrators to inspect.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 1 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ” Caption resolution algorithm</b></summary><br/></details></div><div class="left-col-content"><code>resolveCaptionFor(baseName,labelIndex)</code> aims to return the most specific caption found for a filename base. Steps:<br/>Â Â 1. Strip extension and trim.<br/>Â Â 2. Generate many candidate string forms (space/dash/underscore/concatenated, numeric variants).<br/>Â Â 3. Canonicalize each candidate with <code>canonKey()</code> and dedupe preserving order.<br/>Â Â 4. Sort candidates by length desc (prefer longer, more specific keys).<br/>Â Â 5. Try exact key lookups against the label index in that order.<br/>Â Â 6. If none match, fallback to substring heuristics scanning label index keys for best containment match (picks longest matching key).<br/>- This reduces false positives when short keys are substrings of longer unrelated keys.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 1 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ“‚ Group building heuristics</b></summary><br/></details></div><div class="left-col-content"><code>groupKeyFromPath(pathOrName)</code> returns a human-meaningful group label using heuristics:<br/>Â Â â€¢ If path contains '/', use first segment as group.<br/>Â Â â€¢ Else strip extension and inspect underscores. If last underscore segment is numeric (e.g., <code>_01</code>), treat earlier segments as group.<br/>Â Â â€¢ Otherwise use first two underscore parts or the basename fallback.<br/>- <code>buildGroupsFromLive(liveFiles, labelsIndex)</code> builds <code>map[groupName] = { name, files: [...] }</code> and attaches resolved captions using <code>resolveCaptionFor(base,labelIndex)</code>. For each file it stores <code>{ name, url, path, caption }</code> and ensures <code>url</code> is safe via <code>encodedSavedUrlFor</code>.<br/>- Groups are sorted alphabetically, but <code>'Ungrouped'</code> is pushed to the end for UX consistency.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 1 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ§  File</b></summary></details></div><div class="left-col-content">level search engine (in-memory)<br/>- <code>createFileSearchEngine(items, opts)</code> produces a light inverted index keyed by tokens and prefixed token keys for caption (<code>c:</code>) and filename (<code>f:</code>). It also precalculates trigrams for fuzzy matching.<br/>- Lite entries include <code>tokens</code>, <code>triArr</code> (trigrams), and lightweight metadata for fast scoring.<br/>- <code>candidatesForQuery(q)</code> looks up token postings and returns candidate indices limited by <code>MAX_CANDIDATES</code>.<br/>- <code>scoreFiles(query, candidateIdxs)</code> asynchronously computes relevance using multiple signals:<br/>Â Â â€¢ Exact quoted phrase boost (very high).<br/>Â Â â€¢ Caption presence boost (high).<br/>Â Â â€¢ Filename presence boost (medium).<br/>Â Â â€¢ Matched token count multiplied by per-token weight.<br/>Â Â â€¢ Prefix boosts for caption and filename tokens starting with query tokens.<br/>Â Â â€¢ Trigram overlap fraction scaled to score.<br/>Â Â â€¢ Short-query fuzzy via cheap Damerau-Levenshtein (<code>cheapDL</code>) for small queries.<br/>Â Â â€¢ Small length penalty to prefer concise matches slightly.<br/>- Results sorted descending by score and returned as <code>{idx,score}</code> list. This produces stable, ranked file candidates for UI rendering.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 1 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>âš–ï¸ Scoring rationale &amp; trade</b></summary></details></div><div class="left-col-content">offs<br/>- Weighted multi-signal approach favors captions and filenames over generic body content. This improves discoverability when filenames/captions are curated.<br/>- Trigram overlap helps fuzzy match mid-length queries. Cheap DL handles short queries where trigram overlap is insufficient.<br/>- Conservative caps on postings and candidates prevent heavy resource use on large repositories.<br/>- Asynchronous scoring via Promise preserves UI responsiveness and enables future worker offload without changing call sites.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 1 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ§© UI</b></summary></details></div><div class="left-col-content">modal builder and accessibility<br/>- <code>createModal(contentEl,title)</code> constructs accessible overlay with:<br/>Â Â â€¢ <code>role="dialog"</code>, <code>aria-modal="true"</code>. <br/>Â Â â€¢ Sticky header containing title and Close button with label and keyboard Escape handler.<br/>Â Â â€¢ Focus management: attempts to focus first control in panel or the panel itself shortly after append.<br/>Â Â â€¢ Optional relocation of an existing search element into the modal header to unify UI controls.<br/>- Styling is inline and defensive. Colors read from CSS custom properties (if present) with safe fallbacks to ensure legible contrast in diverse host themes.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 1 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>â³ presentGroupsOnly</b></summary></details></div><div class="left-col-content">rendering strategy<br/>- Builds persistent group rows in <code>resultsWrap</code> and reuses them to minimize DOM churn. For each group a <code>groupControls</code> entry stores <code>{ rowWrap, toggleBtn, fileList, expanded, visible }</code> for local state tracking.<br/>- Each group header includes a toggle button, combined title+description, and a Load button. Toggle controls collapse/expand file list without re-creating DOM nodes. Load triggers sequential file fetch for the group's files.<br/>- File rows are created lazily and replaced inside <code>fileList</code> either on initial render or when search reduces file set. This keeps initial insertion cost linear with number of groups rather than total files.<br/>- Controls include ARIA attributes (<code>role="button"</code>, <code>aria-expanded</code>, <code>aria-pressed</code>) for assistive tech compatibility.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 14</div></div><div class="table-caption" id="Table7" data-table="Docu_0106_07" style="margin-top:2mm;margin-left:3mm;"><strong>PTT Technical Breakdown â€¢ script.list.js</strong></div>
<div class="table-wrapper" data-table-id="table-7"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **script.list.js â€” Expanded Technical Breakdown (Part 2 of 2)**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>script.list.js â€” Expanded Technical Breakdown (Part 2 of 2)</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 2 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ§ª Sequential fetch &amp; caption injection details</b></summary><br/></details></div><div class="left-col-content"><code>loadFilesSequentialAndHideForm(listOfFiles)</code> orchestrates staged fetches of file contents and produces two parallel accumulators: <code>accRaw</code> (raw file bodies) and <code>accMarked</code> (markdown annotated with safe captions).<br/>- Runtime captions array <code>runtimeCaptions</code> is built up-front to preserve per-file caption order. Default caption fallback is <code>Table N</code> when none provided. Duplicate default captions are cleared to avoid repetition.<br/>- Caption sanitization pipeline (<code>sanitizeCaptionForInjection</code>) removes HTML comments, script tags, all tags, and then escapes remaining characters via <code>escapeHtml</code>. Defensive replacements remove <code>--&gt;</code> remnants. This avoids XSS and prevents accidental server-side templating tokens from being re-injected.<br/>- <code>safeMarkdownHeading</code> ensures injected headings are normalized to <code>###</code> level and strips pre-existing heading markers and leading punctuation to avoid markup injection and inconsistent heading depth.<br/>- For each file fetched successfully the code pushes <code>&lt;!-- caption: SAFE --&gt;\n### SAFE\n\n&lt;file-body&gt;</code> into <code>accMarked</code> while <code>accRaw</code> only receives the raw body. This separation preserves a user-facing, renderer-friendly marked stream while maintaining a raw backup for paste area direct editing.<br/>- Errors in fetching create inline HTML comments <code>&lt;!-- failed to fetch: ... --&gt;</code> for traceability and do not abort entire load operation. The loader waits a short setTimeout (60ms) between file fetches to avoid hammering servers and to allow UI updates to remain responsive.<br/>- After all fetches complete, the logic writes <code>combinedRaw</code> into the paste textarea (<code>#paste</code>) if present, otherwise into <code>#page-area</code>. It also sets <code>window.__tv_last_source</code> and <code>window.__tv_last_source_ts</code> for integration with other scripts that expect the last paste source.<br/>- Convert invocation logic attempts in order: <code>window.__tv_do_convert({text,metadata})</code>, then <code>window.convert(combinedMarked)</code>, then a hidden textarea fallback <code>__ptt_hidden_convert</code> to inform passive renderers. This makes the loader tolerant of multiple renderer APIs across different hosts.<br/>- After invoking render, the caption application routine <code>applyRuntimeCaptions</code> polls DOM for caption nodes (<code>.table-caption</code> or <code>h1..h6</code>) and attempts to map runtime captions to DOM nodes by index, id, or content heuristics. It retries up to <code>maxRetries</code> with incremental intervals. On success it writes sanitized captions into nodes using <code>&lt;strong&gt;</code> markup to preserve visual weight and sets <code>id='TableN'</code> for headings when missing. On timeout it logs a warning and sets <code>window.__ptt_list_render_in_progress = false</code> to allow future operations. This approach trades immediacy for reliability in asynchronous renderers and slow JS-driven table generators.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 2 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ“‹ Copy delegation &amp; paste sync</b></summary><br/></details></div><div class="left-col-content">The module implements global delegated copy handlers to intercept clicks on <code>.copy-markdown</code> and <code>.copy-plain</code> selectors. It prefers delegation to renderer-provided <code>copyTableMarkdown</code> / <code>copyTablePlain</code> when available and when <code>window.__ptt_force_raw_copy</code> is false.<br/>- <code>getRawPasteText()</code> reads from <code>#paste</code>, <code>#page-area</code>, or <code>__ptt_hidden_convert</code> ensuring the latest user edits are captured. An <code>attachPasteSync</code> routine wires <code>input</code> events on <code>#paste</code> to keep <code>window.__tv_last_source</code> and timestamp in sync when user edits manually.<br/>- Fallback copy behavior extracts the first markdown table block using <code>findFirstMarkdownBlockInSource</code> and copies that or the entire raw paste text when no dedicated renderer is present. This prevents copying entire long pages when only a single table was intended.<br/>- Copies use <code>navigator.clipboard.writeText</code> when possible, otherwise the <code>execCommand</code> textarea fallback. Toasts notify success or failure using <code>window.showToast</code> if available.<br/>- API helpers exposed: <code>window.__ptt_copy_raw_from_paste()</code> and <code>window.__ptt_set_force_raw_copy(val)</code> to enable programmatic control and testing hooks for integrators.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 2 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ”’ Security considerations</b></summary><br/></details></div><div class="left-col-content">All external file content is treated as untrusted. Captions go through a robust sanitization flow that strips tags and script content and then escapes HTML. Captions are never injected as raw HTML. When setting <code>innerHTML</code> the code only does so with escaped content wrapped in <code>&lt;strong&gt;</code>, minimizing injection risk.<br/>- Network calls use <code>credentials: 'same-origin'</code> and <code>cache: 'no-store'</code> to avoid leaking cross-origin auth tokens and to reduce the chance of stale cached data. However integrators using CORS must ensure server CORS headers permit these requests.<br/>- The code avoids <code>eval</code>, <code>new Function</code>, and similar dynamic execution. It does create modal DOM elements but avoids <code>innerHTML</code> for untrusted content except for escaped strings used in small controlled contexts (captions and highlighted snippets).<br/>- The module includes many try/catch blocks around network parsing and DOM writes so that malformed server responses cannot crash the script, though they may degrade UX. All errors logged with <code>dbg()</code> only when DEBUG true. Critical failures surface via <code>updateStatus</code> to inform users.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 2 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>âš¡ Performance considerations</b></summary><br/></details></div><div class="left-col-content">Index normalization and label building operate on arrays limited by <code>MAX_LIST_ITEMS</code> and <code>MAX_CANDIDATES_FROM_INDEX</code>. These caps prevent OOM and keep lookup times bounded for large archives.<br/>- Inverted index posts are capped (<code>MAX_POSTINGS</code>) to avoid large posting lists that degrade query times.<br/>- Scoring uses precomputed tokenization and trigram sets to avoid repeated heavy string operations per query. Scoring runs asynchronously and returns a Promise so the UI remains responsive.<br/>- DOM rendering uses persistent group controls and updates file lists in-place. Bulk list updates use <code>innerHTML</code> only in tightly controlled contexts or are batched inside <code>requestAnimationFrame</code> loops to reduce layout thrash. Modal content has a capped maxHeight and <code>overflowY:auto</code> to avoid forcing full reflows for huge lists.<br/>- Sequential file fetch includes slight delays (60ms) between fetches. This intentionally reduces simultaneous request counts. For faster networks integrators can increase parallelism by modifying <code>loadFilesSequentialAndHideForm</code> to fetch in parallel with concurrency control, but that increases server load risk.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 2 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ§­ Accessibility &amp; UX</b></summary><br/></details></div><div class="left-col-content">Modal uses <code>role="dialog"</code> and <code>aria-modal="true"</code>. Close button has <code>aria-label</code>; Escape key closes modal.<br/>- Group headers are keyboard-focusable (<code>tabIndex=0</code>) and have <code>role="button"</code> with <code>aria-expanded</code> on toggle controls for screen reader clarity.<br/>- Search input has <code>placeholder</code> and <code>aria-label</code> for discovery. Results container uses <code>role="list"</code> though individual file rows are not explicit <code>role="listitem"</code> due to simple markup; can be enhanced if required.<br/>- Visual contrast attempts to respect CSS variables <code>--panel</code>, <code>--text</code>, <code>--muted</code>. Defaults provided ensure legibility if host variables are absent.<br/>- Smooth scrolling on TOC links is implemented elsewhere (<code>script.toc.js</code>) and list modal uses <code>scrollIntoView</code> for initial focus. The list's modal focuses the first control shortly after opening to allow immediate keyboard use.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 2 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ” Integration points &amp; global tokens</b></summary><br/></details></div><div class="left-col-content">Exposes and reads several globals for integrator interplay:<br/>Â Â â€¢ <code>window.__tv_last_source</code> / <code>__tv_last_source_ts</code> â€” last loaded raw source.<br/>Â Â â€¢ <code>window.__ptt_runtime_captions</code> â€” array used by caption-apply routine.<br/>Â Â â€¢ <code>window.__ptt_list_render_in_progress</code> â€” boolean used to prevent concurrent list renders.<br/>Â Â â€¢ <code>window.__ptt_hidden_convert</code> â€” fallback hidden textarea for renderers that read DOM instead of API.<br/>Â Â â€¢ <code>window.PTLabels</code> â€” cached labels index for debugging.<br/>- Calls into renderer APIs if present: <code>window.__tv_do_convert</code>, <code>window.convert</code>, <code>window.showToast</code>, <code>window.copyTableMarkdown</code>, <code>window.copyTablePlain</code>, <code>window.XLSX</code> for spreadsheet exports. These are attempted safely within try/catch.<br/>- The module sets dataset flags on attached elements (e.g., <code>btn.dataset.__ptt_list_attached</code>, <code>btn.dataset.__ptt_save_md_attached</code>) to avoid duplicate handler attachments when multiple copies of the script run or when re-initialized.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 2 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>âš™ï¸ Edge cases handled</b></summary><br/></details></div><div class="left-col-content">Server returns non-JSON but newline list: parsed via <code>tryParseListBodyAsArray</code>.<br/>- Single-table pages vs multi-table pages: presentGroupsOnly operates on normalized file lists and does not assume page structure; caption application detects <code>.table-caption</code> nodes and heading nodes for flexible mapping.<br/>- Duplicate filenames or duplicate default captions: runtime dedupe removes repeated <code>Table N</code> placeholders to avoid overwriting different tables with the same label.<br/>- Slow renderers that mutate the DOM after conversion: caption application polling with retries ensures captions eventually attach when renderer finishes asynchronous DOM composition.<br/>- Missing <code>#paste</code> textarea: falls back to <code>#page-area</code> and <code>__ptt_hidden_convert</code> to preserve behavior on minimal pages.<br/>- AbortController absence: <code>fetchWithTimeout</code> falls back to timeout via setTimeout and still returns consistent response objects rather than throwing.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 2 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ›  Upgrade &amp; maintenance notes</b></summary><br/></details></div><div class="left-col-content">Suggested refactors for future work:<br/>Â Â 1. Extract scoring into a separate module and provide a pluggable worker-backed scorer interface. This allows offloading heavy scoring to WebWorkers for large archives without changing the public UI calls.<br/>Â Â 2. Convert synchronous tokenization utilities to WebAssembly or dedicated worker if &gt;10k files need indexing.<br/>Â Â 3. Replace inline style-heavy modal with CSS class hooks to allow theme overrides from host pages and smaller payloads.<br/>Â Â 4. Provide a compact adapter API so server endpoints can return a canonical JSON shape and skip local normalization costs.<br/>Â Â 5. Add <code>role="listitem"</code> to file rows and extra ARIA attributes for better assistive tech semantics where required.<br/>- Breakpoints and runtime flags: expose <code>PTT_LIST_CONFIG</code> global object to allow integrators to tweak <code>MAX_LIST_ITEMS</code>, timeouts, cache-buster, and fetch endpoints without editing script code.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 2 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ§¾ Testing checklist &amp; unit</b></summary></details></div><div class="left-col-content">test ideas<br/>- Unit tests (JS environment with DOM emulation or JSDOM):<br/>Â Â â€¢ <code>normalizeIndexData</code> accepts JSON array, object-with-files, and plain newline lists.<br/>Â Â â€¢ <code>buildLabelIndex</code> and <code>resolveCaptionFor</code> return expected captions for many filename variants incl. padded numeric suffixes.<br/>Â Â â€¢ <code>groupKeyFromPath</code> groups <code>a/b/file.md</code> â†’ <code>a</code> and <code>chapter_01.md</code> â†’ <code>chapter</code>.<br/>Â Â â€¢ <code>fetchWithTimeout</code> returns <code>{ok:false,err:'timeout'}</code> when server hangs beyond timeout; Test with mock fetch and forced delay.<br/>Â Â â€¢ <code>createFileSearchEngine</code> candidate retrieval and scoring for simple queries, quoted phrase, and short fuzzy queries; assert ordering.<br/>Â Â â€¢ <code>sanitizeCaptionForInjection</code> rejects script tags and returns escaped text.<br/>- Integration / E2E tests (headless browser):<br/>Â Â â€¢ Load modal UI, set up fake <code>/saved/list</code> endpoint, verify modal shows groups and files, click Load =&gt; files appear in paste area and convert invoked (spy on convert API).<br/>Â Â â€¢ Simulate renderer that delays DOM insertion and verify caption application eventually populates <code>.table-caption</code> nodes by polling.<br/>Â Â â€¢ Simulate copy button clicks to ensure delegated copy falls back to raw copy when renderer copy API absent.<br/>- Performance tests:<br/>Â Â â€¢ Index 5k synthetic items and measure candidate generation and top-k scoring latency. Ensure under target (e.g., &lt;200ms) or offload to worker when above threshold.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 2 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ” Observability &amp; debugging hooks</b></summary><br/></details></div><div class="left-col-content">Expose <code>window.PTLabels</code> and <code>window.__ptt_labels_cache</code> to inspect parsed labels.<br/>- <code>updateStatus</code> writes human-readable progress messages to <code>#status</code>; integrators can add a visible status bar for debugging.<br/>- <code>dbg()</code> toggled via <code>DEBUG</code> variable to show console traces. Recommend toggling <code>DEBUG=true</code> in dev environments only.<br/>- Suggest adding <code>window.__ptt_last_build_signature</code> if integrators want to inspect <code>_lastItemsSignature</code> for TOC interactions between <code>script.list.js</code> and <code>script.toc.js</code>.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 2 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>ğŸ“¦ Deployment &amp; compatibility notes</b></summary><br/></details></div><div class="left-col-content">Works on modern evergreen browsers with <code>fetch</code> and <code>AbortController</code>. Fallbacks exist for older environments but with reduced timeout cancel behavior.<br/>- CSS variable dependency is optional; falls back to safe default inline colors if host does not define theme tokens.<br/>- Should be loaded with <code>defer</code> to avoid blocking parsing. When embedded in pages with CSP, ensure <code>script-src</code> allows the asset origin and <code>style-src</code> allows inline styles if integrator must avoid inline styles then convert them to classes and add host CSS.<br/>- If host uses strict CSP disallowing <code>eval</code> and inline styles, move modal styling to a separate CSS file and avoid setting <code>innerHTML</code> on nodes that display user-provided captions (already escaped).<br/>- For sites behind strict authentication, ensure <code>/saved/*</code> endpoints are reachable with same-origin credentials or adjust <code>fetch</code> options accordingly.</div></div></td></tr><tr><td data-label="script.list.js â€” Expanded Technical Breakdown (Part 2 of 2)"><div class="tv-left-col"><div class="left-col-heading"><details><summary><b>âœ… Final conceptual notes &amp; wrap</b></summary></details></div><div class="left-col-content">up<br/>- <code>script.list.js</code> is a defensive, progressive-enhancement module for delivering saved markdown groups to users. It balances UX, security, and performance through:<br/>Â Â â€¢ Robust network probing of multiple endpoints.<br/>Â Â â€¢ Label and group heuristics tolerant of inconsistent filename schemes.<br/>Â Â â€¢ In-memory lightweight search and scoring tuned for small-to-medium archives.<br/>Â Â â€¢ Safe caption sanitization and eventual DOM injection for asynchronous renderers.<br/>Â Â â€¢ Delegated copy and integration points for broader PasteToTable ecosystem.<br/>- The code is intentionally conservative: caps and retries exist to protect host pages and servers. For scaling to very large archives, follow the upgrade recommendations (workerized scoring, server canonical index, and pagination of file lists).<br/>- To proceed: approve this batch and indicate whether you want a PR-style diff with explicit patches, inline code comments for maintainers, or a tightened audit focusing on security or workerization next.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 12</div></div><div class="table-caption" id="Table8" data-table="Docu_0106_08" style="margin-top:2mm;margin-left:3mm;"><strong>Table 8</strong></div>
<div class="table-wrapper" data-table-id="table-8"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **TV2.1  CODE0  â†’ Revision Plan for PTT  CODE1 **" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>TV2.1  CODE0  â†’ Revision Plan for PTT  CODE1 </strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th><th aria-label="Sort by Revision Plan" class="tv-col" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Revision Plan</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="TV2.1  CODE0  â†’ Revision Plan for PTT  CODE1 "><div class="tv-left-col"><div class="left-col-heading"><strong>ğŸ¯ Purpose &amp; Scope</strong><br/>Current: Central client-side orchestrator handling setup, configuration, utilities, TOC, DOM rendering, scroll, conversion, toast, and event delegation. Defensive and multi-init safe.</div></div></td><td data-label="Revision Plan"> <strong>Plan:</strong> Preserve architecture but strip redundant scroll-reset logic. Delay scroll-to-top until render success confirmation. Add granular flags to control scroll per context (user convert vs system init). </td></tr><tr><td data-label="TV2.1  CODE0  â†’ Revision Plan for PTT  CODE1 "><div class="tv-left-col"><div class="left-col-heading"><strong>âš™ï¸ Configuration &amp; Globals</strong><br/>Current: Global flags (<code>window.tvConfig</code>, <code>window.__tv_skip_scroll</code>, <code>TV_DEBUG</code>) control init and debounce. Base URL auto-detected.</div></div></td><td data-label="Revision Plan"> <strong>Plan:</strong> Add <code>PTTConfig.skipScrollOnLoad</code> and <code>PTTConfig.scrollBehavior</code> to fine-tune scroll. Make base detection simpler by caching last known script root.                                                  </td></tr><tr><td data-label="TV2.1  CODE0  â†’ Revision Plan for PTT  CODE1 "><div class="tv-left-col"><div class="left-col-heading"><strong>ğŸ›  Utility Functions</strong><br/>Current: Wide toolkit: clipboard, blob download, safe, debounce, filename sanitization, search normalization.</div></div></td><td data-label="Revision Plan"> <strong>Plan:</strong> Keep identical API surface for compatibility. Improve <code>debounce()</code> to cancel prior triggers during DOM updates. Remove legacy fallbacks if supported browsers are modern.                            </td></tr><tr><td data-label="TV2.1  CODE0  â†’ Revision Plan for PTT  CODE1 "><div class="tv-left-col"><div class="left-col-heading"><strong>ğŸ’» Extra Script Loader</strong><br/>Current: Sequential loader for <code>extra.js</code>, retry mechanism.</div></div></td><td data-label="Revision Plan"> <strong>Plan:</strong> Keep loader but shift execution post-DOM-ready only. Add version log to detect duplicate loads.                                                                                                      </td></tr><tr><td data-label="TV2.1  CODE0  â†’ Revision Plan for PTT  CODE1 "><div class="tv-left-col"><div class="left-col-heading"><strong>ğŸ“œ CSS Injection</strong><br/>Current: Injects CSS for TOC and button hiding dynamically in try/catch.</div></div></td><td data-label="Revision Plan"> <strong>Plan:</strong> Move static CSS to stylesheet. Remove runtime CSS injection except for conditional visual tweaks (toast, debug).                                                                                     </td></tr><tr><td data-label="TV2.1  CODE0  â†’ Revision Plan for PTT  CODE1 "><div class="tv-left-col"><div class="left-col-heading"><strong>ğŸ“ Toast System</strong><br/>Current: Robust queue with duration auto-scaling and deduplication.</div></div></td><td data-label="Revision Plan"> <strong>Plan:</strong> Keep same architecture. Add fade delay to prevent layout shift. Integrate with native browser notifications toggle (optional).                                                                       </td></tr><tr><td data-label="TV2.1  CODE0  â†’ Revision Plan for PTT  CODE1 "><div class="tv-left-col"><div class="left-col-heading"><strong>ğŸ“– TOC Initialization</strong><br/>Current: IIFE observer for <code>#content</code>/<code>#tables-viewer</code>, debounced attach.</div></div></td><td data-label="Revision Plan"> <strong>Plan:</strong> Integrate unified observer under <code>PTTocController</code>. Only rebuild TOC after confirmed content change. Remove duplicate observer paths.                                                                </td></tr><tr><td data-label="TV2.1  CODE0  â†’ Revision Plan for PTT  CODE1 "><div class="tv-left-col"><div class="left-col-heading"><strong>ğŸ–¥ DOM &amp; Render Handling</strong><br/>Current: Injects HTML, coordinates scroll-up, retries TOC build, ensures init.</div></div></td><td data-label="Revision Plan"> <strong>Plan:</strong> Simplify <code>processRenderedHtml()</code>: only scroll once on first conversion. Replace chained timeouts with MutationObserver completion signal. Prevent multiple forced scroll-ups.                        </td></tr><tr><td data-label="TV2.1  CODE0  â†’ Revision Plan for PTT  CODE1 "><div class="tv-left-col"><div class="left-col-heading"><strong>âš¡ Conversion Logic</strong><br/>Current: Async conversion with fetch + toast + retry + injection.</div></div></td><td data-label="Revision Plan"> <strong>Plan:</strong> Retain async model but modularize: <code>prepareInput</code>, <code>fetchResult</code>, <code>renderOutput</code>. Add timing metrics for debug. Skip scroll-up if conversion originated from â€œappend mode.â€                          </td></tr><tr><td data-label="TV2.1  CODE0  â†’ Revision Plan for PTT  CODE1 "><div class="tv-left-col"><div class="left-col-heading"><strong>ğŸ–± Button Handlers</strong><br/>Current: Conversion, clear, save, export handlers attached once with flags.</div></div></td><td data-label="Revision Plan"> <strong>Plan:</strong> Retain delegation pattern but defer attach until DOM complete. Ensure clear/reset doesnâ€™t trigger scroll.                                                                                            </td></tr><tr><td data-label="TV2.1  CODE0  â†’ Revision Plan for PTT  CODE1 "><div class="tv-left-col"><div class="left-col-heading"><strong>ğŸ§© Shared Utilities Exposure</strong><br/>Current: Exposes <code>tvUtils</code> for clipboard, download, toast, debounce.</div></div></td><td data-label="Revision Plan"> <strong>Plan:</strong> Keep API identical. Add <code>scrollControl(force=false)</code> utility.                                                                                                                                        </td></tr><tr><td data-label="TV2.1  CODE0  â†’ Revision Plan for PTT  CODE1 "><div class="tv-left-col"><div class="left-col-heading"><strong>âœ… Error Resilience</strong><br/>Current: Fully wrapped in try/catch; failures logged via debug flag.</div></div></td><td data-label="Revision Plan"> <strong>Plan:</strong> Maintain same pattern. Add scoped error codes for scroll, conversion, render. Use unified <code>PTTError.log()</code> hook.                                                                                     </td></tr><tr><td data-label="TV2.1  CODE0  â†’ Revision Plan for PTT  CODE1 "><div class="tv-left-col"><div class="left-col-heading"><strong>ğŸ“Œ Behavior Notes</strong><br/>Current: Multi-trigger safe, async resilient, minimal blocking.</div></div></td><td data-label="Revision Plan"> <strong>Plan:</strong> Make scroll independent of TOC. Introduce progressive enhancement mode (init core â†’ load UI).                                                                                                        </td></tr><tr><td data-label="TV2.1  CODE0  â†’ Revision Plan for PTT  CODE1 "><div class="tv-left-col"><div class="left-col-heading"><strong>âš ï¸ Edge Cases</strong><br/>Current: Gracefully handles missing DOM, empty paste, multi-click.</div></div></td><td data-label="Revision Plan"> <strong>Plan:</strong> Explicitly detect forced reinit from saved session and skip scroll. Add check for duplicate <code>#tables-viewer</code> injection.                                                                              </td></tr><tr><td data-label="TV2.1  CODE0  â†’ Revision Plan for PTT  CODE1 "><div class="tv-left-col"><div class="left-col-heading"><strong>ğŸ“ Summary</strong><br/>Current: Resilient and complete, but visually â€œjumpyâ€ due to scroll coordination logic.</div></div></td><td data-label="Revision Plan"> <strong>Plan:</strong> Keep all functionality but re-engineer scroll logic for stability: scroll only when essential, triggered by deliberate convert actions, not background init.                                         </td></tr></tbody></table></div><div class="row-count">Rows: 15</div></div><div class="table-caption" id="Table9" data-table="Docu_0106_09" style="margin-top:2mm;margin-left:3mm;"><strong>Table 9</strong></div>
<div class="table-wrapper" data-table-id="table-9"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **Area**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Area</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th><th aria-label="Sort by **Conceptual Plan (Detailed Expansion)**" class="tv-col" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Conceptual Plan (Detailed Expansion)</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Area"><div class="tv-left-col"><div class="left-col-heading"><strong>1ï¸âƒ£ Scroll Coordination Framework</strong></div></div></td><td data-label="Conceptual Plan (Detailed Expansion)"> Replace global boolean <code>__tv_skip_scroll</code> with a modular system:<br/>â€¢ Introduce <code>window.PTTScroll</code> controller object with methods:<br/>â€ƒ- <code>PTTScroll.enable()</code> â€” allows scroll actions.<br/>â€ƒ- <code>PTTScroll.disable(reason)</code> â€” temporarily locks scroll.<br/>â€ƒ- <code>PTTScroll.scrollToTop(context)</code> â€” executes scroll only if allowed and context-appropriate.<br/>â€¢ Add lightweight event dispatch: <code>document.dispatchEvent(new CustomEvent('ptt:scrollDone'))</code> after controlled scroll finishes.<br/>â€¢ Use <code>scrollTo({top: 0, behavior: 'smooth'})</code> instead of multiple <code>setTimeout</code> retries.<br/>â€¢ Ensure <code>scrollToTop()</code> runs once per successful render cycle, never before HTML insertion completes. </td></tr><tr><td data-label="Area"><div class="tv-left-col"><div class="left-col-heading"><strong>2ï¸âƒ£ Configurable Scroll Policies</strong></div></div></td><td data-label="Conceptual Plan (Detailed Expansion)"> Add <code>window.PTTConfig.scrollBehavior</code> enum with modes:<br/>â€¢ <code>"auto"</code> (default): scroll only after new conversion.<br/>â€¢ <code>"manual"</code>: never auto-scroll; rely on user action.<br/>â€¢ <code>"append"</code>: skip scroll if content appended.<br/>â€¢ <code>"always"</code>: force scroll to top regardless of state.<br/>Each mode used to conditionally trigger <code>PTTScroll.scrollToTop()</code> in render pipeline.<br/>Expose public setter <code>window.setPTTScrollMode(mode)</code> for developers or settings panels.                                                                                                                                                                                                                      </td></tr><tr><td data-label="Area"><div class="tv-left-col"><div class="left-col-heading"><strong>3ï¸âƒ£ Event Hooks for Scroll Lifecycle</strong></div></div></td><td data-label="Conceptual Plan (Detailed Expansion)"> Define scroll lifecycle events for observability and plugin use:<br/>â€¢ <code>ptt:beforeScroll</code> (fired before scroll begins).<br/>â€¢ <code>ptt:scrollStart</code> (on actual scroll trigger).<br/>â€¢ <code>ptt:scrollEnd</code> (after scroll finishes).<br/>â€¢ <code>ptt:scrollCanceled</code> (if locked).<br/>These enable safe integration with TOC rebuild or analytics, without race conditions.                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Area"><div class="tv-left-col"><div class="left-col-heading"><strong>4ï¸âƒ£ Scroll Trigger Conditions (Decision Logic)</strong></div></div></td><td data-label="Conceptual Plan (Detailed Expansion)"> Replace unconditional scroll calls with decision tree:<br/><strong>IF</strong> conversion success <strong>AND</strong> user explicitly clicked â€œConvertâ€ â†’ scroll.<br/><strong>ELSE IF</strong> auto-refresh or background reinit â†’ skip.<br/><strong>ELSE IF</strong> render originated from local file or restore session â†’ skip.<br/><strong>ELSE IF</strong> multiple tables inserted sequentially â†’ skip intermediate scroll, defer until all tables rendered.<br/>All decisions consolidated inside <code>shouldScroll(context)</code> helper returning boolean.                                                                                                                                                                                                           </td></tr><tr><td data-label="Area"><div class="tv-left-col"><div class="left-col-heading"><strong>5ï¸âƒ£ Eliminate Redundant Timeout Scroll Attempts</strong></div></div></td><td data-label="Conceptual Plan (Detailed Expansion)"> Current logic triggers scroll attempts at 0ms, 60ms, 250ms, 600ms.<br/>Replace with one controlled callback triggered by DOM mutation observer:<br/>â€¢ Observe <code>#tables-viewer</code> for childList changes.<br/>â€¢ When mutation settles (no change for 200ms), emit <code>ptt:renderStable</code>.<br/>â€¢ Attach single scroll action to that event.<br/>This prevents â€œforced up-scrollâ€ before content is ready.                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Area"><div class="tv-left-col"><div class="left-col-heading"><strong>6ï¸âƒ£ Integration with TOC and Render Flow</strong></div></div></td><td data-label="Conceptual Plan (Detailed Expansion)"> Integrate scroll logic at final stage of conversion:<br/>â€¢ Conversion â†’ inject HTML â†’ dispatch <code>ptt:renderComplete</code> â†’ call <code>PTToc.rebuild()</code> â†’ then optionally scroll.<br/>â€¢ If TOC rebuild triggers internal scroll (e.g., focusing first entry), the scroll controller detects duplicate motion and suppresses secondary scroll.<br/>â€¢ Optional config <code>PTTConfig.scrollAfterTOC = true</code> for legacy compatibility.                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Area"><div class="tv-left-col"><div class="left-col-heading"><strong>7ï¸âƒ£ Smooth Visual Transitions</strong></div></div></td><td data-label="Conceptual Plan (Detailed Expansion)"> To reduce user-perceived â€œjumpinessâ€:<br/>â€¢ Add temporary CSS <code>html.smooth-scroll { scroll-behavior: smooth; }</code> applied during scroll only.<br/>â€¢ Remove after 1s.<br/>â€¢ Keep toast notifications positioned fixed, not absolute, to prevent reflow during scroll animation.<br/>â€¢ Avoid scroll when toast visible with <code>PTTScroll.isToastBlocking()</code>.                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Area"><div class="tv-left-col"><div class="left-col-heading"><strong>8ï¸âƒ£ Status Preservation Across Scrolls</strong></div></div></td><td data-label="Conceptual Plan (Detailed Expansion)"> Preserve visible state of status/message area:<br/>â€¢ If <code>#status</code> is in view before conversion, do not immediately scroll.<br/>â€¢ Instead, scroll after user dismisses toast or presses â€œBack to Topâ€ if needed.<br/>â€¢ Add minor delay if conversion completes instantly (avoid scroll flicker).                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Area"><div class="tv-left-col"><div class="left-col-heading"><strong>9ï¸âƒ£ Accessibility &amp; UX Considerations</strong></div></div></td><td data-label="Conceptual Plan (Detailed Expansion)"> â€¢ Announce scroll actions via ARIA live region (â€œView moved to top after conversionâ€).<br/>â€¢ Provide keyboard shortcut override: Shift+Home triggers scroll manually.<br/>â€¢ Maintain focus on last interacted element (e.g., Convert button) post-scroll.<br/>â€¢ Do not scroll if focused element is a text input or editable content.                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Area"><div class="tv-left-col"><div class="left-col-heading"><strong>ğŸ”Ÿ Developer/Debug Controls</strong></div></div></td><td data-label="Conceptual Plan (Detailed Expansion)"> Add <code>window.__PTT_DEBUG_SCROLL</code> flag to print logs:<br/>â€“ â€œScroll permitted: reason=convertUserActionâ€<br/>â€“ â€œScroll skipped: mode=append, context=autoRenderâ€<br/>â€“ â€œScroll finished: duration=340msâ€<br/>This will allow developers to tune behavior easily without code editing.                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Area"><div class="tv-left-col"><div class="left-col-heading"><strong>11ï¸âƒ£ Fail-Safe Recovery</strong></div></div></td><td data-label="Conceptual Plan (Detailed Expansion)"> â€¢ In rare case scroll controller deadlocks (e.g., observer detached), fallback to simple one-time scroll at next conversion.<br/>â€¢ Fallback triggered by timer only if <code>document.readyState==='complete' &amp;&amp; noScrollEventFired</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Area"><div class="tv-left-col"><div class="left-col-heading"><strong>12ï¸âƒ£ Optional User Preference Storage</strong></div></div></td><td data-label="Conceptual Plan (Detailed Expansion)"> Allow persistent scroll mode via localStorage:<br/>â€¢ Key: <code>ptt_scroll_behavior</code>.<br/>â€¢ Auto-restored on page load.<br/>â€¢ Optionally exposed in settings panel (â€œAuto-scroll after conversionâ€).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Area"><div class="tv-left-col"><div class="left-col-heading"><strong>13ï¸âƒ£ Modular Placement in Code</strong></div></div></td><td data-label="Conceptual Plan (Detailed Expansion)"> Place new logic in a distinct section:<br/><code>// === Scroll Management Core ===</code> before DOM/render functions.<br/>Keep API accessible through global <code>window.PTTScroll</code>. Ensure existing logic referring to <code>__tv_skip_scroll</code> replaced with compatibility alias: <code>window.__tv_skip_scroll = !PTTScroll.isEnabled()</code>.                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Area"><div class="tv-left-col"><div class="left-col-heading"><strong>14ï¸âƒ£ Testing &amp; Verification Scenarios</strong></div></div></td><td data-label="Conceptual Plan (Detailed Expansion)"> Verify under:<br/>â€¢ Fresh load + first conversion.<br/>â€¢ Sequential conversions.<br/>â€¢ Conversion triggered via append.<br/>â€¢ Large table injection (&gt;10k rows).<br/>â€¢ Browser with reduced motion preference (<code>prefers-reduced-motion</code>).<br/>â€¢ Mobile/touch scroll momentum scenarios.                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Area"><div class="tv-left-col"><div class="left-col-heading"><strong>15ï¸âƒ£ Expected Outcomes</strong></div></div></td><td data-label="Conceptual Plan (Detailed Expansion)"> âœ… Smoother experience (no forced scroll during load).<br/>âœ… Clearer control for developers and users.<br/>âœ… Zero redundant retries.<br/>âœ… Full backward compatibility with legacy TOC and PasteToTable hooks.<br/>âœ… Less CPU time spent on scroll-related timers and forced reflows.                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr></tbody></table></div><div class="row-count">Rows: 15</div></div><div class="table-caption" id="Table10" data-table="Docu_0106_10" style="margin-top:2mm;margin-left:3mm;"><strong>Table 10</strong></div>
<div class="table-wrapper" data-table-id="table-10"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **PTT SCROLL MANAGEMENT CORE â€” REVISION FLOW STRUCTURE**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>PTT SCROLL MANAGEMENT CORE â€” REVISION FLOW STRUCTURE</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="PTT SCROLL MANAGEMENT CORE â€” REVISION FLOW STRUCTURE"><div class="tv-left-col"><div class="left-col-content"><details><summary><b>ğŸ§© Module Overview</b></summary><br/><br/><code>assets/script.core.js</code><br/>â”œâ”€ ğŸ§  <b>Core Scroll Controller</b><br/>â”‚  â”œâ”€ PTTScroll.enable()<br/>â”‚  â”œâ”€ PTTScroll.disable(reason)<br/>â”‚  â”œâ”€ PTTScroll.scrollToTop(context)<br/>â”‚  â”œâ”€ PTTScroll.shouldScroll(context)<br/>â”‚  â”œâ”€ PTTScroll.isEnabled()<br/>â”‚  â”œâ”€ PTTScroll.isToastBlocking()<br/>â”‚  â”œâ”€ PTTScroll.debug(msg, â€¦)<br/>â”‚  â””â”€ PTTScroll.initObservers()<br/>â”œâ”€ âš™ï¸ <b>Configuration</b><br/>â”‚  â”œâ”€ window.PTTConfig.scrollBehavior = "auto"<br/>â”‚  â”œâ”€ window.PTTConfig.scrollAfterTOC = false<br/>â”‚  â”œâ”€ window.setPTTScrollMode(mode)<br/>â”‚  â””â”€ localStorage persistence (key: <code>ptt_scroll_behavior</code>)<br/>â”œâ”€ ğŸ”” <b>Lifecycle Events</b><br/>â”‚  â”œâ”€ ptt:beforeScroll<br/>â”‚  â”œâ”€ ptt:scrollStart<br/>â”‚  â”œâ”€ ptt:scrollEnd<br/>â”‚  â”œâ”€ ptt:scrollCanceled<br/>â”‚  â”œâ”€ ptt:renderStable<br/>â”‚  â”œâ”€ ptt:renderComplete<br/>â”‚  â””â”€ ptt:scrollDone<br/>â”œâ”€ ğŸ§­ <b>Integration Hooks</b><br/>â”‚  â”œâ”€ Conversion Flow<br/>â”‚  â”‚   â€¢ convert â†’ fetch â†’ inject â†’ dispatch <code>ptt:renderComplete</code> â†’ rebuild TOC â†’ optional scroll<br/>â”‚  â”œâ”€ TOC Flow<br/>â”‚  â”‚   â€¢ TOC rebuild triggers <code>ptt:tocRebuilt</code> â†’ optional delayed scroll<br/>â”‚  â”œâ”€ Toast Interaction<br/>â”‚  â”‚   â€¢ PTTScroll.waitIfToastActive() â†’ hold scroll until toast dismissed<br/>â”‚  â””â”€ Restore Session Flow<br/>â”‚      â€¢ skip scroll unless mode=â€œalwaysâ€<br/>â”œâ”€ â± <b>Observer Logic</b><br/>â”‚  â”œâ”€ MutationObserver on <code>#tables-viewer</code><br/>â”‚  â”‚   â€¢ detect content change â†’ debounce 200 ms â†’ fire <code>ptt:renderStable</code><br/>â”‚  â””â”€ ScrollController listens to <code>ptt:renderStable</code> â†’ execute scroll once<br/>â”œâ”€ ğŸ› <b>Decision Matrix</b><br/>â”‚  â”œâ”€ userClickedConvert â†’ scroll (auto/manual check)<br/>â”‚  â”œâ”€ appendMode â†’ skip<br/>â”‚  â”œâ”€ sessionRestore â†’ skip<br/>â”‚  â”œâ”€ multipleSequentialRenders â†’ delay until final<br/>â”‚  â””â”€ fallback once if none triggered<br/>â”œâ”€ â™¿ <b>Accessibility &amp; UX</b><br/>â”‚  â”œâ”€ announces via ARIA live region<br/>â”‚  â”œâ”€ maintains focus on last interacted element<br/>â”‚  â”œâ”€ ignores scroll if user editing input<br/>â”‚  â”œâ”€ optional smooth-scroll CSS injection<br/>â”‚  â””â”€ shift+Home keyboard override<br/>â”œâ”€ ğŸ§© <b>Debugging</b><br/>â”‚  â”œâ”€ window.__PTT_DEBUG_SCROLL flag<br/>â”‚  â”œâ”€ logs: â€œScroll permittedâ€, â€œSkippedâ€, â€œFinishedâ€<br/>â”‚  â””â”€ fail-safe fallback timer<br/>â””â”€ âœ… <b>Expected Integration Result</b><br/>â€ƒâ€¢ Scroll fires once per conversion.<br/>â€ƒâ€¢ No forced jump at load.<br/>â€ƒâ€¢ User preference respected.<br/>â€ƒâ€¢ Zero redundant timers.<br/>â€ƒâ€¢ Compatible with existing PasteToTable and TOC behavior.</details></div></div></td></tr></tbody></table></div><div class="row-count">Rows: 1</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>