<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1763345902">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#Table6">Table 6</a></li>
<li class="toc-item"><a class="toc-link" href="#Table7">Table 7</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0116_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module purpose & overview</strong> — Orchestrates end-to-end rendering of heterogeneous inputs (CSV, markdown, HTML, DataFrame-like, lists) into a single index HTML for PasteToTable (PTT). Responsibilities: normalize inputs → detect/parse tabular data → render fragments (concurrent) → compose final HTML with assets, TOC, captions and fallbacks. Returns a result dict and writes <code>output_html</code>.                                                                                                                                                                                               </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public contract (render_html)</strong> — Inputs: <code>all_tables</code> (iterable), <code>output_html</code> (path), <code>markdown_to_html</code> (callable), optional hooks/config (cdn_integrity, render_cell, config, etc.). Side effects: prepares assets, creates temporary fragment files, writes <code>output_html</code> atomically. Outputs: <code>{&quot;warnings&quot;, &quot;tables&quot;, &quot;rows&quot;, &quot;runtime_ms&quot;, &quot;output&quot;, &quot;html&quot;(opt)}</code>.                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical Breakdown"> <strong>Key dependencies & defensive fallbacks</strong> — Uses <code>core_io</code>, <code>core_assets</code>, <code>core_fragments</code>, <code>core_table</code>, <code>core_utils</code>. Prefers project <code>sanitize_html</code>, falls back to <code>html.escape</code>. Tries BeautifulSoup for robust HTML table extraction; falls back to regex parsing where BS4 isn't available. All external operations are wrapped in try/except and produce warnings rather than hard failures.                                                                                                                                                                                              </td></tr><tr><td data-label="Technical Breakdown"> <strong>Input normalization flow (high level)</strong> — Steps executed per input item: 1) quick DataFrame-like detection, 2) list/tuple coercion, 3) filesystem path handling (.csv/.tsv via <code>_parse_csv_file</code>), 4) inline CSV detection via <code>_detect_csv_like</code> + <code>_parse_csv_text</code>, 5) markdown pipe-table extraction (<code>_extract_pipe_tables_from_markdown</code>), 6) markdown → HTML → sanitize → HTML table extraction (<code>_extract_tables_from_html</code>), 7) fallback: retain sanitized HTML in <code>inline_html_sources</code>. The pipeline is intentionally ordered to avoid expensive operations unless earlier tests fail. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CSV detection & parsing</strong> — <code>_detect_csv_like</code> uses <code>csv.Sniffer</code> then heuristic column-count checks across sample lines. <code>_parse_csv_text</code> and <code>_parse_csv_file</code> use <code>csv.DictReader</code> and convert empty strings to <code>None</code>. File parsing samples the first 8192 bytes to sniff dialect. Heuristics avoid mistaking pipe-markdown and HTML for CSV.                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Technical Breakdown"> <strong>Markdown pipe-table extraction</strong> — <code>_extract_pipe_tables_from_markdown</code> finds header+divider patterns and subsequent rows; validates divider cells using <code>:?-{1,}:?</code> pattern; returns rows + header flag. <code>_split_cells_from_pipe_line</code> trims and removes leading/trailing empty pipe columns. Escaped pipes and complex inline usage are not specially handled — conservative detection prevents many false positives.                                                                                                                                                                           </td></tr><tr><td data-label="Technical Breakdown"> <strong>HTML table extraction strategy</strong> — Prefer BeautifulSoup (<code>_extract_tables_from_html_bs4</code>) to extract <code>&lt;table&gt;</code> rows reliably (preserves <code>&lt;br&gt;</code> as <code>\n</code> via <code>.get_text(&quot;\n&quot;, strip=True)</code>); fallback uses regex (<code>_parse_table_html_regex</code>) that extracts <code>&lt;tr&gt;</code> and <code>&lt;td&gt;/&lt;th&gt;</code> content, replaces <code>&lt;br&gt;</code>, strips tags, unescapes HTML. BS4 path is recommended for production due to robustness.                                                                                                                                                                                                  </td></tr><tr><td data-label="Technical Breakdown"> <strong>Row → DataFrame coercion</strong> — <code>_convert_rows_to_df_like</code> attempts to return a pandas DataFrame when pandas is available; otherwise returns list-of-dicts when a header is present, or raw rows. <code>_to_dataframe_if_possible</code> further tries to coerce lists/dicts to DataFrame for downstream compatibility. Padding of mismatched rows uses <code>r + [&quot;&quot;] * (len(cols) - len(r))</code>.                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical Breakdown"> <strong>Deduplication</strong> — Computes <code>_stable_hash</code> (JSON dump sort_keys=True with fallback to <code>repr</code>) for each parsed table and removes duplicates while preserving order. Non-serializable objects may yield <code>None</code> and therefore are preserved; consider canonicalizing inputs to guarantee deduplication.                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical Breakdown"> <strong>Fragments rendering pipeline</strong> — Calls <code>render_fragments_concurrently(parsed_tables, cfg, renderer, tmp_frag_dir, max_workers)</code>. On success returns <code>fragments_map</code> mapping index → fragment metadata (including file path); on failure pipeline adds a warning and falls back to inline rendering. Fragment outputs are later read and embedded into the final HTML.                                                                                                                                                                                                                             </td></tr><tr><td data-label="Technical Breakdown"> <strong>Fallback inline rendering</strong> — If fragments are missing or contain no rows the module falls back to inline rendering using <code>render_table</code> or, failing that, <code>pandas.to_html</code> or a simple <code>&lt;pre&gt;</code> placeholder. Headings from fragments are removed to avoid duplication using <code>_remove_heading_from_fragment</code> (regex-based).                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Technical Breakdown"> <strong>Asset handling & embed vs link</strong> — Uses <code>prepare_assets</code> to discover/copy assets. If <code>cfg.embed_assets</code> true, reads CSS/JS files and injects them inline; otherwise emits <code>&lt;link&gt;</code> and <code>&lt;script src=... defer&gt;</code> tags with versioning via file mtimes. Uses <code>_sri_attr</code> when <code>cdn_integrity</code> is provided. Missing asset files are handled gracefully and fall back to <code>style_fallback</code> / <code>script_fallback</code>.                                                                                                                                                                                        </td></tr><tr><td data-label="Technical Breakdown"> <strong>HTML composition & header contract</strong> — Produces a programmatic reproduction of <code>index.html</code>'s sticky header and TV2.1 contract: <code>#stickyMainHeader</code>, <code>#toc</code>, <code>#tables-viewer</code>, legacy IDs (e.g., <code>copyAllMdBtn</code>) preserved and alias delegation shim emitted to maintain backward compatibility with older scripts. CSS used in head matches provided <code>index.html</code> header area (sticky layout, paste textarea, TOC styles).                                                                                                                                                                       </td></tr><tr><td data-label="Technical Breakdown"> <strong>Caption/labels loader</strong> — <code>_load_labels_json</code> attempts to read <code>labels.json</code> from several candidate locations. <code>_caption_for</code> resolves caption keys like <code>&lt;book_prefix&gt;_01</code> or nested dict forms. Captions are used when emitting <code>&lt;div class=&quot;table-caption&quot; id=&quot;TableN&quot; data-table=&quot;...&quot;&gt;</code>. Malformed/missing labels are ignored quietly.                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical Breakdown"> <strong>TOC & caption injection behavior</strong> — Builds <code>toc_items</code> from <code>fragments_map</code> or synthesized inline entries. Emits JS to support comment-based caption injection (<code>PTT-CAPTION</code>), which walks DOM comments, finds following table and inserts <code>.table-caption</code>. Also initializes <code>PTToc</code> when available. This preserves the original caption injection semantics used by TV2.1 client code.                                                                                                                                                                                                        </td></tr><tr><td data-label="Technical Breakdown"> <strong>Client-side JS snippets</strong> — Emits small inline JS for: alias delegation, save button hooks (dispatch <code>ptt:save-request</code>), save-md event, <code>PasteToTable.routeHtmlToAreas</code>, reveal wrappers (set <code>.table-wrapper</code> opacity to <code>1</code> on load), export worker hook (posts page HTML to <code>worker.js</code>). Inline scripts are compact and defensive (try/catch). Note: CSP environments may prefer external scripts.                                                                                                                                                                                           </td></tr><tr><td data-label="Technical Breakdown"> <strong>Atomic write semantics</strong> — Writes via <code>_default_write_atomic</code> when present; otherwise writes to <code>.tmp</code> and <code>os.replace</code>. Final fallback: direct open/write; exceptions are caught and returned as warnings. Ensure <code>_default_write_atomic</code> uses fsync semantics appropriate for target FS.                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Technical Breakdown"> <strong>Diagnostics & warnings</strong> — Collects warnings and returns them in the result dict. Logs parsed table counts, sample types, parse events (e.g., "parsed CSV file ..."). Recommendation: surface asset discovery and fragment diagnostics into <code>warnings</code> to ease troubleshooting.                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling philosophy</strong> — Pervasive try/except to maximize best-effort output: pipeline prefers to continue and produce a usable HTML even under partial failures. Tradeoff: harder to detect silent issues — use <code>cfg.strict</code> (recommended extension) to fail-fast on critical errors.                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance considerations</strong> — Hotspots: markdown→HTML rendering, sanitizer, BS4 parsing, concurrent fragment rendering, reading many fragment files into memory. Memory pressure arises from building head/tail arrays and reading fragments via <code>.read()</code>. Mitigations: stream fragment reads, cap <code>max_workers</code>, add size limits for inline HTML, and throttle markdown rendering.                                                                                                                                                                                                             </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security considerations</strong> — Uses <code>sanitize_html(..., allow_tables=True)</code> when available and escapes captions and IDs. Inline scripts and dynamic HTML embedding increase XSS surface; recommend Content-Security-Policy and avoiding inline script blocks where deployment permits. Validate and escape <code>href_prefix</code> and JSON-embedded strings.                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Technical Breakdown"> <strong>Extensibility & observability</strong> — Add fields to result dict: per-fragment file sizes, per-fragment render warnings, assets_written flag, and <code>labels.json</code> path used. Add <code>cfg.debug</code> to control log level and <code>cfg.strict</code> to optionally make parse errors fatal.                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing checklist</strong> — Unit tests required: CSV sniffing (various delimiters), pipe-table parsing edge cases, HTML extraction with/without BS4, fragment pipeline success/failure, asset embed vs link behavior, atomic write fallbacks, caption injection via comments, and CSP-safe operation. Add snapshot tests comparing programmatically generated HTML to canonical <code>index.html</code>.                                                                                                                                                                                                           </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational recommendations</strong> — Prefer linked assets in production; use <code>embed_assets</code> for single-file distribution only. Add resource limits (max fragment size, max HTML embed size, max workers). Instrument render times and fragment counts for telemetry. Provide <code>strict</code> mode for CI or automated runs to detect regressions early.                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final notes</strong> — The implementation mirrors the original index.html contract (sticky header, legacy ID aliases, caption comment injection) while being defensive and production-ready. Key improvements to consider: explicit <code>cfg</code> options for resource budgets, richer fragment diagnostics exposed in <code>result</code>, and converting inline scripts to external files to satisfy stricter CSPs.                                                                                                                                                                                                       </td></tr></tbody></table></div><div class="row-count">Rows: 25</div></div><div class="table-caption" id="Table2" data-table="Docu_0116_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown —  CODE0  (revised, super-detailed)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown —  CODE0  (revised, super-detailed)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Module purpose & summary</strong> — Defensive Flask backend for PasteToTable (PTT). Responsibilities: discover/integrate project renderers and IO helpers; provide robust <code>/convert</code>, <code>/save</code>, <code>/save-md</code>, <code>/api/group/load</code>, <code>/saved/&lt;id&gt;</code>, index/SPA fallback and utility endpoints; enforce size/security limits; perform atomic writes; expose a tiny thread-local request context (<code>get_request_context</code>) for caption injection gating.                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Top-level structure</strong> — Top-level imports and fallbacks → small regex helpers → filename sanitizers → import/cache utilities → group index cache + advisory lock helpers → atomic-write helper → <code>create_app(cfg)</code> factory defining routes and hooks → expose <code>get_request_context</code> and <code>create_app</code> in <code>__all__</code> → <code>__main__</code> runner.                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Thread-local request context (caption gate)</strong> — <code>threading.local()</code> <code>_request_ctx</code>; setters: <code>_set_request_ctx(action, client_req_id, source)</code>; getter: <code>get_request_context()</code> returns <code>{&quot;action&quot;,&quot;client_req_id&quot;,&quot;source&quot;}</code>. <code>/api/group/load</code> sets the context temporarily when client requests <code>action==&quot;load_group&quot;</code>, then clears it in <code>finally:</code> to avoid leakage. <code>core_renderer</code> (or other modules) can import <code>server.get_request_context()</code> to check <code>action==&quot;load_group&quot;</code> and gate injection.                                                                                                                                                                                                        </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Renderer discovery & caching</strong> — At startup tries candidate modules (<code>html_renderer</code>, <code>render.core_renderer</code>, etc.) for <code>render_from_text</code> or <code>convert_text_to_html</code>. First callable found is cached in <code>render_from_text</code> for subsequent calls (avoids per-request imports). Fallbacks attempted later by <code>_try_import_callable</code> using <code>_import_cache</code>.                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Pluggable IO helpers</strong> — Attempts to import <code>save_html_atomic</code> and <code>read_saved</code> from <code>render.io_utils</code> / <code>io_utils</code>. If present, used by <code>/save</code> and <code>/saved/&lt;id&gt;</code> respectively; otherwise built-in fallbacks used. Presence logged.                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Sanitization helpers</strong> — <code>_strip_ref_footnotes(text)</code> removes common reference/footnote markers using three regexes. <code>_escape_leading_list_markers_in_table_cells(text)</code> finds pipe-table blocks and replaces leading <code>1.</code> or <code>-</code> list markers inside cells with HTML character references to avoid Markdown mis-parsing. Both are exception-safe and return original text on failure.                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Filename sanitation</strong> — <code>_safe_filename</code> and <code>_safe_md_filename</code> use <code>secure_filename()</code> then stricter whitelist <code>[^A-Za-z0-9._-] -&gt; _</code>, truncation to 128 chars, and ensure <code>.html</code>/<code>.md</code> extension. Prevents <code>../</code> and odd characters, enforces length.                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Dynamic import cache</strong> — <code>_import_cache: Dict[(module,attr),Callable                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | None]</code>used by<code>_try_import_callable()</code> to memoize fallback renderer lookups, preventing repeated imports during fallback attempts. </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Group index cache</strong> — <code>_group_index_cache: Dict[storage_path -&gt; (ts, map)]</code> with TTL <code>_GROUP_INDEX_TTL=30s</code>. <code>_build_group_index(storage_abspath)</code> populates <code>{group_name: [filenames...]}</code> by normalizing filenames via <code>_normalize_and_group_name_from_filename()</code>. Sorted lists returned; cache reduces <code>os.listdir</code> costs for <code>/groups_index.json</code> and <code>/api/group/load</code>.                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Advisory lock for batch writes</strong> — <code>_acquire_lock(lockfile, timeout)</code> creates an exclusive lockfile via <code>os.open(..., O_EXCL)</code>, writes PID, polled wait. <code>_release_lock</code> removes it. Used in <code>/save-md</code> to reduce concurrent collisions for batch fragment writes. Best-effort and process-local; not a distributed lock.                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Atomic write helper</strong> — <code>_atomic_write_bytes_to_path(storage_dir, dest_name, data)</code> writes to a <code>NamedTemporaryFile</code> in same dir, <code>fsync</code> best-effort, <code>os.replace(tmp, dest)</code> and <code>chmod(0o644)</code>. Returns <code>(True, None)</code> or <code>(False, error)</code>. Employed by <code>/save-md</code> and usable elsewhere.                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Markdown table extraction</strong> — <code>_split_markdown_tables(markdown)</code> scans lines, skips fenced code blocks, detects header+separator patterns (pipe tables), collects contiguous pipe lines, and returns list of table strings (each terminates with <code>\n</code>). Conservative to avoid false positives; recommended to replace with AST parser for edge cases.                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Render fallback chain</strong> — <code>_render_text_with_fallbacks(text)</code> does: preprocess → attempt cached <code>render_from_text(text, {&quot;inline_assets&quot;:False})</code> → iterate candidates list (<code>render_from_text</code> signatures first, then <code>convert_text_to_html</code>) using <code>_try_import_callable</code> → normalize return shapes <code>(html, metadata)</code> for dict/tuple/str → fallback to escaped <code>&lt;pre&gt;</code> with <code>meta={&quot;converted&quot;:False,&quot;error&quot;:&quot;render_failed&quot;}</code>. All attempts are guarded and logged.                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Content-length enforcement</strong> — <code>@app.before_request _enforce_content_length()</code> inspects <code>request.content_length</code> for <code>POST/PUT/PATCH</code> and compares to <code>MAX_PASTE_SIZE</code> from <code>app.config</code>. Returns <code>413</code> early on oversize. (Note: routes also check byte-size of body where relevant.)                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Jinja template cache control</strong> — <code>_clear_jinja_template_cache()</code> flushes <code>app.jinja_env.cache</code> when <code>?v=</code> cache-bust or <code>FLUSH_TEMPLATES_ON_RENDER</code> enabled.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Routes — overview</strong> — <code>/health</code>, <code>/manifest.json</code>, <code>/groups_index.json</code>, <code>/assets/&lt;file&gt;</code>, <code>/saved/index</code>, <code>/saved/list</code>, <code>/api/group/load</code>, <code>/convert</code> (and <code>/api/convert</code> <code>/api/render</code> aliases), <code>/save</code>, <code>/save-md</code>, <code>/saved/&lt;id&gt;</code>, <code>/list</code>/<code>/load</code> aliases, SPA fallback <code>&quot;/&quot;, &quot;/&lt;path&gt;&quot;</code>. After-request hook <code>_set_minimal_security_headers</code> sets common headers.                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong><code>/groups_index.json</code> flow</strong> — If <code>groups_index.json</code> exists at app root, parse and sanitize file lists; else call <code>_build_group_index(storage_path)</code> and return generated <code>{&quot;version&quot;:1,&quot;generated_at&quot;:...,&quot;groups&quot;:[{name,description,files,count},...]}</code> with <code>Cache-Control: max-age=10</code>. Robust try/except around parsing with fallback.                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong><code>/api/group/load</code> flow & caption gating</strong> — Input forms accepted: JSON body (<code>files</code> or <code>group</code>), form data, raw text body (JSON array, newline/comma list, or single group id), query params. Early reads of <code>X-Action</code> header / <code>action</code> query param and <code>X-Client-Req-Id</code> to set thread-local request context when <code>action==&quot;load_group&quot;</code>. Body can also include <code>action</code> / <code>client_req_id</code>. Processing: normalize <code>files</code> (coerce JSON string → list or split), sanitize filenames via <code>os.path.basename</code>, return <code>{&quot;ok&quot;:True,&quot;files&quot;:[...]}</code> if present; if <code>group</code> provided resolve via <code>groups_index.json</code> or cached <code>_build_group_index</code>. In <code>finally</code>, clears thread-local context if set to avoid leak. </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong><code>/convert</code> flow</strong> — Accepts <code>text</code>/<code>markdown</code>/<code>input</code> via JSON or form. Validates non-empty, byte-size <= <code>MAX_PASTE_SIZE</code>. Optionally flush template cache. Detects <code>from_list</code> flag. Calls <code>_render_text_with_fallbacks</code>. Post-check: if no <code>&quot;&lt;table&quot;</code> in HTML, replace output with standardized <code>&lt;div class=&quot;render-error&quot;&gt;</code> and set <code>meta[&quot;render_warning&quot;]=&quot;no_table_detected&quot;</code>. Returns <code>{&quot;ok&quot;:True,&quot;html&quot;:..., &quot;meta&quot;:...}</code>; sets no-cache headers if <code>from_list</code>.                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong><code>/save</code> flow</strong> — Accepts <code>html</code> and optional <code>filename</code>. Validates non-empty HTML. Ensures storage dir exists. Uses pluggable <code>save_html_atomic</code> if available; else fallback write via <code>mkstemp</code> + write + <code>fsync</code> best-effort + <code>os.replace</code>. Ensures <code>chmod(0o644)</code>. Returns saved <code>path</code> and <code>id</code>.                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong><code>/save-md</code> flow</strong> — Accepts markdown via JSON/body/file upload. Validates non-empty and byte-size limit. Derives safe base name via <code>_safe_md_filename</code> and strip trailing <code>_NNN</code> from base. Splits into <code>tables</code> via <code>_split_markdown_tables</code>. Uses <code>_acquire_lock</code> on <code>.ptt_save_md.lock</code> (best-effort) to reduce race collisions. Writes single or multiple fragments using <code>_atomic_write_bytes_to_path</code> with <code>_ensure_unique</code> (UUID suffix on collision). On fragment write failure cleans created files. Returns <code>201</code> with <code>{&quot;id&quot;: uuid, &quot;filenames&quot;: [...], &quot;size&quot;: bytes}</code>.                                                                                                                              </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong><code>/saved/&lt;file_id&gt;</code> flow</strong> — Delegates to <code>read_saved</code> helper (if callable) for path resolution, otherwise <code>os.path.join(storage, file_id)</code>. Performs strict containment check using <code>os.path.commonpath([storage_abs, path_abs])</code> to prevent traversal. If path exists returns <code>send_from_directory(directory, filename, as_attachment=True)</code>. Otherwise 404.                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>SPA index fallback</strong> — Priority: <code>render_template(&quot;index.html&quot;)</code> → static <code>assets/index.html</code> via <code>send_from_directory</code> or file read → <code>html_renderer.get_index_html(asset_hash=ASSET_VERSION)</code> if available → embedded <code>_INDEX_HTML_FALLBACK</code>. Uses <code>render_template_string</code> for returned HTML. All attempts logged.                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Security headers</strong> — <code>_set_minimal_security_headers</code> after-request sets <code>X-Content-Type-Options</code>, <code>X-Frame-Options</code>, <code>Referrer-Policy</code>, <code>Permissions-Policy: interest-cohort=()</code>. Defensive try/except to avoid breaking responses.                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Logging policy</strong> — Extensive <code>logger.info</code> for startup/feature flags; <code>logger.debug</code> for recoverable fallbacks and import failures; <code>logger.exception</code> used where unexpected errors occur (stack trace captured). Recommendation: adjust levels in production to avoid noise.                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Concurrency & process model caveats</strong> — <code>_group_index_cache</code> and <code>_import_cache</code> are in-process; multi-worker (gunicorn) deployments will have separate caches per worker. Advisory lock is file-based and only coordinates processes on same host; not suitable for distributed clusters without external locking. <code>os.replace</code> atomicity depends on filesystem semantics (NFS caveat).                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Integration invariants (caption injection)</strong> — <code>core_renderer.inject_captions()</code> must check <code>server.get_request_context().get(&quot;action&quot;) == &quot;load_group&quot;</code> before injecting captions. The server sets and then clears <code>request_ctx</code> during <code>/api/group/load</code> so downstream renderers should read the context synchronously during the same request processing. If your core renderer expects a different mechanism, adapt it to call <code>server.get_request_context()</code> or accept an <code>options</code> dict from server calls.                                                                                                                                                                                                  </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Error/reporting behavior</strong> — Routes return consistent JSON error shapes (<code>{&quot;ok&quot;:False,&quot;error&quot;:&quot;...&quot;,&quot;details&quot;:...}</code>) and appropriate HTTP codes: <code>400</code> for invalid payloads, <code>413</code> for too-large, <code>500</code> for server errors, <code>201</code> for created. <code>groups_index.json</code> returns <code>Cache-Control</code> header.                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Testing checklist (high priority)</strong> — Unit tests for: filename sanitizers; <code>_strip_ref_footnotes</code> and list-marker escaping; <code>_split_markdown_tables</code> edge cases; <code>_render_text_with_fallbacks</code> with renderer present/absent and various return shapes; <code>_atomic_write_bytes_to_path</code> on local FS; <code>/api/group/load</code> variants (JSON/form/raw/GET) including <code>action</code> header; <code>/save-md</code> concurrency and cleanup on partial failure; <code>saved/&lt;id&gt;</code> containment checks; SPA fallback ordering. Integration: end-to-end Load Group flow verifying <code>&lt;script data-caption-payload&gt;</code> emission and no injection for manual paste.                                                                                          </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Operational recommendations</strong> — 1) Set <code>ASSET_VERSION</code> in production. 2) For multi-host deployments consider external group index cache (Redis) and distributed locking. 3) Run the caption-injection verification (see testing checklist). 4) Tune logging levels to reduce <code>exception</code> noise. 5) Consider using a Markdown AST parser for robust table extraction.                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Known limitations</strong> — 1) Heuristic Markdown splitter can mis-handle exotic markdown; 2) Advisory lock and atomic replace have FS/host limitations; 3) In-process caches are not shared across workers; 4) Excessive <code>logger.exception</code> may require tuning.                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Technical Breakdown —  CODE0  (revised, super-detailed)"> <strong>Summary judgment</strong> — The revised <code>server.py</code> is robust, conservative, preserves legacy routes and behaviors, and adds a safe thread-local caption gating mechanism. Given the verification steps above (especially the caption-injection test and FS atomicity checks on your target environment), the file will integrate with your existing <code>core_renderer</code> and <code>html_renderer</code> without breaking the project.                                                                                                                                                                                                                                                                                                   </td></tr></tbody></table></div><div class="row-count">Rows: 32</div></div><div class="table-caption" id="Table3" data-table="Docu_0116_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by html_renderer.py — Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">html_renderer.py — Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="html_renderer.py — Technical Breakdown"> <strong>Module purpose & overview</strong> — Lightweight, defensive Flask adapter + text-to-HTML rendering helper for PasteToTable-style projects. Responsibilities: discover and adapt a project-provided text→HTML renderer, optionally post-process HTML with a core caption injector, provide a conservative internal fallback renderer, expose batch <code>render_html</code> for simple table exports (string or file), compute an asset fingerprint, and create a Flask app with endpoints for rendering, saving, assets, manifest and health. Designed to be importable in non-Flask environments (Flask guarded).                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="html_renderer.py — Technical Breakdown"> <strong>Public contract</strong> — Exports <code>create_app(cfg) -&gt; Flask</code>, <code>render_from_text(text, options) -&gt; {&quot;html&quot;: str, &quot;metadata&quot;: dict}</code>, <code>render_html(tables, output_path=None, ...) -&gt; str                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | Path</code>, <code>write_atomic(path, data)</code>, and <code>_compute_asset_hash(static_folder)</code>. <code>create_app</code>accepts optional cfg keys (STATIC_FOLDER/TEMPLATE_FOLDER/SAVE_DIR).<code>render_from_text</code>normalizes many possible renderer signatures and return shapes.<code>render_html</code> returns string or writes atomically and returns path. </td></tr><tr><td data-label="html_renderer.py — Technical Breakdown"> <strong>Renderer discovery strategy (robust & layered)</strong> — Attempts to import known module/name pairs (<code>render.convert.convert_text_to_html</code>, <code>convert.convert_text_to_html</code>, <code>render.core_renderer.render_from_text</code>, etc.). If import fails, attempts file-load fallbacks from neighboring paths (<code>./render/convert.py</code>, <code>./convert.py</code>, parent dirs) via <code>SourceFileLoader</code>. If still absent, falls back to <code>_fallback_convert_text_to_html</code>. This layered approach preserves project behaviour while remaining import-safe.                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="html_renderer.py — Technical Breakdown"> <strong>Core caption injector discovery</strong> — Tries to import <code>render.core_renderer</code> module and then looks for multiple likely function names (<code>inject_captions_into_html</code>, <code>inject_captions</code>, <code>postprocess_html</code>, <code>apply_captions</code>, <code>inject_ptt_captions</code>). Also attempts file-load fallback next to module. If found, the injector is called (best-effort) after rendering; adapter tolerates both <code>(html, meta)</code> and <code>(html,)</code> signatures and accepts string/dict results. Failures are logged and ignored (non-fatal).                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="html_renderer.py — Technical Breakdown"> <strong>Fallback renderer behavior</strong> — <code>_fallback_convert_text_to_html</code> is minimal and conservative: returns <code>{&quot;html&quot;:&quot;&lt;pre&gt;escaped input&lt;/pre&gt;&quot;, &quot;metadata&quot;:{&quot;converted&quot;:False}}</code>, normalizes newlines and HTML-escapes content. This guarantees usable output even when project code is missing or raises.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="html_renderer.py — Technical Breakdown"> <strong>Adapter normalization (render_from_text)</strong> — Primary flow: call project renderer with <code>(text, options)</code> or <code>(text,)</code> signature; normalize return shapes (dict, tuple, string). If project renderer raises, revert to fallback. After obtaining HTML, attempt to run core caption injector (two signature attempts). Combine/merge metadata sensibly (injector may return dict containing <code>html</code> and <code>meta</code>). All steps wrapped in try/except; top-level exceptions produce safe <code>&lt;pre&gt;</code> fallback with error metadata.                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="html_renderer.py — Technical Breakdown"> <strong>Batch HTML renderer (render_html)</strong> — Renders an iterable of table-like objects into a compact HTML fragment: supports custom <code>inline_formatter</code>, pandas-like objects (via <code>.to_html(index=False, border=0, escape=True)</code>), row sequences (list of lists/tuples → <code>&lt;table&gt;</code>), or fallback to <code>&lt;pre&gt;</code>. Emits each table inside <code>&lt;section class=&quot;ptt-table-block&quot;&gt;</code> and <code>&lt;div class=&quot;table-wrapper&quot; data-table-index=&quot;N&quot;&gt;</code>. Writes to <code>output_path</code> atomically by default (tmp + <code>fsync</code> best-effort + <code>os.replace</code>). Robust against mixed/heterogeneous inputs and individual entry failures. Returns output string or written path.                                                                                                                                                                                                                            </td></tr><tr><td data-label="html_renderer.py — Technical Breakdown"> <strong>Atomic write helper</strong> — <code>write_atomic(path, data)</code> writes to <code>path + &quot;.tmp&quot;</code>, attempts <code>flush</code> + <code>os.fsync</code>, then <code>os.replace</code>. <code>render_html</code> uses this helper when <code>atomic_write=True</code>. Errors are logged and cause fallback to returning the string.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="html_renderer.py — Technical Breakdown"> <strong>Asset hash computation</strong> — <code>_compute_asset_hash(static_folder)</code> returns <code>ASSET_HASH</code> env var if set; otherwise walks <code>static_folder</code> (defaults to <code>assets</code>) collecting file <code>st_mtime</code> values (limited traverse, rglob, size cap) to compute a short SHA1-derived fingerprint. Falls back to epoch seconds if no files found or an error occurs. Deterministic for a given tree of mtimes; cheap and robust but not cryptographically strong.                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="html_renderer.py — Technical Breakdown"> <strong>Flask app factory & endpoints</strong> — <code>create_app(cfg)</code> configures <code>static_folder</code>, <code>template_folder</code>, computes <code>asset_hash</code> once. Exposes: <code>/</code> → render <code>index.html</code> template (falls back to <code>send_from_directory</code> or simple error Response); <code>/manifest.json</code> → serve manifest from assets or root; <code>/api/render</code> → POST accepts JSON/form with <code>text</code>/<code>markdown</code>/<code>input</code> and optional <code>options</code>, returns <code>{&quot;ok&quot;: True, &quot;html&quot;: ..., &quot;meta&quot;: ...}</code> using <code>render_from_text</code>; <code>/save</code> → POST to atomically save submitted HTML under configured <code>SAVE_DIR</code> (sanitizes filename, enforces directory confinement); <code>/api/health</code> → simple OK; <code>/assets/&lt;path&gt;</code> → static file proxy to static_folder. <code>after_request</code> sets defensive headers (<code>nosniff</code>, <code>DENY</code>, <code>referrer-policy</code>). All endpoints are wrapped with try/except and return JSON errors on exceptions. </td></tr><tr><td data-label="html_renderer.py — Technical Breakdown"> <strong>Security & path-safety</strong> — Filename sanitization uses regex to replace non <code>[A-Za-z0-9._-]</code> characters and truncates to 128 chars. Save path is constrained to live within <code>SAVE_DIR</code> (checks via <code>os.path.abspath</code> and prefix match). <code>send_from_directory</code> used for static/manifest serving. Top-level response headers set to reduce attack surface. HTML returned by renderers is treated as provided — module does not attempt further sanitization before returning <code>html</code> from <code>render_from_text</code>; consume with CSP or sanitize upstream if needed.                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="html_renderer.py — Technical Breakdown"> <strong>Logging & observability</strong> — Module-level logger <code>html_renderer</code> added with StreamHandler if not already present. Informational logs when project renderer or injector are discovered; debug logs for import failures, file-load attempts, and renderer/injector exceptions. <code>create_app</code> logs summary config including <code>render_from_text_available</code>, <code>core_caption_injector</code>, and <code>ASSET_HASH</code>. Endpoint errors are logged with stack traces.                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="html_renderer.py — Technical Breakdown"> <strong>Error handling philosophy</strong> — Pervasive try/except to maximize best-effort output and to avoid breaking host applications. Failures in optional steps (discovery, caption injection, writing, template rendering) are logged and gracefully degraded rather than raising. This mirrors user requirement to avoid breaking the project but can mask silent failures — consider <code>cfg.strict</code> extension to enable fail-fast.                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="html_renderer.py — Technical Breakdown"> <strong>Compatibility & import safety</strong> — Designed to be importable in environments without Flask: Flask symbols are conditionally imported and <code>create_app</code> raises if Flask is absent. File-load fallbacks use <code>SourceFileLoader</code> and tolerate missing dependencies. <code>render_html</code> and <code>render_from_text</code> do not require Flask, allowing programmatic reuse in scripts/CI.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="html_renderer.py — Technical Breakdown"> <strong>Extensibility & integration points</strong> — Clear hooks: <code>_render_from_text_callable</code> discovery (add new candidate locations), <code>_core_caption_injector</code> names list (add to support other injectors), <code>inline_formatter</code> for <code>render_html</code>, <code>cfg</code> keys for <code>create_app</code>. <code>write_atomic</code> and <code>_compute_asset_hash</code> exported for reuse. Module can be extended to accept <code>cfg.strict</code>, <code>cfg.debug</code>, or replace the asset hash strategy.                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="html_renderer.py — Technical Breakdown"> <strong>Performance considerations</strong> — Hotspots: file system traversal in <code>_compute_asset_hash</code> for large asset trees; <code>render_html</code> materializes each table into memory and writes entire combined string (could stream for very large outputs); file-load module imports execute arbitrary project code (cost at import time). Mitigations: traversal limits, use <code>inline_formatter</code> to stream large fragments, and optional <code>max_files</code> cap for hash.                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="html_renderer.py — Technical Breakdown"> <strong>Testing checklist & recommended unit tests</strong> — Discovery: import known module shapes and file-load fallbacks; Injector: detection of multiple function names and signature permutations; Adapter: project renderer returns dict/tuple/string or raises — verify normalized output and metadata merging; Fallback: correct escaping and newline normalization; <code>render_html</code>: pandas-like <code>.to_html</code>, row sequences, <code>inline_formatter</code>, atomic file writing and tmp replace behaviour; <code>/api/render</code> and <code>/save</code> endpoints (filename sanitization, path confinement); <code>_compute_asset_hash</code> deterministic for sample asset trees and fallback behaviour; error flows where template missing, static asset absent, and injector fails.                                                                                                                          </td></tr><tr><td data-label="html_renderer.py — Technical Breakdown"> <strong>Operational recommendations</strong> — Prefer explicit <code>cfg</code> includes for <code>SAVE_DIR</code>, <code>STATIC_FOLDER</code>, and <code>TEMPLATE_FOLDER</code>. Add <code>cfg.strict</code> for CI to surface errors. Consider adding optional sanitization step (or config flag) to sanitize renderer output before returning from <code>/api/render</code>. Replace inline scripts in templates and avoid returning untrusted HTML to clients without CSP. Add health metrics (uptime, last asset_hash compute time) and telemetry for renderer/injector failures.                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="html_renderer.py — Technical Breakdown"> <strong>Limitations & caveats</strong> — The module intentionally defers heavy parsing/sanitization to project renderer. Caption injection is best-effort and may not support all injector return shapes. Asset hash based on mtimes is not content-hash — changes that preserve mtimes (rare) won't be observed. File-load via <code>SourceFileLoader</code> can execute arbitrary code from neighboring files — use in trusted environments only.                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="html_renderer.py — Technical Breakdown"> <strong>Final notes</strong> — <code>html_renderer.py</code> is a pragmatic, defensive adapter that preserves existing project contracts while providing a safe fallback. It focuses on robustness (import resilience, atomic writes, defensive endpoint code) and ease of integration. For production hardening: add stricter validation of renderer outputs, optional sanitizer, configurable strictness, streaming for large renders, and an option to disable file-load fallbacks.                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr></tbody></table></div><div class="row-count">Rows: 20</div></div><div class="table-caption" id="Table4" data-table="Docu_0116_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Summary**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Summary</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Details**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Details</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Summary"> <strong>Critical issue: Caption mismatch</strong>                    </td><td data-label="Details"> <code>convert.py</code> emits <code>&lt;!--CAPTION_KEY:...--&gt;</code> while <code>core_renderer.py</code> only detects <code>PTT-CAPTION:</code> or <code>caption:</code> forms. Result: captions fail to inject. Must unify comment format. </td></tr><tr><td data-label="Summary"> <strong>Critical issue: Fallback sanitization breaks tables</strong> </td><td data-label="Details"> Fallback <code>sanitize_html</code> escapes <code>&lt;table&gt;</code> even when <code>allow_tables=True</code>. Result: <code>_extract_tables_from_html</code> sees no tables. Must preserve table tags.                           </td></tr><tr><td data-label="Summary"> <strong>Critical issue: XSS surface</strong>                         </td><td data-label="Details"> <code>convert.render_table</code> inserts cell HTML without full sanitization. Depending on markdown renderer, unsafe HTML may pass through. A final sanitizer or allow-list is required.    </td></tr><tr><td data-label="Summary"> <strong>Relpath Windows break</strong>                               </td><td data-label="Details"> <code>os.path.relpath</code> fails cross-drive; caught but should be guarded or normalized.                                                                                                  </td></tr><tr><td data-label="Summary"> <strong>Duplicate caption IDs</strong>                               </td><td data-label="Details"> Multiple caption emitters create collisions. Need unique IDs or consistent removal logic.                                                                                         </td></tr><tr><td data-label="Summary"> <strong>Heading removal brittle</strong>                             </td><td data-label="Details"> Regex-based removal can fail on complex HTML. Prefer DOM parsing if possible.                                                                                                     </td></tr><tr><td data-label="Summary"> <strong>CSV detection inconsistent</strong>                          </td><td data-label="Details"> <code>core_renderer</code> and <code>convert</code> use different heuristics for CSV vs pipe tables. Can produce different results for same input.                                                      </td></tr><tr><td data-label="Summary"> <strong>Inline-code stash edge cases</strong>                        </td><td data-label="Details"> Exotic backtick patterns may break stash/restore. Low likelihood but known limitation.                                                                                            </td></tr><tr><td data-label="Summary"> <strong>Two independent pipe-table parsers</strong>                  </td><td data-label="Details"> <code>core_renderer</code> and <code>convert</code> duplicate parsing logic with drift. Consolidation required to avoid future divergence.                                                              </td></tr><tr><td data-label="Summary"> <strong>Silent exception swallowing</strong>                         </td><td data-label="Details"> Broad <code>except Exception</code> hides upstream logic errors. Should show debug logs or raise under a strict mode.                                                                        </td></tr><tr><td data-label="Summary"> <strong>Large fragments loaded fully</strong>                        </td><td data-label="Details"> <code>core_renderer</code> reads entire fragment files into memory. Should stream via <code>copyfileobj</code> for big inputs.                                                                          </td></tr><tr><td data-label="Summary"> <strong>Atomic write inconsistency</strong>                          </td><td data-label="Details"> Multiple atomic writers behave differently. Ensure consistent fsync guarantees.                                                                                                   </td></tr><tr><td data-label="Summary"> <strong>JS caption injection fragile</strong>                        </td><td data-label="Details"> Relies on comment markers; breaks under HTML minifiers or preprocessing. Server-side caption injection is more reliable.                                                          </td></tr><tr><td data-label="Summary"> <strong>Compatibility: Caption format</strong>                       </td><td data-label="Details"> Must resolve <code>CAPTION_KEY</code> vs <code>PTT-CAPTION</code> to reliably inject labels from <code>script.list.js</code>.                                                                                      </td></tr><tr><td data-label="Summary"> <strong>Compatibility: Parser drift</strong>                         </td><td data-label="Details"> Inconsistent CSV and pipe-table logic across modules produces unpredictable rendering. Consolidate into one canonical parser.                                                     </td></tr><tr><td data-label="Summary"> <strong>Compatibility: Sanitization boundary</strong>                </td><td data-label="Details"> <code>convert</code> expects safe HTML; <code>core_renderer</code> sanitizes conditionally. Must enforce one boundary for safety.                                                                       </td></tr><tr><td data-label="Summary"> <strong>Fix priority 1</strong>                                      </td><td data-label="Details"> Unify caption comment format. Without this, client-side captions will not appear.                                                                                                 </td></tr><tr><td data-label="Summary"> <strong>Fix priority 2</strong>                                      </td><td data-label="Details"> Fix sanitize fallback for <code>allow_tables</code>. Needed so extraction works when sanitizer module missing.                                                                               </td></tr><tr><td data-label="Summary"> <strong>Fix priority 3</strong>                                      </td><td data-label="Details"> Ensure cell HTML is sanitized before final output.                                                                                                                                </td></tr><tr><td data-label="Summary"> <strong>Fix priority 4</strong>                                      </td><td data-label="Details"> Consolidate parsing logic so Markdown → table pipeline is deterministic.                                                                                                          </td></tr><tr><td data-label="Summary"> <strong>Recommended remediation</strong>                             </td><td data-label="Details"> Align caption markers, patch fallback sanitizer, enforce final HTML sanitization, consolidate parsers, improve heading removal, implement streaming for fragment writes.          </td></tr><tr><td data-label="Summary"> <strong>Optional improvements</strong>                               </td><td data-label="Details"> Add tests for captions, pipe tables, CSV, and XSS cases. Improve logging over swallowing exceptions.                                                                              </td></tr><tr><td data-label="Summary"> <strong>Available next steps</strong>                                </td><td data-label="Details"> A patch bundle, revised <code>convert.py</code>, revised <code>core_renderer.py</code>, or unified caption injector — whichever you choose.                                                             </td></tr></tbody></table></div><div class="row-count">Rows: 23</div></div><div class="table-caption" id="Table5" data-table="Docu_0116_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Enhancement"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Enhancement</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Enhancement"> <strong>Goal:</strong> Fix critical compatibility and safety issues between <code>convert.py</code> and <code>core_renderer.py</code> so captions inject reliably, table extraction works when the project sanitizer is absent, and XSS/CSV-parsing risks are reduced while preserving existing client behavior and fragment/asset layout.                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Enhancement"> <strong>Files Reviewed / Revised:</strong> <code>convert.py</code> (user part 1), <code>render/core_renderer.py</code> (user part 2). Recommended follow-ups: <code>core_fragments.py</code>, <code>core_utils.py</code>, and project <code>sanitize.py</code> if present.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Enhancement"> <strong>Key Findings (critical, must-fix first):</strong><br>1) Caption format mismatch: <code>convert.render_table</code> emits <code>&lt;!--CAPTION_KEY:...--&gt;</code> but client code historically expected <code>PTT-CAPTION:</code> or <code>caption:</code>.<br>2) Fallback <code>sanitize_html</code> in <code>core_renderer.py</code> previously escaped all tags (including <code>&lt;table&gt;</code>) when no sanitizer available.<br>3) <code>convert.render_table</code> may produce unsanitized cell HTML depending on markdown renderer → XSS risk.<br>4) CSV/pipe-table heuristics differ across the two modules → inconsistent parsing.<br>5) <code>os.path.relpath</code> cross-drive fallback acknowledged; guard preserved.<br>6) Heading-removal regex is brittle for complex fragments.<br>7) Fragments are read fully into memory; large files should use streaming. </td></tr><tr><td data-label="Enhancement"> <strong>Actions applied in revised <code>core_renderer.py</code>:</strong><br>1) Added safer fallback <code>sanitize_html(allow_tables=True)</code> that preserves table tags and strips scripts/inline handlers.<br>2) Expanded caption detection to accept <code>PTT-CAPTION:</code>, <code>CAPTION_KEY:</code>, and <code>caption:</code>.<br>3) Caption injection keeps wrapper/ID semantics intact and sets <code>dataset.pttTableIndex</code>.<br>4) Regex-based HTML fallback retained; BeautifulSoup preferred when available.<br>5) Locked file semantics and asset pipeline unchanged.<br>6) CSV heuristics preserved with added logging/guards.<br>7) Atomic write behavior retained.                                                                                                                                                 </td></tr><tr><td data-label="Enhancement"> <strong>Recommended changes to <code>convert.py</code>:</strong><br>1) Emit canonical <code>&lt;!-- PTT-CAPTION: &lt;key&gt;[:&lt;caption&gt;] --&gt;</code> or emit both <code>PTT-CAPTION</code> and <code>CAPTION_KEY</code> for compatibility.<br>2) Sanitize cell HTML before inserting into <code>&lt;td&gt;</code> — use project <code>sanitize_html(..., allow_tables=False)</code> or fallback to <code>html.escape</code>.<br>3) Ensure no sanitizer upstream escapes <code>&lt;table&gt;</code> so extraction continues to work.<br>4) Export parsing functions and use them consistently to avoid drift.                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Enhancement"> <strong>Unchanged Behavior:</strong> HTML structure, asset ordering, client JS APIs, caption wrapper behavior, and table ID conventions remain unchanged.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Enhancement"> <strong>User Requirements / Assumptions (preserved):</strong><br>1) Keep locked layout and scripts.<br>2) Maintain backward compatibility with legacy <code>CAPTION_KEY</code> markers.<br>3) Preserve atomic writes and existing save/export behavior.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Enhancement"> <strong>Remaining Risks & Notes:</strong><br>1) Fallback sanitizer is heuristic — proper sanitizer recommended.<br>2) Regex heading removal remains brittle.<br>3) XSS remains possible without canonical allow-list sanitization.<br>4) Parser consolidation is still needed.<br>5) Windows cross-drive fallback retained but may still mismatch if assets moved.                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Enhancement"> <strong>Concrete Verification Steps:</strong><br>1) Unit: Verify <code>convert.render_table</code> emits canonical caption markers.<br>2) Integration: Run <code>render_html</code> with markdown, HTML tables, and CSV inputs; confirm parsed table counts.<br>3) Fallback sanitization: Remove <code>sanitize.py</code> and ensure <code>&lt;table&gt;</code> remains functional.<br>4) XSS check: Confirm <code>&lt;script&gt;</code> inside cells is stripped.<br>5) Caption injection: Test all caption formats and ensure visible <code>.table-caption</code> output.<br>6) Large fragment test: Validate memory behavior.                                                                                                                                                                                                                             </td></tr><tr><td data-label="Enhancement"> <strong>Future Upgrade Options:</strong><br>1) Consolidate table parsers into a single module.<br>2) Replace fallback sanitizer with a vetted allow-list sanitizer.<br>3) Use DOM parsing for heading removal and caption insertion.<br>4) Add explicit tests for caption formats and CSV heuristics.<br>5) Provide optional debug HTML return.                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Enhancement"> <strong>Integration with Client:</strong> Caption detection expanded; other client behaviors unchanged (<code>routeHtmlToAreas</code>, save hooks, TOC).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Enhancement"> <strong>Integration with Project Utils / Assets:</strong> Asset preparation and atomic writes preserved. Ensure <code>labels.json</code> discovery path remains consistent.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Enhancement"> <strong>Security / Stability:</strong> Improved by stripping scripts and unsafe attributes when fallback sanitizer used. Proper sanitizer still recommended.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Enhancement"> <strong>Audit / Logging:</strong> Existing logs preserved; recommend warnings when fallback sanitizer used or legacy caption form detected.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Enhancement"> <strong>Cross-check Validation:</strong> Session shows <code>convert.py</code> emits <code>CAPTION_KEY</code>; updated <code>core_renderer.py</code> now accepts both <code>CAPTION_KEY</code> and <code>PTT-CAPTION</code> and preserves <code>&lt;table&gt;</code> during sanitization.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Enhancement"> <strong>Performance:</strong> Minimal regression; sanitizer regex overhead small. Fragment streaming still recommended for large files.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Enhancement"> <strong>Maintenance Recommendations:</strong><br>1) Add tests for caption formats, sanitizer behavior, and parsing edge-cases.<br>2) Consolidate parsing code.<br>3) Deprecate <code>CAPTION_KEY</code> after transition period.<br>4) Document canonical <code>PTT-CAPTION</code> format.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Enhancement"> <strong>Verification Environment:</strong> Python 3.9+; optional BeautifulSoup; cross-OS path behavior validated.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Enhancement"> <strong>Final Assessment:</strong> Revised <code>core_renderer.py</code> resolves caption mismatch and sanitizer table-escaping issues. Apply remaining <code>convert.py</code> edits to fully close compatibility and XSS gaps.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Enhancement"> <strong>Memory State:</strong> Session context retained for next edit pass.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr></tbody></table></div><div class="row-count">Rows: 20</div></div><div class="table-caption" id="Table6" data-table="Docu_0116_06" style="margin-top:2mm;margin-left:3mm;"><strong>Table 6</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Section**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Section</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Section"> <strong>Summary / Purpose</strong>                               </td><td data-label="Technical Breakdown"> Utilities to parse Markdown pipe-tables and CSV, normalize into simple table structures, and render those tables as safe HTML widgets. Provides: <code>parse_markdown_tables</code>, <code>parse_csv_tables</code>, <code>extract_tables_debug</code>, rendering (<code>render_table</code>), and convenience converters (<code>convert_structure</code>, <code>convert_text_to_html</code>). Designed to be robust against code spans, multi-backtick inline code, CSV delimiter ambiguity, and absent project sanitizer.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Section"> <strong>Primary Functions / API</strong>                         </td><td data-label="Technical Breakdown"> - <code>parse_markdown_tables(text) -&gt; List[Dict]</code> — find pipe-style markdown tables and return rows/header flags.<br>- <code>parse_csv_tables(text, delimiter=None, assume_header=None) -&gt; List[Dict]</code> — attempt CSV parsing with sniffing and deterministic fallback.<br>- <code>render_table(df, idx=1, markdown_to_html_func=None, ..., label_key=None, ...) -&gt; str</code> — render a tabular HTML block (full wrapper, header, tools, data rows).<br>- <code>extract_tables_debug(text) -&gt; (pipe_tables, html_tables)</code> — higher-level extractor with CSV fallback; returns <code>_SimpleDF</code> or pandas DataFrame instances when available.<br>- <code>convert_structure(text, options) -&gt; (html, metadata)</code> — convert first detected markdown table to HTML widget and metadata.<br>- <code>convert_text_to_html(text, options) -&gt; Dict</code> — convert all detected markdown tables into HTML pieces and metadata.                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Section"> <strong>Key helpers</strong>                                     </td><td data-label="Technical Breakdown"> - <code>_stash_code_spans</code>, <code>_restore_code_spans</code> — stash multi-backtick inline code with placeholder markers to prevent splitting on <code>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | </code>inside code spans.<br>-<code>_split_row_keep_code(row)</code>— split a pipe-table row into cells while preserving code spans and escaped<code>|</code>sequences. <br>-<code>_take_and_stream</code>, <code>_peek_rows_non_destructive</code>— peek/consume iterators safely.<br>-<code>_detect_column_types(sample_rows, cols)</code> — heuristically detect numeric vs text for alignment.                                                                                                                         </td></tr><tr><td data-label="Section"> <strong>Regex constants & notable patterns</strong>              </td><td data-label="Technical Breakdown"> - <code>_INLINE_CODE_STASH_RE = re.compile(r&#x27;(</code>+)([\s\S]*?)(?<!<code>)\1&#x27;)</code> — captures backtick-delimited code spans robustly.<br>- <code>_DIVIDER_PART_RE = re.compile(r&#x27;^:?-{1,}\:?\s*$&#x27;)</code> — divider part pattern for Markdown alignment detection (<code>---</code>, <code>:---:</code>, etc.).<br>- <code>_PRE_RE</code>, <code>_CODE_RE</code> match <code>&lt;pre</code> and <code>&lt;code</code> to avoid changing code blocks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Section"> <strong>Sanitization strategy</strong>                           </td><td data-label="Technical Breakdown"> - Tries to import project sanitizer <code>utils.sanitize_html</code>. If available, uses it (<code>_project_sanitize</code>).<br>- Fallback <code>_fallback_sanitize_html(x, allow_tables=False)</code> implemented to: remove <code>&lt;script&gt;</code> tags and content, neutralize <code>javascript:</code> href/src, and remove <code>on*</code> event attributes. When <code>allow_tables=True</code> it preserves table-* tags by replacing them with placeholders and restoring safe tag structure; attributes are escaped. <br>- Public wrapper <code>sanitize_html_local(x, allow_tables=False)</code> delegates to project sanitizer or fallback and logs a one-time warning when using fallback.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Section"> <strong>Markdown rendering</strong>                              </td><td data-label="Technical Breakdown"> - <code>_get_default_markdown_renderer()</code> tries to import a project shim <code>markdown.get_markdown_renderer</code>. If missing uses <code>_simple_md</code> fallback with limited inline support: emphasis, strong, inline code replacement via temporary tokens; returns <code>&lt;p&gt;...&lt;/p&gt;</code> blocks for paragraphs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Section"> <strong>CSV detection & parsing approach</strong>                </td><td data-label="Technical Breakdown"> - <code>_looks_like_csv(lines)</code> heuristic: ignores short inputs, deprioritizes pipe-heavy input, checks consistency of delimiter counts for <code>,</code>, <code>;</code>, <code>\t</code> with proportion threshold > 0.6.<br>- <code>parse_csv_tables</code> uses <code>csv.Sniffer().sniff()</code> on a sample; on failure counts delimiter occurrences across lines and picks the highest-count delimiter. Reads via <code>csv.reader</code> with detected delimiter; final fallback is naive <code>split(detected_delim)</code> per line. Header detection uses <code>sniffer.has_header(sample)</code> with numeric heuristics fallback. Normalizes row lengths by padding with <code>&quot;&quot;</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Section"> <strong>Markdown pipe-table parsing details</strong>             </td><td data-label="Technical Breakdown"> - <code>parse_markdown_tables</code> scans lines for a <code>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | </code>-containing header line followed by a divider line matching <code>_DIVIDER_PART_RE</code>to identify a table. Captures header cells then subsequent<code>                                                                                                                                                                                                                                                                                                                    | </code>lines as body until blank or non-pipe line encountered. Normalizes rows to equal column length, returns<code>{&quot;rows&quot;: rows, &quot;header&quot;: True, &quot;source&quot;: &quot;pipe_markdown&quot;}</code> for each table. </td></tr><tr><td data-label="Section"> <strong><code>extract_tables_debug</code> behavior</strong>                 </td><td data-label="Technical Breakdown"> - Aggressive extraction: identifies candidate pipe-table blocks using lookahead for divider lines, or fallback contiguous <code>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | </code>lines. Produces<code>_SimpleDF</code>or pandas DataFrame objects when pandas is available. If no pipe tables found, performs CSV autodetect using<code>_looks_like_csv</code>and<code>parse_csv_tables</code>, then normalizes and returns table objects (pandas DataFrame if available else <code>_SimpleDF</code>). Also normalizes typographic quotes and dashes to ASCII.                                                                                                                            </td></tr><tr><td data-label="Section"> <strong>Data frame shim: <code>_SimpleDF</code> & <code>_SimpleColumns</code></strong> </td><td data-label="Technical Breakdown"> - Lightweight substitute when pandas unavailable. Stores rows as lists, columns via <code>_SimpleColumns</code>. Implements <code>itertuples</code>, <code>__iter__</code>, and minimal behavior needed by <code>render_table</code>. <code>__all__</code> exports <code>_SimpleDF</code> and <code>_SimpleColumns</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Section"> <strong><code>render_table</code> responsibilities</strong>                 </td><td data-label="Technical Breakdown"> - Produces an HTML widget with external caption (<code>.table-caption</code>), optional comment markers for caption key(s), a wrapper <code>&lt;div class=&quot;table-wrapper&quot; data-table-id=&quot;table-idx&quot;...&gt;</code>, a header bar with tool buttons (copy/export), toggle collapse button, and a <code>&lt;table class=&quot;tv-table&quot;&gt;</code> with <code>&lt;thead&gt;</code>/<code>&lt;tbody&gt;</code>. Emits <code>data-table-alignments</code> and <code>data-label-key</code> attributes.<br>- Determines columns by inspecting <code>df.columns</code> or peeking the first row; supports iterables of dicts, tuples, lists, or other objects. <br>- Samples rows to detect numeric/text column types and assign alignments. <br>- Renders each cell through provided <code>markdown_to_html_func</code> (or default), converts single-line newlines to Markdown softbreaks for multi-line content, applies various post-processing steps, then sanitizes each cell via <code>sanitize_html_local(cell_html, allow_tables=False)</code> before inserting into <code>&lt;td&gt;</code>. <br>- If <code>label_key</code> is provided: emits multiple markers for compatibility — <code>&lt;!-- PTT-CAPTION: key[:CaptionText] --&gt;</code>, <code>&lt;!-- CAPTION_KEY:key --&gt;</code>, and <code>&lt;!-- caption:CaptionText --&gt;</code>. </td></tr><tr><td data-label="Section"> <strong>Caption emission & compatibility</strong>                </td><td data-label="Technical Breakdown"> - New behavior intentionally emits canonical <code>PTT-CAPTION</code> plus legacy <code>CAPTION_KEY</code> and a simple <code>caption:</code> comment to maximize backward compatibility with client injector logic. Caption text may be included after colon in <code>PTT-CAPTION</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Section"> <strong>Final cell sanitization policy</strong>                  </td><td data-label="Technical Breakdown"> - Cells are sanitized with <code>sanitize_html_local(..., allow_tables=False)</code> — disallows table tags inside cells. If sanitizer fails, falls back to <code>html.escape</code>. This prevents nested table markup and reduces XSS risk while allowing inline HTML (subject to sanitizer implementation).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Section"> <strong>Error handling & logging</strong>                        </td><td data-label="Technical Breakdown"> - Defensive programming: many <code>try/except</code> blocks around parsing, markdown rendering, sanitizer, and dataframe operations. Exceptions are logged with <code>logger.exception</code> where appropriate (e.g., row rendering, CSV autodetection). <code>sanitize_html_local</code> logs a warning the first time the fallback sanitizer is used.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Section"> <strong>Pandas integration</strong>                              </td><td data-label="Technical Breakdown"> - When pandas is importable in runtime, <code>extract_tables_debug</code> and CSV fallback will try to produce <code>pd.DataFrame</code> objects (and attach <code>_table_alignments</code> attribute if computed). <code>render_table</code> checks for <code>df.itertuples</code> and <code>df.columns</code>. Code handles both pandas and <code>_SimpleDF</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Section"> <strong>Exports & public API</strong>                            </td><td data-label="Technical Breakdown"> - <code>__all__</code> includes: <code>&quot;parse_markdown_tables&quot;,&quot;parse_csv_tables&quot;,&quot;render_table&quot;,&quot;extract_tables_debug&quot;,&quot;_SimpleDF&quot;,&quot;_SimpleColumns&quot;,&quot;convert_structure&quot;,&quot;convert_text_to_html&quot;</code>. This signals intended public usage and import targets for <code>core_renderer.py</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Section"> <strong>Compatibility & interoperability notes</strong>          </td><td data-label="Technical Breakdown"> - <code>render_table</code> produces metadata attributes (<code>data-table-id</code>, <code>data-table-index</code>, <code>data-table-alignments</code>, <code>data-label-key</code>) to be consumed by client-side script or server-side caption injector. <br>- Multiple comment markers emitted to satisfy older consumers expecting <code>CAPTION_KEY</code> while steering clients to <code>PTT-CAPTION</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Section"> <strong>Performance characteristics</strong>                     </td><td data-label="Technical Breakdown"> - Most heavy operations are regex, CSV reading, or markdown rendering. <br>- CSV sniffing uses a sample of up to 40 non-empty lines. <br>- <code>extract_tables_debug</code> may create normalized lists and DataFrames; memory use grows with input size. <br>- <code>_take_and_stream</code> tries to avoid consuming entire iterators but some code paths cast iterables to <code>list</code> when size/structure unknown.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Section"> <strong>Security considerations</strong>                         </td><td data-label="Technical Breakdown"> - Sanitization is delegated to project sanitizer if present; fallback sanitizer strips scripts, javascript: URLs, and inline event handlers. <br>- Final per-cell sanitization reduces XSS surface. <br>- Attributes captured in fallback sanitizer when <code>allow_tables=True</code> are escaped (safe but non-functional); consider whitelisting specific attributes if functionality required.<br>- Markdown renderer fallbacks escape or limit tags to reduce HTML injection risk.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Section"> <strong>Edge cases & known brittle areas</strong>                </td><td data-label="Technical Breakdown"> - Regex-based splitting by <code>&lt;pre&gt;</code>/<code>&lt;code&gt;</code> can be fooled by malformed HTML; consider using an HTML parser when available.<br>- <code>_INLINE_CODE_STASH_RE</code> aims to be robust but nested or malformed backtick runs are tricky — unit tests recommended for long or complex code spans.<br>- <code>csv.Sniffer</code> may mis-detect delimiter on small or inconsistent samples — code provides a deterministic frequency fallback.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Section"> <strong>Testing recommendations</strong>                         </td><td data-label="Technical Breakdown"> - Unit tests: multi-backtick inline code containing <code>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | </code>, escaped <code>|</code>, and nested code spans; pipe-table with leading/trailing pipes; mixed-width rows. <br>- CSV tests: quoted fields with commas; semicolon and tab delimiters; header detection edge cases. <br>- Sanitizer tests: cells with <code>&lt;script&gt;</code>, <code>onload=</code>, and <code>javascript:</code>URLs should be stripped/neutralized. <br>- Integration tests:<code>extract_tables_debug</code>with no pandas vs with pandas;<code>convert_text_to_html</code>returns expected<code>label_key</code> markers. </td></tr><tr><td data-label="Section"> <strong>Integration suggestions</strong>                         </td><td data-label="Technical Breakdown"> - Import <code>parse_markdown_tables</code> / <code>parse_csv_tables</code> from <code>convert.py</code> into <code>core_renderer.py</code> (single source of truth) to avoid parser drift.<br>- Ensure project sanitizer (<code>utils.sanitize_html</code>) is present for best fidelity; otherwise fallback will warn. <br>- Client scripts should detect <code>PTT-CAPTION</code>, <code>CAPTION_KEY</code>, and <code>caption:</code> forms (server now emits all three).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Section"> <strong>Maintenance recommendations</strong>                     </td><td data-label="Technical Breakdown"> - Consolidate parsing logic into a shared module (already <code>convert.py</code>) and import from renderer to prevent divergence.<br>- Replace regex segmentation for HTML with BeautifulSoup when available for robustness.<br>- Consider an allow-list for attributes on preserved <code>&lt;table&gt;</code>-family tags to enable safe attribute usage (id/class/colspan).<br>- Add unit tests for all heuristics and sanitizer fallback behavior.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Section"> <strong>Limitations</strong>                                     </td><td data-label="Technical Breakdown"> - Fallback sanitizer is conservative and escapes attributes, which may break downstream code that relies on <code>id</code>/<code>class</code> attributes unless project sanitizer restores these safely.<br>- Large fragments are read into memory in several places; streaming improvements are recommended for very large inputs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Section"> <strong>Operational guidance</strong>                            </td><td data-label="Technical Breakdown"> - In production install/enable a vetted sanitizer (project <code>sanitize_html</code> or <code>bleach</code>).<br>- Prefer a consistent markdown renderer via <code>options[&quot;markdown_to_html_func&quot;]</code> to avoid inconsistent cell HTML output.<br>- Run the conversion after all content generation to ensure table markup is stable.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Section"> <strong>Backward compatibility</strong>                          </td><td data-label="Technical Breakdown"> - <code>render_table</code> emits legacy and canonical caption comment markers to maintain compatibility with older client code expecting <code>CAPTION_KEY</code> while using <code>PTT-CAPTION</code> as canonical.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Section"> <strong>Failure modes & logging</strong>                         </td><td data-label="Technical Breakdown"> - Parsing failures are logged and cause fallbacks: CSV fallback, naive splitting, or returning original text. <br>- <code>render_table</code> logs exceptions for row rendering; rows that fail to render are skipped (loop continues).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Section"> <strong>Examples of expected outputs</strong>                    </td><td data-label="Technical Breakdown"> - <code>render_table</code> produces HTML containing:<br>  • <code>&lt;div class=&quot;table-caption&quot; id=&quot;Table1&quot; ...&gt;&lt;strong&gt;Table 1&lt;/strong&gt;&lt;/div&gt;</code><br>  • <code>&lt;!-- PTT-CAPTION: key:Table 1 --&gt;</code>, <code>&lt;!-- CAPTION_KEY:key --&gt;</code>, <code>&lt;!-- caption:Table 1 --&gt;</code> markers when <code>label_key</code> supplied.<br>  • <code>&lt;div class=&quot;table-wrapper&quot; data-table-id=&quot;table-1&quot; data-table-index=&quot;1&quot; data-table-alignments=&quot;left,right&quot;&gt;</code> and <code>&lt;table class=&quot;tv-table&quot;&gt;</code> with sanitized <code>&lt;td&gt;</code> contents.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Section"> <strong>Checklist for reviewers</strong>                         </td><td data-label="Technical Breakdown"> 1. Verify <code>sanitize_html_local</code> delegates to project sanitizer when present and falls back safely.<br>2. Ensure <code>render_table</code> always sanitizes cells before injecting into <code>&lt;td&gt;</code> (<code>allow_tables=False</code>).<br>3. Confirm <code>PTT-CAPTION</code> and <code>CAPTION_KEY</code> markers are emitted when <code>label_key</code> provided.<br>4. Validate CSV detection on representative inputs (commas, semicolons, tabs, pipes).<br>5. Run integration tests with/without pandas installed.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Section"> <strong>Next-step action items (if applying changes)</strong>    </td><td data-label="Technical Breakdown"> - Keep <code>convert.py</code> as canonical parser module and import into <code>core_renderer.py</code> to avoid drift.<br>- Optionally implement attribute whitelisting for table tags in fallback sanitizer if attribute functionality is required.<br>- Add unit tests for code-span stash/restore and caption marker emission.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Section"> <strong>Final assessment</strong>                                </td><td data-label="Technical Breakdown"> <code>convert.py</code> is a robust, defensive utility suited for server-side conversion of Markdown and CSV to sanitized HTML table widgets. It prioritizes safety via per-cell sanitization and preserves compatibility via multiple caption comment markers. The main operational improvements are: consolidate parsers, install a proper sanitizer for production, and add unit tests targeting code-span and CSV edge cases.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr></tbody></table></div><div class="row-count">Rows: 31</div></div><div class="table-caption" id="Table7" data-table="Docu_0116_07" style="margin-top:2mm;margin-left:3mm;"><strong>Table 7</strong></div>
<div class="table-wrapper" data-table-id="table-7"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Topic**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Topic</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Detailed Explanation**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Detailed Explanation</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Topic"> <strong>File purpose</strong>                               </td><td data-label="Detailed Explanation"> <code>convert.py</code> is the conversion and parsing core for PasteToTable. It detects and parses pipe-style Markdown tables and CSV inputs, preserves inline and fenced code spans, normalizes table row shapes, provides a lightweight DataFrame shim (<code>_SimpleDF</code> / <code>_SimpleColumns</code>), infers column alignment and types, and exposes rendering helpers (<code>render_table</code>, <code>convert_structure</code>, <code>convert_text_to_html</code>) used by higher-level renderers. It also contains new caption utilities (<code>caption_for</code>, <code>caption_html_for</code>) to centralize caption injection.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Topic"> <strong>Primary responsibilities</strong>                   </td><td data-label="Detailed Explanation"> - Parse Markdown pipe-tables robustly. <br>- Heuristically detect and parse CSV text. <br>- Stash/restore inline code spans to avoid splitting on pipes. <br>- Provide <code>render_table</code> to emit the project's HTML table fragment markup. <br>- Offer debug extraction (<code>extract_tables_debug</code>) that returns pd-like objects or <code>_SimpleDF</code>. <br>- Provide conversion entrypoints (<code>convert_structure</code>, <code>convert_text_to_html</code>). <br>- Supply caption lookup and HTML generation functions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Topic"> <strong>Top-level public API</strong>                       </td><td data-label="Detailed Explanation"> <code>parse_markdown_tables</code>, <code>parse_csv_tables</code>, <code>render_table</code>, <code>extract_tables_debug</code>, <code>_SimpleDF</code>, <code>_SimpleColumns</code>, <code>convert_structure</code>, <code>convert_text_to_html</code>, <code>_load_labels_json_search_paths</code>, <code>caption_for</code>, <code>caption_html_for</code>. These are designed to be imported by <code>core_renderer</code> and other modules.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Topic"> <strong>Accepted inputs & integration points</strong>       </td><td data-label="Detailed Explanation"> - Strings containing Markdown, CSV, or HTML. <br>- File paths are <em>not</em> handled here (core_renderer handles files). <br>- <code>pandas.DataFrame</code> or objects with <code>.columns</code> and <code>.itertuples</code> are accepted by <code>render_table</code>. <br>- <code>markdown_to_html</code> callable may be passed to <code>render_table</code> / conversion functions to render cell content.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Topic"> <strong>CSV detection & parsing strategy</strong>           </td><td data-label="Detailed Explanation"> - <code>_looks_like_csv</code> and <code>parse_csv_tables</code> use sampling, csv.Sniffer when available, and deterministic fallbacks. <br>- <code>parse_csv_tables</code> returns normalized rows and a <code>header</code> flag. <br>- For robust fallback, counts of delimiters (<code>,</code>, <code>;</code>, <code>\t</code>, <code>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | </code>) and proportion statistics drive detection.                                                                                                                  </td></tr><tr><td data-label="Topic"> <strong>Pipe-table parsing strategy</strong>                </td><td data-label="Detailed Explanation"> - <code>parse_markdown_tables</code> and <code>_split_row_keep_code</code> split rows on unescaped pipes while preserving stashed inline code. <br>- Divider detection uses <code>_DIVIDER_PART_RE</code> (<code>:?-{1,}:?</code>) per cell to identify the header/divider row. <br>- Normalizes cells to equal column counts.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Topic"> <strong>Code-span stash/restore</strong>                    </td><td data-label="Detailed Explanation"> - <code>_stash_code_spans</code> replaces inline-backtick runs with NUL-delimited placeholders (<code>\x00CODE{n}\x00</code>) and returns mapping. <br>- <code>_restore_code_spans</code> can restore original backtick content or convert to <code>&lt;code&gt;</code> when <code>to_html=True</code>. <br>- This prevents pipes inside inline code from breaking parsing.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Topic"> <strong>Cell splitting rules</strong>                       </td><td data-label="Detailed Explanation"> - <code>_split_row_keep_code</code> stashes code spans then splits on unescaped <code>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | </code>. <br>- Leading/trailing empty cells resulting from leading/trailing pipes are trimmed. <br>- Escaped pipes <code>|</code> are supported (converted back after restore). </td></tr><tr><td data-label="Topic"> <strong>Markdown rendering fallback</strong>                </td><td data-label="Detailed Explanation"> - <code>_get_default_markdown_renderer</code> prefers a local <code>markdown.get_markdown_renderer()</code>; else provides a simple safe replacer that handles inline code, bold, italics and wraps paragraphs. <br>- In <code>render_table</code>, the <code>markdown_to_html_func</code> argument overrides the default. Failures fall back to <code>html.escape</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Topic"> <strong>Render_table responsibilities</strong>              </td><td data-label="Detailed Explanation"> - Take a df-like or iterable and produce the project's HTML fragment (caption, wrapper, header toolbar, <code>&lt;table&gt;</code>, row count, etc.). <br>- Detect columns from pandas-like objects or infer from the first row. <br>- Sample up to 5 rows to detect numeric columns via <code>_detect_column_types</code>. <br>- Build header HTML via the markdown callable; sanitize/normalize whitespace. <br>- Render each cell through the markdown callable, apply sanitation helpers (<code>sanitize_bold_html</code>, <code>_apply_left_col_heading</code>, <code>_escape_unmatched_markers</code>), and emit <code>&lt;td&gt;</code> with <code>data-label</code> and alignment classes.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Topic"> <strong>Alignment & column-type inference</strong>          </td><td data-label="Detailed Explanation"> - <code>_detect_column_types</code> marks columns as <code>numeric</code> or <code>text</code> based on sampled values (handles commas, percent signs, parentheses). <br>- Alignments default to <code>right</code> for numeric, <code>left</code> otherwise. Alignments are emitted as <code>data-table-alignments</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Topic"> <strong>_SimpleDF shim</strong>                             </td><td data-label="Detailed Explanation"> - <code>_SimpleDF</code> and <code>_SimpleColumns</code> provide a minimal DataFrame-like interface used where pandas isn't present. <br>- Methods: <code>itertuples</code>, <code>columns</code> object with <code>tolist()</code>. This maintains compatibility with <code>render_table</code> logic.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Topic"> <strong>Deduplication & stable-hashing</strong>             </td><td data-label="Detailed Explanation"> - <code>render_html</code> (in core_renderer) dedups parsed tables using <code>_stable_hash</code>, which JSON-serializes stable keys with <code>sort_keys=True</code>. <code>convert.py</code> exposes <code>_stable_hash</code> used by other modules.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Topic"> <strong>extract_tables_debug behavior</strong>              </td><td data-label="Detailed Explanation"> - Scans for pipe-table candidates and returns <code>_SimpleDF</code> or pandas DataFrames when available. <br>- If no pipe-tables are found, runs the CSV autodetect fallback and returns parsed CSVs as DataFrame-like objects. <br>- Preserves alignment metadata on DataFrame objects via <code>_table_alignments</code> attribute when possible.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Topic"> <strong>Caption utilities (moved here)</strong>             </td><td data-label="Detailed Explanation"> - <code>_load_labels_json_search_paths(out_dir)</code> searches well-known locations for <code>labels.json</code> (project root, parents, out_dir, cwd) and returns parsed labels. <br>- <code>caption_for(book_prefix, idx, labels=None)</code> looks up captions with keys like <code>{book}_{idx:02d}</code>, <code>{book_prefix}</code> sub-dictionaries, and <code>book-{idx:02d}</code> variants. <br>- <code>caption_html_for(book_prefix, idx, title_id, title_text, labels=None)</code> returns the caption HTML block used by <code>core_renderer</code> and fallback inline rendering. This centralizes caption logic.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Topic"> <strong>Sanitization & fallbacks</strong>                   </td><td data-label="Detailed Explanation"> - The module attempts to use project-level utilities if importable: <code>sanitize_bold_html</code>, <code>_apply_left_col_heading</code>, <code>_escape_unmatched_markers</code>. <br>- If unavailable, safe fallbacks are defined. <br>- Final cell rendering falls back to <code>html.escape</code> if markdown or sanitizers throw.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Topic"> <strong>Error handling & robustness</strong>                </td><td data-label="Detailed Explanation"> - Defensive try/except widely used; failures in parsing, detection, conversion, or markdown rendering will log and degrade gracefully to escaped or minimal HTML. <br>- Multiple fallback layers for CSV detection, markdown renderers, and DataFrame conversion reduce single points of failure.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Topic"> <strong>Inter-module contract</strong>                      </td><td data-label="Detailed Explanation"> - <code>render_table</code> returns a string fragment expected by <code>core_renderer.writer()</code> or the fragment writer pipeline. <br>- <code>extract_tables_debug</code> returns DataFrame-like objects or <code>_SimpleDF</code> for further pipeline processing. <br>- <code>caption_html_for</code> is now consumed by <code>core_renderer</code> to inject captions consistently.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Topic"> <strong>Normalization & padding</strong>                    </td><td data-label="Detailed Explanation"> - When rows differ in length, functions pad with empty strings to produce rectangular tables (see both markdown and CSV parsing paths). This prevents jagged output.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Topic"> <strong>Performance considerations</strong>                 </td><td data-label="Detailed Explanation"> - Sampling is bounded (CSV sample 40 lines / parse_csv_tables sample up to 8192 chars). <br>- <code>render_table</code> samples up to 5 rows to infer types. <br>- String construction uses <code>parts.append()</code> + <code>&#x27;&#x27;.join(parts)</code> pattern for efficiency.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Topic"> <strong>Security posture</strong>                           </td><td data-label="Detailed Explanation"> - Default behavior is escaping; sanitize helpers are used if present and may be called with <code>allow_tables</code> where supported. <br>- Code-span stash reduces attack surface by moving raw code out of parsing flow. <br>- <code>_stable_hash</code> uses <code>json.dumps(..., sort_keys=True)</code> for deterministic hashing when possible.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Topic"> <strong>Testing & verification matrix</strong>              </td><td data-label="Detailed Explanation"> Unit/integration tests to cover: <code>parse_markdown_tables</code> (edge pipes, escaped pipes, inline code), <code>_stash/_restore</code> roundtrip, <code>parse_csv_tables</code> with various delimiters and encodings, <code>_detect_column_types</code> correctness, <code>_SimpleDF</code> behavior, <code>render_table</code> output structure, <code>caption_for</code> lookup variants, and <code>extract_tables_debug</code> CSV fallback.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Topic"> <strong>Verification checklist (10 focused passes)</strong> </td><td data-label="Detailed Explanation"> 1) <strong>Code-stash roundtrip:</strong> ensure <code>_stash_code_spans</code> → <code>_restore_code_spans</code> returns original for inline backticks and multi-backtick runs. <br>2) <strong>Pipe-splitting:</strong> verify <code>_split_row_keep_code</code> handles <code>\|</code> escapes and does not split inside stashed code. <br>3) <strong>Divider detection:</strong> confirm <code>_DIVIDER_PART_RE</code> correctly identifies Markdown divider lines including <code>:---:</code>, <code>---</code>, <code>:---</code>. <br>4) <strong>CSV sniff fallback:</strong> test <code>parse_csv_tables</code> when <code>csv.Sniffer</code> fails (various delimiter distributions). <br>5) <strong>Header inference:</strong> validate <code>parse_csv_tables</code> header heuristics when <code>sniffer.has_header</code> is unavailable. <br>6) <strong>Render_table integration:</strong> render representative DataFrame, list-of-dicts, list-of-lists and confirm table markup, alignment, and <code>data-table-*</code> attributes. <br>7) <strong>Caption lookup:</strong> place <code>labels.json</code> in each search path and confirm <code>caption_for</code> and <code>caption_html_for</code> return expected results. <br>8) <strong>Sanitizer fallback:</strong> remove <code>utils</code> imports and ensure safe fallback functions are used without exceptions. <br>9) <strong>Edge cases:</strong> very short inputs, empty strings, and non-iterable inputs do not crash. <br>10) <strong>Performance:</strong> run with moderately large tables (thousands rows) and ensure sampling and memory behavior is acceptable. </td></tr><tr><td data-label="Topic"> <strong>Acceptance criteria</strong>                        </td><td data-label="Detailed Explanation"> - <code>convert.py</code> produces well-formed, sanitized HTML fragments for a variety of inputs. <br>- Caption lookup/injection is deterministic and centralised (works from <code>core_renderer</code>). <br>- No exceptions bubble up for typical malformed inputs; project-level fallbacks handle missing dependencies. <br>- New caption helpers are importable by <code>core_renderer</code> and produce identical HTML as prior inline logic.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Topic"> <strong>Risks & mitigations</strong>                        </td><td data-label="Detailed Explanation"> - <strong>Risk:</strong> caption lookup path differences across environments may return <code>None</code>. <strong>Mitigation:</strong> <code>caption_for</code> falls back to <code>title_text</code> when no label found and <code>core_renderer</code> also has fallback logic. <br>- <strong>Risk:</strong> <code>json.dumps</code> in <code>_stable_hash</code> may fail for non-serializable objects. <strong>Mitigation:</strong> second fallback uses <code>repr(obj)</code> hashing. <br>- <strong>Risk:</strong> external markdown/sanitizer behaves unsafely. <strong>Mitigation:</strong> default is <code>html.escape</code> and sanitizers are optional; recommend enabling strict mode in production.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Topic"> <strong>Actionable next steps</strong>                      </td><td data-label="Detailed Explanation"> 1) Add unit tests for the 10 verification passes above. <br>2) Run integration test of <code>core_renderer</code> importing <code>caption_html_for</code> and writing full output. <br>3) Validate the labels search paths on CI and local dev machines. <br>4) Optionally add a configurable <code>labels_search_paths</code> override to <code>caption_for</code> to make paths explicit and deterministic. <br>5) Add a small migration note in the README documenting the caption move and the <code>caption_html_for</code> API.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr></tbody></table></div><div class="row-count">Rows: 26</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>