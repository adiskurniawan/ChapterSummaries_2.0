<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1764452144">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0139_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by Technical Breakdown" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>File-level summary (expanded)</strong><br/><br/>This module manages a persistent, interactive “Saved groups / file list” modal for PasteToTable. It builds grouped rows of saved files, presents search results, supports progressive scoring via an <code>engine</code> abstraction, fetches file contents with timeout-safe logic, loads files sequentially into the paste area, and triggers conversion. It is defensive, written to survive partial environments (missing DOM nodes, missing fetch features) and exposes lifecycle hooks (modal <code>close</code> override, <code>presentGroupsOnly</code>) so host pages may integrate. Focus is reliability and UX polish (toasts, focus management, retries) rather than raw performance.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Primary responsibilities</strong><br/><br/>• Resolve live files from configured endpoints and labels.<br/>• Build and present a modal with grouped file rows and per-file click handlers.<br/>• Provide search with async scoring, highlight and fallback search.<br/>• Fetch file text with abort + timeout and robust error handling.<br/>• Load selected files sequentially into the paste textarea or page area and invoke renderer hooks.<br/>• Apply runtime captions to headings after injection and retry until DOM stabilizes.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Key exported/attached functions &amp; handles</strong><br/><br/>• <code>presentGroupsOnly(groups, descriptions)</code> — builds modal with given groups and immediately presents it. Designed to accept pre-built normalized groups.<br/>• <code>buildAndPresent()</code> — fetches live files, labels and descriptions, converts to groups and calls <code>presentGroupsOnly</code>.<br/>• <code>attachListHandler()</code> — finds the configured list button and attaches click handler that calls <code>buildAndPresent()</code>.<br/>• <code>fetchFileWithTimeout(url, timeoutMs)</code> — fetch wrapper with optional AbortController and timeout promise handling.<br/>• <code>loadFilesSequentialAndHideForm(listOfFiles)</code> — fetches files sequentially, constructs the combined raw/marked payloads, writes them into the paste area and triggers conversion.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Control flow overview</strong><br/><br/>1. <code>attachListHandler()</code> attaches a click listener to the element with id <code>LIST_BTN_ID</code>.<br/>2. User clicks, <code>buildAndPresent()</code> runs: fetches live files, descriptions, and labels via <code>fetchLiveFilesSequential</code>, <code>loadGroupDescriptions</code>, <code>loadLabels</code> and then normalizes into <code>groups</code>.<br/>3. <code>presentGroupsOnly</code> creates a modal, lays out groups into <code>groupControls</code> and wires search handlers.<br/>4. Search uses <code>engine.candidatesForQuery()</code> then <code>engine.scoreFiles()</code> returning promises. If scoring fails a local simple fallback (haystack <code>indexOf</code>) runs.<br/>5. Clicking a file row calls <code>loadFilesSequentialAndHideForm(single)</code> which uses <code>fetchFileWithTimeout</code> for each file and appends results to the paste textarea, then invokes converter hooks.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Data structures: groups and groupControls</strong><br/><br/>• <code>groupMap</code> — array of group descriptors <code>{ title, id, files: [...] }</code> normalized for rendering.<br/>• <code>groupControls</code> — runtime UI control objects created by <code>createGroupRowForRender(index, files, q)</code> that contain <code>rowWrap</code>, <code>fileList</code>, <code>toggleBtn</code>, <code>visible</code>, <code>expanded</code>, and <code>rowWrap</code> DOM nodes; used to maintain state and to drive UI updates efficiently instead of re-building everything on each search update.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Modal UI construction details</strong><br/><br/><code>presentGroupsOnly</code> constructs a container with header (search input, expand/collapse button, close button), and a scrollable <code>resultsWrap</code> holding <code>rowWrap</code> entries per group. Each group row contains heading, toggle control, and <code>fileList</code> which is a flex container of file rows. Accessibility: <code>aria-expanded</code>, <code>aria-pressed</code>, <code>aria-label</code> used on toggle/expand controls when possible. Focus management: <code>search.focus()</code> called after modal creation to maximize keyboard usability.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Search flow and versioning pattern</strong><br/><br/>Search is debounced and versioned. <code>searchVersion</code> increments on each search invocation. When asynchronous scoring resolves it compares <code>thisVersion</code> against the current <code>searchVersion</code> so stale promises bail out. This prevents race conditions where slow scoring results override more recent queries. Debounce default is 120ms but configurable via <code>debounce()</code> wrapper usage in the host shared utilities.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Scoring and fallback search</strong><br/><br/>Preferred path: call <code>engine.candidatesForQuery(q)</code> to get candidate indices then <code>engine.scoreFiles(q, cand)</code> returning a promise with <code>{ idx, score }[]</code>. Fallback path: perform a naive substring match across <code>engine.lite</code> entries combining <code>name</code>, <code>caption</code>, <code>path</code>, <code>full</code>. This keeps the UI usable even if search worker fails. The code restricts rendering to top N (800) results to keep UI responsive.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>File fetch semantics &amp; timeout handling</strong><br/><br/><code>fetchFileWithTimeout(url, timeoutMs)</code> uses <code>AbortController</code> when available and a <code>setTimeout</code> to abort after <code>timeoutMs</code> (configurable via <code>FILE_FETCH_TIMEOUT_MS</code>). It sets fetch options <code>{ cache: 'no-store', credentials: 'same-origin' }</code> to avoid caching surprises. Errors propagate as rejected promises with <code>Error('HTTP ' + status)</code> for non-ok responses. All branches clear the timer. If <code>AbortController</code> is missing, the function still works but without abort.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Safety &amp; sanitization responsibilities</strong><br/><br/>Sanitization is conservative: <code>sanitizeCaptionForInjection</code> removes HTML comments and <code>&lt;script&gt;</code> tags, strips all tags, and then uses <code>escapeHtml</code> before placing caption into HTML comment or markdown. This prevents accidental script injection in the caption fields. The module avoids inserting raw fetched file contents into the DOM without passing through existing conversion hooks (the conversion step is required to generate HTML from markdown safely).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>User feedback &amp; toast integration</strong><br/><br/>UI status updates use <code>updateStatus</code> and <code>showToast</code> (when available) to notify success/failure: examples 'Fetching X file(s)...', 'Loaded N file(s) into paste area.', and 'Caption application timed out'. The code attempts to call <code>window.showToast</code> if present in the host page. Toasts are non-blocking.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Performance guards</strong><br/><br/>• Limits top results to 800 to avoid DOM bloat. <br/>• Introduces small delays (40–120ms) between sequential fetch operations to avoid saturating network/CPU. <br/>• Uses <code>resultsWrap.innerHTML = ''</code> and per-group <code>fileList.innerHTML = ''</code> to clear and reuse nodes rather than rebuilding entire modal. <br/>• <code>presentGroupsOnly</code> caches <code>groupControls</code> to avoid re-allocating DOM nodes repeatedly while still re-rendering file lists on search.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Error handling and debugging</strong><br/><br/>Most catch blocks call <code>dbg('message', e)</code> where <code>dbg</code> is a host-level debug function if present (non-fatal). Critical errors update status text and sometimes call <code>console.warn</code>. The code never throws to the caller for UI-level failures; instead it falls back or shows user-facing messages. This keeps the host page resilient.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Accessibility considerations</strong><br/><br/>• Uses <code>aria-expanded</code> and <code>aria-pressed</code> on expand/collapse controls. <br/>• Sets focus to search input on modal open. <br/>• Uses <code>role="link"</code> on generated anchor-like elements inside TOC and file rows for assistive tech. <br/>• Adds <code>aria-hidden</code> for hidden textarea fallback. <br/>Improvements: add keyboard-only navigation between file rows and better <code>aria-live</code> announcements for search result counts.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Integration points for host apps</strong><br/><br/>Host can override/extend behavior by providing these globals or functions:<br/>• <code>engine</code> object with <code>candidatesForQuery</code>, <code>scoreFiles</code> (promise), <code>lite</code> array for fallback. <br/>• <code>fetchLiveFilesSequential</code>, <code>loadGroupDescriptions</code>, <code>loadLabels</code> — the buildAndPresent calls them and expects <code>{ ok, data }</code> shapes. <br/>• <code>window.__tv_do_convert</code> or <code>window.convert</code> — conversion hooks called after paste injection. <br/>• <code>window.showToast</code> and <code>dbg</code> for messaging and debugging. <br/>• Modal creation helper <code>createModal(container, title)</code> returning handle with <code>close</code> method.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Edge cases handled</strong><br/><br/>• Missing <code>AbortController</code> gracefully falls back to non-abortible fetch. <br/>• Slow or failing scoring resolves to fallback substring search. <br/>• Missing paste area writes to <code>#page-area</code> instead. <br/>• Duplicate default captions de-duplicated in <code>runtimeCaptions</code>. <br/>• Large number of files truncated by <code>MAX_LIST_ITEMS</code> or <code>MAX_LIST_ITEMS</code> used upstream.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Potential failure modes &amp; mitigations</strong><br/><br/>• If <code>engine.scoreFiles</code> never resolves UI remains waiting; mitigation: versioning prevents stale updates, but consider adding a scoring timeout fallback. <br/>• Fetch aborts could leave partially loaded content in <code>accMarked</code> — but sequential loading uses note comments (<code>&lt;!-- failed to fetch: ... --&gt;</code>) to surface failures to user. <br/>• If conversion hooks are missing the code will still place content into hidden textarea and set <code>window.__ptt_hidden_convert</code> so manual conversion or host scripts can pick it up.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Testing checklist</strong><br/><br/>1. Click flow: attachListHandler -&gt; buildAndPresent -&gt; modal shows and search input focused. <br/>2. Search cancellation: issue 3 rapid queries. Ensure only latest result rendered. <br/>3. Fetch timeout: simulate slow server and verify abort occurs and error comment appended. <br/>4. Sequential load: pick 3 files and verify <code>paste</code> receives combined text and <code>window.__tv_last_source</code> set. <br/>5. Caption application: ensure runtime captions are applied to <code>h1/h2</code> or <code>.table-caption</code> nodes and that retry mechanism halts on success.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Observability &amp; metrics to add</strong><br/><br/>• <code>modal.open.count</code> and <code>modal.open.duration.ms</code> <br/>• <code>search.query.latency.ms</code> (time from input -&gt; final render) <br/>• <code>fetchFile.duration.ms</code> per URL and <code>fetchFile.aborts</code> count <br/>• <code>loadFilesSequential.items</code> and <code>loadFilesSequential.failures</code> <br/>Collect these for performance regression detection.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Refactor opportunities</strong><br/><br/>• Extract search rendering into smaller pure functions for easier unit testing. <br/>• Replace <code>innerHTML</code> mass DOM operations with <code>DocumentFragment</code> builds to reduce layout thrash for huge groups. <br/>• Add a scoring timeout wrapper so <code>engine.scoreFiles</code> failure mode is always bounded. <br/>• Centralize DOM utilities (<code>createRow</code>, <code>createFileRow</code>) to reduce repeated style-setting code.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Security considerations</strong><br/><br/>• Never trust fetched text. The module writes raw fetched text only into textarea or hidden element and relies on downstream conversion to produce DOM HTML. Host must ensure conversion sanitizes HTML before insertion into <code>tables-viewer</code> via <code>__tv_do_convert</code> hook. <br/>• Captions are sanitized before injection. <br/>• Avoid storing sensitive content in attributes; use hidden script areas or server-side storage for large or sensitive payloads.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Backward compatibility notes</strong><br/><br/>• Designed to tolerate missing features: <code>AbortController</code>, <code>window.convert</code>, <code>engine</code>. <br/>• Adds non-invasive <code>dataset</code> flags on elements to avoid re-binding handlers (<code>__ptt_list_attached</code>, <code>__tv_convert_attached</code>, etc.). <br/>• Modal <code>close</code> override ensures engine <code>dispose</code> will be called if present which prevents leaked workers or event listeners.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Actionable hardening changes before prod</strong><br/><br/>1. Add bounded timeout to <code>engine.scoreFiles</code> calls. <br/>2. Use <code>DocumentFragment</code> when appending many <code>ctrl.rowWrap</code> elements. <br/>3. Implement keyboard navigation and announce result counts in <code>aria-live</code>. <br/>4. Improve fetch retry/backoff policy for flaky endpoints.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Short-term roadmap (next 2 weeks)</strong><br/><br/>• Add unit tests for <code>fetchFileWithTimeout</code> using fake timers. <br/>• Introduce scoring timeout wrapper. <br/>• Convert append-heavy DOM writes to fragment-based batching. <br/>• Add telemetry hooks and counters.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Caption application logic</strong><br/><br/><code>applyRuntimeCaptions</code> finds <code>.table-caption</code> or header nodes and pairs them to <code>runtimeCaptions</code>. Matching logic uses an id scheme <code>TableN</code> fallback and tries to detect headings like <code>Table 1</code>. It uses repeated <code>setTimeout</code> ticks (intervalMs default 160, maxRetries default 120) to wait for consumer renderers to add heading nodes. When a caption is applied it sets node innerHTML to <code>&lt;strong&gt;${escaped}&lt;/strong&gt;</code> and sets id for heading nodes if missing. This approach tolerates slow third-party renderers that work asynchronously.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Sequential load logic (robustness)</strong><br/><br<code>loadFilesSequentialAndHideForm(listOfFiles):<code>&lt;br&gt;• Processes </code>listOfFiles<code> in order using a </code>next()<code> loop and short </code>setTimeout<code> delays between items (60ms) to keep UI thread responsive.&lt;br&gt;• Builds </code>accRaw<code> (plain text) and </code>accMarked<code> (with </code><!-- caption: --><code> and </code>### Title<code> headings for marked conversions).&lt;br&gt;• If caption supplied uses </code>sanitizeCaptionForInjection<code> and </code>safeMarkdownHeading<code> to prevent injection and produce a markdown heading.&lt;br&gt;• After all files loaded writes combinedRaw to </code>#paste<code> or </code>#page-area<code>, sets </code>window.<strong>tv_last_source<code> and timestamp, then calls conversion hooks (</code></strong>tv_do_convert<code>, </code>convert<code>, or fallback hidden convert </code>__ptt_hidden_convert<code>).&lt;br&gt;• After injection tries to apply runtime captions to actual DOM nodes using </code>applyRuntimeCaptions` which retries until success or maxRetries to allow downstream renderers to hydrate.</br<code></div></div></td></tr></tbody></table></div><div class="row-count">Rows: 26</div></div><div class="table-caption" id="Table2" data-table="Docu_0139_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by Technical Breakdown (continued)" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown (continued)</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown (continued)"><div class="tv-left-col"><div class="left-col-heading"><strong>Accessibility &amp; ARIA considerations</strong><br/><br/>• Links: generated anchors include <code>role="link"</code> and <code>aria-label</code> set to the visible label so screen readers announce target text reliably. <br/>• Current item: the script sets <code>aria-current="page"</code> on the active link. This is sufficient for most screen readers to indicate the current section. <br/>• Keyboard: links are real <code>&lt;a&gt;</code> elements so they are keyboard-focusable and activate via Enter/Space by default. Delegated click handling avoids interfering with native keyboard activation. <br/>• Focus management: <code>onTocClick</code> attempts to <code>target.focus({preventScroll:true})</code> after scrolling to allow keyboard users to continue navigation; focus falls back harmlessly if the element is not focusable. <br/>• Recommendations: if targets are table rows (<code>&lt;tr&gt;</code>), add <code>tabindex="-1"</code> to rows (or wrap anchors inside cells) so focus is programmatic and compliant. The companion <code>initRenderedContent</code> in other scripts already sets <code>tabindex</code> in some flows; ensure that pattern remains consistent.</div></div></td></tr><tr><td data-label="Technical Breakdown (continued)"><div class="tv-left-col"><div class="left-col-heading"><strong>Performance characteristics &amp; complexity analysis</strong><br/><br/>Time complexity:<br/>• <code>buildOnce()</code> scans <code>contentRoot</code> for <code>table</code> nodes and for <code>headingSelector</code>. Cost O(N) where N is DOM node count in the content root. <br/>• <code>ensureId()</code> reads <code>textContent</code> and runs a small regex and array checks per element; cost proportional to label length. <br/>• <code>MutationObserver</code> triggers are debounced to O(rebuilds) rather than O(mutations). Default debounce 150ms minimizes thrash. <br/><br/>Memory and runtime notes:<br/>• No heavy allocations. Uses ephemeral arrays for node lists. <br/>• Does not keep references to large node snapshots. <br/>• Safe for pages with tens to low hundreds of tables/heading items. If content root is extremely large (&gt;10k DOM nodes) initial scan cost may rise; consider narrowing <code>contentSelector</code>.</div></div></td></tr><tr><td data-label="Technical Breakdown (continued)"><div class="tv-left-col"><div class="left-col-heading"><strong>Edge cases, pitfalls, and defensive behaviors</strong><br/><br/>1. Elements with existing messy <code>id</code> values. <code>ensureId</code> preserves existing valid ids and only creates new ones when necessary. Collision resolution appends numeric suffixes. <br/>2. Headings with embedded HTML or <code>&lt;br&gt;</code> literal text. <code>_normalize_heading_text</code> collapses newlines and strips isolated 'br' tokens to avoid id noise. This may remove intentionally literal 'br' words; use a custom <code>headingSelector</code> if exact text preservation is required. <br/>3. Dynamically-replaced nodes: the MutationObserver re-runs builds, but client code that dramatically rewrites the TOC container could race; the module avoids re-creating listeners by using delegation. <br/>4. CSS and styling are not injected. Visual presentation relies on host CSS. If TOC containers are absent or hidden, the script will be silent.</div></div></td></tr><tr><td data-label="Technical Breakdown (continued)"><div class="tv-left-col"><div class="left-col-heading"><strong>Integration points with PasteToTable stack</strong><br/><br/>• Content discovery: uses <code>#content</code> then <code>#tables-viewer</code> then <code>document.body</code>. This aligns with common PTT DOM patterns. <br/>• TOC containers: expects <code>#toc</code> and <code>#tocBar</code> but tolerates their absence. <br/>• Sticky header: honors <code>stickyHeaderId</code> to compute scroll offsets. <br/>• Exposes <code>PTToc.build()</code> and <code>window.PTToc</code> for external hooks. <br/>• Works alongside <code>initRenderedContent</code> flows in <code>script.core.js</code> and <code>script.table.js</code>; these scripts create <code>.table-caption</code> / <code>.table-heading</code> elements that the TOC consumes. Ensure <code>initRenderedContent</code> runs before heavy user interactions or rely on <code>MutationObserver</code> to pick up late-inserted headings.</div></div></td></tr><tr><td data-label="Technical Breakdown (continued)"><div class="tv-left-col"><div class="left-col-heading"><strong>Concrete test matrix (recommended unit &amp; integration tests)</strong><br/><br/>Small focused unit tests:<br/>1. <code>ensureId()</code>:<br/> • No id -&gt; generates slug from heading text. <br/> • Blank text -&gt; generates random fallback id. <br/> • Colliding id -&gt; appends numeric suffix. <br/>2. <code>_normalize_heading_text()</code>:<br/> • Input with <code>\n</code>, <code>\r\n</code>, and extra spaces collapses to single-space string. <br/> • Literal "br" tokens separated by spaces removed. <br/>3. <code>buildItemsFromSingleTable()</code>:<br/> • Single table with <code>tbody</code> rows returns one item per row with ids. <br/> • Table with <code>thead</code> + <code>tbody</code> excludes <code>thead</code> rows. <br/>4. <code>buildItemsFromHeadings()</code>:<br/> • Multiple headings produce correctly normalized labels and unique ids.<br/><br/>Integration tests (DOM-level using headless browser):<br/>• Inject a single large table and verify TOC <code>#tocBar</code> receives N "Topic" links and clicking link scrolls to correct row. <br/>• Inject multiple tables with preceding headings and verify TOC uses heading labels. <br/>• Dynamically insert a new table and verify <code>MutationObserver</code> rebuilds the TOC. <br/>• Sticky header offset: mock header height and verify scroll target is offset by that height.</div></div></td></tr><tr><td data-label="Technical Breakdown (continued)"><div class="tv-left-col"><div class="left-col-heading"><strong>Security considerations</strong><br/><br/>• XSS: this module never calls <code>innerHTML</code> with attacker-controlled strings when building links. It uses <code>textContent</code> and <code>createElement</code>, which are DOM-safe. <br/>• ID generation: uses <code>textContent</code> inputs to form IDs. While not directly a vector for XSS, IDs can contain user content; ensure other scripts that interpolate ids into HTML attributes use proper escaping. <br/>• History API: uses <code>history.replaceState</code> to update hash without creating history entries. This is low-risk. <br/>• Recommendations: continue to avoid <code>innerHTML</code> on untrusted content. If client code must render raw HTML from headings, sanitize with DOMPurify or similar before injection.</div></div></td></tr><tr><td data-label="Technical Breakdown (continued)"><div class="tv-left-col"><div class="left-col-heading"><strong>Logging, diagnostics &amp; observability</strong><br/><br/>Current code is silent in normal operations and swallows errors to preserve UX. For production-grade observability consider adding:<br/>• Counters: <code>pttoc.rebuilds</code>, <code>pttoc.items_generated</code>, <code>pttoc.mutations_triggered</code>.<br/>• Debug logging gated behind a global <code>PTToc.debug</code> flag to avoid noise. <br/>• Optional event dispatch: <code>document.dispatchEvent(new CustomEvent('pttoc:built', {detail:{count:items.length}}))</code> after builds to allow host metrics to capture events.</div></div></td></tr><tr><td data-label="Technical Breakdown (continued)"><div class="tv-left-col"><div class="left-col-heading"><strong>Performance tuning knobs &amp; recommendations</strong><br/><br/>• <code>PTToc._debounceMs</code>: increase to 300–500ms on pages with noisy dynamic updates. <br/>• <code>PTToc.config.contentSelector</code>: narrow to a smaller subtree to reduce scanning cost. <br/>• If page injects thousands of nodes frequently, temporarily disconnect <code>MutationObserver</code> during bulk inserts and call <code>PTToc.build()</code> once insertion completes. <br/>• Lazy-build: if initial render is heavy, consider deferring <code>buildOnce()</code> until user opens the TOC (e.g., build on first hover/click).</div></div></td></tr><tr><td data-label="Technical Breakdown (continued)"><div class="tv-left-col"><div class="left-col-heading"><strong>Backward compatibility &amp; extension points</strong><br/><br/>• <code>PTToc.init(options)</code> accepts overrides for all selectors and header id. Keep config minimal when integrating. <br/>• Public methods <code>PTToc.build()</code> and <code>PTToc.config</code> allow host code to trigger rebuilds or adjust behavior. <br/>• <code>ensureId</code> and <code>makeLink</code> are small pure functions that can be reused by other modules. Export them if needed.</div></div></td></tr><tr><td data-label="Technical Breakdown (continued)"><div class="tv-left-col"><div class="left-col-heading"><strong>Operational failure modes &amp; recovery</strong><br/><br/>• If <code>MutationObserver</code> is missing the script still runs an initial build and remains usable for static pages. <br/>• If <code>#toc</code> or <code>#tocBar</code> are removed dynamically, <code>buildOnce()</code> will no-op safely. <br/>• If a single link click throws, delegation catches and the rest of listeners remain intact. <br/>• Recovery: re-initialize with <code>PTToc.init()</code> if host-side changes break the TOC container layout.</div></div></td></tr><tr><td data-label="Technical Breakdown (continued)"><div class="tv-left-col"><div class="left-col-heading"><strong>Roadmap &amp; prioritized improvements</strong><br/><br/>Short term (next sprint):<br/>1. Emit <code>pttoc:built</code> custom event with payload for observability. <br/>2. Add <code>PTToc.debug</code> toggle with optional console logs. <br/>3. Add unit tests for <code>ensureId</code> and <code>_normalize_heading_text</code>.<br/><br/>Mid term (1–3 months):<br/>1. Allow <code>labelFormatter</code> callback in config to produce custom labels (e.g., i18n). <br/>2. Add optional client-side virtualization for extremely large single-table row lists to keep the TOC bar compact. <br/><br/>Long term (3–6 months):<br/>1. Provide a plugin hook so host apps can supply custom anchor-building logic (e.g., include table metadata). <br/>2. Add telemetry integration (optional) to export counters to host metrics pipeline.</div></div></td></tr><tr><td data-label="Technical Breakdown (continued)"><div class="tv-left-col"><div class="left-col-heading"><strong>Quick operational checklist before deployment</strong><br/><br/>1. Verify <code>#content</code> (or configured <code>contentSelector</code>) references the correct subtree. <br/>2. Ensure host CSS styles <code>.pt-toc-link</code> / <code>.toc-link</code> for usable visuals. <br/>3. Confirm <code>stickyHeaderId</code> if the page has a fixed header. <br/>4. Run the unit test matrix on the target environment. <br/>5. Optionally enable <code>PTToc.debug</code> for a short smoke-test window to capture any DOM anomalies.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 12</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>