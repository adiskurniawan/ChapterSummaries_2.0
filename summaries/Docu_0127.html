<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1763746935">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0127_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1 • script.core.js</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical breakdown (script.core.js)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical breakdown (script.core.js)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Overview & intent</strong><br>Central client-side core for PasteToTable. Responsibilities: bootstrapping runtime configuration, locating auxiliary assets (index/worker/extra scripts), providing safe utility primitives (debounce, clipboard, download, toasts), wiring UI actions (convert/clear/save/export), performing the conversion request to <code>/api/render</code> (<code>__tv_do_convert</code>), routing/rendering server HTML into the viewer (<code>processRenderedHtml</code>), applying injected captions and TOC initialization when appropriate, and coordinating scroll behavior. The file emphasizes defensive programming, feature-detection, non-breaking fallbacks, and progressive enhancement for environments lacking modern APIs. Designed to integrate with optional global collaborators (<code>window.PasteToTable</code>, <code>window.PTToc</code>, external <code>script.toc.js</code>, <code>labels_injected.json</code>). </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>High-level architecture & modules</strong><br>1. Config & bootstrap — <code>defaultConfig</code>, <code>window.tvConfig</code>, <code>detectScriptBase</code>, <code>ensureIndexAndWorkerAttrs</code>, <code>startExtraLoader</code>.<br>2. Scroll coordination shim — <code>PTTScroll</code>.<br>3. Loader utilities — sequential loaders, TOC loader, label loader.<br>4. Utility primitives — debounce, normalize, clipboard, filename sanitization, download helpers.<br>5. Toast system — queued lightweight notifications.<br>6. Caption & TOC orchestration — install/inject helpers.<br>7. Conversion pipeline — <code>__tv_do_convert</code>, <code>processRenderedHtml</code>.<br>8. Event wiring — action dispatcher, header wiring. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Global contracts & exposed API</strong><br><code>window.tvConfig</code>, <code>window.tvIndexUrl</code>, <code>window.tvWorkerUrl</code>, <code>window.__tv_base</code>, <code>window.tvUtils</code>, <code>window.__tv_utils</code>, <code>window.__ptt_apply_injected_captions</code>, <code>window.__ptt_labels_injected</code>, <code>window.__ptt_toc_and_labels_installed</code>, <code>window.PasteToTable.processRenderedHtml</code>, <code>window.__tv_do_convert</code>, <code>window.convertButtonHandler</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>detectScriptBase()</strong><br>Purpose: determine script base URL. Uses <code>document.currentScript</code>, scans <code>&lt;script&gt;</code> tags, or falls back to <code>location.origin + path</code>. Returns <code>&#x27;/&#x27;</code> on failure. Handles missing <code>currentScript</code>, relative paths, malformed DOM. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>ensureIndexAndWorkerAttrs(base)</strong><br>Purpose: ensure <code>&lt;body&gt;</code> has <code>data-index-url</code> and <code>data-worker-url</code>. Computes defaults from base. Writes DOM attrs and assigns globals. Swallows CSP failures. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>PTTScroll (IIFE)</strong><br>Purpose: neutral scroll coordinator. Methods: <code>enable</code>, <code>disable</code>, <code>isEnabled</code>, <code>initObserver</code>, <code>scrollToTop</code> (noop). MutationObserver emits <code>ptt:renderStable</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>createScriptElement(src, opts)</strong><br>Creates a <code>&lt;script&gt;</code> with optional flags. Returns element for caller to append. Empty <code>src</code> tolerated. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>loadExtraSequentially(possiblePaths, onDone, onAllFailed)</strong><br>Sequential script loader. Appends candidate; on error removes and tries next. Reduces race conditions. Worst-case latency O(N). </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>startExtraLoader()</strong><br>Guards against duplicates, checks for existing extras, invokes sequential loader, logs success/failure. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>joinUrl(base, rel)</strong> — Robust absolute-URL builder using <code>new URL(rel, base).href</code> with string-concat fallback on failure; handles malformed inputs via fallback. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>normalizeForSearchLocal(s)</strong> — Unicode-aware normalizer. Tries <code>Shared.normalizeForSearchLocal</code>; default lowercases, NFD-decomposes, strips combining marks, removes non-letter/number/space with <code>\p{}</code> regex, collapses whitespace; safe fallback when Unicode regex unsupported. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>debounce(fn, wait)</strong> — Debounces a function using timer; prefers <code>Shared.debounce</code>; preserves <code>this</code> via <code>apply</code>; <code>wait</code> defaults to <code>tvConfig.debounceMs</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>copyToClipboard(text) / tryLegacyCopy(t)</strong> — Clipboard copy using <code>navigator.clipboard.writeText</code>; falls back to hidden <code>&lt;textarea&gt;</code> + <code>execCommand(&#x27;copy&#x27;)</code>; Promise-based; handles CSP/UA failures. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>sanitizeFileName(name)</strong> — Produces safe filename: replaces invalid chars, compresses spaces, trims to ≤200 chars; returns <code>&#x27;download&#x27;</code> if empty; <code>Shared.sanitizeFileName</code> override supported. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>downloadBlob(blob, filename)</strong> — Client-side download using <code>URL.createObjectURL</code> + anchor click; revokes URL after 150 ms; returns success boolean; supports <code>Shared.downloadBlob</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Toast system</strong> — <code>_ensureToastContainer</code>, <code>_computeToastDuration</code>, <code>showToast</code>, <code>showToastOnce</code>, <code>_processToastQueue</code>, <code>_hideActiveToast</code>, <code>_dismissToastById</code>.<br>Creates ARIA-aware toast container; queue-based display; auto-dismiss; duplicate-prevention; DOM creation, animation, cleanup; inline style usage; relies on CSS vars for colors. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>getSearchEl()</strong> — Returns search input element by checking ids: <code>searchBox</code>, <code>searchInput</code>, <code>search</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>tvUtils / __tv_utils export block</strong> — Exposes utilities globally (<code>copyToClipboard</code>, <code>debounce</code>, <code>sanitizeFileName</code>, <code>downloadBlob</code>, <code>getSearchEl</code>, <code>formatCellForMarkdown</code>, <code>tableToMarkdownLines</code>, <code>normalizeForSearchLocal</code>); respects existing definitions and <code>Shared</code> hooks. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>ID & escape helpers</strong> — <code>_normalizeKey</code>, <code>buildPrefixCandidatesFromLabels</code>, <code>sanitizeForId</code>, <code>ensureId</code>, <code>escapeHtml</code>.<br><code>ensureId</code> builds deterministic unique IDs from label text; <code>escapeHtml</code> escapes <code>&amp;&lt;&gt;\&quot;&#x27;</code> for safe caption/content usage. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>fetchJsonWithTimeout(url, timeoutMs)</strong> — Fetch JSON with timeout; uses AbortController or manual timeout; always resolves <code>null</code> on error; no-store, same-origin. Defensive but could return richer diagnostics. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>tryLoadLabels(candidates)</strong> — Sequentially tests label URLs using <code>fetchJsonWithTimeout</code>; returns first non-empty object or <code>{}</code>; fully error-tolerant; O(N) latency. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>installTocScript(candidates)</strong> — Tries to load <code>script.toc.js</code> candidates in order; resolves <code>true</code> on first success else <code>false</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>captionFor(labelsObj, bookPrefix, idx)</strong> — Resolves caption text through multiple permutations: flat keys, nested objects, underscore/dash variants, padded/unpadded indices; returns string or <code>null</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>inferBookPrefix()</strong> — Picks prefix from <code>data-file</code>/<code>data-source</code>, or URL filename, or sanitized document title. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>injectCaptionForElement(anchorEl, bookPrefix, idx, captionText)</strong> — Inserts or updates a <code>&lt;div.table-caption&gt;</code> before a table/anchor; ensures unique <code>Table{n}</code> ID; reuses existing caption when present; uses inline styles; primarily uses <code>innerHTML</code> with escaped input. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>installTocAndLabels()</strong> — One-time installer for TOC script and labels; guarded by global flag; loads TOC, then labels; stores <code>window.__ptt_labels_injected</code> and installation status. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>__ptt_apply_injected_captions()</strong> — Scans all tables; builds candidate prefix list; finds caption by trying permutations; enforces unique IDs; reuses or injects caption nodes; reports whether any caption was inserted or updated. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>processRenderedHtml(responseData)</strong> — Main renderer and post-processor:<br>1. Normalizes HTML string.<br>2. Parses metadata (e.g., <code>fromList</code>).<br>3. Sets skip-scroll flag.<br>4. Routes HTML via <code>PasteToTable.routeHtmlToAreas</code> with fallback to innerHTML injection.<br>5. Calls <code>PasteToTable.initRenderedContent()</code> twice (timing guard).<br>6. If <code>fromList</code>: ensures TOC/labels installed; applies captions; initializes TOC (<code>__tv_init_pttoc_from_core</code> or <code>PTToc.build</code>).<br>7. Attempts TOC init unconditionally.<br>8. Performs multiple scroll-to-top attempts with fail-safe clearing of skip flag.<br>Returns <code>true</code>/<code>false</code> based on handled success. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>__tv_do_convert(opts)</strong> — Primary conversion pipeline. Posts pasted text to <code>/api/render</code>, receives HTML/JSON, delegates to <code>processRenderedHtml</code>, manages UI state, and performs auto-selection of Table 1. Key steps: guard reentrancy; extract/validate text; dual-mode fetch (JSON then form fallback); handle non-OK responses; normalize payload (JSON or wrapped HTML); delegate to <code>window.PasteToTable.processRenderedHtml</code> if present; sanitize <code>fromList</code>; inject HTML on fallback path; toast status; deferred multi-strategy TOC auto-select; final cleanup of flags. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>convertButtonHandler(ev)</strong> — UI wrapper calling <code>__tv_do_convert</code>. Checks concurrency flag, then awaits conversion. Exposed as <code>window.convertButtonHandler</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>convert click delegation (IIFE)</strong> — Global click capture to route clicks on <code>#convertBtn</code> or <code>[data-action=&quot;convert&quot;]</code> to conversion handler. Prevents duplicate handling via <code>ev.__tv_convert_handled</code>. Attaches direct click listener as fallback. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>attachActionDispatcher()</strong> — Universal <code>[data-action]</code> dispatcher. Single bubbling click listener finds the nearest <code>[data-action]</code> and dispatches to <code>window.__tv_action_handlers[action]</code>. Pre-registers <code>&#x27;convert&#x27;</code> if available. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>clearButtonHandler()</strong> — Clears <code>#paste</code>, <code>#tables-viewer</code>, <code>#page-area</code>, resets <code>#status</code>, and shows toast. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>saveHtmlHandler(ev)</strong> — Saves current rendered HTML. Detects visible area (<code>#page-area</code> or <code>#tables-viewer</code>), builds minimal HTML document, and attempts server-side save via <code>window.PasteToTable.save</code>. On failure, falls back to <code>downloadBlob</code>. Uses sanitized filename from <code>document.title</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>attachHeaderHandlersOnce()</strong> — Attaches header button handlers (<code>convert</code>, <code>clear</code>, <code>save</code>, <code>exportAllBtn</code>, <code>renderBtn</code>) once. Uses internal <code>_attached</code> and dataset flags for idempotence. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Action dispatcher & final wiring</strong> — Exports <code>showToast</code>, <code>downloadBlob</code>, <code>copyToClipboard</code>, <code>sanitizeFileName</code>. Wires <code>window.PasteToTable.processRenderedHtml</code>. Logs final environment info. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Defensive patterns</strong> — Extensive <code>try/catch</code>; idempotent event binding; robust fallback logic; global coordination flags (<code>__tv_convert_in_progress</code>, <code>__tv_skip_scroll</code>, etc.); tolerant fetch helpers returning <code>null</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Compatibility & security choices</strong> — Uses <code>innerHTML</code> for injection (trusted server required); inline styles may conflict with CSP; fetch defaults keep same-origin cookies; avoids assuming modern APIs by feature detection. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Performance & scalability notes</strong><br>- Asset discovery (<code>loadExtraSequentially</code>, <code>tryLoadLabels</code>) is sequential — predictable but adds cumulative latency; acceptable for small candidate lists.<br>- Toast rendering & DOM ops are lightweight.<br>- Caption injection loops over all <code>table</code> nodes — O(T); for extremely large documents consider throttling or incremental insertion. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Bugs / risky assumptions / edge cases</strong><br>1. innerHTML vs textContent inconsistency — risk of double-escaping or missed sanitization.<br>2. ID collision detection limited — only global check, not table-scoped.<br>3. Sequential candidate probing latency — cumulative timeout cost.<br>4. TOC coupling assumptions — new TOC implementations may break auto-select.<br>5. Scroll coordination race — shared flag <code>__tv_skip_scroll</code> may conflict with other scripts.<br>6. Ambiguous <code>fromList</code> semantics — caller must set correctly.<br>7. Toast focus side-effect — may steal focus in SPAs. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Maintainability observations</strong><br>- Large file with many responsibilities; split into modules.<br>- Global variable proliferation; document global API contract.<br>- Inline style use and duplicated utility functions; factor into shared helpers. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Concrete recommended fixes / improvements</strong><br><strong>High priority</strong>: replace innerHTML caption insertion with DOM-safe construction; externalize styles; add cancellation hooks.<br><strong>Medium</strong>: improve discovery concurrency; structured error returns.<br><strong>Low</strong>: config entry-point for URLs; centralize utilities. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Suggested tests</strong><br><strong>Unit</strong>: unicode normalization, filename sanitization, HTML escaping, caption generation, timeout behavior.<br><strong>Integration</strong>: complex DOM caption injection, routing logic, convert flow with varying server responses.<br><strong>E2E</strong>: verify TOC behaviors, performance on large table counts. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Compatibility & integration checklist</strong><br>- Document global hooks (PasteToTable, PTToc).<br>- Ensure server <code>/api/render</code> is trusted or avoid innerHTML injection.<br>- Provide tvConfig pre-init override pattern; describe CSP considerations. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Potential regressions to watch</strong><br>- Caption ID naming changes break TOC.<br>- innerHTML → DOM refactor may affect whitespace/layout.<br>- Refactoring event wiring may double-bind handlers; preserve guards. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Final concise verdict</strong><br>Strong defensive design with good fallbacks. Main issues: innerHTML reliance, inline styles, sequential probing, duplicated helpers. Implement recommended fixes for production readiness. </td></tr></tbody></table></div><div class="row-count">Rows: 46</div></div><div class="table-caption" id="Table2" data-table="Docu_0127_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2 • script.list.js</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical breakdown (script.list.js)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical breakdown (script.list.js)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Overview & intent</strong><br>Client-side module that discovers server-side saved table/index endpoints, normalizes file metadata, builds logical groups, presents a searchable/expandable modal UI for selecting groups or individual files, fetches chosen files (parallel fetch with ordered assembly), exposes runtime captions safely, invokes the renderer/convert pipeline, applies captions into the rendered DOM, and provides robust copy-from-paste behavior. Emphasis on defensive coding, timeouts, graceful fallbacks, and preserving legacy public APIs and function names for backward compatibility.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Top-level configuration & flags</strong><br>- <code>LIST_BTN_ID</code>, <code>PASTE_ID</code>, <code>STATUS_ID</code> — DOM IDs used throughout.<br>- <code>LIVE_FILES_ENDPOINTS</code>, <code>GROUPS_JSON_CANDIDATES</code>, <code>LABELS_JSON_CANDIDATES</code> — ordered probe lists for discovery with fallback candidates.<br>- Timeouts & limits: <code>FILE_FETCH_TIMEOUT_MS</code> (12000), <code>INDEX_FETCH_TIMEOUT_MS</code> (8000), <code>GROUPS_FETCH_TIMEOUT_MS</code> (4000), <code>LABELS_FETCH_TIMEOUT_MS</code> (3000), <code>MAX_LIST_ITEMS</code> (5000).<br>- Feature flags: <code>ENABLE_CACHE_BUSTER</code>, <code>ENABLE_INVERTED_INDEX</code>, <code>ENABLE_WORKER_SCORING</code>, <code>WORKER_THRESHOLD</code>, <code>WORKER_TIMEOUT_MS</code>, <code>MAX_CANDIDATES_FROM_INDEX</code>. Many flags present for tunability; some (worker scoring) are not fully wired.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>High-level architecture</strong><br>1. <strong>Fetch layer</strong> — <code>fetchWithTimeout</code> (generic) and <code>fetchFileWithTimeout</code> (per-file) wrap <code>fetch</code> with AbortController/timeouts and return normalized shapes (resolve-with-object for index fetch; reject on failure for <code>fetchFileWithTimeout</code>).<br>2. <strong>Index & normalization</strong> — <code>normalizeIndexData</code>, <code>tryParseListBodyAsArray</code>, <code>encodedSavedUrlFor</code>, helpers for BOM stripping and safe string ops.<br>3. <strong>Labels & groups</strong> — <code>loadLabels</code>, <code>buildLabelIndex</code>, <code>resolveCaptionFor</code> for caption resolution; <code>loadGroupDescriptions</code> parses <code>groups.json</code> candidates.<br>4. <strong>Group building & keys</strong> — <code>groupKeyFromPath</code>, <code>safeGroupName</code>, <code>buildGroupsFromLive</code> create grouped structures consumed by UI.<br>5. <strong>Search engine</strong> — <code>createFileSearchEngine</code> builds a lightweight inverted index, trigrams, token lists, and exposes <code>candidatesForQuery</code> and <code>scoreFiles</code> for ranking (with internal tokenize, trigrams, cheapDL edit-distance helper).<br>6. <strong>UI modal</strong> — <code>createModal</code> and <code>presentGroupsOnly</code> build a polished modal UI, search box, group rows, expand/collapse controls, and per-file load handlers.<br>7. <strong>Load & assemble</strong> — <code>loadFilesSequentialAndHideForm</code> (keeps name) performs parallel file fetches preserving order, assembles <code>combinedMarked</code> and <code>combinedRaw</code>, writes into paste area or page-area, invokes conversion, applies captions, and dispatches <code>ptt:groupLoaded</code> on microtask queue.<br>8. <strong>Copy and clipboard</strong> — encapsulated copy override to delegate to renderer (if available) or to fallback raw/markdown extraction via <code>findFirstMarkdownBlockInSource</code> and <code>copyTextToClipboard</code>.<br>9. <strong>Public hooks</strong> — <code>buildAndPresent</code>, <code>attachListHandler</code>, <code>attachPasteSync</code>, and small exported globals (<code>window.__ptt_copy_raw_from_paste</code>, <code>window.__ptt_set_force_raw_copy</code>) implement integration points.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Key functions — concise technical summary</strong><br><strong>dbg(...)</strong> — gated logging controlled by <code>DEBUG</code> flag; safe <code>console.log</code> usage.<br><strong>safeTrim, basenameFromPath, removeExtension</strong> — lightweight, defensive string utilities used by normalizers.<br><strong>encodedSavedUrlFor(relPath)</strong> — constructs <code>/saved/</code> encoded path unless <code>relPath</code> is absolute URL; returns <code>null</code> on error. Hardcoded base path may not match server routing in all deployments.<br><strong>stripBOM, updateStatus, showToastOrStatus, generateClientReqId</strong> — UI helpers and client trace id generator used across flows.<br><strong>fetchWithTimeout(url, timeoutMs)</strong> — robust wrapper: supports AbortController when available; appends cache-buster if enabled; returns promise resolving to <code>{ok,status,url,body,err}</code>. Important behavior: resolves rather than rejects, simplifying callers when probing endpoints.<br><strong>normalizeIndexData(raw)</strong> — accepts array-of-strings, array-of-objects, or <code>{files: [...]}</code> shape and produces canonical <code>{ name, url, path, description }</code> entries up to <code>MAX_LIST_ITEMS</code> with defensive guards.<br><strong>tryParseListBodyAsArray(txt)</strong> — attempts JSON parse with fallback to detect <code>{files:[]}</code> wrappers; returns <code>null</code> if not JSON.<br><strong>fetchLiveFilesSequential(endpoints)</strong> — sequentially probes candidate endpoints using <code>fetchWithTimeout</code>; accepts JSON arrays or line-oriented text lists; returns first valid normalized index — sequential probing increases worst-case latency.<br><strong>escapeHtml, canonKey, keyVariants, buildLabelIndex</strong> — label normalization and tolerant key generation to map many naming variants to captions; <code>buildLabelIndex</code> populates <code>__ptt_labels_cache</code> and <code>window.PTLabels</code> when available.<br><strong>loadLabels()</strong> — sequentially attempts <code>LABELS_JSON_CANDIDATES</code>, parses JSON, builds label index, caches result; falls back to empty map.<br><strong>resolveCaptionFor(baseName, labelIndex)</strong> — complex heuristic: many candidate normalizations (underscores, dashes, numeric suffixes) and fallback substring matching against labelIndex; returns first-match caption or empty string.<br><strong>loadGroupDescriptions()</strong> — similar candidate probing to <code>loadLabels</code>, parses groups.json formats (array <code>groups</code> or object) and returns a descriptive map.<br><strong>groupKeyFromPath(pathOrName) / safeGroupName(s)</strong> — heuristics to derive grouping key from path structure, underscores, or numeric suffixes; returns <code>&#x27;Ungrouped&#x27;</code> as default.<br><strong>buildGroupsFromLive(liveFiles, labelsIndex)</strong> — groups normalized files by <code>groupKeyFromPath</code>, resolves per-file captions via <code>resolveCaptionFor</code>, encodes saved URL via <code>encodedSavedUrlFor</code> when needed, and returns sorted group array (<code>Ungrouped</code> last).<br><strong>createFileSearchEngine(items, opts)</strong> — builds <code>lite</code> array (tokens, trigrams), an <code>inverted</code> postings map, a small LRU query cache, and exposes: <code>candidatesForQuery(q)</code> (postings intersection/union logic, MAX_POSTINGS), <code>scoreFiles(query, candidateIdxs)</code> (promised scoring using token matches, caption/name boosting, trigram overlap, cheapDL fuzzy distance), <code>dispose</code>. Internal helpers: <code>tokenize</code> (ASCII-only), <code>trigramsOf</code>, <code>cheapDL</code> (edit distance).<br><strong>createModal(contentEl, title)</strong> — constructs an accessible modal overlay with inline styles, moves existing search node into header when present, appends to document, and returns <code>{overlay,panel,close}</code> handle; ensures Escape key and overlay click close behavior.<br><strong>presentGroupsOnly(groups, descriptions)</strong> — builds persistent DOM: container, search input, expand/collapse controls, <code>FILE_ITEMS</code> flattening, creates <code>engine</code> (search), renders initial group rows, supports incremental search via debounced scoring, <code>renderGroupsFromFileResults</code> to assemble per-group ranked file lists, <code>createGroupRowForRender</code> to make interactive rows with per-file click handlers invoking <code>loadFilesSequentialAndHideForm</code>. Contains local highlight/token/trigram utilities (note duplication with engine).<br><strong>fetchFileWithTimeout(url, timeoutMs)</strong> — per-file fetch wrapper returning <code>Promise</code> that resolves to <code>res.text()</code> or rejects; uses AbortController when available; interface unchanged to preserve legacy callers.<br><strong>trySendActiveGroupMetadata(groupObj, client_req_id)</strong> — validates group and files, constructs payload with filenames, paths, captions, and posts to <code>/api/group/load</code> (non-blocking). Logs responses with <code>dbg</code> and <code>console.warn</code> on failures. <strong>Privacy note:</strong> sends per-file metadata by default.<br><strong>loadFilesSequentialAndHideForm(listOfFiles)</strong> — centerpiece file-load function (legacy name preserved): validates input, updates status, builds runtime captions array (dedupes default names), exposes <code>window.__ptt_runtime_captions</code> (deep-clone + <code>Object.freeze</code> where possible), prepares <code>fetchPromises</code> (parallel <code>fetchFileWithTimeout</code>), <code>Promise.all</code> to preserve order, assembles <code>accMarked</code> and <code>accRaw</code> (inserts safe caption markers and markdown headings when captions present via <code>sanitizeCaptionForInjection</code> and <code>safeMarkdownHeading</code>), writes to <code>PASTE_ID</code> element or <code>page-area</code>, sets <code>window.__tv_last_source</code>, calls renderer if available (<code>__tv_do_convert</code> preferred), fallback hidden textarea <code>__ptt_hidden_convert</code>, schedules caption-application loop (<code>applyRuntimeCaptions</code>) with polling up to <code>maxRetries</code>, then dispatches <code>ptt:groupLoaded</code> via <code>queueMicrotask</code> with <code>runtimeCaptions</code> and count. Handles many errors defensively.<br><strong>sanitizeCaptionForInjection, safeMarkdownHeading</strong> — caption sanitization removing comments/scripts/tags and escaping for safe insertion; markdown heading normalization.<br><strong>triggerConvertIfAvailable()</strong> — simple detection for renderer presence.<br><strong>buildAndPresent()</strong> — top-level orchestrator: updates status, concurrently resolves <code>fetchLiveFilesSequential</code>, <code>loadGroupDescriptions</code>, <code>loadLabels</code>, normalizes <code>liveFiles</code>, builds <code>groups</code>, updates status, calls <code>presentGroupsOnly</code> to show modal.<br><strong>attachListHandler()</strong> — binds click handler on <code>#listBtn</code> once; marks element with <code>__ptt_list_attached</code> to avoid duplicate binding. Uses DOMContentLoaded fallback.<br><strong>attachPasteSync()</strong> — keeps <code>window.__tv_last_source</code> and timestamp in sync with user edits to paste textarea.<br><strong>Copy/clipboard closure</strong> — installs a delegated <code>document</code> click handler for copy-markdown / copy-plain selectors; functions: <code>getRawPasteText</code>, <code>copyTextToClipboard</code> (Clipboard API preferred with <code>navigator.clipboard.writeText</code>, fallback to <code>execCommand</code>), <code>ensureTvTableIndex</code>, <code>findFirstMarkdownBlockInSource</code>, and UI toast helpers. Exposes <code>window.__ptt_copy_raw_from_paste</code> and <code>window.__ptt_set_force_raw_copy</code>. Delegates to <code>window.copyTableMarkdown</code> / <code>window.copyTablePlain</code> (renderer) when available unless forced raw copy is set. </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Defensive patterns & helpful fallbacks</strong><br>- Frequent <code>try/catch</code> blocks around almost every operation to avoid throwing and breaking UI.<br>- Feature-detection for <code>AbortController</code>, <code>TextDecoder</code>, <code>navigator.clipboard</code>, and renderer functions (<code>__tv_do_convert</code>, <code>convert</code>).<br>- Fetch utilities return normalized shapes or controlled rejection to simplify consumer code.<br>- Limits & timeouts everywhere (per-fetch, per-endpoint, caption-apply retry limits) to avoid indefinite stalls.<br>- Deep-copy + <code>Object.freeze</code> for <code>__ptt_runtime_captions</code> to avoid accidental mutation by other scripts.<br>- Uses <code>queueMicrotask</code> to dispatch <code>ptt:groupLoaded</code> to improve delivery reliability across sync/async renderer implementations.<br>- Fallbacks for renderer absence (hidden textarea) and copy fallback (execCommand).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Notable behaviors & compatibility choices</strong><br>- Preserves legacy names and public signals (<code>loadFilesSequentialAndHideForm</code>, <code>attachListHandler</code>, <code>__tv_last_source</code>) for backward compatibility.<br>- Keeps <code>encodedSavedUrlFor()</code> synthesizing <code>/saved/</code> paths — convenient but coupling to server routing.<br>- <code>fetchLiveFilesSequential</code> probes sequentially (first-to-last) to preserve candidate priority; increases latency when valid endpoint is late in list.<br>- <code>trySendActiveGroupMetadata</code> posts file-level metadata by default to <code>/api/group/load</code> — may be undesired for privacy-sensitive deployments.<br>- Modal uses inline styles heavily for portability — may conflict with strict CSPs that disallow inline styles. <code>createModal</code> attempts to read CSS custom properties but still writes many inline rules.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Performance & scalability notes</strong><br>- Parallel per-file fetch with <code>Promise.all</code> preserves order while achieving concurrency — good for typical workloads.<br>- <code>fetchLiveFilesSequential</code> is sequential and can add up latencies equal to sum of endpoint probe times; consider bounded parallelization for faster discovery.<br>- <code>createFileSearchEngine</code> builds inverted postings limited by <code>MAX_POSTINGS</code>; this mitigates memory blow-up but reduces recall for very large collections. Tokenization and scoring run on main thread — flags exist for worker scoring (<code>ENABLE_WORKER_SCORING</code>) but no worker implementation present; for large datasets (>= <code>WORKER_THRESHOLD</code>) scoring will block UI. <br>- Caption application loop polls DOM up to <code>maxRetries</code> (default 120 every 160ms) — worst-case ~19s of polling; safe but could delay perceived completion.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Security, privacy & injection considerations</strong><br>- <strong>XSS risk mitigation:</strong> highlights and injected HTML use <code>.innerHTML</code> in multiple places (e.g., <code>nameLine.innerHTML = highlight(...)</code>, <code>fname.innerHTML = highlight(...)</code>). The code uses <code>escapeHtmlLocal</code> or <code>escapeHtml</code> before highlighting in most places, but ensure that all highlight code paths always escape user-controlled strings. <code>sanitizeCaptionForInjection</code> aggressively strips tags and scripts before inserting captions into markdown comments/headings — good practice.<br>- <strong>Telemetry/privacy:</strong> <code>trySendActiveGroupMetadata</code> transmits filenames, captions, and paths to <code>/api/group/load</code> by default. This can leak sensitive metadata. Recommend opt-in telemetry or redaction by default, and server-side CSRF/auth protection for the endpoint.<br>- <strong>CSP</strong>: heavy inline style usage in <code>createModal</code> may violate strict CSPs; provide a CSS class alternative or allow injection of a nonce-controlled <code>&lt;style&gt;</code> block.<br>- <strong>Clipboard fallback</strong>: the <code>execCommand(&#x27;copy&#x27;)</code> fallback may be unreliable in some environments; code already prefers <code>navigator.clipboard</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Bugs, risky assumptions & edge-cases</strong><br>1. <strong>ASCII-only tokenization</strong> — <code>tokenize</code> in <code>createFileSearchEngine</code> and <code>norm</code> in <code>presentGroupsOnly</code> use <code>/[^a-z0-9\s]+/g</code> which strips non-Latin characters; CJK, accented, Cyrillic, Arabic searches and tokenization will fail. Requires Unicode-aware tokenization (e.g., <code>\p{L}\p{N}</code> with <code>u</code> flag).<br>2. <strong>Worker scoring flags unused</strong> — <code>ENABLE_WORKER_SCORING</code> and <code>WORKER_TIMEOUT_MS</code> exist but no Web Worker is spawned; large indexes will perform scoring on main thread. Either implement worker or remove confusing flags.<br>3. <strong>Duplicate utilities</strong> — <code>trigramsOf</code>/<code>tokenize</code> implementations exist both inside the engine and inside <code>presentGroupsOnly</code> — risk of drift. Factor to shared helpers.<br>4. <strong>Sequential endpoint probing</strong> — <code>fetchLiveFilesSequential</code> checks endpoints one-by-one leading to worst-case latency equal to sum of probe times. Bounded parallel probing would improve UX without breaking priority.<br>5. <strong>Hardcoded saved base path</strong> — <code>encodedSavedUrlFor</code> uses <code>/saved/</code> prefix; if server uses different base, synthesized URLs may 404. Make base configurable or prefer server-provided URLs when available.<br>6. <strong>No global cancellation</strong> — the <code>loadFilesSequentialAndHideForm</code> flow spawns many fetches via <code>fetchFileWithTimeout</code> but provides no central cancellation token when modal closed or user navigates away. Add an AbortController group for cancellation and to stop caption-polling ticks.<br>7. <strong>Title mutation side-effect</strong> — code may set <code>document.title</code> to first caption when <code>document.title</code> is missing or default. This mutates host page and may be unexpected. Limit or make optional.<br>8. <strong>Caption-apply heuristics may mis-target nodes</strong> — <code>applyRuntimeCaptions</code> attempts matching by <code>.table-caption</code> or heading elements and heuristics for "Table N" names; fragile with custom renderer markup. Consider exposing an integration hook to map runtime captions to renderer-specific caption nodes.<br>9. <strong>Potential silent failures</strong> — <code>fetchFileWithTimeout</code> rejects on HTTP error; callers swallow errors into <code>ok:false</code> slots and insert fail notes into assembled text. This is intentional, but ensure host UX accounts for partially failed loads.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Maintainability & integration observations</strong><br>- File is modular with clear function boundaries but contains many global exposures (<code>window.__ptt_runtime_captions</code>, <code>__tv_last_source</code>, <code>__ptt_list_render_in_progress</code>, <code>__ptt_hidden_convert</code>, <code>PTLabels</code>, <code>__ptt_force_raw_copy</code>) — document integration contract.<br>- Inline styles and duplicated utility functions complicate visual adjustments and maintenance; centralize CSS and common helpers.<br>- Logging controlled by <code>DEBUG</code> flag; consider a scoped logger with levels and runtime toggle to avoid editing source for debugging.<br>- Good separation: label-injection and server POST responsibility removed from this file (explicit comment) — reduces coupling.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Concrete recommended fixes (priority order)</strong><br><strong>High-priority</strong><br>- Replace ASCII-only tokenizers with Unicode-aware tokenization (e.g., <code>s.replace(/[^\p{L}\p{N}\s]+/gu, &#x27; &#x27;)</code> and use Unicode-aware splitting). Update highlight code to use the same canonical tokens to avoid mismatch.<br>- Add a cancellation mechanism for group loads: return a cancellable handle from <code>loadFilesSequentialAndHideForm</code> or use a shared <code>AbortController</code> that <code>attachListHandler</code>/modal close can call; stop caption polling on cancel.<br>- Make telemetry opt-in: require configuration like <code>PTT_CONFIG.telemetry === true</code> before POSTing filenames/captions; redact or aggregate file metadata by default (send counts and anonymized group id only).<br>- Make <code>/saved/</code> base path configurable via top-level config (e.g., <code>PTT_CONFIG.savedBasePath</code>) rather than hardcoding.[br]<br><strong>Medium-priority</strong><br>- Implement worker-based scoring or remove <code>ENABLE_WORKER_SCORING</code> flag. If implementing, serialize minimal engine data and set a worker timeout/fallback path.<br>- Parallelize initial live-endpoint probes with bounded concurrency (N=2) while preserving candidate priority (e.g., race first two, then remaining sequentially).<br>- Factor duplicated helpers (<code>tokenize</code>, <code>trigramsOf</code>, <code>escapeHtmlLocal</code>) into shared utilities to avoid divergence.<br><br><strong>Low-priority / nice-to-have</strong><br>- Move inline modal styles to a CSS class / stylesheet and support CSP nonce injection.<br>- Expose integration hooks to map runtime captions to renderer-specific caption nodes (e.g., <code>PTT.on(&#x27;findCaptionNode&#x27;, fn)</code>).<br>- Make document title mutation optional or guarded by <code>PTT_CONFIG.titlesFromCaptions</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Suggested tests</strong><br><strong>Unit tests</strong>: <code>normalizeIndexData</code> for array/string/object shapes; <code>tryParseListBodyAsArray</code> with broken JSON and line lists; <code>buildLabelIndex</code> and <code>resolveCaptionFor</code> across many naming variants and numeric suffixes; <code>groupKeyFromPath</code> heuristics; <code>encodedSavedUrlFor</code> encoding edge cases; <code>tokenize</code> with Unicode inputs.<br><strong>Integration tests</strong>: <code>fetchWithTimeout</code> abort behavior with simulated slow endpoints; <code>fetchLiveFilesSequential</code> with a late-valid endpoint to reproduce latency; <code>loadFilesSequentialAndHideForm</code> with partial failures and large files; caption-apply flow with renderer mocking different DOM structures.<br><strong>E2E / Load</strong>: large index (>WORKER_THRESHOLD) to validate search performance and UI responsiveness; simulate mobile and CSP-restricted hosts to validate modal style behavior.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Compatibility & deployment checklist</strong><br>- Document and allow runtime overrides for top-level config (endpoints, savedBasePath, timeouts, MAX_LIST_ITEMS, cache-buster, telemetry).<br>- Document global variables and expected renderer API (<code>__tv_do_convert</code>, <code>convert</code>, <code>copyTableMarkdown</code>, <code>copyTablePlain</code>) and how to opt-out of telemetry/auto-posting.<br>- Ensure server-side <code>/api/group/load</code> endpoint has appropriate CSRF/auth checks if telemetry is enabled.<br>- Provide instructions for CSP environments (nonce or external CSS) and non-UTF8 servers (if any TextDecoder fallback needed).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Potential regressions to watch for when changing code</strong><br>- Changing tokenizer/normalizer behavior will change search results and label lookups (<code>labels.json</code> matching). Maintain backward compatibility or provide migration notes.<br>- Making <code>/saved/</code> path configurable will alter generated URLs; include compatibility shim or fallback to server-provided <code>url</code> when available.<br>- Moving inline styles to classes may alter visual layout; provide default stylesheet to keep parity with the current UI.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Final concise verdict</strong><br>Robust, defensive, and well-structured saved-groups/list loader with careful fallbacks and strong UX considerations. Primary technical risks: ASCII-only tokenization (non-Latin search failure), unused worker-scoring flags (main-thread scoring on large datasets), sequential endpoint probing (worst-case latency), hardcoded <code>/saved/</code> path assumption, and lack of a centralized cancellation mechanism for in-flight loads and caption polling. Addressing those items (Unicode tokenization, worker or remove flag, bounded-parallel endpoint probing, configurable saved base path, opt-in telemetry, and an AbortController group) plus factoring duplicated utilities will make the module production-ready and easier to maintain.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr></tbody></table></div><div class="row-count">Rows: 15</div></div><div class="table-caption" id="Table3" data-table="Docu_0127_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3 • script.table.js</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical breakdown (script.table.js)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical breakdown (script.table.js)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Overview & intent</strong><br>Client-side table utilities for PasteToTable focused on read-only caption safety, robust copying/export, TOC building, search/highlight, sorting, UI optimization, and multi-format export (CSV/JSON/XLSX/PDF). Designed to be defensive and interoperable with optional host utilities (<code>window.tvUtils</code>, <code>window.PTToc</code>, <code>window.XLSX</code>, <code>window.tvConfig</code>). The module avoids creating caption DOM (reads server-rendered captions only), prefers non-destructive operations (stores <code>data-orig-html</code>), and provides idempotent initialization via <code>initRenderedContent</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>High-level architecture</strong><br>1. <strong>Feature-detection wrappers</strong> — lightweight <code>safe</code>, <code>isString</code>, and fallbacks for clipboard/download/toast/debounce. <br>2. <strong>DOM helpers & locators</strong> — <code>getContentRoot</code>, <code>_findTocBarUl</code>, <code>safeGetTBody</code>, <code>getTableFromButton</code>, <code>getWrapperTitle</code>. <br>3. <strong>TOC builders</strong> — <code>buildSingleTableToc</code>, <code>buildTocFromCaptions</code>, <code>buildTocs</code> (prefers <code>window.PTToc</code>). <br>4. <strong>Row / sort state management</strong> — <code>_ensureRowUidsAndSnapshot</code>, <code>sortStates</code>, <code>originalRowOrders</code>, <code>updateHeaderSortUI</code>, <code>sortTableByColumn</code>, <code>headerSortButtonClicked</code>. <br>5. <strong>Collapse/expand & controls</strong> — <code>toggleTable</code>, <code>toggleAllTables</code>, <code>optimizeTableControls</code>, responsive adjustments and control re-parenting. <br>6. <strong>Search & highlighting</strong> — <code>normalizeForSearchLocal</code>, <code>buildNormalizedMapForCell</code>, <code>highlightMatches</code>, <code>clearHighlights</code>, <code>searchTable</code>. <br>7. <strong>Copy / export</strong> — <code>copyTablePlain</code>, <code>copyTableMarkdown</code>, <code>tableToMarkdownLines</code>, <code>formatCellForMarkdown</code>, <code>exportTableCSV</code>, <code>exportTableJSON</code>, <code>exportTableXLSX</code>, <code>exportTablePDF</code>, <code>exportAllBtnHandler</code>. <br>8. <strong>Source snapshot & mapping</strong> — IIFE <code>attachSourceSnapshotters</code>, <code>getPreferredSourceForTable</code>, <code>findMarkdownTableBlocks</code>, <code>splitSourceByBlankLines</code>. <br>9. <strong>Init & events</strong> — <code>initRenderedContent</code>, DOMContentLoaded/ready path, global click delegations for sort and TOC links, keybindings (<code>/</code>, <code>Escape</code>), <code>backToTop</code>. <br>10. <strong>Exports & integration</strong> — exposes <code>PasteToTable.initRenderedContent</code>, <code>PTTable.buildTocs</code>, and many <code>window.*</code> helpers for host usage.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Key functions (concise per-function notes)</strong><br><strong>safe(fn)</strong> — wrapper executes <code>fn()</code> catching exceptions; returns <code>undefined</code> on error. Use: protect optional one-off calls.<br><strong>isString(x)</strong> — strict <code>typeof x === &quot;string&quot;</code> predicate used across markdown/source helpers.<br><strong>copyToClipboard(text)</strong> — adaptive copy: uses <code>navigator.clipboard.writeText</code> when available; falls back to hidden <code>&lt;textarea&gt;</code> + <code>document.execCommand(&#x27;copy&#x27;)</code>. Returns Promise; rejects on failure. Handles focus/select and cleans up element. <br><strong>downloadBlob(blob, filename)</strong> — creates <code>ObjectURL</code>, injects hidden <code>&lt;a download&gt;</code>, clicks, schedules cleanup + revoke. Best-effort; silent on error. <br><strong>showToast(...)</strong> — delegates to host <code>tvUtils.showToast</code> or global <code>showToast</code>; final fallback logs to console. Used for user feedback on exports/copy. <br><strong>debounce(fn, wait)</strong> — fallback debounce (simple timeout) if host <code>tvUtils.debounce</code> absent. <br><strong>sanitizeText(s)</strong> — safe trimming with try/catch. <br><strong>getContentRoot()</strong> — returns content container (<code>#content</code>, <code>#tables-viewer</code>, or <code>document.body</code>) with try/catch fallback. <br><strong>_findTocBarUl(tocBar)</strong> — ensures a <code>&lt;ul&gt;</code> exists inside tocBar; returns existing <code>#tocBarList</code> or creates one. Defensive about nulls. <br><strong>buildSingleTableToc()</strong> — when a single table exists, finds canonical wrapper and table rows, creates stable per-row anchors (<code>tv-row-N</code>), sets <code>tabindex=-1</code>, builds list items in <code>#tocBar</code> with click handlers that smooth-scroll and focus target. Idempotent: clears existing <code>ul</code> children. Avoids inventing captions; uses row text summarization for labels. <br><strong>buildTocFromCaptions()</strong> — reads server-provided caption-like nodes (<code>.table-caption</code>, <code>.table-title</code>, <code>.table-heading</code>), ensures unique IDs without creating caption nodes, builds TOC entries in <code>#toc</code> and <code>#tocBar</code> by cloning list nodes. If none found, clears existing TOC lists. Click handlers similar to <code>buildSingleTableToc</code>. <br><strong>buildTocs()</strong> — integration entry that prefers <code>window.PTToc.init/build()</code> with specific selectors; falls back to <code>buildSingleTableToc</code> and <code>buildTocFromCaptions</code> and schedules delayed re-runs for dynamic content. <br><strong>safeGetTBody(table)</strong> — returns first <code>tBodies[0]</code> or <code>null</code> safely. <br><strong>_ensureRowUidsAndSnapshot(table, tableIdx)</strong> — assigns stable <code>data-tv-uid</code> to each row and stores original order into <code>originalRowOrders[tableIdx]</code> for stable restore; increments <code>_tv_row_uid_counter</code>. <br><strong>updateHeaderSortUI(tableIdx)</strong> — updates header button classes (<code>sort-state-0/1/2</code>), sets <code>aria-sort</code>, and swaps inline SVGs inside <code>.sort-icon</code> according to <code>sortStates</code>. Defensive DOM checks. <br><strong>sortTableByColumn(tableIdx, colIdx)</strong> — three-state sort cycle: (0) default → ascending numeric/lexicographic, (1) ascending → descending, (2) descending → restore original order using <code>originalRowOrders</code>. Numeric detection: <code>parseFloat</code> after removing commas/spaces. Preserves <code>data-orig-html</code> for cells, appends rows to tbody in new order, normalizes other header states to <code>0</code>, updates UI and row counts. <br><strong>headerSortButtonClicked(tableIdx, colIdx, btnEl)</strong> — simple wrapper to call <code>sortTableByColumn</code> and focus the button. Exposed on <code>window</code>. <br><strong>toggleTable(btn)</strong> — collapse/expand a single wrapper's tbody by toggling <code>display: none</code> and ARIA label & button text; updates <code>toggleAllBtn</code> text and calls <code>updateRowCounts</code>. Exposed. <br><strong>toggleAllTables()</strong> — toggles all wrappers collapsed/expanded collectively; updates per-wrapper toggle labels and <code>toggleAllBtn</code> label; calls <code>updateRowCounts</code>. Exposed. <br><strong>updateRowCounts()</strong> — per-wrapper row counting UI: writes "Showing X rows" or "Showing V of T rows" into <code>.row-count</code> elements; accounts for hidden rows (display: none). Robust to missing wrappers. <br><strong>formatCellForMarkdown(cell)</strong> — escapes pipe <code>|</code> with <code>\|</code>, replaces newlines with <code>&lt;br&gt;</code> and returns string suitable for inline pipe-markdown cell. Used by <code>tableToMarkdownLines</code>. <br><strong>tableToMarkdownLines(table, title)</strong> — builds array of markdown lines: optional bold title, header row from <code>rows[0]</code>, separator <code>---</code>, then data rows using <code>formatCellForMarkdown</code>; safe for empty tables. <br><strong>attachSourceSnapshotters() (IIFE)</strong> — binds input listener on <code>#paste</code> to set <code>window.__tv_last_source</code> on edits; captures click on convert buttons to snapshot and set <code>__tv_last_source_ts</code>. Idempotent and defensive. <br><strong>findMarkdownTableBlocks(source)</strong> — parses raw source into contiguous pipe-table blocks using header+separator detection; returns <code>[{start,end,lines}]</code>. Conservative rules: looks for <code>|</code> lines and <code>-</code> separator. <br><strong>splitSourceByBlankLines(source)</strong> — splits source on blank-line blocks and trims entries; used to match preferred source per table. <br><strong>getPreferredSourceForTable(table)</strong> — attempts to map <code>window.__tv_last_source</code> blocks to a DOM table: strategies — (a) if number of <code>.table-container table</code> equals number of source blocks, pick corresponding indexed block; (b) match by wrapper title proximity to lines near block start; (c) match by header cell content (token/length heuristics); (d) fallback to single block or source with <code>|</code>. Returns block string or <code>null</code>. Defensive: many fall-through heuristics and try/catch wrappers; returns null if uncertain. <br><strong>getWrapperTitle(wrapper)</strong> — read-only lookup for wrapper caption: checks <code>.table-caption</code>, h3/h2/h1, <code>aria-label</code>, and <code>data-table-id</code> dataset attributes; returns empty string if nothing found. Important: does NOT create caption nodes. <br><strong>getTableFromButton(btn)</strong> — resolves table by <code>data-tv-table-index</code> dataset (preferred) or nearest wrapper (<code>.table-wrapper</code>, <code>.table-container</code>, <code>[data-table-id]</code>) and returns the table element. Defensive parsing of dataset. <br><strong>copyTablePlain(btn)</strong> — copies tab-separated table text: builds title + rows (cells joined by <code>\t</code>), tries <code>tvUtils.showCopyModal</code> if available, else <code>copyToClipboard</code> then toasts success/failure with fallback to show modal on failure. If no table, falls back to <code>window.__tv_last_source</code>. Shows warnings if nothing to copy. Exposed on <code>window</code>. <br><strong>copyTableMarkdown(btn)</strong> — tries <code>getPreferredSourceForTable</code> first and copies raw markdown when available; otherwise builds markdown via <code>tableToMarkdownLines</code> and copies it; falls back to <code>__tv_last_source</code> if table absent. Uses same modal/copy/toast pattern as plain copy. Exposed. <br><strong>sanitizeFileName(name)</strong> — strips invalid filesystem characters, trims to 160 chars, default "table". Used by exports. <br><strong>exportTableCSV(btn, { filename } )</strong> — builds CSV from table rows with proper quoting for <code>&quot;</code> and <code>,</code> and newline handling; prepends BOM <code>\uFEFF</code>; uses <code>downloadBlob</code> to trigger save. Uses wrapper title or provided filename. Toasts. Exposed. <br><strong>exportTableJSON(btn, { filename })</strong> — extracts headers from <code>thead</code> or first row fallback <code>ColN</code>, builds array of objects (keys→cell text), stringifies prettily, creates Blob and triggers <code>downloadBlob</code>. Exposed. <br><strong>exportTableXLSX(btn, { filename })</strong> — attempts true XLSX export via SheetJS (<code>window.XLSX.utils</code>) if available (supports <code>writeFile</code> or <code>write</code> paths). If SheetJS missing, falls back to TSV saved with Excel-compatible MIME and warns. Uses <code>aoa</code> conversion of table rows. Exposed. <br><strong>exportTablePDF(btn, { filename })</strong> — builds small standalone HTML doc (inline styles), opens new window/tab, writes document and calls <code>print()</code> to let user save as PDF; toasts on failure. Exposed. <br><strong>clearHighlights(cell)</strong> — restores <code>cell.innerHTML</code> from <code>data-orig-html</code> if present, else unwraps <code>&lt;mark&gt;</code> elements by replacing them with text nodes. Non-destructive. <br><strong>normalizeForSearchLocal(s)</strong> — Unicode-aware normalization: prefers host <code>__tv_utils.normalizeForSearchLocal</code>; otherwise attempts <code>toLowerCase().normalize(&quot;NFD&quot;)</code>, strips diacritics, removes non-letter/number/space using <code>\p{L}\p{N}</code> with <code>u</code> flag, falls back to <code>\w</code>. Defensive try/catch branches for environment support. <br><strong>buildNormalizedMapForCell(cell)</strong> — builds a normalized string and a positional <code>map</code> linking each normalized character back to a specific text node and offset. Uses a TreeWalker to collect text nodes, iterates by codepoints (handles surrogate pairs), applies NFD decomposition and diacritic stripping, and preserves per-character mapping for accurate highlight insertion. Returns <code>{normStr, map, nodes}</code>. <br><strong>highlightMatches(cell, filterNorm)</strong> — uses <code>buildNormalizedMapForCell</code> to find matches of normalized needle inside <code>normStr</code>, computes start/end node/offsets for each match, then wraps matched text ranges in <code>&lt;mark&gt;</code> elements. Works backward from end to start to preserve offsets; supports matches spanning multiple text nodes by extracting and moving nodes under <code>&lt;mark&gt;</code>. Respects <code>data-orig-html</code> to reset first. <br><strong>searchTable()</strong> — main search entry: reads search input (multiple selectors), computes <code>filterNorm</code>, iterates tables and rows, clears previous highlights, hides non-matching rows (<code>display: none</code>), applies <code>highlightMatches</code> if <code>window.tvConfig.highlight</code> truthy, scrolls to firstMatch smoothly, requests table virtualizer refresh if present, and updates row counts. Exposed. <br><strong>optimizeTableControls()</strong> — responsive control layout adjustments: detects mobile via <code>(max-width:600px)</code>, moves copy buttons into <code>.copy-buttons</code> container, repositions toggle button to left, applies per-button inline style adjustments for mobile vs desktop. Uses best-effort DOM mutations; non-destructive. Debounced and bound to <code>resize</code>/<code>matchMedia</code> change. <br><strong>initRenderedContent()</strong> — consolidated initialization: wraps standalone tables into <code>.table-container</code> if missing, calls <code>buildTocs</code>, ensures row uids/snapshots, caches <code>data-orig-html</code>, updates header UI icons, sets toggle button labels, creates <code>backToTop</code> if missing, wires search box listeners (debounced), attaches per-table handlers for copy/export/toggle buttons (idempotent via dataset flags), calls <code>optimizeTableControls</code>, <code>updateRowCounts</code>, and scrolls first table into view. Idempotent and safe to call multiple times. Exposed via <code>PasteToTable.initRenderedContent</code>. <br><strong>exportAllBtnHandler()</strong> — collects all <code>.table-wrapper</code> tables and does multi-sheet XLSX export if SheetJS present; otherwise concatenates markdown for all tables and downloads as <code>all_tables.md</code>. Uses <code>getWrapperTitle</code> for sheet names (limited to 31 chars). Exposed. <br><strong>backToTop()</strong> — smooth scroll to top; exposed and bound to <code>backToTop</code> button. <br><strong>Event delegations & global listeners</strong> — two delegated <code>document.click</code> handlers: (1) sorting via <code>.sort-btn</code> / <code>.th-with-sort</code> detection which maps to <code>headerSortButtonClicked</code>; (2) TOC link clicks under <code>#tocBar</code> to smooth-scroll to id or wrapper. <code>window.scroll</code> listener toggles <code>#backToTop</code> visibility. Keydown listener (<code>/</code> to focus search; <code>Escape</code> triggers backToTop) bound on init. Many listeners are defensive and wrapped.                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Defensive patterns used</strong><br>- Ubiquitous <code>try/catch</code> to avoid breaking host pages.<br>- Feature detection for <code>navigator.clipboard</code>, <code>window.XLSX</code>, <code>window.PTToc</code>, <code>window.tvUtils</code>, <code>window.__tv_utils</code>.<br>- Idempotent init: uses dataset flags (<code>tvBound</code>, <code>tvHandlerAttached</code>) and checks for existing wrappers/elements before creation.<br>- Non-destructive content handling: caches original HTML in <code>data-orig-html</code> and uses it to restore highlights; does not create caption elements (read-only principle).<br>- Unicode-aware processing with fallbacks: uses <code>\p{L}\p{N}</code> where supported, falls back to <code>\w</code> when not. Handles surrogate pairs and diacritics explicitly. <br>- Accessibility considerations: sets <code>tabindex=-1</code> on row anchors, <code>aria-sort</code> proper values, <code>aria-label</code> on anchors, and updates <code>aria-expanded</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Notable behaviors & integration choices</strong><br>- <strong>Caption safety</strong>: intentionally reads caption-like nodes only; never creates captions; avoids content injection. <br>- <strong>Source-first copy</strong>: <code>copyTableMarkdown</code> prefers the original source block (<code>__tv_last_source</code>) when it confidently maps to a table — preserves author intent and runtime provenance. <br>- <strong>SheetJS optional</strong>: XLSX exports prefer SheetJS but provide TSV fallback for environments where SheetJS isn't loaded. <br>- <strong>UI styling</strong>: many inline style manipulations inside <code>optimizeTableControls</code> to ensure control layout without requiring external CSS; acceptable but may clash with strict CSP or theming. <br>- <strong>Search tokenization</strong>: <code>normalizeForSearchLocal</code> aggressively strips punctuation but attempts robust Unicode normalization; this behavior affects what is considered a match (good for accent-insensitive search). <br>- <strong>Non-blocking UX</strong>: debounced search, delayed re-builds (<code>setTimeout</code>), and best-effort layout moves reduce layout thrashing on init.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Performance & scalability notes</strong><br>- <strong>Highlighting complexity</strong>: <code>buildNormalizedMapForCell</code> iterates every text node and every character by codepoint; for very large cells or tables with thousands of rows, highlighting can be CPU-heavy. Consider throttling or virtualizing highlight operations for very large tables. <br>- <strong>Sorting stability</strong>: restoring original order relies on <code>originalRowOrders</code> captured on init; subsequent DOM mutations (rows added/removed) may desynchronize snapshots — callers must re-run <code>initRenderedContent</code> when tables change. <br>- <strong>I/O & Blob generation</strong>: export functions create in-memory strings/blobs; exporting extremely large tables may cause memory spikes. Suggest streaming exports for huge datasets or server-side export endpoints. <br>- <strong>DOM reflows</strong>: <code>optimizeTableControls</code> manipulates inline styles and element insertion per-wrapper; on pages with many wrappers this can cause layout churn. Debounced invocation mitigates but consider batching or CSS-only approach.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Security, privacy & CSP considerations</strong><br>- <strong>CSP</strong>: inline <code>style</code> assignments and <code>innerHTML</code> usage for SVG icons and <code>table.outerHTML</code> in PDF export may be blocked by CSP policies. Recommend providing CSS classes and using safe DOM methods for icons (SVG <code>&lt;use&gt;</code> or CSS). <br>- <strong>HTML injection risk</strong>: <code>updateHeaderSortUI</code> uses <code>innerHTML</code> to insert SVG markup; it's low-risk but ensure the SVG strings are constant and not influenced by user input. <br>- <strong>Clipboard fallback</strong>: using <code>document.execCommand(&#x27;copy&#x27;)</code> relies on DOM insertion of a textarea; some environments may restrict clipboard access — fallback shows copy modal when available. <br>- <strong>Open window printing</strong>: <code>exportTablePDF</code> opens a new window and writes <code>table.outerHTML</code> into it. If a host page's table contains sensitive inline scripts or event handlers, those are serialized to HTML but not executed in the new doc; still verify sanitized content if host requires strict privacy.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Bugs / risky assumptions / edge cases</strong><br>1. <strong>Header detection for markdown</strong>: <code>tableToMarkdownLines</code> assumes the first row is header; pages using <code>thead</code> properly are fine, but tables with multi-row headers or no explicit header may produce poor markdown. <br>2. <strong>Original-order restoration fragility</strong>: <code>originalRowOrders</code> keyed by <code>tableIdx</code> is captured during <code>initRenderedContent</code>. If tables reflow or DOM order changes (insertion/removal), <code>tableIdx</code> may no longer map to the same table. Consider using a Map keyed by a stable table identifier (e.g., <code>data-table-id</code> or <code>table</code> element reference) instead of numeric index. <br>3. <strong>normalizeForSearchLocal fallback inconsistency</strong>: fallback branch uses <code>\w</code> which includes underscore and digits but may behave differently across locales; tests required for CJK behavior. <br>4. <strong>Highlight spanning complex nodes</strong>: <code>highlightMatches</code> extracts and reparent nodes between start and end text nodes; it can break if those nodes cross element boundaries with non-text children (e.g., images, nested tags with event handlers) — need to ensure semantic integrity when reparenting. <br>5. <strong>Performance on large tables</strong>: search + highlight on many rows can be slow; no in-page virtualization by default. If <code>tableVirtualizer</code> exists it's refreshed, but file does not include a fallback virtualizer. <br>6. <strong>Button wiring limited selectors</strong>: handlers are attached to first matching selector per wrapper (<code>wrapper.querySelector(h.sel)</code>); if a wrapper contains multiple identical buttons, only the first is wired. Intention may be to wire primary action only — document this. <br>7. <strong>Event delegation duplication</strong>: two <code>document.addEventListener(&quot;click&quot;, ...)</code> handlers are defined; they are targeted and safe but could be consolidated for clarity. <br>8. <strong>CSV BOM use</strong>: <code>exportTableCSV</code> prepends <code>\uFEFF</code> universally; while good for Excel/UTF-8 detection, some consumers may prefer raw CSV without BOM. Consider configurability.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Maintainability observations</strong><br>- File is well-structured with clear regions (TOC, sorting, export, search). Abundant try/catch makes logic safe but noisy; consider scoping common try/catch wrapper utility to reduce repetition. <br>- Many implicit globals and dataset flags: document expected dataset keys (<code>tvTableIndex</code>, <code>tvHandlerAttached</code>, <code>tvBound</code>) and global hooks (<code>tvUtils</code>, <code>tvConfig</code>, <code>PTToc</code>, <code>XLSX</code>, <code>tableVirtualizer</code>). <br>- Inline SVG strings and style manipulations are duplicated in <code>updateHeaderSortUI</code> and <code>optimizeTableControls</code>; factor to shared utilities or small templates for clarity. <br>- Consider extracting heavy text-processing (normalization + map building) into a dedicated module to enable unit tests and performance optimization.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Concrete recommended fixes (priority order)</strong><br><strong>High-priority</strong><br>- Replace <code>originalRowOrders[tableIdx]</code> indexing with a Map keyed by a stable identifier (e.g., <code>table.dataset.tableId</code> or <code>table</code> element reference via <code>WeakMap</code>) to ensure restore correctness after DOM changes. <br>- Limit highlight work for very large cells/tables: add a maximum length/rows threshold before enabling fine-grained <code>highlightMatches</code>, or progressively highlight visible viewport rows only (integrate with virtualizer). <br>- Make CSV BOM prepend configurable via <code>tvConfig.exportBom</code> to support host preferences. <br><strong>Medium-priority</strong><br>- Make handlers attach to <code>querySelectorAll(h.sel)</code> instead of first <code>querySelector</code> when multiple identical buttons should be wired; or document the intended single-button assumption. <br>- Add a <code>PTTable.rebuild()</code> API that re-captures <code>originalRowOrders</code>, rebinds handlers, and reinitializes snapshots for dynamic content injection. <br><strong>Low-priority / niceties</strong><br>- Move inline SVG icon templates into small functions <code>getSortIcon(state)</code> to reduce duplication. <br>- Replace many <code>try/catch</code> blocks with <code>safe(()=&gt;...)</code> helper where appropriate to reduce noise and ensure consistent error reporting.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Suggested tests</strong><br><strong>Unit</strong>: <code>findMarkdownTableBlocks</code> edge cases (multiline cells, stray pipes), <code>getPreferredSourceForTable</code> with varied source layouts, <code>normalizeForSearchLocal</code> with accented/emoji/CJK text, <code>buildNormalizedMapForCell</code> mapping accuracy (with surrogate pairs). <br><strong>Integration</strong>: <code>copyTablePlain</code> and <code>copyTableMarkdown</code> success/failure paths including clipboard API absence; <code>exportTableXLSX</code> SheetJS vs fallback; <code>buildSingleTableToc</code> idempotence and unique ID collision handling. <br><strong>Performance</strong>: highlight throughput on large table (10k rows), sorting on wide tables (100+ columns), repeated <code>initRenderedContent</code> calls for dynamic DOM. <br><strong>Accessibility</strong>: <code>aria-sort</code>, <code>aria-expanded</code>, <code>tabindex</code> behavior and keyboard focus after anchor clicks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Compatibility & integration checklist</strong><br>- Document optional global hooks: <code>tvUtils</code> (copy/download/toast/debounce), <code>PTToc</code> (external TOC builder), <code>tvConfig</code> (highlight, debounceMs), <code>XLSX</code> (SheetJS), <code>tableVirtualizer</code>. <br>- Ensure CSP compatibility: provide CSS-only alternative or host-provided nonce for inline styles if required. <br>- Expose <code>PTTable.rebuild</code> (recommended) to allow host to re-run snapshots after dynamic DOM changes. <br>- Recommend host opt-in for <code>tvConfig.highlight</code> to avoid heavy DOM changes on pages with large tables.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Potential regressions to watch for when changing code</strong><br>- Changing <code>normalizeForSearchLocal</code> regex can alter search results and highlight positions; ensure backward-compatible normalization or configurable normalizer. <br>- Altering <code>data-orig-html</code> handling or clearing strategy may break highlight restoration and custom cell formatting. <br>- Moving inline style logic into classes without preserving all adjustments may change appearance on smaller screens; provide default CSS to maintain parity.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Final concise verdict</strong><br>Comprehensive, defensive, and integration-friendly table utility module with strong emphasis on caption-safety and preserving source provenance. Primary risks are performance of per-character normalized mapping & highlight on large tables, fragility of row-order restoration using numeric indexes, and inline-style/CSP concerns. Addressing the high-priority fixes (stable original-order tracking, highlight throttling/virtualization, and configurable CSV BOM) plus adding a public <code>rebuild()</code> API and unit tests will make this production-ready and robust for dynamic host environments. Reviewed carefully and cross-checked against the provided file for completeness. </td></tr></tbody></table></div><div class="row-count">Rows: 14</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>