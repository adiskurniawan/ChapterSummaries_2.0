<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1763610405">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#Table6">Table 6</a></li>
<li class="toc-item"><a class="toc-link" href="#Table7">Table 7</a></li>
<li class="toc-item"><a class="toc-link" href="#Table8">Table 8</a></li>
<li class="toc-item"><a class="toc-link" href="#Table9">Table 9</a></li>
<li class="toc-item"><a class="toc-link" href="#Table10">Table 10</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0121_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Area / Change"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Area / Change</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by World-class fix (concise, actionable)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">World-class fix (concise, actionable)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Area / Change"> <strong>Caption ownership (core change)</strong>           </td><td data-label="World-class fix (concise, actionable)"> <em>Stop rendering visible caption HTML in <code>render_table</code>.</em> Instead have <code>render_table</code> return <code>(html_fragment, caption_fragments)</code> where <code>caption_fragments</code> is a list of canonical objects: <code>{ id: &quot;table-017&quot;, fragment_id: &quot;frag-2025-0001&quot;, text: &quot;My caption&quot;, type: &quot;table&quot;, source: {...} }</code>. The server emits the HTML fragment <strong>and</strong> an adjacent payload script: <code>&lt;script data-caption-payload type=&quot;application/json&quot;&gt;JSON.stringify({ captions: [...], wrapper_id: &quot;table-017&quot; })&lt;/script&gt;</code>. Client only positions captions. Add an option <code>emit_captions_inline=False</code> for backward compatibility. </td></tr><tr><td data-label="Area / Change"> <strong>Canonical IDs / Deterministic mapping</strong>     </td><td data-label="World-class fix (concise, actionable)"> Use one canonical identifier for both wrapper and caption: <code>data-table-id=&quot;table-017&quot;</code> and <code>fragment_id: &quot;table-017&quot;</code> (or use <code>frag-</code> prefix from <code>core_fragments</code>). Remove <code>Table{idx}</code> vs <code>table-{idx}</code> duality. Prefer deterministic IDs derived from file path + table index (or stable hash) so re-renders preserve mapping. Ensure <code>core_fragments</code> is source-of-truth for IDs and accept <code>fragment_id</code> param into <code>render_table</code>.                                                                                                                                                                       </td></tr><tr><td data-label="Area / Change"> <strong>Caption sanitization & JSON safety</strong>        </td><td data-label="World-class fix (concise, actionable)"> Before JSON emission run <code>sanitize.py</code> on caption text. Never embed raw NULs or raw backtick placeholders in JSON. Replace NUL placeholders with safe token format: <code>__PTT_CODE_{n}__</code> (ASCII alphanum + underscores) or base64-encode payloads that include arbitrary bytes. Ensure <code>json.dumps()</code> of payload uses <code>ensure_ascii=False</code> and proper escaping. Add unit test that round-trips code spans through stash→render→JSON→client injection.                                                                                                                                                            </td></tr><tr><td data-label="Area / Change"> <strong>Code-span stash / placeholder robustness</strong>  </td><td data-label="World-class fix (concise, actionable)"> Replace <code>\x00CODE{n}\x00</code> with safe marker <code>__PTT_PLACEHOLDER_{n}__</code>. This avoids NULs in strings and JSON, avoids issues with certain text encodings and editors, and keeps the mapping deterministic. Keep mapping array for restore; when emitting JSON, either omit raw original code or encode it in an array with index → original string (base64 if necessary).                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Area / Change"> <strong>Server payload contract (strict schema)</strong>   </td><td data-label="World-class fix (concise, actionable)"> Define a minimal JSON schema and document it: <code>{ wrapper_id, table_index, captions: [{ fragment_id, id, text_html, text_plain, type, source_file, source_line, index }], alignments: [...], meta: {...} }</code>. Validate payload against schema before emitting. Include version field <code>caption_payload_version: &quot;1.0&quot;</code>.                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Area / Change"> <strong>Render flow: single-responsibility split</strong>  </td><td data-label="World-class fix (concise, actionable)"> <code>convert.py</code> builds table rows and wrapper HTML skeleton only. A small helper <code>caption_builder.py</code> (or <code>core_fragments</code>) constructs CaptionFragments and stable IDs. <code>html_renderer.py</code> emits skeleton + payload <code>&lt;script&gt;</code>. Keep roles single-responsibility so tests can target each step.                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Area / Change"> <strong>CSV detection & parsing robustness</strong>        </td><td data-label="World-class fix (concise, actionable)"> Improve <code>_looks_like_csv</code>: use delimiter-score based on median field count, presence of quoted fields, and CSV quoting consistency, not only most-common count. Prefer <code>csv.Sniffer</code> but fall back to deterministic scoring: compute per-delim variance of field counts; choose the delimiter with lowest variance and mean>1. Provide <code>force_delimiter</code> option. Add tests with mixed delimiters, quoted fields, and header/no-header heuristics.                                                                                                                                                              </td></tr><tr><td data-label="Area / Change"> <strong>Markdown renderer & inline handling</strong>       </td><td data-label="World-class fix (concise, actionable)"> Accept a pluggable markdown renderer via <code>markdown_to_html_func</code>; add <code>markdown_features</code> flags (allow_lists, allow_fenced_code, allow_html). For fallback renderer, preserve as plaintext rather than attempt limited formatting; avoid producing inconsistent <code>&lt;p&gt;</code> wrappers. Normalize single-line cell breaks consistently (convert single <code>\n</code> → <code>&#x27;  \n&#x27;</code> <strong>only</strong> when not in code/fenced blocks).                                                                                                                                                                                                       </td></tr><tr><td data-label="Area / Change"> <strong>List normalization & nested lists</strong>         </td><td data-label="World-class fix (concise, actionable)"> Replace fragile ad-hoc list code with a small deterministic normalization pass:<br>1. detect fenced blocks and skip;<br>2. for non-fenced, convert leading numeric/bullet variants to canonical markers (<code>1.</code> / <code>- </code>) while preserving indent levels;<br>3. feed normalized block to markdown renderer.<br>Keep test vectors for nested lists and corner cases (em dash bullets, localized bullets).                                                                                                                                                                                                           </td></tr><tr><td data-label="Area / Change"> <strong>Column type detection & alignment</strong>         </td><td data-label="World-class fix (concise, actionable)"> Make <code>_detect_column_types</code> tolerant: sample up to configurable N rows, treat columns as numeric only if ≥70% parseable numeric after cleaning (remove currency, commas, parentheses). Expose <code>alignment_overrides</code> option. Add fallback to server-side metadata <code>data-table-alignments</code> but do not rely on it for logic — it's presentation hint only.                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Area / Change"> <strong>HTML generation: skeleton and ARIA</strong>        </td><td data-label="World-class fix (concise, actionable)"> Emit semantic skeleton only: wrapper with <code>data-table-id</code>, <code>data-table-index</code>, <code>data-table-alignments</code>; table <code>&lt;table role=&quot;table&quot;&gt;</code> with <code>&lt;thead&gt;</code>/<code>&lt;tbody&gt;</code>. Do <strong>not</strong> emit caption HTML. For accessibility include <code>aria-describedby</code> on table pointing to a stable caption container id if client will inject <code>&lt;caption&gt;</code> or <code>.table-caption</code>. Example: <code>&lt;div data-table-id=&quot;table-017&quot; id=&quot;table-wrapper-table-017&quot; aria-describedby=&quot;caption-table-017&quot;&gt;</code> then client injects element with id <code>caption-table-017</code>.                                                                                      </td></tr><tr><td data-label="Area / Change"> <strong>Client contract & injectCaptions() shape</strong>  </td><td data-label="World-class fix (concise, actionable)"> Define <code>injectCaptions(payload)</code> signature: <code>payload = { wrapper_id, captions: [...] }</code>. Client must: 1) find wrapper by <code>data-table-id</code>, 2) if caption element already exists — update text (idempotent), 3) otherwise create caption element (preferred: <code>&lt;caption class=&quot;table-caption&quot; id=&quot;caption-{id}&quot;&gt;…&lt;/caption&gt;</code>) and insert before table element or into proper DOM location. Client MUST NOT synthesize caption text. Provide small pseudo-code block in docs for <code>script.core.js</code> consumer.                                                                                                        </td></tr><tr><td data-label="Area / Change"> <strong>Backward compatibility & opt-in migration</strong> </td><td data-label="World-class fix (concise, actionable)"> Add <code>emit_captions_inline=True</code> option to keep legacy behavior during rollout. When turning off, run an integration test where payload script is emitted and client runs <code>injectCaptions</code> to ensure parity. Log a deprecation warning in metadata for one release.                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Area / Change"> <strong>Performance & streaming</strong>                   </td><td data-label="World-class fix (concise, actionable)"> For very large tables, offer a streaming renderer variant that yields HTML parts and a small final payload. Avoid building enormous <code>parts</code> lists — use <code>io.StringIO</code> or write generator yield to reduce peak memory. Provide <code>render_table(..., stream=True)</code> or <code>render_into(writer)</code> hook.                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Area / Change"> <strong>Security (XSS / HTML safety)</strong>              </td><td data-label="World-class fix (concise, actionable)"> Sanitize all cell HTML produced by external markdown renderer using <code>sanitize.py</code> before embedding. Caption <code>text_html</code> should be either pre-sanitized HTML or <code>text_plain</code> only — never both untrusted. Use CSP-compatible safe payloads and never <code>innerHTML</code> un-sanitized on client. Document required client sanitization/DOM insertion rules.                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Area / Change"> <strong>Testing strategy (world-class)</strong>            </td><td data-label="World-class fix (concise, actionable)"> Unit tests for each helper (stash/restore, split_row_keep_code, csv sniff, list normalization). Integration tests for round-trip: Markdown→convert→payload→client-injection (simulate DOM) verifying no duplicate captions and stable anchors. Add property/fuzz tests for CSVs and table edge cases. Add CI checks for pandas/no-pandas mode. Add snapshot tests of payload JSON schema.                                                                                                                                                                                                                      </td></tr><tr><td data-label="Area / Change"> <strong>Logging & telemetry</strong>                       </td><td data-label="World-class fix (concise, actionable)"> Emit structured debug logs when heuristic falls back (e.g., CSV autodetect fallback, stash failures). Add <code>metadata[&quot;warnings&quot;]</code> and <code>metadata[&quot;id_map&quot;]</code> to <code>convert_text_to_html</code> return for easier server-side auditing.                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Area / Change"> <strong>Migration patch outline (concrete steps)</strong>  </td><td data-label="World-class fix (concise, actionable)"> 1. Add <code>CaptionFragment</code> model in <code>core_fragments</code>.<br>2. Change <code>render_table</code> to return <code>(html, caption_fragments)</code> and add <code>emit_captions_inline</code> flag.<br>3. Add <code>html_renderer</code> emitter to write <code>&lt;script data-caption-payload&gt;</code> adjacent to each table wrapper.<br>4. Update <code>sanitize.py</code> to include <code>sanitize_caption_for_json()</code> and safe placeholder policy.<br>5. Update client <code>script.core.js</code>/<code>script.table.js</code> to parse payload and call <code>injectCaptions(payload)</code>.<br>6. Run full test matrix and stage rollout with <code>emit_captions_inline=True</code> default → then flip.                          </td></tr><tr><td data-label="Area / Change"> <strong>Quick example payload (minimal)</strong>           </td><td data-label="World-class fix (concise, actionable)"> <code>{&quot;wrapper_id&quot;:&quot;table-017&quot;,&quot;table_index&quot;:17,&quot;captions&quot;:[{&quot;fragment_id&quot;:&quot;frag-2025-0001&quot;,&quot;id&quot;:&quot;table-017&quot;,&quot;type&quot;:&quot;table&quot;,&quot;text_html&quot;:&quot;&lt;strong&gt;Topic 17&lt;/strong&gt;&quot;,&quot;text_plain&quot;:&quot;Topic 17&quot;,&quot;source&quot;:{&quot;file&quot;:&quot;doc.md&quot;,&quot;line&quot;:123}}],&quot;alignments&quot;:[&quot;left&quot;,&quot;right&quot;,&quot;left&quot;],&quot;version&quot;:&quot;1.0&quot;}</code>                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Area / Change"> <strong>Developer checklist before flip</strong>           </td><td data-label="World-class fix (concise, actionable)"> core_fragments deterministic IDs ✅<br>sanitize.py JSON-safe ✅<br>client injectCaptions idempotent ✅<br>tests green (unit+integration+snapshot) ✅<br>backward compatibility toggle present ✅<br>rollout plan documented ✅.                                                                                                                                                                                                                                                                                                                                                                                      </td></tr></tbody></table></div><div class="row-count">Rows: 20</div></div><div class="table-caption" id="Table2" data-table="Docu_0121_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Area / Change"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Area / Change</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by World-class fix (concise, actionable)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">World-class fix (concise, actionable)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Area / Change"> <strong>Caption ownership (core change)</strong>           </td><td data-label="World-class fix (concise, actionable)"> Stop emitting visible caption HTML from <code>render_table</code>. Change <code>render_table(...)</code> to return <code>(html_fragment, caption_fragments)</code> where each fragment is <code>{ id, fragment_id, text_html, text_plain, type, source }</code>. Emit adjacent payload script when <code>emit_captions_inline=False</code>: <code>&lt;script data-caption-payload type=&quot;application/json&quot;&gt;...&lt;/script&gt;</code>. Keep <code>emit_captions_inline</code> flag for rollback.                                                                                                                                            </td></tr><tr><td data-label="Area / Change"> <strong>Canonical IDs / Deterministic mapping</strong>     </td><td data-label="World-class fix (concise, actionable)"> Use a single canonical ID scheme for wrapper and fragment (e.g. <code>table-017</code> / <code>frag-2025-0001</code>). Derive deterministically from file path + index or a stable hash. Stop dual <code>Table{idx}</code> vs <code>table-{idx}</code> forms. Make <code>core_fragments</code> authoritative and accept <code>fragment_id</code> in <code>render_table</code>.                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Area / Change"> <strong>Caption sanitization & JSON safety</strong>        </td><td data-label="World-class fix (concise, actionable)"> Run <code>sanitize.py</code> on caption text before JSON emission. Replace NULs/unsafe bytes with safe tokens <code>__PTT_PLACEHOLDER_{n}__</code> or base64-encode binary pieces. Use <code>json.dumps(..., ensure_ascii=False)</code> and validate the produced JSON. Add unit test to round-trip code spans through stash→render→JSON→client injection.                                                                                                                                                                                                                           </td></tr><tr><td data-label="Area / Change"> <strong>Code-span stash / placeholder robustness</strong>  </td><td data-label="World-class fix (concise, actionable)"> Replace <code>\x00CODE{n}\x00</code> with <code>__PTT_PLACEHOLDER_{n}__</code>. Keep a deterministic mapping array <code>[ &quot;...original code...&quot; ]</code>; include only safe tokens in JSON payload and, if needed, include originals in a base64-encoded attachments array. Provide helpers <code>stash_code</code>, <code>restore_code_from_placeholders</code>.                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Area / Change"> <strong>Server payload contract (strict schema)</strong>   </td><td data-label="World-class fix (concise, actionable)"> Define and validate a minimal schema (example fields: <code>caption_payload_version</code>, <code>wrapper_id</code>, <code>table_index</code>, <code>captions: [{fragment_id,id,text_html,text_plain,type,source_file,source_line,index}]</code>). Validate payload before emitting and include <code>version</code> + <code>metadata.warnings</code>.                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Area / Change"> <strong>Render flow: single-responsibility split</strong>  </td><td data-label="World-class fix (concise, actionable)"> Keep responsibilities narrow: <code>convert.py</code> → HTML skeleton; <code>caption_builder.py</code> / <code>core_fragments</code> → fragments & IDs; <code>html_renderer</code> → emit skeleton + <code>&lt;script data-caption-payload&gt;</code>. Unit-test each step independently.                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Area / Change"> <strong>CSV detection & parsing robustness</strong>        </td><td data-label="World-class fix (concise, actionable)"> Replace single-rule sniffing with delimiter scoring (median field count, variance, quoted-field consistency). Prefer <code>csv.Sniffer</code> if available; otherwise choose delimiter with lowest variance and mean>1. Add <code>force_delimiter</code> option and tests for mixed delimiters and quoted fields.                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Area / Change"> <strong>Markdown renderer & inline handling</strong>       </td><td data-label="World-class fix (concise, actionable)"> Accept pluggable <code>markdown_to_html_func</code> and <code>markdown_features</code>. When fallbacking, render plaintext rather than fragile partial HTML. Normalize intra-cell single <code>\n</code> → hard break only outside code/fenced blocks. Provide tests for fenced code, inline code, and single-line cells.                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Area / Change"> <strong>List normalization & nested lists</strong>         </td><td data-label="World-class fix (concise, actionable)"> Implement deterministic normalization pass: detect fenced blocks (skip), canonicalize bullets (<code>1.</code> / <code>- </code>) and preserve indent levels, then feed to markdown renderer. Keep test vectors for nested lists, em-dash bullets, and localized bullets.                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Area / Change"> <strong>Column type detection & alignment</strong>         </td><td data-label="World-class fix (concise, actionable)"> Sample up to configurable <code>N</code> rows; treat column as numeric only if ≥70% parseable after cleaning (strip currency, commas, parentheses). Expose <code>alignment_overrides</code> and accept <code>data-table-alignments</code> as hint only. Document behavior and tests.                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Area / Change"> <strong>HTML generation: skeleton and ARIA</strong>        </td><td data-label="World-class fix (concise, actionable)"> Emit skeleton only: wrapper with <code>data-table-id</code>, <code>id=&quot;table-wrapper-{id}&quot;</code>, <code>aria-describedby=&quot;caption-{id}&quot;</code>; <code>&lt;table role=&quot;table&quot;&gt;&lt;thead&gt;…&lt;/thead&gt;&lt;tbody&gt;…&lt;/tbody&gt;&lt;/table&gt;</code>. Do <strong>not</strong> emit <code>&lt;caption&gt;</code> server-side when using payloads. Client will insert caption element with stable <code>id=&quot;caption-{id}&quot;</code>.                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Area / Change"> <strong>Client contract & injectCaptions() shape</strong>  </td><td data-label="World-class fix (concise, actionable)"> Define <code>injectCaptions(payload)</code> signature: <code>{ wrapper_id, captions: [...] }</code>. Client actions: locate wrapper by <code>data-table-id</code>; idempotently update existing caption or create <code>&lt;caption id=&quot;caption-{id}&quot; class=&quot;table-caption&quot;&gt;…&lt;/caption&gt;</code> placed before table; never synthesize text—use server-provided <code>text_html</code> (sanitized) or <code>text_plain</code>. Provide pseudo-code for <code>script.core.js</code> consumer.                                                                                                                                          </td></tr><tr><td data-label="Area / Change"> <strong>Backward compatibility & opt-in migration</strong> </td><td data-label="World-class fix (concise, actionable)"> Add <code>emit_captions_inline=True</code> default for rollout. Support both modes concurrently: if <code>emit_captions_inline</code> you keep legacy caption HTML; otherwise emit payload script and rely on <code>injectCaptions</code>. Add telemetry <code>metadata[&quot;legacy_mode&quot;]=true/false</code> and deprecation warning in payload metadata.                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Area / Change"> <strong>Performance & streaming</strong>                   </td><td data-label="World-class fix (concise, actionable)"> For large outputs offer <code>render_table(..., stream=True)</code> or <code>render_into(writer)</code> to avoid building huge strings. Use <code>io.StringIO</code>/generators and emit final caption payload as small chunk. Ensure payload emission occurs adjacent to the wrapper to preserve locality.                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Area / Change"> <strong>Security (XSS / HTML safety)</strong>              </td><td data-label="World-class fix (concise, actionable)"> Always sanitize cell HTML and caption HTML server-side with <code>sanitize.py</code>. Emit only pre-sanitized <code>text_html</code> or <code>text_plain</code>. Client must insert via safe methods (createElement, <code>textContent</code> or <code>innerHTML</code> only with trusted sanitized HTML). Document CSP and recommended client insertion patterns.                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Area / Change"> <strong>Testing strategy (world-class)</strong>            </td><td data-label="World-class fix (concise, actionable)"> Unit tests for stash/restore, placeholder tokens, CSV sniff, list normalization, ID determinism. Integration tests for Markdown→convert→payload→client-injection (simulate DOM). Snapshot tests for payload JSON schema. Property/fuzz tests for CSV and edge cases. CI gating before flip.                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Area / Change"> <strong>Logging & telemetry</strong>                       </td><td data-label="World-class fix (concise, actionable)"> Add structured warnings when heuristics fall back (CSV sniff fallback, placeholder collisions). Return <code>metadata[&quot;warnings&quot;]</code> and <code>metadata[&quot;id_map&quot;]</code> from <code>convert_text_to_html</code> for observability.                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Area / Change"> <strong>Migration patch outline (concrete steps)</strong>  </td><td data-label="World-class fix (concise, actionable)"> 1. Add <code>CaptionFragment</code> in <code>core_fragments</code>.<br>2. Change <code>render_table</code> to return <code>(html, caption_fragments)</code> and add <code>emit_captions_inline</code> flag.<br>3. Add <code>html_renderer</code> to emit <code>&lt;script data-caption-payload&gt;</code> adjacent to wrapper.<br>4. Extend <code>sanitize.py</code> with <code>sanitize_caption_for_json()</code> and placeholder policy.<br>5. Update <code>script.core.js</code>/<code>script.table.js</code> to parse payload and call <code>injectCaptions(payload)</code> idempotently.<br>6. Run unit+integration+snapshot tests; start rollout with legacy flag on; flip when stable. </td></tr><tr><td data-label="Area / Change"> <strong>Quick example payload (minimal)</strong>           </td><td data-label="World-class fix (concise, actionable)"> <code>{&quot;caption_payload_version&quot;:&quot;1.0&quot;,&quot;wrapper_id&quot;:&quot;table-017&quot;,&quot;table_index&quot;:17,&quot;captions&quot;:[{&quot;fragment_id&quot;:&quot;frag-2025-0001&quot;,&quot;id&quot;:&quot;table-017&quot;,&quot;type&quot;:&quot;table&quot;,&quot;text_html&quot;:&quot;&lt;strong&gt;Topic 17&lt;/strong&gt;&quot;,&quot;text_plain&quot;:&quot;Topic 17&quot;,&quot;source&quot;:{&quot;file&quot;:&quot;doc.md&quot;,&quot;line&quot;:123}}],&quot;alignments&quot;:[&quot;left&quot;,&quot;right&quot;,&quot;left&quot;],&quot;meta&quot;:{&quot;warnings&quot;:[]}}</code>                                                                                                                                                                                                                       </td></tr><tr><td data-label="Area / Change"> <strong>Developer checklist before flip</strong> </td><td data-label="World-class fix (concise, actionable)"> Ensure:<br>core_fragments deterministic IDs ✅<br>sanitize.py JSON-safe helpers ✅<br>client injectCaptions idempotent ✅<br>unit+integration+snapshot tests green ✅<br>emit_captions_inline toggle present ✅<br>rollout plan & telemetry ✅ </td></tr></tbody></table></div><div class="row-count">Rows: 20</div></div><div class="table-caption" id="Table3" data-table="Docu_0121_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Area / Change"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Area / Change</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by World-class fix (concise, actionable)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">World-class fix (concise, actionable)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Area / Change"> <strong>Caption ownership & server/client contract</strong>      </td><td data-label="World-class fix (concise, actionable)"> Do not emit or synthesize caption HTML in <code>render_fragments_concurrently</code> or <code>_simple_render_table</code>. Instead produce explicit caption fragments in the fragment metadata (<code>fragments_map[idx][&quot;captions&quot;] = [{fragment_id, table_id, text_plain, text_html, source:{file,line}, type, index}]</code>). Ensure <code>content</code> is a skeleton with <code>data-table-id=&quot;table-&lt;id&gt;&quot;</code> and <code>aria-describedby=&quot;caption-&lt;id&gt;&quot;</code> so the client positions captions. Add <code>emit_caption_payload: bool</code> flag to allow old behavior. </td></tr><tr><td data-label="Area / Change"> <strong>Deterministic IDs (table_id / fragment_id)</strong>      </td><td data-label="World-class fix (concise, actionable)"> Add a single helper <code>generate_fragment_id(source, idx)</code> that deterministically derives <code>table-&lt;hex8&gt;</code> from (file-path + table-index + optional anchor) using a stable hash (sha1/hexdigest[:8]). Replace <code>Table{idx}</code> usage. Store <code>fragment_id</code> in <code>fragments_map</code> and expose it in returns.                                                                                                                                                                                                          </td></tr><tr><td data-label="Area / Change"> <strong>Placeholders: remove NULs & make safe tokens</strong>    </td><td data-label="World-class fix (concise, actionable)"> Replace any NUL-based stash with safe alphanumeric tokens <code>__PTT_PLACEHOLDER_{n}__</code>. Include a <code>placeholders</code> array in fragment metadata mapping tokens → original/raw (base64 if binary). When building payload JSON, include placeholders instead of embedding raw bytes.                                                                                                                                                                                                                            </td></tr><tr><td data-label="Area / Change"> <strong>Caption sanitization & JSON embedding</strong>           </td><td data-label="World-class fix (concise, actionable)"> Call <code>sanitize_caption_for_json(text)</code> in <code>sanitize.py</code> before placing in payload. When server emits <code>&lt;script data-caption-payload&gt;</code>, use <code>json.dumps(payload, ensure_ascii=False)</code> and escape <code>&lt;/script&gt;</code> sequences (<code>&#x27;&lt;\/script&gt;&#x27;</code>) to prevent injection. Mark <code>text_html</code> with <code>sanitized: true</code> flag.                                                                                                                                                                                              </td></tr><tr><td data-label="Area / Change"> <strong>_call_render_table return contract</strong>              </td><td data-label="World-class fix (concise, actionable)"> Standardize <code>_call_render_table</code> to return one of: <code>str</code> (html skeleton), or <code>{&quot;html&quot;:..., &quot;assets&quot;:[...], &quot;captions&quot;:[...]}</code>. Normalize this shape in <code>_render_job</code> so <code>content</code>, <code>assets_required</code>, and <code>captions</code> are always known.                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Area / Change"> <strong>ProcessPool picklability & fallback logic</strong>       </td><td data-label="World-class fix (concise, actionable)"> Replace <code>pickle.dumps(renderer)</code> check with a safe attempt: spawn a tiny ProcessPoolExecutor task that imports/uses <code>renderer</code> with a timeout; if it errors, fall back to threads and log the reason. Ensure ordering and indices are preserved when falling back.                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Area / Change"> <strong>Thread/Process ordering & deterministic indices</strong> </td><td data-label="World-class fix (concise, actionable)"> Always enumerate inputs with <code>start=1</code> and use that <code>idx</code> as the authoritative key. When using workers, collect results and assign into <code>fragments_map[idx]</code> so completion order cannot change mapping. Return fragments_map ordered by idx for callers that rely on stable ordering.                                                                                                                                                                                                                  </td></tr><tr><td data-label="Area / Change"> <strong>Atomic writes & tmp dir error handling</strong>          </td><td data-label="World-class fix (concise, actionable)"> Use <code>_atomic_stream_write</code> when available; otherwise use a robust tmpfile+os.replace pattern (tempfile.NamedTemporaryFile in same dir, then rename). On write failure, set <code>fragments_map[idx][&quot;write_error&quot;]</code> with details instead of silently continuing. Ensure <code>tmp_frag_dir</code> perms are created with <code>exist_ok=True</code>.                                                                                                                                                                              </td></tr><tr><td data-label="Area / Change"> <strong>CSV detection & delimiter scoring</strong>               </td><td data-label="World-class fix (concise, actionable)"> Replace simple count heuristic with variance-based scoring: sample N lines, calculate field counts per candidate delimiter, choose delimiter with lowest variance and mean>1. Prefer <code>csv.Sniffer</code> but fall back deterministically. Expose <code>force_delimiter</code> and add unit tests for tricky delimiters and quoted fields.                                                                                                                                                                               </td></tr><tr><td data-label="Area / Change"> <strong>Fenced CSV regex robustness</strong>                     </td><td data-label="World-class fix (concise, actionable)"> Replace current <code>fence_re</code> with a safer non-catastrophic regex, anchor fence start and end handling, and support optional info-strings. Example: <code>(?m)^[</code>~]{3,}\s*(csv                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Area / Change"> <strong>Markdown pipe-table parser edge cases</strong>           </td><td data-label="World-class fix (concise, actionable)"> Add tests and fix <code>_split_row_keep_code</code> for nested/backtick code with escaped backticks and multi-backtick fences. Ensure <code>_is_divider_line</code> tolerates leading/trailing pipes and extra spaces. Normalize cell counts (pad/truncate) before converting to df-like.                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Area / Change"> <strong>HTML table extraction: bs4 vs regex fallbacks</strong>   </td><td data-label="World-class fix (concise, actionable)"> Prefer BeautifulSoup extraction. If falling back to regex, use non-greedy patterns and limit HTML input window to avoid huge greedy matches. Avoid relying on <code>&lt;h3 id=&#x27;Table{idx}&#x27;&gt;</code> — prefer <code>data-table-id</code> or nearest wrapper. Add tests for fragmented or inline-table HTML.                                                                                                                                                                                                                       </td></tr><tr><td data-label="Area / Change"> <strong>_convert_rows_to_df_like behavior</strong>               </td><td data-label="World-class fix (concise, actionable)"> Make deterministic shape: if header True → return list-of-dicts; if pandas available, also return DataFrame but keep fallback deterministic. Document return types. Ensure empty-body tables return <code>[]</code> not <code>None</code>.                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Area / Change"> <strong>Asset detection reliability</strong>                     </td><td data-label="World-class fix (concise, actionable)"> Keep <code>_detect_assets_from_html</code> but only match attributes or explicit markers (e.g., <code>data-requires-*</code>) — avoid scanning code samples. Add <code>force_assets</code> override and include <code>assets_required</code> in fragment metadata returned to caller.                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Area / Change"> <strong>Row counting and tbody parsing</strong>                  </td><td data-label="World-class fix (concise, actionable)"> For accurate row count parse <code>&lt;tbody&gt;</code> using BeautifulSoup when available; fallback to regex but limit to matching <code>&lt;tbody&gt;</code> contents only. Store <code>row_count</code> in fragment metadata.                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Area / Change"> <strong>Logging, warnings & telemetry</strong>                   </td><td data-label="World-class fix (concise, actionable)"> Use structured warnings: <code>{&quot;code&quot;:&quot;process_fallback&quot;,&quot;level&quot;:&quot;warn&quot;,&quot;msg&quot;:..,&quot;table&quot;:idx}</code>. Append <code>metadata[&quot;warnings&quot;]</code> to return so caller/convert can inspect fallback reasons.                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Area / Change"> <strong>Security: XSS & payload escaping</strong>                </td><td data-label="World-class fix (concise, actionable)"> Never assume <code>text_html</code> is safe. Sender must mark sanitized. On server-side embedding inside <code>&lt;script&gt;</code> escape <code>&lt;/</code> and control chars. Document client must re-sanitize or only set <code>innerText</code> when <code>text_plain</code> is provided.                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Area / Change"> <strong>API / schema: explicit caption payload</strong>          </td><td data-label="World-class fix (concise, actionable)"> Add <code>caption_payload_version</code> and return schema in-call: <code>fragments_map[idx]</code> includes <code>captions: [], fragment_id, table_id, content, assets_required, row_count, render_time_ms, write_time_ms, detected_type, source</code>. Provide a small JSON schema for validation.                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Area / Change"> <strong>Unit & integration tests to add</strong>                 </td><td data-label="World-class fix (concise, actionable)"> Tests: placeholder round-trip, <code>_split_row_keep_code</code> edgecases, <code>_is_divider_line</code> permutations, CSV delimiter scoring (quoted fields), fenced CSV extraction, bs4 vs regex table extraction, process-pool fallback, atomic write failure injection, caption payload shape and deterministic id mapping. Add snapshot test for <code>fragments_map</code> shape.                                                                                                                                                 </td></tr><tr><td data-label="Area / Change"> <strong>Backward compatibility & rollout flag</strong>           </td><td data-label="World-class fix (concise, actionable)"> Add <code>emit_captions_inline: bool</code> (default True for legacy) and <code>emit_caption_payload: bool</code> for new path. When <code>emit_caption_payload=True</code> produce skeleton+payload and set <code>deprecation</code> warning when both present.                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Area / Change"> <strong>Quick patch outline (concrete edits)</strong>        </td><td data-label="World-class fix (concise, actionable)"> 1) Add generate_fragment_id helper.<br>2) Change _call_render_table to return normalized dict.<br>3) Modify _render_job to extract captions and include in returned tuple.<br>4) Replace NUL stash with safe tokens + payload placeholders.<br>5) Add emit_caption_payload flag wiring.<br>6) Add unit tests and schema. </td></tr><tr><td data-label="Area / Change"> <strong>Developer checklist before flipping default</strong> </td><td data-label="World-class fix (concise, actionable)"> core_fragments deterministic IDs ✅<br>sanitize JSON-safe helpers wired ✅<br>fragments_map contains captions payload ✅<br>client contract documented ✅<br>atomics + write-error reporting ✅<br>unit+integration tests green ✅<br>emit_captions_inline toggle present ✅                                                    </td></tr></tbody></table></div><div class="row-count">Rows: 22</div></div><div class="table-caption" id="Table4" data-table="Docu_0121_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Area / Change"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Area / Change</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by World-class fix (concise, actionable)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">World-class fix (concise, actionable)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Area / Change"> <strong>Caption ownership (core change)</strong>           </td><td data-label="World-class fix (concise, actionable)"> <em>Stop emitting visible caption HTML from <code>render_table</code>.</em> Change <code>render_table</code> to <strong>not</strong> write <code>&lt;caption&gt;</code> nodes. Instead have it return <code>(html_fragment, caption_fragments)</code> when <code>emit_captions_inline=False</code> (default for new flow). <code>caption_fragments</code> = list of canonical caption objects: <code>{ fragment_id, id, table_id, text_html, text_plain, type, source }</code>. Emit an adjacent payload script: <code>&lt;script data-caption-payload type=&quot;application/json&quot;&gt;…&lt;/script&gt;</code> with the caption list and <code>wrapper_id</code> so client does only positioning. Add <code>emit_captions_inline</code> option (default True for backwards compatibility, but plan to flip). </td></tr><tr><td data-label="Area / Change"> <strong>Canonical IDs / Deterministic mapping</strong>     </td><td data-label="World-class fix (concise, actionable)"> Unify table & fragment IDs. Replace ad-hoc <code>Table{idx}</code> and <code>caption-{Table{idx}}</code> with deterministic IDs e.g. <code>table-{stable-hash-or-filepath}-{index}</code> and <code>frag-{stable-hash-or-filepath}-{index}</code>. Add optional <code>fragment_id</code>/<code>table_id</code> param to <code>render_table</code>. Make <code>core_fragments</code> fully authoritative for ID generation; accept precomputed IDs from <code>core_fragments</code> and prefer them over generated <code>Table{idx}</code>. Document ID derivation algorithm.                                                                                                                                                                                      </td></tr><tr><td data-label="Area / Change"> <strong>Caption sanitization & JSON safety</strong>        </td><td data-label="World-class fix (concise, actionable)"> Centralize caption sanitization via <code>sanitize.py</code>: produce both <code>text_plain</code> and <code>text_html</code> (sanitized). When building JSON payload use safe encoding: <code>json.dumps(..., ensure_ascii=False)</code> then <code>_safe_json_for_script</code> should also escape <code>&lt;/script&gt;</code> sequences and control chars. Replace the current <code>&lt;/</code> escape with robust sanitization (e.g., replace <code>&lt;/script&gt;</code> and ensure no raw control chars). Provide <code>sanitize_caption_for_json()</code> helper that strips dangerous attributes and returns safe HTML/plain text pair.                                                                                                                   </td></tr><tr><td data-label="Area / Change"> <strong>Code-span stash / placeholder robustness</strong>  </td><td data-label="World-class fix (concise, actionable)"> Replace current <code>@@FENCED{n}@@</code> / <code>@@INLINE{n}@@</code> markers with stable, ASCII-safe tokens such as <code>__PTT_FENCED_{n}__</code> and <code>__PTT_INLINE_{n}__</code>. Keep mapping arrays but <strong>never</strong> embed NULs. When emitting JSON, either omit raw code bodies or base64-encode them into a separate <code>code_map</code> array referenced by index to avoid JSON-breaking characters. Add unit test that round-trips stash→render→embed→client-restore.                                                                                                                                                                                                                       </td></tr><tr><td data-label="Area / Change"> <strong>Server payload contract (strict schema)</strong>   </td><td data-label="World-class fix (concise, actionable)"> Define explicit payload schema and version: <code>{&quot;caption_payload_version&quot;:&quot;1.0&quot;,&quot;wrapper_id&quot;,&quot;table_id&quot;,&quot;table_index&quot;,&quot;captions&quot;:[{fragment_id,id,type,text_html,text_plain,source}], &quot;meta&quot;:{rows,cols,alignments,tv_options}}</code>. Validate the payload server-side (simple schema check) before emitting. Log and fail-safe to fallback <code>emit_captions_inline=True</code> if validation fails. Ship small <code>caption_payload_schema.json</code> for consumers and tests.                                                                                                                                                                                            </td></tr><tr><td data-label="Area / Change"> <strong>Render flow: single-responsibility split</strong>  </td><td data-label="World-class fix (concise, actionable)"> Separate responsibilities: <code>convert.py</code> builds rows+raw skeleton; <code>core_fragments.py</code> builds <code>CaptionFragment</code> and stable IDs; <code>core_table.render_table</code> builds skeleton HTML (no caption) and table rows; <code>html_renderer.py</code> stitches skeleton + <code>&lt;script data-caption-payload&gt;</code> (if payloads present). Make <code>render_table</code> return (html, payload_obj) when <code>fragment=True</code> to avoid double-emitting assets. Keep small clear helpers to make unit testing each stage trivial.                                                                                                                                                                     </td></tr><tr><td data-label="Area / Change"> <strong>CSV detection & parsing robustness</strong>        </td><td data-label="World-class fix (concise, actionable)"> Replace <code>_is_likely_csv_text</code> and <code>_sniff_delimiter</code> heuristics with a delimiter-score approach: sample N lines, for each candidate delimiter compute field-count mean and variance; prefer delimiter with mean>1 and lowest variance. Keep <code>csv.Sniffer</code> as best-effort but fallback deterministically to this scoring. Expose <code>force_delimiter</code> and <code>sniff_sample_size</code> options. Add tests for mixed delimiters, quoted fields, and pipeline with <code>try_pandas=False</code> to validate fallback behavior.                                                                                                                                               </td></tr><tr><td data-label="Area / Change"> <strong>Markdown renderer & inline handling</strong>       </td><td data-label="World-class fix (concise, actionable)"> Make markdown callable pluggable and explicit: accept <code>markdown_to_html_func</code> and <code>markdown_features</code> dict (<code>allow_html</code>, <code>allow_fenced_code</code>, <code>allow_lists</code>). If no renderer is provided, <strong>do not</strong> attempt partial formatting that produces inconsistent <code>&lt;p&gt;</code> wrappers — output <code>text_plain</code> escaped. Normalize single-line breaks consistently: convert single <code>\n</code>→<code>  \n</code> only outside code/fenced blocks. Document the <code>md_callable</code> contract (input → safe HTML string).                                                                                                                                                                    </td></tr><tr><td data-label="Area / Change"> <strong>List normalization & nested lists</strong>         </td><td data-label="World-class fix (concise, actionable)"> Before sending content to the markdown renderer, run a deterministic normalization pass: 1) stash fenced/code blocks; 2) normalize list markers (map bullets to <code>- </code> and numbers to <code>1.</code> while preserving indentation); 3) restore block stashes; 4) pass normalized text to markdown renderer. Provide unit tests covering nested lists, localized bullets, and edge-case em-dash bullets. This removes brittle ad-hoc handling inside <code>_render_cell_text</code>.                                                                                                                                                                                        </td></tr><tr><td data-label="Area / Change"> <strong>Column type detection & alignment</strong>         </td><td data-label="World-class fix (concise, actionable)"> Make <code>_detect_column_types</code> conservative and configurable: sample up to <code>column_type_sample</code> rows, require ≥70% parseable numeric after cleaning for numeric type. Strip currency symbols and thousands separators before numeric parse. Expose <code>alignment_overrides</code> option. Treat numeric vs text as presentation hint only; never change underlying cell HTML semantics. Add a <code>col_type_confidence</code> output so client can prefer but not rely on server-provided alignment.                                                                                                                                                                      </td></tr><tr><td data-label="Area / Change"> <strong>HTML generation: skeleton and ARIA</strong>        </td><td data-label="World-class fix (concise, actionable)"> Emit semantic skeleton only: wrapper <code>&lt;div data-table-id=&quot;table-017&quot; id=&quot;wrapper-table-017&quot; data-table-index=&quot;17&quot; aria-describedby=&quot;caption-table-017&quot;&gt;</code> and <code>&lt;table role=&quot;table&quot; aria-labelledby=&quot;table-label-table-017&quot; aria-describedby=&quot;caption-table-017&quot;&gt;</code>. <strong>Do not emit <code>&lt;caption&gt;</code></strong>. Include <code>id</code> placeholders for client-injected caption (e.g., <code>caption-table-017</code>). If captions absent, do not create the caption id. Ensure <code>hidden anchor</code> logic uses <code>data-table-id</code> consistently.                                                                                                                                                 </td></tr><tr><td data-label="Area / Change"> <strong>Client contract & injectCaptions() shape</strong>  </td><td data-label="World-class fix (concise, actionable)"> Define <code>injectCaptions(payload)</code> signature precisely: <code>payload = { wrapper_id, table_id, captions: [{fragment_id,id,type,text_html,text_plain,source}] }</code>. Client must: 1) find wrapper by <code>[data-table-id=wrapper_id]</code>, 2) for each caption: if element <code>#caption-{id}</code> exists update innerText/innerHTML idempotently; else create <code>&lt;caption id=&quot;caption-{id}&quot; class=&quot;table-caption&quot; role=&quot;note&quot;&gt;</code> and insert as first child of table, 3) preserve <code>text_plain</code> as fallback and prefer sanitized <code>text_html</code> only if trusted. Provide short pseudo-code in docs.                                                                                  </td></tr><tr><td data-label="Area / Change"> <strong>Backward compatibility & opt-in migration</strong> </td><td data-label="World-class fix (concise, actionable)"> Add <code>emit_captions_inline=True</code> option to preserve legacy behavior. Default rollout path: ship both payload script and legacy caption HTML for N releases (<code>emit_captions_inline=True</code>), then flip default to <code>False</code> after verifying <code>injectCaptions</code> presence. Add <code>metadata[&quot;caption_migration&quot;]=&quot;pending                                                                                                                                                                                                                                                                                                                                        | complete&quot;</code> and deprecation messages. Provide a small integration test (payload present, client injects, legacy captions removed or ignored). </td></tr><tr><td data-label="Area / Change"> <strong>Lazy loading & streaming memory use</strong>       </td><td data-label="World-class fix (concise, actionable)"> Replace <code>parts: List[str]</code> accumulation with <code>io.StringIO()</code> or generator-based streaming to reduce peak memory for large tables. Provide <code>render_table(..., stream=True)</code> that writes directly to a file-like writer and returns metadata/payload only. For lazy-load chunks, keep embedding compact JSON blocks but consider emitting them as compressed/base64 script if extremely large. Document memory and CPU trade-offs and provide <code>max_rows_in_memory</code> config.                                                                                                                                                                            </td></tr><tr><td data-label="Area / Change"> <strong>Security (XSS / HTML safety)</strong>              </td><td data-label="World-class fix (concise, actionable)"> Sanitize all HTML from markdown renderer using <code>sanitize_html</code> with explicit policy (allow_tables=True when needed). For caption <code>text_html</code>, either require server-sanitized HTML or emit only <code>text_plain</code>. Never trust client to sanitize <code>text_html</code>. In payload, do not embed unsanitized raw code — encode or omit. Add CSP guidance for consumers and require <code>injectCaptions</code> to insert via <code>textContent</code> or sanitized <code>innerHTML</code> only after validation.                                                                                                                                                                                   </td></tr><tr><td data-label="Area / Change"> <strong>Safe JSON embedding</strong>                       </td><td data-label="World-class fix (concise, actionable)"> Replace <code>_safe_json_for_script</code> with a stricter routine that: 1) JSON-encodes with <code>ensure_ascii=False</code>; 2) escapes <code>&lt;/script&gt;</code> sequences (<code>&lt;/script&gt;</code> → <code>&lt;\\/script&gt;</code>); 3) replaces control chars U+0000–U+001F with <code>\uXXXX</code>; 4) optionally base64-encode large binary sub-payloads. Add unit tests validating JSON round-trip and no accidental script injection.                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Area / Change"> <strong>Testing strategy (world-class)</strong>            </td><td data-label="World-class fix (concise, actionable)"> Add unit tests for: stash/restore, placeholder token round-trip, <code>_is_likely_csv_text</code> delimiters, <code>_sniff_delimiter</code> scoring, <code>parse_csv_safe</code> fallbacks, <code>_detect_column_types</code> thresholds, and caption payload schema validation. Add integration tests simulating DOM injection (headless DOM) verifying idempotency and no duplicate captions. Add fuzz tests for CSVs and markdown edge cases. Add CI matrix for pandas/no-pandas, xlsxwriter/openpyxl presence permutations.                                                                                                                                                                 </td></tr><tr><td data-label="Area / Change"> <strong>Logging & telemetry</strong>                       </td><td data-label="World-class fix (concise, actionable)"> Add structured warnings in <code>metadata[&quot;warnings&quot;]</code> for heuristics used (e.g., <code>csv_sniff_fallback</code>, <code>pandas_failed</code>) and include <code>id_map</code> mapping <code>table_index-&gt;table_id-&gt;fragment_id</code>. Emit <code>logger.info</code> lines on PARSE_TRY/PARSE_OK/PARSE_FAIL with contextualized short summaries. Keep logs machine-parseable (JSON lines) when <code>options.get(&#x27;telemetry&#x27;,True)</code>.                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Area / Change"> <strong>Migration patch outline (concrete steps)</strong>  </td><td data-label="World-class fix (concise, actionable)"> 1) Add <code>CaptionFragment</code> model + ID generator in <code>core_fragments.py</code>.<br>2) Add <code>emit_captions_inline</code> flag to <code>render_table</code> and refactor to optionally omit <code>&lt;caption&gt;</code> and return payload.<br>3) Add <code>html_renderer.py</code> to insert <code>&lt;script data-caption-payload&gt;</code> adjacent to wrapper when payload exists.<br>4) Harden <code>_safe_json_for_script</code> and add <code>sanitize_caption_for_json()</code> in <code>sanitize.py</code>.<br>5) Update <code>script.core.js</code> to parse payloads and call <code>injectCaptions(payload)</code>; ship client lib and docs.<br>6) Run unit+integration tests; stage rollout.                                                                           </td></tr><tr><td data-label="Area / Change"> <strong>Quick example payload (minimal)</strong>           </td><td data-label="World-class fix (concise, actionable)"> <code>{&quot;caption_payload_version&quot;:&quot;1.0&quot;,&quot;wrapper_id&quot;:&quot;wrapper-abc123&quot;,&quot;table_id&quot;:&quot;table-docpath-17&quot;,&quot;table_index&quot;:17,&quot;captions&quot;:[{&quot;fragment_id&quot;:&quot;frag-docpath-17-1&quot;,&quot;id&quot;:&quot;caption-table-docpath-17&quot;,&quot;type&quot;:&quot;table&quot;,&quot;text_html&quot;:&quot;&lt;strong&gt;Topic 17&lt;/strong&gt;&quot;,&quot;text_plain&quot;:&quot;Topic 17&quot;,&quot;source&quot;:{&quot;file&quot;:&quot;doc.md&quot;,&quot;line&quot;:123}}],&quot;meta&quot;:{&quot;rows&quot;:120,&quot;cols&quot;:6,&quot;alignments&quot;:[&quot;left&quot;,&quot;right&quot;],&quot;tv_options&quot;:{}}}</code>                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Area / Change"> <strong>Developer checklist before flip</strong>           </td><td data-label="World-class fix (concise, actionable)"> core_fragments deterministic IDs ✅<br>sanitize.py JSON-safe helpers ✅<br>replace NUL placeholders with <code>__PTT_*__</code> tokens ✅<br>emit_captions_inline flag present ✅<br>html_renderer emits <code>&lt;script data-caption-payload&gt;</code> ✅<br>script.core.js <code>injectCaptions</code> idempotent & documented ✅<br>unit+integration+snapshot tests green ✅<br>streaming/render_into writer option added ✅<br>rollout plan & telemetry ✅.                                                                                                                                                                                                                                   </td></tr></tbody></table></div><div class="row-count">Rows: 21</div></div><div class="table-caption" id="Table5" data-table="Docu_0121_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Area"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Area</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Finding / Concern"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Finding / Concern</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Risk Level"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Risk Level</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Concrete, safe fix (small, reversible edits)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Concrete, safe fix (small, reversible edits)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Verification &amp; rollback"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Verification & rollback</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Area"> <code>inject_captions()</code> gating                          </td><td data-label="Finding / Concern"> Function only runs for <code>request_ctx.action == &quot;load_group&quot;</code> and marks <code>meta[&quot;injected&quot;]=True</code>. Good guard but source check earlier (<code>mmeta.get(&quot;source&quot;) != &quot;group_load&quot;</code>) is brittle.                                                                                                                 </td><td data-label="Risk Level"> Medium — wrong/absent source will skip injection, leaving no payloads.                                </td><td data-label="Concrete, safe fix (small, reversible edits)"> Normalize source checks: accept both <code>&quot;group_load&quot;</code> and <code>&quot;load_group&quot;</code> (or make the accepted value configurable). Add a single-line comment explaining canonical value. Minimal patch: change <code>if str(mmeta.get(&quot;source&quot;)) != &quot;group_load&quot;</code> → <code>if str(mmeta.get(&quot;source&quot;)) not in (&quot;group_load&quot;,&quot;load_group&quot;):</code>.                                                                                                                                                                                                                                                      </td><td data-label="Verification &amp; rollback"> Unit: add test asserting fragments with either source string get <code>meta[&quot;injected&quot;]=True</code>. Rollback: revert single-line change.                                                                               </td></tr><tr><td data-label="Area"> Duplicate captions (inline HTML + payload)          </td><td data-label="Finding / Concern"> Code emits inline caption HTML in fallback and in writer() when <code>not need_fallback</code>, and <strong>also</strong> emits <code>data-caption-payload</code> script. This can create duplicate visible captions (server wrote caption divs <em>and</em> client injects again).                                                              </td><td data-label="Risk Level"> High — duplicates visible to users; inconsistent when client also tries to place captions.            </td><td data-label="Concrete, safe fix (small, reversible edits)"> Introduce config flag <code>emit_captions_inline</code> (default <code>False</code>) passed via <code>config</code>/<code>cfg</code>. When False: <strong>do not</strong> write <code>caption_html</code> blocks into <code>inline_parts</code> or in <code>writer()</code>; only emit the caption payload script. When True: preserve current behavior for compatibility. Implement small checks around the two locations that build/write caption HTML to skip when <code>not getattr(cfg,&#x27;emit_captions_inline&#x27;, False)</code>.                                                                                                                                         </td><td data-label="Verification &amp; rollback"> Tests: generate HTML with <code>emit_captions_inline=False</code> and assert no <code>.table-caption</code> blocks are present but <code>data-caption-payload</code> script exists. Rollback: revert config branch (isolated boolean checks). </td></tr><tr><td data-label="Area"> Caption payload serialization escaping              </td><td data-label="Finding / Concern"> <code>json_payload</code> is injected directly into <code>&lt;script&gt;...&lt;/script&gt;</code>. A raw <code>&lt;/script&gt;</code> in data can prematurely close the tag. Current <code>json.dumps</code> does <strong>not</strong> escape <code>&lt;/script&gt;</code>.                                                                                                                        </td><td data-label="Risk Level"> High — XSS / broken HTML if <code>caption_html</code> contains <code>&lt;/script&gt;</code> or user input contains that sequence. </td><td data-label="Concrete, safe fix (small, reversible edits)"> After <code>json_payload = json.dumps(...)</code>, replace <code>&lt;/script&gt;</code> with <code>&lt;\\/script&gt;</code> (safe, minimal). Example: <code>json_payload = json_payload.replace(&#x27;&lt;/script&gt;&#x27;, &#x27;&lt;\\/script&gt;&#x27;)</code>. Do the same for the second inlined <code>json.dumps(caption_payloads)</code> used in the follow-up script. Preferably emit the JSON inside a <code>&lt;script type=&quot;application/json&quot; data-caption-payload&gt;...&lt;/script&gt;</code> (already present) and ensure the replacement is applied.                                                                                                                            </td><td data-label="Verification &amp; rollback"> Unit: assert <code>&#x27;&lt;/script&gt;&#x27; not in produced HTML</code> and that JSON parses in browser (roundtrip <code>json.loads</code>). Rollback: revert the two replace lines.                                                            </td></tr><tr><td data-label="Area"> Payload size & chunking                             </td><td data-label="Finding / Concern"> <code>caption_payloads</code> may become very large for big documents; server currently dumps whole array.                                                                                                                                                                                                        </td><td data-label="Risk Level"> Medium — very large inline scripts can slow load or exceed embedding limits.                          </td><td data-label="Concrete, safe fix (small, reversible edits)"> Add configurable limit <code>cfg.max_caption_payload_size</code> (bytes, default e.g. 200_000). If <code>json_payload</code> length exceeds limit, chunk payloads into multiple <code>&lt;script data-caption-payload&gt;</code> blocks and include <code>data-payload-part=&quot;n&quot;</code> attributes. Keep chunking deterministic. Keep chunking code small (loop emitting successive slices).                                                                                                                                                                                                                             </td><td data-label="Verification &amp; rollback"> Test: generate >limit payload and assert multiple payload scripts appear and that client-side loader can be made to merge chunks. Rollback: remove chunking branch.                                          </td></tr><tr><td data-label="Area"> Caption content sanitization / truncation           </td><td data-label="Finding / Concern"> <code>payload[&quot;caption_html&quot;]</code> strips tags with regex and truncates to 2000 chars. Regex strip might leave <code>&lt;/script&gt;</code> or unbalanced entities.                                                                                                                                                              </td><td data-label="Risk Level"> Medium — content could still include problematic sequences; truncation may cut high-UTF8 sequences.   </td><td data-label="Concrete, safe fix (small, reversible edits)"> Use <code>sanitize_html(..., allow_tables=False)</code> or a dedicated <code>sanitize_caption_text()</code> prior to stripping tags. Replace regex strip with <code>BeautifulSoup(...).get_text()</code> when bs4 available (already used elsewhere) and then truncate safely (use <code>[:2000]</code> with <code>encode(&#x27;utf-8&#x27;,&#x27;ignore&#x27;).decode(...)</code> if needed). Minimal change: if <code>_HAVE_BS4: txt = BeautifulSoup(caption_html,&#x27;html.parser&#x27;).get_text()</code> else fallback to existing regex but then run <code>txt = txt.replace(&#x27;&lt;/script&gt;&#x27;, &#x27;&lt;\\/script&gt;&#x27;)</code>.                                                          </td><td data-label="Verification &amp; rollback"> Tests: roundtrip parse on captions with scripts/html; assert <code>caption_html</code> contains no <code>&lt;</code> or <code>&lt;/script&gt;</code> and length <=2000. Rollback: revert to previous extraction branch.                                </td></tr><tr><td data-label="Area"> Fallback inline rendering vs fragment model         </td><td data-label="Finding / Concern"> When <code>need_fallback</code> the code currently emits inline caption divs and <code>inline_parts</code> content without creating fragment metadata entries; later caption payload building iterates only <code>fragments_map</code>. That means some inline tables will have visible captions but not corresponding payload entries. </td><td data-label="Risk Level"> High — inconsistent: some captions only inline, some only in payload.                                 </td><td data-label="Concrete, safe fix (small, reversible edits)"> For fallback path, always create lightweight fragment entries (populate minimal <code>meta</code>/<code>table_meta</code> for each inline table) so caption payload builder can include them. Alternatively, prefer emitting payloads for inline tables and <strong>skip</strong> inline caption HTML (controlled by <code>emit_captions_inline</code> flag). Implement minimal wrapper: when building <code>inline_parts</code>, also <code>fragments_map[fallback_idx] = {&quot;meta&quot;: {&quot;source&quot;:&quot;inline_fallback&quot;,&quot;sanitized&quot;:True,&quot;injected&quot;:True}, &quot;table_meta&quot;: {...}, &quot;caption_html&quot;: cap}</code> so payload builder will pick them up. </td><td data-label="Verification &amp; rollback"> Tests: run fallback flow and assert for every inline table there is a payload entry with matching <code>data_table_id</code>. Rollback: remove inserted minimal fragment entries.                                       </td></tr><tr><td data-label="Area"> <code>ensure_table_id</code> and id normalization              </td><td data-label="Finding / Concern"> <code>ensure_table_id</code> uses <code>Table{idx}</code> and <code>data_table_id</code> includes <code>book_prefix</code> and <code>idx</code>. <code>_normalize_id</code> will produce <code>auto-...</code> for invalid ids. Good, but risk: collisions if different codepaths compute different prefixes.                                                                       </td><td data-label="Risk Level"> Low → Medium depending on upstream consistency.                                                       </td><td data-label="Concrete, safe fix (small, reversible edits)"> Keep <code>ensure_table_id</code> but document canonical format in a single place. Add a small unit test ensuring <code>ensure_table_id</code> results are stable for repeated calls with same inputs. Optionally canonicalize <code>table_id</code> to a lowercased, safe form (<code>table-{book_prefix}-{idx:02d}</code>) if you want more predictable IDs.                                                                                                                                                                                                                                                    </td><td data-label="Verification &amp; rollback"> Tests: call <code>ensure_table_id</code> multiple times, ensure identical outputs. Rollback: revert canonicalization change.                                                                                            </td></tr><tr><td data-label="Area"> Client coordination (script ordering & idempotency) </td><td data-label="Finding / Concern"> Server emits payload script and also optionally inlines <code>window.PTT._serverCaptionPayload</code> and triggers <code>window.PTT.injectCaptions</code>. Client must make <code>injectCaptions</code> idempotent and safe to run multiple times.                                                                                      </td><td data-label="Risk Level"> Medium — race conditions if client script loads earlier/later.                                        </td><td data-label="Concrete, safe fix (small, reversible edits)"> On server: keep <code>defer</code> on script tags (already used in other assets). On client: ensure <code>window.PTT.injectCaptions</code> checks for <code>data-injected</code> attribute on target element or marks <code>window.PTT._injectedIds</code> set to avoid duplicate insertions. Add small client-side guard (idempotency) in <code>script.core.js</code> — single short function.                                                                                                                                                                                                                              </td><td data-label="Verification &amp; rollback"> Test: load page with payload, run inject twice, assert single caption per target. Rollback: remove guard if it conflicts with older clients.                                                                 </td></tr><tr><td data-label="Area"> Safety: writing atomic output                       </td><td data-label="Finding / Concern"> Code uses <code>_default_write_atomic</code> when available and falls back to tmp replace. Good.                                                                                                                                                                                                                  </td><td data-label="Risk Level"> Low                                                                                                   </td><td data-label="Concrete, safe fix (small, reversible edits)"> No change recommended. Add a short unit test simulating failure during write to ensure tmp file not left or is replaced.                                                                                                                                                                                                                                                                                                                                                                                                                                              </td><td data-label="Verification &amp; rollback"> Test: simulate exception in writer and confirm temp file handling. Rollback: none needed.                                                                                                                    </td></tr></tbody></table></div><div class="row-count">Rows: 9</div></div><div class="table-caption" id="Table6" data-table="Docu_0121_06" style="margin-top:2mm;margin-left:3mm;"><strong>Table 6</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Area / Change"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Area / Change</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by World-class fix (concise, actionable)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">World-class fix (concise, actionable)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Area / Change"> <strong>Caption ownership (core change)</strong>           </td><td data-label="World-class fix (concise, actionable)"> <em>Stop emitting visible caption HTML from <code>render_table</code>.</em> Change <code>render_table</code> to <strong>not</strong> write <code>&lt;caption&gt;</code> nodes. Instead have it return <code>(html_fragment, caption_fragments)</code> when <code>emit_captions_inline=False</code> (default for new flow). <code>caption_fragments</code> = list of canonical caption objects: <code>{ fragment_id, id, table_id, text_html, text_plain, type, source }</code>. Emit an adjacent payload script: <code>&lt;script data-caption-payload type=&quot;application/json&quot;&gt;…&lt;/script&gt;</code> with the caption list and <code>wrapper_id</code> so client does only positioning. Add <code>emit_captions_inline</code> option (default True for backwards compatibility, but plan to flip). </td></tr><tr><td data-label="Area / Change"> <strong>Canonical IDs / Deterministic mapping</strong>     </td><td data-label="World-class fix (concise, actionable)"> Unify table & fragment IDs. Replace ad-hoc <code>Table{idx}</code> and <code>caption-{Table{idx}}</code> with deterministic IDs e.g. <code>table-{stable-hash-or-filepath}-{index}</code> and <code>frag-{stable-hash-or-filepath}-{index}</code>. Add optional <code>fragment_id</code>/<code>table_id</code> param to <code>render_table</code>. Make <code>core_fragments</code> fully authoritative for ID generation; accept precomputed IDs from <code>core_fragments</code> and prefer them over generated <code>Table{idx}</code>. Document ID derivation algorithm.                                                                                                                                                                                      </td></tr><tr><td data-label="Area / Change"> <strong>Caption sanitization & JSON safety</strong>        </td><td data-label="World-class fix (concise, actionable)"> Centralize caption sanitization via <code>sanitize.py</code>: produce both <code>text_plain</code> and <code>text_html</code> (sanitized). When building JSON payload use safe encoding: <code>json.dumps(..., ensure_ascii=False)</code> then <code>_safe_json_for_script</code> should also escape <code>&lt;/script&gt;</code> sequences and control chars. Replace the current <code>&lt;/</code> escape with robust sanitization (e.g., replace <code>&lt;/script&gt;</code> and ensure no raw control chars). Provide <code>sanitize_caption_for_json()</code> helper that strips dangerous attributes and returns safe HTML/plain text pair.                                                                                                                   </td></tr><tr><td data-label="Area / Change"> <strong>Code-span stash / placeholder robustness</strong>  </td><td data-label="World-class fix (concise, actionable)"> Replace current <code>@@FENCED{n}@@</code> / <code>@@INLINE{n}@@</code> markers with stable, ASCII-safe tokens such as <code>__PTT_FENCED_{n}__</code> and <code>__PTT_INLINE_{n}__</code>. Keep mapping arrays but <strong>never</strong> embed NULs. When emitting JSON, either omit raw code bodies or base64-encode them into a separate <code>code_map</code> array referenced by index to avoid JSON-breaking characters. Add unit test that round-trips stash→render→embed→client-restore.                                                                                                                                                                                                                       </td></tr><tr><td data-label="Area / Change"> <strong>Server payload contract (strict schema)</strong>   </td><td data-label="World-class fix (concise, actionable)"> Define explicit payload schema and version: <code>{&quot;caption_payload_version&quot;:&quot;1.0&quot;,&quot;wrapper_id&quot;,&quot;table_id&quot;,&quot;table_index&quot;,&quot;captions&quot;:[{fragment_id,id,type,text_html,text_plain,source}], &quot;meta&quot;:{rows,cols,alignments,tv_options}}</code>. Validate the payload server-side (simple schema check) before emitting. Log and fail-safe to fallback <code>emit_captions_inline=True</code> if validation fails. Ship small <code>caption_payload_schema.json</code> for consumers and tests.                                                                                                                                                                                            </td></tr><tr><td data-label="Area / Change"> <strong>Render flow: single-responsibility split</strong>  </td><td data-label="World-class fix (concise, actionable)"> Separate responsibilities: <code>convert.py</code> builds rows+raw skeleton; <code>core_fragments.py</code> builds <code>CaptionFragment</code> and stable IDs; <code>core_table.render_table</code> builds skeleton HTML (no caption) and table rows; <code>html_renderer.py</code> stitches skeleton + <code>&lt;script data-caption-payload&gt;</code> (if payloads present). Make <code>render_table</code> return (html, payload_obj) when <code>fragment=True</code> to avoid double-emitting assets. Keep small clear helpers to make unit testing each stage trivial.                                                                                                                                                                     </td></tr><tr><td data-label="Area / Change"> <strong>CSV detection & parsing robustness</strong>        </td><td data-label="World-class fix (concise, actionable)"> Replace <code>_is_likely_csv_text</code> and <code>_sniff_delimiter</code> heuristics with a delimiter-score approach: sample N lines, for each candidate delimiter compute field-count mean and variance; prefer delimiter with mean>1 and lowest variance. Keep <code>csv.Sniffer</code> as best-effort but fallback deterministically to this scoring. Expose <code>force_delimiter</code> and <code>sniff_sample_size</code> options. Add tests for mixed delimiters, quoted fields, and pipeline with <code>try_pandas=False</code> to validate fallback behavior.                                                                                                                                               </td></tr><tr><td data-label="Area / Change"> <strong>Markdown renderer & inline handling</strong>       </td><td data-label="World-class fix (concise, actionable)"> Make markdown callable pluggable and explicit: accept <code>markdown_to_html_func</code> and <code>markdown_features</code> dict (<code>allow_html</code>, <code>allow_fenced_code</code>, <code>allow_lists</code>). If no renderer is provided, <strong>do not</strong> attempt partial formatting that produces inconsistent <code>&lt;p&gt;</code> wrappers — output <code>text_plain</code> escaped. Normalize single-line breaks consistently: convert single <code>\n</code>→<code>  \n</code> only outside code/fenced blocks. Document the <code>md_callable</code> contract (input → safe HTML string).                                                                                                                                                                    </td></tr><tr><td data-label="Area / Change"> <strong>List normalization & nested lists</strong>         </td><td data-label="World-class fix (concise, actionable)"> Before sending content to the markdown renderer, run a deterministic normalization pass:<br>1. stash fenced/code blocks;<br>2. normalize list markers (map bullets to <code>- </code> and numbers to <code>1.</code> while preserving indentation);<br>3. restore block stashes;<br>4. pass normalized text to markdown renderer.<br>Provide unit tests covering nested lists, localized bullets, and edge-case em-dash bullets. This removes brittle ad-hoc handling inside <code>_render_cell_text</code>.                                                                                                                                                                         </td></tr><tr><td data-label="Area / Change"> <strong>Column type detection & alignment</strong>         </td><td data-label="World-class fix (concise, actionable)"> Make <code>_detect_column_types</code> conservative and configurable: sample up to <code>column_type_sample</code> rows, require ≥70% parseable numeric after cleaning for numeric type. Strip currency symbols and thousands separators before numeric parse. Expose <code>alignment_overrides</code> option. Treat numeric vs text as presentation hint only; never change underlying cell HTML semantics. Add a <code>col_type_confidence</code> output so client can prefer but not rely on server-provided alignment.                                                                                                                                                                      </td></tr><tr><td data-label="Area / Change"> <strong>HTML generation: skeleton and ARIA</strong>        </td><td data-label="World-class fix (concise, actionable)"> Emit semantic skeleton only: wrapper <code>&lt;div data-table-id=&quot;table-017&quot; id=&quot;wrapper-table-017&quot; data-table-index=&quot;17&quot; aria-describedby=&quot;caption-table-017&quot;&gt;</code> and <code>&lt;table role=&quot;table&quot; aria-labelledby=&quot;table-label-table-017&quot; aria-describedby=&quot;caption-table-017&quot;&gt;</code>. <strong>Do not emit <code>&lt;caption&gt;</code></strong>. Include <code>id</code> placeholders for client-injected caption (e.g., <code>caption-table-017</code>). If captions absent, do not create the caption id. Ensure <code>hidden anchor</code> logic uses <code>data-table-id</code> consistently.                                                                                                                                                 </td></tr><tr><td data-label="Area / Change"> <strong>Client contract & injectCaptions() shape</strong>  </td><td data-label="World-class fix (concise, actionable)"> Define <code>injectCaptions(payload)</code> signature precisely: <code>payload = { wrapper_id, table_id, captions: [{fragment_id,id,type,text_html,text_plain,source}] }</code>.<br>Client must:<br>1. find wrapper by <code>[data-table-id=wrapper_id]</code>;<br>2. for each caption: if element <code>#caption-{id}</code> exists update innerText/innerHTML idempotently; else create <code>&lt;caption id=&quot;caption-{id}&quot; class=&quot;table-caption&quot; role=&quot;note&quot;&gt;</code> and insert as first child of table;<br>3. preserve <code>text_plain</code> as fallback and prefer sanitized <code>text_html</code> only if trusted. Provide short pseudo-code in docs.                                                                      </td></tr><tr><td data-label="Area / Change"> <strong>Backward compatibility & opt-in migration</strong> </td><td data-label="World-class fix (concise, actionable)"> Add <code>emit_captions_inline=True</code> option to preserve legacy behavior. Default rollout path: ship both payload script and legacy caption HTML for N releases (<code>emit_captions_inline=True</code>), then flip default to <code>False</code> after verifying <code>injectCaptions</code> presence. Add <code>metadata[&quot;caption_migration&quot;]=&quot;pending complete&quot;</code> and deprecation messages. Provide a small integration test (payload present, client injects, legacy captions removed or ignored).                                                                                                                                                                                           </td></tr><tr><td data-label="Area / Change"> <strong>Lazy loading & streaming memory use</strong>       </td><td data-label="World-class fix (concise, actionable)"> Replace <code>parts: List[str]</code> accumulation with <code>io.StringIO()</code> or generator-based streaming to reduce peak memory for large tables. Provide <code>render_table(..., stream=True)</code> that writes directly to a file-like writer and returns metadata/payload only. For lazy-load chunks, keep embedding compact JSON blocks but consider emitting them as compressed/base64 script if extremely large. Document memory and CPU trade-offs and provide <code>max_rows_in_memory</code> config.                                                                                                                                                                            </td></tr><tr><td data-label="Area / Change"> <strong>Security (XSS / HTML safety)</strong>              </td><td data-label="World-class fix (concise, actionable)"> Sanitize all HTML from markdown renderer using <code>sanitize_html</code> with explicit policy (allow_tables=True when needed). For caption <code>text_html</code>, either require server-sanitized HTML or emit only <code>text_plain</code>. Never trust client to sanitize <code>text_html</code>. In payload, do not embed unsanitized raw code — encode or omit. Add CSP guidance for consumers and require <code>injectCaptions</code> to insert via <code>textContent</code> or sanitized <code>innerHTML</code> only after validation.                                                                                                                                                                                   </td></tr><tr><td data-label="Area / Change"> <strong>Safe JSON embedding</strong>                       </td><td data-label="World-class fix (concise, actionable)"> Replace <code>_safe_json_for_script</code> with a stricter routine that:<br>1. JSON-encodes with <code>ensure_ascii=False</code>;<br>2. escapes <code>&lt;/script&gt;</code> sequences (<code>&lt;/script&gt;</code> → <code>&lt;\\/script&gt;</code>);<br>3. replaces control chars U+0000–U+001F with <code>\uXXXX</code>;<br>4. optionally base64-encode large binary sub-payloads.<br>Add unit tests validating JSON round-trip and no accidental script injection.                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Area / Change"> <strong>Testing strategy (world-class)</strong>            </td><td data-label="World-class fix (concise, actionable)"> Add unit tests for: stash/restore, placeholder token round-trip, <code>_is_likely_csv_text</code> delimiters, <code>_sniff_delimiter</code> scoring, <code>parse_csv_safe</code> fallbacks, <code>_detect_column_types</code> thresholds, and caption payload schema validation. Add integration tests simulating DOM injection (headless DOM) verifying idempotency and no duplicate captions. Add fuzz tests for CSVs and markdown edge cases. Add CI matrix for pandas/no-pandas, xlsxwriter/openpyxl presence permutations.                                                                                                                                                                 </td></tr><tr><td data-label="Area / Change"> <strong>Logging & telemetry</strong>                       </td><td data-label="World-class fix (concise, actionable)"> Add structured warnings in <code>metadata[&quot;warnings&quot;]</code> for heuristics used (<code>csv_sniff_fallback</code>, <code>pandas_failed</code>) and include <code>id_map</code> mapping <code>table_index-&gt;table_id-&gt;fragment_id</code>. Emit <code>logger.info</code> lines on PARSE_TRY/PARSE_OK/PARSE_FAIL with contextualized short summaries. Keep logs machine-parseable (JSON lines) when <code>options.get(&#x27;telemetry&#x27;,True)</code>.                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Area / Change"> <strong>Migration patch outline (concrete steps)</strong>  </td><td data-label="World-class fix (concise, actionable)"> 1) Add <code>CaptionFragment</code> model + ID generator in <code>core_fragments.py</code>.<br>2) Add <code>emit_captions_inline</code> flag to <code>render_table</code> and refactor to optionally omit <code>&lt;caption&gt;</code> and return payload.<br>3) Add <code>html_renderer.py</code> to insert <code>&lt;script data-caption-payload&gt;</code> adjacent to wrapper when payload exists.<br>4) Harden <code>_safe_json_for_script</code> and add <code>sanitize_caption_for_json()</code> in <code>sanitize.py</code>.<br>5) Update <code>script.core.js</code> to parse payloads and call <code>injectCaptions(payload)</code>; ship client lib and docs.<br>6) Run unit+integration tests; stage rollout.                                                                           </td></tr><tr><td data-label="Area / Change"> <strong>Quick example payload (minimal)</strong>           </td><td data-label="World-class fix (concise, actionable)"> <code>{&quot;caption_payload_version&quot;:&quot;1.0&quot;,&quot;wrapper_id&quot;:&quot;wrapper-abc123&quot;,&quot;table_id&quot;:&quot;table-docpath-17&quot;,&quot;table_index&quot;:17,&quot;captions&quot;:[{&quot;fragment_id&quot;:&quot;frag-docpath-17-1&quot;,&quot;id&quot;:&quot;caption-table-docpath-17&quot;,&quot;type&quot;:&quot;table&quot;,&quot;text_html&quot;:&quot;&lt;strong&gt;Topic 17&lt;/strong&gt;&quot;,&quot;text_plain&quot;:&quot;Topic 17&quot;,&quot;source&quot;:{&quot;file&quot;:&quot;doc.md&quot;,&quot;line&quot;:123}}],&quot;meta&quot;:{&quot;rows&quot;:120,&quot;cols&quot;:6,&quot;alignments&quot;:[&quot;left&quot;,&quot;right&quot;],&quot;tv_options&quot;:{}}}</code>                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Area / Change"> <strong>Developer checklist before flip</strong>           </td><td data-label="World-class fix (concise, actionable)"> core_fragments deterministic IDs ✅<br>sanitize.py JSON-safe helpers ✅<br>replace NUL placeholders with <code>__PTT_*__</code> tokens ✅<br>emit_captions_inline flag present ✅<br>html_renderer emits <code>&lt;script data-caption-payload&gt;</code> ✅<br>script.core.js <code>injectCaptions</code> idempotent & documented ✅<br>unit+integration+snapshot tests green ✅<br>streaming/render_into writer option added ✅<br>rollout plan & telemetry ✅                                                                                                                                                                                                                                    </td></tr></tbody></table></div><div class="row-count">Rows: 21</div></div><div class="table-caption" id="Table7" data-table="Docu_0121_07" style="margin-top:2mm;margin-left:3mm;"><strong>Table 7</strong></div>
<div class="table-wrapper" data-table-id="table-7"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Area / Change"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Area / Change</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by World-class fix (concise, actionable)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">World-class fix (concise, actionable)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Area / Change"> <strong>Renderer discovery (robust import)</strong>        </td><td data-label="World-class fix (concise, actionable)"> Replace loose try/import + file-load probing with a small helper <code>find_renderer()</code> that returns <code>(fn, source_desc)</code> and logs deterministic reasons. Fail fast with a clear debug-level log showing probe order and what succeeded. Keep current fallbacks but limit file-load attempts to configured directories (<code>RENDER_PATHS</code>) and add a short-circuit timeout for pathological loads. </td></tr><tr><td data-label="Area / Change"> <strong>Renderer signature handling</strong>               </td><td data-label="World-class fix (concise, actionable)"> Replace nested <code>try: ... except TypeError</code> calls with an adapter function <code>call_renderer(fn, text, options)</code> that inspects <code>inspect.signature(fn)</code> and calls the correct signature (preferred <code>(text, options)</code>, fallback <code>(text,)</code>). This avoids swallowing unrelated <code>TypeError</code>s and provides better logs when signatures mismatch.                                                    </td></tr><tr><td data-label="Area / Change"> <strong>Core caption injector invocation</strong>          </td><td data-label="World-class fix (concise, actionable)"> Wrap injector invocation in a small adapter <code>call_caption_injector(fn, html, meta)</code> that inspects signature, enforces non-destructive behavior, and validates return types. If injector returns <code>dict</code>, require keys <code>html</code> and/or <code>meta</code>; if returns <code>str</code> accept as html. On injector failure, log once at WARN and continue. Add unit test asserting tolerant behavior.                </td></tr><tr><td data-label="Area / Change"> <strong>Fallback renderer safety</strong>                  </td><td data-label="World-class fix (concise, actionable)"> Keep HTML-escaping but simplify: centralize fallback into <code>_fallback_convert_text_to_html()</code> and ensure it never returns untrusted innerHTML. Return <code>{&quot;html&quot;:&quot;&lt;pre&gt;…&lt;/pre&gt;&quot;,&quot;metadata&quot;:{&quot;converted&quot;:False,&quot;source&quot;:&quot;fallback&quot;}}</code>. Add test for non-ASCII and large input.                                                                                                                </td></tr><tr><td data-label="Area / Change"> <strong>render_from_text normalization & contract</strong> </td><td data-label="World-class fix (concise, actionable)"> Normalize outputs to exact contract early: always return <code>{&quot;html&quot;: str, &quot;metadata&quot;: dict}</code>. Ensure <code>metadata</code> keys <code>converted: bool</code>, <code>warnings: []</code>, <code>caption_payload</code>: optional. Validate and coerce before use. This makes downstream code simpler and predictable.                                                                                                                    </td></tr><tr><td data-label="Area / Change"> <strong>Safe injector integration (non-blocking)</strong>  </td><td data-label="World-class fix (concise, actionable)"> Do not run injector synchronously in the hot POST path if it can be expensive. Instead: attempt to call injector with a short-circuit guard (e.g., <code>if options.get(&quot;apply_captions&quot;, True)</code>), catch exceptions and attach <code>metadata[&quot;caption_injector_error&quot;]</code> rather than letting it fail the render. Keep behavior idempotent.                                                          </td></tr><tr><td data-label="Area / Change"> <strong>render_html() structure and streaming</strong>     </td><td data-label="World-class fix (concise, actionable)"> Replace list-accumulation <code>parts: List[str]</code> with an <code>io.StringIO()</code> writer and support <code>stream=False/True</code>. If <code>stream=True</code> accept a file-like <code>writer</code> param and write progressively. Ensure wrapper <code>section</code> ids use deterministic <code>table_id</code> if provided (accept optional <code>tbl.table_id</code>), otherwise fall back with a stable prefix + index.                                        </td></tr><tr><td data-label="Area / Change"> <strong>Stable IDs exposure</strong>                       </td><td data-label="World-class fix (concise, actionable)"> Allow callers to pass <code>table_id</code>/<code>wrapper_id</code> into <code>render_html</code> (or let <code>core_table</code> supply them). When none provided, produce deterministic ids via <code>stable_id(source_path, index)</code> helper (hash + index). Document the id format and include it in returned metadata.                                                                                                                  </td></tr><tr><td data-label="Area / Change"> <strong>Asset hash computation</strong>                    </td><td data-label="World-class fix (concise, actionable)"> Tighten <code>_compute_asset_hash()</code> to: (1) prefer <code>ASSET_HASH</code> env var, (2) if missing compute SHA1 over file paths + mtimes but limit to known asset file extensions and a configurable depth, (3) fall back to a fixed fallback string (not current time) in test mode. Add cache and make it deterministic across runs.                                                                   </td></tr><tr><td data-label="Area / Change"> <strong>/save endpoint path-safety</strong>                </td><td data-label="World-class fix (concise, actionable)"> Current path-safety is good but be explicit: use <code>os.path.realpath</code> checks and reject filenames with <code>..</code> or absolute paths. Limit saved file size (configurable) and sanitize <code>filename</code> to <code>safe_name</code> earlier. Return HTTP 413 if content too large. Add unit tests.                                                                                                                   </td></tr><tr><td data-label="Area / Change"> <strong>/api/render input handling & size limits</strong>  </td><td data-label="World-class fix (concise, actionable)"> Enforce a maximum payload length (configurable, default e.g. 200KB) and return a clear error if exceeded. Coerce <code>text</code> extraction to prefer JSON body <code>text</code> → form <code>text</code> → empty; set <code>options</code> defaults strictly. Add logging for client-supplied <code>options</code>.                                                                                                                          </td></tr><tr><td data-label="Area / Change"> <strong>Response safety headers & CSP guidance</strong>    </td><td data-label="World-class fix (concise, actionable)"> Good defaults already set. Add <code>Content-Security-Policy</code> guidance in comments (do not hard-fail) and ensure <code>render_from_text</code> never returns unescaped user HTML unless <code>metadata[&quot;trusted&quot;]</code> is explicitly set by the renderer.                                                                                                                                                          </td></tr><tr><td data-label="Area / Change"> <strong>JSON wrapper for APIs</strong>                     </td><td data-label="World-class fix (concise, actionable)"> Ensure <code>_api_render</code> returns <code>{&quot;ok&quot;: True/False, &quot;status&quot;: &quot;...&quot;, &quot;html&quot;: &quot;...&quot;, &quot;meta&quot;: {...}}</code> with <code>meta.warnings</code> array. Keep HTTP status codes aligned (200 for success, 4xx for client errors, 500 for server). Add small schema validation test.                                                                                                                                   </td></tr><tr><td data-label="Area / Change"> <strong>Logging & telemetry fields</strong>                </td><td data-label="World-class fix (concise, actionable)"> Add structured metadata keys on success/failure: <code>meta[&quot;render_source&quot;]=&quot;project&quot;</code>/<code>&quot;fallback&quot;</code>, <code>meta[&quot;injector_used&quot;]=True/False</code>, <code>meta[&quot;table_count&quot;]=N</code>. Log these at INFO for successful renders and WARN on fallback. Keep logs machine-parseable when <code>options.get(&quot;telemetry&quot;, True)</code>.                                                                                           </td></tr><tr><td data-label="Area / Change"> <strong>Unit/integration tests</strong>                    </td><td data-label="World-class fix (concise, actionable)"> Add tests exercising: renderer discovery (module import vs file-load), signature permutations, injector success/failure, render_html streaming, id generation, asset-hash determinism, /save path-safety, and /api/render input size limits. Include one integration test simulating a renderer returning <code>{&quot;html&quot;,&quot;metadata&quot;,&quot;captions&quot;}</code> and verifying the adapter preserves payload.   </td></tr><tr><td data-label="Area / Change"> <strong>Error handling clarity</strong>                    </td><td data-label="World-class fix (concise, actionable)"> Avoid overly broad <code>except Exception:</code> swallowing. Narrow catch blocks where possible and include contextual log messages. Re-raise or return structured error metadata so callers (or tests) can assert on failure reasons.                                                                                                                                                              </td></tr><tr><td data-label="Area / Change"> <strong>Docstrings & developer notes</strong>              </td><td data-label="World-class fix (concise, actionable)"> Add concise docstrings to <code>render_from_text</code>, <code>_fallback_convert_text_to_html</code>, and <code>render_html</code> describing input types, return contract, and caption-injector behavior. Include a short comment describing the caption pipeline and where injection should occur (core_renderer/html_renderer).                                                                                         </td></tr><tr><td data-label="Area / Change"> <strong>Backwards compatibility & opt-in flags</strong>    </td><td data-label="World-class fix (concise, actionable)"> Add <code>options</code> flags: <code>apply_caption_injector</code> (default True), <code>stream</code> (default False), <code>max_input_size</code>, <code>emit_legacy_captions</code> (default True for rollout). Document their usage and ensure <code>create_app</code> exposes config via <code>cfg</code>.                                                                                                                                                       </td></tr><tr><td data-label="Area / Change"> <strong>Minor quality: imports & typing</strong>           </td><td data-label="World-class fix (concise, actionable)"> Move heavy imports (importlib.machinery) inside branch that needs them to speed module import. Add narrow typing for returned metadata: <code>Dict[str, Any]</code> with documented keys. Use <code>logging.getLogger(__name__)</code> and consistent logger name.                                                                                                                                              </td></tr></tbody></table></div><div class="row-count">Rows: 19</div></div><div class="table-caption" id="Table8" data-table="Docu_0121_08" style="margin-top:2mm;margin-left:3mm;"><strong>Table 8</strong></div>
<div class="table-wrapper" data-table-id="table-8"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Area / Change"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Area / Change</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by World-class fix (concise, actionable)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">World-class fix (concise, actionable)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Area / Change"> <strong>Table conversion & canonical rows</strong>       </td><td data-label="World-class fix (concise, actionable)"> Centralize table parsing in <code>convert.py</code>: produce row objects with consistent indexing, capture source file/line, and table/figure index. Provide explicit metadata per row and per table for downstream processing. Avoid inline HTML injection; keep skeletal structure only. </td></tr><tr><td data-label="Area / Change"> <strong>TOC initialization & anchors</strong>            </td><td data-label="World-class fix (concise, actionable)"> <code>init_toc</code> must scan headings and assign deterministic <code>id</code>s, update anchor links, and build hierarchical TOC. Normalize heading text (remove extra whitespace, escape unsafe chars). Preserve hierarchy when headings repeat by adding stable suffixes.                        </td></tr><tr><td data-label="Area / Change"> <strong>Toast notifications & alerts</strong>            </td><td data-label="World-class fix (concise, actionable)"> Use a single <code>show_toast(message, type, duration)</code> helper. Ensure only one toast container exists. Fade in/out smoothly; queue messages if multiple calls occur in rapid succession. Make type-safe (<code>info</code>, <code>warning</code>, <code>error</code>) and style consistent with UI theme.            </td></tr><tr><td data-label="Area / Change"> <strong>Clipboard copy functionality</strong>            </td><td data-label="World-class fix (concise, actionable)"> Wrap <code>navigator.clipboard.writeText</code> in try/catch. Provide fallback for older browsers via temporary <code>&lt;textarea&gt;</code>. Trigger <code>show_toast</code> on success/failure. Do not modify DOM elements beyond necessary for fallback.                                                           </td></tr><tr><td data-label="Area / Change"> <strong>Event delegation & listener management</strong>  </td><td data-label="World-class fix (concise, actionable)"> Attach event listeners at container level, not per element. Use <code>data-action</code> attributes to identify actions. Remove unused listeners on element removal to avoid memory leaks. Document delegation strategy.                                                                   </td></tr><tr><td data-label="Area / Change"> <strong>CSV / TSV / text input parsing</strong>          </td><td data-label="World-class fix (concise, actionable)"> Detect delimiter with scoring (mean/variance of field counts per line). Allow <code>force_delimiter</code> override. Use fallback parsing without pandas if unavailable. Normalize line endings and strip BOM.                                                                             </td></tr><tr><td data-label="Area / Change"> <strong>Markdown & inline formatting</strong>            </td><td data-label="World-class fix (concise, actionable)"> Provide pluggable markdown renderer (<code>markdown_to_html_func</code>) with strict feature flags: <code>allow_html</code>, <code>allow_fenced_code</code>, <code>allow_lists</code>. Normalize line breaks outside code blocks (<code>\n</code> → <code>  \n</code>). Escape untrusted HTML.                                                    </td></tr><tr><td data-label="Area / Change"> <strong>Nested list normalization</strong>               </td><td data-label="World-class fix (concise, actionable)"> Stash fenced/code blocks, normalize bullets/numbers, restore blocks, then render. Ensure deterministic indentation and consistent marker style (<code>- </code> for bullets, <code>1.</code> for numbers). Unit tests for edge cases.                                                                 </td></tr><tr><td data-label="Area / Change"> <strong>Column type detection & alignment</strong>       </td><td data-label="World-class fix (concise, actionable)"> Sample up to <code>column_type_sample</code> rows. Require ≥70% parseable numeric for numeric type. Strip currency symbols and thousands separators before parse. Provide <code>alignment_overrides</code> and <code>col_type_confidence</code>.                                                                 </td></tr><tr><td data-label="Area / Change"> <strong>HTML skeleton & ARIA compliance</strong>         </td><td data-label="World-class fix (concise, actionable)"> Emit <code>&lt;div&gt;</code> and <code>&lt;table&gt;</code> with semantic <code>id</code>, <code>data-table-id</code>, <code>aria-labelledby</code>, <code>aria-describedby</code>. Do not emit <code>&lt;caption&gt;</code>. Include placeholder <code>id</code>s for client-injected captions. Ensure hidden anchors consistent.                                                       </td></tr><tr><td data-label="Area / Change"> <strong>Client caption injection contract</strong>       </td><td data-label="World-class fix (concise, actionable)"> Define <code>injectCaptions(payload)</code> signature: locate wrapper by <code>data-table-id</code>, update or create caption elements with sanitized <code>text_html</code>, fallback to <code>text_plain</code>. Idempotent insertion. Provide pseudo-code in docs.                                                       </td></tr><tr><td data-label="Area / Change"> <strong>Backward compatibility & migration path</strong> </td><td data-label="World-class fix (concise, actionable)"> Add <code>emit_captions_inline=True</code> option. Ship both payload and legacy captions for initial releases. Include metadata marker <code>caption_migration=&quot;pending complete&quot;</code>. Flip default after verification.                                                                            </td></tr><tr><td data-label="Area / Change"> <strong>Lazy loading & memory optimization</strong>      </td><td data-label="World-class fix (concise, actionable)"> Replace list accumulation with generator or <code>io.StringIO</code>. Support <code>render_table(..., stream=True)</code> writing to file-like object. For very large tables, emit compressed/base64 JSON payloads. Document memory trade-offs.                                                       </td></tr><tr><td data-label="Area / Change"> <strong>Sanitization & XSS safety</strong>               </td><td data-label="World-class fix (concise, actionable)"> Sanitize all markdown-rendered HTML using <code>sanitize_html</code>. Only allow server-sanitized HTML in <code>text_html</code>. Encode or omit raw code in JSON. Follow CSP best practices.                                                                                                         </td></tr><tr><td data-label="Area / Change"> <strong>Safe JSON embedding</strong>                     </td><td data-label="World-class fix (concise, actionable)"> Strict routine: JSON encode with <code>ensure_ascii=False</code>, escape <code>&lt;/script&gt;</code>, replace control chars U+0000–U+001F with <code>\uXXXX</code>, optionally base64-encode large payloads. Unit tests to ensure round-trip safety.                                                                  </td></tr><tr><td data-label="Area / Change"> <strong>Logging & telemetry</strong>                     </td><td data-label="World-class fix (concise, actionable)"> Structured warnings in <code>metadata[&quot;warnings&quot;]</code>. Map <code>table_index-&gt;table_id-&gt;fragment_id</code>. Emit machine-readable logs (<code>logger.info</code>) for parse attempts and outcomes. Include context for analytics and debugging.                                                               </td></tr><tr><td data-label="Area / Change"> <strong>Testing & QA</strong>                            </td><td data-label="World-class fix (concise, actionable)"> Unit tests for conversion, placeholder round-trip, delimiter detection, markdown normalization, and caption injection. Integration tests with headless DOM, CSV edge cases, and fallback paths. CI coverage across pandas/no-pandas and library permutations.                   </td></tr><tr><td data-label="Area / Change"> <strong>Quick developer checklist before flip</strong>   </td><td data-label="World-class fix (concise, actionable)"> deterministic IDs ✅<br>sanitize helpers ✅<br>placeholder tokens ✅<br>emit_captions_inline flag ✅<br>client injectCaptions idempotent ✅<br>unit+integration tests ✅<br>streaming writer option ✅<br>rollout plan & telemetry ✅                                                   </td></tr></tbody></table></div><div class="row-count">Rows: 18</div></div><div class="table-caption" id="Table9" data-table="Docu_0121_09" style="margin-top:2mm;margin-left:3mm;"><strong>Table 9</strong></div>
<div class="table-wrapper" data-table-id="table-9"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Area / Change"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Area / Change</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by World-class fix (concise, actionable)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">World-class fix (concise, actionable)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Area / Change"> <strong>Responsive table control styling</strong>        </td><td data-label="World-class fix (concise, actionable)"> Consolidate mobile vs desktop adjustments: apply consistent flex, gap, padding, fontSize, width/height on toggle and copy buttons. Use <code>Array.from(...).forEach</code> for iteration, clear all inline styles when reverting. Debounce <code>optimizeTableControls</code> and trigger on <code>resize</code> and <code>matchMedia</code> change events.                                                                                </td></tr><tr><td data-label="Area / Change"> <strong>Table container enforcement</strong>             </td><td data-label="World-class fix (concise, actionable)"> Wrap all <code>.table-wrapper &gt; table</code> elements in <code>.table-container</code> if missing. Insert container before the table to maintain DOM order and prevent layout shift.                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Area / Change"> <strong>TOC generation with fallback</strong>            </td><td data-label="World-class fix (concise, actionable)"> Prefer <code>PTToc.init</code> for TOC; fallback to <code>buildSingleTableToc</code> and <code>buildTocFromCaptions</code>. Perform immediate and delayed build (setTimeout) to account for late-loaded elements.                                                                                                                                                                                                                </td></tr><tr><td data-label="Area / Change"> <strong>Row UID and sort state initialization</strong>   </td><td data-label="World-class fix (concise, actionable)"> Assign unique IDs to rows and maintain snapshot states for headers. Initialize <code>sortStates[idx]</code> array with length matching table columns, defaulting to 0.                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Area / Change"> <strong>Original cell HTML caching</strong>              </td><td data-label="World-class fix (concise, actionable)"> Cache <code>innerHTML</code> of all <code>&lt;td&gt;</code> and <code>&lt;th&gt;</code> in <code>data-orig-html</code> on first pass, idempotent, to support reset or export operations.                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Area / Change"> <strong>Header sort UI updates</strong>                  </td><td data-label="World-class fix (concise, actionable)"> Call <code>updateHeaderSortUI(idx)</code> for each table to refresh icons and indicators, maintaining visual sort state.                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Area / Change"> <strong>Toggle button labels</strong>                    </td><td data-label="World-class fix (concise, actionable)"> Update <code>.toggle-table-btn</code> text based on <code>.table-collapsed</code> class. Adjust global <code>#toggleAllBtn</code> to reflect any expanded tables.                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Area / Change"> <strong>Back-to-top button creation & scroll</strong>    </td><td data-label="World-class fix (concise, actionable)"> Create <code>#backToTop</code> once if missing; wire click to <code>backToTop()</code> smooth scroll. Toggle visibility on <code>scroll</code> event when document scrolled >200px.                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Area / Change"> <strong>Search box wiring</strong>                       </td><td data-label="World-class fix (concise, actionable)"> Bind input and keyup events (Enter triggers search). Use debounced <code>searchTable</code>. Guard against multiple bindings via <code>dataset.tvBound</code>.                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Area / Change"> <strong>Per-table action handlers</strong>               </td><td data-label="World-class fix (concise, actionable)"> Attach click handlers for toggle, copy, export buttons; idempotent via <code>dataset.tvHandlerAttached</code> and <code>tvTableIndex</code>. Skip buttons with inline <code>onclick</code>.                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Area / Change"> <strong>Optimize controls & row counts</strong>          </td><td data-label="World-class fix (concise, actionable)"> Call <code>optimizeTableControls()</code> and <code>updateRowCounts()</code> after initialization, with delayed retry to ensure layout correctness.                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Area / Change"> <strong>Scroll into first table</strong>                 </td><td data-label="World-class fix (concise, actionable)"> Smooth scroll to first <code>.table-wrapper</code> to improve user focus.                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Area / Change"> <strong>Global click delegation: sorting</strong>        </td><td data-label="World-class fix (concise, actionable)"> Delegate clicks on <code>.sort-btn</code> or <code>th[role=button]</code> to <code>headerSortButtonClicked(tableIdx, colIdx, hit)</code>. Prevent default action.                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Area / Change"> <strong>Global click delegation: TOC navigation</strong> </td><td data-label="World-class fix (concise, actionable)"> Intercept clicks on <code>#tocBar a[href^=&#x27;#&#x27;]</code>. Smooth scroll to target header or table wrapper, adjust for sticky header offset, update history state, focus target element.                                                                                                                                                                                                                       </td></tr><tr><td data-label="Area / Change"> <strong>Keyboard shortcuts</strong>                      </td><td data-label="World-class fix (concise, actionable)"> <code>/</code> focuses search box unless inside input/textarea/contentEditable. <code>Escape</code> triggers <code>backToTop()</code>.                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Area / Change"> <strong>Export all tables</strong>                       </td><td data-label="World-class fix (concise, actionable)"> Prefer XLSX via SheetJS: build workbook, append sheets with truncated names, write to file. Fallback: export all tables to Markdown, download as <code>.md</code>. Show appropriate toasts.                                                                                                                                                                                                                </td></tr><tr><td data-label="Area / Change"> <strong>Idempotent exposure of public API</strong>       </td><td data-label="World-class fix (concise, actionable)"> Expose functions like <code>toggleTable</code>, <code>copyTablePlain</code>, <code>exportTableCSV</code>, <code>exportAllBtnHandler</code> only if not already defined to avoid overwrites.                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Area / Change"> <strong>Initialization on DOM ready</strong>             </td><td data-label="World-class fix (concise, actionable)"> Execute <code>initRenderedContent()</code> immediately if <code>document.readyState !== &quot;loading&quot;</code>, otherwise bind to <code>DOMContentLoaded</code>. Wire keyboard shortcuts and update row counts.                                                                                                                                                                                                                        </td></tr><tr><td data-label="Area / Change"> <strong>Error resilience</strong>                        </td><td data-label="World-class fix (concise, actionable)"> Wrap all DOM interactions in try/catch blocks to prevent one failure from halting initialization.                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Area / Change"> <strong>Performance & debouncing</strong>                </td><td data-label="World-class fix (concise, actionable)"> Use a single debounced <code>_debouncedOptimize</code> instance. Minimize repeated DOM queries where feasible.                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Area / Change"> <strong>Developer checklist before deployment</strong> </td><td data-label="World-class fix (concise, actionable)"> Verify:<br>- responsive styling works on mobile/desktop ✅<br>- TOC builds correctly with PTToc and fallback ✅<br>- row UIDs and sort states assigned ✅<br>- caching of original HTML ✅<br>- all per-table actions wired once ✅<br>- export XLSX and Markdown ✅<br>- back-to-top smooth scroll ✅<br>- keyboard shortcuts functional ✅<br>- idempotent public API ✅<br>- debounce effective ✅<br>- no uncaught exceptions on initialization ✅ </td></tr></tbody></table></div><div class="row-count">Rows: 21</div></div><div class="table-caption" id="Table10" data-table="Docu_0121_10" style="margin-top:2mm;margin-left:3mm;"><strong>Table 10</strong></div>
<div class="table-wrapper" data-table-id="table-10"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Area"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Area</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Assessment"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Assessment</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Area"> <strong>Role in caption pipeline</strong>      </td><td data-label="Assessment"> Fully compliant. The file performs <em>only</em> sanitization. It does not alter structure, generate captions, or touch fragment IDs. Safe for server-owned captions architecture.                                                                                  </td></tr><tr><td data-label="Area"> <strong>Safety of caption text</strong>        </td><td data-label="Assessment"> Correct. <code>_neutralize_script_tags_outside_code</code> ensures literal <code>&lt;script&gt;</code> in captions remains visible inside code blocks while dangerous ones are neutralized. Captions passing through <code>sanitize_html()</code> remain safe for embedding.                        </td></tr><tr><td data-label="Area"> <strong>ID preservation</strong>               </td><td data-label="Assessment"> Safe. IDs on headings, figures, tables, etc. are allowed by <code>ALLOWED_ATTRIBUTES(&quot;*&quot;) → id</code>. Nothing here modifies IDs, so caption fragments referencing stable IDs will resolve correctly.                                                                   </td></tr><tr><td data-label="Area"> <strong>Table safety</strong>                  </td><td data-label="Assessment"> Correct separation: <code>allow_tables</code> gates only table tags. Captions (<code>figcaption</code>) are included in <code>TABLE_TAGS</code>, therefore emitted only when <code>allow_tables=True</code> (which convert.py will set for table blocks).                                                </td></tr><tr><td data-label="Area"> <strong>Image rules</strong>                   </td><td data-label="Assessment"> Strict and safe: enforces MIME type and full <code>data:image/...;base64</code> pattern. No conflict with captions containing images.                                                                                                                                   </td></tr><tr><td data-label="Area"> <strong>Attribute wildcard behavior</strong>   </td><td data-label="Assessment"> Good: <code>data-*</code>, <code>aria-*</code> survive. This is required because caption injection payloads and DOM nodes often need <code>data-caption-id</code>.                                                                                                                            </td></tr><tr><td data-label="Area"> <strong>Mixed bleach / fallback modes</strong> </td><td data-label="Assessment"> Works: bleach cleaned then additional attribute sanitizing uses <code>_sanitize_tag</code>. Fallback cleaner does not break caption content.                                                                                                                            </td></tr><tr><td data-label="Area"> <strong>Script neutralization logic</strong>   </td><td data-label="Assessment"> Structured split by <code>&lt;pre&gt;</code> and <code>&lt;code&gt;</code> ensures code examples containing script syntax remain human-readable. Good for documentation pages.                                                                                                                 </td></tr><tr><td data-label="Area"> <strong>Impact on caption JSON blocks</strong> </td><td data-label="Assessment"> JSON payload is emitted inside <code>&lt;script data-caption-payload type=&quot;application/json&quot;&gt;</code>. Sanitizer does not touch the block because sanitize_html() is used only on rendered HTML fragments <em>before</em> html_renderer injects payload. This avoids interference. </td></tr><tr><td data-label="Area"> <strong>Bugs / risks found</strong>            </td><td data-label="Assessment"> None affecting your caption architecture. Only one optional improvement: Bleach+linkify may wrap text that looks like URLs in captions; if captions must remain verbatim, we disable linkify for caption text specifically.                                  </td></tr></tbody></table></div><div class="row-count">Rows: 10</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>