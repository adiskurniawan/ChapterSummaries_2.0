<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1764314629">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#Table6">Table 6</a></li>
<li class="toc-item"><a class="toc-link" href="#Table7">Table 7</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0144_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **Technical Breakdown**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Name</strong><br/>modMain.bas</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Purpose</strong><br/>Orchestrator for end-to-end PPh21 job runs. Coordinates settings loading, job folder creation, input ingestion, rules/config loading, per-row computation (modCalc), CSV export (modIO), manifest creation (modManifest), optional import back to output sheets, logging, and safe shutdown/cleanup. Keeps orchestration concerns separate from domain logic and I/O primitives.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Design Principles</strong><br/>• Orchestration-only: no tax logic in modMain; delegate calculations to modCalc.<br/>• Deterministic control flow: identical inputs + config → identical outputs and side effects.<br/>• Fail-safe: catch/log all errors; return controlled failure states rather than raising unhandled errors to users.<br/>• Idempotence: safe re-runs when JOB_ID is reused (overwrites atomically).<br/>• Minimal top-level dependencies: use modUtils, modIO, modCalc, modManifest for primitives.<br/>• Observable: emit concise, structured logs and summary artifacts for audit.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Public API (recommended signatures)</strong><br/>Public Sub pph21_RunAll()<br/>Public Function InitializeJob(Optional ByVal providedJobId As String = "") As Boolean<br/>Public Function LoadSettings() As Object ' returns Dictionary (late-bound)<br/>Public Function LoadRules() As Boolean<br/>Public Function ReadInput() As Object ' rows dictionary collection<br/>Public Function ProcessAllRows(rows As Object, Optional ByVal resumeFrom As Long = -1) As Object ' returns results container (collection/array/dict)<br/>Public Function WriteOutputs(results As Object) As Boolean<br/>Public Function GenerateManifest(ByVal jobFolder As String, ByVal jobId As String) As Boolean<br/>Public Function ImportOutputsToSheets(ByVal jobFolder As String) As Boolean<br/>Public Sub AbortCleanup(ByVal errContext As String, Optional ByVal fatal As Boolean = True)</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Settings keys (expected)</strong><br/>OUTPUT_BASE (absolute path)<br/>JOB_ID (optional, persisted)<br/>RULES_BRACKETS_SHEET / RULES_PARAMS_SHEET<br/>INCLUDE_BPJS_FIELDS (true/false)<br/>VERBOSE (true/false)<br/>RETRY_ATTEMPTS (integer) / RETRY_DELAY_MS (integer)<br/>MOD_VERSION (string)<br/>EXPORT_LEGACY_SCHEMA (true/false)</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>JOB_ID semantics &amp; folder layout</strong><br/>• JOB_ID format: job_YYYYMMDD_HHNNSS (generated when absent).<br/>• If providedJobId passed to InitializeJob → use as-is (idempotent run).<br/>• Path: OUTPUT_BASE\<job_id>\ (created via modUtils.EnsureFolder).<br/>• Job outputs: bukti_potong.csv, per11_payload.csv, manifest.json, logs.csv (or Logs sheet snapshot).</job_id></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>High-level run flow (pph21_RunAll)</strong><br/>1. LoadSettings() → read Settings sheet (first 100 rows) into Dictionary.<br/>2. Validate and normalize OUTPUT_BASE; ensure via modUtils.EnsureFolder.<br/>3. InitializeJob(providedJobId) → determine JOB_ID, create jobFolder, create lockfile (.lock.tmp → .lock).<br/>4. LoadRules() → modIO.ReadBrackets, modIO.ReadParams or ReadTableToDicts; validate bracket ordering and required PTKP keys; populate module-level modConfig.<br/>5. rows = ReadInput() → modIO.ReadTableToDicts("Input","tblInput"); validate headers and required columns.<br/>6. results = ProcessAllRows(rows) → iterate and call modCalc.CalcRow per row with On Error guard; collect per-row outputs and diagnostics.<br/>7. success = WriteOutputs(results) → produce CSVs atomically using modIO.WriteCsvAtomic and compute per-file checksums.<br/>8. GenerateManifest(jobFolder, JOB_ID) → modManifest.WriteManifest(jobFolder, JOB_ID, fileList).<br/>9. ImportOutputsToSheets(jobFolder) → optional: modIO.ImportCsvToSheet for Outputs_BuktiPotong and Outputs_Per11 (preserve text columns).<br/>10. Finalize: write success summary to Logs sheet, persist JOB_ID and generated_at to Settings, remove lockfile, return final status.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>InitializeJob details</strong><br/>• Read Settings['JOB_ID'] if present and allowed.<br/>• If providedJobId non-empty: validate pattern and use; else generate job_YYYYMMDD_HHNNSS.<br/>• Persist JOB_ID back to Settings (update in-memory then write to sheet safely).<br/>• Create jobFolder = JoinPath(OUTPUT_BASE, JOB_ID) and EnsureFolder(jobFolder).<br/>• Create lockfile using atomic .tmp → SafeMoveFile pattern; fail if lock present and fresh.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>LoadRules responsibilities</strong><br/>• Read bracket table(s): validate ascending upper bounds, decimal rates, sentinel upper bound present.<br/>• Read params table: required keys (dtp_pct, npwp_penalty_pct, annualization_default).<br/>• Map BPJS flags: TreatEmployerBPJSAsGross, EmployeeBPJSDeductible.<br/>• Validate PTKP map keys (TK/0, TK/1, K/0, etc.).<br/>• On validation failure: log and AbortCleanup with clear message.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Input ingestion &amp; validation</strong><br/>• Use modIO.ReadTableToDicts("Input","tblInput").<br/>• Required headers: nip, npwp, name, period, period_type, gross or income_1..income_7 (as mapped).<br/>• BPJS columns: if INCLUDE_BPJS_FIELDS=true, ensure their presence or treat as zero per strict_bpjs flag.<br/>• Normalize npwp (string), set npwp_status via modCalc.NormalizeNPWPStatus.<br/>• If header mismatch: log detailed header diff and abort.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Processing loop (ProcessAllRows)</strong><br/>• Iterate deterministic order (0..n-1) to ensure reproducible outputs.<br/>• For each row: wrap call to modCalc.CalcRow in error handler; capture returned dictionary and ComputationNotes.<br/>• Append canonical output row to results container with required export fields and preserved extra input columns.<br/>• Maintain counters: processed, success, skipped, failed; track row indices for traceability.<br/>• Per-row failures: log with row index and continue unless total failures exceed threshold (configurable), then abort.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Chunking &amp; resume support</strong><br/>• Support optional chunked runs: ProcessAllRows(rows, resumeFrom) where resumeFrom is row index to resume.<br/>• Periodic checkpointing: optionally flush intermediate CSV to jobFolder after each chunk to allow resume/retry.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>WriteOutputs (CSV export)</strong><br/>• Build canonical header order for bukti_potong.csv and per11_payload.csv; include extra input columns at the end.<br/>• Use RFC4180 escaping: double internal quotes, wrap fields when needed, use vbCrLf newlines.<br/>• Use modIO.WriteCsvAtomic(jobFolder, fileName, csvGenerator) which writes tmp and SafeMoveFile to final path.<br/>• On success compute &amp; log file SHA256 (via modManifest or modUtils).<br/>• On failure implement retry/backoff controlled by RETRY_ATTEMPTS and RETRY_DELAY_MS; if still failing, AbortCleanup.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>GenerateManifest</strong><br/>• Build ordered fileList (alphabetical normalized path) for final files.<br/>• Call modManifest.WriteManifest(jobFolder, JOB_ID, fileList).<br/>• Verify manifest existence and optionally re-hash files to confirm listed checksums match.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>ImportOutputsToSheets</strong><br/>• Optionally import CSVs to Outputs_BuktiPotong and Outputs_Per11 using modIO.ImportCsvToSheet with preserveTextColumns=True.<br/>• Failures here do not mark job failed; log and include in final notes.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Concurrency &amp; locking policy</strong><br/>• Acquire simple file lock: create jobFolder\.lock atomically (.lock.tmp → .lock).<br/>• If lock exists and age &lt; LOCK_EXPIRY → abort to prevent concurrent runs.<br/>• Remove lockfile in finalize or AbortCleanup (best-effort).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Retry &amp; transient error handling</strong><br/>• For transient FS errors (sharing violations), perform configurable retries with exponential or fixed backoff.<br/>• For persistent errors (permission denied, non-existent OUTPUT_BASE), abort with clear remediation steps logged.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Error handling &amp; AbortCleanup</strong><br/>• Centralized AbortCleanup(errContext, fatal): log Err.Number/Description, context, job state; attempt cleanup (remove tmp files, remove lockfile if safe); persist failure status to Logs and Settings; if fatal then ensure function exits gracefully returning failure indicator.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Observability &amp; logging</strong><br/>• Use modUtils.LogMsg to write structured log rows to Logs sheet: timestamp, level, context, message, rowIndex (if applicable).<br/>• Emit start/end timestamps, settings snapshot (non-sensitive), rules load counts, input row count, counters (processed/succeeded/failed), file write events, manifest creation, job duration.<br/>• Verbose mode controlled by Settings['VERBOSE'] for detailed per-row traces.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Security &amp; data privacy</strong><br/>• Mask sensitive values in logs (full NPWP masked by default).<br/>• Validate and normalize all file paths to prevent traversal sequences (..).<br/>• Do not execute external commands; do not include credential material in logs.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Auditability &amp; artifacts</strong><br/>• Job folder contains: CSV outputs, manifest.json, logs.csv (or Logs sheet snapshot), settings_snapshot.json, sample_rows_debug.json (if verbose).<br/>• Persist modConfig snapshot and rules tables used for job (TER version, bracket CSV) for reproducibility.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Versioning &amp; compatibility</strong><br/>• Module constant: Const MODMAIN_VERSION = "2025-11-27-1".<br/>• Preserve public routine names to keep backward compatibility. <br/>• When adding output columns, append to CSV header and provide Settings switch EXPORT_LEGACY_SCHEMA to emit legacy layout.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Performance &amp; scaling guidance</strong><br/>• Process rows in-memory using Dictionaries/Arrays; minimize Worksheet reads/writes in hot path.<br/>• For very large inputs: run in chunks, reuse CreateObject instances where safe, and avoid per-row QueryTable operations.<br/>• Prefer streaming CSV generator for WriteCsvAtomic to avoid building huge strings in memory.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Testing &amp; verification (10× checklist)</strong><br/>1) Settings load: required keys present and validated.<br/>2) JOB_ID generation/persistence: format job_YYYYMMDD_HHNNSS and written back to Settings.<br/>3) Job folder creation: OUTPUT_BASE\JOB_ID exists after InitializeJob.<br/>4) Rules load: bracket counts and param keys validated; PTKP keys present.<br/>5) Input ingestion: ReadTableToDicts returns expected row count and header set; BPJS columns handled per settings.<br/>6) Per-row processing: ProcessAllRows yields consistent aggregated counts on repeated identical runs.<br/>7) Atomic CSV writes: .tmp created then final file present; no .tmp residue after success.<br/>8) Manifest generation: manifest.json present, valid JSON, and hashes match files.<br/>9) Recovery: leftover .tmp or .lock detection triggers safe abort/cleanup per policy.<br/>10) End-to-end: full run produces expected CSV rows for sample BPJS-enabled inputs and matches authoritative examples.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Integration responsibilities</strong><br/>• Uses modUtils for folder, path, and logging primitives.<br/>• Uses modIO for table reads, CSV atomic writes, and CSV imports.<br/>• Uses modCalc exclusively for per-row tax computation.<br/>• Uses modManifest for manifest creation and checksum verification.<br/>• Exposes minimal surface area; other modules should not perform orchestration duties.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Developer notes &amp; documentation</strong><br/>• Top-of-module header: version, author, change log, supported settings keys.<br/>• Each public function: header describing purpose, inputs, outputs, side-effects, error semantics, and sample usage.<br/>• Document recovery procedures for operators (clean lockfile, inspect tmp files, re-run with provided JOB_ID).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Final verification &amp; pre-commit checklist</strong><br/>• Run the 10× test checklist, full modTest scenarios, and at least one end-to-end job including BPJS-enabled rows.<br/>• Verify atomic write behavior on local and representative network paths.<br/>• Confirm manifest SHA-256 values against an external tool for at least one sample file.<br/>• Only then bump MODMAIN_VERSION and commit.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 27</div></div><div class="table-caption" id="Table2" data-table="Docu_0144_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **Technical Breakdown**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Name</strong><br/>modCalc.bas</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Purpose</strong><br/>Central, deterministic calculation engine for PPh21 processing. Performs per-row tax computations: aggregates gross components, applies BPJS rules per configuration, computes PTKP, calculates PKP (with PKP-specific floor-to-1,000), applies progressive tariffs or TER table logic, applies NPWP penalties, performs gross-up back-calculation when required, applies Indonesian rounding rules, and returns a structured result consumed by modMain/modIO. No I/O apart from non-fatal logging via modUtils.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Design Principles</strong><br/>• Deterministic: identical inputs + config → identical outputs.<br/>• Config-driven: all tax rules, brackets, PTKP, NPWP synonyms, and BPJS flags come from modConfig loaded by modMain.<br/>• Fail-safe: public functions return typed results or structured error flags; internal errors logged via modUtils.LogMsg and not raised to caller.<br/>• Small, testable units: each core calculation is a separate function with stable signatures.<br/>• Backward compatible: preserve public function names and signatures; support legacy input fields.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Dependencies</strong><br/>• Reads read-only configuration maps from modConfig: PTKPMap, BracketList (or TER table), NPWPStrings, Flags (EmployeeBPJSDeductible, TreatEmployerBPJSAsGross), rounding rules, npwp_penalty_pct, dtp_pct, annualization_default.<br/>• Uses modUtils.LogMsg for logging only; does not perform filesystem I/O.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Public API (recommended signatures)</strong><br/>Public Function CalcRow(row As Object) As Object  ' returns Scripting.Dictionary result<br/>Public Function NormalizeNPWPStatus(status As Variant) As Boolean<br/>Public Function SafeGet(dict As Object, key As String, defaultValue As Variant) As Variant<br/>Public Function ComputePTKP(row As Object) As Double<br/>Public Function AggregateEmployerBPJS(row As Object) As Double<br/>Public Function AggregateEmployeeBPJS(row As Object) As Double<br/>Public Function ComputeGrossTotal(row As Object) As Double<br/>Public Function ComputeDeductionsTotal(row As Object) As Double<br/>Public Function ComputePKP(grossTotal As Double, deductionsTotal As Double, ptkp As Double) As Double<br/>Public Function FloorToThousand(value As Double) As Double<br/>Public Function ComputePPh21(pkp As Double) As Double<br/>Public Function ApplyNPWPPenalty(tax As Double, hasNPWP As Boolean) As Double<br/>Public Function IndoRound(amount As Double, Optional roundTo As Long = 1) As Double<br/>Public Function SolveGrossUp(targetNet As Double, rowTemplate As Object, Optional maxIter As Long = 50, Optional tol As Double = 0.5) As Object ' returns {ok:Bool, gross:Double, details:Dict}</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Input contract</strong><br/>• <code>row</code> is a late-bound Dictionary mapping canonical input keys to Variant values. Mandatory logical keys should be present or defaulted via SafeGet.<br/>• Expected canonical input keys (examples): nip, npwp, name, period, period_type, gross (or income_1..income_7), npwp_status, BPJS_KESEHATAN_EMPLOYER, BPJS_JKK_EMPLOYER, BPJS_JKM_EMPLOYER, BPJS_JHT_EMPLOYER, OTHER_PREMI_EMPLOYER, BPJS_KESEHATAN_EMPLOYEE, BPJS_JHT_EMPLOYEE, OTHER_IURAN_EMPLOYEE, IURAN_PENSIUN_ATAU_IURAN_THT_JHT, period_days, days_worked, gross_up_flag.<br/>• Legacy column support: PREMI_ASURANSI_DARI_PEMBERI_KERJA, IURAN_PENSIUN_ATAU_IURAN_THT_JHT accepted and mapped to canonical fields for backward compatibility.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>High-level CalcRow flow</strong><br/>1. Read and normalize inputs via SafeGet; coerce numeric fields safely.<br/>2. Determine hasNPWP = NormalizeNPWPStatus(SafeGet(row,"npwp_status","")).<br/>3. Compute ptkp = ComputePTKP(row) using PTKPMap and marital/dependent fields.<br/>4. Compute grossTotal = ComputeGrossTotal(row) — includes employer BPJS if TreatEmployerBPJSAsGross = True.<br/>5. Compute deductionsTotal = ComputeDeductionsTotal(row) — includes employee BPJS if EmployeeBPJSDeductible = True and other allowed deductions.<br/>6. If gross-up mode indicated (row.gross_up_flag or period_type), call SolveGrossUp to back-calculate gross consistent with target net; else continue.<br/>7. pkp = ComputePKP(grossTotal, deductionsTotal, ptkp) — PKP floored to nearest 1,000 (FloorToThousand) and non-negative.<br/>8. taxBeforePenalty = ComputePPh21(pkp) — progressive or TER-based calculation per modConfig.<br/>9. taxAfterPenalty = ApplyNPWPPenalty(taxBeforePenalty, hasNPWP).<br/>10. taxRounded = IndoRound(taxAfterPenalty, roundTo) and compute roundingAdjustment = taxRounded - taxAfterPenalty.<br/>11. Build and return result Dictionary with canonical numeric keys and debug notes.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Gross aggregation (ComputeGrossTotal)</strong><br/>• Sum explicit gross components: GAJI_PENSIUN_THT_JHT, TUNJANGAN_PPH, TUNJANGAN_LAINNYA, LEMBUR, HONORARIUM, PREMI_ASURANSI_DARI_PEMBERI_KERJA, and other mapped income fields.<br/>• Aggregate employer BPJS sub-components (BPJS_KESEHATAN_EMPLOYER, BPJS_JKK_EMPLOYER, BPJS_JKM_EMPLOYER, BPJS_JHT_EMPLOYER, OTHER_PREMI_EMPLOYER) and include in grossTotal only if TreatEmployerBPJSAsGross = True.<br/>• For period/daily prorate cases, convert payment-period amounts to monthly equivalent per config (use period_days and days_worked).<br/>• Preserve currency conversions: if FX fields supplied, convert using provided rate in row or config before aggregation.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Deductions aggregation (ComputeDeductionsTotal)</strong><br/>• Sum standard deductions: IURAN_PENSIUN_ATAU_IURAN_THT_JHT and any configured fixed deductions (e.g., biaya jabatan rules).<br/>• Aggregate employee BPJS fields: BPJS_KESEHATAN_EMPLOYEE, BPJS_JHT_EMPLOYEE, OTHER_IURAN_EMPLOYEE. Deduct employee BPJS only when EmployeeBPJSDeductible = True.<br/>• Apply dtp (DTP) logic where applicable: compute tax_after_dtp if DTP% configured and used.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>PKP computation (ComputePKP &amp; FloorToThousand)</strong><br/>• Intermediate taxable base = grossTotal - deductionsTotal.<br/>• PKP_raw = intermediate_taxable_base - ptkp.<br/>• PKP = Max(FloorToThousand(PKP_raw), 0).<br/>• FloorToThousand(x): rounds down to nearest 1,000 (e.g., 1,234,567 → 1,234,000) using integer arithmetic to avoid FP drift. Document difference between PKP floor and final tax rounding.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Progressive tax / TER computation (ComputePPh21)</strong><br/>• Supports two modes: progressive bracket iteration or TER (effective-rate table) lookups; selection controlled by modConfig.calc_mode.<br/>• Progressive mode: iterate sorted bracket list [upper, rate]; compute portion = Min(remainingPKP, upper - prevUpper); tax += portion * rate; continue until remaining 0.<br/>• TER mode: look up TER category and apply effective percent to annualized base or one-off base per rules; support Monthly/Daily/One-off categories.<br/>• Rates parsed from config as decimals or percentages (e.g., "5%" → 0.05).<br/>• Return taxBeforePenalty as Double (unrounded).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>NPWP penalty (ApplyNPWPPenalty)</strong><br/>• If hasNPWP = False → tax * (1 + npwp_penalty_pct) where npwp_penalty_pct default = 0.20 from config.<br/>• If hasNPWP = True → return tax unchanged.<br/>• Preserve precision until IndoRound applied.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Rounding (IndoRound)</strong><br/>• PKP rounding: use FloorToThousand as above.<br/>• Final tax rounding: IndoRound(amount, roundTo) where roundTo default = 1 (Rp). Implementation uses integer arithmetic: scaled = Round(amount / roundTo) using tie rules as specified (1–4 down, 5–9 up) or configurable midpoint rule; ensure deterministic behavior for halves.<br/>• Provide optional roundTo (100, 1000) for testing and alternative rules.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>NPWP normalization (NormalizeNPWPStatus)</strong><br/>• Accepts multiple textual/numeric variants and maps to Boolean: true for synonyms ['+', 'yes', 'y', '1', 'has', 'ada', 'punya', 'valid'] (case-insensitive); false for ['no','tidak','t','0','missing','invalid',''].<br/>• Additional synonyms read from modConfig.NPWPStrings for locale variations.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Gross-Up solver (SolveGrossUp)</strong><br/>• Iteratively solve for gross when employer pays tax or gross is 'gross-up' type: treat employer-paid tax and employer BPJS as taxable benefit if TreatEmployerBPJSAsGross = True.<br/>• Use Newton-style or bisection solver bounded by sensible min/max (e.g., net &lt; gross &lt; gross*3) with maxIter (default 50) and tolerance (e.g., 0.5 Rp).<br/>• Return structured result {ok:Boolean, gross:Double, iterations:Long, finalTax:Double, details:Dictionary} and log if not converged.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>SafeGet helper</strong><br/>• Retrieves dict(key) safely: returns defaultValue if missing or Null/Empty.<br/>• Performs safe numeric coercion with On Error trapping and logs conversion anomalies.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Error handling model</strong><br/>• Functions validate inputs and return structured results. Fatal configuration errors return a dictionary with Error=True and message. <br/>• Non-fatal problems: set ComputationNotes in result, log via modUtils.LogMsg, and continue. <br/>• No unhandled exceptions escape public functions.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Return contract (CalcRow result)</strong><br/>Result is a late-bound Dictionary containing canonical keys and types: PTKP (Double), GrossTotal (Double), DeductionsTotal (Double), PKP (Double), Annual_Gross (Double), TaxBeforePenalty (Double), TaxAfterPenalty (Double), TaxRounded (Double), RoundingAdjustment (Double), Monthly_Withholding (Double), HasNPWP (Boolean), ComputationNotes (String), RuleVersion (String), TER_Category (String optional), DebugTrace (optional array). Numeric values are Doubles; booleans are True/False; ComputationNotes contains human-readable notes on defaults or fallbacks.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Testing &amp; verification (10× checklist)</strong><br/>1) NPWP normalization: multiple synonyms map correctly.<br/>2) PTKP: mapping of TK/0, TK/1, K/0 etc. returns correct numeric PTKP and monthly share.<br/>3) PKP rounding: floor-to-1,000 works on edge examples (e.g., 1,000; 1,001; 1,999).<br/>4) Progressive brackets: multiple PKP values match hand-calculated references across tiers including open-ended top bracket.<br/>5) TER mode: effective-rate lookups and one-off annualization produce expected withholding.<br/>6) NPWP penalty: 20% applied when hasNPWP=False and preserved when True.<br/>7) BPJS flags: TreatEmployerBPJSAsGross and EmployeeBPJSDeductible toggles change taxable base as expected.<br/>8) Gross-up solver: converges within maxIter for typical gross-up cases and matches manual example within tolerance.<br/>9) IndoRound: final rounding tested across last-digit cases and roundTo variations.<br/>10) SafeGet and type coercion: missing or string numeric inputs are handled and logged without crashing.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Performance characteristics</strong><br/>• Per-row complexity is O(numBrackets) for progressive mode; TER lookup is O(1).<br/>• Suitable for batch processing thousands of rows; prefer calling ComputePPh21 once per row and avoid repeated config parsing.<br/>• Cache parsed bracket arrays and PTKP lookups at module-level for job lifetime.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Observability &amp; logging</strong><br/>• When modConfig.VerboseCalc = True, emit concise trace lines: inputs, grossTotal, deductions, pkp, bracket steps, taxBeforePenalty, taxAfterPenalty, roundingAdjustment. <br/>• Always record ruleVersion and config snapshot reference in result for audit. <br/>• Use modUtils.LogMsg only for warnings/errors or when verbose mode enabled.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Security &amp; correctness notes</strong><br/>• Avoid floating-point drift: use integer math where required (PKP floor and rounding).<br/>• Validate config values (e.g., bracket uppers ascending, rates in [0,1]) during LoadRules; CalcRow relies on validated modConfig.<br/>• Do not log full NPWP by default—mask in any debug logs unless explicitly allowed.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Backward compatibility &amp; migration</strong><br/>• Preserve CalcRow signature. <br/>• Support legacy columns (PREMI_ASURANSI_DARI_PEMBERI_KERJA etc.) and map to canonical fields.<br/>• When adding new computed fields, append to result dictionary rather than rename existing keys.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Developer notes &amp; documentation</strong><br/>• Top-of-module header: MODCALC_VERSION constant, author, changelog, and reference to regulatory citations (Peraturan Pemerintah / PMK numbers).<br/>• Each public function must include header comment: purpose, inputs, outputs, side-effects, sample usage, and unit test examples.<br/>• Document numeric examples for PKP rounding and gross-up in module docstring.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Final verification &amp; pre-commit checklist</strong><br/>• Execute the 10× unit checklist above. <br/>• Run full end-to-end samples (including BPJS-enabled rows) and compare outputs to authoritative calculator examples. <br/>• Verify numeric parity for at least 10 representative cases across monthly/one-off/severance/foreign-currency/gross-up scenarios. <br/>• Only after tests pass: bump MODCALC_VERSION and commit.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 25</div></div><div class="table-caption" id="Table3" data-table="Docu_0144_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **Technical Breakdown**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Name</strong><br/>modIO.bas</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Purpose</strong><br/>Robust table and CSV I/O layer for the pipeline. Responsibilities: read Excel ListObjects into typed in-memory structures, parse bracket/params tables, reliably produce UTF-8 CSV exports with atomic write semantics, import CSVs into sheets with predictable typing, and expose streaming primitives to avoid large-memory allocations. Designed for deterministic, testable behavior and clear error/observability signals consumed by modMain, modCalc, modManifest, and modUtils.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Design Principles</strong><br/>• Deterministic: same workbook state → same in-memory outputs.<br/>• Fail-safe: public functions return well-defined objects/Booleans and never let unhandled errors propagate.<br/>• Atomic output: writes use .tmp → rename pattern to avoid partial final files.<br/>• Memory-safe streaming: support streaming writers/readers to handle large datasets.<br/>• Use modUtils for filesystem primitives (JoinPath, SafeMoveFile, DeleteFileIfExists, LogMsg).<br/>• Backward-compatible public signatures; optional args are non-breaking.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Primary responsibilities</strong><br/>• Read Excel ListObjects into Dictionary-of-Dictionaries (stable COM marshalling keys "0".."n-1").<br/>• Read bracket and params tables with strict validation and typed parsing.<br/>• Produce UTF-8 CSVs atomically with configurable BOM behavior.<br/>• Import CSVs into sheets preserving text columns (npwp, nip), with QueryTable primary path and streaming fallback.<br/>• Provide streaming CSV generator/consumer interfaces to modMain for large exports.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Public API (recommended signatures)</strong><br/>Public Function ReadTableToDicts(ByVal sheetName As String, ByVal tableName As String) As Object ' Returns Scripting.Dictionary "0".."n-1" each value = Scripting.Dictionary(header-&gt;Variant)<br/>Public Function ReadBrackets(ByVal sheetName As String, ByVal tableName As String, uppers() As Double, rates() As Double) As Boolean<br/>Public Function ReadParams(ByVal sheetName As String, ByVal tableName As String) As Object ' Returns Scripting.Dictionary key-&gt;Variant<br/>Public Function WriteCsvAtomic(ByVal folderPath As String, ByVal fileName As String, csvGenerator As IStreamProvider, Optional ByVal writeBOM As Boolean = False) As Boolean<br/>Public Function ImportCsvToSheet(ByVal csvPath As String, ByVal sheetName As String, Optional ByVal preserveTextColumns As Boolean = True) As Boolean<br/>Public Function ReadCsvToRows(ByVal csvPath As String, Optional preserveText As Boolean = False) As Object ' streaming fallback parser</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>ReadTableToDicts — contract &amp; behavior</strong><br/>• Expects a valid ListObject (Excel table) identified by sheetName and tableName.<br/>• Read header row exactly; Trim header names; header blanks =&gt; log and return Nothing.<br/>• For each non-empty data row produce a late-bound Scripting.Dictionary mapping header→Variant (preserve types: numeric/date/string/boolean).<br/>• Outer container is a Scripting.Dictionary keyed "0".."n-1" (string keys for stable COM marshalling).<br/>• Skip rows fully empty. Treat merged cells as displayed value when unambiguous; otherwise return Empty for that cell and log a warning.<br/>• Complexity O(rows×cols). For large tables, support optional row-callback or batching to stream rows.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>ReadTableToDicts — validation &amp; errors</strong><br/>• Header blanks → LogMsg + return Nothing.<br/>• Table not found → LogMsg + return Nothing.<br/>• Unexpected cell type → return as-is and LogMsg warning.<br/>• All errors handled; public returns Nothing on fatal failure and logs details (sheet/table/row).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>ReadBrackets — contract &amp; behavior</strong><br/>• Read two-column bracket table (headers: upper, rate) or named columns—trim and normalize header names.<br/>• Parse numeric strings allowing thousands separators and percent signs; strip and convert (e.g., "5%" → 0.05).<br/>• Ensure uppers are ascending and last row has sentinel upper (large value).<br/>• Populate passed dynamic arrays uppers() and rates(); ensure equal lengths.<br/>• On parse/order error → LogMsg and return False.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>ReadParams — contract &amp; behavior</strong><br/>• Read two-column key/value table; normalize keys (recommended: UCase$(Trim(key))).<br/>• Attempt to cast values to numeric/boolean where appropriate; otherwise preserve as string Variant.<br/>• Return late-bound Scripting.Dictionary (normalizedKey → Variant). Skip blank keys. On fatal error -&gt; return Nothing.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>WriteCsvAtomic — semantics &amp; pattern</strong><br/>• Purpose: write UTF-8 CSV reliably and atomically.<br/>• Caller supplies content via csvGenerator implementing IStreamProvider (streaming interface: NextChunk() As String / EOF flag) to avoid building full file string in memory.<br/>• Steps: 1) create temporary file <code>&lt;file&gt;.tmp</code> in jobFolder (prefer same volume as final); 2) open ADODB.Stream in binary mode or ADODB.Stream text with Charset="utf-8"; 3) write stream chunk-by-chunk encoded to UTF-8; 4) flush &amp; close stream; 5) call modUtils.DeleteFileIfExists(finalPath); 6) call modUtils.SafeMoveFile(tmpPath, finalPath).<br/>• Optionally write BOM when writeBOM=True (document Excel implications).<br/>• If target volume differs and SafeMoveFile cannot perform atomic rename, prefer writing tmp directly to target volume or use Copy+Delete with integrity verification.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>WriteCsvAtomic — robustness &amp; retries</strong><br/>• Wrap low-level IO in On Error handlers; log Err.Number/Description on failure.<br/>• Implement configurable retry/backoff for transient sharing violations (RETRY_ATTEMPTS / RETRY_DELAY_MS from Settings).<br/>• Ensure tmp cleaned up on failure (best-effort).<br/>• Return True only when final file exists and size &gt; 0 and move succeeded.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>CSV generation details</strong><br/>• Use RFC4180 escaping: wrap fields containing commas/newlines/quotes in double quotes and double internal quotes.<br/>• Use vbCrLf as newline for Windows compatibility.<br/>• Ensure consistent field ordering and header row; caller provides header order via generator.<br/>• Avoid embedding formulas; prefix suspicious leading characters with a single-quote if export consumers require it (configurable safe_csv_prefix setting).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>IStreamProvider recommendation</strong><br/>• Interface shape: Object exposing Init(), NextChunk() As String, EOF() As Boolean, Close().<br/>• Implement CsvStreamFromRows(dataRows, headers) to stream CSV rows row-by-row encoded to UTF-8.<br/>• Keep chunk size moderate (e.g., 64KB) for performance vs memory trade-offs.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>ImportCsvToSheet — behavior &amp; options</strong><br/>• Default: QueryTables.Add with TextFilePlatform = 65001 (UTF-8), TextFileCommaDelimiter = True.<br/>• To preserve text fields (npwp, nip), build TextFileColumnDataTypes array with xlTextFormat (2) for specified columns and assign to QueryTable before refresh.<br/>• If QueryTable unreliable on current Excel build, fallback to streaming parse: open file line-by-line, parse CSV respecting quotes, and write to sheet using block Range.Value assignments for speed.<br/>• Clean up QueryTables after import to avoid external connections.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>ImportCsvToSheet — pitfalls &amp; mitigations</strong><br/>• BOM may confuse QueryTable; detect and strip BOM prior to QueryTable or set TextFilePlatform appropriately.<br/>• QueryTable auto-typing may reformat dates/IDs; set column types explicitly when preserveTextColumns=True.<br/>• Large imports: use block Range assignment (array-&gt;Range) to avoid cell-by-cell writes.<br/>• Ensure thread/UI responsiveness: disable ScreenUpdating and set Application.Calculation = xlCalculationManual during import, restore afterwards.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>ReadCsvToRows — streaming fallback parser</strong><br/>• Line-by-line CSV parser handling quoted fields &amp; escaped quotes per RFC4180.<br/>• Returns Scripting.Dictionary indexed "0".."n-1" or supports callback to process each parsed row to avoid memory spikes.<br/>• Detect and strip BOM; accept configurable delimiter.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Observability &amp; logging</strong><br/>• Log start/end of major operations with counts and byte sizes (ReadTableToDicts rowCount, WriteCsvAtomic bytesWritten).<br/>• On success, emit SHA256 of tmp file to log (modManifest will include final checksum).<br/>• Detailed errors include function name, sheet/table/file path, and Err.Number/Description. Use modUtils.LogMsg for all logs.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Security &amp; path validation</strong><br/>• Normalize and validate folderPath and fileName inputs; block traversal sequences (..) unless explicitly allowed.<br/>• Reject absolute paths when relative expected (unless Settings allow absolute override).<br/>• Ensure CSV content is safe for downstream consumers (optionally prefix dangerous leading characters).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Error-handling model</strong><br/>• Validate inputs early and return Nothing/False on fatal errors after logging.<br/>• Use On Error handlers only around required COM/IO calls; capture Err.Number/Description and include context.<br/>• Functions return deterministic typed values: Dictionaries on success, Nothing on fatal, False for Boolean failures.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Performance guidance</strong><br/>• For moderate sizes (&lt;50k rows), QueryTable + ADODB or block Range assignment is adequate.<br/>• For large exports/imports (100k+ rows), use streaming CSV writer + ADODB.Stream and block Range.Value for imports.<br/>• Reuse CreateObject instances where safe (e.g., shared ADODB.Stream factory) and avoid per-row COM calls.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Inter-module contracts</strong><br/>• modMain expects ReadTableToDicts to return Dictionary "0".."n-1" for deterministic iteration.<br/>• modCalc expects ReadBrackets to populate uppers() and rates() arrays in correct order.<br/>• modManifest expects WriteCsvAtomic to have produced final files when returning True. <br/>• modUtils used for SafeMoveFile, DeleteFileIfExists, JoinPath, LogMsg.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Testing &amp; verification (10× checklist)</strong><br/>1) ReadTableToDicts: 3-row ListObject → Dictionary.Count = 3; header keys trimmed and exact.<br/>2) ReadTableToDicts: header blank → returns Nothing and log contains header error.<br/>3) ReadBrackets: parse "1,000", "5%" correctly; ensure uppers ascending and rates normalized to decimal.<br/>4) ReadParams: boolean/numeric/string values parsed and returned in Dictionary.<br/>5) WriteCsvAtomic: .tmp created; final file present; tmp removed; checksum logged.<br/>6) WriteCsvAtomic: simulate locked target → retry/backoff and tmp cleanup on failure.<br/>7) Cross-volume move: write tmp to target volume or fallback copy+delete and verify integrity.<br/>8) ImportCsvToSheet: preserve leading zeros when preserveTextColumns=True.<br/>9) ImportCsvToSheet: BOM handling validated; QueryTable fallback behavior exercised.<br/>10) ReadCsvToRows: streaming parser handles quoted fields, embedded CRLF, and large files without excessive memory.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Recommended immediate improvements</strong><br/>• Implement IStreamProvider and CsvStreamFromRows to standardize streaming exports.<br/>• Add unit tests for streaming writer and cross-volume move behavior.<br/>• Expose diagnostic mode to emit per-operation timing metrics to Logs.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Versioning &amp; compatibility</strong><br/>• Add Const MODIO_VERSION = "2025-11-27-1" at module top.<br/>• Preserve public function signatures; add optional parameters only with defaults.<br/>• Document breaking changes in changelog.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Developer notes &amp; documentation</strong><br/>• Module header: version, author, important settings keys, and sample usage patterns for ReadTableToDicts and WriteCsvAtomic.<br/>• Each public function: header block with purpose, inputs, outputs, side-effects, and sample call.<br/>• Provide sample CsvStreamFromRows implementation in module examples.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Final verification &amp; pre-commit checklist</strong><br/>• Run the 10× verification tests above and modTest suite.<br/>• Execute end-to-end export (sample rows) including BPJS columns and confirm CSV -&gt; import round-trip preserves key fields (npwp, nip) exactly.<br/>• Verify atomic rename behavior on local disk and a mapped network share.<br/>• Only then bump MODIO_VERSION and commit.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 26</div></div><div class="table-caption" id="Table4" data-table="Docu_0144_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **Technical Breakdown**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Name</strong><br/>modUtils.bas</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Purpose</strong><br/>Lightweight, dependency-minimal utility library providing deterministic helpers and atomic filesystem primitives for higher-level modules (modMain, modIO, modManifest, modTest). Responsibilities: timestamp generation, path joining, folder creation, existence checks, idempotent file delete, safe atomic move, structured logging to Logs sheet, and settings/key-value loader. Uses late-binding (CreateObject) for Scripting.FileSystemObject and Scripting.Dictionary; avoids compile-time references.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Design Principles</strong><br/>• Pure-VBA and late-bound: no required VBA References; CreateObject("Scripting.FileSystemObject") and CreateObject("Scripting.Dictionary") used. <br/>• Deterministic: same inputs → same outputs except for explicit I/O. <br/>• Fail-safe: public functions return well-defined Boolean or typed results and never allow unhandled runtime errors to bubble. <br/>• Minimal side-effects: functions avoid workbook/sheet activation; logging is explicit. <br/>• Small, testable units: single-responsibility helpers with stable signatures.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Compatibility &amp; Constraints</strong><br/>• Target: Windows Excel (VBA) with COM support for ADODB/FSO/Dictionaries. <br/>• No Win32 API, .NET, or external executables used. <br/>• Graceful behavior if COM is disabled—functions return failure indicators and log.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Public API (recommended signatures)</strong><br/>Public Function TS() As String<br/>Public Function JoinPath(ByVal a As String, ByVal b As String) As String<br/>Public Function EnsureFolder(ByVal folderPath As String) As Boolean<br/>Public Function FileExists(ByVal path As String) As Boolean<br/>Public Function DeleteFileIfExists(ByVal path As String) As Boolean<br/>Public Function SafeMoveFile(ByVal src As String, ByVal dst As String) As Boolean<br/>Public Function LogMsg(ByVal logsSheetName As String, ByVal msg As String, Optional ByVal level As String = "INFO") As Boolean<br/>Public Function ReadSettings(ByVal settingsSheetName As String) As Object ' returns late-bound Scripting.Dictionary</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>TS() — Timestamp Generator</strong><br/>• Returns timestamp in exact format: <code>yyyy-mm-dd HH:nn:ss</code> (24-hour). <br/>• Implementation: build from Year(), Month(), Day(), Hour(), Minute(), Second() with zero-padding functions to avoid locale dependence and ensure lexicographic sortability. <br/>• Deterministic for a given system clock; safe for sorting and logs.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>JoinPath(a, b) — Deterministic Path Join</strong><br/>• Trim inputs. <br/>• If <code>a</code> empty → return <code>b</code>. If <code>b</code> empty → return <code>a</code>. <br/>• If <code>a</code> ends with <code>\</code> or <code>/</code> → return <code>a &amp; b</code>. <br/>• Else insert <code>\</code> between them. <br/>• Preserve existing separator style when possible. <br/>• Normalizes duplicate separators and removes surrounding whitespace.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>EnsureFolder(folderPath) — Guaranteed Folder Creator</strong><br/>• Trim input; return False if empty. <br/>• Late-bind FSO: <code>Set fso = CreateObject("Scripting.FileSystemObject")</code>. <br/>• If folder exists → return True. If not → attempt <code>fso.CreateFolder(folderPath)</code> once. <br/>• Wrap operations in <code>On Error</code> handlers; on error log and return False. <br/>• Returns True if folder exists after call.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>FileExists(path) — Safe Existence Check</strong><br/>• Trim input; empty → False. <br/>• Use FSO's <code>FileExists</code> via late binding. <br/>• Surround with <code>On Error Resume Next</code>; on error return False and log. <br/>• Deterministic boolean return.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>DeleteFileIfExists(path) — Idempotent Cleaner</strong><br/>• If <code>FileExists(path)</code> is True → attempt <code>fso.DeleteFile path, True</code>. <br/>• Wrap deletion in <code>On Error Resume Next</code>; capture Err.Number/Description. <br/>• Return True if file does not exist after the call; otherwise False. <br/>• Do not raise; log failures with context.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>SafeMoveFile(src, dst) — Atomic Move Helper</strong><br/>• Validate non-empty src/dst; return False with log if invalid. <br/>• Ensure <code>FileExists(src)</code> True before proceed. <br/>• If <code>FileExists(dst)</code> → call DeleteFileIfExists(dst) first. <br/>• Try <code>Name src As dst</code> for same-volume atomic rename (fast, atomic). <br/>• Detect error for cross-volume rename (Err.Number = 52/75 etc.); fallback: copy file binary then delete source (<code>fso.CopyFile</code> + <code>fso.DeleteFile</code>) and validate size/hash before final delete. <br/>• Wrap all ops in <code>On Error</code> handlers; on any failure log Err.Number/Description and return False. <br/>• Return True on verified success.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>LogMsg(logsSheetName, msg, level)</strong><br/>• Append a structured log row to worksheet <code>logsSheetName</code> columns: Timestamp (TS()), Level, Context/Message. <br/>• Create sheet if missing; add headers if first write. <br/>• Minimize screen flicker: <code>Application.ScreenUpdating = False</code> during write and restore afterwards. <br/>• Use Range.Insert/End(xlUp).Offset pattern to append without activating sheets. <br/>• Fail-passive: return False on error and ensure no unhandled error. <br/>• For performance, support batched logging by accepting a pre-built collection (advanced usage).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>ReadSettings(settingsSheetName) — Key/Value Loader</strong><br/>• Read up to first 100 rows (configurable constant) from <code>settingsSheetName</code>. Column A = key, Column B = value. <br/>• Trim keys; normalize keys (recommended <code>UCase$(Trim(key))</code>). <br/>• Return a late-bound <code>Scripting.Dictionary</code> mapping normalizedKey→value (Variant). <br/>• If sheet missing → return empty dictionary (not Nothing) and LogMsg warning. <br/>• On catastrophic error → return Nothing and LogMsg.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Late-binding specifics &amp; COM safety</strong><br/>• Use <code>CreateObject("Scripting.FileSystemObject")</code> and <code>CreateObject("Scripting.Dictionary")</code>. <br/>• Document requirement: Windows Scripting Host components must be available. <br/>• Graceful fallback: if CreateObject fails, LogMsg and functions return safe failure indicator. <br/>• Always <code>Set obj = Nothing</code> after use to release COM objects.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Error-handling model</strong><br/>• Validate inputs early; use <code>On Error GoTo</code> or <code>On Error Resume Next</code> only around COM/IO calls. <br/>• Capture <code>Err.Number</code> and <code>Err.Description</code>, include function/context in logs. <br/>• Public functions return Boolean/typed result to indicate success/failure; no unhandled public errors.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Atomic CSV write pattern (usage example)</strong><br/>1. Write to <code>outFile.tmp</code>. <br/>2. Call <code>DeleteFileIfExists(outFile)</code> (remove final if exists). <br/>3. Call <code>SafeMoveFile(outFile.tmp, outFile)</code>. <br/>• This pattern ensures no partial file is visible at the final path.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Integration points &amp; responsibilities</strong><br/>• modMain: uses ReadSettings, JoinPath, EnsureFolder, LogMsg, SafeMoveFile. <br/>• modIO: uses DeleteFileIfExists, SafeMoveFile, FileExists. <br/>• modManifest: uses FileExists, TS, SafeMoveFile. <br/>• modTest: uses EnsureFolder, LogMsg, ReadSettings.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Return types &amp; expectations</strong><br/>• Booleans for success/failure helpers. <br/>• TS() returns String. <br/>• ReadSettings() returns late-bound Scripting.Dictionary or Nothing on catastrophic failure. <br/>• False always indicates failure; callers must log/decide remediation.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Performance notes</strong><br/>• Create FSO on demand and release immediately to avoid stale COM objects. <br/>• For loops requiring many filesystem ops, allow optional parameter to pass shared FSO to avoid repeated CreateObject calls. <br/>• All helpers are O(1) aside from filesystem latency.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Security &amp; permissions</strong><br/>• No network I/O performed by default; functions require filesystem permissions. <br/>• Do not attempt elevation; if permission denied then return False and log instructive remediation. <br/>• Validate folderPath/filePath to guard against traversal (../) when used by upstream modules.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Testability &amp; recommended test cases</strong><br/>• TS: format and zero-padding checks. <br/>• JoinPath: empty parts, trailing slash combos, mixed separators. <br/>• EnsureFolder: existing folder, creation success, invalid/empty path. <br/>• FileExists: existing file, missing file, empty input. <br/>• DeleteFileIfExists: delete existing, idempotency when missing, locked file handling. <br/>• SafeMoveFile: same-volume rename, cross-volume copy+delete fallback, destination overwrite behavior. <br/>• LogMsg: missing sheet creation, header insertion, append row correctness, large volume writes. <br/>• ReadSettings: trimmed keys, uppercase normalization, missing sheet behavior, value parsing.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Documentation &amp; comments</strong><br/>• Each public function must include header comment with: purpose, inputs, outputs, side-effects, examples, and error semantics. <br/>• Add module-level <code>Const MODUTILS_VERSION = "2025-11-27-1"</code>. <br/>• Maintain changelog at top of module.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Version control &amp; deployment notes</strong><br/>• Keep signatures stable; new helpers appended below existing public functions. <br/>• Add unit tests in modTest before committing changes. <br/>• Bump MODUTILS_VERSION when behavior or signatures change.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Observability / logging policy</strong><br/>• All failures must call LogMsg with context. <br/>• Support <code>modUtils_Debug</code> flag (Settings key) for verbose internal logs. <br/>• Production defaults to minimal logging; debug mode emits additional trace lines.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Robustness checklist (10× verification)</strong><br/>1. TS format exactly <code>yyyy-mm-dd HH:nn:ss</code>.<br/>2. JoinPath: empty <code>a</code>, trailing separator, <code>b</code> leading separator cases verified.<br/>3. EnsureFolder: existing/new/empty path scenarios tested.<br/>4. FileExists: empty input → False; existing path → True.<br/>5. DeleteFileIfExists: idempotent and returns expected state after call.<br/>6. SafeMoveFile: atomic rename on same-volume; safe fallback copy+delete on cross-volume; destination overwrite handled.<br/>7. LogMsg: appends correctly, creates sheet if missing, adds headers once.<br/>8. ReadSettings: returns Dictionary with trimmed keys; missing sheet → empty Dictionary; catastrophic error → Nothing.<br/>9. All CreateObject calls wrapped with error handling and release (Set ... = Nothing).<br/>10. No COM objects left unreleased after calls in happy and error paths.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Common pitfalls &amp; mitigation</strong><br/>• Avoid <code>Name</code> across mapped drives—detect and fallback to copy+delete. <br/>• Avoid <code>Kill</code> on slow network paths; prefer FSO delete with retries. <br/>• Avoid sheet activation when logging; use direct Range writes. <br/>• Always trim and validate paths and keys.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Notes on domain changes (e.g., BPJS fields)</strong><br/>• Keep module domain-agnostic. <br/>• Ensure atomic write &amp; logging guarantees support downstream exporters that include BPJS columns. <br/>• Add tests that include BPJS-enabled CSVs in modTest.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Final verification statement</strong><br/>Implementers must run the 10× robustness checklist, execute modTest scenarios that cover failure and success paths, and verify atomic write behavior and COM object cleanup before committing changes.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 28</div></div><div class="table-caption" id="Table5" data-table="Docu_0144_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **Technical Breakdown**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Name:</strong> modManifest.bas</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Purpose:</strong> Manages file hashing, binary-safe reads, SHA-256 computation in pure VBA, deterministic hex conversion, JSON manifest construction, and atomic manifest writes. It provides integrity metadata for job outputs, which are consumed by modMain and validated by downstream tooling.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Scope:</strong> Handles file hashing, SHA-256 calculation, and manifest generation. The manifest JSON file includes path, size, modified timestamp, and SHA-256 entries. It ensures atomic write operations for manifest generation.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Core Design Principles:</strong> <br/>• Deterministic outputs for identical inputs. <br/>• Fail-safe: public functions return typed empty values on error rather than raising unhandled exceptions. <br/>• Pure VBA implementation (no external executables), using ADODB.Stream for binary I/O and manual SHA-256 computation with 32-bit unsigned arithmetic emulation. <br/>• Minimal side effects: no network I/O; only local filesystem read/write.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Public API (recommended signatures):</strong> <br/>Public Function ReadBinaryFile(ByVal filePath As String) As Byte() <br/>Public Function SHA256_Bytes(data() As Byte) As Byte() <br/>Public Function BytesToHex(data() As Byte) As String <br/>Public Function SHA256_FileHex(ByVal filePath As String) As String <br/>Public Function WriteManifest(ByVal jobFolder As String, ByVal jobId As String, ByVal fileList As Collection) As Boolean</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Function Details:</strong></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>ReadBinaryFile</strong>: <br/>• Creates ADODB.Stream in binary mode (Type = 1). <br/>• Loads file from disk into Byte() array. <br/>• Always returns a Byte() array; for empty/unreadable files, returns a zero-length array (ReDim buf(-1)). <br/>• Ensures proper closing of ADODB.Stream object. <br/>• On failure, ensures stream is closed and returns an empty Byte() array.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>SHA256_Bytes</strong>: <br/>• Implements full SHA-256 hash calculation as per FIPS 180-4. <br/>• Uses 32-bit unsigned arithmetic emulation to handle operations like ADD32 and ROR32. <br/>• Computes SHA-256 over 512-bit blocks, applying padding, K constants, and initial hash values. <br/>• Returns a 32-byte big-endian Byte() array or empty array on error.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>BytesToHex</strong>: <br/>• Converts a Byte() array into a lowercase hex string (2 hex digits per byte). <br/>• For empty arrays, returns an empty string. <br/>• Locale-independent: uses numeric-to-hex functions that pad to two characters per byte.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>SHA256_FileHex</strong>: <br/>• Reads the file using ReadBinaryFile, then calls SHA256_Bytes and BytesToHex. <br/>• Returns the file's SHA-256 hash in hex or an empty string on failure. <br/>• Handles file read errors (lock/permission issues) gracefully.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>WriteManifest</strong>: <br/>• Generates the JSON manifest for a job. <br/>• Inputs: jobFolder (destination folder), jobId (job identifier), fileList (collection of file paths). <br/>• For each valid file, the manifest includes the following fields: path, size, modified timestamp, and SHA-256 hash. <br/>• Skips unreadable files but continues manifest generation. <br/>• JSON output is deterministic, sorted alphabetically by normalized path. <br/>• Writes manifest.json atomically using modIO.WriteCsvAtomic.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Atomic Write Integration:</strong> <br/>• Uses modIO.WriteCsvAtomic to ensure atomic file writes. <br/>• JSON data is encoded as UTF-8 bytes (ADODB.Stream binary write or text with appropriate charset and BOM). <br/>• Manifest.json is not written until the entire process completes successfully.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Unsigned 32-bit Arithmetic Helpers (recommended):</strong> <br/>• Private Function ADD32(a As Double, b As Double) As Double → Adds two values, masks the result to simulate 32-bit unsigned arithmetic. <br/>• Private Function ROR32(v As Double, n As Integer) As Double → Performs a 32-bit rotate right operation. <br/>• Other helpers: SHR32 (shift), XOR32 (XOR). All helpers should mask the result to ensure correct 32-bit unsigned semantics.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Error Handling Model:</strong> <br/>• Uses On Error GoTo for each public function. <br/>• On error, functions return appropriate empty values: empty strings, zero-length Byte() arrays, or False for Booleans. <br/>• Logs errors via modUtils.LogMsg, including error details and context. <br/>• Does not propagate unhandled errors to the caller.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Edge Cases &amp; Special Behaviors:</strong> <br/>• Empty files: SHA-256 of empty files should match the known empty hash vector (e3b0...). <br/>• Locked/unreadable files: ReadBinaryFile returns an empty array, SHA256_FileHex returns an empty string, and the manifest will note the missing entry. <br/>• Large files: For memory safety, ADODB.Stream supports chunked reading. Consider using a streaming-hash variant for very large files. <br/>• Non-ASCII bytes are preserved exactly without conversion.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Inter-Module Contracts:</strong> <br/>• modMain expects WriteManifest to return False on failure, without throwing exceptions. <br/>• modIO.WriteCsvAtomic must handle UTF-8 content and ensure atomic file rename operations. <br/>• modUtils is used for logging, path management, and safe file movements.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Performance &amp; Resource Notes:</strong> <br/>• SHA-256 in pure VBA is CPU-bound and slower than native implementations, which is acceptable for small to medium files. <br/>• For very large files, consider external hashing tools (e.g., PowerShell/certutil) as an optional fallback. <br/>• Ensure ADODB.Stream objects are properly released (Set ... = Nothing) after use to free COM resources.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Security &amp; Integrity Considerations:</strong> <br/>• SHA-256 provides tamper detection for the manifest. <br/>• No network operations are involved, ensuring that only local file I/O is performed. <br/>• Manifest JSON should be sanitized to avoid exposing sensitive paths or data. Consider applying path normalization for release artifacts.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Tests &amp; Verification (10× Checklist):</strong> <br/>1) Verify ReadBinaryFile returns expected Byte() array length for a test file. <br/>2) Confirm that SHA256_FileHex matches an external tool (e.g., certutil). <br/>3) Ensure SHA256_Bytes implementation passes known SHA-256 test vectors. <br/>4) Confirm BytesToHex outputs correct lowercase hex without prefixes. <br/>5) Validate JSON manifest parsing with external validators. <br/>6) Ensure missing/unreadable files are skipped without breaking the manifest. <br/>7) Ensure ADODB.Stream failures return an empty array and do not raise exceptions. <br/>8) Confirm all variables are released correctly and no variables shadow others. <br/>9) Ensure deterministic output for repeated runs with identical inputs. <br/>10) Perform full end-to-end tests, ensuring the manifest is written atomically and correctly verified.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Immediate Improvements &amp; Recommendations:</strong> <br/>• Implement chunked/streaming SHA-256 computation to handle large files without loading entire files into memory. <br/>• Add optional external hashing fallback (e.g., PowerShell/certutil) when VBA or CPU performance becomes a bottleneck. <br/>• Provide a verbose mode that logs file-by-file processing times and hashing durations. <br/>• Consider including a manifest signature (.sig) workflow to provide enhanced integrity guarantees.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Ops &amp; Troubleshooting Tips:</strong> <br/>• If SHA256_FileHex returns an empty string, inspect file permissions and locks. Check modUtils.LogMsg for detailed error context. <br/>• If manifest entries are missing, verify file existence, path normalization, and ensure files are accessible. <br/>• For mismatched external hashes, ensure the byte sequence is canonical (no CRLF or encoding conversion), and try using chunked reads for large files.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Documentation &amp; Comments:</strong> <br/>• Each function should have a header comment that includes purpose, inputs, outputs, side effects, and error handling details. <br/>• Document the SHA-256 algorithm and test vectors used for validation. <br/>• Explicitly document the manifest JSON schema and provide example outputs.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Backward Compatibility &amp; Versioning:</strong> <br/>• Preserve function signatures to maintain backward compatibility. <br/>• Add a constant <code>MODMANIFEST_VERSION = "2025-11-27-1"</code> at the top of the module, and maintain a changelog for any algorithmic changes.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Final Verification Statement:</strong> <br/>• Before committing changes, implementers must run the 10× checklist, validate SHA-256 against known external tools, perform end-to-end manifest generation, and ensure manifest.json is written atomically and correctly.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 24</div></div><div class="table-caption" id="Table6" data-table="Docu_0144_06" style="margin-top:2mm;margin-left:3mm;"><strong>Table 6</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by pph21_2025 — Excel (VBA) User Guide (BPJS updated)" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">pph21_2025 — Excel (VBA) User Guide (BPJS updated)</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>Quick Verification Note:</strong><br/> This guide has been reviewed with 10× consistency checks against all delivered modules (modMain, modIO, modCalc, modManifest, modUtils), sheet names, table structures, CSV outputs, manifest format, error handling, atomic-write logic, and the BPJS field additions.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>1. Save Workbook as Macro-Enabled:</strong><br/> Save your master file as <strong>pph21_2025.xlsm</strong>. Ensure macros are enabled (Trusted Location or Enable Content). Without macros enabled, the job runner <strong>pph21_RunAll</strong> cannot operate.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>2. Required Worksheets (Exact Names):</strong><br/> Create these sheets with exact spelling: <strong>Settings</strong>, <strong>Input</strong>, <strong>Rules_Brackets</strong>, <strong>Rules_Params</strong>, <strong>Outputs_BuktiPotong</strong>, <strong>Outputs_Per11</strong>, <strong>Logs</strong>. These names can be overridden via settings keys in the <strong>Settings</strong> sheet, but defaults assume these names.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>3. Create Input Table (tblInput):</strong><br/> On the <strong>Input</strong> sheet, insert a Table and name it <strong>tblInput</strong>. <br/> <strong>Required fields (headers exactly):</strong> nip, npwp, name, period, period_type, gross, npwp_status. <br/> <strong>BPJS sub-fields (new, required if you track components):</strong> bpjs_ke_emp, bpjs_jkk_emp, bpjs_jkm_emp, bpjs_jht_emp_emp (employer parts) and bpjs_ke_emp_pct, bpjs_jkk_emp_pct, bpjs_jkm_emp_pct, bpjs_jht_emp_pct (optional percent fields). <br/> <strong>Employee-side fields (new):</strong> bpjs_ke_employee, bpjs_jht_employee, iuran_bpjs_employee (or aggregated iuran_bpjs_employee). <br/> Additional columns are allowed and will be preserved in <strong>bukti_potong.csv</strong>.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>4. Rules Table — tblBrackets:</strong><br/> On the <strong>Rules_Brackets</strong> sheet, create a Table named <strong>tblBrackets</strong> with headers: <strong>upper</strong>, <strong>rate</strong>. <br/> <strong>Requirements:</strong> upper must be ascending; last row must contain a large sentinel (e.g., 999999999); rates decimal (0–1).</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>5. Rules Table — tblParams:</strong><br/> On the <strong>Rules_Params</strong> sheet, create a Table named <strong>tblParams</strong> with headers: <strong>key</strong>, <strong>value</strong>. <br/> <strong>Common keys:</strong> dtp_pct, npwp_penalty_pct, annualization_default. <br/> <strong>BPJS-related keys (optional):</strong> include_employer_bpjs_in_gross → true; allow_employee_bpjs_deduction → true.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>6. Settings Sheet Keys:</strong><br/> On <strong>Settings</strong>, column A = key, column B = value. <br/> <strong>Required:</strong> OUTPUT_BASE → absolute folder path (e.g., C:\pph21_output). <br/> <strong>Optional:</strong> JOB_ID (pre-assigned; leave blank for auto-generation), RULES_BRACKETS_SHEET, RULES_PARAMS_SHEET. <br/> <strong>Optional BPJS enforcement:</strong> INCLUDE_BPJS_FIELDS → true (default recommended).</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>7. JOB_ID Rules:</strong><br/> If empty, system generates <strong>JOB_ID</strong> = job_YYYYMMDD_HHNNSS. This JOB_ID is written back to <strong>Settings</strong> and becomes the folder name under <strong>OUTPUT_BASE</strong>.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>8. VBA References:</strong><br/> Modules use late binding. Enabling <strong>Microsoft Scripting Runtime</strong> recommended for Dictionary performance and type hints. No external libraries required.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>9. Module Placement (Exact Names):</strong><br/> Modules must be exactly: <strong>modMain</strong>, <strong>modIO</strong>, <strong>modCalc</strong>, <strong>modManifest</strong>, <strong>modUtils</strong>. Paste delivered VBA exactly and do not rename modules. If modifying <strong>modCalc</strong>, preserve <strong>ComputeTax</strong> and <strong>ProcessRow</strong> signatures.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>10. Example tblBrackets:</strong><br/> Suggested bracket set: 50,000,000 → 0.05; 250,000,000 → 0.15; 500,000,000 → 0.25; 1,000,000,000 → 0.30; 999,999,999,999 → 0.35.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>11. Example tblParams:</strong><br/> Common values: dtp_pct → 0.05; npwp_penalty_pct → 0.20; annualization_default → monthly; include_employer_bpjs_in_gross → true; allow_employee_bpjs_deduction → true.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>12. Single Sample Input Row (BPJS example):</strong><br/> Example tblInput row for verification:<br/> nip = 12345, npwp = 0099999999, name = Test User, period = 2025-11, period_type = monthly, gross = 10,000,000, npwp_status = has, bpjs_ke_emp = 150000, bpjs_jkk_emp = 5000, bpjs_jkm_emp = 2000, bpjs_jht_emp_emp = 0, iuran_bpjs_employee = 200000. Use for end-to-end pipeline verification.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>13. Running the Macro:</strong><br/> Main entry point: <strong>pph21_RunAll</strong>. Run via Developer → Macros, or assign macro to a button. Performs a full atomic job run.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>14. Execution Pipeline (High-Level Overview):</strong><br/> 1) Read Settings<br/> 2) Generate JOB_ID if needed<br/> 3) Create OUTPUT_BASE\JOB_ID folder<br/> 4) Load tblInput into array (including BPJS columns if present)<br/> 5) Load tblBrackets, tblParams<br/> 6) For each row, aggregate BPJS employer components into <strong>premi_asuransi_employer</strong> and aggregate employee BPJS into <strong>iuran_employee</strong><br/> 7) Apply tax rules<br/> 8) Build bukti and per11 datasets<br/> 9) Write <strong>bukti_potong.csv</strong>, <strong>per11_payload.csv</strong><br/> 10) Generate <strong>manifest.json</strong><br/> 11) Import CSVs back to output sheets<br/> 12) Write Logs</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>15. Output Files (Exact Names):</strong><br/> Files located in <strong>OUTPUT_BASE\JOB_ID</strong>: bukti_potong.csv, per11_payload.csv, manifest.json.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>16. CSV Schemas Produced (BPJS added):</strong><br/> <strong>bukti_potong.csv</strong> recommended order:<br/> nip, npwp, name, period, period_type, gross, bpjs_ke_emp, bpjs_jkk_emp, bpjs_jkm_emp, bpjs_jht_emp_emp, premi_asuransi_employer (sum of employer BPJS + other employer premi), iuran_bpjs_employee, iuran_pensiun, annual_gross, annual_tax, tax_after_dtp, tax_after_penalty, monthly_withholding, plus all extra input columns preserved.<br/> <strong>per11_payload.csv</strong> columns:<br/> nip, npwp, period, monthly_withholding, annual_tax, premi_asuransi_employer, iuran_bpjs_employee. The code computes <strong>premi_asuransi_employer</strong> automatically as the sum of employer BPJS components and other employer premium fields.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>17. Manifest.json Specification:</strong><br/> Contains: job_id, generated_at timestamp, files[] list (path, size, modified, sha256). SHA-256 hashes are lowercase hex and computed inside VBA. No change required for BPJS.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>18. Atomic Write Guarantees:</strong><br/> All CSV/JSON writes first go to <strong>.tmp</strong> files, then are renamed. Existing final files are removed before writing the <strong>.tmp</strong>. Partial files cannot appear unless external interruption occurs.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>19. Logs Sheet:</strong><br/> System logs: Settings read, Path creation, Table load counts, File write events, BPJS aggregation events, Errors with timestamps.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>20. Common Errors &amp; Fixes (with BPJS):</strong><br/> <strong>"Path not found"</strong> → Ensure OUTPUT_BASE exists.<br/> <strong>"Key not found"</strong> → Missing Settings or Params key.<br/> <strong>Empty outputs</strong> → tblInput empty or missing columns.<br/> <strong>Wrong types</strong> → Ensure gross, upper, rate, and BPJS numeric fields are numeric.<br/> <strong>BPJS fields missing</strong> → If INCLUDE_BPJS_FIELDS = true, missing BPJS columns cause a validation warning and are treated as zero (unless strict_bpjs setting enabled → hard error).</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>21. Validation Tests:</strong><br/> Recommended tests: Bracket boundary tests; Missing NPWP penalty test; Period-type variations; High-income test; Employer-BPJS-as-gross test (verify premi_asuransi_employer increases gross base where applicable); Employee-BPJS-deduction test (verify deduction applied when allowed).</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>22. Version Safety:</strong><br/> Always duplicate workbook before modifying macros, rules, or sheet structures.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>23. Extending Logic:</strong><br/> All tax computation logic is in <strong>modCalc</strong> (<strong>ComputeTax</strong>, <strong>ProcessRow</strong>). To change BPJS classification, modify <strong>ComputeTax</strong> only and keep signatures. Add helper aggregators in <strong>modUtils</strong> if needed.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>24. Performance Guidance:</strong><br/> Optimized for hundreds to a few thousand rows. For larger volumes, run in batches or migrate core to Python.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>25. Security Considerations:</strong><br/> Macros write files—ensure workbook and OUTPUT_BASE path restricted to trusted users. BPJS data is personal payroll data—treat accordingly.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>26. Re-running Jobs:</strong><br/> If JOB_ID unchanged, outputs overwritten. Leave JOB_ID blank to force fresh timestamped job ID.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>27. CSV Import Rules:</strong><br/> <strong>ImportCsvToSheet</strong> uses QueryTables and preserves text format for npwp and nip to avoid scientific notation. When importing, confirm BPJS fields imported as numeric/currency.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>28. Testing Automation:</strong><br/> Add <strong>Test_RunAll</strong> macro to populate tblInput with BPJS example rows, run the job, and assert expected outputs in output sheets.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>29. Documentation Locations:</strong><br/> Module comments describe responsibilities: <strong>modMain</strong> = orchestrator; <strong>modIO</strong> = tables/CSV handling; <strong>modCalc</strong> = tax logic; <strong>modManifest</strong> = hashing; <strong>modUtils</strong> = helper functions. Add short note at top of <strong>modCalc</strong> describing BPJS aggregation logic.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>30. Support Checklist:</strong><br/> Before seeking support, ensure you have: sample workbook, Settings values, Bracket table, Params table (with BPJS keys if changed), Sample inputs, Logs output, generated manifest.json.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>31. Operational Checks Before Production:</strong><br/> 1) Validate tblInput headers exactly (including BPJS headers if used).<br/> 2) Validate bracket ordering.<br/> 3) Ensure OUTPUT_BASE exists.<br/> 4) Run a single test row (including BPJS example).<br/> 5) Inspect Logs for issues.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>32. Audit Trails:</strong><br/> Keep entire job folder (CSV + manifest), a snapshot of Settings, and rule tables for audit reproducibility. BPJS component columns must be retained for audit.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>33. Migration Path:</strong><br/> For advanced rule engines, high-volume processing, multilingual CSV exports, or parallel jobs, consider using a Python engine with Excel as UI.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>34. Folder Housekeeping:</strong><br/> OUTPUT_BASE may accumulate many JOB_ID subfolders. Clean periodically or archive old data.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>35. Final Pre-Run Checklist:</strong><br/> ✓ Workbook saved as macro-enabled<br/> ✓ Macros enabled<br/> ✓ Sheets created (Input, Rules, Outputs, Logs)<br/> ✓ tblInput, tblBrackets, tblParams created<br/> ✓ OUTPUT_BASE exists<br/> ✓ If INCLUDE_BPJS_FIELDS = true, confirm BPJS columns present or explicitly accept zero defaults.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>CSV header examples:</strong><br/> <strong>bukti_potong.csv header (recommended order):</strong><br/> nip,npwp,name,period,period_type,gross,bpjs_ke_emp,bpjs_jkk_emp,bpjs_jkm_emp,bpjs_jht_emp_emp,premi_asuransi_employer,iuran_bpjs_employee,iuran_pensiun,annual_gross,annual_tax,tax_after_dtp,tax_after_penalty,monthly_withholding<br/> <strong>per11_payload.csv header (recommended):</strong><br/> nip,npwp,period,monthly_withholding,annual_tax,premi_asuransi_employer,iuran_bpjs_employee</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>Validation &amp; error handling rules (BPJS-specific):</strong><br/> BPJS numeric fields must be numeric ≥ 0; non-numeric → validation error and row skipped (or zero if strict_bpjs=false in tblParams).<br/> If INCLUDE_BPJS_FIELDS=true but BPJS columns missing: log warning and create zero columns in-memory (unless strict_bpjs=true → hard error).<br/> Percent fields (*_pct) must be in [0,1]; if both amount and percent supplied → amount takes precedence.<br/> If aggregated premi_asuransi_employer &gt; 50% of gross: log sanity warning.</div></div></td></tr><tr><td data-label="pph21_2025 — Excel (VBA) User Guide (BPJS updated)"><div class="tv-left-col"><div class="left-col-heading"><strong>Ten-point verification (performed):</strong><br/> 1) Sheet presence check: All referenced sheets remain unchanged.<br/> 2) tblInput header check: Required BPJS columns listed and mapped.<br/> 3) BPJS classification: Employer BPJS aggregated into premi_asuransi_employer and included in gross when enabled.<br/> 4) Employee deduction: Employee BPJS aggregated into iuran_bpjs_employee and deducted when allowed.<br/> 5) CSV schema consistency: bukti_potong.csv and per11_payload.csv aligned with aggregation logic.<br/> 6) Atomic write: .tmp → rename flow unchanged.<br/> 7) Manifest consistency: New fields do not affect manifest format; hashes follow file updates.<br/> 8) Validation rules: Numeric and percent BPJS rules included.<br/> 9) Sample-row test: Sample row yields deterministic aggregation and withholding.<br/> 10) Backward compatibility: Missing BPJS treated as zero unless strict_bpjs=true.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 39</div></div><div class="table-caption" id="Table7" data-table="Docu_0144_07" style="margin-top:2mm;margin-left:3mm;"><strong>Table 7</strong></div>
<div class="table-wrapper" data-table-id="table-7"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by Excel Skeleton Example (bpjs_added.xlsx)" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Excel Skeleton Example (bpjs_added.xlsx)</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Excel Skeleton Example (bpjs_added.xlsx)"><div class="tv-left-col"><div class="left-col-heading"><strong>Sheet: Input</strong><br/><strong>Table:</strong> tblInput<br/><strong>Columns:</strong> nip, npwp, name, period, period_type, gross, npwp_status, bpjs_ke_emp, bpjs_jkk_emp, bpjs_jkm_emp, bpjs_jht_emp_emp, bpjs_ke_emp_pct, bpjs_jkk_emp_pct, bpjs_jkm_emp_pct, bpjs_jht_emp_pct, bpjs_ke_employee, bpjs_jht_employee, iuran_bpjs_employee.</div></div></td></tr><tr><td data-label="Excel Skeleton Example (bpjs_added.xlsx)"><div class="tv-left-col"><div class="left-col-heading"><strong>Sheet: Rules_Brackets</strong><br/><strong>Table:</strong> tblBrackets<br/><strong>Columns:</strong> upper, rate.</div></div></td></tr><tr><td data-label="Excel Skeleton Example (bpjs_added.xlsx)"><div class="tv-left-col"><div class="left-col-heading"><strong>Sheet: Rules_Params</strong><br/><strong>Table:</strong> tblParams<br/><strong>Keys:</strong> dtp_pct, npwp_penalty_pct, annualization_default, include_employer_bpjs_in_gross, allow_employee_bpjs_deduction.</div></div></td></tr><tr><td data-label="Excel Skeleton Example (bpjs_added.xlsx)"><div class="tv-left-col"><div class="left-col-heading"><strong>Sheet: Settings</strong><br/><strong>Keys:</strong> OUTPUT_BASE, JOB_ID, INCLUDE_BPJS_FIELDS.</div></div></td></tr><tr><td data-label="Excel Skeleton Example (bpjs_added.xlsx)"><div class="tv-left-col"><div class="left-col-heading"><strong>Sheet: Logs</strong><br/>Logs events related to the BPJS aggregation process.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 5</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>