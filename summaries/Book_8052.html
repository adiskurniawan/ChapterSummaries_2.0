<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1762008369">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#Table6">Table 6</a></li>
<li class="toc-item"><a class="toc-link" href="#Table7">Table 7</a></li>
<li class="toc-item"><a class="toc-link" href="#Table8">Table 8</a></li>
<li class="toc-item"><a class="toc-link" href="#Table9">Table 9</a></li>
<li class="toc-item"><a class="toc-link" href="#Table10">Table 10</a></li>
<li class="toc-item"><a class="toc-link" href="#Table11">Table 11</a></li>
<li class="toc-item"><a class="toc-link" href="#Table12">Table 12</a></li>
<li class="toc-item"><a class="toc-link" href="#Table13">Table 13</a></li>
<li class="toc-item"><a class="toc-link" href="#Table14">Table 14</a></li>
<li class="toc-item"><a class="toc-link" href="#Table15">Table 15</a></li>
<li class="toc-item"><a class="toc-link" href="#Table16">Table 16</a></li>
<li class="toc-item"><a class="toc-link" href="#Table17">Table 17</a></li>
<li class="toc-item"><a class="toc-link" href="#Table18">Table 18</a></li>
<li class="toc-item"><a class="toc-link" href="#Table19">Table 19</a></li>
<li class="toc-item"><a class="toc-link" href="#Table20">Table 20</a></li>
<li class="toc-item"><a class="toc-link" href="#Table21">Table 21</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Book_8052_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1 — main.py</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>File-level summary (expanded)</strong><br><br>This <code>main.py</code> is the unified entrypoint for PasteToTable. It multiplexes two modes: a web application (via <code>html_renderer.create_app</code>) and a batch export mode (Table Viewer style) triggered by <code>--batch</code> CLI or <code>P2T_BATCH</code> env. It embeds a robust markdown/csv table parser, conservative markdown-to-html helpers, Dropbox-path sanitization, DataFrame-to-HTML rendering preserving inline code, fragment cleanup utilities, a flexible renderer-caller adapter, and a batch orchestration flow. The design is defensive: optional dependencies (pandas, html_renderer) are imported lazily or with graceful fallbacks; logging is used heavily for observability; operations avoid modifying locked files; and the code favors safe defaults over aggressive transformations (no automatic <code>&lt;br&gt;</code> injection). This file is intended for reliability across varied deployment environments, including minimal containers and developer machines. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Top-level imports & dependency strategy</strong><br><br>Uses local imports for heavy libs (<code>pandas</code>) inside the functions that require them to prevent import-time failure when running web-only or constrained environments. <code>html_renderer.create_app</code> is imported at module top-level within a try/except so web mode can fail early with an explanatory log. The <code>_load_renderer_callable()</code> supports dynamic loading of a local <code>html_renderer.py</code> via <code>importlib.util.spec_from_file_location</code> then falls back to importing a package on <code>sys.path</code>. This two-tier approach increases resilience and supports both source-tree and installed-package layouts. The logger is obtained via <code>utils.make_logger</code> with expectation that <code>utils</code> exists; if <code>utils</code> is missing the import will fail early — consistent with the project's dependency contract. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Renderer loader <code>_load_renderer_callable</code></strong><br><br>Purpose: find and set <code>render_html</code> for batch exports. Behavior summary:<br>1. Prefer local <code>_html_renderer_path</code> and load it with <code>spec_from_file_location</code> to isolate local modifications.<br>2. If loaded, insert into <code>sys.modules[&quot;html_renderer_local&quot;]</code> to keep identity for reloads and to satisfy downstream introspection.<br>3. Extract <code>render_html</code> callable and log whether found or missing.<br>4. If local file absent, try standard <code>import html_renderer</code> from <code>sys.path</code> and repeat extraction.<br>5. Capture and log exceptions, including stack traces at debug level.<br>Design notes: inserting module into <code>sys.modules</code> reduces weirdness when other code attempts <code>import html_renderer</code>. The function does not swallow all exceptions silently — it logs and sets <code>render_html=None</code> so batch flow can choose fallback behavior. Potential improvement: return diagnostic object with module path and function signature to simplify operator debugging. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CSV reader <code>_safe_read_csv</code></strong><br><br>Problem addressed: pandas API changes (older versions use <code>error_bad_lines</code> / <code>warn_bad_lines</code>; newer versions use <code>on_bad_lines</code>). Behavior:<br>1. Local import of pandas; if missing this raises to caller (batch code checks and aborts).<br>2. Accepts <code>data</code> string or file-like object. Wraps string into <code>StringIO</code> if necessary.<br>3. Primary attempt: <code>pd.read_csv(..., on_bad_lines=&quot;skip&quot;, skip_blank_lines=False, engine=&quot;python&quot;)</code> to be permissive.<br>4. Fallbacks: catch <code>TypeError</code> (signature mismatch), rewind file, call <code>pd.read_csv</code> with older kwargs (<code>error_bad_lines=False</code>, <code>warn_bad_lines=False</code>).<br>5. Last-resort: simpler <code>pd.read_csv(f, sep=sep, engine=&quot;python&quot;, skipinitialspace=False)</code>.<br>Design tradeoffs: uses <code>engine=&quot;python&quot;</code> for robust parsing at cost of speed. This method minimizes batch failures on diverse CSV quirks. Potential improvement: detect delimiter and quoting heuristics before choosing engine or enable <code>quoting=csv.QUOTE_MINIMAL</code> for known edge cases. </td></tr></tbody></table></div><div class="row-count">Rows: 4</div></div><div class="table-caption" id="Table2" data-table="Book_8052_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2 — html_renderer.py</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>File-level summary (expanded)</strong><br><br>This module is a hardened, backward-compatible HTML renderer and adapter. It attempts to import upstream renderers and helpers, records diagnostics, and provides conservative string-based post-processing: ensure <code>&lt;h1&gt;</code> title attributes, optional minification, injection of PTT UI CSS/JS, conversion of newlines to <code>&lt;br&gt;</code> inside table cells only, and wrapping each top-level <code>&lt;table&gt;</code> into a <code>.table-wrapper</code> with inline JSON metadata or a JSON <code>&lt;script&gt;</code> fallback. It includes safe fallbacks that produce usable HTML when dependencies (like <code>pandas</code> or <code>render.*</code> modules) are missing. The file is oriented toward reliability and predictable output rather than maximal parsing fidelity. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Runtime configuration and overrides</strong><br><br>Renderer behavior is controlled by <code>_renderer_config</code> with defaults loaded from env. Key toggles:<br><br>• <code>ensure_title</code> (bool) — ensure first <code>&lt;h1&gt;</code> has configured <code>class</code> and <code>id</code>.<br>• <code>minify_html</code> (bool) — conservative whitespace minification outside protected blocks.<br>• <code>process_path_outputs</code> (bool) — if <code>True</code> post-process <code>Path</code> returns from renderers.<br>• <code>page_title_class</code>, <code>page_title_id</code> — class/id injected into <code>&lt;h1&gt;</code> when <code>ensure_title</code> is enabled.<br>• <code>table_ui_css</code>, <code>table_ui_js</code> — URLs for PTT assets to inject if absent.<br>• <code>table_ui_max_attr_json_len</code> — threshold in bytes for storing metadata in <code>data-ptt-json</code> vs JSON <code>&lt;script&gt;</code>.<br><br><code>set_renderer_config(**kwargs)</code> validates keys and silently ignores unknown keys. Use this to change behavior at runtime before first render. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Import & diagnostics strategy</strong><br><br>Import attempts recorded via <code>_record()</code> into a capped deque. Attempt order:<br><br>1. <code>render.core_compat.render_html/render_table/render_page</code><br>2. <code>render.core_renderer.render_html/render_table</code><br><br>Optional helpers attempted: <code>render.convert</code>, <code>render.sanitize</code>, <code>render.core_assets</code>. Failures are non-fatal and aggregated in <code>get_import_diagnostics()</code> and <code>generate_diagnostic_report()</code>. <code>_debug</code> enables traceback capture. This pattern enables systems to run in minimal environments while surfacing root-cause info for ops teams. </td></tr><tr><td data-label="Technical Breakdown"> <strong>String-based vs DOM parsing: rationale and limitations</strong><br><br>All transformations are implemented with regular expressions and string operations. Rationale: avoid heavy dependencies, keep bootstrapping simple, and reduce install-time failures. Limitations: regex-based HTML processing can fail on severely malformed HTML, scripts containing <code>&lt;/table&gt;</code>-like substrings, or unusual attribute quoting. Recommendation: prefer an HTML parser (e.g., <code>lxml</code>, <code>html5lib</code>) for production-grade inputs or provide a controlled path where the renderer will use the parser when available and fallback to regex otherwise. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Title enforcement details</strong><br><br><code>_ensure_title_attrs_in_str()</code> finds the first <code>&lt;h1&gt;</code> using <code>_H1_RE</code> and ensures <code>class</code> and <code>id</code> attributes. Behavior specifics:<br><br>• If <code>&lt;h1 class=&quot;...&quot;&gt;</code> present, append <code>page_title_class</code> if not present, preserving other classes.<br>• If <code>id</code> absent, add <code>id=page_title_id</code>.<br>• Only modifies the first matched <code>&lt;h1&gt;</code> instance and avoids touching remaining markup.<br><br>Edge cases handled: varying attribute order, single/double quotes, presence of newlines in tag, and unexpected capitalization. If the fragment cannot be processed safely the function returns original HTML unchanged and logs the event. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Conservative minification semantics</strong><br><br><code>_minify_html_str()</code> splits the document using <code>_MINIFY_TOKEN_RE</code> which preserves script/style/pre/code/textarea and HTML tags. For text-node tokens it collapses runs of whitespace to a single space then trims. It intentionally avoids removing optional tags or attributes. This yields smaller HTML payloads while avoiding breaking inline script or preformatted blocks. Use-case: moderate payload reduction for network transfer. Avoid enabling on content that depends on preserved whitespace inside inline markup. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Byte processing and encoding resilience</strong><br><br><code>_process_bytes()</code> decodes using UTF-8 with fallback to Latin-1. After post-processing it re-encodes to UTF-8. This avoids UnicodeDecodeError crashes when renderers return bytes in various encodings. If decoding fails entirely, it returns original bytes to avoid data-loss. When wrapping third-party renderers that produce bytes, ensure <code>_renderer_config</code> toggles are set before calling to influence the final encoded output. </td></tr><tr><td data-label="Technical Breakdown"> <strong>PTT UI injection strategy</strong><br><br><code>_inject_ui_assets()</code> checks existing <code>&lt;link&gt;</code> and <code>&lt;script src&gt;</code> tags by comparing basenames (query and fragment stripped) and injects missing CSS before <code>&lt;/head&gt;</code> and missing JS before <code>&lt;/body&gt;</code> (or <code>&lt;/head&gt;</code> fallback). Advantages: avoids duplicate asset injection and supports pre-bundled themes. Caveat: detection by basename fails when assets are served with dynamic filenames or CDN query parameters that alter basenames; use exact URLs in config to reduce risk. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Cell-level newline conversion rules</strong><br><br><code>_convert_newlines_in_table_cells()</code> focuses only on the interior of <code>&lt;td&gt;</code> and <code>&lt;th&gt;</code> tags. Rules:<br><br>1. Normalize <code>\r\n</code> and <code>\r</code> to <code>\n</code>.<br>2. If cell contains <code>&lt;pre&gt;</code>, <code>&lt;code&gt;</code>, <code>&lt;textarea&gt;</code> or <code>&lt;script&gt;</code> substring (case-insensitive) skip conversion entirely to preserve semantics.<br>3. If cell already contains <code>&lt;br&gt;</code> (any variant) skip conversion to avoid duplicate <code>&lt;br&gt;</code>s.<br>4. Replace <code>\n</code> → <code>&lt;br&gt;</code> for remaining cells. <br><br>Why conservative: cell content may already be preformatted or may contain HTML snippets where injecting <code>&lt;br&gt;</code> would corrupt the semantics. This function is idempotent if input already processed. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Table fragment wrapping logic (detailed)</strong><br><br><code>_wrap_each_table_with_ui()</code> iterates <code>_TABLE_RE</code> matches and for each table:<br><br>• Extracts and temporarily removes <code>&lt;caption&gt;</code> for consistent placement.<br>• Scans the immediate previous slice for an immediately preceding heading (<code>&lt;h1&gt;-&lt;h6&gt;</code>) to use its text and id as the table title and id.<br>• If header exists it removes it from the previous slice to avoid duplication.<br>• Generates a stable <code>table_id</code> by preferring existing table <code>id</code> then header <code>id</code> then <code>Table&lt;N&gt;</code> base with collision-resolving suffixes.<br>• Builds a wrapper <code>&lt;div class=&quot;table-wrapper&quot; id=&quot;table-wrapper-&lt;id&gt;&quot; data-title=&quot;...&quot; data-ptt-json=&quot;...&quot;&gt;...&lt;/div&gt;</code> when JSON payload is within <code>table_ui_max_attr_json_len</code>, otherwise emits a sibling <code>&lt;script type=&quot;application/json&quot; data-ptt=&quot;&lt;id&gt;&quot;&gt;...&lt;/script&gt;</code> to store the JSON safely.<br><br>This design balances HTML attribute size limits and keeps metadata close to the table for easy client-side discovery. </td></tr><tr><td data-label="Technical Breakdown"> <strong>JSON metadata construction and escaping</strong><br><br>Metadata payload is <code>{&quot;html&quot;: &quot;&lt;table...&gt;...&lt;/table&gt;&quot;}</code> serialized with <code>json.dumps(..., ensure_ascii=False, separators=(&quot;,&quot;, &quot;:&quot;))</code>. When embedding into attribute the JSON string is escaped with <code>_html.escape</code>. For large JSON payloads the <code>&lt;script type=&quot;application/json&quot;&gt;</code> fallback is used and again the JSON string is escaped to avoid breaking the enclosing HTML. Security: because table HTML may contain user content, ensure any untrusted content is escaped before inclusion if you rely on attributes for client-side HTML insertion without additional sanitization. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Toolbar & UI markup design</strong><br><br<code>**</code> The default toolbar HTML (<code>_default_toolbar_html()</code>) provides accessible buttons with <code>role=&quot;toolbar&quot;</code> and <code>aria-label</code>. Buttons include toggle, copy, export CSV/JSON/MD. These are minimal building blocks expected to be wired by the PTT client JS. Keep <code>table_ui_toolbar_html</code> config to override toolbar for custom deployments. Ensure JS looks for <code>.table-wrapper</code> and the <code>data-ptt-json</code> or the JSON script to hydrate client features. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Wrapper id generation & collision handling</strong><br><br>ID generation attempts to preserve existing IDs. If none found it uses <code>TableN</code> with a numeric suffix and checks <code>used_ids</code> to avoid collision within a single processed document. This prevents accidental duplicate <code>id</code> attributes that break anchor links. For distributed rendering across pages ensure unique naming per document or include a prefix derived from page context to avoid cross-page collisions when embedding multiple documents into a single DOM. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Wrapper size threshold tuning</strong><br><br<code>**</code> <code>table_ui_max_attr_json_len</code> controls the cutoff for embedding metadata in attributes vs script element. Consider these tuning points:<br>1. Browsers and proxies may impose limits on attribute length. Keep attribute JSON under a few KB for safety (default 3000).<br>2. If tables are frequently large, lower the threshold to force script fallback which is robust and avoids HTML attribute bloat.<br>3. Measure typical rendered size and set threshold to median + 2*sigma to balance locality and safety. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Wrapper placement and heading interaction</strong><br><br>If a heading immediately precedes a table and is detected, the wrapper will not re-emit a new <code>&lt;h3&gt;</code> for that table. Instead it reuses the heading text and id. This preserves the author's original semantic structure while associating the UI wrapper. When no header found a generated <code>&lt;h3&gt;</code> is added with an anchor to the generated table id. </td></tr><tr><td data-label="Technical Breakdown"> <strong>_wrap_callable behavior and contract</strong><br><br><code>_wrap_callable(fn)</code> returns a function that post-processes <code>fn</code>'s return value. It handles outputs of types <code>str</code>, <code>bytes/bytearray</code>, and <code>pathlib.Path</code>. It applies <code>_ensure_title_attrs_in_str</code>, <code>_minify_html_str</code>, <code>_inject_ui_assets</code>, and <code>_wrap_each_table_with_ui</code> in that order. It marks wrapped functions with <code>__tv_wrapped__</code> to avoid repeated wrapping. If post-processing fails it logs and returns the original output. For implementers: apply <code>set_renderer_config()</code> before wrapping to ensure correct behavior. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Fallback renderer detailed behavior</strong><br><br>When upstream renderers are absent the fallback implementations provide usable HTML:<br><br>• <code>_df_to_str_safe(df)</code>: <code>df.fillna(&quot;&quot;).astype(str)</code> preferred. Fallback iterates cells element-wise to coerce to strings safely. This avoids numeric coercion that could reformat IDs or codes.<br>• <code>_df_to_html_preserve_code(df)</code>: replaces inline backtick code with unique placeholders, runs <code>to_html(escape=True)</code> to prevent XSS, and then restores placeholders as <code>&lt;code&gt;escaped&lt;/code&gt;</code> ensuring content is safe and code spans preserved.<br>• <code>_fallback_render_html(tables, output_path, inline_formatter, page_title)</code>: constructs a minimal HTML document with a <code>&lt;h1&gt;</code> controlled by config and writes to <code>output_path</code> if provided. Returns path or HTML string/bytes as appropriate. </td></tr><tr><td data-label="Technical Breakdown"> <strong>API shim <code>create_app</code> and endpoints</strong><br><br><code>create_app(cfg)</code> first attempts to delegate to <code>server.create_app</code>. On failure it constructs a minimal Flask app exposing:<br><br>• <code>GET /</code> — serves <code>templates/index.html</code> or <code>assets/index.html</code> fallback.<br>• <code>GET /api/health</code> — returns uptime.<br>• <code>POST /api/convert</code> and <code>POST /api/render</code> — extract text payload and call <code>render_html</code> when available. Input size is guarded by <code>MAX_PASTE_SIZE</code> in <code>before_request</code>. After-response headers include <code>X-Content-Type-Options</code>, <code>X-Frame-Options</code>, <code>Referrer-Policy</code>, and <code>Permissions-Policy</code>. This provides a minimal server experience when the full app is not present. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security posture & XSS considerations</strong><br><br>Fallback rendering escapes table cells using <code>to_html(escape=True)</code> and <code>html.escape</code> for textual content. However embedding HTML into <code>data-ptt-json</code> attributes or injecting table HTML via client JS requires careful client-side sanitization or safe insertion semantics (e.g., <code>element.innerHTML = trustedHTML</code> only when sanitized). Without a DOM sanitizer, be conservative: prefer data-only JSON (e.g., arrays of cells) for untrusted inputs. The server adds basic headers to mitigate some attack vectors. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance characteristics and complexity analysis</strong><br><br>Processing cost is dominated by: regex scanning of large documents, <code>json.dumps</code> for embedding payloads, and DataFrame-to-HTML rendering when <code>pandas</code> is available. Complexity notes:<br><br>• <code>_wrap_each_table_with_ui()</code> is O(document_size) with additional O(table_html_size) per table for JSON creation.<br>• <code>_minify_html_str()</code> is O(document_size) but with regex overhead that may be expensive for multi-MB pages.<br>• DataFrame handling is O(num_cells) memory and CPU; <code>astype(str)</code> duplicates memory transiently. For very large tables use streaming or write-to-disk approach. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Instrumentation, logging, and metrics suggestions</strong><br><br>Instrument key events: import success/failure, render start/finish, bytes in/out, number of tables wrapped, size of largest table, times for <code>_convert_newlines_in_table_cells</code> and <code>_wrap_each_table_with_ui</code>. Suggested metrics:<br><br>1. <code>renderer.imports.attempts</code> (count)<br>2. <code>renderer.render.duration.ms</code> (histogram)<br>3. <code>renderer.tables.wrapped</code> (gauge per render)<br>4. <code>renderer.json_payload_size.bytes</code> (histogram)<br><br>Log levels: keep operational info at INFO and parsing exceptions at DEBUG. Avoid logging entire HTML payloads at INFO to prevent sensitive data leakage. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Unit tests & edge-case test matrix (concrete)</strong><br><br>Suggested tests to add to unit suite:<br>1. <code>_ensure_title_attrs_in_str()</code>:<br> &nbsp;&nbsp;1.1 Input with no <code>&lt;h1&gt;</code> returns unchanged.<br> &nbsp;&nbsp;1.2 <code>&lt;h1 class=&quot;x&quot;&gt;</code> gains <code>page_title_class</code> correctly.<br> &nbsp;&nbsp;1.3 <code>&lt;h1 id=&#x27;a&#x27;&gt;</code> preserves id and appends class.<br>2. <code>_minify_html_str()</code>:<br> &nbsp;&nbsp;2.1 Blocks <code>&lt;pre&gt;</code>,<code>&lt;code&gt;</code> remain unchanged.<br> &nbsp;&nbsp;2.2 Multiple whitespace collapsed outside tags.<br>3. <code>_convert_newlines_in_table_cells()</code>:<br> &nbsp;&nbsp;3.1 <code>&lt;td&gt;one\ntwo&lt;/td&gt;</code> → <code>&lt;td&gt;one&lt;br&gt;two&lt;/td&gt;</code>.<br> &nbsp;&nbsp;3.2 <code>&lt;td&gt;&lt;code&gt;one\ntwo&lt;/code&gt;&lt;/td&gt;</code> remains unchanged.<br>4. <code>_wrap_each_table_with_ui()</code>:<br> &nbsp;&nbsp;4.1 Table with preceding <code>&lt;h2 id=&quot;x&quot;&gt;</code> uses <code>x</code> as table id and does not emit an extra <code>&lt;h3&gt;</code>.<br> &nbsp;&nbsp;4.2 Table without id gets unique <code>Table1</code> etc and wrapper contains <code>data-ptt-json</code> when small and <code>&lt;script&gt;</code> when large.<br>5. <code>_df_to_html_preserve_code()</code>:<br> &nbsp;&nbsp;5.1 Inline `<code> </code>code<code> </code><code> values are </code><code>code</code>` in output and not escaped as HTML markup. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Integration & migration guidance</strong><br><br>When migrating an existing renderer pipeline:<br>1. Run <code>get_import_diagnostics()</code> to understand which pieces are active.<br>2. Call <code>set_renderer_config()</code> at startup to tune <code>table_ui_max_attr_json_len</code> and asset paths.<br>3. If switching to an HTML parser, wrap it in the same <code>_wrap_callable()</code> contract so post-processing remains identical.<br>4. For large-volume batch jobs, set <code>minify_html=False</code> and route heavy transforms to an offline preprocessor to avoid runtime stalls. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational failure modes & recovery</strong><br><br>Common failure signals and remediation:<br>• Missing <code>pandas</code> in fallback mode: fallback still works but with limited table fidelity; recommend installing <code>pandas</code> for better DataFrame rendering.<br>• JSON attribute too large: the code falls back to emitting a JSON <code>&lt;script&gt;</code>; ensure the client reads both attribute and script fallback.<br>• Regex parse anomalies on malformed HTML: consider enabling an HTML-parser path or pre-sanitizing input. Log offending snippet at DEBUG and return best-effort HTML rather than failing hard. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security hardening checklist</strong><br><br>1. Validate or sanitize user-provided HTML before storing it in <code>data-ptt-json</code> when using attribute embedding.<br>2. Limit access to <code>/api/convert</code> via authentication or rate limits when exposed publicly.<br>3. Avoid logging full HTML payloads; log sizes and summary metrics only.<br>4. If client-side will execute injected JSON into DOM via <code>innerHTML</code>, use a sanitizer (e.g., DOMPurify) or prefer structured JSON arrays that client transforms into safe DOM nodes. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Backward compatibility & extension points</strong><br><br>Designed to be pluggable: external renderers that return <code>str</code>, <code>bytes</code>, or <code>Path</code> will be accepted. <code>set_renderer_config()</code> is the primary extension point for runtime behavior. Optional helpers like <code>convert_bullets_to_ul</code> and <code>prepare_assets</code> are used when available but not required. When adding new helpers keep the optional import pattern to preserve graceful degradation. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Concrete performance tuning recommendations</strong><br><br>1. For pages >5MB turn off <code>minify_html</code> and run a dedicated minify step offline.<br>2. For tables >100k cells avoid <code>df.astype(str)</code> in-memory conversion; instead stream conversion row-by-row to HTML writer to limit peak memory. <br>3. Lower <code>table_ui_max_attr_json_len</code> to 1024 bytes in environments with conservative proxies. <br>4. If many pages are rendered, reuse a long-running process and pre-load <code>pandas</code> once to amortize import cost. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Documentation and README checklist</strong><br><br>Document clearly:<br>1. Config keys and default values.<br>2. Expected input types and supported return types for upstream renderers.<br>3. JSON attribute vs <code>&lt;script&gt;</code> fallback behavior and <code>table_ui_max_attr_json_len</code> semantics.<br>4. Create a small example showing how client-side JS should read <code>data-ptt-json</code> and fallback to JSON script. Include a sample <code>set_renderer_config()</code> snippet for common deployments. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Next-step prioritized roadmap</strong><br><br>Short-term (0-2 weeks):<br>1. Add unit tests around newline conversion and table wrapping.<br>2. Add telemetry hooks for table size and counts.<br>3. Minor refactor: guard <code>os.environ.get(...).strip()</code> usage with <code>or &quot;&quot;</code> for robustness.<br><br>Mid-term (1-3 months):<br>1. Add optional <code>lxml</code>/<code>html5lib</code> path for HTML parsing when available.<br>2. Add streaming HTML writer for large DataFrames to avoid peak memory.<br><br>Long-term (3-6 months):<br>1. Add client-server contract docs for JSON payloads and hydrate logic.<br>2. Consider a worker-based pipeline for heavy transformations to avoid blocking request threads. </td></tr></tbody></table></div><div class="row-count">Rows: 29</div></div><div class="table-caption" id="Table3" data-table="Book_8052_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3 —server.py</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>File-level summary</strong><br><br>Flask server for PasteToTable with robust fallbacks and defensive behaviors. Enforces content-length on body-bearing methods, sets minimal security headers, supports optional CORS and rate-limiting, provides convert/save/get_saved endpoints, safe template cache flush, manifest serving, and conservative pre-processing to escape leading list markers in pipe-table cells. Designed to integrate with optional render and I/O helpers but operate standalone when those modules are missing. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Top-level imports & optional modules</strong><br><br>Imports are conservative. Optional features loaded with try/except: <code>flask_cors.CORS</code>, <code>flask_limiter.Limiter</code>, <code>render_from_text</code> from various candidate modules, and <code>save_html_atomic/read_saved</code> helpers. Failure to import is logged and gracefully degraded. This pattern prioritizes bootstrapping reliability. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Logger strategy</strong><br><br>Uses <code>utils.make_logger</code> when available; otherwise <code>_make_basic_logger</code> fallback ensures logging works in minimal environments. Logger set to INFO by default. Keep logs concise to avoid exposing payloads. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Render discovery heuristics</strong><br><br><code>render_from_text</code> resolution attempts direct import <code>html_renderer.render_from_text</code> then falls back to several candidate module paths. This increases compatibility across different packaging/layouts. The server wraps calls to discovered renderers to accept multiple return shapes (str, tuple, dict). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Reference-footnote sanitizer</strong><br><br><code>_strip_ref_footnotes(s)</code> removes tokens like `<code>, </code>[Dropbox][1]<code>, and </code>[1]`. Purpose: reduce accidental renderer footnote expansion and remove noise that may interfere with table parsing. Defensive and idempotent. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Leading-list-marker escape preprocessor</strong><br><br><code>_escape_leading_list_markers_in_table_cells(text)</code> scans contiguous pipe-containing lines and per-cell encodes leading digits (<code>1.</code>) or list markers (<code>-</code>, <code>*</code>, <code>+</code>) into numeric HTML entities (e.g., <code>&amp;#49;</code> for '1') to prevent markdown renderers converting cell-start tokens into lists. Behavior:<br><br>• Operates only on blocks containing <code>|</code> to minimize false positives.<br>• Preserves pipe counts, spacing, and non-matching cells unchanged.<br>• Works line-by-line and flushes contiguous blocks atomically.<br><br>Edge cases: cells containing complex markup that starts with digits may be encoded unnecessarily but visible output remains identical. This is safe but may interfere with consumers expecting raw digits for programmatic parsing. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Helper utilities: filename & imports</strong><br><br><code>_coerce_int(value, fallback)</code> safe-casts ints. <code>_safe_filename(name, default_prefix)</code> uses <code>werkzeug.secure_filename</code> and ensures <code>.html</code> extension; fallback uses timestamp. <code>_try_import_callable(module_name, attr)</code> loads functions defensively. These helpers centralize common failure modes and avoid repetitive try/except clutter. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Flask app creation and config defaults</strong><br><br<code>**</code> <code>create_app(cfg)</code> builds Flask app with <code>static_folder=&quot;assets&quot;</code> and <code>template_folder=&quot;templates&quot;</code>. Config defaults:<br><br>• <code>MAX_PASTE_SIZE</code> = 300000<br>• <code>STORAGE_PATH</code> = "saved_tables" (resolved absolute)<br>• <code>ENABLE_CORS</code> = False<br>• <code>RATE_LIMIT</code> = None<br>• <code>FLUSH_TEMPLATES_ON_RENDER</code> = False<br><br><code>create_app</code> logs feature availability for optional components to help operators quickly see runtime capabilities. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CORS & rate-limiter integration</strong><br><br>Enables CORS if configured and <code>flask_cors</code> present. Optionally configures <code>flask_limiter</code> when present and <code>RATE_LIMIT</code> set. The code handles missing libraries gracefully and logs warnings. If <code>RATE_LIMIT</code> is set but limiter unavailable, a warning is emitted to avoid silent misconfiguration. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Content-length enforcement</strong><br><br><code>_enforce_content_length()</code> runs <code>before_request</code> for methods <code>POST</code>, <code>PUT</code>, <code>PATCH</code>. It checks <code>request.content_length</code> against <code>MAX_PASTE_SIZE</code> and returns <code>413</code> when exceeded. Defensive: wrapped in try/except to avoid blocking healthy requests on unexpected errors. Note: <code>content_length</code> may be <code>None</code> for chunked transfers; consider reading body length for stronger enforcement but beware of memory cost. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Jinja template cache flush helper</strong><br><br><code>_clear_jinja_template_cache()</code> attempts to clear <code>app.jinja_env.cache</code> if present. Called on cache-busting param or <code>FLUSH_TEMPLATES_ON_RENDER</code>. Implementation is safe-no-throw. Suggestion: also call <code>app.jinja_env.cache.clear()</code> only when attribute exists to avoid errors (already implemented). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Index and manifest routes</strong><br><br><code>/</code> serves <code>templates/index.html</code> with fallback to <code>assets/index.html</code>. <code>/manifest.json</code> looks in <code>static_folder/assets</code> then project root. If missing returns 404 and logs debug message. This supports PWAs and static-first deployments. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Asset serving fallbacks</strong><br><br><code>/assets/&lt;path:filename&gt;</code> uses <code>send_from_directory(app.static_folder, filename)</code>. On failure it logs debug and returns 404. Ensure <code>app.static_folder</code> is correct relative to deployment packaging. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Render pipeline <code>_render_text_with_fallbacks</code></strong><br><br>High-level flow:<br>1. Apply <code>_strip_ref_footnotes</code>.<br>2. Apply <code>_escape_leading_list_markers_in_table_cells</code> to avoid accidental list conversions inside pipe tables.<br>3. Prefer <code>render_from_text(text, {&quot;inline_assets&quot;: False})</code> if callable and accept multiple return forms.<br>4. Iterate candidate functions across multiple modules and call them with friendly parameter signatures, catching exceptions per-candidate.<br>5. On complete failure return <code>&lt;pre&gt;escaped text&lt;/pre&gt;</code> with <code>meta={&quot;converted&quot;: False, &quot;error&quot;: &quot;render_failed&quot;}</code>.<br><br>Design goal: robustly accept many renderer shapes and degrade gracefully. </td></tr><tr><td data-label="Technical Breakdown"> <strong>/convert endpoint behavior</strong><br><br><code>/convert</code> accepts JSON or form data. Steps:<br><br>• Extract text from JSON <code>text|markdown|input</code> or form/request values.<br>• Reject empty input with 400.<br>• Enforce <code>MAX_PASTE_SIZE</code> on string length and return 413 if exceeded.<br>• Optionally flush Jinja template cache on query param <code>v</code> or <code>FLUSH_TEMPLATES_ON_RENDER</code>.<br>• Call <code>_render_text_with_fallbacks</code> and coerce output to string.<br>• Post-render guard: if no <code>&lt;table</code> detected, replace <code>html_out</code> with an accessible <code>.render-error</code> block and set <code>meta[&quot;render_warning&quot;]=&quot;no_table_detected&quot;</code>. This ensures downstream clients get a predictable structure.<br><br>Return: JSON with <code>ok: true</code>, <code>html</code>, and <code>meta</code> on success. </td></tr><tr><td data-label="Technical Breakdown"> <strong>/save endpoint behavior</strong><br><br><code>/save</code> accepts <code>html</code> and optional <code>filename</code> via JSON or form. Steps:<br><br>• Validate non-empty <code>html</code> payload.<br>• Ensure storage directory exists.<br>• Try <code>save_html_atomic</code> helper if callable; otherwise fallback to an atomic tempfile + <code>os.replace</code> write with mode <code>0o644</code> best-effort.<br>• Return <code>{&quot;ok&quot;:true,&quot;path&quot;:path,&quot;id&quot;:file_id}</code>. On failures return <code>500</code> with <code>save_failed</code> error.<br><br>Atomic write ensures partial uploads do not leave corrupt files. Note: <code>save_html_atomic</code> signature must match expectation; provide a wrapper if helper uses different param names. </td></tr><tr><td data-label="Technical Breakdown"> <strong>/saved/<file_id> retrieval & path safety</strong><br><br><code>get_saved(file_id)</code> resolves path via <code>read_saved</code> helper or by assuming <code>file_id</code> is a filename under <code>STORAGE_PATH</code>. It ensures path is within storage by comparing <code>os.path.commonpath([storage_abs, path_abs])</code> and returns 404 if outside. Uses <code>send_from_directory</code> with <code>as_attachment=True</code>. This prevents directory traversal. Edge: <code>commonpath</code> throws on different drives on Windows; code catches exceptions and aborts. </td></tr><tr><td data-label="Technical Breakdown"> <strong>API compatibility aliases</strong><br><br>Registers legacy endpoints <code>/api/convert</code>, <code>/api/render</code>, and <code>/api/health</code> delegating to new handlers to preserve external integrations. This is non-breaking and helps transitions. </td></tr><tr><td data-label="Technical Breakdown"> <strong>After-request minimal security headers</strong><br><br><code>_set_minimal_security_headers</code> sets <code>X-Content-Type-Options</code>, <code>X-Frame-Options</code>, <code>Referrer-Policy</code>, <code>Permissions-Policy</code> via <code>response.headers.setdefault</code> to avoid overwriting upstream values. This is non-invasive and improves baseline security posture. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling and observability</strong><br><br>All endpoints wrap critical sections in try/except and log exceptions with <code>logger.exception</code>. Conversion fallback returns escaped preformatted text rather than a 5xx unless rendering itself fails catastrophically. This favors graceful degradation for clients. Logs include startup feature summary to aid ops discovery. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Preprocessor correctness & tradeoffs</strong><br><br>Preprocessor encoded digits/markers at cell starts to prevent markdown list conversion. Tradeoffs:<br>• Pros: preserves visual fidelity and prevents unintentional lists inside cells.<br>• Cons: downstream programs expecting raw numeric strings may need to decode HTML entities prior to data extraction. Document this behavior for API consumers. Consider adding an explicit option to disable this preprocessor. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Input size enforcement details & limitations</strong><br><br>Uses <code>request.content_length</code> and string-length checks. Limitations:<br>• <code>content_length</code> may be missing for chunked requests. <code>len(text)</code> checks cover JSON/form payloads but require reading body which may increase memory usage. Current enforcement balances safety and simplicity. For stronger enforcement add streaming-parsing or enforce <code>Content-Length</code> header presence at proxy level. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security & injection concerns</strong><br><br>Server carefully escapes raw fallback outputs via <code>html.escape</code>. However when renderers return HTML fragments they are passed through to responses. Recommend:<br><br>• Treat incoming content as untrusted and avoid reflecting raw user HTML in other users' contexts.<br>• When serving saved HTML, ensure access control if content may contain sensitive info.<br>• If clients will re-insert <code>data-ptt-json</code> into DOM, pair with client-side sanitization (DOMPurify) before <code>innerHTML</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Concurrency, scaling & deployment notes</strong><br><br>This server is a development-grade Flask app but is written to be deployed under WSGI servers. For production:<br><br>• Run behind a WSGI host (gunicorn/uvicorn with workers).<br>• Use reverse proxy to enforce request size limits at nginx/traefik level as <code>content_length</code> checks are advisory.<br>• For heavy batch saving or large tables, offload rendering to background workers to avoid request timeouts. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing checklist</strong><br><br>Suggested tests:<br>1. <code>_escape_leading_list_markers_in_table_cells()</code>:<br> &nbsp;&nbsp;1.1 Pipe-table line <code>&#x27;| 1. item |&#x27;</code> → <code>&#x27;| &amp;#49;. item |&#x27;</code> equivalently displayed.<br> &nbsp;&nbsp;1.2 Mixed blocks: ensure lines without <code>|</code> remain unchanged.<br>2. <code>_strip_ref_footnotes()</code> removes `<code>, </code>[Name][1]<code>, and </code>[1]<code> patterns.&lt;br&gt;3. </code>/convert<code> with: empty payload → 400; oversized payload → 413; valid table text → 200 with </code>html<code> containing </code><table<code> or </code>render_warning<code> fallback.&lt;br&gt;4. </code>/save<code> atomic write: simulate helper missing and ensure file exists and has </code>0o644<code> permission when possible.&lt;br&gt;5. </code>get_saved<code> path traversal attempt </code>../../etc/passwd` → 404. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance and resource considerations</strong><br><br>Key costs:<br>• Renderer execution (potentially <code>pandas</code> heavy) per request.<br>• <code>_escape_leading_list_markers_in_table_cells()</code> is linear in input size; low overhead compared to rendering.<br>• Saving large HTML writes uses disk I/O and temporary file descriptors. Recommendations:<br>1. Set realistic <code>MAX_PASTE_SIZE</code> based on memory constraints.<br>2. Use streaming or worker queues for processing documents > 1MB.<br>3. Reuse process-level renderer instances where possible to amortize import costs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational observability & metrics</strong><br><br>Add counters and histograms for:<br>• <code>requests.convert.count</code> and <code>requests.save.count</code><br>• <code>render.duration.ms</code> histogram<br>• <code>saved.files.written</code> and <code>saved.write.duration.ms</code><br>• <code>render.fallbacks.used</code> (when renderers missing or errors)<br><br>Emit logs at INFO for normal operations and DEBUG for stack traces. Avoid logging full HTML bodies. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Suggested incremental improvements</strong><br><br>1. Make <code>_escape_leading_list_markers_in_table_cells</code> opt-in via config flag <code>ESCAPE_LEADING_LIST_MARKERS</code> default true; expose to <code>create_app(cfg)</code>. <br>2. If <code>content_length</code> is <code>None</code> and <code>Transfer-Encoding: chunked</code> present, consider reading up to <code>MAX_PASTE_SIZE + 1</code> bytes and abort early to enforce limit. <br>3. Add a small middleware to reject requests without <code>Content-Length</code> when uploading large payloads behind a trust boundary. <br>4. Add unit tests for all helpers and endpoint error paths. <br>5. Expose <code>SAVE_HTML_PERMISSIONS</code> config to control file mode. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Backward compatibility & API contract</strong><br><br>Maintains legacy endpoints and integrates optional helpers when available. <code>convert</code> returns a stable JSON schema <code>{&quot;ok&quot;: bool, &quot;status&quot;: &quot;ok&quot;, &quot;html&quot;: str, &quot;meta&quot;: dict}</code>. Consumers should rely on <code>meta.render_warning</code> for special cases. When changing behavior, bump API version or document additions to <code>meta</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Failure modes & recommended mitigations</strong><br><br>• Missing renderer module → graceful fallback to escaped <code>&lt;pre&gt;</code>; surface <code>meta.error</code> for diagnostics.<br>• Disk write failures on save → return 500 and log; mitigation: ensure storage_path permissions and disk availability are monitored.<br>• Rate-limiter misconfiguration → fallback to no-limiter and emit warning; mitigation: start with permissive <code>RATE_LIMIT</code> and tighten as needed after measuring traffic. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security hardening checklist</strong><br><br>1. Ensure forwarded headers (X-Forwarded-For) are validated by proxy. <br>2. Limit <code>/save</code> endpoint access or require tokens if saving user content exposes the server to storage abuse. <br>3. Monitor stored files for PII or secrets and implement retention policies. <br>4. Ensure saved HTML files are served with <code>Content-Security-Policy</code> or from separate storage domain to avoid DOM interactions across origin. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Documentation & onboarding notes</strong><br><br>Document these items in README:<br>• Expected config keys and defaults.<br>• Behavior of <code>escape_leading_list_markers</code> and how to disable it.<br>• How to plug optional <code>render_from_text</code> and I/O helpers and expected function signatures. <br>• Example <code>curl</code> requests for <code>/convert</code>, <code>/save</code>, and <code>/saved/&lt;id&gt;</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Next-step roadmap (prioritized)</strong><br><br>Short-term:<br> &nbsp;&nbsp;1. Add unit tests for preprocessors and endpoints.<br> &nbsp;&nbsp;2. Make leading-list escape configurable.<br><br>Mid-term:<br> &nbsp;&nbsp;1. Add streaming enforcement for chunked uploads.<br> &nbsp;&nbsp;2. Add metrics instrumentation and health dashboards.<br><br>Long-term:<br> &nbsp;&nbsp;1. Migrate HTML processing to an HTML parser when available; keep regex fallback.<br> &nbsp;&nbsp;2. Offload heavy rendering to worker pool and return job tokens to clients. </td></tr></tbody></table></div><div class="row-count">Rows: 33</div></div><div class="table-caption" id="Table4" data-table="Book_8052_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4 — utils.py</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>File-level summary</strong><br><br>Utility module combining environment, logging, filesystem, and lightweight markdown/table helpers. Designed for compatibility between PasteToTable and Table Viewer. Functions are small, well-documented, and defensive. Priorities: reliability, low external dependency footprint, safe defaults, and predictable behavior across platforms. Good candidate for unit tests and static typing incrementally. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Design principles & compatibility goals</strong><br><br>1. Backwards-compatible names preserved for other modules. <br>2. Localized imports to avoid heavy dependency failures at import time. <br>3. Idempotent helpers (e.g., <code>ensure_dir</code>, <code>make_logger</code>). <br>4. Defensive error handling: log debug details and return safe defaults rather than raising in most helpers. <br><br>These choices favor resilience in varied runtime environments (CI, containers, developer machines). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Module-level logging & formatting</strong><br><br>Constants <code>_DEFAULT_LOG_FMT</code> and <code>_DEFAULT_LOG_DATEFMT</code> provide consistent formatting. <code>_logger = logging.getLogger(&quot;utils&quot;)</code> is defined but functions create or use root logger safely. <code>init_logger(force=True)</code> clears handlers to ensure deterministic root logger state for CLI tools. Consider switching to structured logging (JSON) in high-volume deployments. </td></tr><tr><td data-label="Technical Breakdown"> <strong>load_env(env_path, override) — behavior & edge cases</strong><br><br>Purpose: parse <code>.env</code>-style files into a dict merged onto <code>os.environ</code> snapshot. Key behaviors:<br>1. Reads file if exists; ignores comment lines and lines without <code>=</code>.<br>2. Splits at first <code>=</code> only; trims quotes around right-hand value.<br>3. If <code>override</code> True, file values replace current env; otherwise existing env entries prevail.<br><br>Edge cases:<br>• Lines with multiple <code>=</code> preserve RHS after first <code>=</code>. <br>• No variable expansion (<code>${VAR}</code>) performed. <br>• Non-UTF-8 files may be skipped silently (logged at debug).<br><br>Improvements: support <code>export KEY=val</code> prefix, variable expansion, and <code>.env.local</code> layering. Expose strict mode to fail on malformed lines for CI. </td></tr><tr><td data-label="Technical Breakdown"> <strong>init_logger & make_logger — contract & idempotence</strong><br><br><code>init_logger(level, fmt, datefmt, force)</code> configures root logger and returns it. <code>make_logger(name, level)</code> creates a named logger with a StreamHandler only if none exists. Both avoid duplicate handlers. <br><br>Notes:<br>• <code>init_logger(force=True)</code> resets handlers for deterministic CLI runs. <br>• <code>make_logger</code> does not set <code>propagate=False</code>, so messages propagate to root; desired for unified logging. <br><br>Improvements: optional <code>propagate</code> control, optional file handler, and optional JSON formatter parameter. </td></tr><tr><td data-label="Technical Breakdown"> <strong>ensure_dir(path, mode) — semantics & platform details</strong><br><br>Ensures directory exists and attempts <code>chmod(mode)</code> ignoring failures. Returns resolved path string. <br><br>Considerations:<br>• On Windows <code>chmod</code> semantics are limited; silent ignore is acceptable. <br>• Returns <code>resolve()</code> which follows symlinks; if caller expects exact path (no symlink resolution) use <code>absolute()</code> alternative. <br><br>Potential additions: <code>exist_ok</code> flag, <code>owner</code>/<code>group</code> support, and robust error on permission denied for critical operations. </td></tr><tr><td data-label="Technical Breakdown"> <strong>safe_join(base, *paths) — path traversal prevention</strong><br><br>Resolves <code>base.joinpath(*paths)</code> then compares <code>os.path.commonpath</code> to base. If not within base raises <code>ValueError</code>. Fallback string-prefix check handles platforms where <code>commonpath</code> may behave unexpectedly. <br><br>Edge cases:<br>• On Windows with differing drive letters <code>commonpath</code> raises; code falls into fallback that may still fail — tests included. <br>• Caller must pass absolute or relative base consistently. <br><br>Security suggestion: canonicalize <code>base</code> with <code>resolve(strict=False)</code> before use and consider normalizing <code>os.path.normcase</code> for case-insensitive filesystems. </td></tr><tr><td data-label="Technical Breakdown"> <strong>safe_remove(path) — idempotent file deletion</strong><br><br>Removes file if exists; returns True on success or if file absent; returns False and logs debug on failure. Best for cleanup flows where missing files are normal. <br><br>Edge: does not remove directories. For directory removal provide <code>safe_rmtree</code> with <code>ignore_errors=True</code> pattern. </td></tr><tr><td data-label="Technical Breakdown"> <strong>atomic_write(path, data, mode, encoding) — atomicity model</strong><br><br>Writes to NamedTemporaryFile in the same directory then <code>os.replace</code> to atomically move into final location. Supports text and binary modes. Ensures flush and attempts <code>os.fsync</code> when possible. Guarantees that either a fully-written file appears or the previous file remains. <br><br>Important notes:<br>• Uses <code>delete=False</code> then <code>os.replace</code>; ensures temporary cleanup in <code>finally</code> block. <br>• Ensures target parent dir exists via <code>mkdir(parents=True, exist_ok=True)</code>. <br>• Uses <code>os.fsync</code> best-effort but may not guarantee durability on network filesystems. <br><br>Improvements: expose <code>fsync_dir=True</code> to <code>fsync</code> parent dir for additional durability; add retry logic for transient <code>os.replace</code> errors on NFS. </td></tr><tr><td data-label="Technical Breakdown"> <strong>atomic_write_bytes wrapper</strong><br><br>Simple convenience wrapper calling <code>atomic_write(..., mode=&#x27;wb&#x27;)</code>. Keeps API tidy. Consider deprecating redundant wrappers if not widely used. </td></tr><tr><td data-label="Technical Breakdown"> <strong>try_int(v, default) — robust casting</strong><br><br>Small helper to convert to int returning <code>default</code> on failure. Useful when parsing environment variables. Consider <code>try_float</code> or <code>coerce_bool</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>checksum_file(path, algo, chunk_size) — streaming digest</strong><br><br>Computes file digest using <code>hashlib.new(algo)</code> and streaming reads. Returns <code>None</code> if algorithm unsupported or read fails. Good for content integrity checks and cache keys. <br><br>Improvements: expose <code>progress_callback</code> for large files; support file-like objects in addition to path. </td></tr><tr><td data-label="Technical Breakdown"> <strong>validate_env_keys(env, required, raise_on_missing) — contract</strong><br><br>Checks required keys exist and warns via logger if missing. If <code>raise_on_missing</code> raises <code>ValueError</code>. Returns list of missing keys. Use in startup checks to fail fast when critical configuration absent. Note: uses truthiness <code>if not env.get(k)</code> so empty-string value is considered missing — document this. </td></tr><tr><td data-label="Technical Breakdown"> <strong>normalize_whitespace(text)</strong><br><br>Collapses sequences of whitespace (spaces, tabs, newlines) into single spaces and strips ends. Useful for canonicalizing labels, slugs, and comparing text. Deterministic and cheap. </td></tr><tr><td data-label="Technical Breakdown"> <strong>is_table_separator(line)</strong><br><br>Uses <code>split_table_row</code> and <code>re.fullmatch(r&#x27;:?-{1,}\:?&#x27;, p.strip())</code> per cell to detect table separator lines. Conservative detection avoids false positives. Example matches: <code>| --- | :---: |</code>, <code>---|---:</code>. Avoids lines without <code>-</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>parse_table(lines) — returns 2D array</strong><br><br>Filters out blank lines and separator lines then returns parsed rows via <code>split_table_row</code>. Preserves underscores and inline text. Useful for small markdown table-to-array transformations. Not intended to produce DataFrames; use <code>parse_markdown_tables</code> for DataFrame-level parsing. </td></tr><tr><td data-label="Technical Breakdown"> <strong>is_list_item & extract_list</strong><br><br><code>is_list_item</code> uses <code>re.match(r&#x27;^\s*(?:[-*+]|\d+\.)\s+&#x27;, line)</code> to detect ordered/unordered list items. <code>extract_list</code> runs across multiple lines returning normalized items. These are simple and suitable for quick text ingestion. Consider locale-aware list markers in future if needed. </td></tr><tr><td data-label="Technical Breakdown"> <strong>safe_slug(name) — slug rules and rationale</strong><br><br>Converts to lowercase, preserves underscores, replaces non-alnum/underscore with <code>-</code>, trims leading/trailing <code>-</code>. Uses <code>normalize_whitespace</code> first. Deterministic and safe for HTML <code>id</code> attributes. Collisions are possible; callers should deduplicate if necessary. </td></tr><tr><td data-label="Technical Breakdown"> <strong>chunk_lines(lines, marker)</strong><br><br>Splits a sequence of lines into chunks separated by lines containing <code>marker</code>. Useful for splitting on fence markers or section delimiters. Edge: marker substring matching not anchored; choose marker carefully. </td></tr><tr><td data-label="Technical Breakdown"> <strong>strip_comments(line, comment_markers=None)</strong><br><br>Removes inline comments represented by <code>#</code> or <code>//</code> by default. Safety rules avoid cutting URL schemes containing <code>://</code> before the comment marker. Returns the trimmed pre-comment portion. Behavior is conservative to avoid breaking URLs and anchor fragments. Improvements: support quoted contexts where comment markers inside quotes are ignored. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Exports & backward compatibility</strong><br><br><code>__all__</code> enumerates expected public API for other modules. This list preserves names used elsewhere in the project. If adding functions extend <code>__all__</code> to maintain discoverability. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Test matrix & recommended unit tests</strong><br><br>Core tests to add:<br>1. <code>load_env</code>:<br> &nbsp;&nbsp;1.1 Parse normal key=val lines.<br> &nbsp;&nbsp;1.2 Handle <code>export KEY=val</code> optional syntax. <br> &nbsp;&nbsp;1.3 Verify <code>override</code> behavior. <br>2. <code>init_logger</code> / <code>make_logger</code>:<br> &nbsp;&nbsp;2.1 Idempotence on repeated calls. <br>3. <code>ensure_dir</code> permissions and returns resolved path. <br>4. <code>safe_join</code>:<br> &nbsp;&nbsp;4.1 Valid join within base. <br> &nbsp;&nbsp;4.2 Attempted traversal raises <code>ValueError</code>. <br>5. <code>atomic_write</code>:<br> &nbsp;&nbsp;5.1 Race conditions with preexisting target. <br> &nbsp;&nbsp;5.2 Binary and text modes write correct content and replace atomically. <br>6. <code>split_table_row</code>:<br> &nbsp;&nbsp;6.1 Escaped pipes <code>\|</code> preserved. <br> &nbsp;&nbsp;6.2 Backtick-contained pipes not split. <br>7. <code>is_table_separator</code> detection cases. <br>8. <code>checksum_file</code> correctness for small known file. <br>9. <code>strip_comments</code> with URLs and anchors. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance notes & complexity</strong><br><br>• Most helpers are O(n) in input size. <br>• <code>atomic_write</code> and <code>checksum_file</code> stream data to disk and should be used with chunking for large files. <br>• <code>split_table_row</code> is linear per row and suitable for moderate-size rows; for extremely long single-line content consider fast-path splitting if no backticks or escapes present. <br><br>Scaling guidance:<br>• For massive batch jobs, avoid buffering whole files in memory; use streaming and process line-by-line. <br>• Reuse logger instances to avoid creating handlers repeatedly. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security considerations</strong><br><br>• <code>safe_join</code> defends filesystem access; use before serving files or saving user-provided filenames. <br>• <code>atomic_write</code> reduces risk of partial writes being served. <br>• <code>strip_comments</code> avoids accidental leakage in logs by trimming extraneous data before logging. <br><br>Recommendations:<br>• Avoid logging raw user-submitted HTML or table content at INFO level. <br>• Validate filenames passed to writing functions and use <code>safe_slug</code> / <code>secure_filename</code> when exposing file names in URLs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>API usability & ergonomics suggestions</strong><br><br>1. Add <code>read_env</code> that returns merged config with typed conversions (int/bool). <br>2. Provide <code>atomic_write_json(path, obj)</code> convenience with indentation and atomic write. <br>3. Offer optional <code>logger_name</code> parameter on functions that perform significant IO to attach contextual logs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Refactor ideas & long-term roadmap</strong><br><br>Short-term:<br> &nbsp;&nbsp;1. Add type annotations to all functions for better IDE/typing support.<br> &nbsp;&nbsp;2. Add unit tests and CI integration. <br>Medium-term:<br> &nbsp;&nbsp;1. Add optional external dependency for robust <code>.env</code> parsing (python-dotenv) behind a feature flag. <br> &nbsp;&nbsp;2. Provide async-friendly IO helpers for future async server support. <br>Long-term:<br> &nbsp;&nbsp;1. Create a small <code>utils</code> package with stable exported API and versioning. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Integration & migration notes</strong><br><br>Keep API stable. When introducing breaking changes prefer adding new helper names and deprecating old ones. Consumers should rely on <code>__all__</code> as the public contract. Before removing or renaming functions run a project-wide usage scan. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational checks and health indicators</strong><br><br>Add small health checks in services using <code>utils</code>: verify <code>ensure_dir(storage_path)</code> returns an existing path and <code>checksum_file</code> returns expected digest for a small sentinel file. Log warnings when atomic writes fail. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Diagnostics helpers to add</strong><br><br>1. <code>ls_dir_summary(path)</code> returning file counts and total size for quick operator inspection. <br>2. <code>tail_file(path, n=100)</code> for debugging large logs safely. <br>3. <code>env_diff(reference_env)</code> to compare effective env to desired config. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Summary — prioritized small changes</strong><br><br>1. Add type hints and mypy CI check. <br>2. Add unit tests for parsing helpers. <br>3. Expose optional <code>fsync_dir</code> in <code>atomic_write</code> for higher durability. <br>4. Document <code>load_env</code> behavior about override and quoting. <br><br>These will raise confidence and reduce field surprises. </td></tr></tbody></table></div><div class="row-count">Rows: 30</div></div><div class="table-caption" id="Table5" data-table="Book_8052_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5 — assets.py</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>File-level purpose</strong>  <br><br> Provide minimal asset copying and a function to emit <code>overrides.css</code> into an <code>output_dir/assets</code> folder.  <br><br> Assumes repository layout where <code>assets/</code> sits one level above this module. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Constants: _EMBED_STYLE / _EMBED_SCRIPT</strong>  <br><br> <strong>Role:</strong> Embedded fallbacks used when project asset files are missing or unreadable.  <br><br> <strong>Properties:</strong> Small, safe defaults.  <br><br> <strong>Risk:</strong> Hardcoded CSS/JS may diverge from real assets. Keep minimal and prefer canonical files where possible. </td></tr><tr><td data-label="Technical Breakdown"> <strong>copy_assets — purpose</strong>  <br><br> Copy <code>style.css</code> and <code>script.js</code> from project <code>assets/</code> into <code>output_dir/assets</code>. Write fallback content when source missing or on error. </td></tr><tr><td data-label="Technical Breakdown"> <strong>copy_assets — path resolution & assumptions</strong>  <br><br> 1. <code>project_assets_dir</code> computed as <code>os.path.join(os.path.dirname(__file__), &quot;..&quot;, &quot;assets&quot;)</code> then <code>normpath</code>.  <br> 2. Assumes <code>__file__</code> exists and relative layout is stable.  <br> 3. Not resilient to packaging (zipapp, PyInstaller) where <code>__file__</code> or file layout differs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>copy_assets — behavior (stepwise)</strong>  <br><br> 1. Ensure <code>output_dir/assets</code> exists (<code>os.makedirs(..., exist_ok=True)</code>).  <br> 2. If <code>project_assets_dir</code> is a directory: iterate <code>(&quot;style.css&quot;,&quot;script.js&quot;)</code>.  <br> 3. For each file: if <code>src</code> exists, <code>shutil.copy2(src,dst)</code> else write fallback content.  <br> 4. On any exception during copy, write fallback content to <code>dst</code>.  <br><br> <strong>Notes:</strong> Exception handling swallows errors and substitutes fallback silently. </td></tr><tr><td data-label="Technical Breakdown"> <strong>copy_assets — edge cases & failure modes</strong>  <br><br> 1. <strong>Permissions:</strong> <code>os.makedirs</code> or file writes may fail due to permissions; exceptions are not surfaced.  <br> 2. <strong>Partial writes:</strong> <code>shutil.copy2</code> can leave partial files on failure.  <br> 3. <strong>Filename mismatch:</strong> Project uses <code>script.core.js</code> etc. but function expects <code>script.js</code>. This can cause fallback writes even when correct assets exist.  <br> 4. <strong>Race conditions:</strong> Concurrent processes writing same <code>out_assets</code> may collide.  <br> 5. <strong>Symlinks / mount issues:</strong> Copy semantics copy targets; symlink handling not explicit.  <br> 6. <strong>Packaging / frozen apps:</strong> <code>project_assets_dir</code> may not be a real dir; function falls back to creating fallback assets but without logging. </td></tr><tr><td data-label="Technical Breakdown"> <strong>copy_assets — security & correctness notes</strong>  <br><br> 1. No path traversal risk because source path computed from module path.  <br> 2. Not validating file contents or size.  <br> 3. Writes use system default encoding only for fallback; <code>shutil.copy2</code> preserves metadata which may be undesired. </td></tr><tr><td data-label="Technical Breakdown"> <strong>copy_assets — actionable improvements</strong>  <br><br> 1. Use <code>importlib.resources</code> / <code>pkgutil</code> for packaged data to support installations and zip imports.  <br> 2. Replace silent <code>except</code> with logging at WARN level and optional <code>raise</code> in a debug mode.  <br> 3. Use atomic write: write to a temp file and <code>os.replace()</code> to avoid partial files.  <br> 4. Make asset filenames configurable and align with project <code>assets/</code> (e.g., <code>script.core.js</code>, <code>script.table.js</code>).  <br> 5. On copy failure, preserve original exception in logs to aid debugging.  <br> 6. Consider checksum or mtime checks to avoid unnecessary copies. </td></tr><tr><td data-label="Technical Breakdown"> <strong>write_overrides_css — purpose</strong>  <br><br> Generate <code>overrides.css</code> with theme variables, sticky-first-column styling, list marker normalization, and proportional column widths based on <code>left_width</code> / <code>right_width</code>. Write the CSS into <code>output_dir/assets/overrides.css</code> and return the CSS string. </td></tr><tr><td data-label="Technical Breakdown"> <strong>write_overrides_css — inputs & validation concerns</strong>  <br><br> 1. <code>left_width</code> and <code>right_width</code> are floats formatted into CSS as percentages using <code>{left_width:.2f}%</code>.  <br> 2. No validation or clamping is performed.  <br><br> <strong>Risk:</strong> Malicious or malformed inputs (NaN, inf, negative, >100, locale-specific floats) can produce invalid CSS or injection. </td></tr><tr><td data-label="Technical Breakdown"> <strong>write_overrides_css — behavior (stepwise)</strong>  <br><br> 1. Ensure <code>assets_dir</code> exists.  <br> 2. Build <code>overrides_css</code> with an f-string embedding widths.  <br> 3. Attempt to write to <code>assets_dir/overrides.css</code>.  <br> 4. Ignore any exception during write (pass).  <br> 5. Return <code>overrides_css</code> regardless of write success. </td></tr><tr><td data-label="Technical Breakdown"> <strong>write_overrides_css — CSS content notes</strong>  <br><br> 1. Covers light and dark theme variables and sticky-first-column semantics.  <br> 2. Uses <code>!important</code> in several places to override other styles: effective but potentially brittle.  <br> 3. Provides list-style normalization inside table cells.  <br> 4. Uses explicit z-index and box-shadow for sticky column.  <br><br> <strong>Observation:</strong> Good pragmatic CSS for table rendering. Consider smaller rule set to reduce specificity wars. </td></tr><tr><td data-label="Technical Breakdown"> <strong>write_overrides_css — error handling & UX</strong>  <br><br> 1. Write errors are suppressed silently.  <br> 2. Caller receives CSS string and cannot know whether the file was persisted.  <br><br> <strong>Recommendation:</strong> Return a <code>(css_str, wrote_successfully: bool)</code> tuple or raise/log on failure. </td></tr><tr><td data-label="Technical Breakdown"> <strong>write_overrides_css — actionable improvements</strong>  <br><br> 1. Sanitize and clamp width args: <code>left = float(left_width); left = max(0.0, min(100.0, left))</code> and similar for right.  <br> 2. Validate that <code>left + right</code> equals 100 or adopt a proportional calculation with a <code>total_units</code> parameter.  <br> 3. Use <code>locale</code>-independent formatting: <code>format(left, &#x27;.2f&#x27;)</code> already safe; ensure callers pass numeric.  <br> 4. Use atomic write pattern.  <br> 5. Expose a debug logging path for write failures.  <br> 6. Consider emitting source map comment with generation metadata (timestamp, generator version) for traceability. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing & QA recommendations</strong>  <br><br> 1. Unit tests:  <br>  • Test asset copy when source assets present.  <br>  • Test fallback creation when source absent.  <br>  • Test behavior in read-only output dir (expect graceful error handling or logged failure).  <br> 2. Integration: verify CSS file persists and is loadable by headless browser.  <br> 3. Packaging: test under <code>pip install .</code> and when bundled with PyInstaller or zipapp. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance & deployment notes</strong>  <br><br> 1. Small IO footprint.  <br> 2. Atomic rename recommended to avoid partial files in concurrent deploys.  <br> 3. If many processes call these functions during startup, add idempotent guards or per-process temp directories. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security & supply-chain considerations</strong>  <br><br> 1. Avoid copying arbitrary external files. Current code is safe because it uses repo-local <code>assets/</code>.  <br> 2. If you later allow user-supplied asset paths, validate and sandbox.  <br> 3. Consider signing or checksumming canonical assets in release builds. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Minimal example fixes (high-leverage)</strong>  <br><br> 1. Replace <code>os.path.join(os.path.dirname(__file__), &quot;..&quot;, &quot;assets&quot;)</code> with <code>importlib.resources</code> access for packaged assets.  <br> 2. Use an <code>atomic_write(path, data)</code> helper that writes to <code>path + &quot;.tmp&quot;</code> then <code>os.replace</code>.  <br> 3. Add simple logging: <code>logger.warning(...)</code> inside exception handlers.  <br><br> These three changes dramatically improve reliability and diagnosability. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Summary recommendation</strong>  <br><br> Keep the current functions as lightweight fallbacks. Add three improvements before production: validate numeric inputs for CSS, adopt atomic writes, and surface write/copy failures via logging or return flags. These adjustments preserve current behavior while making failures observable and files robustly written. </td></tr></tbody></table></div><div class="row-count">Rows: 19</div></div><div class="table-caption" id="Table6" data-table="Book_8052_06" style="margin-top:2mm;margin-left:3mm;"><strong>Table 6 — cli.py</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Shebang & module doc</strong><br><code>#!/usr/bin/env python3</code> ensures cross-platform Python 3 execution. Docstring is minimal and informative.                                                                                                                                                                                           </td></tr><tr><td data-label="Technical Breakdown"> <strong>Imports</strong><br>Uses <code>argparse</code>, <code>sys</code>, <code>Path</code>. Internal import with fallback: <code>from render.core_compat import render_html</code> → fallback <code>from render import render_html</code>. Defensive pattern avoids ImportError in mixed environments.                                                                                             </td></tr><tr><td data-label="Technical Breakdown"> <strong>RenderConfig import</strong><br>Multi-level attempt: first <code>render.types.RenderConfig</code>, then <code>render.RenderConfig</code>, finally <code>None</code>. Safely ensures <code>RenderConfig</code> variable always exists.                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>parse_args(argv)</strong><br>Standard argparse CLI: <code>&lt;source&gt;</code> positional, <code>-o/--output</code>, <code>--embed-assets</code>. Returns <code>Namespace</code>. Clean separation of CLI parsing.                                                                                                                                                                    </td></tr><tr><td data-label="Technical Breakdown"> <strong>_make_config(output_path, embed_assets)</strong><br>Builds a <code>RenderConfig</code> instance. Tries multiple likely constructor signatures: <code>output_dir</code>, <code>output_path</code>, <code>output</code>, or no-arg fallback. Defensive against signature changes. Returns <code>None</code> if unavailable.                                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>main(argv=None)</strong><br>Core CLI flow:<br>1. Parse args.<br>2. Convert <code>source</code> and <code>output</code> to <code>Path</code>.<br>3. Create <code>RenderConfig</code> via <code>_make_config</code>.<br>4. Call <code>render_html</code> preferring <code>config</code> keyword.<br>5. Fallback to alternate signatures if <code>TypeError</code> occurs.<br>Ensures CLI works even if module versions differ. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Signature handling</strong><br>Tries:<br>• <code>render_html(str(src), config=cfg)</code><br>• <code>render_html(str(src), str(out), config=cfg)</code><br>• <code>render_html(str(src), str(out))</code><br>• <code>render_html(str(src))</code><br>Provides broad compatibility across versions.                                                                               </td></tr><tr><td data-label="Technical Breakdown"> <strong>Path conversion</strong><br>Always converts <code>Path</code> to <code>str</code> when calling <code>render_html</code>. Avoids potential type issues with older APIs.                                                                                                                                                                                                </td></tr><tr><td data-label="Technical Breakdown"> <strong>CLI exit</strong><br>Uses <code>raise SystemExit(main())</code> to propagate return codes correctly.                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling philosophy</strong><br>Minimal try/except around ImportError and TypeError. Fails gracefully with fallback rather than raising unhandled exceptions.                                                                                                                                                                  </td></tr><tr><td data-label="Technical Breakdown"> <strong>Extensibility notes</strong><br>- Can add <code>--verbose</code> or logging flags for detailed runtime info.<br>- <code>_make_config</code> can be extended for future parameters without changing main flow.<br>- <code>main</code> design allows programmatic import and function call in other scripts.                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>Potential improvements</strong><br>1. Add type hints to <code>parse_args</code> and <code>main</code>. <br>2. Validate that <code>src.exists()</code> before calling <code>render_html</code>. <br>3. Optional dry-run or preview mode. <br>4. Document which <code>RenderConfig</code> versions are supported.                                                                             </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security & safety</strong><br>Input/output paths not sanitized beyond <code>Path</code> conversion; rely on <code>render_html</code> to handle safely. Embedding assets flag is boolean, low risk.                                                                                                                                                         </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing & robustness</strong><br>Unit tests can mock <code>render_html</code> to ensure multiple signatures are handled. CLI integration tests should verify fallback paths and <code>RenderConfig</code> combinations.                                                                                                                                    </td></tr><tr><td data-label="Technical Breakdown"> <strong>Summary</strong><br>Minimal, highly robust CLI wrapper for tables rendering. Designed for backward compatibility and graceful fallback. Structured to work with multiple versions of <code>render_html</code> and <code>RenderConfig</code>. Clean separation between argument parsing, configuration, and execution.                                      </td></tr></tbody></table></div><div class="row-count">Rows: 15</div></div><div class="table-caption" id="Table7" data-table="Book_8052_07" style="margin-top:2mm;margin-left:3mm;"><strong>Table 7 — convert.py</strong></div>
<div class="table-wrapper" data-table-id="table-7"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>File purpose & summary</strong>  <br><br> <strong>Purpose:</strong> Production-ready <code>convert.py</code> for PasteToTable. Handles robust Markdown pipe-table parsing, CSV parsing, minimal Markdown rendering, HTML-safe transformations, table rendering with alignment and widths, and conversion APIs: <code>parse_markdown_tables</code>, <code>parse_csv_tables</code>, <code>render_table</code>, <code>extract_tables_debug</code>, <code>convert_structure</code>, <code>convert_text_to_html</code>.  <br><br> <strong>Scope:</strong> Reader-friendly, defensive code with fallbacks when project utilities or third-party libs (pandas, markdown) are absent. Designed for embedding in tooling that converts pasted text into HTML tables. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Top-level structure</strong>  <br><br> 1. Regex presets and fallback utility imports.  <br> 2. Low-level helpers (<code>_unescape_brackets_outside_code</code>, streaming helpers, type detection).  <br> 3. CSV sniffing and <code>parse_csv_tables</code>.  <br> 4. Markdown pipe-table parser <code>parse_markdown_tables</code>.  <br> 5. Small DataFrame shim <code>_SimpleDF/_SimpleColumns</code>.  <br> 6. Debug extractor <code>extract_tables_debug</code>.  <br> 7. Renderer selection <code>_get_default_markdown_renderer</code>.  <br> 8. Main renderer <code>render_table</code>.  <br> 9. Conversion helpers <code>convert_structure</code>, <code>convert_text_to_html</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Design goals observed</strong>  <br><br> • Preserve inline code and escaped pipes.  <br> • Keep single-newline preservation inside cells (TV2.1 parity).  <br> • Provide safe fallbacks when utilities unavailable.  <br> • Keep external dependencies optional.  <br><br> <strong>Tradeoffs:</strong> More defensive code increases complexity. Fallback markdown renderer is intentionally small and not spec-complete. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Regex & constants</strong>  <br><br> • <code>_PRE_RE</code>, <code>_CODE_RE</code> detect <code>&lt;pre</code>/<code>&lt;code</code> blocks for escapes.  <br> • <code>_DIVIDER_PART_RE</code> matches divider pieces like <code>---</code>, <code>:---:</code>, <code>-:</code> etc.  <br><br> <strong>Note:</strong> <code>_DIVIDER_PART_RE</code> is strict and appropriate for divider validation but will reject divider parts with extra spaces/content. Good for correctness. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Fallback utilities behavior</strong>  <br><br> 1. Attempts to import helpers from <code>utils</code>; falls back to local implementations.  <br> 2. <code>_strip_tags</code> strips tags via regex fallback; tolerates <code>None</code>.  <br> 3. <code>sanitize_bold_html</code> tries to preserve bolded first-line text.  <br> 4. <code>convert_markdown_lists</code> delegates to provided <code>markdown_to_html</code> or escapes.  <br> 5. <code>_escape_unmatched_markers</code> splits around <code>&lt;pre&gt;/&lt;code&gt;</code> and replaces stray <code>|</code> with <code>&amp;#124;</code>.  <br> 6. <code>_apply_left_col_heading</code> is a no-op fallback.  <br><br> <strong>Implication:</strong> code is resilient but fallback behaviors differ from project helpers; test coverage should include both code paths. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Helper functions — correctness notes</strong>  <br><br> <strong>_unescape_brackets_outside_code</strong>: safely unescapes <code>\[</code> and <code>\]</code> outside code/pre.  <br><br> <strong>_peek_rows_non_destructive/_take_and_stream</strong>: create non-destructive samples from iterables using <code>itertools.tee</code>. Handles lists and iterators.  <br><br> <strong>_detect_column_types</strong>: heuristically marks columns numeric/text by sampling rows and trying <code>float()</code> after sanitizing. Handles percent and parentheses.  <br><br> <strong>_clean_label_for_datalabel</strong>: strips tags and punctuation for <code>data-label</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CSV detection (<code>_looks_like_csv</code>)</strong>  <br><br> <strong>Logic:</strong> rejects pipe-containing lines, requires ≥2 non-empty lines, checks candidate delimiters (<code>,</code>, <code>;</code>, <code>\t</code>) by consistent counts across lines.  <br><br> <strong>Strengths:</strong> avoids misclassifying pipe-tables as CSV.  <br><br> <strong>Limitations:</strong> some complex CSVs with quoted fields containing delimiter counts may mislead. Acceptable as heuristic. </td></tr><tr><td data-label="Technical Breakdown"> <strong>parse_markdown_tables</strong><br><br><strong>Responsibilities:</strong> Locate Markdown pipe tables, preserve inline backtick code and escaped pipes, and return table rows with header flag.<br><br><strong>Strengths:</strong> Handles inline code and escaped pipes robustly.<br><br><strong>Limitations & failure modes:</strong><br>1. Does not detect fenced code blocks that span multiple lines which may contain <code>\|</code> characters. If a fenced code block appears inside the candidate area, algorithm may misinterpret.<br>2. Backtick handling is purely toggle-based and does not support multi-backtick code spans with differing backtick counts (e.g., <code> </code>`<code> </code>) which can allow backticks inside backticks.<br>3. Does not consider codefence start/end lines like <code> </code>`<code> </code> which should be skipped entirely during detection; this is partially mitigated in other places but worth addressing in parsing step.<br><br><strong>Recommended fixes:</strong><br>• Pre-scan to mask fenced code blocks (<code> </code>`<code> </code> or <code>~~~</code>) and indented code blocks before table detection.<br>• Enhance <code>_split_row_keep_code</code> to support code spans delimited by N backticks (common in CommonMark) by scanning sequences of backticks and matching same-length closers.<br>• Consider using a CommonMark parser for robust coverage when available. </td></tr><tr><td data-label="Technical Breakdown"> <strong>parse_csv_tables</strong>  <br><br> <strong>Flow:</strong> normalize newlines, strip BOM, <code>html.unescape</code>, sample for <code>csv.Sniffer</code>.  <br><br> 1. Try <code>csv.Sniffer.sniff</code> with delimiters <code>,; \t |</code>.  <br> 2. Fallback to counting delimiters if sniff fails.  <br> 3. Read with <code>csv.reader</code>, strip empty rows.  <br> 4. Attempt header detection using <code>sniffer.has_header(sample)</code>; fallback numeric heuristics comparing first row numericity to subsequent rows.  <br> 5. Return <code>{&quot;rows&quot;: normalized_rows, &quot;header&quot;: bool(has_header), &quot;source&quot;: &quot;csv&quot;}</code> in list.  <br><br> <strong>Edge cases & suggestions:</strong>  <br> • Use <code>csv.DictReader</code> when header present for clarity.  <br> • <code>sniffer.has_header</code> is unreliable; the numeric heuristic is reasonable but test thoroughly.  <br> • For large inputs, consider streaming parse instead of reading all into memory. </td></tr><tr><td data-label="Technical Breakdown"> <strong>_SimpleDF / shim</strong>  <br><br> <strong>Purpose:</strong> Provides a minimal dataframe-like object for environments without pandas. Supports <code>columns</code>, <code>itertuples</code>, iteration, and <code>alignments</code> attachable attribute.  <br><br> <strong>Behavior:</strong> Lightweight and simple. Good fallback.  <br><br> <strong>Note:</strong> When pandas present, <code>extract_tables_debug</code> attempts to create a real DataFrame and attach <code>_table_alignments</code>. This is pragmatic. </td></tr><tr><td data-label="Technical Breakdown"> <strong>extract_tables_debug</strong>  <br><br> <strong>Purpose:</strong> Aggressive extractor to produce table-like objects for debugging. Returns <code>(pipe_tables, html_tables)</code>.  <br><br> <strong>Behavior:</strong>  <br> 1. Normalizes typographic quotes/dashes/ellipses.  <br> 2. Finds candidate ranges by detecting divider lines or contiguous pipe lines.  <br> 3. Uses local <code>_split_row_keep_code_local</code> to split rows.  <br> 4. Computes header, alignment, normalizes body rows, and returns DataFrame or <code>_SimpleDF</code>.  <br><br> <strong>Strengths:</strong> Good for debugging and discovering pipe-tables even when not strictly well-formed.  <br><br> <strong>Limitations:</strong> shares same backtick & fenced code limitations as <code>parse_markdown_tables</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>_get_default_markdown_renderer</strong>  <br><br> <strong>Strategy:</strong> Try to import a project-local <code>get_markdown_renderer</code>. Fallback to <code>_simple_md</code> which:  <br> • Escapes plain strings.  <br> • Extracts inline code and replaces with <code>&lt;code&gt;</code>.  <br> • Handles bold/italic patterns with simple regex.  <br> • Splits blocks on double newlines into <code>&lt;p&gt;</code> blocks.  <br><br> <strong>Limitations:</strong> Not CommonMark compliant; will not handle lists, blockquotes, fenced code, tables, or complex inline rules reliably. Acceptable as a last-resort fallback only. </td></tr><tr><td data-label="Technical Breakdown"> <strong>render_table — detailed correctness & edge cases</strong>  <br><br> 1. <strong>Column detection fallback:</strong> If <code>df.columns</code> broken, code peeks first row. Works but must handle StopIteration exceptions (it does).  <br> 2. <strong>Iterator handling:</strong> <code>_take_and_stream</code> uses <code>itertools.tee</code> where possible. Note: <code>tee</code> can increase memory if iterator is large; only used for small sample (n=5) which is acceptable.  <br> 3. <strong>Markdown rendering for multiline cells:</strong> It converts single newlines to Markdown line breaks (<code>two spaces + newline</code>) unless code fences detected. This matches TV2.1 parity intent.  <br> 4. <strong>Cell-level sanitization:</strong> <code>sanitize_bold_html</code> is used with <code>preserve_full=False</code>. This may alter original inline markup; acceptable if consistent with upstream expectations.  <br> 5. <strong>Escaping unmatched <code>|</code>:</strong> <code>_escape_unmatched_markers</code> ensures stray <code>|</code> do not break table re-copy operations.  <br> 6. <strong>Accessibility:</strong> <code>th</code> elements have <code>role=&quot;button&quot;</code>, <code>scope=&quot;col&quot;</code>, <code>aria-label</code> and <code>aria-sort</code>. Good semantic choices.  <br><br> <strong>Potential issues:</strong>  <br> • <code>md_callable(pre_md)</code> may return block-level markup like <code>&lt;p&gt;</code> or <code>&lt;ul&gt;</code> which is directly placed inside <code>&lt;td&gt;</code>; that's acceptable but ensure it doesn't produce block-level <code>&lt;table&gt;</code> or malformed HTML.  <br> • If <code>md_callable</code> returns text containing <code>&lt;/td&gt;</code> or <code>&lt;tr&gt;</code> due to broken markdown, output could break layout; consider sanitizing or restricting allowed tags.  <br> • <code>data-label</code> is used for responsive layouts; <code>_clean_label_for_datalabel</code> ensures reasonable content. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security considerations (XSS & injection)</strong>  <br><br> 1. <code>md_callable</code> may return HTML. When that renderer is a full markdown library it may generate sanitized HTML or raw HTML depending on configuration. Caller must provide safe renderer or sanitize final output.  <br> 2. Fallback <code>_simple_md</code> escapes most content but still injects HTML for inline and block tags it intentionally emits.  <br> 3. <code>render_table</code> uses <code>html.escape</code> for default fallbacks but relies on provided <code>md_callable</code> for HTML safety.  <br><br> <strong>Recommendations:</strong> Always pass a safe <code>markdown_to_html_func</code> that either sanitizes or disallows raw HTML. For defense-in-depth, run output through an HTML sanitizer (e.g., <code>bleach</code>) before returning to untrusted contexts. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance and memory</strong>  <br><br> 1. Parsing functions operate in-memory and are appropriate for typical pasted content sizes (KBs to low MBs).  <br> 2. <code>_take_and_stream</code> uses tee with small sample size; memory effect minimal.  <br> 3. <code>render_table</code> builds HTML via Python string joins; efficient and typical.  <br><br> <strong>When to optimize:</strong> For very large inputs (>10MB) consider streaming CSV parse, and pagination/virtualization when rendering many tables/rows. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling approach</strong>  <br><br> • Code uses local <code>try/except</code> liberally to keep conversion resilient.  <br><br> <strong>Pros:</strong> Robust UI behavior; avoids crashing on malformed input.  <br> <strong>Cons:</strong> Silent failures can mask bugs. Exceptions are logged with <code>logger.exception</code> in key places but many <code>except</code> blocks simply <code>pass</code>.  <br><br> <strong>Recommendation:</strong> Replace silent <code>except: pass</code> with <code>logger.debug</code> or <code>logger.warning</code> in low-severity cases and preserve <code>logger.exception</code> where a stacktrace helps debugging. Consider an optional <code>strict</code> flag to surface failures during testing. </td></tr><tr><td data-label="Technical Breakdown"> <strong>API ergonomics</strong>  <br><br> • <code>parse_markdown_tables(text) -&gt; List[Dict]</code> returns <code>rows/header/source</code>.  <br> • <code>parse_csv_tables(text, delimiter=None, assume_header=None) -&gt; List[Dict]</code> returns a list with row arrays and header flag.  <br> • <code>render_table(df, ...) -&gt; str</code> returns table HTML.  <br> • <code>convert_text_to_html(text, options) -&gt; {&quot;html&quot;:..., &quot;metadata&quot;:...}</code> tries parse-markdown-first, else calls markdown renderer.  <br><br> <strong>Recommendation:</strong> Document expected return shapes and types in a module-level docstring and type hints for returned dict entries (currently relaxed <code>Any</code>). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing recommendations</strong>  <br><br> Build a comprehensive test matrix. Key test cases:  <br> 1. Pipe tables with escaped pipes <code>\|</code> in cells.  <br> 2. Inline code spans with backticks including nested backticks and varying counts.  <br> 3. Fenced code blocks that include <code>|</code> characters.  <br> 4. Tables with uneven row lengths.  <br> 5. Divider-line variations: <code>:---:</code>, <code>---:</code>, <code>:---</code>, multiple dashes and spaces.  <br> 6. CSVs with quoted delimiters and mixed quote/delimiter presence.  <br> 7. Very large tables to measure performance.  <br> 8. XSS attempts in input to confirm sanitization (if desired output must be safe).  <br><br> Automate these tests using pytest and include fixtures for both presence and absence of <code>pandas</code> and <code>markdown</code> libs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>API & integration notes</strong>  <br><br> • Callers should supply <code>markdown_to_html_func</code> when HTML safety or markdown fidelity matters.  <br> • For better alignment control, callers may set <code>df._table_alignments</code> or <code>df.alignments</code> before calling <code>render_table</code>.  <br> • <code>convert_text_to_html</code> returns metadata that helps identify whether conversion occurred; extend metadata with <code>warnings</code> array like <code>convert_structure</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Packaging & deployment notes</strong>  <br><br> 1. Relative import of <code>utils</code> assumes project layout. Consider using absolute imports or packaging <code>convert.py</code> as part of a module that guarantees <code>utils</code> presence.  <br> 2. When packaging into wheels or zipapps, <code>__file__</code> resolution is more complex; but <code>convert.py</code> does not rely on <code>__file__</code> directly so it's safe.  <br> 3. Third-party optional deps: <code>pandas</code> and <code>markdown</code> are tried but optional. Document optional dependencies in packaging metadata (extras). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Logging & observability</strong>  <br><br> • <code>logger = logging.getLogger(&quot;convert&quot;)</code> provided and uses <code>NullHandler</code> by default.  <br> • Recommend adding structured debug messages at <code>DEBUG</code> for parsing steps and <code>WARN</code> when fallbacks are used.  <br> • Consider adding counters for <code>tables_parsed</code>, <code>csv_detected</code>, <code>markdown_fallback_used</code> available on <code>logger</code> or via returned metadata for telemetry. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Maintainability & code style</strong>  <br><br> 1. Many repeated try/except blocks with similar fallbacks. Consider helper decorator <code>@suppress_and_log(default=...)</code> to reduce repetition.  <br> 2. Add module docstring describing public API, return types, and guarantees.  <br> 3. Add type hints to function returns for clearer contracts, e.g., <code>-&gt; List[Dict[str, Any]]</code>.  <br> 4. Small utility functions should include one-line docstrings to improve readability. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security hardening checklist</strong>  <br><br> 1. Sanitize or validate <code>md_callable</code> output before injecting into <code>&lt;td&gt;</code> for untrusted sources.  <br> 2. Limit rendered HTML length or number of rows when invoked in untrusted contexts.  <br> 3. Add Content-Security-Policy guidance when embedding produced HTML in web apps. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Backward compatibility & TV2.1 parity</strong>  <br><br> The module clearly attempts to preserve single-newline behavior and alignment metadata. Tests should verify exact carriage of single-newline semantics and that the <code>  \n</code> insertion does not double-insert for content already containing Markdown linebreaks. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Concrete high-leverage improvements (prioritized)</strong>  <br><br> 1. <strong>Fenced code protection:</strong> Pre-mask fenced code blocks before table detection to avoid misparsing tables that appear inside code fences.  <br> 2. <strong>Backtick-span robustness:</strong> Upgrade <code>_split_row_keep_code</code> to support multi-backtick delimiters.  <br> 3. <strong>Sanitization default:</strong> Add optional <code>sanitize_html</code> param at render APIs to pass through <code>bleach.clean</code> with safe tags.  <br> 4. <strong>Logging clarity:</strong> Replace silent <code>except: pass</code> with <code>logger.debug(...)</code> or <code>logger.warning(...)</code>.  <br> 5. <strong>Docstrings & types:</strong> Add explicit return-type annotations and short docstrings for every public function. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Smaller targeted code fixes (copy-paste ready)</strong>  <br><br> 1. Mask fenced code before parsing:  <br>    • Use regex to replace contents of triple-backtick fences with placeholders and restore later.  <br> 2. Improve code-span support:  <br>    • Track opening backtick run length and require matching closing run of same length.  <br> 3. Validate <code>left_width</code>/<code>right_width</code> in <code>render_table</code>: clamp to [0.0, 100.0] and ensure not NaN/inf.  <br> 4. When building HTML, wrap final output in a small sanitizer pass when <code>options.get(&quot;sanitize&quot;, True)</code> is set. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational suggestions</strong>  <br><br> • Expose a CLI wrapper for <code>convert_text_to_html</code> and <code>extract_tables_debug</code> to facilitate manual testing of pasted content.  <br> • Provide a debug flag that returns both HTML and a structured AST of parsed tables for developer inspection. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Backward/forward compatibility notes</strong>  <br><br> • Future upgrades to markdown or pandas may add more attributes; keep checks defensive (e.g., look for <code>_table_alignments</code>, <code>alignments</code>, and accept both).  <br> • If integrating server-side rendering, consider producing sidecar JSON with normalized tokens to accelerate client search/highlight. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Summary & recommended next steps</strong>  <br><br> 1. Add tests for fenced-code masking, multi-backtick spans, and CSV edge cases.  <br> 2. Harden <code>parse_markdown_tables</code> by pre-masking fenced code blocks and supporting multi-backtick code spans.  <br> 3. Require callers to pass a safe <code>markdown_to_html_func</code> for untrusted input or enable an internal sanitize pass by default.  <br> 4. Replace silent <code>except</code> with logged warnings and an optional <code>strict</code> mode for CI.  <br><br> These steps preserve current defensive behavior while improving correctness for corner cases and increasing developer visibility into failures. </td></tr></tbody></table></div><div class="row-count">Rows: 29</div></div><div class="table-caption" id="Table8" data-table="Book_8052_08" style="margin-top:2mm;margin-left:3mm;"><strong>Table 8 — core_assets.py</strong></div>
<div class="table-wrapper" data-table-id="table-8"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>File purpose & summary</strong>  <br><br> Implements robust asset discovery, safe copying, atomic writes, placeholder generation, manifest and SRI creation, optional fingerprinting, and helper utilities for embedding or linking assets in rendered HTML. Designed to be resilient: prefers project or core_io helpers when present and falls back to safe defaults otherwise. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API (surface)</strong>  <br><br> - <code>prepare_assets(cfg: Optional[Any], out_dir: Path) -&gt; Tuple[Path,str,str,bool]</code> — ensure assets dir, copy assets or create placeholders, possibly write manifest/info, return <code>(assets_dir, style_fallback, script_fallback, assets_written)</code>.  <br> - <code>write_overrides_css(out_dir: Path, left_width: float, right_width: Optional[float]) -&gt; None</code> — robust fallback overrides CSS writer.  <br> - <code>compute_sri(path: Path, algo: str=&#x27;sha384&#x27;) -&gt; str</code> — produce SRI string.  <br> - <code>write_assets_manifest(assets_dir: Path, logical_map: Optional[Dict[str,str]])</code> — write JSON manifest with file stats and SRI.  <br> - <code>resolve_asset_name(logical_name: str, assets_dir: Path) -&gt; Optional[str]</code> — map logical asset name to physical file using manifest or patterns.  <br> - <code>make_link_tag_for_css</code> / <code>make_script_tag_for_js</code> — produce <code>&lt;link&gt;</code> / <code>&lt;script&gt;</code> elements with integrity attr when possible.  <br> - <code>inline_style_fallback</code> / <code>inline_script_fallback</code> — embed fallback content into HTML tags. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Design principles observed</strong>  <br><br> 1. Prefer existing implementations (<code>.assets</code>, <code>.core_io</code>) when available.  <br> 2. Fail gracefully and log debug traces rather than raising for most non-fatal errors.  <br> 3. Use atomic writes/copies where possible to avoid partial files.  <br> 4. Avoid overwriting non-empty targets unless <code>force_copy</code> requested.  <br> 5. Provide minimal non-empty placeholders to avoid zero-byte assets.  <br> 6. Make advanced features opt-in (fingerprinting, manifest generation). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Top-level behavior of <code>prepare_assets</code></strong>  <br><br> 1. Determine <code>assets_dir</code> (cfg override or <code>out_dir/assets</code>).  <br> 2. Ensure directory exists (prefers core_io helper).  <br> 3. Attempt <code>project-provided copy_assets</code> implementation if present.  <br> 4. Otherwise attempt copying from multiple candidate dirs discovered by <code>_discover_candidate_asset_dirs</code>.  <br> 5. Ensure non-empty placeholders for <code>style.css</code>, <code>script.js</code>, <code>worker.js</code>, <code>overrides.css</code>.  <br> 6. Optionally write manifest & info files.  <br> 7. Return <code>(assets_dir, style_fallback, script_fallback, assets_written)</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Candidate discovery & copy policy</strong>  <br><br> <code>_discover_candidate_asset_dirs</code> returns an ordered list: repo-root <code>assets</code> (parents[1]), cwd/assets, package sibling assets, module assets. This ordered search is intentional to pick repo-local override first. <code>_copy_from_source_assets</code> iterates candidates and copies files respecting whitelist, blacklist, max_size, fingerprint, force_copy flags. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Atomic operations & fallbacks</strong>  <br><br> - Uses <code>_coreio_atomic_write</code> / <code>_coreio_atomic_stream_write</code> / <code>_coreio_ensure_dir</code> when available.  <br> - Fallback implementations: <code>_fallback_atomic_write</code> (text-mode file writer to a tmp file then <code>os.replace</code>), <code>_fallback_atomic_copy</code> (binary copy into tmp file then <code>os.replace</code>, with <code>copystat</code> best-effort).  <br> - <code>_atomic_write_dispatch</code> and <code>_atomic_copy_dispatch</code> choose preferred impls, otherwise fall back.  <br><br> <strong>Implication:</strong> Writes and copies aim to be atomic on POSIX and Windows <code>os.replace</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Non-destructive semantics</strong>  <br><br> By default <code>_copy_from_source_assets</code> will skip overwriting an existing destination file if dest size >= 10 bytes and <code>force_copy</code> is False. This prevents accidental overwrites of custom or user-edited files. Logical mapping recorded if fingerprinting enabled. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Placeholders & minimum content</strong>  <br><br> <code>_ensure_non_empty_file(path, fallback_text)</code> guarantees files exist and are at least 10 bytes. This prevents zero-byte files that can break downstream loaders. The function will create the file or overwrite small files with fallback. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Hashing & fingerprinting</strong>  <br><br> - <code>_compute_hash_hex(path, algo=&#x27;sha256&#x27;)</code> returns hex digest.  <br> - <code>_insert_hash_before_ext</code> composes fingerprinted filename by inserting hash before extension.  <br> - When <code>cfg.fingerprint_assets</code> True, <code>_copy_from_source_assets</code> will create a hashed variant and optionally record logical->physical mapping for the manifest.  <br><br> <strong>Note:</strong> fingerprint uses sha256 truncated to <code>fp_len</code> chars; fingerprint length must be balanced for collision risk vs filename length. </td></tr><tr><td data-label="Technical Breakdown"> <strong>SRI computation</strong>  <br><br> <code>compute_sri(path, algo=&#x27;sha384&#x27;)</code> reads file and returns <code>algo-&lt;base64digest&gt;</code>. Returns empty string on failure. This is used by <code>make_link_tag_for_css</code> / <code>make_script_tag_for_js</code> to produce <code>integrity</code> attributes. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Manifest & info files</strong>  <br><br> - <code>write_assets_manifest</code> enumerates files in <code>assets_dir</code>, records <code>size</code>, <code>mtime</code>, and <code>sri</code> for each. Optionally includes <code>mapping</code> logical map. Writes <code>assets-manifest.json</code> with atomic write.  <br> - <code>write_assets_info</code> writes diagnostics <code>assets-info.json</code> with <code>assets_written</code> flag and file list.  <br><br> <strong>Usage:</strong> <code>prepare_assets</code> writes manifest if <code>cfg.generate_manifest</code> True and writes assets-info always. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Resolution helper</strong>  <br><br> <code>resolve_asset_name(logical_name, assets_dir)</code> first tries to read manifest mapping, falls back to direct file presence, then attempts pattern match <code>base.&lt;something&gt;.ext</code> to find fingerprinted files. Robust for common fingerprint schemes. </td></tr><tr><td data-label="Technical Breakdown"> <strong>HTML helper builders</strong>  <br><br> <code>make_link_tag_for_css</code> and <code>make_script_tag_for_js</code> produce tags with <code>href/src</code> under <code>assets/</code> path and include <code>integrity</code> and <code>crossorigin=&quot;anonymous&quot;</code> if SRI available. <code>inline_style_fallback</code> and <code>inline_script_fallback</code> wrap fallback text into tags for embedding. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Logging & observability</strong>  <br><br> Uses module-level logger <code>&quot;render.core_assets&quot;</code>. Default handler is NullHandler. Code logs at debug/info levels for copy attempts, skipped files, failures, and manifest writes. Many <code>except</code> blocks log debug traces instead of surfacing errors. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling philosophy</strong>  <br><br> Defensive: most IO failures are caught and logged at debug level. Functions return boolean success flags or continue. This aligns with non-fatal asset population where UI degrades gracefully. But consuming code must check returned <code>assets_written</code> and presence of files for guaranteed behavior. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security considerations</strong>  <br><br> 1. Only copies from local discovered candidate directories. No user-provided arbitrary paths are copied without explicit cfg.  <br> 2. Manifest includes SRI values.  <br> 3. When embedding inline fallbacks, callers must still observe XSS contexts; CSS/JS fallbacks are developer-controlled strings.  <br><br> <strong>Recommendation:</strong> If exposing <code>prepare_assets</code> to untrusted inputs, validate <code>cfg</code> fields (no path injection) and ensure <code>assets_dir</code> is constrained under an allowed base directory. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Race conditions & concurrency</strong>  <br><br> - Atomic replace mitigates partial-file races but concurrent runs could still contend.  <br> - <code>_copy_from_source_assets</code> may skip copying if dest exists; a concurrent process may write while this process is checking dest size.  <br><br> <strong>Mitigation:</strong> Encourage callers to coordinate or lock when multiple processes might prepare the same <code>assets_dir</code>. Consider creating a <code>.lock</code> file during preparation. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Platform considerations</strong>  <br><br> - Uses <code>os.replace</code> which is atomic on POSIX and on Windows for replacing same-path files.  <br> - <code>os.fsync</code> used best-effort; on some filesystems <code>fsync</code> semantics vary.  <br> - <code>tempfile.NamedTemporaryFile(delete=False, dir=...)</code> used to create tmp file in same directory to ensure <code>os.replace</code> is atomic. Works cross-platform. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance & IO considerations</strong>  <br><br> - <code>_copy_from_source_assets</code> copies files sequentially; for many assets this is IO-bound but acceptable for typical project asset counts.  <br> - <code>compute_sri</code> and <code>_compute_hash_hex</code> read whole file; manifest generation on large assets will be CPU/IO heavy.  <br> - <code>max_asset_copy_size</code> default 10MB prevents copying extremely large assets unless whitelisted. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Configurability (cfg keys)</strong>  <br><br> - <code>assets_dir</code> (str/Path) override.  <br> - <code>generate_manifest</code> bool.  <br> - <code>fingerprint_assets</code> bool.  <br> - <code>fingerprint_len</code> int.  <br> - <code>max_asset_copy_size</code> int.  <br> - <code>asset_copy_whitelist</code> list of glob patterns.  <br> - <code>asset_copy_blacklist</code> list of glob patterns.  <br> - <code>force_copy_assets</code> bool.  <br><br> <strong>Note:</strong> <code>cfg</code> is treated as a duck-typed object. Consider allowing dicts for convenience. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Edge cases & failure modes</strong>  <br><br> 1. If project supplies <code>_copy_assets_impl</code> that raises but leaves partially-written files, caller may not detect.  <br> 2. If <code>assets_dir</code> is on a filesystem that disallows atomic rename across directories, atomic replace could fail; code falls back by catching exceptions.  <br> 3. If <code>compute_sri</code> fails, tags will be emitted without integrity attribute.  <br> 4. Manifest fails silently except logged debug; callers assuming manifest exists should verify. </td></tr><tr><td data-label="Technical Breakdown"> <strong>API ergonomics & return contracts</strong>  <br><br> - <code>prepare_assets</code> returns <code>style_fallback</code> and <code>script_fallback</code> strings. These are the embedded constants imported from <code>.assets</code> when present else empty. Callers may inline them if copying failed.  <br> - <code>assets_written</code> flag indicates whether any asset copies occurred (not whether placeholders were written). Documented but ambiguous: consider splitting flags <code>(copied_assets, placeholders_written)</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing matrix recommendations</strong>  <br><br> Unit and integration tests should cover:  <br> • Candidate discovery order and when multiple candidate dirs present.  <br> • Copy with fingerprinting and logical_map recording.  <br> • Force copy vs skip behavior when dest exists and is non-empty.  <br> • <code>_ensure_non_empty_file</code> behavior on existing small files and on missing files.  <br> • <code>_fallback_atomic_write</code> and <code>_fallback_atomic_copy</code> correctness, including tmp cleanup on failure.  <br> • Manifest and info generation and valid SRI values.  <br> • <code>resolve_asset_name</code> path resolution including hashed filenames.  <br> • <code>make_link_tag_for_css</code> / <code>make_script_tag_for_js</code> integrity attribute presence.  <br> • Behavior on read-only <code>assets_dir</code> and when <code>core_io</code> helpers are present (mocked). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational recommendations</strong>  <br><br> 1. Add a high-level <code>prepare_assets(..., logger=...)</code> parameter or allow callers to configure logging to surface warnings.  <br> 2. Provide an optional <code>lock</code> parameter to coordinate concurrent runs.  <br> 3. Return richer diagnostics: list of copied files, skipped files, and reasons for skip. This aids CI and user debugging.  <br> 4. Consider a <code>dry_run</code> parameter that reports intended actions without writing. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Small implementation improvements (high-leverage)</strong>  <br><br> 1. <strong>Return richer result object</strong> from <code>prepare_assets</code>, e.g. <code>PreparedAssets(assets_dir, style_fallback, script_fallback, copied_files, placeholders_written, manifest_written)</code>.  <br> 2. <strong>Validate cfg types</strong> (allow dict or object). Use <code>cfg.get(&#x27;generate_manifest&#x27;, False)</code> or <code>getattr</code> consistently.  <br> 3. <strong>Make <code>max_asset_copy_size</code> smaller for default</strong> in web contexts (e.g., 2MB) to avoid accidental giant assets; keep config override.  <br> 4. <strong>Add optional file-level allowlist</strong> to always copy required essential assets (e.g., <code>style.css</code>, <code>script.core.js</code>).  <br> 5. <strong>Add unit-test hooks</strong> to inject fake <code>core_io</code> for verifying dispatch. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security hardening (recommended)</strong>  <br><br> 1. Restrict <code>assets_dir</code> to be under an allowed base root if <code>cfg</code> originates from untrusted sources.  <br> 2. When writing manifest or info, avoid including absolute paths; keep relative names only.  <br> 3. If copying user-provided assets in other contexts add virus/malware scanning or checksum whitelisting. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Backward compatibility & migration notes</strong>  <br><br> - The module is intentionally conservative; it will not overwrite existing assets. If previous behavior overwrote files silently, callers must set <code>force_copy_assets=True</code> to restore that semantics.  <br> - When enabling fingerprinting, older references expecting <code>script.js</code> must be resolved via <code>resolve_asset_name</code> and the manifest mapping must be shipped. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Observability & telemetry suggestions</strong>  <br><br> - Add counters or metrics: <code>assets_attempted</code>, <code>assets_copied</code>, <code>assets_skipped</code>, <code>manifest_written</code>.  <br> - Emit warnings at WARN level for skipped critical assets like <code>style.css</code> if placeholders were used, to alert maintainers. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Backward/forward integration notes</strong>  <br><br> - Compose <code>prepare_assets</code> with template rendering pipelines: prefer linking tag with SRI when available.  <br> - When serving from CDN, manifest mapping or fingerprinting helps ensure cache-bust behavior.  <br> - Offer an optional <code>base_url</code> parameter to <code>make_*_tag</code> to produce absolute CDN URLs rather than local <code>assets/</code> paths. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Example small fixes to apply (copy-paste)</strong>  <br><br> 1. Return richer <code>prepare_assets</code> result: <code>NamedTuple(&#x27;PreparedAssets&#x27;, ...)</code> and populate copied/skipped lists.  <br> 2. Accept dict-style cfg: <code>cfg_get = lambda k, default=None: (cfg.get(k) if isinstance(cfg, dict) else getattr(cfg,k,default))</code>.  <br> 3. Add a <code>lockfile</code> context manager for <code>prepare_assets</code> to avoid concurrent races.  <br> 4. On manifest write, include a <code>version</code> or generator ID to aid debugging. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Potential future features</strong>  <br><br> - Remote asset bundling to a CDN with optional upload plugin.  <br> - Hash-indexed asset cache to avoid re-copying unchanged assets across CI runs.  <br> - Asset delta sync that only copies files with different SRI.  <br> - Optional compression step (brotli/gzip) writing <code>.br</code>/<code>.gz</code> variants and adding <code>Content-Encoding</code> mapping in manifest. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Summary & prioritized next steps</strong>  <br><br> <strong>Immediate (high priority):</strong>  <br> • Return richer diagnostics from <code>prepare_assets</code>.  <br> • Validate <code>cfg</code> and accept dicts.  <br> • Add simple <code>lock</code> to avoid concurrent races.  <br><br> <strong>Medium:</strong>  <br> • Add optional <code>base_url</code> and CDN integration hooks.  <br> • Move non-fatal logs to <code>logger.warning</code> for critical missing assets like <code>style.css</code> placeholder.  <br><br> <strong>Long-term:</strong>  <br> • Add asset delta sync and optional compression fingerprints.  <br><br> These will make the module safer, observable, and easier to operate in CI and multi-process environments. </td></tr></tbody></table></div><div class="row-count">Rows: 32</div></div><div class="table-caption" id="Table9" data-table="Book_8052_09" style="margin-top:2mm;margin-left:3mm;"><strong>Table 9 — core_fragments.py</strong></div>
<div class="table-wrapper" data-table-id="table-9"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>File purpose & summary</strong>  <br><br> Implements robust fragment rendering utilities. Detects and normalizes table-like content from mixed inputs (strings, files, dataframes, lists), extracts pipe-style Markdown tables and HTML <code>&lt;table&gt;</code> blocks, detects CSV/TSV payloads (including fenced CSV blocks), converts rows into DataFrame-like structures, and renders table fragments concurrently to disk using threads or processes. Emphasizes safety: atomic writes, best-effort fallbacks when optional dependencies (BeautifulSoup, pandas, core_table, convert) are missing, and detailed metadata reporting. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Top-level public API</strong>  <br><br> - <code>render_fragments_concurrently(all_tables, cfg, renderer, tmp_frag_dir, max_workers=1, use_process=False) -&gt; (fragments_map, frag_row_counts, total_rows, warnings)</code>  <br> - Utility re-exports: <code>normalize_table_text</code>, <code>extract_pipe_tables_from_markdown</code>, <code>extract_table_blocks_from_html</code>, <code>convert_rows_to_df_like</code>, <code>simple_render_table</code>.  <br><br> Public API returns structured metadata and writes per-fragment HTML files to <code>tmp_frag_dir</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Design goals & tradeoffs</strong>  <br><br> Goals: correctness in parsing varied input types, graceful degradation without third-party libs, concurrency for speed, atomic persistence for reliability, and asset detection heuristics. Tradeoffs: reimplements parsing heuristics rather than using full CommonMark parsers. This yields portable behavior but requires careful test coverage for edge cases (fenced code, nested tables, complex quoting). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Normalization helper <code>_normalize_table_text</code></strong>  <br><br> Purpose: canonicalize line endings, collapse variant hyphen glyphs, strip invisible characters and NBSP, collapse runs of hyphens, and trim trailing whitespace per line. Returns predictable text for downstream detection. Important for handling pasted content from Word, PDFs, or web.  <br><br> Edge-case: replaces multiple dash variants with ASCII <code>-</code> then normalizes runs to <code>---</code>. Good for divider detection but could transform intentional em-dash content in prose. Consider limiting dash normalization to lines that look table-like. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Markdown pipe-table splitting (<code>_split_row_keep_code</code>)</strong>  <br><br> Behavior: iterate characters, toggle <code>in_backtick</code> on single backtick, treat <code>\|</code> as escaped pipe, split on <code>|</code> only when not in backtick. Trim external empty cells.  <br><br> Strengths: preserves inline code spans and escaped pipes. Weaknesses: does not handle multi-backtick code spans (e.g., ```<code> </code>`<code>code</code>with<code>backticks</code>`<code> </code>```) or triple-backtick fenced code blocks encountered inline. Recommendation: support N-backtick matching for inline spans and pre-scan/mask fenced code blocks before table extraction. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Divider detection (<code>_is_divider_line</code>)</strong>  <br><br> Uses regex <code>^:?-{1,}\:?\s*$</code> on each pipe cell. Strict and correct for CommonMark-style dividers. Will reject dividers with additional inner content. Works well for robust detection. Potential false negatives if author added spaces or markup in divider cells; acceptable tradeoff for precision. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Pipe-table extraction (<code>_extract_pipe_tables_from_markdown</code>)</strong>  <br><br> Scans lines sequentially looking for a header with a following divider line then collects contiguous <code>|</code> rows as table body until blank or non-pipe line. Returns <code>(rows, header_flag)</code>.  <br><br> Strengths: simple, fast, and handles basic Markdown tables including escaped pipes and inline code. Limitations: vulnerable to code fences containing <code>|</code>, and will not capture tables with leading/trailing spaces or indent levels if not normalized. Recommendation: pre-mask fenced code blocks and ignore indented code blocks. </td></tr><tr><td data-label="Technical Breakdown"> <strong>HTML <code>&lt;table&gt;</code> extraction</strong>  <br><br> Two paths: BeautifulSoup when available; regex fallback otherwise.  <br><br> BeautifulSoup path: robust, preserves cell text with <code>get_text(&quot;\n&quot;, strip=True)</code>. Regex fallback: extracts <code>&lt;tr&gt;</code> blocks and then <code>&lt;td&gt;</code>/<code>&lt;th&gt;</code> cell content, replaces <code>&lt;br&gt;</code> tags with newlines, strips other tags.  <br><br> Caveats: regex approach is best-effort and can break on malformed HTML or nested tables. Using BS4 when available is strongly preferred. </td></tr><tr><td data-label="Technical Breakdown"> <strong>HTML parsing helper <code>_parse_table_html_regex</code> behavior</strong>  <br><br> Extracts rows and flags presence of <code>&lt;th&gt;</code> or <code>&lt;thead&gt;</code>. Strips tags and unescapes HTML entities. Good for simple server outputs but fragile for complex markup (colspans, nested elements, scripts inside cells). Consider documenting limitations. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CSV heuristics</strong>  <br><br> <code>_is_probable_csv</code> examines first up to 10 non-empty lines and compares delimiter counts across lines for candidates <code>,</code>, <code>\t</code>, <code>;</code>. Returns suggested delimiter or None. <code>_parse_csv_text_to_rows</code> uses <code>csv.Sniffer</code> with fallbacks, returns rows and header_flag (with fallback numeric heuristics comparing first and second row types).  <br><br> Strengths: practical for pasted CSV/TSV. Limitations: quoted delimiters, embedded newlines in quoted fields, or inconsistent row field counts can confuse heuristics. For robust parsing recommend deferring to <code>csv.reader</code> with <code>quotechar</code> and full streaming across entire content already implemented. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Convert rows to DataFrame-like (<code>_convert_rows_to_df_like</code>)</strong>  <br><br> Attempts to import <code>pandas</code> and return a DataFrame where possible. If pandas missing or DataFrame creation fails returns list-of-dicts (when header=True) or list-of-lists. This keeps downstream rendering adaptable.  <br><br> Note: When returning list-of-dicts order of columns is Python dict order; if stable column ordering needed ensure explicit columns list used. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Rendering fallback <code>_simple_render_table</code></strong>  <br><br> Produces minimal HTML when <code>core_table.render_table</code> not present. If df supports <code>.to_html</code> uses it; else builds a simple table by iterating lists/dicts. Provides header with <code>Table {idx}</code>. Safe and useful as last-resort renderer.  <br><br> Limitations: no styling, no Markdown processing, no alignment detection, and sensitive to long cell content (not escaped if using df.to_html with <code>escape=False</code>). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Concurrent render orchestration <code>render_fragments_concurrently</code></strong>  <br><br> Workflow: normalize inputs into <code>inputs[]</code> (value+meta), detect types, then schedule rendering jobs either with threads or, if allowed and renderer picklable, with <code>ProcessPoolExecutor</code> running a picklable simple render job. Each job writes fragment file atomically and collects metadata: <code>render_time_ms</code>, <code>write_time_ms</code>, <code>assets_required</code>, <code>title_id</code>, <code>title_text</code>, <code>sections</code>, <code>detected_type</code>, <code>source</code>, <code>original_preview</code>, and row counts. Returns a map of fragments and aggregated totals plus warnings. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Input normalization step</strong>  <br><br> Accepts mixed inputs: bytes (decoded), Path/filename (reads file), pandas-like DataFrame, list-of-dicts / list-of-lists, dict, or string. Detects and annotates <code>detected_type</code> accordingly. Converts strings using pipeline: prefer external <code>convert.parse_markdown_tables</code> bridge, then local pipe-table extraction, fenced CSV detection, raw CSV detection, then HTML table extraction via markdown rendering or direct HTML. Falls back to passing unknown types through to renderer. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Fenced CSV detection</strong>  <br><br> Recognizes fenced code blocks with languages <code>csv</code>, <code>tsv</code>, <code>text/csv</code>, <code>text/tab-separated-values</code> via <code>fence_re</code>. Parses content within fences as CSV using either bridge or local parser. Good for content authors who embed CSV examples. Edge-case: fenced blocks without trailing fence or nested fences require robust regex; current regex uses multiline/dotall and anchored triple/backtick/tilde runs which is reasonable but must be tested with varied fence lengths and info strings. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Renderer bridge & fallback <code>_call_render_table</code></strong>  <br><br> Attempts call sequence: prefer <code>core_table.render_table</code> (<code>_render_table_helper</code>), calling with (df, idx, md_callable, left_width, right_width) or falling back to fewer args. If df is string and renderer has <code>.render</code> uses that. Else uses <code>_simple_render_table</code> fallback. This layered strategy maximizes compatibility across version differences. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Atomic write semantics</strong>  <br><br> Writes fragment files using either <code>_atomic_stream_write</code> if available from <code>io_utils</code>, else <code>_atomic_write_text</code> which writes to <code>&lt;path&gt;.tmp</code> and <code>os.replace</code>. Ensures fragment files are not left partial. Robust across threads and processes assuming same-directory atomic replace semantics. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Asset detection heuristics</strong>  <br><br> <code>_detect_assets_from_html</code> looks for substrings and patterns to infer required assets such as <code>xlsx.full.min.js</code>, <code>prismjs</code>, <code>virtualize</code>, and patterns from <code>data-requires-*</code> attributes. Useful for downstream asset bundling but heuristic and not exhaustive. Recommend having a canonical mapping or allowing renderer to return explicit <code>assets</code> metadata for accuracy. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Process worker path</strong>  <br><br> If <code>use_process</code> True and <code>renderer</code> picklable, the module uses <code>ProcessPoolExecutor</code> calling <code>_process_simple_render_job</code> which spawns a fresh process that runs <code>_simple_render_table</code>. Returned results are then written out by main process. Reason: avoid pickling heavy renderer objects. Limitation: only simple rendering supported in worker because full renderer may not be picklable. The code detects picklability via <code>pickle.dumps(renderer)</code> and falls back to threads if not picklable. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Thread worker path</strong>  <br><br> Default concurrency uses <code>ThreadPoolExecutor</code>. Jobs call <code>_render_job</code> capturing exceptions and returning structured result. Threads allow calling complex renderer objects without pickling restrictions. For CPU-bound rendering, processes may be faster; for I/O-bound writes, threads suffice. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Fragment metadata extraction</strong>  <br><br> After rendering, code extracts <code>title_id</code> and <code>title_text</code> from <code>&lt;h3 id=&quot;...&quot;&gt;</code> pattern, extracts section headings with class <code>section-heading</code>, computes row counts using regex on <code>&lt;tbody&gt;</code> or <code>&lt;tr&gt;</code>, and collects <code>assets_required</code>. Ensures unique <code>title_id</code> values with <code>_ensure_unique_title_id</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Warnings collection</strong>  <br><br> Warnings aggregated for non-fatal problems: no inputs, non-picklable renderer when <code>use_process</code> requested, fragment render/write failures. Each warning is a dict with <code>level</code>, <code>msg</code>, and <code>table</code> context. Useful for UI display or logging. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Resilience & error handling philosophy</strong>  <br><br> Highly defensive: most internal steps wrapped in try/except with logging and warnings. This preserves pipeline progress even if some fragments or detection heuristics fail. Tradeoff: silent failures can hide systematic bugs unless logging levels and warnings are observed. Suggest surfacing key warnings at WARN level for operator visibility. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance considerations</strong>  <br><br> - Building <code>inputs</code> scans content and may invoke heavy normalization and conversion. For many or very large inputs memory and CPU may be significant.  <br> - <code>compute_sri</code> not used here but similar hashing in other modules can be heavy; consider streaming and limits.  <br> - <code>worker_count</code> computed as <code>max(1, min(len(inputs) or 1, max_workers or 1))</code> which caps workers to number of inputs; sensible.  <br><br> Suggestion: allow chunked processing for large input lists and provide progress callbacks. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security considerations</strong>  <br><br> - The module renders content and writes files; beware of writing to untrusted paths. Validate <code>tmp_frag_dir</code> to avoid path traversal via malformed inputs.  <br> - If <code>renderer.render</code> executes arbitrary templates or accepts raw HTML, sanitize before writing if target is publicly served.  <br> - File content is written with <code>os.replace</code>; this avoids partial files but does not validate content for XSS. Add optional sanitizer step if fragments are served as-is. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Concurrency hazards & recommendations</strong>  <br><br> - Concurrent runs preparing the same <code>tmp_frag_dir</code> can race on file names <code>frag_{idx}.html</code>. Use unique run-scoped prefix or acquire a lock if multiple processes may write to same dir.  <br> - Process path writes in main process but processes also write temporary outputs in worker path in this module; ensure proper cleanup and atomic replacement to avoid partial artifacts.  <br> - Suggestion: allow caller to pass an atomic prefix or uuid to filenames to avoid collision across runs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Pickling & renderer constraints</strong>  <br><br> - The module attempts to pickle <code>renderer</code> to decide whether process pool is allowed. This is a reasonable heuristic but picklability does not ensure renderer dependencies are available in worker processes. Use dedicated worker functions that import necessary modules inside worker to ensure environment consistency. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing recommendations</strong>  <br><br> Build comprehensive tests covering:  <br> 1. Markdown pipe tables with escaped pipes and inline code spans (single and multi-backtick).  <br> 2. Fenced code blocks with CSV/TSV and unusual fence delimiters.  <br> 3. HTML table extraction with nested tags, <code>colspan</code>, <code>&lt;br&gt;</code> handling.  <br> 4. Path-like inputs: UTF-8 and latin-1 file reads.  <br> 5. Pandas DataFrame inputs and <code>_convert_rows_to_df_like</code> fallbacks.  <br> 6. Concurrency: thread and process paths with synthetic renderer (picklable vs non-picklable).  <br> 7. Atomic write: simulate write failure to ensure no partial <code>.tmp</code> files left.  <br> 8. Asset detection heuristics with sample HTML requiring <code>xlsx</code> or Prism. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Observability & logging</strong>  <br><br> - Module-level logger <code>&quot;render.core_fragments&quot;</code> exists. Many debug logs are present.  <br> - Suggest adding structured logs for high-level events: number of inputs detected, count of rendered fragments, total rows, average render/write latency, and warnings summary.  <br> - Consider optional telemetry counters returned in metadata for performance monitoring. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Maintainability & code quality suggestions</strong>  <br><br> 1. Factor the input normalization pipeline into smaller testable functions with clear return contracts.  <br> 2. Extract the detection order into a pluggable list so new detectors can be added without changing function body.  <br> 3. Replace several regex-based HTML heuristics with optional HTML parser modules when available (encapsulate fallback in one place).  <br> 4. Document expected types for <code>renderer</code> (callable vs object with <code>.render</code>) and examples for callers. </td></tr><tr><td data-label="Technical Breakdown"> <strong>API ergonomics suggestions</strong>  <br><br> 1. <code>render_fragments_concurrently</code> could return a <code>PreparedFragments</code> object (namedtuple/dataclass) containing: <code>fragments_map</code>, <code>frag_row_counts</code>, <code>total_rows</code>, <code>warnings</code>, <code>stats</code> (timings), and <code>copied_assets</code>.  <br> 2. Add <code>dry_run</code> and <code>quiet</code> flags to control writes and logging for tests.  <br> 3. Expose optional <code>on_fragment_complete</code> callback for progress UI. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Small, high-leverage code fixes to apply</strong>  <br><br> 1. Pre-mask fenced code blocks before <code>_extract_pipe_tables_from_markdown</code> to prevent misdetection.  <br> 2. Upgrade <code>_split_row_keep_code</code> to support multi-backtick inline spans by recording backtick run length and matching same-length closer.  <br> 3. Make <code>_atomic_write_text</code> use <code>tempfile.NamedTemporaryFile</code> in same dir and <code>os.replace</code> for added robustness and proper cleanup.  <br> 4. Ensure file writes use <code>encoding=&#x27;utf-8&#x27;</code> and handle exceptions to avoid data loss. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational & packaging notes</strong>  <br><br> - Keep optional imports lazy so packaging does not require bs4/pandas by default.  <br> - Document optional extras in <code>setup.py</code>/<code>pyproject.toml</code> (e.g., <code>render[html]</code> installs <code>beautifulsoup4</code>, <code>render[dataframe]</code> installs <code>pandas</code>).  <br> - Provide a small CLI wrapper for debugging fragment extraction and for running local concurrency tests. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security hardening checklist</strong>  <br><br> 1. Validate <code>tmp_frag_dir</code> is an explicit safe directory and reject paths that escape intended base.  <br> 2. Sanitize rendered HTML when written for public consumption unless caller guarantees safe renderer.  <br> 3. Avoid writing user-controlled filenames; generate names deterministic from index and run id.  <br> 4. Limit maximum fragment content size written to disk unless configured. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Summary & prioritized next steps</strong>  <br><br> <strong>Immediate (high priority):</strong>  <br> • Add fenced-code pre-masking to avoid false-positive table extraction.  <br> • Improve inline code span handling to support multi-backtick runs.  <br> • Harden atomic write to use secure tempfiles and ensure cleanup.  <br><br> <strong>Medium:</strong>  <br> • Add richer return struct and optional progress callback.  <br> • Surface important warnings at WARNING level and include counts in returned metadata.  <br><br> <strong>Long-term:</strong>  <br> • Provide pluggable detector chain and optional server-side indexing of table tokens.  <br> • Add asset manifest integration so fragment-level <code>assets_required</code> become canonical and machine-actionable.  <br><br> These steps increase correctness, observability, and safety while preserving the flexible fallback-first design of the module. </td></tr></tbody></table></div><div class="row-count">Rows: 35</div></div><div class="table-caption" id="Table10" data-table="Book_8052_10" style="margin-top:2mm;margin-left:3mm;"><strong>Table 10 — core_io.py</strong></div>
<div class="table-wrapper" data-table-id="table-10"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>File purpose & summary</strong>  <br><br> Implements atomic file write primitives, directory utilities, deterministic temporary fragment directory creation, and CSV extraction helpers. Provides safe defaults while preferring project-supplied implementations when present. Designed for reliability: atomic replace semantics, same-directory temp files, encoding detection, dialect sniffing, and small-memory CSV preview. Public surface: <code>_atomic_write</code>, <code>_atomic_stream_write</code>, <code>_ensure_dir</code>, <code>tmp_frag_dir_for</code>, <code>extract_table_source</code>, <code>read_csv_rows</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Top-level design choices</strong>  <br><br> • Prefer project-provided <code>io_utils</code> helpers when available.  <br> • Provide robust fallbacks that use same-directory temp files and <code>os.replace</code> for atomicity.  <br> • Keep fallback implementations cross-platform (POSIX and Windows) by using <code>os.replace</code>.  <br> • Provide safe directory creation with race-condition resistance.  <br> • Provide small CSV/TSV detection and sampling utilities suitable for previewing pasted or uploaded tables. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Atomic write (<code>_default_write_atomic</code>) behavior</strong>  <br><br> • Create a NamedTemporaryFile in the target directory with <code>delete=False</code>.  <br> • Call user-supplied <code>writer(tf)</code> to write to the temp file.  <br> • <code>flush()</code> and <code>os.fsync()</code> attempted best-effort to persist file contents.  <br> • <code>os.replace(tmp, path)</code> performs an atomic swap.  <br> • On error, attempt to unlink tmp and raise the exception.  <br><br> <strong>Rationale:</strong> Writing temp file in same directory ensures <code>os.replace</code> is atomic on same filesystem. <code>fsync</code> increases durability but failures on <code>fsync</code> are non-fatal. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Stream write alias (<code>_default_stream_write</code>)</strong>  <br><br> Thin wrapper around <code>_default_write_atomic</code>. Maintains API symmetry expected by callers that provide stream-style writer callbacks. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Exported dispatchers</strong>  <br><br> <code>_atomic_write</code>, <code>_atomic_stream_write</code>, and <code>_ensure_dir</code> are assigned to either project-supplied implementations or default fallbacks. This allows the module to integrate into projects that provide optimized versions while remaining self-contained for other contexts. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Directory utility <code>_ensure_dir_path</code></strong>  <br><br> Tries <code>Path.mkdir(parents=True, exist_ok=True)</code> and falls back to <code>os.makedirs</code> on error. Logs debug on failure. Handles typical race conditions where another process created the directory concurrently. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Temporary fragment directory (<code>tmp_frag_dir_for</code>)</strong>  <br><br> Produces a deterministic per-run fragment dir name <code>.frags_&lt;timestamp_ms&gt;_&lt;pid&gt;_&lt;uuid8&gt;</code>. Ensures directory exists. This naming helps avoid collisions across runs and enables easy cleanup. Falls back to <code>out_dir</code> if creation fails. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Robustness & failure semantics</strong>  <br><br> • Most IO failures are logged and re-raised (atomic writes) or caught and logged (directory creation).  <br> • Temp file cleanup attempted on failure.  <br> • Caller should handle raised exceptions for writes to detect persistent failures. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Encoding detection (<code>_detect_encoding_from_bytes</code>)</strong>  <br><br> • Quick heuristic: detect BOM <code>\xef\xbb\xbf</code> as <code>utf-8-sig</code>.  <br> • Try <code>utf-8</code>, <code>utf-8-sig</code>, then <code>latin-1</code> by attempting decode.  <br><br> <strong>Strengths:</strong> Practical for many pasted/uploaded files.  <br><br> <strong>Limitations:</strong> Does not detect other encodings (e.g., cp1252) explicitly, but <code>latin-1</code> fallback prevents decode exceptions and preserves byte values. Consider using <code>chardet</code>/<code>charset-normalizer</code> for broader coverage if needed. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CSV dialect detection (<code>_detect_csv_dialect</code>)</strong>  <br><br> • Uses <code>csv.Sniffer().sniff</code> on progressively smaller prefixes (full, 16KB, 1KB, 256B) to increase chance of success while avoiding huge samples.  <br> • Fallback dialect class defined if sniffing fails.  <br><br> <strong>Notes:</strong> <code>sniffer.sniff</code> can be brittle for short or noisy samples; the fallback dialect ensures safe defaults. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Table source extraction (<code>extract_table_source</code>)</strong>  <br><br> <strong>Purpose:</strong> Provide survey metadata and a small preview from a source that can be a path, bytes, file-like object, or raw string bytes.  <br><br> <strong>Returned keys:</strong> <code>source_path</code>, <code>exists</code>, <code>size</code>, <code>encoding</code>, <code>delimiter</code>, <code>quotechar</code>, <code>headers</code>, <code>sample_rows</code>, <code>sha256</code> (optional).  <br><br> <strong>Flow:</strong>  <br> 1. Read up to <code>sample_size</code> bytes from the source using robust reading for file path, bytes, or file-like object.  <br> 2. Detect encoding using <code>_detect_encoding_from_bytes</code>.  <br> 3. Decode sample_text.  <br> 4. Detect dialect via <code>_detect_csv_dialect</code>.  <br> 5. Use <code>csv.Sniffer().has_header</code> to guess header presence with fallback to False.  <br> 6. Use <code>csv.reader</code> with detected dialect to parse up to <code>max_sample_rows</code>.  <br> 7. If header present, set <code>headers</code> to first row and <code>sample_rows</code> to subsequent rows.  <br> 8. Optionally compute SHA-256 of full file or provided bytes if <code>compute_hash=True</code>.  <br><br> <strong>Strengths:</strong> Good for preview UI where file might be large and only sample is required. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CSV reading utility (<code>read_csv_rows</code>)</strong>  <br><br> Reads up to <code>max_rows</code> from a CSV file path safely. Detects encoding from sample and selects dialect when <code>delimiter</code> is <code>None</code>. Uses <code>csv.reader</code> to parse full rows reliably including quoted fields. Returns list-of-lists. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Edge cases & limitations - CSV/encoding</strong>  <br><br> 1. Detection heuristics may mis-detect widely varying CSVs, e.g., files with embedded newlines in quoted cells or inconsistent delimiters.  <br> 2. <code>_detect_encoding_from_bytes</code> does not try windows-1252; some files from Excel on Windows may be mis-decoded though <code>latin-1</code> will still preserve bytes.  <br> 3. <code>csv.Sniffer().has_header</code> is heuristic and can be unreliable. Where correctness matters, provide explicit <code>delimiter</code> and <code>has_header</code> flags to callers.  <br> 4. For very large files computing full SHA-256 (<code>compute_hash=True</code>) reads entire file which is I/O heavy. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Atomicity and platform concerns</strong>  <br><br> 1. <code>os.replace</code> on POSIX is atomic if source and destination are on same filesystem. Same-directory temp ensures this.  <br> 2. On Windows <code>os.replace</code> is supported. Using same-directory tmp is important to avoid cross-device rename errors.  <br> 3. <code>NamedTemporaryFile(..., delete=False, dir=...)</code> is used to put tmp file in same dir. On Windows, opening the same file by another process while it's open may behave differently than POSIX; solution used is close before replace.  <br> 4. <code>os.fsync</code> best-effort improves durability for local crashes but not strictly necessary for atomic replace; still good for safety. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Race conditions & concurrency</strong>  <br><br> 1. Directory create uses <code>exist_ok=True</code>; this tolerates concurrent creation.  <br> 2. Atomic write still risks a small race where two processes write to the same final path concurrently; the last <code>os.replace</code> wins. If this is unacceptable consider advisory lock or pid-unique filenames then final <code>rename</code> under lock.  <br><br> <strong>Recommendation:</strong> Provide optional lock file mechanism or require an external coordinator when multiple processes write to same destination. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security considerations</strong>  <br><br> 1. <code>extract_table_source</code> accepts path-like inputs and will open them; ensure callers validate user-supplied paths to prevent unintended file reads (path traversal).  <br> 2. The module does not execute file content; risk is limited to reading and writing files.  <br> 3. If file contents are later embedded into HTML, ensure proper sanitization at rendering step. </td></tr><tr><td data-label="Technical Breakdown"> <strong>API ergonomics & return contracts</strong>  <br><br> • Exports are named with leading underscores for atomic functions (<code>_atomic_write</code>) but intended to be imported by other render modules.  <br> • <code>extract_table_source</code> returns a dict with predictable keys; consider documenting shape in a module docstring or typed NamedTuple.  <br> • <code>read_csv_rows</code> raises <code>FileNotFoundError</code> if path missing — appropriate and explicit. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling style</strong>  <br><br> • Atomic write logs and re-raises exceptions to let callers determine failure handling.  <br> • Directory creation logs debug traces but does not raise, making it tolerant.  <br> • CSV parsing functions log exceptions and fall back where possible.  <br><br> <strong>Suggestion:</strong> Provide optional <code>strict</code> parameter for callers that prefer failures to be raised vs tolerant fallback. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Test matrix recommendations</strong>  <br><br> Unit tests to include:  <br> 1. Atomic write success writes file and remove tmp.  <br> 2. Atomic write failure cleans up tmp and raises.  <br> 3. <code>tmp_frag_dir_for</code> creates unique directories across runs and respects out_dir.  <br> 4. <code>_detect_encoding_from_bytes</code> handles BOM, UTF-8, Latin-1 and fallback.  <br> 5. <code>_detect_csv_dialect</code> correctly sniffs comma, tab, semicolon, and colon variants under multiple sample sizes.  <br> 6. <code>extract_table_source</code> with path, bytes, and file-like object, with and without <code>compute_hash</code>.  <br> 7. <code>read_csv_rows</code> respects <code>max_rows</code> and decodes files with different encodings.  <br> 8. Concurrency test: multiple threads/processes writing to distinct target paths do not collide; concurrent writes to same path produce deterministic final state or proper locks if implemented. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational recommendations</strong>  <br><br> 1. For high-volume workloads, consider limiting <code>fsync</code> frequency or making it configurable because <code>fsync</code> can be slow on certain disks.  <br> 2. For deployments that require reproducible tmp dirs across restarts, allow caller-provided <code>run_id</code> to incorporate into <code>tmp_frag_dir_for</code> naming.  <br> 3. Provide an optional <code>max_sample_size</code> guard for <code>extract_table_source</code> to avoid reading very large samples unnecessarily. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Edge-case bug risks & mitigations</strong>  <br><br> 1. <code>NamedTemporaryFile</code> with <code>delete=False</code> ensures file closed before <code>os.replace</code>, but if writer raises and leaves tmp present, code attempts unlink; ensure exception re-raise doesn't swallow original stack. Current code re-raises after cleanup which is correct.  <br> 2. <code>_detect_csv_dialect</code> returns on first successful <code>sniffer.sniff</code>; if <code>candidate</code> too small it may guess poorly; mitigate by increasing min prefix for small files or explicitly testing for uniform delimiter counts across lines.  <br> 3. <code>read_csv_rows</code> uses <code>csv.get_dialect(&quot;excel&quot;)</code> when <code>delimiter</code> provided; better to construct <code>csv.reader</code> with explicit delimiter and quotechar to honor caller input. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security hardening checklist</strong>  <br><br> 1. Validate and sanitize <code>source</code> paths from untrusted callers.  <br> 2. Avoid writing files to world-writable directories without appropriate ACLs.  <br> 3. If integrating with a web-facing UI, ensure fragment files are stored outside webroot or served with strict CSP and proper sanitization. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Backward compatibility & integration notes</strong>  <br><br> • Module tries to import project-provided implementations and defers to them. Document that users providing <code>io_utils</code> should expose <code>_atomic_write</code> or <code>atomic_write</code> and <code>_atomic_stream_write</code> to override defaults.  <br> • Re-exports used by other <code>render</code> modules expect <code>_atomic_write</code> symbol; keep that name stable or provide adapter layer. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance observations</strong>  <br><br> • Small files and preview workloads will be very fast.  <br> • <code>fsync</code> and full-file SHA256 computation are the most expensive operations; make these optional.  <br> • Concurrency performance is limited by IO throughput; thread-based writers are suitable for many small writes; process-based patterns unnecessary here. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Summary & prioritized next steps</strong>  <br><br> <strong>Immediate:</strong>  <br> • Add <code>atomic_write_text</code> convenience wrapper and document it.  <br> • Adjust <code>read_csv_rows</code> to honor explicit <code>delimiter</code> by constructing a <code>csv.reader</code> with given delimiter.  <br><br> <strong>Medium:</strong>  <br> • Add optional integration with <code>chardet</code>/<code>charset-normalizer</code> for encoding detection.  <br> • Provide optional advisory-file locking mechanism for truly concurrent producers.  <br><br> <strong>Long-term:</strong>  <br> • Allow pluggable CSV detection strategies and expose a <code>CSVInspector</code> class for richer previews (types, inferred column types, sample statistics).  <br><br> These changes will make the module safer, more explicit, and easier to integrate in multi-process or user-facing systems. </td></tr></tbody></table></div><div class="row-count">Rows: 25</div></div><div class="table-caption" id="Table11" data-table="Book_8052_11" style="margin-top:2mm;margin-left:3mm;"><strong>Table 11 — core_utils.py</strong></div>
<div class="table-wrapper" data-table-id="table-11"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>File purpose & high-level summary</strong>  <br><br> Provides small, dependable utility functions used across the <code>render</code> package. Focuses on safe/consistent string and path sanitation, lightweight HTML/ID helpers, simple checks for fragment content, and a defensive <code>take-and-stream</code> helper for working with possibly broken iterables. Functions are deliberately minimal so they are safe to call at import time and cheap to execute at runtime. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Audience & intent</strong>  <br><br> These helpers are internal primitives intended for other modules in the <code>render</code> package. They are not designed as end-user APIs. The functions favor fault tolerance over strict validation to keep higher-level rendering code robust in the face of malformed inputs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Module-level characteristics</strong>  <br><br> • Minimal dependencies (re, html, logging, typing).  <br> • No heavy imports to avoid import-time cost.  <br> • Each function guards errors and logs debug traces rather than raising for ordinary input problems.  <br><br> <strong>Implication:</strong> Good for pipelines where inputs may be uncontrolled, but callers that need strict validation must apply additional checks. </td></tr><tr><td data-label="Technical Breakdown"> <strong>_sanitize_id — purpose</strong>  <br><br> Generate a safe HTML <code>id</code> value from arbitrary input. Core responsibilities:  <br> 1. Replace any character that is not alphanumeric, underscore, or dash with <code>-</code>.  <br> 2. Remove leading/trailing <code>-</code>.  <br> 3. Collapse repeated dashes into a single dash.  <br> 4. If result is empty, return <code>id-{idx}</code> fallback.  <br><br> <strong>Why needed:</strong> HTML <code>id</code> attributes must avoid spaces and many punctuation characters. This produces deterministic, URL/selector-safe identifiers derived from titles or keys. </td></tr><tr><td data-label="Technical Breakdown"> <strong>_sanitize_id — correctness details</strong>  <br><br> • Regex: <code>r&#x27;[^a-zA-Z0-9\-_]+&#x27;</code> matches any invalid run and replaces with <code>-</code>.  <br> • Collapsing uses <code>re.sub(r&#x27;-{2,}&#x27;, &#x27;-&#x27;, s)</code> which reduces consecutive dashes produced by replacement.  <br> • Uses <code>str(x or &quot;&quot;)</code> to handle <code>None</code>.  <br><br> <strong>Edge cases & notes:</strong>  <br> • Input <code>&quot;____&quot;</code> results in <code>&quot;____&quot;</code> since underscore permitted.  <br> • Input with leading numbers is allowed. If you require IDs not to start with digits (for CSS selectors), additional logic needed.  <br> • Unicode characters outside ASCII will be turned into <code>-</code> by the regex; if preserving unicode is desired use <code>\w</code> with <code>re.UNICODE</code> and post-process.  <br> • The fallback uses <code>idx or 0</code> which yields <code>id-0</code> when both None. Consider returning <code>id-&lt;uuid&gt;</code> if collisions are a concern. </td></tr><tr><td data-label="Technical Breakdown"> <strong>_sanitize_id — potential improvements</strong>  <br><br> 1. Optionally normalize unicode via <code>unicodedata.normalize(&#x27;NFKC&#x27;, ...)</code> before regex.  <br> 2. Allow a <code>max_length</code> param to truncate long ids and avoid exceeding HTML attribute length constraints.  <br> 3. Provide <code>prefix</code> param to avoid collisions across different namespaces.  <br> 4. Optionally ensure the ID does not begin with a digit (prefix with <code>id-</code> if needed). </td></tr><tr><td data-label="Technical Breakdown"> <strong>_sanitize_output_path — purpose</strong>  <br><br> Defensive conversion of arbitrary object to a string path that can be used for writing output. Returns <code>str(x)</code> or <code>&quot;output.html&quot;</code> fallback when conversion fails. Useful to avoid crashes in top-level code building output filenames. </td></tr><tr><td data-label="Technical Breakdown"> <strong>_sanitize_output_path — correctness & caveats</strong>  <br><br> • Simple <code>str(x)</code> is typically sufficient for <code>Path</code> and string inputs.  <br> • If <code>x</code> is an object with side-effecting <code>__str__</code>, that side-effect will run. Caller must not pass untrusted objects.  <br> • The fallback <code>&quot;output.html&quot;</code> may silently hide bugs where the caller passed an invalid path. Consider raising or returning a tuple <code>(ok, path)</code> when strictness required. </td></tr><tr><td data-label="Technical Breakdown"> <strong>_sanitize_html_whitelist — purpose & limitations</strong>  <br><br> Minimal pass-through wrapper returning <code>str(s or &quot;&quot;)</code>. The docstring signals a "real" sanitizer lives in <code>sanitize.py</code>. This function exists so other modules can call a harmless function even when a full sanitizer is not available. It intentionally does not attempt to sanitize. </td></tr><tr><td data-label="Technical Breakdown"> <strong>_sanitize_html_whitelist — security note</strong>  <br><br> Do not use this function to sanitize untrusted HTML. It is a placeholder. If output will be rendered in browsers, always run proper sanitization elsewhere, for example using <code>bleach</code> or a project-specific <code>sanitize.py</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>_sri_attr — purpose</strong>  <br><br> Returns the <code> integrity=&quot;... &quot; crossorigin=&quot;anonymous&quot;</code> attribute string for a given resource <code>url</code> if <code>cdn_integrity</code> mapping contains an entry. Designed to be used when generating <code>&lt;link&gt;</code>/<code>&lt;script&gt;</code> tags with known SRI values. </td></tr><tr><td data-label="Technical Breakdown"> <strong>_sri_attr — behavior & usage</strong>  <br><br> • Accepts <code>cdn_integrity</code> typically as a dict mapping relative URLs or keys to integrity strings.  <br> • If mapping present and key matches exactly, returns attribute string; otherwise returns empty string.  <br><br> <strong>Caveats:</strong>  <br> • Matching is exact. For fingerprinted filenames or absolute CDN URLs, ensure keys match or include a resolution step before calling <code>_sri_attr</code>.  <br> • No validation is performed on the integrity value; assume it is pre-computed and trusted. </td></tr><tr><td data-label="Technical Breakdown"> <strong>_frag_contains_rows — purpose</strong>  <br><br> Quick heuristic to determine whether an HTML fragment contains table rows by searching for <code>&lt;tbody&gt;&lt;tr</code> pattern (case-insensitive). Intended for UI decisions (e.g., show row-count controls only when fragments include rows). </td></tr><tr><td data-label="Technical Breakdown"> <strong>_frag_contains_rows — limitations & alternatives</strong>  <br><br> • Very lightweight and fast.  <br> • May miss tables that omit <code>&lt;tbody&gt;</code> (browsers may insert tbody automatically), or where there is whitespace/newline between <code>&lt;tbody&gt;</code> and <code>&lt;tr&gt;</code>; current regex allows whitespace via <code>\s*</code>.  <br> • May be fooled by commented-out <code>&lt;tbody&gt;</code> sequences or by strings inside <code>&lt;code&gt;</code> elements.  <br> • If stronger guarantees needed, use an HTML parser and check for <code>table &gt; tbody &gt; tr</code> nodes (e.g., BeautifulSoup). </td></tr><tr><td data-label="Technical Breakdown"> <strong>_frag_contains_rows — improvement ideas</strong>  <br><br> 1. Accept an optional <code>use_parser: bool</code> parameter to run a safe parser when exactness required.  <br> 2. Expand regex to allow attribute-containing tags like <code>&lt;tbody class=&quot;...&quot;&gt;\s*&lt;tr</code> (current pattern already matches because <code>&lt;tbody&gt;</code> is literal; improvement: search <code>&lt;tbody\b[^&gt;]*&gt;\s*&lt;tr\b</code>).  <br> 3. Return row count if requested instead of boolean. </td></tr><tr><td data-label="Technical Breakdown"> <strong>_take_and_stream — purpose</strong>  <br><br> Non-destructive helper that attempts to take the first <code>n</code> elements from an iterable and return <code>(list_of_taken, remainder_iter)</code>. Designed to be defensive when the provided <code>rows_iterable</code> may be non-sequence, may raise on iteration, or may be a generator that cannot be re-iterated. This function is used when callers need a small sample but still want to continue streaming the remainder. </td></tr><tr><td data-label="Technical Breakdown"> <strong>_take_and_stream — behavior details</strong>  <br><br> 1. Attempt to get an iterator via <code>iter(rows_iterable)</code>.  <br> 2. Attempt to <code>next(it)</code> up to <code>n</code> times, accumulating into <code>buf</code>.  <br> 3. Returns <code>(buf, it)</code> where <code>it</code> is the original iterator positioned after the taken items.  <br> 4. If first attempt fails (e.g., <code>next</code> raises non-StopIteration exception), the function falls back to converting the entire iterable to a sequence <code>seq = list(rows_iterable)</code>, then returns first <code>n</code> and <code>iter(seq[len(buf):])</code>.  <br> 5. If conversion fails, returns <code>([], iter([]))</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>_take_and_stream — correctness & complexity</strong>  <br><br> • Works with any iterator and preserves remaining elements for consumption by consumers.  <br> • Complexity: O(n) for small <code>n</code> when iterator is healthy.  <br> • Fallback uses O(len(seq)) memory which can be expensive if the iterable is large. This fallback only runs when the initial iteration raised unexpected exceptions, which should be rare.  <br><br> <strong>Caveat:</strong> If <code>rows_iterable</code> is itself a sequence (like list), <code>iter()</code> will produce an iterator that supports stepping; <code>it</code> will be the iterator object — this function does not attempt to preserve random-access indexing, it returns plain iterator. </td></tr><tr><td data-label="Technical Breakdown"> <strong>_take_and_stream — potential improvements</strong>  <br><br> 1. Accept an optional <code>max_fallback_size</code> parameter to refuse converting very large iterables to a list.  <br> 2. Use <code>itertools.tee</code> to produce two independent iterators when safe and when <code>rows_iterable</code> is an iterator (but note <code>tee</code> memory tradeoffs).  <br> 3. Provide a documented contract about whether the returned iterator supports <code>len()</code> or indexing (it does not).  <br> 4. Consider returning a generator wrapper that yields from an internal buffer first then yields from the original iterator to avoid exposing the original iterator directly. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Logging & observability</strong>  <br><br> • Module logger is <code>&quot;render.core_utils&quot;</code>.  <br> • On errors functions use <code>logger.debug</code> to record exceptions.  <br> • This keeps high-level logs clean but may hide frequent issues if logging is not inspected at debug level.  <br><br> <strong>Recommendation:</strong> For user-facing errors consider <code>logger.warning</code> when fallback behavior may affect correctness. Keep <code>debug</code> for purely diagnostic information. </td></tr><tr><td data-label="Technical Breakdown"> <strong>API surface & usage patterns</strong>  <br><br> • Functions are small, side-effect free (no file IO).  <br> • Safe for import-time execution.  <br> • Typical use: generate stable <code>id</code> attributes for headings, sanitize output path before writing files, quickly inspect HTML fragments, and take a preview sample from row iterables for alignment detection or type heuristics. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Test coverage matrix (recommended)</strong>  <br><br> Unit tests to include:  <br> 1. <code>_sanitize_id</code> behavior with: <code>None</code>, empty string, strings with punctuation, unicode characters, very long strings, strings starting with digits, strings already safe.  <br> 2. <code>_sanitize_output_path</code> with normal paths, <code>Path</code> objects, and objects whose <code>__str__</code> raises.  <br> 3. <code>_sanitize_html_whitelist</code> should return <code>&#x27;&#x27;</code> for <code>None</code>, and <code>str(s)</code> otherwise.  <br> 4. <code>_sri_attr</code> with mapping present/absent and keys that differ by absolute/relative paths.  <br> 5. <code>_frag_contains_rows</code> with fragments that: include <code>&lt;tbody&gt;&lt;tr</code>, include <code>&lt;table&gt;&lt;tr&gt;</code> but no tbody, include commented-out matches, include <code>&lt;tbody    &gt;&lt;tr&gt;</code>, include code blocks containing literal <code>&lt;tbody&gt;&lt;tr</code>.  <br> 6. <code>_take_and_stream</code> with: finite lists, generators, iterators that raise on 1st iteration, and iterables which are expensive to convert (simulate large sequence to ensure fallback behavior is limited or controlled).  <br><br> Include property tests (Hypothesis) to verify round-trips and invariants for <code>_take_and_stream</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance & complexity</strong>  <br><br> • All functions are O(len(input)) for small inputs or O(n) for <code>n</code> being small sample size.  <br> • No heavy allocations except when fallback forces full materialization in <code>_take_and_stream</code>.  <br> • Suitable for high-performance loops because string regex operations are efficient for typical lengths (IDs, small fragments). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security considerations</strong>  <br><br> • None of these helpers execute or render untrusted data. However <code>str()</code> calls on arbitrary objects may invoke user code (<code>__str__</code>) that could be malicious if objects are untrusted.  <br> • <code>_sanitize_html_whitelist</code> explicitly does not sanitize HTML; never substitute for a proper sanitizer.  <br> • When using <code>_sanitize_output_path</code>, validate the returned path before writing to disk to avoid path traversal. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Backward compatibility & extension notes</strong>  <br><br> • Keep function names stable; other modules depend on these names.  <br> • If additional behavior is required (e.g., more advanced id sanitation), add new functions with explicit names (e.g., <code>_sanitize_id_strict</code>) rather than changing existing semantics. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Small, concrete improvement suggestions</strong>  <br><br> 1. Add type hints to all function signatures to improve IDE discoverability and static checking.  <br> 2. For <code>_sanitize_id</code>, add optional parameters: <code>prefix: str = &quot;id&quot;</code>, <code>max_len: Optional[int] = 64</code>, and <code>ensure_leading_alpha: bool = False</code>.  <br> 3. For <code>_sanitize_output_path</code>, add behavior to optionally validate the path against allowed directories and return <code>(ok, path)</code> tuple when invalid.  <br> 4. For <code>_frag_contains_rows</code>, use a slightly more robust regex: <code>r&#x27;&lt;tbody\b[^&gt;]*&gt;\s*&lt;tr\b&#x27;</code> to match attributes inside <code>&lt;tbody&gt;</code>.  <br> 5. For <code>_take_and_stream</code>, consider using <code>itertools.tee</code> when the input is an iterator and <code>n</code> is small to avoid full-list fallback memory costs. Add a <code>max_memory_fallback</code> parameter to cap memory usage. </td></tr><tr><td data-label="Technical Breakdown"> <strong>When to change semantics vs add functions</strong>  <br><br> • Maintain current permissive semantics for backward compatibility.  <br> • Add stricter variants when callers need more validation.  <br> • Example: add <code>_sanitize_id_strict(...)</code> that enforces leading alpha, lowercasing, and hyphen-delimited words. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Summary</strong>  <br><br> <code>render.core_utils</code> is a compact, well-scoped utility module that provides safe defaults and defensive behavior suitable for use in a rendering pipeline where inputs can be unpredictable. It favors robustness and low cost. For callers that demand stricter validation, sanitization, or different id conventions, add dedicated variants rather than altering the current helpers. Apply the suggested small improvements to increase robustness (unicode normalization, more robust regex for tbody, optional strict modes) and add tests to lock in behavior. </td></tr></tbody></table></div><div class="row-count">Rows: 28</div></div><div class="table-caption" id="Table12" data-table="Book_8052_12" style="margin-top:2mm;margin-left:3mm;"><strong>Table 12 — io_utils.py</strong></div>
<div class="table-wrapper" data-table-id="table-12"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>File purpose & summary</strong>  <br><br> Implements small, focused file I/O utilities with an emphasis on safe atomic writes. Exports: <code>read_file</code>, <code>write_file</code>, <code>ensure_dir</code>, and <code>_atomic_stream_write</code>. Designed to be a lightweight, dependency-free utility for projects that need reliable disk writes and simple directory management. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API & contracts</strong>  <br><br> • <code>read_file(path) -&gt; str</code> — read entire file decoded as UTF-8; raises <code>IOError</code> on failure.  <br> • <code>write_file(path, content) -&gt; None</code> — writes UTF-8 content, ensures parent directories exist, non-atomic. Raises <code>IOError</code> on failure.  <br> • <code>ensure_dir(path) -&gt; None</code> — ensures directory exists; raises <code>IOError</code> if a non-directory exists at path or on failure to create.  <br> • <code>_atomic_stream_write(path, write_fn) -&gt; None</code> — atomically write by streaming into a same-dir temp file then <code>os.replace</code>. Raises <code>IOError</code> on failure. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Atomic write mechanics</strong>  <br><br> 1. Use <code>tempfile.mkstemp(dir=target.parent, prefix=f&quot;.{target.name}.&quot;, suffix=&quot;.tmp&quot;)</code> to create a temp file in the same directory.  <br> 2. Close the low-level fd then reopen temp file in text mode for writing.  <br> 3. Call <code>write_fn(f)</code> to let caller stream content.  <br> 4. Best-effort <code>f.flush()</code> and <code>os.fsync(f.fileno())</code> to persist data.  <br> 5. <code>os.replace(tmp_path, target)</code> performs atomic swap on same filesystem.  <br> 6. On any exception, attempt to remove tmp and raise <code>IOError</code>.  <br><br> <strong>Implication:</strong> Guarantees atomic visibility of either old or new full file content when target and temp are on same device. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Durability & fsync</strong>  <br><br> <code>fsync</code> is attempted but errors are ignored. This is a pragmatic choice: it improves crash durability when it succeeds but avoids hard failures on filesystems where <code>fsync</code> may error. Make <code>fsync</code> optional/configurable if caller needs strict durability semantics. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Temp file placement & atomicity constraints</strong>  <br><br> Creating temp file in the same directory ensures <code>os.replace</code> will be atomic. If <code>target.parent</code> is on a different device or not writable, <code>mkstemp</code> will fail. The code closes the raw FD immediately to avoid Windows locking issues when reopening in text mode. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling & exceptions</strong>  <br><br> All I/O errors are wrapped into <code>IOError</code> with explanatory message and original exception chained. Temporary file cleanup is attempted on failure. Caller must catch <code>IOError</code> to handle disk problems. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Directory utilities (<code>ensure_dir</code>)</strong>  <br><br> 1. Verifies if path exists and is not a dir, then raises an explicit <code>IOError</code>.  <br> 2. Uses <code>mkdir(parents=True, exist_ok=True)</code> which tolerates concurrent creation.  <br><br> This is strict and appropriate for callers that must not override files. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Simple write (<code>write_file</code>) semantics</strong>  <br><br> - Non-atomic convenience writer.  <br> - Ensures parent directory exists via <code>mkdir(..., exist_ok=True)</code> then writes with UTF-8 encoding.  <br> - Documented note: for critical writes use <code>_atomic_stream_write</code>.  <br><br> <strong>Risk:</strong> callers might use <code>write_file</code> for important files. Encourage code paths that require atomicity to call <code>_atomic_stream_write</code> or wrapper <code>atomic_write_text</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Read semantics (<code>read_file</code>)</strong>  <br><br> - Simple UTF-8 read.  <br> - Raises <code>IOError</code> on failure with original exception chained.  <br><br> <strong>Limitation:</strong> No <code>errors</code> param. Files encoded other than UTF-8 will raise unless caller prepares content; consider a safe fallback or <code>encoding</code> parameter if necessary. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Cross-platform considerations</strong>  <br><br> - Use of <code>mkstemp</code> plus <code>os.replace</code> is portable across POSIX and Windows when temp file is in same directory.  <br> - Closing the fd before reopening avoids Windows sharing violations.  <br> - <code>fsync</code> semantics differ by platform and filesystem; handled best-effort. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance characteristics</strong>  <br><br> - <code>_atomic_stream_write</code> streams data; memory usage depends only on what <code>write_fn</code> buffers.  <br> - <code>fsync</code> can be slow on some media; invoked once per file.  <br><br> For many small writes consider batching or making fsync optional. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security considerations</strong>  <br><br> - Temp files created in target directory are visible to other processes until replaced. Use directory permissions to restrict access if sensitive.  <br> - Caller-supplied <code>write_fn</code> must not execute untrusted code.  <br> - No sanitization of paths done here; caller should validate untrusted paths to prevent directory traversal. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Robustness & race conditions</strong>  <br><br> - Directory creation uses <code>exist_ok=True</code> which tolerates concurrent creators.  <br> - Concurrent atomic writes to the same target from multiple processes can race; the last <code>os.replace</code> wins. For deterministic ownership consider advisory locks or pid-unique staging plus coordinated rename. </td></tr><tr><td data-label="Technical Breakdown"> <strong>API ergonomics suggestions</strong>  <br><br> 1. Add a small convenience wrapper <code>atomic_write_text(path, text)</code> that calls <code>_atomic_stream_write</code>.  <br> 2. Expose an <code>atomic_write_bytes</code> variant for binary content.  <br> 3. Make <code>_atomic_stream_write</code> public without underscore if intended for external use.  <br> 4. Allow optional params: <code>sync=True/False</code>, <code>tmp_prefix=None</code>, <code>mode=&#x27;w&#x27;</code> to increase flexibility. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing recommendations</strong>  <br><br> Unit tests to include:  <br> 1. Successful atomic write: verify tmp removed and final file contains written content.  <br> 2. Simulated write_fn exception: tmp cleaned up and <code>IOError</code> raised.  <br> 3. Concurrent writers: last-writer-wins semantics validated or use locking tests.  <br> 4. Windows-specific behavior: ensure reopen after <code>mkstemp</code> works and no sharing violations occur.  <br> 5. <code>ensure_dir</code> on existing file path raises as specified.  <br> 6. <code>read_file</code> reads UTF-8; consider test for non-UTF8 to assert raising behavior. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Small, high-leverage improvements</strong>  <br><br> 1. Add <code>atomic_write_text(path, text)</code> wrapper:  <br> &nbsp;&nbsp;<code>def atomic_write_text(path, text): _atomic_stream_write(path, lambda f: f.write(text))</code>  <br> 2. Make <code>fsync</code> configurable via parameter <code>sync=True</code>.  <br> 3. Add <code>encoding</code> parameter to <code>read_file</code> and <code>write_file</code> for flexibility.  <br> 4. Return path on success from <code>_atomic_stream_write</code> to aid callers.  <br> 5. Add context-manager helper <code>atomic_open(path, mode=&#x27;w&#x27;)</code> that yields file-like object writing into tmp and performs replace on exit.  <br> 6. Consider adding <code>tmp_dir_fallback</code> logic when <code>target.parent</code> is non-writable. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Integration notes</strong>  <br><br> - This module is a good low-level primitive for higher-level asset and fragment writers.  <br> - Higher layers should call <code>_atomic_stream_write</code> for critical outputs and keep <code>write_file</code> for convenience/debug outputs.  <br> - If project provides an <code>io_utils</code> override, this module will be used indirectly; keep function names stable. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Behavioral invariants to document</strong>  <br><br> 1. <code>_atomic_stream_write</code> guarantees atomic replacement only when <code>target.parent</code> is on same filesystem and writable.  <br> 2. <code>write_file</code> is not atomic.  <br> 3. All public functions raise <code>IOError</code> on failure.  <br> 4. Temporary files follow naming <code>.{target.name}.{random}.tmp</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Summary</strong>  <br><br> The module correctly implements practical, portable atomic writes and minimal file utilities. It favors simplicity and clear failure semantics. Add small conveniences (atomic_write_text, optional fsync toggle, encoding params) and test coverage for concurrent and platform-specific behaviors to make it production hardened. </td></tr></tbody></table></div><div class="row-count">Rows: 19</div></div><div class="table-caption" id="Table13" data-table="Book_8052_13" style="margin-top:2mm;margin-left:3mm;"><strong>Table 13 — markdown.py</strong></div>
<div class="table-wrapper" data-table-id="table-13"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>File & purpose (overview)</strong>  <br><br> Implements a conservative, single-file Markdown-to-HTML converter tailored for rendering tables and inline content safely. Goals: preserve underscores in plain words, use <code>*</code> for emphasis only, stash code blocks and inline code, detect and render pipe-tables and CSV blocks outside fenced code, sanitize output with a small allowlist, and offer an optional in-memory LRU cache and a pluggable <code>MarkdownRenderer</code> that uses <code>python-markdown</code> when available. </td></tr><tr><td data-label="Technical Breakdown"> <strong>High-level architecture</strong>  <br><br> • Preprocessing: normalize whitespace/typography, stash code blocks/inline code, stash table/CSV blocks.  <br> • Cell-level inline rendering: <code>_render_cell_inline</code> handles code spans, emphasis, underscore behavior, and HTML escaping for <code>&lt;td&gt;/&lt;th&gt;</code> contexts.  <br> • Table detection and rendering: <code>_stash_tables</code> finds contiguous pipe-table blocks and CSV-like blocks and replaces them with placeholders whose HTML is generated by <code>_render_table_block</code> / <code>_render_csv_block</code>.  <br> • Primary conversion: attempt <code>MarkdownRenderer</code> (python-markdown) path first; if unavailable or failing, fall back to <code>_fallback_markdown_to_html</code>.  <br> • Postprocessing: sanitize via <code>_sanitize_html</code>, enforce link rel attributes via <code>_enforce_link_rel</code>, restore code/table placeholders, and optionally cache results. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Sanitization approach</strong>  <br><br> • <code>_sanitize_html</code> is an allowlist sanitizer. It:  <br> 1. removes dangerous tags and content (script, iframe, object, embed, form, input, button, svg, meta, link),  <br> 2. strips event handler attributes (<code>on*</code>),  <br> 3. only allows limited tags (<code>div, p, br, strong, em, code, pre, ul, ol, li, table, thead, tbody, tr, th, td, a, span, sub, sup, kbd, u</code>),  <br> 4. only preserves safe attributes: <code>class</code>, <code>id</code>, and <code>data-*</code>, and for <code>&lt;a&gt;</code> allows safe <code>href</code> and <code>title</code> via <code>_is_safe_url</code>.  <br><br> <strong>Design tradeoff:</strong> lightweight and fast, but not a full HTML sanitizer. Good for controlled inputs; not a drop-in replacement for hardened sanitizers like <code>bleach</code> when inputs are fully untrusted. </td></tr><tr><td data-label="Technical Breakdown"> <strong>URL safety (<code>_is_safe_url</code>)</strong>  <br><br> • Rejects <code>javascript:</code> scheme.  <br> • Allows <code>http(s)</code>, <code>mailto:</code>, relative paths (<code>/</code>, <code>#</code>), and protocol-relative (<code>//</code>).  <br> • Validates using a permissive URL charset regex for safety.  <br><br> <strong>Edge cases:</strong> Data URLs are disallowed. If data URIs must be supported, add explicit whitelist. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Link hardening (<code>_enforce_link_rel</code>)</strong>  <br><br> • Adds <code>rel=&quot;noopener noreferrer&quot;</code> to external links (http, https, or protocol-relative) if <code>rel</code> absent.  <br> • Operates on sanitized HTML and only touches <code>&lt;a ... href=&quot;...&quot;&gt;</code> patterns.  <br><br> <strong>Note:</strong> Does not rewrite <code>target</code> attributes. If <code>target=&quot;_blank&quot;</code> enforcement is needed, add logic. </td></tr></tbody></table></div><div class="row-count">Rows: 5</div></div><div class="table-caption" id="Table14" data-table="Book_8052_14" style="margin-top:2mm;margin-left:3mm;"><strong>Table 14 — sanitize.py</strong></div>
<div class="table-wrapper" data-table-id="table-14"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>File purpose & summary</strong>  <br><br> Implements HTML sanitization utilities for the renderer. Primary export: <code>sanitize_html(html_text: str, allow_tables: bool = False) -&gt; str</code>. Goals: safely allow a small set of HTML tags and attributes, prefer <code>bleach</code> if available, fallback to an <code>HTMLParser</code>-based cleaner otherwise, neutralize script tags outside <code>&lt;pre&gt;</code>/<code>&lt;code&gt;</code>, and provide conservative defaults (notably omitting <code>&lt;br&gt;</code> from allowed tags). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API & contract</strong>  <br><br> • <code>sanitize_html(html_text, allow_tables=False) -&gt; str</code> — returns sanitized HTML or empty string for non-strings.  <br> • <code>is_safe_url(url) -&gt; bool</code> — checks allowed URL schemes and strict <code>data:image</code> base64 for images.  <br> • Internal helpers exported implicitly: <code>bleach_clean</code>, <code>fallback_clean</code>.  <br><br> <strong>Behavioral guarantees:</strong> Removes disallowed tags and attributes; preserves code/pre content (no script neutralization inside code/pre); neutralizes <code>&lt;script&gt;</code> tokens outside code blocks. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Allowed tags & attributes (defaults)</strong>  <br><br> • <code>ALLOWED_TAGS</code>: conservative set including textual, list, code, details/summary and table tags. Notably <code>&lt;br&gt;</code> is omitted by design.  <br> • <code>ALLOWED_ATTRIBUTES</code>: wildcard <code>*</code> includes <code>id, dir, scope, class, title, role, aria-*, aria-hidden, data-*</code>. <code>a</code> allows <code>href,title,rel,target</code>. <code>img</code> allows <code>src,alt,title,width,height</code>.  <br> • <code>ALLOWED_PROTOCOLS</code>: <code>http,https,mailto,data</code> (data only allowed for images by pattern). </td></tr><tr><td data-label="Technical Breakdown"> <strong>URL validation</strong>  <br><br> • <code>is_safe_url</code> uses <code>urlparse</code>.  <br> • Allows relative URLs (no scheme), <code>http</code>, <code>https</code>, <code>mailto</code>.  <br> • Allows <code>data:</code> only if matches <code>IMG_DATA_MIME</code> (strict base64 pattern limited to common image MIME types).  <br><br> <strong>Note:</strong> Data URIs other than validated image forms are rejected. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Primary implementation paths</strong>  <br><br> 1. <strong>Bleach path (preferred)</strong> — <code>bleach_clean</code> calls <code>bleach.clean</code> with configured tags, attributes, protocols, <code>strip=True</code>. Then runs <code>bleach.linkify</code> (best-effort). Finally post-processes start-tags via regex to enforce attribute-level restrictions and escape attribute values.  <br> 2. <strong>Fallback path</strong> — <code>FallbackCleaner</code> (subclass of <code>HTMLParser</code>) reconstructs output, allowing only permitted tags and attributes. It escapes textual data and filters attributes (drops <code>on*</code>, <code>style</code>, enforces <code>is_safe_url</code> for <code>href</code>/<code>src</code>). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Attribute filtering mechanics</strong>  <br><br> • Both paths remove event handler attributes (<code>on*</code>) and <code>style</code>.  <br> • Wildcard attribute patterns like <code>aria-*</code> and <code>data-*</code> are supported.  <br> • Values for <code>href</code>/<code>src</code> are validated via <code>is_safe_url</code> before being re-emitted.  <br><br> <strong>Result:</strong> Strong defense against inline JS via attributes. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Script neutralization strategy</strong>  <br><br> • <code>_neutralize_script_tags_outside_code</code> splits the text on <code>&lt;pre&gt;</code>/<code>&lt;code&gt;</code> sections and replaces <code>&lt;script</code> / <code>&lt;/script</code> tokens with escaped forms (<code>&amp;lt;script</code>, <code>&amp;lt;/script</code>) only in non-code parts.  <br> • Applied after bleach/fallback cleaning to catch cases where raw <code>script</code> tokens survive or were re-introduced.  <br><br> <strong>Rationale:</strong> Avoids mangling literal examples in code blocks while ensuring active script tags cannot execute. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Regex-based post-processing (bleach path)</strong>  <br><br> • <code>START_TAG_RE</code> locates opening tags. <code>_sanitize_tag</code> then parses attribute pairs conservatively and reconstructs a safe start-tag containing only allowed attributes sorted and escaped.  <br> <strong>Risk & limitations:</strong> Regex tag parsing is pragmatic but brittle for very malformed HTML. Bleach output tends to be well-formed so this is practical. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Fallback HTMLParser cleaner details</strong>  <br><br> • <code>FallbackCleaner</code> preserves only tags in <code>allowed</code>.  <br> • Attributes are validated similarly to bleach path; text nodes always escaped.  <br> • On parse failure fallback returns <code>html.escape(html_text)</code> to avoid returning unsafe output. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Table handling toggle</strong>  <br><br> • <code>sanitize_html(..., allow_tables=False)</code> removes table-related tags from <code>allowed</code> set by filtering <code>ALLOWED_TAGS</code> against <code>TABLE_TAGS</code>.  <br> <strong>Use case:</strong> When embedding sanitized fragments into contexts that must not include tables. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security tradeoffs & reasoning</strong>  <br><br> • Conservative defaults minimize XSS surface: omit <code>&lt;br&gt;</code>, strip <code>style</code>, drop <code>on*</code> attributes, strict <code>data:</code> allowance.  <br> • <code>bleach</code> used when available for robust canonicalization.  <br> • Fallback parser is intentionally simpler but safe due to aggressive escaping of text nodes.  <br><br> <strong>Caveat:</strong> The custom regex-based post-processing step should be considered an additional potential risk if HTML is extremely malformed; tests needed. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance characteristics</strong>  <br><br> • Bleach path is fast and optimized for common HTML sizes. Additional regex post-processing adds moderate overhead.  <br> • Fallback HTMLParser is linear and suitable for moderate-sized fragments.  <br><br> <strong>Recommendation:</strong> Use bleach when available for throughput and reliability. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Edge cases & important behaviors</strong>  <br><br> 1. Script tokens embedded inside code/pre are preserved and not neutralized.  <br> 2. Self-closing tags preserved as <code>&lt;tag /&gt;</code> where detected.  <br> 3. Unrecognized or disallowed tags are dropped in the fallback and escaped in bleach path's early phase.  <br><br> <strong>Note:</strong> If downstream relies on <code>&lt;br&gt;</code> inside cells, the omission may change rendering; explicit allowance is required. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing recommendations</strong>  <br><br> Create unit/integration tests covering:  <br> 1. XSS payloads in attributes and tag bodies (script, img with <code>javascript:</code>).  <br> 2. <code>href</code>/<code>src</code> validation including relative URLs, <code>mailto</code>, allowed <code>data:image</code> and disallowed <code>data:</code> forms.  <br> 3. Preservation of code examples: <code>&lt;pre&gt;&lt;code&gt;&amp;lt;script&amp;gt;...</code> should remain unchanged.  <br> 4. Attribute wildcard handling: <code>aria-foo</code>, <code>data-foo</code> pass; <code>style</code>, <code>onerror</code> fail.  <br> 5. Behavior when <code>bleach</code> is present vs absent (consistency checks).  <br> 6. Malformed HTML inputs to validate fallback escape behavior. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Practical improvements & recommendations</strong>  <br><br> 1. Expose a configuration hook to accept a custom <code>allowed_tags</code> / <code>allowed_attrs</code> for different embedding contexts.  <br> 2. Consider adding CSP guidance when embedding sanitized HTML, i.e., recommend <code>Content-Security-Policy: default-src &#x27;self&#x27;</code> for consumers.  <br> 3. Add explicit unit tests for the regex-based tag post-processor to ensure it cannot be tricked by pathological input.  <br> 4. If broad input sources are untrusted, prefer <code>bleach</code> with a well-reviewed configuration.  <br> 5. Optionally allow toggling <code>allow_br</code> if callers need <code>&lt;br&gt;</code> semantics in table cells. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Integration notes</strong>  <br><br> • Intended to be used as the canonical sanitizer before returning or embedding HTML snippets produced by renderer modules (<code>markdown.py</code>, <code>core_*</code>).  <br> • <code>allow_tables</code> should match whether the embedding context permits tables.  <br> • Keep sanitizer as last transformation prior to output to ensure neutralization of any injected tokens. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Limitations & warnings</strong>  <br><br> • This module is safe for typical renderer outputs but is not a substitute for a security review when exposing HTML in high-risk contexts.  <br> • Custom attribute names or additional tags added elsewhere must be registered here to avoid being stripped unexpectedly.  <br> • The fallback is conservative but may alter intended markup by heavy escaping. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Summary</strong>  <br><br> A pragmatic, defense-in-depth sanitizer tailored for this renderer stack. It favors <code>bleach</code> but includes a robust fallback. It neutralizes script tokens outside code blocks, enforces strict attribute and URL policies, and provides an <code>allow_tables</code> toggle. Prioritize tests for the regex post-processing and consider making sanitizer configuration pluggable for different host embedding contexts. </td></tr></tbody></table></div><div class="row-count">Rows: 18</div></div><div class="table-caption" id="Table15" data-table="Book_8052_15" style="margin-top:2mm;margin-left:3mm;"><strong>Table 15 — core_compat.py</strong></div>
<div class="table-wrapper" data-table-id="table-15"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>File purpose & summary</strong>  <br><br> Acts as a thin compatibility re-export layer for the <code>render</code> package. Provides stable public names (<code>render_html</code>, <code>render_table</code>, <code>render_page</code>) so external callers do not need to change import paths if implementation files move. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Exact behavior</strong>  <br><br> 1. Attempt <code>from .core_renderer import render_html</code>.  <br> 2. If that import fails raise <code>ImportError(&quot;core_renderer.render_html is required but not found&quot;)</code> chaining original exception.  <br> 3. Attempt <code>from .core_table import render_table</code>.  <br> 4. If that import fails raise <code>ImportError(&quot;core_table.render_table is required but not found&quot;)</code> chaining original exception.  <br> 5. Create alias <code>render_page = render_html</code>.  <br> 6. Set <code>__all__ = [&quot;render_html&quot;, &quot;render_table&quot;, &quot;render_page&quot;]</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Rationale & benefits</strong>  <br><br> • Keeps public API stable across refactors.  <br> • Avoids changes for consumers when internals move.  <br> • Provides a single import surface for rendering capabilities. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Failure semantics</strong>  <br><br> • Fail-fast on missing critical components by raising <code>ImportError</code> with a clear message and preserved traceback.  <br> • This is appropriate for libraries where these functions are mandatory at import time. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Edge cases & potential issues</strong>  <br><br> 1. <strong>Import-time side effects</strong>: importing <code>core_renderer</code> or <code>core_table</code> may execute heavy module-level logic. This file forces that work at import-time for all consumers.  <br> 2. <strong>Circular imports</strong>: if <code>core_renderer</code> or <code>core_table</code> import from this module (directly or indirectly) a circular import may raise <code>ImportError</code> or provide partially initialized objects.  <br> 3. <strong>Testing friction</strong>: unit tests that patch or monkeypatch <code>core_renderer</code> before import must import after any test-specific patching to avoid the re-export capturing old state.  <br> 4. <strong>No optional fallback</strong>: raises on missing implementation. Some deployments may prefer a graceful fallback (e.g., stub that raises at call-time rather than import-time). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Compatibility & API design notes</strong>  <br><br> • <code>__all__</code> restricts <code>from render.core_compat import *</code> to the intended names.  <br> • The alias <code>render_page</code> preserves historical API. Keep it only if consumers rely on it. Consider deprecation path if you plan to remove it. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing recommendations</strong>  <br><br> 1. Unit tests should assert that <code>core_compat</code> exposes the expected names and that they call through to the real implementations.  <br><br> 2. Add a test that simulates missing <code>core_renderer</code> by temporarily renaming module or manipulating <code>sys.modules</code> and confirm <code>ImportError</code> message is informative.  <br><br> 3. If adopting lazy imports, test that import succeeds even when implementations are temporarily unavailable and that calling functions raises the appropriate runtime error. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Packaging & distribution notes</strong>  <br><br> • Keep this module stable; it is the public surface for renderers.  <br> • When renaming or moving internal modules, update this file only. Consumers should continue to import <code>render.core_compat</code>.  <br> • Document the intended import path in the package README so integrators know the stable API. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security considerations</strong>  <br><br> None specific to this module. Ensure implementations it imports are trusted. Avoid executing untrusted code at import time, which argues for lazy imports if implementations can be user-supplied. </td></tr><tr><td data-label="Technical Breakdown"> <strong>When to keep current strict behavior</strong>  <br><br> • If you want immediate fail-fast detection of missing implementations at import time (good for early CI failure).  <br><br> <strong>When to switch to lazy</strong>  <br><br> • If you need to avoid heavy import-time cost, reduce circular import risk, or allow embedding contexts that import API wrappers before implementations are ready. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Summary</strong>  <br><br> The module correctly provides a small compatibility layer and fail-fast semantics. For robustness and better developer ergonomics consider lazy imports or call-time stubs and add docstrings and tests. Keep the alias <code>render_page</code> only while consumers depend on it and document its lifecycle. </td></tr></tbody></table></div><div class="row-count">Rows: 11</div></div><div class="table-caption" id="Table16" data-table="Book_8052_16" style="margin-top:2mm;margin-left:3mm;"><strong>Table 16 — toc_manager.py</strong></div>
<div class="table-wrapper" data-table-id="table-16"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module purpose (overview)</strong>  <br><br> Inject captions into an HTML document and rebuild a Table of Contents (TOC) from a JSON mapping. Designed for post-processing rendered HTML files where tables have <code>id</code> attributes that correspond to keys in a labels JSON. Uses BeautifulSoup for DOM manipulation and performs file reads/writes on disk. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Primary entry: apply_toc_and_captions(html_path, labels_path)</strong>  <br><br> <strong>Inputs:</strong> <code>html_path</code> (string path to HTML file), <code>labels_path</code> (string path to JSON labels file).  <br> <strong>High-level behavior:</strong>  <br> 1. Validate both paths exist.  <br> 2. Parse HTML with BeautifulSoup (<code>html.parser</code>).  <br> 3. Load <code>labels.json</code> mapping <code>{ table_id: caption_text }</code>.  <br> 4. For each mapping entry: locate element with <code>id=table_id</code>. If found, insert a <code>&lt;caption class=&quot;table-caption&quot;&gt;caption_text&lt;/caption&gt;</code> immediately before the table unless an identical preceding caption is already present.  <br> 5. Build a TOC <code>&lt;ul id=&quot;toc&quot;&gt;</code> containing <code>&lt;li&gt;&lt;a href=&quot;#{table_id}&quot;&gt;caption_text&lt;/a&gt;&lt;/li&gt;</code> entries in the same order as the JSON keys.  <br> 6. Replace existing element with <code>id=&quot;toc&quot;</code> if present; otherwise insert the TOC at the start of <code>&lt;body&gt;</code>.  <br> 7. Write modified HTML back to <code>html_path</code> (overwrites file).  <br><br> <strong>Return/side-effects:</strong> None returned. Writes to disk and prints status messages to stdout. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Dependencies & environment</strong>  <br><br> • Requires <code>bs4</code> (BeautifulSoup).  <br> • Uses <code>pathlib.Path.read_text()</code> / <code>write_text()</code> with UTF-8 encoding.  <br> • Assumes HTML file is well-formed enough for <code>html.parser</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>File existence & early exit behavior</strong>  <br><br> • If <code>html_path</code> does not exist: prints a message and returns without exception.  <br> • If <code>labels_path</code> does not exist: prints a message and returns without exception.  <br><br> <strong>Design note:</strong> Non-exception early-returns are friendly but may hide failures in automated pipelines. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Caption insertion logic (detailed)</strong>  <br><br> • Finds target element via <code>soup.find(id=table_id)</code>. This matches any tag with the specified id, not only <code>&lt;table&gt;</code> elements.  <br> • Checks for an existing caption by looking at <code>table_tag.find_previous_sibling(&quot;caption&quot;)</code> and comparing <code>.text == caption_text</code>.  <br> • If no identical previous sibling caption exists, creates <code>&lt;caption&gt;</code> tag, sets <code>.string = caption_text</code>, adds <code>class=&quot;table-caption&quot;</code>, and inserts it immediately before the found element (<code>table_tag.insert_before(cap)</code>).  <br><br> <strong>Subtleties & edge cases:</strong>  <br> • If the element with <code>id</code> is not a <code>&lt;table&gt;</code> but some container, a <code>&lt;caption&gt;</code> inserted before it is still created (semantically odd).  <br> • <code>find_previous_sibling(&quot;caption&quot;)</code> checks only direct previous sibling; captions that are placed differently (e.g., inside a wrapper or after the table) will not be detected as duplicates.  <br> • Comparison uses raw <code>.text</code> equality; differences in whitespace or HTML-escaped characters will fail the duplicate-detection. </td></tr><tr><td data-label="Technical Breakdown"> <strong>TOC building logic (detailed)</strong>  <br><br> • Builds a new <code>&lt;ul id=&quot;toc&quot;&gt;</code> and appends <code>&lt;li&gt;&lt;a href=&quot;#{id}&quot;&gt;{caption}&lt;/a&gt;&lt;/li&gt;</code> for each entry in <code>captions</code> iterating the JSON object in its native order.  <br> • If an existing element with <code>id=&quot;toc&quot;</code> exists, the code calls <code>.replace_with(toc_ul)</code> to swap it.  <br> • If no existing TOC, inserts the new <code>&lt;ul&gt;</code> at the start of <code>&lt;body&gt;</code> using <code>body.insert(0, toc_ul)</code>.  <br><br> <strong>Subtleties:</strong>  <br> • Insertion at index 0 places the TOC before all body children, including scripts or meta content; consumers might prefer inserting after a header element.  <br> • JSON iteration order matters; on older Python versions where <code>dict</code> ordering is not guaranteed, TOC order could be unpredictable (Python 3.7+ preserves insertion order). </td></tr><tr><td data-label="Technical Breakdown"> <strong>I/O, encoding, and atomicity</strong>  <br><br> • Uses <code>Path.read_text(encoding=&#x27;utf-8&#x27;)</code> and <code>Path.write_text(..., encoding=&#x27;utf-8&#x27;)</code>.  <br> • Write is not atomic. A crash during <code>write_text</code> can produce a truncated file.  <br> <strong>Recommendation:</strong> For production use, write to a temp file and <code>os.replace()</code> to perform an atomic swap. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling</strong>  <br><br> • Current implementation prints user-visible messages and returns early on missing files.  <br> • There is no exception handling for JSON parsing errors, BeautifulSoup failures, or write errors—these will raise exceptions to the caller.  <br> <strong>Recommendation:</strong> Wrap JSON load and file writes in <code>try/except</code> and emit structured errors or return codes for automation. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security & injection considerations</strong>  <br><br> • <code>caption_text</code> is inserted as <code>.string</code> which is safe because BeautifulSoup will treat it as text not markup. This avoids HTML injection from the labels file.  <br> • However the code does not sanitize the existing HTML document; if it contains unsafe scripts, the function does not attempt to neutralize them.  <br> <strong>Recommendation:</strong> Run sanitized output through a sanitizer (e.g., <code>render.sanitize.sanitize_html</code>) before writing if inputs may be untrusted. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Behavior with nested or complex markup</strong>  <br><br> • If the targeted element is inside templates, wrappers, or fragments, inserting a <code>&lt;caption&gt;</code> before arbitrary elements may break semantic HTML or CSS.  <br> • If multiple elements share the same id (invalid HTML), <code>soup.find(id=...)</code> returns the first occurrence only.  <br> <strong>Recommendation:</strong> Validate that matched element is a <code>&lt;table&gt;</code> before adding a <code>&lt;caption&gt;</code> to preserve semantics. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance characteristics</strong>  <br><br> • Operates on single file loaded fully into memory. Suitable for typical HTML pages but not optimized for extremely large files.  <br> • Complexity is O(n) over HTML size plus O(m) for number of captions. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Tests to add (priority)</strong>  <br><br> 1. Missing files: ensure function returns cleanly and logs the expected message.  <br> 2. JSON parse error: pass malformed JSON and confirm behavior (expect exception or controlled error).  <br> 3. Caption duplication: variations in whitespace and HTML entities to confirm duplicate detection logic.  <br> 4. Non-<code>&lt;table&gt;</code> elements with id: ensure caption insertion does not break layout; test that function optionally validates tag type.  <br> 5. TOC replacement: existing TOC present and absent cases, ensuring placement and content correctness.  <br> 6. Atomic write test: simulate write failure and assert original file preserved when atomic swap is used. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Recommended improvements & hardening</strong>  <br><br> • <strong>Validate target tag:</strong> Only insert <code>&lt;caption&gt;</code> if <code>table_tag.name == &quot;table&quot;</code> (or optionally allow <code>figure</code>).  <br> • <strong>Stricter duplicate detection:</strong> Normalize whitespace and HTML-unescape both existing caption and <code>caption_text</code> before comparison.  <br> • <strong>Atomic save:</strong> Write to a temp file and <code>os.replace()</code> to avoid partial writes.  <br> • <strong>Logging vs printing:</strong> Replace <code>print()</code> with structured logging (<code>logger.info/warn/error</code>) and return status codes or raise controlled exceptions for programmatic callers.  <br> • <strong>TOC placement option:</strong> Accept a parameter to specify insertion point (e.g., after <code>#main-header</code> or <code>div.toc-container</code>).  <br> • <strong>Schema validation:</strong> Validate <code>labels.json</code> structure and content (e.g., non-empty strings, safe length limits).  <br> • <strong>Id collision handling:</strong> If multiple entries map to the same id, warn and skip duplicates. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Backward-compat & API notes</strong>  <br><br> • Simple, small API suitable for CLI or post-render pipeline steps.  <br> • Behavior is deterministic on modern Python (dict preserves insertion order).  <br> • Minimal surface area eases embedding into build scripts but callers must handle exceptions that may propagate. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Summary</strong>  <br><br> The module is a concise utility that inserts captions and rebuilds a TOC from a JSON mapping using BeautifulSoup. It is correct for common use but should be hardened for production by validating that targets are actual <code>&lt;table&gt;</code> elements, using atomic writes, normalizing caption comparisons, improving error handling, and replacing <code>print()</code> with structured logging. </td></tr></tbody></table></div><div class="row-count">Rows: 15</div></div><div class="table-caption" id="Table17" data-table="Book_8052_17" style="margin-top:2mm;margin-left:3mm;"><strong>Table 17 — types.py</strong></div>
<div class="table-wrapper" data-table-id="table-17"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module purpose & summary</strong>  <br><br> Small typed helper module that centralizes renderer configuration and lightweight shared type aliases. Exports <code>RenderConfig</code> dataclass and a couple of runtime type aliases (<code>RenderResult</code>, <code>TableLike</code>). Designed for simple dependency injection and consistent defaults across the render pipeline. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API & surface</strong>  <br><br> • <code>RenderResult = Dict[str, Any]</code> — generic mapping used to return render outputs.  <br> • <code>TableLike = Any</code> — loose alias for table-like inputs.  <br> • <code>RenderConfig</code> dataclass — primary configuration container with default values and the <code>resolved_assets_dir(out_dir: Path) -&gt; Path</code> helper. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Fields & semantics (per-field)</strong>  <br><br> 1. <code>log_level: int = logging.INFO</code> — default logging level for consumers. Expected values from <code>logging</code>.  <br> 2. <code>assets_dir: Optional[Path | str] = None</code> — allows explicit assets location; <code>resolved_assets_dir</code> will prefer this when set.  <br> 3. <code>embed_assets: bool = False</code> — boolean toggle likely used to inline styles/scripts into output.  <br> 4. <code>bundle_assets: bool = True</code> — likely controls whether assets are bundled/copied to output.  <br> 5. <code>cache_size: int = 100</code> — intended LRU/cache capacity for render caches.  <br> 6. <code>table_render_timeout_ms: Optional[int] = 500</code> — per-table render timeout in ms; <code>None</code> => no timeout.  <br> 7. <code>split_threshold: int = 0</code> — threshold for splitting or chunking large output (semantics depend on renderer).  <br> 8. <code>max_workers: int = 4</code> — concurrency cap for thread/process pools.  <br> 9. <code>table_row_limit: int = 0</code> — row trimming limit (0 likely means no limit).  <br> 10. <code>cancel_event: Optional[Event] = None</code> — threading <code>Event</code> used to signal cancellation across worker threads.  <br> 11. <code>progress_callback: Optional[Callable[[int,int],None]] = None</code> — optional progress reporter with <code>(processed, total)</code> signature.  <br> 12. <code>gzip_out: bool = False</code> — toggle to gzip final output. </td></tr><tr><td data-label="Technical Breakdown"> <strong>resolved_assets_dir behaviour</strong>  <br><br> • If <code>assets_dir</code> is truthy returns <code>Path(self.assets_dir)</code> preserving user-specified location.  <br> • Otherwise returns <code>Path(out_dir) / &quot;assets&quot;</code>.  <br><br> <strong>Notes:</strong> Does not validate path existence or create directories. Converts <code>assets_dir</code> to <code>Path</code> without type normalization for <code>Path|str</code> complexity introduced in annotation. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Typing & forward-compat</strong>  <br><br> • Uses <code>from __future__ import annotations</code> to allow compact type annotations.  <br> • Annotation <code>Path | str</code> requires Python 3.10+ or <code>from __future__ import annotations</code> (present). Good for modern codebases.  <br> • <code>TableLike = Any</code> is intentionally permissive but weakens static guarantees; consider a Protocol for table-like objects if you need structural typing. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Threading & cancellation model</strong>  <br><br> • <code>cancel_event</code> accepts a <code>threading.Event</code>. This is a portable cancellation primitive for worker loops and is preferable to exceptions for cooperative shutdown.  <br> • Callers must pass the same Event instance to workers and check <code>is_set()</code> periodically.  <br> • No helper methods are provided to set/clear or to create default events. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Design strengths</strong>  <br><br> • Centralized defaults simplify configuration propagation.  <br> • Small and focused API surface; easy to instantiate and pass through rendering pipeline.  <br> • Explicit <code>resolved_assets_dir</code> helper avoids repeated path-resolution logic elsewhere. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Potential issues & edge cases</strong>  <br><br> 1. <code>resolved_assets_dir</code> returns <code>Path(self.assets_dir)</code> without validating type — if <code>assets_dir</code> is a non-string object this will raise.  <br> 2. No input validation or normalization for numeric fields (negative <code>max_workers</code>, zero/negative <code>cache_size</code>, non-sensical timeouts).  <br> 3. <code>table_row_limit</code> default <code>0</code> is ambiguous (no limit vs strip all rows). Callers must document interpretation.  <br> 4. No JSON/serialization helpers. If config must be persisted or constructed from CLI/env, a <code>from_dict</code> / <code>to_dict</code> pair would be helpful. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Robustness & hardening recommendations</strong>  <br><br> 1. Add validation in <code>__post_init__</code> to clamp and verify fields: <code>max_workers &gt;= 1</code>, <code>cache_size &gt;= 0</code>, <code>table_render_timeout_ms</code> either <code>None</code> or <code>&gt;= 0</code>.  <br> 2. Normalize <code>assets_dir</code> to <code>Path</code> eagerly (and optionally create directory) to fail fast.  <br> 3. Provide helpers: <code>from_mapping(m: Mapping)</code> and <code>to_mapping()</code> for config ingestion from env/CLI.  <br> 4. Consider replacing <code>TableLike = Any</code> with a <code>Protocol</code> that defines minimal expected methods (<code>columns</code>, <code>itertuples</code> or <code>__iter__</code>) for safer static checks.  <br> 5. Document semantics of <code>split_threshold</code> and <code>table_row_limit</code> in docstring or property docstrings. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing checklist</strong>  <br><br> 1. Construct <code>RenderConfig</code> with defaults and ensure <code>resolved_assets_dir(Path(&#x27;/out&#x27;))</code> returns <code>/out/assets</code>.  <br> 2. Pass a <code>Path</code> for <code>assets_dir</code> and a string path; confirm returned <code>Path</code> matches input.  <br> 3. Validate <code>__post_init__</code> if added: out-of-range values raise or are corrected.  <br> 4. Use <code>cancel_event</code> in a small threaded worker to confirm cooperative cancellation works.  <br> 5. Serialization roundtrip if <code>to_dict</code>/<code>from_dict</code> added. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Integration notes</strong>  <br><br> • This configuration object should be created once and passed to all renderer components.  <br> • Keep <code>RenderConfig</code> immutable in practice for thread-safety, or document that fields may be mutated before use only.  <br> • Use <code>progress_callback</code> sparingly and ensure callers catch exceptions from the callback to avoid worker termination. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Backward compatibility & evolution</strong>  <br><br> • Adding new fields is safe due to dataclass defaults.  <br> • If the package must support older Python versions (<3.10), change union annotation to <code>Optional[Union[Path,str]]</code> or rely on <code>typing.Union</code>.  <br> • Consider freezing the dataclass (<code>frozen=True</code>) if immutability is desirable. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Summary</strong>  <br><br> <code>render/types.py</code> is a compact, pragmatic config layer for the renderer. It benefits from small hardening steps: input validation, explicit Path normalization, clearer semantics for ambiguous numeric defaults, and optional (de)serialization helpers. Converting <code>TableLike</code> to a structural <code>Protocol</code> will increase static safety when integrating diverse table-like inputs. </td></tr></tbody></table></div><div class="row-count">Rows: 13</div></div><div class="table-caption" id="Table18" data-table="Book_8052_18" style="margin-top:2mm;margin-left:3mm;"><strong>Table 18 — core_renderer</strong></div>
<div class="table-wrapper" data-table-id="table-18"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>📌 Module purpose & overview</strong>  <br> <strong>Purpose:</strong> Orchestrate rendering tables to HTML with defensive parsing, fragment rendering, and asset management.  <br> <strong>Inputs:</strong> iterable of table-like objects, output path, markdown renderer, optional config and hooks.  <br> <strong>Outputs:</strong> HTML file written to <code>output_html</code> and a result dict with warnings, counts, runtime. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Dependencies & fallbacks</strong>  <br> <strong>Behavior:</strong> imports <code>core_io</code>, <code>core_assets</code>, <code>core_fragments</code>, <code>core_table</code>, <code>core_utils</code>; prefers project <code>sanitize</code> with fallback to conservative <code>html.escape</code>.  <br> <strong>Edge cases:</strong> absent optional modules handled by local fallbacks.  <br> <strong>Recommendation:</strong> surface dependency availability in diagnostics. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Diagnostic recorder <code>_record</code></strong>  <br> <strong>Purpose:</strong> lightweight debug logger wrapper used for internal notes.  <br> <strong>Behavior:</strong> wraps <code>logger.debug</code>, swallowing exceptions.  <br> <strong>Recommendation:</strong> keep extremely cheap to avoid overhead in hot paths. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 MarkdownRenderer wrapper</strong>  <br> <strong>Purpose:</strong> adapt provided markdown function into object with <code>.render</code> or <code>.render</code>-compatible interface.  <br> <strong>Behavior:</strong> stores provided callable or fallback escape function; has <code>cache_size</code> and <code>timeout_s</code> parameters not actively used here.  <br> <strong>Recommendation:</strong> implement caching/timeouts if heavy renderers passed. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 HTML table extraction strategy</strong>  <br> <strong>Purpose:</strong> extract table data from markdown or HTML input robustly using BS4 when available, else regex fallback.  <br> <strong>Functions:</strong> <code>_split_cells_from_pipe_line</code>, <code>_extract_pipe_tables_from_markdown</code>, <code>_extract_tables_from_html_bs4</code>, <code>_parse_table_html_regex</code>, <code>_extract_tables_from_html_regex</code>, <code>_extract_tables_from_html</code>.  <br> <strong>Behavior:</strong> prefer BS4; fall back to regex parsing when BS4 missing; special handling for markdown pipe-tables via line-pattern detection and header-divider validation.  <br> <strong>Edge cases:</strong> malformed HTML or nested tables may reduce accuracy; regex path is guarded and logs exceptions.  <br> <strong>Recommendation:</strong> favor BS4 path in production for robustness. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 <code>_split_cells_from_pipe_line</code></strong>  <br> <strong>Purpose:</strong> split a markdown pipe-line into trimmed cells and remove leading/trailing empty pipe columns.  <br> <strong>Behavior:</strong> <code>re.split(r&#x27;\|&#x27;, ...)</code>, strip parts, drop empty first/last if present.  <br> <strong>Edge cases:</strong> escaped pipes not considered; recommend pre-stashing code/placeholders upstream if needed. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 <code>_extract_pipe_tables_from_markdown</code></strong>  <br> <strong>Purpose:</strong> detect standard markdown pipe-tables by locating header line + divider line and collecting following rows until blank/non-pipe line.  <br> <strong>Behavior:</strong> validates divider cells match <code>:?-{1,}:?</code> pattern; assembles rows and marks <code>header=True</code>.  <br> <strong>Edge cases:</strong> misaligned pipes or inline pipes in text may cause false negatives; conservative approach chosen. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 BS4 HTML extraction <code>_extract_tables_from_html_bs4</code></strong>  <br> <strong>Purpose:</strong> parse HTML to extract <code>&lt;table&gt;</code> contents reliably with text extraction preserving <code>&lt;br&gt;</code> as newline.  <br> <strong>Behavior:</strong> for each <code>&lt;table&gt;</code> collect rows and detect presence of <code>&lt;thead&gt;</code>/<code>&lt;th&gt;</code> for <code>header</code> flag; returns <code>html</code> snippet for fallback.  <br> <strong>Edge cases:</strong> BS4 parsing exceptions logged and path falls back to regex.  <br> <strong>Recommendation:</strong> decode cell text with <code>.get_text(&quot;\n&quot;, strip=True)</code> to preserve multi-line cells. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Regex HTML extraction <code>_parse_table_html_regex</code> & wrapper</strong>  <br> <strong>Purpose:</strong> lightweight parser when BS4 not available.  <br> <strong>Behavior:</strong> finds <code>&lt;tr&gt;</code> blocks then <code>&lt;td&gt;/&lt;th&gt;</code> cells; substitutes <code>&lt;br&gt;</code> to <code>\n</code>, strips tags and unescapes HTML.  <br> <strong>Edge cases:</strong> fragile to attributes, nested tags, comments; covered by try/except and returns empty on failure.  <br> <strong>Recommendation:</strong> use only as fallback. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 <code>_convert_rows_to_df_like</code></strong>  <br> <strong>Purpose:</strong> coerce extracted <code>rows</code> and <code>header</code> flag into pandas DataFrame when available, else to list-of-dicts or rows.  <br> <strong>Behavior:</strong> if <code>header</code> true uses first row as columns and builds DataFrame or list-of-dicts; else DataFrame of rows or raw rows.  <br> <strong>Edge cases:</strong> mismatched row lengths padded via <code>r + [&quot;&quot;] * (len(cols)-len(r))</code>.  <br> <strong>Recommendation:</strong> prefer DataFrame for downstream compatibility but tolerate list forms. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 CSV detection helper <code>_detect_csv_like</code></strong>  <br> <strong>Purpose:</strong> detect CSV-like text, avoid misclassifying HTML or markdown pipe-tables.  <br> <strong>Behavior:</strong> rejects if no newline or contains HTML tags; avoids pipe-containing first lines; uses <code>csv.Sniffer</code> then heuristic counts across first 10 lines.  <br> <strong>Returns:</strong> <code>(is_csv: bool, delimiter: Optional[str])</code>.  <br> <strong>Edge cases:</strong> sniffer may raise; heuristics match consistent column counts.  <br> <strong>Recommendation:</strong> allow forced delimiter via <code>forced_delim</code> when known. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 <code>_parse_csv_text</code> & <code>_parse_csv_file</code></strong>  <br> <strong>Purpose:</strong> parse CSV text or file path into list-of-dicts using <code>_csv.DictReader</code>.  <br> <strong>Behavior:</strong> for text uses provided delimiter; for file attempts sniffing sample of 8192 bytes for dialect then uses <code>DictReader</code>; converts empty strings to <code>None</code> in values.  <br> <strong>Edge cases:</strong> encoding issues handled by <code>open(..., errors=&#x27;ignore&#x27;)</code>; large files read streaming via reader.  <br> <strong>Recommendation:</strong> prefer explicit <code>encoding</code> when possible; return diagnostics on detected delimiter. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 <code>_stable_hash</code></strong>  <br> <strong>Purpose:</strong> compute a stable SHA256 hash for deduplication using JSON <code>sort_keys=True</code> fallback to <code>repr</code>.  <br> <strong>Behavior:</strong> serializes with <code>default=str</code>, sorts keys then hashes; exceptions handled with graceful fallback to <code>repr</code> hashing; returns <code>None</code> if hashing fails.  <br> <strong>Recommendation:</strong> ensure objects passed are JSON-serializable for consistent hashes. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 <code>render_html</code> entry contract</strong>  <br> <strong>Purpose:</strong> top-level orchestrator to render <code>all_tables</code> into <code>output_html</code>.  <br> <strong>Signature highlights:</strong> parameters include <code>markdown_to_html</code>, <code>cfg</code>, <code>return_html</code>, <code>materialize</code>, and hooks for <code>render_cell</code> and CDN integrity.  <br> <strong>Behavior:</strong> sanitizes output path, prepares assets, converts inputs into parsed tables, renders fragments concurrently, writes composed HTML via atomic writer.  <br> <strong>Recommendation:</strong> validate <code>cfg</code> fields before heavy processing. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Asset preparation & write overrides</strong>  <br> <strong>Behavior:</strong> calls <code>prepare_assets(cfg, out_dir)</code> with best-effort fallback; computes <code>href_prefix</code> relative path; attempts to write <code>overrides.css</code> via <code>write_overrides_css</code>.  <br> <strong>Edge cases:</strong> failures are non-fatal; use fallbacks.  <br> <strong>Recommendation:</strong> emit clear log if assets not found to help debugging. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Renderer instantiation</strong>  <br> <strong>Behavior:</strong> wraps <code>markdown_to_html</code> into <code>MarkdownRenderer</code> object; <code>renderer.render</code> not invoked explicitly later but object passed into fragments pipeline.  <br> <strong>Recommendation:</strong> ensure <code>markdown_to_html</code> is callable and cheap or implements caching. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Input normalization loop (core logic)</strong>  <br> <strong>Purpose:</strong> transform raw inputs into <code>parsed_tables</code> and <code>inline_html_sources</code>.  <br> <strong>Flow:</strong> iterate <code>raw_inputs</code>, handle DataFrame-like, lists/tuples (_to_dataframe_if_possible), filesystem paths (CSV files parsed), inline CSV via <code>_detect_csv_like</code> and <code>_parse_csv_text</code>, markdown pipe-table extraction, markdown->HTML->sanitize->HTML-table extraction, else retain sanitized HTML for inline display.  <br> <strong>Edge cases:</strong> many try/except blocks to avoid crash on malformed items; logs errors and continues.  <br> <strong>Recommendation:</strong> place expensive ops (markdown render, sanitize, BS4) only when candidate likely contains tables. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 <code>_to_dataframe_if_possible</code> helper</strong>  <br> <strong>Purpose:</strong> attempt to coerce lists/dicts into pandas DataFrame for downstream uniformity.  <br> <strong>Behavior:</strong> for list-of-dicts returns DataFrame; for list-of-lists tries to infer header if first row matches rest lengths; handles dict-of-columns.  <br> <strong>Edge cases:</strong> pandas absence returns <code>None</code>; exceptions suppressed.  <br> <strong>Recommendation:</strong> fail fast with clear error when input shapes inconsistent. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Filesystem CSV path handling</strong>  <br> <strong>Behavior:</strong> when string is an existing file and extension <code>.csv</code>/<code>.tsv</code> use <code>_parse_csv_file</code> and append parsed rows to <code>parsed_tables</code>; logs PARSE_FAIL when no rows returned.  <br> <strong>Edge cases:</strong> files with non-CSV extension still sampled for CSV-like content later.  <br> <strong>Recommendation:</strong> use explicit <code>cfg.csv_delimiter</code> when reading ambiguous files. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Inline CSV detection & parsing</strong>  <br> <strong>Behavior:</strong> uses <code>cfg.detect_csv</code> flag then <code>_detect_csv_like</code> to determine CSV; on positive detection uses <code>_parse_csv_text</code> and appends rows to <code>parsed_tables</code>.  <br> <strong>Edge cases:</strong> empty parse results logged; robust to exceptions.  <br> <strong>Recommendation:</strong> <code>cfg.detect_csv</code> can be disabled for content-heavy markdown files. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Pipe-table extraction and conversion</strong>  <br> <strong>Behavior:</strong> <code>_extract_pipe_tables_from_markdown</code> returns structured rows which are converted via <code>_convert_rows_to_df_like</code> then <code>_to_dataframe_if_possible</code>; appended to <code>parsed_tables</code> when successful.  <br> <strong>Edge cases:</strong> multiple pipe-tables per input supported.  <br> <strong>Recommendation:</strong> preserve source metadata (line numbers) for diagnostic messages. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Markdown->HTML->sanitize->HTML-table extraction</strong>  <br> <strong>Behavior:</strong> converts remaining string input via <code>markdown_to_html</code>, sanitizes with <code>sanitize_html(allow_tables=True)</code> fallback, extracts tables via <code>_extract_tables_from_html</code>, converts to df-like and appends.  <br> <strong>Edge cases:</strong> expensive operations performed only after prior CSV/pipe-table checks.  <br> <strong>Recommendation:</strong> throttle markdown render for very large strings by sampling. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Inline HTML source retention</strong>  <br> <strong>Behavior:</strong> if no table extracted the sanitized HTML <code>md_html</code> is appended to <code>inline_html_sources</code> for later inline rendering.  <br> <strong>Recommendation:</strong> track size and avoid embedding very large HTML blobs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Deduplication of parsed_tables</strong>  <br> <strong>Purpose:</strong> avoid rendering identical tables multiple times.  <br> <strong>Behavior:</strong> computes stable hash of each table (DataFrame-><code>to_dict(records)</code> or raw object), uses set <code>seen</code> to drop duplicates while preserving order.  <br> <strong>Edge cases:</strong> non-hashable or non-serializable objects may yield <code>None</code> key and be retained.  <br> <strong>Recommendation:</strong> canonicalize DataFrame/sources before hashing. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Aggressive CSV coercion fallback</strong>  <br> <strong>Behavior:</strong> when <code>parsed_tables</code> empty but raw_inputs non-empty, attempts to coerce string items that look CSV-like (contains newline and comma) via <code>_detect_csv_like</code> and <code>_parse_csv_text</code>.  <br> <strong>Rationale:</strong> salvage probable tabular CSV embedded in content.  <br> <strong>Recommendation:</strong> make this configurable to avoid surprising coercions. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Fragments rendering orchestration</strong>  <br> <strong>Purpose:</strong> Render parsed tables into fragment files concurrently via <code>render_fragments_concurrently</code>.  <br> <strong>Inputs:</strong> <code>parsed_tables</code>, <code>cfg</code>, <code>renderer</code>, <code>tmp_frag_dir</code>, <code>max_workers</code>.  <br> <strong>Behavior:</strong> attempts concurrent fragment rendering; on exception logs and sets <code>fragments_map={}, frag_row_counts={}, total_rows=0</code> and adds a warning.  <br> <strong>Edge cases:</strong> worker failures produce warnings; pipeline continues to fallback path.  <br> <strong>Recommendation:</strong> surface per-fragment errors and partial successes in <code>warnings</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Fragment result validation & fallback decision</strong>  <br> <strong>Purpose:</strong> Determine if fragment-based rendering produced usable content.  <br> <strong>Behavior:</strong> sets <code>need_fallback</code> when <code>fragments_map</code> empty or no fragment contains rows (checked via <code>_frag_contains_rows</code>).  <br> <strong>Edge cases:</strong> small fragments with non-row content considered empty; fallback triggered conservatively.  <br> <strong>Recommendation:</strong> include fragment diagnostics (file sizes, row counts) in <code>warnings</code> for troubleshooting. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Asset embedding flag (<code>embed_assets</code>)</strong>  <br> <strong>Purpose:</strong> Fold-in <code>cfg.embed_assets</code> boolean to decide between inline assets vs linked assets.  <br> <strong>Behavior:</strong> if <code>embed_assets</code> true then CSS/JS read as text and injected into head/tail; otherwise link tags with versioning via file mtime are used.  <br> <strong>Edge cases:</strong> missing files fall back to provided <code>style_fallback</code> and <code>script_fallback</code>.  <br> <strong>Recommendation:</strong> prefer linked assets in production and embed only for single-file distribution. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Head & tail HTML assembly</strong>  <br> <strong>Purpose:</strong> Build initial <code>head_parts</code> and <code>tail_parts</code> slices including DOCTYPE, meta, title, minimal CSS, and asset inclusions.  <br> <strong>Behavior:</strong> includes conditional logic for embed vs linked assets, computes <code>href_prefix</code>, appends <code>&lt;link&gt;</code> or <code>&lt;style&gt;</code> for CSS, and script tags or inline shim for JS and worker.  <br> <strong>Edge cases:</strong> filesystem errors guarded; <code>_sri_attr</code> used for CDN integrity when linking.  <br> <strong>Recommendation:</strong> compute <code>href_prefix</code> robustly and log when asset versioning fails. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Header UI generation</strong>  <br> <strong>Purpose:</strong> Produce top UI with search, theme toggle, collapse, copy, reset controls while preserving legacy IDs for compatibility.  <br> <strong>Behavior:</strong> writes <code>#tables-viewer</code>, header with <code>#tv-header</code>, search input <code>#searchBox</code>, and action buttons; includes inline delegation shim mapping legacy alias <code>copyAllMdBtn</code> to modern button.  <br> <strong>Edge cases:</strong> CSP may block inline script; delegation attempts to avoid breaking older integrations.  <br> <strong>Recommendation:</strong> keep legacy aliases documented and consider deprecation plan. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Labels loader & caption resolution</strong>  <br> <strong>Purpose:</strong> Load optional <code>labels.json</code> from candidate paths to produce per-table captions.  <br> <strong>Behavior:</strong> <code>_load_labels_json</code> searches project and output directories; <code>_caption_for</code> looks up keys like <code>prefix_01</code> or nested dicts to return human captions.  <br> <strong>Edge cases:</strong> missing or malformed JSON silently ignored.  <br> <strong>Recommendation:</strong> surface loaded labels in debug metadata to confirm lookup paths. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Table listing (TOC) and frag_paths_ordered</strong>  <br> <strong>Purpose:</strong> Build <code>frag_paths_ordered</code> and <code>toc_items</code> for fragments or inline fallback.  <br> <strong>Behavior:</strong> when fragments present iterate <code>fragments_map</code> keys to create tuples <code>(idx, path, id, title)</code> and TOC entries; in fallback mode synthesize inline entries.  <br> <strong>Edge cases:</strong> fragment <code>path</code> may be None; code preserves semantics and still emits TOC entry.  <br> <strong>Recommendation:</strong> include fragment timestamps in TOC for traceability. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Fallback inline rendering flow</strong>  <br> <strong>Purpose:</strong> Render HTML inline when fragment pipeline fails.  <br> <strong>Behavior:</strong> <code>_render_table_safe</code> tries <code>render_table(df_like, idx, md_to_html, lw, rw)</code> preserving upstream behavior; falls back to pandas <code>to_html</code> or a textual fail placeholder.  <br> <strong>Edge cases:</strong> <code>render_table</code> may raise TypeError; handled by nested tries.  <br> <strong>Recommendation:</strong> keep fallback minimal and clearly annotated to help users spot fallback output. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Sanitization of rendered fragments/inline</strong>  <br> <strong>Purpose:</strong> Ensure safe HTML output before embedding.  <br> <strong>Behavior:</strong> <code>sanitize_html(piece, allow_tables=True)</code> used where available; falls back to raw piece on exception.  <br> <strong>Edge cases:</strong> sanitizer signature differences handled by try/except.  <br> <strong>Recommendation:</strong> validate sanitizer API at startup and log its signature for compatibility. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Heading removal from fragment content</strong>  <br> <strong>Purpose:</strong> Avoid duplicate headings by removing first heading element from fragment before embedding.  <br> <strong>Behavior:</strong> <code>_remove_heading_from_fragment</code> uses regex to remove heading by <code>id</code> or by text or strips first <code>&lt;h[1-6]&gt;</code> header.  <br> <strong>Edge cases:</strong> regex may be brittle with complex nested markup; wrapped in try/except to avoid breakage.  <br> <strong>Recommendation:</strong> prefer structured fragment format that includes header metadata to avoid regex surgery. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Inline HTML sources processing</strong>  <br> <strong>Purpose:</strong> Wrap leftover sanitized HTML sources with generated captions and heading ids for fallback pages.  <br> <strong>Behavior:</strong> ensure an <code>&lt;h3 id=&quot;TableN&quot;&gt;</code> exists; attempt to replace first heading with id set; append caption from <code>_caption_for</code> when available.  <br> <strong>Edge cases:</strong> existing headings with complex attributes may prevent replacement; fallback inserts new heading.  <br> <strong>Recommendation:</strong> coerce consistent structure for inline sources earlier in pipeline. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Banner when no output produced</strong>  <br> <strong>Purpose:</strong> Provide user-visible warning block when no tables were rendered.  <br> <strong>Behavior:</strong> construct <code>banner_html</code> with recent <code>warnings</code> messages concatenated; displayed prominently in page.  <br> <strong>Recommendation:</strong> include actionable suggestions in banner (e.g., enable <code>cfg.detect_csv</code>). </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 TOC assembly and export template variables</strong>  <br> <strong>Purpose:</strong> final assembly of Table of Contents and export template JS variables.  <br> <strong>Behavior:</strong> builds <code>toc</code> HTML and JSON-escapes <code>export_template</code>, <code>output_user</code>, and <code>href_prefix</code> into JS variables <code>template</code>, <code>userVal</code>, <code>hrefPrefix</code>.  <br> <strong>Edge cases:</strong> JSON encoding failures falling back to defaults.  <br> <strong>Recommendation:</strong> validate <code>export_name_template</code> format before embedding. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Client-side export worker stub</strong>  <br> <strong>Purpose:</strong> Provide a button handler that uses a Web Worker to export the page (PDF or similar) while guarding against huge HTML sizes.  <br> <strong>Behavior:</strong> JS checks <code>html.length &gt; 2_000_000</code> and worker availability; posts <code>{html, format:&#x27;pdf&#x27;}</code> to worker and handles responses; uses <code>hrefPrefix</code> to locate <code>worker.js</code>.  <br> <strong>Edge cases:</strong> environment without Worker alerts user; worker creation failures caught with user notification.  <br> <strong>Recommendation:</strong> make worker job bounded and return structured status messages for UI feedback. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Reveal-on-load opacity fix</strong>  <br> <strong>Purpose:</strong> avoid FOUC by setting <code>.table-wrapper</code> opacity to 1 on window load.  <br> <strong>Behavior:</strong> appended JS to run on <code>load</code> and set <code>element.style.opacity=&#x27;1&#x27;</code>.  <br> <strong>Edge cases:</strong> CSS transitions may animate large pages; acceptable.  <br> <strong>Recommendation:</strong> use <code>requestAnimationFrame</code> for smoother paint when many elements. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Writer function & HTML composition</strong>  <br> <strong>Purpose:</strong> Single writer closure that streams <code>head</code>, <code>toc</code>, captions, fragment contents or inline_parts, and <code>tail</code> into provided file-like <code>f</code>.  <br> <strong>Behavior:</strong> writes <code>head</code>, <code>toc</code>, optional <code>banner_html</code>, then either fragment files (reading each <code>frag_path</code>) or <code>inline_parts</code>, then <code>tail</code>. Each fragment read sanitized via <code>_remove_heading_from_fragment</code> before writing.  <br> <strong>Edge cases:</strong> frag file read errors are caught and skipped; writer continues.  <br> <strong>Recommendation:</strong> stream large fragments rather than <code>read()</code> into memory for better memory profile. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Atomic writing & fallback writes</strong>  <br> <strong>Purpose:</strong> Ensure safe atomic file output using <code>_default_write_atomic</code> when available, otherwise write to <code>.tmp</code> and <code>os.replace</code>.  <br> <strong>Behavior:</strong> attempts <code>_default_write_atomic(out_path, writer)</code>, else manual tmp write with replace; final fallback tries direct write and returns warnings on failures.  <br> <strong>Edge cases:</strong> permission errors, disk full, race conditions; caught and reported.  <br> <strong>Recommendation:</strong> ensure <code>_default_write_atomic</code> uses fsync and robust temp-path semantics on target filesystem. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Result composition & post-run options</strong>  <br> <strong>Purpose:</strong> Build <code>result</code> dict with <code>warnings</code>, <code>tables</code>, <code>rows</code>, <code>runtime_ms</code>, <code>output</code>, and optionally <code>html</code> content when <code>return_html</code>.  <br> <strong>Behavior:</strong> computes <code>runtime_ms</code> from <code>start_time</code>, reads <code>out_path</code> when requested.  <br> <strong>Edge cases:</strong> reading output file may fail; <code>html</code> set to <code>None</code> in that case.  <br> <strong>Recommendation:</strong> include fragment-level metrics and asset write flags in result for richer telemetry. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Logging & diagnostics</strong>  <br> <strong>Purpose:</strong> emit debug logs for counts, sample types, parsed tables, and record notes via <code>_record</code>.  <br> <strong>Behavior:</strong> logs <code>parsed_tables</code> count and sample type names; records when CSV files parsed or inline detection occurs.  <br> <strong>Recommendation:</strong> increase log verbosity only when <code>cfg.debug</code> to avoid noisy production logs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Error handling philosophy</strong>  <br> <strong>Purpose:</strong> maximize best-effort output.  <br> <strong>Behavior:</strong> pervasive try/except blocks ensure pipeline continues even when sub-operations fail; accumulate <code>warnings</code> to return to caller.  <br> <strong>Tradeoff:</strong> errors may be noisy but user gets an output file rather than crash.  <br> <strong>Recommendation:</strong> classify <code>warnings</code> by severity and optionally fail-fast under <code>cfg.strict</code> mode. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Performance considerations</strong>  <br> <strong>Hot spots:</strong> markdown->HTML render, sanitizer, BS4 parsing, fragment rendering concurrency, reading/writing fragment files and asset scanning.  <br> <strong>Memory profile:</strong> building <code>head_parts</code>/<code>tail_parts</code> and reading fragment files into memory may spike memory for many large fragments.  <br> <strong>Mitigations:</strong> stream fragment reads, limit concurrent fragment workers, throttle markdown renders, and avoid embedding huge inline chunks.  <br> <strong>Recommendation:</strong> add resource budget config (max_memory_mb, max_fragment_size) and enforce early. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Security & safety</strong>  <br> <strong>XSS mitigations:</strong> sanitize user-supplied HTML with <code>sanitize_html(allow_tables=True)</code> when possible; escape captions and labels; escape JSON for embedding via <code>_safe_json_for_script</code> in other modules.  <br> <strong>Asset integrity:</strong> <code>_sri_attr</code> used for CDN scripts when provided.  <br> <strong>Exposures:</strong> inline script injection risks if sanitization skipped; <code>data-</code> attributes might leak internal values.  <br> <strong>Recommendation:</strong> enable CSP, avoid inline scripts where possible, and validate <code>cfg</code> values before embedding. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Testing & validation checklist</strong>  <br> <strong>Critical tests:</strong>  <br> 1. End-to-end render with fragments pipeline success and failure.  <br> 2. CSV file and inline CSV parsing with different delimiters and encodings.  <br> 3. Pipe-table markdown extraction edge cases.  <br> 4. Asset embed vs link behavior and link versioning.  <br> 5. Atomic write fallback paths and error conditions (permissions, disk full).  <br> 6. Worker export path behavior in browsers with/without Worker.  <br> <strong>Recommendation:</strong> add CI job that runs full render against canonical fixture set and validates output snapshots. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Integration & operational recommendations</strong>  <br> <strong>Short-term:</strong> add clear debug logs for asset discovery and fragment outputs; surface <code>warnings</code> in CLI/UI.  <br> <strong>Medium-term:</strong> implement streaming fragment writer, size-limits, and strict-mode option to fail on critical warnings.  <br> <strong>Long-term:</strong> separate heavy work into offline pre-render pipeline and serve static HTML fragments rather than building at request time. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Final merge checklist for core_renderer.py</strong>  <br> <strong>Pre-merge steps:</strong>  <br> 1. Run unit tests for CSV heuristics, markdown/pipe-table extraction, fragment rendering success/failure.  <br> 2. Validate sanitizer presence and signature; add compatibility shim tests.  <br> 3. Test <code>render_fragments_concurrently</code> with varying <code>max_workers</code> and confirm resource limits.  <br> 4. Exercise atomic write paths on target deployment FS and ensure tmp replace semantics safe.  <br> 5. Add telemetry hooks to capture fragments_map sizes, total_rows, and asset write outcomes.  <br> <strong>Ready-to-merge note:</strong> core_renderer is defensive and production-ready with recommended improvements above. </td></tr></tbody></table></div><div class="row-count">Rows: 50</div></div><div class="table-caption" id="Table19" data-table="Book_8052_19" style="margin-top:2mm;margin-left:3mm;"><strong>Table 19 — core_table</strong></div>
<div class="table-wrapper" data-table-id="table-19"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>📌 Module: Purpose & safety caps</strong>  <br> <strong>Purpose:</strong> Provide robust table-rendering helpers with safe defaults and truncation caps.  <br> <strong>Key behavior:</strong> enforce <code>_MAX_CELL_HTML</code>, <code>_MAX_ROWS_SAFE_RENDER</code>, <code>_MAX_COLS_SAFE</code>.  <br> <strong>Edge cases:</strong> truncates large cell HTML and logs.  <br> <strong>Recommendation:</strong> expose caps via config for host apps. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Optional imports & capability probing</strong>  <br> <strong>Purpose:</strong> Probe optional libs (<code>pandas</code>,<code>openpyxl</code>,<code>xlsxwriter</code>,<code>charset_normalizer</code>,<code>chardet</code>,<code>sanitize_html</code>) non-fatally.  <br> <strong>Behavior:</strong> set local aliases or <code>None</code>; set <code>_charset_detector</code>.  <br> <strong>Edge cases:</strong> downstream code must check existence.  <br> <strong>Recommendation:</strong> expose diagnostics for capabilities. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 _get_md_callable</strong>  <br> <strong>Purpose:</strong> Normalize <code>markdown_to_html</code> to a safe callable.  <br> <strong>Inputs:</strong> <code>md</code> (None callable object with <code>.render</code>).  <br> <strong>Behavior:</strong> return escape-lambda if None; return callable or wrapper around <code>.render</code>; fallback to escape on errors.  <br> <strong>Recommendation:</strong> add adapter for async renderers. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Diagram detection & RTL helpers</strong>  <br> <strong>Purpose:</strong> Heuristics to detect ASCII/box diagrams and RTL text for <code>dir</code> attributes.  <br> <strong>Key funcs:</strong> <code>_is_diagram_text</code>, <code>_detect_rtl_chars</code>, <code>_dir_for_text</code>.  <br> <strong>Behavior:</strong> pattern checks, branch counting, Unicode-range regex.  <br> <strong>Recommendation:</strong> cache per-cell results. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Code stash & restore</strong>  <br> <strong>Purpose:</strong> Protect fenced and inline code from markdown processing then restore escaped code in final HTML.  <br> <strong>Behavior:</strong> <code>_stash_code_local</code> replaces fenced/inline code with keys and stores maps; <code>_restore_code_placeholders_in_html</code> reinserts escaped <code>&lt;pre&gt;&lt;code&gt;</code> and <code>&lt;code&gt;</code>.  <br> <strong>Edge cases:</strong> regex failures logged; fallback to raw text.  <br> <strong>Recommendation:</strong> use low-collision placeholder keys (UUIDs) if collision risk. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Protect underscores & pipes</strong>  <br> <strong>Purpose:</strong> Prevent markdown from treating underscores/pipes as formatting outside placeholders.  <br> <strong>Behavior:</strong> <code>_preprocess_underscores_outside_placeholders</code> splits by placeholders and replaces underscores/pipes with entities; <code>_restore_protection_entities</code> reverses them.  <br> <strong>Edge cases:</strong> placeholder-splitting may fail; whole-text fallback used.  <br> <strong>Recommendation:</strong> unit-test mixed code/markdown cases. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Cell rendering pipeline (<code>_render_cell_text</code>)</strong>  <br> <strong>Purpose:</strong> Convert raw cell value to safe HTML: stash code, protect entities, run markdown, restore code, truncate, sanitize, final escape.  <br> <strong>Inputs:</strong> <code>raw</code>, <code>col_i</code>, <code>md_callable</code>, <code>max_cell_html</code>.  <br> <strong>Behavior:</strong> coerce to str; stash code; preprocess underscores/pipes; call <code>md_callable</code> with fallback; restore entities and code; truncate if over <code>max_cell_html</code>; sanitize when <code>sanitize_html</code> available with <code>allow_tables</code> if supported; final <code>html.escape</code> fallback.  <br> <strong>Edge cases:</strong> many nested try/except; logs on errors.  <br> <strong>Performance:</strong> per-cell regex+markdown+sanitize; expensive at scale.  <br> <strong>Recommendation:</strong> cache rendered output and make sanitize optional for trusted input. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Heuristic CSV detection (<code>_is_likely_csv_text</code>)</strong>  <br> <strong>Purpose:</strong> Decide if a string should be treated as CSV while avoiding misclassifying markdown pipe-tables.  <br> <strong>Behavior:</strong> require newline; if first non-empty line has pipes but no commas/tabs → treat as markdown; otherwise look for <code>, ; \t</code>; for pipes require consistent column counts across sample lines.  <br> <strong>Edge cases:</strong> ambiguous inputs handled conservatively.  <br> <strong>Recommendation:</strong> allow caller to force parse mode. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Text/bytes reader with charset fallback (<code>_read_text_source</code>)</strong>  <br> <strong>Purpose:</strong> Read bytes/path/string and return <code>(text, encoding)</code> using detectors and fallbacks.  <br> <strong>Behavior:</strong> if bytes → try <code>charset_normalizer</code> then <code>chardet</code> then encodings list; if path → read binary sample then re-run bytes branch; if string → return as-is.  <br> <strong>Edge cases:</strong> IO failures caught; always returns string.  <br> <strong>Recommendation:</strong> surface used encoding in logs and allow larger samples when needed. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Delimiter sniffing (<code>_sniff_delimiter</code>)</strong>  <br> <strong>Purpose:</strong> Pick likely field delimiter using <code>csv.Sniffer</code> then simple counting.  <br> <strong>Behavior:</strong> use Sniffer when sample large and contains delimiters; fallback to max-count heuristic over candidates.  <br> <strong>Edge cases:</strong> Sniffer may mis-sniff on small samples; caught and logged.  <br> <strong>Recommendation:</strong> restrict sniffing to samples containing multiple delimiter types. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Pandas CSV helper (<code>_try_pandas_read_csv</code>)</strong>  <br> <strong>Purpose:</strong> If pandas present, attempt parse to DataFrame with <code>dtype=str</code> and NA disabled to preserve content.  <br> <strong>Behavior:</strong> call <code>pd.read_csv</code> with <code>engine=&#x27;python&#x27;</code> and iterate <code>itertuples</code> to build rows.  <br> <strong>Edge cases:</strong> pandas parsing errors logged; returns <code>None</code> on failure.  <br> <strong>Recommendation:</strong> consider <code>low_memory=False</code> for mixed types. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Robust CSV parser to rows (<code>_parse_csv_source_to_rows</code>)</strong>  <br> <strong>Purpose:</strong> Parse CSV-like input to <code>(rows, header)</code> robustly without raising.  <br> <strong>Behavior:</strong> read text; choose delimiter via <code>_sniff_delimiter</code> if <code>_is_likely_csv_text</code>; try <code>csv.reader</code>; fallback to naive split; detect header via <code>sniffer.has_header</code> or heuristic; normalize cells to strings; pad/truncate rows to <code>max_cols</code>; log <code>PARSE_OK</code>/<code>PARSE_FAIL</code>.  <br> <strong>Edge cases:</strong> malformed quoting and inconsistent columns padded/truncated.  <br> <strong>Recommendation:</strong> return parse diagnostics (delimiter, encoding) to caller for transparency. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Top-level CSV loader (<code>parse_csv_safe</code>)</strong>  <br> <strong>Purpose:</strong> High-level CSV loader preferring pandas when available; falls back to csv.reader parse then rows->DataFrame conversion if possible.  <br> <strong>Behavior:</strong> iterate encodings×delimiters to attempt pandas parse; sniff and try again; else fallback to <code>_parse_csv_source_to_rows</code>; convert fallback rows to DataFrame when pandas present; log <code>PARSE_TRY</code>/<code>PARSE_OK</code>/<code>PARSE_FAIL</code>.  <br> <strong>Outputs:</strong> returns <code>DataFrame</code> or <code>list[list[str]]</code> or <code>None</code>.  <br> <strong>Recommendation:</strong> stream large CSVs to avoid memory pressure. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Input coercion (<code>_rows_from_iterable</code>) — overview start</strong>  <br> <strong>Purpose:</strong> Normalize varied table-like inputs into <code>(rows, header)</code> for rendering.  <br> <strong>Supported inputs (flow):</strong> bytes→CSV parse; str→path or inline CSV; objects with <code>to_pandas()</code>; pandas-like DataFrame; list-of-dicts; list-of-lists; final iterable fallback.  <br> <strong>Behavior:</strong> attempts early CSV/text handling then falls back to pandas-like detection and list handling.  <br> <strong>Edge cases:</strong> many try/except blocks; returns <code>([], None)</code> if all coercions fail. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Input coercion (<code>_rows_from_iterable</code>) — bytes & string handling</strong>  <br> <strong>Behavior:</strong> bytes/bytearray call <code>parse_csv_safe</code>; if parse returns DataFrame convert to rows/header; list-of-rows path used if pandas absent.  <br> <strong>String path handling:</strong> if path exists and extension indicates CSV-like then <code>parse_csv_safe</code>; else read excerpt and test <code>_is_likely_csv_text</code>; inline CSV triggers parse.  <br> <strong>Edge cases:</strong> path exists but non-CSV extension still checked via sample text. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Input coercion — pandas-like and to_pandas</strong>  <br> <strong>Behavior:</strong> if object exposes <code>to_pandas()</code> call and use result; if <code>_pd.DataFrame</code> or object with <code>.columns</code> & <code>.itertuples</code> convert to rows/header.  <br> <strong>Edge cases:</strong> <code>to_pandas()</code> may fail; exceptions caught and logged. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Input coercion — list-of-dicts</strong>  <br> <strong>Behavior:</strong> preserve insertion order of keys from first dict as columns; for each item produce row of values matching keys; missing keys coerced to empty string; robust to non-dict iterable items by attempting attribute access then fallback to "".  <br> <strong>Edge cases:</strong> exceptions per-item produce empty-row placeholders and are logged.  <br> <strong>Recommendation:</strong> document that list-of-dicts uses first element's keys as canonical column order. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Input coercion — list-of-lists and fallback</strong>  <br> <strong>Behavior:</strong> convert nested lists/tuples to rows; detect header if first row all-strings and more than one row; otherwise treat as data rows.  <br> <strong>Final fallback:</strong> iterate <code>df</code> and coerce each element to list.  <br> <strong>Edge cases:</strong> ensure very large iterables handled lazily upstream to avoid memory blow. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Uniform rows padding (<code>_ensure_uniform_rows</code>)</strong>  <br> <strong>Purpose:</strong> Pad or trim rows to <code>max_cols</code> to ensure consistent column counts.  <br> <strong>Behavior:</strong> determine <code>max_cols</code> then extend or truncate rows; returns <code>(out_rows, max_cols)</code>.  <br> <strong>Complexity:</strong> O(rows * cols).  <br> <strong>Recommendation:</strong> validate <code>max_cols</code> <= <code>_MAX_COLS_SAFE</code> before call. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Alignments extraction (<code>_get_table_alignments</code>)</strong>  <br> <strong>Purpose:</strong> Extract per-column alignments from <code>df._table_alignments</code> or <code>df.alignments</code> if provided.  <br> <strong>Behavior:</strong> return list[str] or None; exceptions logged.  <br> <strong>Recommendation:</strong> normalize length to match detected columns. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Column type heuristics start (<code>_guess_value_type</code>)</strong>  <br> <strong>Purpose:</strong> Classify single cell values into types: <code>empty</code>,<code>boolean</code>,<code>integer</code>,<code>numeric</code>,<code>json</code>,<code>html</code>,<code>diagram</code>,<code>code</code>,<code>datetime</code>,<code>text</code>.  <br> <strong>Behavior / steps:</strong>  <br> 1. Type checks for <code>None</code>, <code>bool</code>, <code>int</code>, <code>float</code>, and container types.  <br> 2. String checks: empty, HTML-like tags, diagram heuristic, code fences, ISO datetime parsing, numeric parsing with comma removal, integer regex <code>_INT_RE</code>.  <br> <strong>Edge cases:</strong> complex strings may match multiple heuristics; order of checks drives outcome. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Column type detection (<code>_detect_column_types</code>)</strong>  <br> <strong>Purpose:</strong> Infer predominant column type per column by sampling up to <code>_COLUMN_TYPE_SAMPLE</code> rows.  <br> <strong>Behavior / steps:</strong>  <br> 1. Initialize counters per column.  <br> 2. Sample rows up to <code>sample_size</code>, call <code>_guess_value_type</code> for each cell, increment counters.  <br> 3. Choose most frequent type per column with sensible fallback from <code>empty</code> to next-most.  <br> 4. Normalize <code>integer</code>+<code>numeric</code> to <code>numeric</code> in result.  <br> <strong>Output:</strong> list of chosen column type tokens.  <br> <strong>Complexity:</strong> O(sample_size * cols).  <br> <strong>Recommendation:</strong> return distribution metadata for caller confidence scoring. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Hidden heading anchor & init script</strong>  <br> <strong>Purpose:</strong> Emit hidden anchors per table and inline bootstrap script that assembles a table navigation UI on the client.  <br> <strong>Behavior:</strong> <code>_make_hidden_heading_anchor</code> emits hidden <code>&lt;a&gt;</code> tags; <code>_heading_init_script</code> finds anchors, builds <code>.table-heading-bar</code> and inserts it defensively with try/catch.  <br> <strong>Edge cases:</strong> DOM absent or CSP blocking inline scripts; script uses many guards.  <br> <strong>Recommendation:</strong> serve as external asset for CSP and caching. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 One-time assets (<code>_one_time_assets</code>)</strong>  <br> <strong>Purpose:</strong> Provide minimal inline CSS/JS and heading init script idempotently.  <br> <strong>Behavior:</strong> returns CSS string + JS closure that guards <code>window.__tv_table_assets_inited</code> then attaches download helpers and stub bind functions then appends <code>_heading_init_script</code>.  <br> <strong>Edge cases:</strong> inline assets increase HTML payload; <code>_ASSETS_EMITTED</code> flag prevents duplication when <code>emit_assets_once</code> true.  <br> <strong>Recommendation:</strong> allow opt-out; externalize to static file. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Safe JSON embed helper (<code>_safe_json_for_script</code>)</strong>  <br> <strong>Purpose:</strong> Prevent <code>&lt;/script&gt;</code> termination via <code>&lt;/</code> escaping.  <br> <strong>Behavior:</strong> simple replace <code>&lt;/</code> -> <code>&lt;\/</code>.  <br> <strong>Edge cases:</strong> minimal; use with <code>json.dumps(..., ensure_ascii=False)</code> output.  <br> <strong>Recommendation:</strong> combine with content-length limits and JSON schema validation. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 CSS class token sanitizer (<code>_class_token</code>)</strong>  <br> <strong>Purpose:</strong> Convert arbitrary type names into safe CSS token fragments.  <br> <strong>Behavior:</strong> lowercases, replaces invalid chars with <code>-</code>, trims non-alphanumerics from ends, returns empty string if nothing safe.  <br> <strong>Edge cases:</strong> empty returns; caller should skip empty token usage.  <br> <strong>Recommendation:</strong> produce deterministic mapping and reserve prefix to avoid clashes with user classes. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Server-side filter (<code>_filter_rows</code>)</strong>  <br> <strong>Purpose:</strong> Conservative row filtering based on criteria dict supporting <code>col_index</code>, <code>equals</code>, <code>contains</code>, <code>in</code>, and numeric comparisons (<code>gt/gte/lt/lte</code>).  <br> <strong>Behavior:</strong> if <code>col_index</code> specified, test that column; otherwise test any cell in row; <code>match</code> coerces types defensively and attempts numeric comparisons then string compare.  <br> <strong>Edge cases:</strong> non-numeric value comparisons handled via exception fallback to string compares; failures logged and ignored for row.  <br> <strong>Recommendation:</strong> push heavy filters to DB or typed engines for large datasets; add criteria validation upfront. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Server-side sort (<code>_sort_rows</code>)</strong>  <br> <strong>Purpose:</strong> Stable, conservative sort implementing numeric-first then lexical fallback.  <br> <strong>Behavior:</strong> key function attempts <code>float(v)</code> then <code>str(v)</code> and uses tuple ranking to prefer numeric sorts.  <br> <strong>Edge cases:</strong> missing cols yield stable fallback; exceptions return copy of original list.  <br> <strong>Recommendation:</strong> allow caller to pass comparator or specify type hints to avoid mis-sorting. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Export CSV bytes (<code>_rows_to_csv_bytes</code>)</strong>  <br> <strong>Purpose:</strong> Serialize rows+header to CSV bytes with quoting and fallback escape.  <br> <strong>Behavior:</strong> write header then rows to <code>io.StringIO</code>, quoting values by doubling <code>&quot;</code> and wrapping fields. On write exceptions, fallback to <code>html.escape</code> for problematic cells.  <br> <strong>Edge cases:</strong> inconsistent column lengths handled by iterating row elements; function returns <code>b&quot;&quot;</code> on fatal failure and logs.  <br> <strong>Recommendation:</strong> use <code>csv.writer</code> with specified dialect for more robust quoting and newline handling. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Export JSON bytes (<code>_rows_to_json_bytes</code>)</strong>  <br> <strong>Purpose:</strong> Convert rows to JSON bytes; if header present output array of objects keyed by header.  <br> <strong>Behavior:</strong> iterate rows and headers to build objects; call <code>json.dumps(..., ensure_ascii=False)</code> and encode.  <br> <strong>Edge cases:</strong> non-serializable cell values coerced implicitly by JSON encoder failing; exceptions logged and function returns empty bytes.  <br> <strong>Recommendation:</strong> sanitize or coerce complex types before dumping. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Export XLSX bytes (<code>_rows_to_xlsx_bytes</code>)</strong>  <br> <strong>Purpose:</strong> Produce <code>.xlsx</code> bytes using <code>xlsxwriter</code> or <code>openpyxl</code> as fallback.  <br> <strong>Behavior:</strong> if <code>xlsxwriter</code> present build in-memory workbook; else if <code>openpyxl</code> present use <code>Workbook</code> append rows; return binary or <code>None</code> on failure.  <br> <strong>Edge cases:</strong> large sheets consume memory; exceptions logged.  <br> <strong>Recommendation:</strong> stream large sheets to temporary file or use row-chunked writing APIs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Data attributes builder (<code>_build_data_attrs</code>)</strong>  <br> <strong>Purpose:</strong> Convert <code>tv_options</code> dict into safe HTML <code>data-tv-*</code> attributes.  <br> <strong>Behavior:</strong> iterate items, generate <code>data-tv-key=&quot;value&quot;</code> where non-primitive values JSON-encoded; HTML-escape keys and values.  <br> <strong>Edge cases:</strong> non-serializable objects coerced to <code>str</code>; keys sanitized by replacing spaces with hyphens.  <br> <strong>Recommendation:</strong> validate keys and values and avoid exposing secrets. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Core rendering: high-level <code>render_table</code> flow</strong>  <br> <strong>Purpose:</strong> Produce full HTML wrapper for a table input with controls, accessibility attributes, assets, lazy chunks, and metadata.  <br> <strong>Inputs / options:</strong> <code>df</code>, <code>idx</code>, <code>markdown_to_html</code>, <code>left_width</code>, <code>right_width</code>, options (<code>debug</code>, <code>table_id</code>, <code>caption</code>, <code>tv_options</code>, <code>auto_type</code>, <code>sticky_header</code>, <code>export_button</code>, <code>lazy_load_threshold</code>, <code>initial_rows</code>, <code>collapsible</code>, <code>collapse_by_default</code>, <code>fragment</code>, <code>inject_assets</code>, <code>emit_assets_once</code>).  <br> <strong>High-level steps:</strong>  <br> 1. Optionally delegate to <code>.convert.render_table</code> for preservation.  <br> 2. Normalize <code>markdown_to_html</code> via <code>_get_md_callable</code>.  <br> 3. If <code>df</code> supports <code>to_html</code> and <code>auto_type</code> false, prefer <code>df.to_html</code> legacy path.  <br> 4. Coerce input to <code>rows, header</code> via <code>_rows_from_iterable</code>.  <br> 5. Check row count against <code>_MAX_ROWS_SAFE_RENDER</code> and warn.  <br> 6. Merge <code>tv_options</code> from <code>df._tv_options</code> and passed <code>options</code>.  <br> 7. Compute lazy split into <code>displayed_rows</code> and <code>remaining_rows</code> if <code>lazy_threshold</code> used.  <br> 8. If <code>auto_type</code> detect column types via <code>_detect_column_types</code>.  <br> 9. Inject one-time assets if not fragment and not already emitted.  <br> 10. Emit hidden anchor and wrapper with unique <code>wrapper_id</code> and <code>table_id</code>.  <br> 11. Render header controls (copy, export, collapse).  <br> 12. Build <code>&lt;table&gt;</code>: caption, thead using <code>_render_cell_text</code> for headers or synthetic headers if missing.  <br> 13. Determine <code>max_cols</code> and clamp to <code>_MAX_COLS_SAFE</code>.  <br> 14. Ensure uniform rows and render <code>&lt;tbody&gt;</code> per <code>displayed_rows</code> using <code>_render_cell_text</code> for cells while setting <code>dir</code>, <code>data-col-type</code>, classes (diagram, col-token).  <br> 15. If <code>remaining_rows</code> embed as safe JSON script chunk for client-side load.  <br> 16. Append row-count and embed <code>table-meta</code> JSON including render timing when <code>debug</code>.  <br> 17. Return concatenated parts string.  <br> <strong>Resilience:</strong> pervasive try/except blocks ensure best-effort HTML even if substeps fail.  <br> <strong>Performance:</strong> cost dominated by per-cell <code>_render_cell_text</code> (regex + markdown + sanitize) leading to O(rows×cols) work.  <br> <strong>Security:</strong> uses <code>_safe_json_for_script</code> and optional <code>sanitize_html</code>.  <br> <strong>Recommendation:</strong> cache per-cell renders, allow skipping sanitization for trusted pipelines, stream large outputs, or implement server pagination/virtualization. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Render_table: header & accessibility details</strong>  <br> <strong>Purpose:</strong> Build accessible heading and header controls and attach ARIA attributes.  <br> <strong>Behavior:</strong> emits <code>&lt;h3 id=&quot;Table{idx}&quot;&gt;</code> inside <code>.table-heading-bar</code>, sets wrapper <code>role=&quot;region&quot; aria-labelledby</code>, table <code>role=&quot;table&quot; aria-labelledby</code>, <code>caption</code> optionally with id referenced.  <br> <strong>Edge cases:</strong> fallback label when caption missing.  <br> <strong>Recommendation:</strong> ensure unique IDs when multiple renderers on page. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Render_table: header cell controls & sorting UI</strong>  <br> <strong>Purpose:</strong> Add per-column sort buttons, visual affordances and <code>data-col-type</code> attributes.  <br> <strong>Behavior:</strong> header cells include inner <code>&lt;div class=&quot;th-with-sort&quot;&gt;</code> with header HTML and sort button; when no header, synthesize <code>Col N</code> labels and attach sort buttons.  <br> <strong>Recommendation:</strong> expose server-side hooks to apply default sort state and emit sort snapshots. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Render_table: tbody rendering details</strong>  <br> <strong>Purpose:</strong> Render each visible row and cell safely with alignment, direction, and type classes.  <br> <strong>Behavior:</strong> compute <code>max_cols</code>, clamp to safety cap, call <code>_ensure_uniform_rows</code>, for each cell compute <code>cell_html = _render_cell_text</code>, <code>dir</code> via <code>_dir_for_text</code>, class tokens via <code>_class_token</code>, and append <code>&lt;td data-label=... data-col-type=... dir=...&gt;cell_html&lt;/td&gt;</code>.  <br> <strong>Edge cases:</strong> exceptions per-cell replaced with empty string; diagrams flagged with <code>cell-diagram</code> class via <code>_is_diagram_text</code>.  <br> <strong>Recommendation:</strong> lazy-render or virtualize table in client when displayed rows large. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Render_table: lazy chunk embedding</strong>  <br> <strong>Purpose:</strong> Provide client-side chunk for "load more" without streaming initial HTML.  <br> <strong>Behavior:</strong> remaining rows are sanitized/coerced to primitive types then JSON-dumped and put inside <code>&lt;script type=&quot;application/json&quot; class=&quot;table-row-chunk&quot; data-table-id=&quot;...&quot;&gt;</code> after <code>_safe_json_for_script</code>.  <br> <strong>Edge cases:</strong> chunk size impacts payload and memory; embedding large chunks defeats lazy load purpose.  <br> <strong>Recommendation:</strong> keep chunks small and use server pagination for very large datasets. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Render_table: metadata & diagnostics</strong>  <br> <strong>Purpose:</strong> Emit machine-readable <code>table-meta</code> JSON including <code>table_id</code>, <code>rows</code>, <code>displayed_rows</code>, <code>cols</code>, <code>tv_options</code>, <code>caption</code>, and optional <code>render_ms</code>.  <br> <strong>Behavior:</strong> compute timing when <code>debug</code> and embed via <code>_safe_json_for_script</code>.  <br> <strong>Recommendation:</strong> surface metadata endpoint for telemetry and offload heavy instrumentation from page. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Fragment wrapper & compatibility functions</strong>  <br> <strong>Purpose:</strong> <code>render_fragment</code> to produce fragment-only output (no assets). <code>simple_render_table</code> fallback produces minimal HTML for environments where full renderer fails.  <br> <strong>Behavior:</strong> <code>render_fragment</code> sets <code>fragment=True</code> and disables asset injection. <code>simple_render_table</code> tries <code>df.to_html</code> or constructs minimal <code>&lt;table&gt;</code> with escaped text.  <br> <strong>Recommendation:</strong> keep <code>simple_render_table</code> for testing or email templates only. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Public API surface & export list</strong>  <br> <strong>Exports:</strong> <code>render_table</code>, <code>render_fragment</code>, <code>simple_render_table</code> and many helpers including <code>_render_cell_text</code>, <code>_rows_from_iterable</code>, <code>_get_table_alignments</code>, <code>_stash_code_local</code>, <code>_restore_code_placeholders_in_html</code>, <code>_preprocess_underscores_outside_placeholders</code>, <code>_restore_protection_entities</code>, <code>_make_hidden_heading_anchor</code>, <code>_heading_init_script</code>, <code>_filter_rows</code>, <code>_sort_rows</code>, <code>_rows_to_csv_bytes</code>, <code>_rows_to_json_bytes</code>, <code>_rows_to_xlsx_bytes</code>, <code>parse_csv_safe</code>.  <br> <strong>Recommendation:</strong> document public vs private helpers and keep internal helpers prefixed with <code>_</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Testing matrix & validation checklist</strong>  <br> <strong>Unit tests (recommended):</strong>  <br> 1. Inputs: bytes, file path, inline CSV, DataFrame, list-of-dicts, list-of-lists.  <br> 2. CSV heuristics: pipe-table vs CSV edge cases.  <br> 3. Charset detection: various encodings with BOMs.  <br> 4. Sanitization: HTML/JS injection cases with and without <code>sanitize_html</code>.  <br> 5. Column type inference: mixed types and sampling limits.  <br> 6. Lazy chunk embedding and load-more correctness.  <br> 7. Asset injection idempotence and CSP behavior. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Performance & scalability notes</strong>  <br> <strong>Costs:</strong> per-cell markdown + sanitize dominates CPU and memory. Building full <code>parts</code> list in RAM scales with rendered HTML size.  <br> <strong>Practical mitigations:</strong> caching rendered cell HTML, disabling per-cell sanitization for trusted inputs, streaming render or server pagination, and moving heavy normalization off the request thread.  <br> <strong>Recommendation:</strong> set practical defaults (e.g., <code>initial_rows=200</code>, <code>lazy_load_threshold</code>) and document them. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Security considerations</strong>  <br> <strong>XSS mitigations:</strong> <code>html.escape</code> fallbacks, <code>sanitize_html</code> usage when available, <code>_safe_json_for_script</code> for embedded JSON.  <br> <strong>Exposures:</strong> <code>tv_options</code> serialized into <code>data-</code> attributes may leak sensitive info if not filtered.  <br> <strong>Recommendation:</strong> default to sanitize, validate <code>tv_options</code> whitelist, and review CSP headers when injecting inline scripts. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Operational & deployment recommendations</strong>  <br> <strong>Short-term:</strong> add capability diagnostics to log optional dependency availability; unit tests for CSV heuristics and sanitizer signatures.  <br> <strong>Medium-term:</strong> externalize assets, add streaming/template partials, and provide server pagination endpoints.  <br> <strong>Long-term:</strong> pre-render heavy tables as static assets or use worker processes to offload normalization and sanitization. </td></tr><tr><td data-label="Technical Breakdown"> <strong>📌 Final: checklist before merge</strong>  <br> <strong>Pre-merge steps:</strong>  <br> 1. Run unit tests for all input coercions and edge CSV cases.  <br> 2. Verify sanitizer signature compatibility (<code>allow_tables</code> param path).  <br> 3. Confirm <code>_ASSETS_EMITTED</code> behavior in multi-threaded server setups.  <br> 4. Audit <code>data-tv-*</code> output for sensitive fields.  <br> 5. Add integration test rendering a large table to measure memory and latency.  <br> <strong>Recommendation:</strong> after these checks, merge with feature flag enabling streaming or pagination for >10k rows. </td></tr></tbody></table></div><div class="row-count">Rows: 45</div></div><div class="table-caption" id="Table20" data-table="Book_8052_20" style="margin-top:2mm;margin-left:3mm;"><strong>Table 20 — style.css</strong></div>
<div class="table-wrapper" data-table-id="table-20"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Section / Selector**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Section / Selector</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Technical Breakdown &amp; Notes**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown & Notes</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Section / Selector"> <code>:root { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Defines CSS custom properties (variables) for colors, typography, spacing, transitions, code styles, and responsive helpers. Variables enable theme management (light/dark/high-contrast) and consistent reuse across multiple selectors. Key variables include <code>--bg</code>, <code>--text</code>, <code>--panel</code>, <code>--border</code>, <code>--row-hover</code>, <code>--highlight</code>, <code>--current-row</code> for table theming, and <code>--button-bg</code>, <code>--button-text</code> for consistent button styling. Motion and transition variables (<code>--trans-duration</code>, <code>--easing</code>) allow unified animation adjustments. <code>--font-sans</code> and <code>--font-mono</code> support readable and monospace typography. Accessibility and measurement variables (<code>--focus-ring</code>, <code>--focus-bg</code>, <code>--measure</code>) improve legibility and interaction feedback. </td></tr><tr><td data-label="Section / Selector"> <code>@media (prefers-contrast: more)</code> </td><td data-label="Technical Breakdown &amp; Notes"> High contrast additive mode. Overrides base colors to enhance visibility. Borders, text, button backgrounds, and TOC links are adjusted to higher contrast values to meet accessibility standards. Muted text darkened for legibility. Focus-ring opacity increased to emphasize keyboard navigation. </td></tr><tr><td data-label="Section / Selector"> <code>@media (prefers-color-scheme: dark)</code> </td><td data-label="Technical Breakdown &amp; Notes"> Dark mode overrides for all major colors including background, panel, text, borders, row hover, highlight, buttons, TOC links, and code blocks. Ensures high contrast and readability in low-light environments. Dark theme variables are separate from explicit <code>data-theme=&quot;dark&quot;</code> to allow dynamic theme switching. </td></tr><tr><td data-label="Section / Selector"> <code>[data-theme=&quot;dark&quot;] { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Explicit dark mode override for users or scripts applying <code>data-theme=&quot;dark&quot;</code>. Mirrors prefers-color-scheme dark values. Ensures consistent rendering even if the system does not signal dark preference. </td></tr><tr><td data-label="Section / Selector"> <code>*, *::before, *::after { box-sizing: border-box; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Global normalization of box-sizing. Prevents unexpected sizing when padding and borders are applied. Essential for tables, buttons, containers, and responsive elements. </td></tr><tr><td data-label="Section / Selector"> <code>html, body { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Sets global layout, typography, and base responsive scaling. Uses <code>clamp()</code> for fluid font sizing (<code>15px</code> min, <code>16px</code> max) with a viewport relative unit for scalability. Line-height, text rendering, and font smoothing optimized for readability. Transitions added for background and color to support smooth theme changes. </td></tr><tr><td data-label="Section / Selector"> <code>a { color: inherit; text-decoration: none; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Neutral link styling to inherit text color and remove default underlines. Transition added for hover effects when needed. Later overridden for content-specific links. </td></tr><tr><td data-label="Section / Selector"> <code>img, video, svg { max-width: 100%; height: auto; display: block; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Responsive media handling. Prevents overflow in containers and maintains aspect ratio. </td></tr><tr><td data-label="Section / Selector"> <code>code, pre, kbd { font-family: var(--font-mono); }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Enforces monospace font for code-related elements for consistent alignment and readability. </td></tr><tr><td data-label="Section / Selector"> <code>button { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Base button styling with background, border, color, padding, border-radius, and hover/active states. Transforms and box-shadow used for tactile feedback. <code>will-change: transform</code> hints for GPU acceleration. Focus-visible support with outline and background for keyboard users. </td></tr><tr><td data-label="Section / Selector"> <code>.table-container { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Horizontal scroll container for tables. Supports mobile touch scrolling via <code>-webkit-overflow-scrolling: touch</code>. Rounded corners applied. Ensures tables remain responsive without breaking layout. </td></tr><tr><td data-label="Section / Selector"> <code>table { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Base table styling. Fixed table-layout, word-wrap, and min-width enforced for responsiveness. Collapsed borders and consistent font stack ensure visual uniformity. <code>font-size</code> set to 15px with <code>min-width</code> fallback. </td></tr><tr><td data-label="Section / Selector"> <code>thead th, th { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Sticky header styling with padding, alignment, background, font weight, and z-index. <code>scroll-margin-top</code> ensures anchor navigation does not hide headers. Position sticky enables persistence while scrolling. </td></tr><tr><td data-label="Section / Selector"> <code>tbody td, td { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Table cell styling. Breaks long words and wraps text for readability. Vertical alignment ensures consistency with variable content heights. </td></tr><tr><td data-label="Section / Selector"> <code>table strong, table b { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Emphasized text in tables uses slightly heavier font-weight and subtle letter-spacing adjustment for readability. </td></tr><tr><td data-label="Section / Selector"> <code>tr:nth-child(even) { background: var(--bg); }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Alternating row color for visual distinction. </td></tr><tr><td data-label="Section / Selector"> <code>tr:hover td { background: var(--row-hover); }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Hover state highlighting. Improves row selection visibility. </td></tr><tr><td data-label="Section / Selector"> <code>.highlight { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Temporary highlighting for dynamic row interactions, e.g., search results. </td></tr><tr><td data-label="Section / Selector"> <code>.current-row td { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Persistent row highlighting, often used for active selection or focus tracking. </td></tr><tr><td data-label="Section / Selector"> <code>thead th:first-child, td:first-child { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Sticky first column. Maintains visibility while horizontally scrolling. <code>z-index</code> ensures stacking above other cells. Box-shadow for subtle separation. Min-width ensures content readability. </td></tr><tr><td data-label="Section / Selector"> <code>.sort-btn { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Sorting button for table headers. Flex layout with gap, subtle opacity when inactive, transitions for hover and focus. Supports accessibility via focus-visible outlines. </td></tr><tr><td data-label="Section / Selector"> <code>#stickyMainHeader { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Sticky page header with shadow and background transitions. Flex layout supports multiple child elements and spacing. Optimized for both desktop and mobile. </td></tr><tr><td data-label="Section / Selector"> <code>#tv-header { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Top-level header container with flexible layout. Supports responsive wrapping and alignment for logo, buttons, and inputs. <code>gap</code> ensures consistent spacing. </td></tr><tr><td data-label="Section / Selector"> <code>#tv-header button, #tv-header .btn, #stickyMainHeader button { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Smaller buttons in header area. Compact sizing for mobile compatibility. Min-height/width ensures touch-friendly targets. </td></tr><tr><td data-label="Section / Selector"> <code>#tv-header input[type=&quot;search&quot;], #tv-header input[type=&quot;text&quot;], ...</code> </td><td data-label="Technical Breakdown &amp; Notes"> Flexible input fields in headers. <code>flex: 1 1</code> allows scaling. Min-width ensures usability on small screens. Transitions for focus highlight. </td></tr><tr><td data-label="Section / Selector"> <code>#tocBar { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Table of contents bar. Horizontal scrolling for overflow. Flex layout with gap for individual link items. Hover background and color transitions for user feedback. </td></tr><tr><td data-label="Section / Selector"> <code>.th-with-sort, thead th[role=&quot;button&quot;] { cursor: pointer; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Explicit pointer cursor for interactive header cells. Improves affordance. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper .table-header-wrapper { gap: 8px; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Header wrapper inside table container ensures spacing between controls and labels. </td></tr><tr><td data-label="Section / Selector"> <code>.table-controls { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Flexible container for all table control buttons, links, and toggle elements. Supports wrapping and consistent alignment across varying table markup. </td></tr><tr><td data-label="Section / Selector"> <code>.table-controls a, .table-controls button, ...</code> </td><td data-label="Technical Breakdown &amp; Notes"> Unified button styling across <code>&lt;a&gt;</code>, <code>&lt;button&gt;</code>, <code>&lt;summary&gt;</code>, and custom elements. Ensures visual consistency, padding, and alignment. Transitions applied for hover and focus. </td></tr><tr><td data-label="Section / Selector"> <code>.table-controls summary { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Removes default details marker and enforces consistent padding, cursor, and list-style removal. </td></tr><tr><td data-label="Section / Selector"> <code>.table-controls .toggle-table-btn { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Table collapse toggle with transform for rotation upon collapse. Transitions ensure smooth animation. Responsive overrides reduce padding and enforce icon-only display on mobile. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper.table-collapsed .table-container table tbody { display: none; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Hides table body when collapsed. Complementary to toggle button rotation. </td></tr><tr><td data-label="Section / Selector"> <code>.copy-buttons { display:flex; gap:8px; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Layout for copy/export buttons. Ensures proper spacing and alignment with tables. </td></tr><tr><td data-label="Section / Selector"> <code>.copy-button-output pre, .copy-button-table pre { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Preformatted output styling. Ensures monospace rendering, scrollable overflow, and proper padding for copied content. </td></tr><tr><td data-label="Section / Selector"> <code>.table-caption { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Caption styling for accessibility and print-friendliness. Fallback margin ensures consistent spacing. Strong tags inherit font weight to prevent over-emphasis. </td></tr><tr><td data-label="Section / Selector"> <code>td[data-col-type=&quot;numeric&quot;], th[data-col-type=&quot;numeric&quot;] { text-align: right; font-variant-numeric: tabular-nums; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Numeric column alignment and tabular number variant for precise layout. </td></tr><tr><td data-label="Section / Selector"> <code>td[data-col-type=&quot;code&quot;], th[data-col-type=&quot;code&quot;] { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Code columns enforce monospace font, nowrap, and slightly reduced font-size. Ensures code readability. </td></tr><tr><td data-label="Section / Selector"> <code>td[data-col-type=&quot;date&quot;], th[data-col-type=&quot;date&quot;] { text-align: center; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Center-aligns date columns. Improves readability and consistency. </td></tr><tr><td data-label="Section / Selector"> <code>@media (prefers-reduced-motion: reduce) { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Reduces motion and disables transitions/animations for users with accessibility preferences. Applies to buttons, hover effects, and global animations. </td></tr><tr><td data-label="Section / Selector"> <code>#backToTop { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Back-to-top floating button. Positioned fixed with transition on hover for smooth visual feedback. Hidden by default; displayed via JS when needed. </td></tr><tr><td data-label="Section / Selector"> <code>td ul, td ol { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Styling for lists within table cells. Removes native bullets, adds custom markers (<code>–</code> or numeric counters), supports nested lists with adjusted margin/padding and smaller bullets for readability. </td></tr><tr><td data-label="Section / Selector"> <code>code, pre code, td code { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Comprehensive code styling. Background color varies by context (inline vs table). Preformatted code uses block display, padding, and scrollable overflow. Dark mode overrides ensure contrast. </td></tr><tr><td data-label="Section / Selector"> <code>kbd { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Keyboard input representation. Consistent monospace font, background, border, padding, and subtle inset shadow. Dark mode adapts background and border opacity. </td></tr><tr><td data-label="Section / Selector"> <code>sup, sub { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Superscript and subscript styling. Adjusted font-size and vertical alignment. </td></tr><tr><td data-label="Section / Selector"> <code>.small, .footnote { font-size: .85em; color: var(--muted); }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Auxiliary text styling for footnotes and minor labels. </td></tr><tr><td data-label="Section / Selector"> <code>a { color: var(--accent); text-decoration: underline; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Stronger link affordance for readable content, differentiating links in markdown and content areas. Hover states underline for interaction feedback. </td></tr><tr><td data-label="Section / Selector"> <code>thead th a, th a { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Neutralizes anchor styles inside table headers. Prevents default focus outline, tap highlight, background, and box-shadow. Maintains inherited color for header readability. </td></tr><tr><td data-label="Section / Selector"> <code>::selection { background: rgba(37,99,235,0.25); color: var(--text); }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Custom text selection color. Maintains readability and accessibility. </td></tr><tr><td data-label="Section / Selector"> <code>.emoji { font-family: var(--emoji-fonts); font-size: 1em; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Emoji fallback fonts to ensure consistent display across platforms. </td></tr><tr><td data-label="Section / Selector"> <code>.markdown, .content, p, li, td { hyphens: auto; word-break: break-word; overflow-wrap: anywhere; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Handles long words and hyphenation, improves multi-language support and prevents layout overflow. </td></tr><tr><td data-label="Section / Selector"> <code>.katex, .MathJax { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Math rendering support with display block for block math, inline adjustments, scrollable overflow, and centered alignment. </td></tr><tr><td data-label="Section / Selector"> <code>.table-heading-bar, .table-heading { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Styling for table headings outside of <code>&lt;thead&gt;</code>. Includes background, padding, font-weight, alignment, and sticky behavior. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper .collapse-indicator { transition: transform var(--trans-duration) var(--easing); }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Rotating indicator for collapsed tables. Smooth transform animation. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper .cell-highlight { background: var(--highlight); }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Cell-specific highlight for search or selection. </td></tr><tr><td data-label="Section / Selector"> <code>@media (max-width: 900px) { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Responsive adjustments for smaller screens. Font-size reduction, padding reduction, table controls stacked vertically, icon-only enforcement. Sticky headers adapt. </td></tr><tr><td data-label="Section / Selector"> <code>@media (max-width: 600px) { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Stronger responsive enforcement. Hide less-important header elements, table caption adjustments, minimal padding on buttons, enforce icon-only toggle. </td></tr><tr><td data-label="Section / Selector"> <code>@media (max-width: 420px) { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Ultra-small screens. Horizontal scroll for table controls, hide non-essential elements, force mobile-friendly layout. </td></tr><tr><td data-label="Section / Selector"> <code>@media print { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Print optimizations. Light theme enforced, sticky headers disabled, first-column sticky removed, table borders and background solid for clarity. Pre/code wraps preserved. </td></tr><tr><td data-label="Section / Selector"> <code>.visually-hidden, .sr-only { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Accessibility helpers. Hidden from layout but readable by screen readers. </td></tr><tr><td data-label="Section / Selector"> <code>.content, .chat, article, #mainContent { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Chat/markdown content container styling. Max-width via <code>--measure</code>, margin auto, hyphens auto, line-height 1.5 for readability. Supports text blocks, lists, tables. </td></tr><tr><td data-label="Section / Selector"> <code>h1,h2,h3,h4,h5,h6 { scroll-margin-top: 6rem; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Anchor scrolling adjustment for sticky headers. Ensures headings not obscured. </td></tr><tr><td data-label="Section / Selector"> <code>blockquote { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Blockquote styling with left border, background color, padding, and italic font style for visual distinction. </td></tr><tr><td data-label="Section / Selector"> <code>pre { white-space: pre; overflow-x: auto; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Preformatted blocks scrollable horizontally. Preserves whitespace and code layout. </td></tr><tr><td data-label="Section / Selector"> <code>strong { font-weight: 600; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Unified strong emphasis across content. </td></tr><tr><td data-label="Section / Selector"> <code>table tr td code, table tr th code { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Code inside tables inherits font, background, padding, border-radius, scrollable overflow. Dark mode adjusted for contrast. </td></tr><tr><td data-label="Section / Selector"> <code>a:focus-visible, button:focus-visible, input:focus-visible { outline: 2px solid var(--focus-ring); outline-offset: 2px; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Accessibility: keyboard focus indicator for all interactive elements. </td></tr><tr><td data-label="Section / Selector"> <code>.toggle-table-btn svg { width: 1em; height: 1em; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Icon sizing enforcement for toggle buttons, scales with font-size. </td></tr><tr><td data-label="Section / Selector"> <code>.table-controls .btn-icon-only { width: 36px; height: 36px; min-width:36px; min-height:36px; padding:0; display:flex; justify-content:center; align-items:center; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Mobile optimization: enforce square icon-only buttons. Prevents accidental text overflow. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper.table-collapsed tbody { display: none; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Body hidden when collapsed. Maintains DOM for accessibility and screen readers. </td></tr><tr><td data-label="Section / Selector"> <code>.copy-buttons button.copy-btn { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Copy buttons styled to match main button theme. Hover, focus, and active states match UI. </td></tr><tr><td data-label="Section / Selector"> <code>.copy-button-output pre { max-height: 400px; overflow-y: auto; padding: 8px; background: var(--panel); border-radius: 4px; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Limits height for long copied blocks. Scrollable overflow ensures layout stability. </td></tr><tr><td data-label="Section / Selector"> <code>.content pre code, .table-container pre code { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Fenced code blocks styled for readability, with background, padding, border-radius, tabular numbers. </td></tr><tr><td data-label="Section / Selector"> <code>.th-with-sort .sort-icon { width: 1em; height: 1em; vertical-align: middle; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Sorting icon sizing and alignment with text. Ensures consistent table header alignment. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody tr td:first-child, th:first-child { position: sticky; left:0; z-index: 2; background: var(--panel); }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Sticky first column for better horizontal navigation. Ensures content visibility while scrolling horizontally. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody tr:hover td:first-child { box-shadow: inset -2px 0 0 rgba(0,0,0,0.1); }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Subtle shadow for sticky first column on hover for depth cue. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td ul, .table-wrapper table tbody td ol { padding-left: 16px; margin:0; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Inner cell list padding to maintain readability. Nested lists increase padding by 8px. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td ol li::marker { content: counter(li) &quot;. &quot;; font-weight: 500; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Numbered list inside table cell uses CSS counters for semantic numbering. Supports multi-line list items. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td ul li::before { content: &quot;– &quot;; font-weight: 500; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Custom bullet for unordered lists inside table cells. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td code { font-family: var(--font-mono); background: rgba(220,220,220,0.2); padding: 1px 4px; border-radius:2px; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Inline code inside table cells visually distinct from surrounding text. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td pre code { display:block; padding:8px; background: var(--panel); border-radius:4px; overflow-x:auto; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Block code inside table cells scrollable and visually separated. </td></tr><tr><td data-label="Section / Selector"> <code>.table-caption { font-weight: 600; font-size:0.95em; margin-top:0.5em; margin-bottom:0.5em; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Table captions styled for prominence without overpowering table content. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper .collapse-indicator { transition: transform 0.2s ease-in-out; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Rotating indicator animation smooth. Ensures user sees collapse state. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper .cell-highlight { background: var(--highlight); }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Cell-level highlight for search or selection. Can be animated for transient attention cues. </td></tr><tr><td data-label="Section / Selector"> <code>.content .footnote { font-size:0.85em; color:var(--muted); }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Footnotes rendered smaller with muted color for distinction without distraction. </td></tr><tr><td data-label="Section / Selector"> <code>@media print { body { background: #fff; color: #000; } table { border-collapse: collapse; } thead th { position: static; } th, td { border:1px solid #000; } pre, code { white-space: pre-wrap; word-wrap: break-word; } }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Print mode ensures all content visible, sticky headers disabled, borders reinforced for clarity. Pre/code blocks wrap to avoid overflow. </td></tr><tr><td data-label="Section / Selector"> <code>*::selection { background: rgba(37,99,235,0.25); color: var(--text); }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Selection highlight consistent across browsers. </td></tr><tr><td data-label="Section / Selector"> <code>.emoji { font-family: &quot;Apple Color Emoji&quot;,&quot;Segoe UI Emoji&quot;,&quot;Segoe UI Symbol&quot;,&quot;Noto Color Emoji&quot;,sans-serif; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Emoji fallback stack ensures cross-platform consistency. </td></tr><tr><td data-label="Section / Selector"> <code>.content, .chat, #mainContent article { max-width: var(--measure); margin:auto; hyphens:auto; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Centralizes main content, limits line width for readability, supports responsive typography and wrapping. </td></tr><tr><td data-label="Section / Selector"> <code>.chat p, .chat li, .chat td { line-height:1.5; margin-bottom:0.5em; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Chat text spacing optimized for reading, avoiding cramped layout. </td></tr><tr><td data-label="Section / Selector"> <code>h1,h2,h3,h4,h5,h6 { scroll-margin-top:6rem; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Sticky header offset ensures anchor scrolling does not obscure headings. </td></tr><tr><td data-label="Section / Selector"> <code>blockquote { padding:8px 16px; border-left:4px solid var(--accent); background: rgba(0,0,0,0.03); font-style:italic; margin:8px 0; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Blockquotes visually distinct. Left border and background cue separation from content. </td></tr><tr><td data-label="Section / Selector"> <code>pre { white-space: pre; overflow-x:auto; padding:8px; background: var(--panel); border-radius:4px; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Preformatted blocks scrollable, with padding and background to distinguish code blocks. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td code, .table-wrapper table tbody td pre code { font-size:0.9em; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Slightly smaller code in table cells for compact layout. </td></tr><tr><td data-label="Section / Selector"> <code>.th-with-sort .sort-icon { margin-left:4px; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Spacing between header text and sort icon improves readability. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody tr:hover td:first-child { box-shadow: inset -2px 0 0 rgba(0,0,0,0.1); }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Visual cue for sticky first column during row hover for UX depth. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td ul, ol { margin:0; padding-left:16px; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Cell lists are padded and margin reset for consistency. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td ul li::before, ol li::marker { font-weight:500; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Visual differentiation for list markers. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td pre code { overflow-x:auto; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Horizontal scroll ensures no content clipping. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td[data-col-type=&quot;numeric&quot;] { text-align:right; font-variant-numeric:tabular-nums; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Numeric columns aligned for readability and layout precision. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td[data-col-type=&quot;code&quot;] { font-family: var(--font-mono); white-space:nowrap; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Enforces monospace and prevents wrapping for inline code columns. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td[data-col-type=&quot;date&quot;] { text-align:center; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Dates centered for consistency and aesthetic balance. </td></tr><tr><td data-label="Section / Selector"> <code>.table-controls .btn-icon-only { width:36px;height:36px;display:flex;align-items:center;justify-content:center; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Mobile-first design, ensures square touch targets for icon-only buttons. </td></tr><tr><td data-label="Section / Selector"> <code>@media (max-width:420px) { .table-controls a, button, summary { padding:0; min-width:36px; min-height:36px; } }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Enforces minimal touch-friendly dimensions for ultra-small devices. </td></tr><tr><td data-label="Section / Selector"> <code>.copy-buttons { display:flex; gap:8px; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Copy/export button container maintains spacing and alignment. </td></tr><tr><td data-label="Section / Selector"> <code>.copy-buttons button.copy-btn { padding:4px 8px; border-radius:4px; background:var(--button-bg); color:var(--button-text); transition: all 0.2s ease-in-out; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Styled to match main buttons. Hover/focus state consistent with theme. </td></tr><tr><td data-label="Section / Selector"> <code>.copy-button-output pre { max-height:400px; overflow-y:auto; background:var(--panel); border-radius:4px; padding:8px; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Ensures long code blocks or copied content remain contained and scrollable. </td></tr><tr><td data-label="Section / Selector"> <code>.content pre code, .table-container pre code { background:var(--panel); padding:8px; border-radius:4px; overflow-x:auto; display:block; font-family:var(--font-mono); font-size:0.95em; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Code blocks styled consistently, with padding, scroll, and monospace font. </td></tr><tr><td data-label="Section / Selector"> <code>.table-caption { font-weight:600; font-size:0.95em; margin:0.5em 0; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Caption styled to be visually separated but not overpowering. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper .collapse-indicator { transition:transform 0.2s ease-in-out; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Smooth visual cue for collapsed/expanded tables. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper .cell-highlight { background:var(--highlight); }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Cell-level highlighting for search or selection. Supports transient animation if needed. </td></tr><tr><td data-label="Section / Selector"> <code>.content .footnote { font-size:0.85em; color:var(--muted); }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Footnotes smaller and muted for minimal distraction. </td></tr><tr><td data-label="Section / Selector"> <code>@media print { body { background:#fff;color:#000; } table { border-collapse:collapse; } thead th { position:static; } th, td { border:1px solid #000; } pre, code { white-space:pre-wrap; word-wrap:break-word; } }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Print-friendly overrides: light background, border enforcement, sticky headers disabled, pre/code blocks wrap. </td></tr><tr><td data-label="Section / Selector"> <code>*::selection { background: rgba(37,99,235,0.25); color: var(--text); }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Text selection visual feedback consistent across browsers. </td></tr><tr><td data-label="Section / Selector"> <code>.emoji { font-family:&quot;Apple Color Emoji&quot;,&quot;Segoe UI Emoji&quot;,&quot;Segoe UI Symbol&quot;,&quot;Noto Color Emoji&quot;,sans-serif; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Cross-platform emoji font stack. </td></tr><tr><td data-label="Section / Selector"> <code>.content, .chat, #mainContent article { max-width: var(--measure); margin:auto; hyphens:auto; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Centered content, readable width, responsive hyphenation. </td></tr><tr><td data-label="Section / Selector"> <code>.chat p, .chat li, .chat td { line-height:1.5; margin-bottom:0.5em; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Text spacing optimized for chat and markdown content. </td></tr><tr><td data-label="Section / Selector"> <code>h1,h2,h3,h4,h5,h6 { scroll-margin-top:6rem; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Sticky header offset for anchor navigation. </td></tr><tr><td data-label="Section / Selector"> <code>blockquote { padding:8px 16px; border-left:4px solid var(--accent); background: rgba(0,0,0,0.03); font-style:italic; margin:8px 0; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Blockquotes visually distinct, improved readability. </td></tr><tr><td data-label="Section / Selector"> <code>pre { white-space:pre; overflow-x:auto; padding:8px; background:var(--panel); border-radius:4px; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Preformatted code blocks scrollable horizontally. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td code, .table-wrapper table tbody td pre code { font-size:0.9em; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Slightly smaller code in table cells for compactness. </td></tr><tr><td data-label="Section / Selector"> <code>.th-with-sort .sort-icon { margin-left:4px; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Sorting icon spacing improves visual separation from header text. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody tr:hover td:first-child { box-shadow: inset -2px 0 0 rgba(0,0,0,0.1); }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Depth cue for sticky first column hover. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td ul, ol { margin:0; padding-left:16px; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> List padding inside cells ensures proper alignment. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td ul li::before, ol li::marker { font-weight:500; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Visual marker styling for lists inside table cells. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td pre code { overflow-x:auto; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Ensures no code content clipping in table cells. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td[data-col-type=&quot;numeric&quot;] { text-align:right; font-variant-numeric:tabular-nums; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Numeric columns aligned and use tabular numbers. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td[data-col-type=&quot;code&quot;] { font-family:var(--font-mono); white-space:nowrap; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Monospace and no-wrap enforced for code columns. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td[data-col-type=&quot;date&quot;] { text-align:center; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Dates centered for clarity. </td></tr><tr><td data-label="Section / Selector"> <code>.table-controls .btn-icon-only { width:36px;height:36px; display:flex; justify-content:center; align-items:center; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Mobile-friendly square buttons for icon-only controls. </td></tr><tr><td data-label="Section / Selector"> <code>@media (max-width:420px) { .table-controls a, button, summary { padding:0; min-width:36px; min-height:36px; } }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Ultra-small screen enforcement for touch targets. </td></tr><tr><td data-label="Section / Selector"> <code>.copy-buttons { display:flex; gap:8px; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Copy/export button container. </td></tr><tr><td data-label="Section / Selector"> <code>.copy-buttons button.copy-btn { padding:4px 8px; border-radius:4px; background:var(--button-bg); color:var(--button-text); transition: all 0.2s ease-in-out; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Buttons visually match main UI. Hover and focus states aligned with theme. </td></tr><tr><td data-label="Section / Selector"> <code>.copy-button-output pre { max-height:400px; overflow-y:auto; background:var(--panel); border-radius:4px; padding:8px; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Scrollable container for copied content. </td></tr><tr><td data-label="Section / Selector"> <code>.content pre code, .table-container pre code { background:var(--panel); padding:8px; border-radius:4px; overflow-x:auto; display:block; font-family:var(--font-mono); font-size:0.95em; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Block code styling consistent for tables and markdown. </td></tr><tr><td data-label="Section / Selector"> <code>.table-caption { font-weight:600; font-size:0.95em; margin:0.5em 0; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Table caption prominence controlled. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper .collapse-indicator { transition:transform 0.2s ease-in-out; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Smooth rotation indicator for collapsed tables. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper .cell-highlight { background:var(--highlight); }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Cell highlight support for search and selection. </td></tr><tr><td data-label="Section / Selector"> <code>.content .footnote { font-size:0.85em; color:var(--muted); }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Footnote rendering with muted styling. </td></tr><tr><td data-label="Section / Selector"> <code>@media print { ... }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Print mode enforces light theme, disables sticky positioning, ensures table borders, wraps pre/code content. </td></tr><tr><td data-label="Section / Selector"> <code>*::selection { background: rgba(37,99,235,0.25); color: var(--text); }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Selection highlight. </td></tr><tr><td data-label="Section / Selector"> <code>.emoji { font-family:&quot;Apple Color Emoji&quot;,&quot;Segoe UI Emoji&quot;,&quot;Segoe UI Symbol&quot;,&quot;Noto Color Emoji&quot;,sans-serif; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Emoji font stack for cross-platform support. </td></tr><tr><td data-label="Section / Selector"> <code>.content, .chat, #mainContent article { max-width: var(--measure); margin:auto; hyphens:auto; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Centralized content with readable line length and hyphenation. </td></tr><tr><td data-label="Section / Selector"> <code>.chat p, .chat li, .chat td { line-height:1.5; margin-bottom:0.5em; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Chat and content spacing optimized for readability. </td></tr><tr><td data-label="Section / Selector"> <code>h1,h2,h3,h4,h5,h6 { scroll-margin-top:6rem; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Sticky header offset for anchor navigation. </td></tr><tr><td data-label="Section / Selector"> <code>blockquote { padding:8px 16px; border-left:4px solid var(--accent); background: rgba(0,0,0,0.03); font-style:italic; margin:8px 0; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Blockquote visual distinction. </td></tr><tr><td data-label="Section / Selector"> <code>pre { white-space:pre; overflow-x:auto; padding:8px; background:var(--panel); border-radius:4px; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Scrollable pre blocks. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td code, .table-wrapper table tbody td pre code { font-size:0.9em; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Slightly smaller code in table cells. </td></tr><tr><td data-label="Section / Selector"> <code>.th-with-sort .sort-icon { margin-left:4px; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Header icon spacing. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody tr:hover td:first-child { box-shadow: inset -2px 0 0 rgba(0,0,0,0.1); }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Sticky column hover cue. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td ul, ol { margin:0; padding-left:16px; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> List padding in cells. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td ul li::before, ol li::marker { font-weight:500; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> List markers in cells styled. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td pre code { overflow-x:auto; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Ensures scrollable code. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td[data-col-type=&quot;numeric&quot;] { text-align:right; font-variant-numeric:tabular-nums; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Numeric alignment. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td[data-col-type=&quot;code&quot;] { font-family:var(--font-mono); white-space:nowrap; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Code column styling. </td></tr><tr><td data-label="Section / Selector"> <code>.table-wrapper table tbody td[data-col-type=&quot;date&quot;] { text-align:center; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Date column centering. </td></tr><tr><td data-label="Section / Selector"> <code>.table-controls .btn-icon-only { width:36px;height:36px; display:flex; justify-content:center; align-items:center; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Icon-only buttons mobile enforcement. </td></tr><tr><td data-label="Section / Selector"> <code>@media (max-width:420px) { .table-controls a, button, summary { padding:0; min-width:36px; min-height:36px; } }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Ultra-small screen touch target adjustment. </td></tr><tr><td data-label="Section / Selector"> <code>.copy-buttons { display:flex; gap:8px; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Copy/export buttons container. </td></tr><tr><td data-label="Section / Selector"> <code>.copy-buttons button.copy-btn { padding:4px 8px; border-radius:4px; background:var(--button-bg); color:var(--button-text); transition: all 0.2s ease-in-out; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Copy button style. </td></tr><tr><td data-label="Section / Selector"> <code>.copy-button-output pre { max-height:400px; overflow-y:auto; background:var(--panel); border-radius:4px; padding:8px; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Scrollable copy output. </td></tr><tr><td data-label="Section / Selector"> <code>.content pre code, .table-container pre code { background:var(--panel); padding:8px; border-radius:4px; overflow-x:auto; display:block; font-family:var(--font-mono); font-size:0.95em; }</code> </td><td data-label="Technical Breakdown &amp; Notes"> Consistent code block styling. </td></tr></tbody></table></div><div class="row-count">Rows: 162</div></div><div class="table-caption" id="Table21" data-table="Book_8052_21" style="margin-top:2mm;margin-left:3mm;"><strong>Table 21 — worker.js</strong></div>
<div class="table-wrapper" data-table-id="table-21"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Details**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Details</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>File Overview</strong> </td><td data-label="Details"> <code>/static/worker.js</code> is a lightweight, non-blocking Web Worker that handles table indexing and searching. It operates independently of the DOM, suitable for large datasets, and supports multiple input formats (arrays of tables, raw HTML, or URLs). The worker uses <code>DOMParser</code> when available and falls back to regex-based parsing in minimal environments. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Primary Responsibilities</strong> </td><td data-label="Details"> 1. Build structured index from tables.<br>2. Perform text-based searches over indexed tables.<br>3. Provide results with row snippets.<br>4. Support cancellation of in-progress searches.<br>5. Handle errors gracefully and return structured messages. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Message Types</strong> </td><td data-label="Details"> The worker communicates using structured messages:<br>- <code>index</code>: builds or rebuilds the table index.<br>- <code>search</code>: searches the index for a query.<br>- <code>clear</code>: resets the index.<br>- <code>status</code>: returns readiness and current table count.<br>- <code>ping</code>: simple heartbeat.<br>- Unknown types: trigger error response. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Index Store Structure</strong> </td><td data-label="Details"> <code>indexStore</code> maintains an array of tables: <code>indexStore.tables = []</code>.<br>Each table object contains:<br>- <code>id</code>: unique table identifier.<br>- <code>headers</code>: array of column headers.<br>- <code>rows</code>: array of row arrays, each row is <code>[cell0, cell1,...]</code>.<br>- <code>rowsText</code>: each row joined as <code>&quot;cell0 | cell1 | ...&quot;</code>, for display or snippet extraction.<br>- <code>rowsTextLc</code>: lowercase, sanitized version of <code>rowsText</code> for fast search matching. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Constants and Globals</strong> </td><td data-label="Details"> - <code>CHUNK_YIELD = 500</code>: number of rows processed before yielding to the event loop to prevent worker freeze.<br>- <code>currentSearchToken = 0</code>: integer token to manage search cancellation.<br>- <code>indexStore</code>: persistent storage for all indexed tables. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Text Sanitization</strong> </td><td data-label="Details"> <code>sanitize(text)</code> performs:<br>1. Null-safe handling: converts <code>null</code>/<code>undefined</code> to empty string.<br>2. Whitespace collapse: multiple spaces replaced with a single space.<br>3. Trim: leading and trailing spaces removed.<br>4. Lowercase conversion: enables case-insensitive search.<br>Ensures consistent query matching. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Array Comparison Utility</strong> </td><td data-label="Details"> <code>arraysEqual(a, b)</code> checks deep equality:<br>- Returns false if either array is null, lengths differ, or any element mismatches.<br>- Used primarily for detecting if the first row matches headers in fallback parsing. </td></tr><tr><td data-label="Technical Breakdown"> <strong>HTML Parsing Function</strong> </td><td data-label="Details"> <code>parseHtmlTables(html)</code> extracts tables from HTML input:<br>1. If <code>DOMParser</code> is present:<br>   - Parse HTML string into <code>document</code>.<br>   - Select all <code>&lt;table&gt;</code> elements.<br>   - For each table:<br>     • Extract headers from <code>&lt;thead th&gt;</code> or fallback to first <code>&lt;tr&gt;</code> cells.<br>     • Extract body rows from <code>&lt;tbody tr&gt;</code>; if missing, fallback to all <code>&lt;tr&gt;</code> excluding header row.<br>     • Store as <code>{id, headers, rows}</code>.<br>2. If <code>DOMParser</code> unavailable, regex fallback:<br>   - Match <code>&lt;table&gt;</code> blocks.<br>   - Extract <code>&lt;thead&gt;</code> if present, otherwise first row as headers.<br>   - Extract <code>&lt;tr&gt;</code> → <code>&lt;td&gt;/&lt;th&gt;</code> for rows.<br>   - Strip HTML tags, trim text.<br>   - Avoid crashes by returning empty tables on parse errors. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Table Addition to Index</strong> </td><td data-label="Details"> <code>addTableToIndex(id, headers, rows)</code>:<br>1. Normalize rows: all entries coerced to strings.<br>2. Build <code>rowsText</code>: row content joined with <code>&quot; | &quot;</code> for display.<br>3. Build <code>rowsTextLc</code>: lowercase, sanitized version for search.<br>4. Assign <code>id</code> if missing: <code>table_${indexStore.tables.length + 1}</code>.<br>5. Append table to <code>indexStore.tables</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Index Building Workflow</strong> </td><td data-label="Details"> <code>buildIndex(msg)</code> handles input sources:<br>- <code>msg.tables</code>: direct table array input.<br>- <code>msg.html</code>: raw HTML input.<br>- <code>msg.url</code>: fetch HTML via <code>fetch</code> and parse.<br>Steps:<br>1. Reset <code>indexStore.tables</code> to empty.<br>2. Iterate over tables/html, parse, and normalize.<br>3. Add tables via <code>addTableToIndex</code>.<br>4. Post status <code>{type:&#x27;status&#x27;, status:&#x27;indexed&#x27;, tables: &lt;count&gt;}</code>.<br>5. Errors caught and posted via <code>{type:&#x27;error&#x27;, error: &#x27;parse_html_failed&#x27;}</code> or <code>fetch_failed</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Search Functionality</strong> </td><td data-label="Details"> <code>handleSearch(msg)</code> performs query searches across indexed tables:<br>1. Increment <code>currentSearchToken</code> for cancellation control.<br>2. Sanitize query.<br>3. Determine <code>perTableLimit</code> from <code>msg.limit</code> (default 200).<br>4. Iterate <code>indexStore.tables</code> and <code>rowsTextLc</code>:<br>   - For each row containing the query, store index and snippet.<br>   - Snippets capture ±40 characters around query, max 160 chars.<br>   - Yield to event loop every <code>CHUNK_YIELD</code> rows to avoid blocking.<br>5. If token mismatch detected, post <code>{type:&#x27;searchCanceled&#x27;}</code>.<br>6. Post final <code>{type:&#x27;searchResults&#x27;}</code> with matches. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Snippet Extraction</strong> </td><td data-label="Details"> - Extract relevant context around matched term for UI display.<br>- Avoids overlong snippets by enforcing max length.<br>- Associates snippet with row index for reconstruction. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Search Cancellation</strong> </td><td data-label="Details"> - Uses <code>currentSearchToken</code> to track the latest search.<br>- Any older searches detect token mismatch and stop immediately.<br>- Ensures no race conditions for rapid search inputs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Async Yielding</strong> </td><td data-label="Details"> Worker yields control using <code>await new Promise(r =&gt; setTimeout(r,0))</code> every <code>CHUNK_YIELD</code> rows.<br>Prevents UI lock-up and keeps worker responsive for large datasets. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Event Handling</strong> </td><td data-label="Details"> <code>self.addEventListener(&#x27;message&#x27;, async ev =&gt; {...})</code>:<br>- Switches on <code>msg.type</code>.<br>- <code>index</code> → <code>buildIndex</code>.<br>- <code>search</code> → <code>handleSearch</code> (async, not awaited to allow cancellation).<br>- <code>clear</code> → reset <code>indexStore</code>.<br>- <code>status</code> → post readiness.<br>- <code>ping</code> → post <code>&#x27;pong&#x27;</code>.<br>- Default → post error for unknown types. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Clear Index</strong> </td><td data-label="Details"> On <code>&#x27;clear&#x27;</code> message:<br>- <code>indexStore.tables = []</code>.<br>- Post <code>{type:&#x27;status&#x27;, status:&#x27;cleared&#x27;}</code>.<br>- Ensures previous data removed safely. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Status Query</strong> </td><td data-label="Details"> On <code>&#x27;status&#x27;</code> message:<br>- Returns <code>{status:&#x27;ready&#x27;, tables:&lt;count&gt;}</code>.<br>- Allows main thread to check worker readiness. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Ping/Pong Heartbeat</strong> </td><td data-label="Details"> <code>&#x27;ping&#x27;</code> message triggers <code>&#x27;pong&#x27;</code> response.<br>Used for liveness check and simple connectivity verification. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error Handling Strategy</strong> </td><td data-label="Details"> - All parsing, fetching, and search operations wrapped in try/catch.<br>- Errors reported via <code>postMessage({type:&#x27;error&#x27;, error, details})</code>.<br>- Worker remains alive after error; non-fatal. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Fallback Parsing</strong> </td><td data-label="Details"> - Regex fallback for environments without <code>DOMParser</code>.<br>- Uses non-greedy patterns to safely capture <code>&lt;table&gt;</code> content.<br>- Strips inner tags and trims text.<br>- Prevents crashes on malformed HTML. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Headers Detection Strategy</strong> </td><td data-label="Details"> - Prefer <code>&lt;thead th&gt;</code>.<br>- Fallback to first <code>&lt;tr&gt;</code> <code>&lt;th&gt;</code> cells.<br>- If absent, header may be empty.<br>- Ensures consistent <code>headers</code> array for each table. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Row Normalization & Safety</strong> </td><td data-label="Details"> - All rows coerced to string arrays.<br>- Empty or missing rows handled gracefully.<br>- Ensures <code>rowsText</code> and <code>rowsTextLc</code> arrays remain aligned. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Memory & Performance Considerations</strong> </td><td data-label="Details"> - Chunked processing avoids blocking event loop.<br>- Limits per-table search results via <code>perTableLimit</code>.<br>- Lowercased row text precomputed for fast comparisons.<br>- Snippets generated lazily, only for matched rows. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Worker Safety</strong> </td><td data-label="Details"> - Does not manipulate DOM.<br>- Operates purely on data structures.<br>- Safe for multi-threaded execution.<br>- Compatible with minimal environments. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Data Contracts</strong> </td><td data-label="Details"> Every <code>postMessage</code> includes <code>type</code> and relevant fields:<br>- <code>&#x27;status&#x27;</code>, <code>&#x27;searchResults&#x27;</code>, <code>&#x27;searchCanceled&#x27;</code>, <code>&#x27;error&#x27;</code>, <code>&#x27;pong&#x27;</code>.<br>- Ensures predictable communication with main thread. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Extensibility & Maintainability</strong> </td><td data-label="Details"> - Message handling can be extended for new types.<br>- Parsing strategy supports DOM-based and regex-based methods.<br>- Index and search logic modular and isolated. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security Considerations</strong> </td><td data-label="Details"> - Sanitizes all text for search matching.<br>- Regex parsing strips HTML tags safely.<br>- No execution of HTML or scripts from indexed content.<br>- Safe even with untrusted HTML input. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational Notes</strong> </td><td data-label="Details"> - Suitable for large table datasets.<br>- Non-blocking, memory-efficient.<br>- Can be used in multi-threaded UI environments for search functionality.<br>- Supports cancellation, responsive search, and large table indexing without freezes. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Edge Case Handling</strong> </td><td data-label="Details"> - Empty tables or rows handled gracefully.<br>- Missing headers do not break indexing.<br>- Fetch failures reported without crashing worker.<br>- Token-based cancellation ensures old searches do not interfere with new ones. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Developer Utilities</strong> </td><td data-label="Details"> - <code>sanitize(text)</code> for text normalization.<br>- <code>arraysEqual(a,b)</code> for header verification.<br>- <code>addTableToIndex</code> centralizes table addition logic.<br>- All utilities isolated and reusable. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Fetch-Based Indexing</strong> </td><td data-label="Details"> - Supports <code>msg.url</code> input.<br>- Fetches HTML via <code>fetch</code>.<br>- Parses returned HTML and adds tables to index.<br>- Errors caught and reported if network or parsing fails. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Search Result Format</strong> </td><td data-label="Details"> - Array of objects: <code>{ tableId, tableIndex, matches: [rowIndices], snippets: [{rowIndex, snippet}] }</code>.<br>- Provides structured data for rendering UI search results. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Snippet Extraction Rules</strong> </td><td data-label="Details"> - ±40 characters before query, max 160 characters total.<br>- Captures enough context for UI previews.<br>- Handles start/end bounds of text safely. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Worker Concurrency Model</strong> </td><td data-label="Details"> - Async functions with yielding prevent blocking main thread.<br>- <code>currentSearchToken</code> prevents race conditions.<br>- Worker remains responsive under heavy load. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Logging & Debugging</strong> </td><td data-label="Details"> - Errors and parsing issues posted as messages.<br>- Allows main thread to log or handle worker-side issues.<br>- No silent failures; all exceptions propagated. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Fallback Robustness</strong> </td><td data-label="Details"> - Dual parsing strategies (DOM + regex) ensure high table capture rate.<br>- Handles malformed or minimal HTML gracefully.<br>- No dependency on external libraries. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Consistency Guarantees</strong> </td><td data-label="Details"> - <code>rowsText</code> and <code>rowsTextLc</code> arrays align with <code>rows</code> arrays.<br>- Headers preserved for every table.<br>- Search results match index structure exactly. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Resource Management</strong> </td><td data-label="Details"> - Indexing clears previous tables to free memory.<br>- Chunked processing avoids blocking event loop.<br>- Snippets generated on demand. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final Guarantees</strong> </td><td data-label="Details"> - Safe, consistent indexing of tables from multiple sources.<br>- Non-blocking search over large datasets.<br>- Cancellation support.<br>- Predictable, structured messaging for main thread consumption.<br>- DOM-free operation; minimal memory footprint. </td></tr></tbody></table></div><div class="row-count">Rows: 39</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>