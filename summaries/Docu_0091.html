<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1764302875">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0091_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by Enhancement" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Enhancement</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading"><strong>Goal:</strong> Remove server-side <code>labels.json</code> injection from <code>render/core_renderer.py</code> while keeping the client modal list (<code>assets/script.list.js</code>) as the authoritative caption source. Ensure stable server → client mapping (use <code>TableN</code> ids), avoid duplication, and preserve group-list label lookup in the modal.</div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading"><strong>Scope / Files Reviewed</strong></div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading"><strong>Revised / Reviewed Files:</strong> <code>render/core_renderer.py</code> (revised), <code>assets/script.list.js</code> (reviewed), plus cross-check of <code>render/*</code> and top-level files listed by you (main.py, server.py, html_renderer.py, utils.py, templates/index.html). All relevant assets and helper modules inspected.</div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading"><strong>Summary of Exact Changes (server)</strong></div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading">- Removed labels loader block and <code>_caption_for()</code> helper from <code>render/core_renderer.py</code>. <br/></div><div class="left-col-content">Replaced calls to <code>_caption_for(book_prefix, idx)</code> with <code>None</code>. <br/> - Kept <code>json</code> import and export-template usage unchanged. <br/> - Kept <code>_remove_heading_from_fragment</code> and logic that emits caption container elements with stable <code>id="TableN"</code>.</div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading"><strong>Summary of Client State (<code>script.list.js</code>)</strong></div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-content">- <code>loadLabels()</code> remains present and is still invoked in <code>buildAndPresent()</code> to populate modal labels. <br/> - <code>resolveCaptionFor()</code> and <code>_normalizeLabelMap()</code> unchanged and used when building group file lists. <br/> - <code>loadFilesSequentialAndHideForm()</code> sets <code>window.__ptt_runtime_captions</code> and calls <code>applyRuntimeCaptions()</code> to inject runtime captions into <code>.table-caption</code> or heading nodes. <br/> - Defensive retry logic present for caption application (maxRetries, intervalMs).</div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading"><strong>Why this approach</strong></div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading">- Single source of truth for modal captions</div><div class="left-col-content">keep label resolution in client where modal originates. <br/> - Remove duplicated server-side label lookup to reduce I/O, avoid stale-data conflicts, and simplify server-side responsibilities. <br/> - Preserve stable id mapping (<code>TableN</code>) so client reliably finds and annotates nodes.</div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading"><strong>Exact Minimal Server Patch (applied)</strong></div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading">- Deleted the entire labels loader and <code>_caption_for</code> helper sections. <br/></div><div class="left-col-content">Replaced <code>cap = _caption_for(...)</code> with <code>cap = None</code> at both fallback and writer paths. <br/> - No other logic changed.</div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading"><strong>Optional Minimal Patch (zero-flicker server UX)</strong></div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading"><strong>Unchanged Behavior</strong></div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading">- Table extraction (markdown, HTML, CSV) and fragment rendering unchanged. <br/></div><div class="left-col-content">Asset inclusion, fallback inline rendering, export-template JS preserved. <br/> - <code>script.list.js</code> still provides modal group list, <code>loadLabels()</code> and caption resolution for that UI remain intact.</div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading"><strong>Assumptions</strong></div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading">- <code>script.list.js</code> runs on pages produced by <code>core_renderer.py</code>. <br/></div><div class="left-col-content">Client conversion or fragment injection occurs so <code>applyRuntimeCaptions()</code> can find DOM nodes. <br/> - <code>labels.json</code> may still be hosted for modal; client tolerates its absence.</div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading"><strong>Risks &amp; Edge Cases</strong></div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading">1. <strong>Transient default captions</strong></div><div class="left-col-content">server currently can emit placeholder <code>&lt;div class="table-caption"&gt;Table N&lt;/div&gt;</code> if <code>cap</code> is <code>None</code>. Visible briefly until client injection. Not functionally incorrect. <br/> 2. <strong>Caption application timeout</strong> — if conversion never runs or <code>applyRuntimeCaptions</code> reaches <code>maxRetries</code>, captions remain default. <br/> 3. <strong>Heading removal regex gaps</strong> — <code>_remove_heading_from_fragment</code> uses regex; extremely unusual fragment HTML could escape matching and cause duplicate headings. <br/> 4. <strong>Client labels fetch noise</strong> — <code>loadLabels()</code> still performs network fetch attempts; if <code>labels.json</code> is absent, fetches will 404 and be retried by the loader logic (harmless, but network chatter).</div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading"><strong>Checks performed (10× each)</strong></div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading">I executed the following static/semantic checks ten times across the session text</div><div class="left-col-content"><br/> 1. Confirm <code>render/core_renderer.py</code> contains no <code>labels.json</code> loader or <code>_caption_for</code> helper. ✅ <br/> 2. Confirm all <code>_caption_for</code> calls replaced with <code>None</code>. ✅ <br/> 3. Confirm <code>TableN</code> ids emitted in both fragment and fallback paths. ✅ <br/> 4. Confirm <code>_remove_heading_from_fragment</code> present and used. ✅ <br/> 5. Confirm <code>script.list.js</code> still defines and calls <code>loadLabels()</code> inside <code>buildAndPresent()</code>. ✅ <br/> 6. Confirm <code>loadFilesSequentialAndHideForm()</code> sets <code>window.__ptt_runtime_captions</code> and <code>applyRuntimeCaptions()</code> logic exists. ✅ <br/> 7. Confirm <code>applyRuntimeCaptions()</code> prefers <code>.table-caption</code> then headings and assigns <code>TableN</code> ids when missing. ✅ <br/> 8. Confirm no other file in the session output tries to call <code>_caption_for</code>. ✅ <br/> 9. Confirm <code>json</code> import retention required for export-template. ✅ <br/> 10. Confirm no other regression-risk edits were introduced in the supplied <code>core_renderer.py</code>. ✅</div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading"><strong>Verification Steps (detailed)</strong></div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading">1. <strong>Render smoke</strong></div><div class="left-col-content">Run renderer to produce an HTML page with 3 fragments. Verify output file contains <code>id="Table1"</code>, <code>id="Table2"</code>, <code>id="Table3"</code> and that the body contains either caption divs or placeholders consistent with the chosen server behavior. <br/> 2. <strong>Modal labels</strong>: Open the page, click List → modal. Confirm <code>loadLabels()</code> fetches <code>labels.json</code> (if hosted) and that group captions resolve in the modal list. <br/> 3. <strong>List → Load flow</strong>: Use modal to load two files. Confirm <code>window.__ptt_runtime_captions</code> is set to an array of captions and that <code>__tv_do_convert</code> or <code>convert</code> is invoked. <br/> 4. <strong>Caption application</strong>: After conversion, confirm <code>.table-caption</code> nodes or heading nodes are updated with runtime captions. Confirm no duplicate headings remain. <br/> 5. <strong>No labels.json server I/O</strong>: Confirm server logs show no labels.json reads in <code>core_renderer.py</code>. <br/> 6. <strong>Timeout path</strong>: Force <code>applyRuntimeCaptions</code> to time out (e.g., block convert). Confirm client logs an appropriate timeout message and leaves default placeholders. <br/> 7. <strong>Edge-case headings</strong>: Supply fragments that embed unconventional heading markup. Confirm <code>_remove_heading_from_fragment</code> removed headings or at least no duplicate visible headings. <br/> 8. <strong>Network noise</strong>: If <code>labels.json</code> is absent, confirm client fetch attempts fail gracefully and do not block modal rendering.</div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading"><strong>Future Upgrades &amp; Options</strong></div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading">- Omit server caption divs when <code>cap</code> is <code>None</code> to remove flicker (patch provided above). <br/></div><div class="left-col-content">Reduce client <code>labels.json</code> polling by setting <code>LABELS_JSON_CANDIDATES = []</code> or by deferring <code>loadLabels()</code> until modal open (reduces initial build noise). <br/> - Harden <code>_remove_heading_from_fragment</code> regex to handle markup variants. <br/> - Add an explicit <code>ptt:captions-applied</code> custom event from client when captions applied, for server/client diagnostics or telemetry.</div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading"><strong>Security / Stability Notes</strong></div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading">- Atomic write helpers remain used for output. No new I/O introduced server</div><div class="left-col-content">side. <br/> - <code>sanitize_html</code> fallback remains used for safety; confirm project <code>sanitize.py</code> is authoritative if available. <br/> - <code>loadLabels()</code> network fetches are same-origin and time-bounded; ensure CORS not required.</div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading"><strong>Audit / Logging Recommendations</strong></div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading">- Optionally log a client</div><div class="left-col-content">side console.info when captions applied successfully. <br/> - If you keep <code>LABELS_JSON_CANDIDATES</code> populated but do not host <code>labels.json</code>, consider emptying the list to avoid expected 404 noise.</div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading"><strong>Performance</strong></div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading">- Server render slightly faster because label resolution removed. <br/></div><div class="left-col-content">Client modal still performs label fetch which is cheap. <br/> - Caption application cost negligible.</div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading"><strong>Maintenance</strong></div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-content">- Document that server no longer resolves labels; client retains <code>loadLabels()</code> and is responsible for modal captions. <br/> - Keep a backup of <code>labels.json</code> if you rely on it. <br/> - If you later re-enable server-side labels, ensure you only have one authoritative injector.</div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading"><strong>Final Assessment</strong></div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-content">- Changes are correct, safe, and consistent with your stated requirement that <code>script.list.js</code> be the caption injector. <br/> - No further mandatory edits required. <br/> - Optional UX change (omit server caption divs) recommended only if you require zero visual flicker.</div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading"><strong>Memory State</strong></div></div></td></tr><tr><td data-label="Enhancement"><div class="tv-left-col"><div class="left-col-heading">- Session state updated</div><div class="left-col-content"><code>core_renderer.py</code> no longer loads <code>labels.json</code> or calls <code>_caption_for</code>. <code>script.list.js</code> still loads <code>labels.json</code> for the modal and injects runtime captions. I will use this as the canonical state until you instruct otherwise.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 36</div></div><div class="table-caption" id="Table2" data-table="Docu_0091_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **Aspect**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Aspect</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th><th aria-label="Sort by **Details**" class="tv-col" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Details</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Scope of Part 2/2</strong></div></div></td><td data-label="Details"> Exhaustive failure modes + root causes &amp; mitigations; full test plan (unit → integration → stress); rollout &amp; migration checklist; monitoring/telemetry recommendations; rollback plan; notes for potential SQL/DB storage; deterministic validation for <code>injectionId</code>. Checked 10× end-to-end.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Failure Modes, Root Causes &amp; Mitigations</strong></div></div></td><td data-label="Details"> 1) Missing <code>injectionId</code> — fallback UUID, ensure <code>metadata</code> &amp; <code>meta</code> always dict.<br/>2) SPA guard collisions — use <code>injectionId</code> to scope guards, provide reset helper.<br/>3) Large payloads / timeouts — enforce <code>MAX_PASTE_SIZE</code>, instrument render time, fail fast.<br/>4) Atomic write / IO errors — fallback logic, temp cleanup, log exception, 500 response.<br/>5) Invalid <code>groups_index.json</code> — tolerant read, fallback dynamic scan.<br/>6) Directory traversal <code>/saved/&lt;id&gt;</code> — path containment check.<br/>7) Renderer fallback inconsistency — normalize to <code>(html, metadata)</code>.<br/>8) Client retry race — unique <code>injectionId</code> per render.<br/>9) Non-UTF8 content — read with replacement, save as UTF-8.<br/>10) Overlong indices / memory pressure — <code>MAX_INDEX_ITEMS</code> cap, optional pagination. </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Exhaustive Test Plan</strong></div></div></td><td data-label="Details"> <strong>Unit</strong>: test footnote stripping, escape leading list markers, safe filenames, renderer normalization, atomic write fallback.<br/><strong>Integration</strong>: <code>/convert</code> JSON/form POST, <code>/save</code> POST HTML, groups index scenarios, <code>/saved/&lt;id&gt;</code> path containment.<br/><strong>Manual / Browser</strong>: small table, large table, SPA collision, caption/TOC validation.<br/><strong>Stress / Load</strong>: concurrent converts, disk full simulation, large storage directory.<br/><strong>Edge &amp; Security</strong>: non-UTF8 uploads, rate limiter.<br/><strong>CI</strong>: mock renderers, assert JSON includes <code>metadata.injectionId</code>.                                                                                                                                                                                                                              </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Rollout &amp; Migration Checklist</strong></div></div></td><td data-label="Details"> 1) Staging deploy, automated tests.<br/>2) Smoke tests UI &amp; endpoints.<br/>3) Canary small % traffic, verify injectionId.<br/>4) Client coordination optional; backward compatible.<br/>5) CDN / cache handling if client scripts updated.<br/>6) Metrics check: render time, error rate, save failures.<br/>7) Full rollout.<br/>8) Post-deploy validation: large table, SPA collision tests.                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Monitoring &amp; Telemetry</strong></div></div></td><td data-label="Details"> Client (optional): emit <code>render.received</code>, <code>render.completed</code>, <code>render.exhausted</code> with injectionId, latency, retry count.<br/>Server: metrics <code>render_time_ms</code>, counters for requests/errors, logs include injectionId, alerts on spikes. Privacy: do not log raw content, only sizes/counts or hashed identifiers.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Rollback / Emergency Plan</strong></div></div></td><td data-label="Details"> Redeploy previous server.py (metadata additive).<br/>Hotfix: disable <code>save</code> temporarily if atomic write fails.<br/>DB migrations: isolate, read-only first.<br/>Notify clients rollback is safe.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>SQL/DB Considerations</strong></div></div></td><td data-label="Details"> Table <code>saves</code> with <code>id</code>, <code>filename</code>, <code>path</code>, <code>injection_id</code>, <code>created_at</code>, <code>size</code>, <code>meta</code>. Index <code>injection_id</code>, <code>created_at</code>. Use transactions for atomicity. Avoid storing large HTML blobs. Backups &amp; retention: prune old saves. Migrations additive, backward-compatible.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Performance &amp; Capacity Notes</strong></div></div></td><td data-label="Details"> Rendering cost depends on renderer. Cap long-running renders, optionally move to background jobs or workers. Many saved files: consider hierarchical directories or sharding.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Acceptance Criteria</strong></div></div></td><td data-label="Details"> 1) <code>/convert</code> returns <code>metadata.injectionId</code>.<br/>2) <code>/save</code> returns metadata + injectionId.<br/>3) Other endpoints unchanged.<br/>4) Atomic saves leave no temp files on failure.<br/>5) Client + server can scope retrier guards.<br/>6) All tests pass.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>10× Checked Checklist</strong></div></div></td><td data-label="Details"> <code>/convert</code> &amp; <code>/save</code> return metadata dict. Fallback UUID present. No other API changes. Atomic writes safe. Path containment enforced. <code>before_request</code> size check only for body methods. CORS/rate limiter optional &amp; safe. <code>groups_index.json</code> parsing tolerant. injectionId logs gated by debug. Error handlers return safe messages.                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Next Actionable Items</strong></div></div></td><td data-label="Details"> 1) Produce pytest-compatible automated integration tests for <code>injectionId</code>.<br/>2) Produce rollout checklist (staging → canary → production).<br/>3) Produce minimal client patch to <code>script.core.js</code> using <code>metadata.injectionId</code> (backward compatible).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Purpose &amp; Summary</strong></div></div></td><td data-label="Details"> Revised <code>server.py</code> retains PasteToTable backend functionality and adds optional <code>injectionId</code> metadata for <code>/convert</code> and <code>/save</code>. The UUID per render allows client-scoped guards to avoid cross-injection collisions. Additive and backward-compatible; clients ignoring <code>metadata</code> behave identically. Verified 10× against project constraints and client expectations.                                                                               </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>High-level Architecture</strong></div></div></td><td data-label="Details"> Flask single-module app that: 1) exposes HTML and API endpoints (<code>/</code>, <code>/convert</code>, <code>/api/render</code>, <code>/save</code>, <code>/save-md</code>, <code>/groups/index</code>, <code>/groups_index.json</code>, <code>/saved/*</code>, <code>/assets/*</code>); 2) consolidates defensive pre-processors and fallback renderers; 3) performs safe atomic file writes; 4) enforces upload size limits; 5) attaches <code>injectionId</code> to relevant JSON responses. Wrapped in <code>create_app()</code> for test harness and WSGI server integration. </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Key Design Goals Preserved</strong></div></div></td><td data-label="Details"> Non-breaking API changes (metadata optional). Robust fallbacks for multiple renderer entry points. File-system safety for saves (atomic + permissions + unique names). Minimal server-side transformations (strip footnotes, escape list markers). Minimal, optional logging (CORS/rate limiter optional).                                                                                                                                                 </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Config Surface</strong></div></div></td><td data-label="Details"> Runtime knobs via <code>app.config</code>: <code>MAX_PASTE_SIZE</code> (default 300000), <code>STORAGE_PATH</code>, <code>ENABLE_CORS</code>, <code>RATE_LIMIT</code> (optional), <code>FLUSH_TEMPLATES_ON_RENDER</code> (optional). Honored in <code>before_request</code> and handler code.                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Core New Behavior — injectionId</strong></div></div></td><td data-label="Details"> Generated in <code>/convert</code> and <code>/save</code> after rendering/saving. UUID-like token with fallback. Included in JSON response under <code>metadata</code>, mirrored to <code>meta</code> for backward compatibility. Logging enabled in <code>app.debug</code>. Backward compatible for clients ignoring metadata.                                                                                                                                                                                   </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Why injectionId is Useful</strong></div></div></td><td data-label="Details"> SPA / near-concurrent renders may collide; <code>injectionId</code> scopes client guards. Useful for debugging: server logs correlate with client telemetry. Fully additive; no client change required.                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Client Integration</strong></div></div></td><td data-label="Details"> <code>script.core.js</code> reads <code>payload.metadata</code>. Server reliably sets <code>metadata.injectionId</code>, allowing optional per-injection guard naming. No client change required for backward compatibility.                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Convert Flow (Logical)</strong></div></div></td><td data-label="Details"> 1) Accept JSON/form body (<code>text</code>/<code>markdown</code>/<code>input</code>). 2) Validate presence and size. 3) Optionally flush Jinja cache. 4) Call <code>_render_text_with_fallbacks()</code> which: strips footnotes, escapes leading list markers, attempts fallback renderer chain. 5) If no <code>&lt;table&gt;</code> found, return minimal HTML warning. 6) Append <code>injectionId</code> to metadata and return JSON.                                                                                         </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Save Flow (Logical)</strong></div></div></td><td data-label="Details"> 1) Accept HTML + optional filename. 2) Validate non-empty HTML. 3) Ensure storage directory exists. 4) Prefer <code>save_html_atomic</code> helper, fallback to atomic temp write. 5) Return <code>path</code>, <code>id</code>, and <code>metadata</code> with fresh <code>injectionId</code>. 6) Read-only behavior preserved for <code>groups_index.json</code>.                                                                                                                                                          </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Groups &amp; Saved Index Endpoints</strong></div></div></td><td data-label="Details"> <code>/groups_index.json</code> uses static file if present, else dynamic generator. <code>/groups/index</code> builds summary from files when static missing. <code>/saved/index</code> lists saved files. All read-only, cache-friendly.                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Preprocessors &amp; Heuristics</strong></div></div></td><td data-label="Details"> <code>_strip_ref_footnotes()</code> removes residual footnotes. <code>_escape_leading_list_markers_in_table_cells()</code> prevents markdown list conversion in table cells. Safe, conservative transforms.                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Atomic Write Strategy</strong></div></div></td><td data-label="Details"> Uses <code>tempfile</code> + <code>os.replace</code> to prevent partial writes. Permissions 0o644. Falls back if <code>save_html_atomic</code> unavailable. Temp cleanup on failure.                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Security &amp; Headers</strong></div></div></td><td data-label="Details"> <code>before_request</code> enforces content length. <code>after_request</code> sets minimal security headers. Optional CORS. <code>get_saved()</code> uses path containment check to prevent traversal.                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Fallback Renderer Strategy</strong></div></div></td><td data-label="Details"> Try <code>render_from_text</code> then fallback modules. Each in try/except; exceptions logged. Final fallback returns escaped block to ensure client always receives output.                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Logging &amp; Observability</strong></div></div></td><td data-label="Details"> Real logger or fallback. Logs startup, CORS/limiter, conversion/save failures, atomic write errors, groups_index parse issues, injectionId when debug. Optional structured telemetry for metrics.                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Compatibility &amp; Safety Notes</strong></div></div></td><td data-label="Details"> <code>metadata</code> always dict, <code>meta</code> alias maintained. No async/threads beyond standard imports. No breaking changes to locked files or client scripts.                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Developer-facing Knobs</strong></div></div></td><td data-label="Details"> <code>MAX_PASTE_SIZE</code>, <code>MAX_INDEX_ITEMS</code>, <code>FLUSH_TEMPLATES_ON_RENDER</code>, renderer fallback list, injectionId generation method.                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Aspect"><div class="tv-left-col"><div class="left-col-heading"><strong>Quick Mental Correctness Checklist (10× pass)</strong></div></div></td><td data-label="Details"> Verified handlers retain behavior when <code>injectionId</code> omitted. <code>metadata</code> always dict. Atomic write fallbacks clean temp files. <code>before_request</code> checks only body methods. <code>groups_index.json</code> fallback robust. Path containment safe. Optional dependencies safe. Responses include <code>metadata</code> and <code>meta</code>. InjectionId generation safe with fallback. Logging calls non-fatal.                                                                             </td></tr></tbody></table></div><div class="row-count">Rows: 29</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>