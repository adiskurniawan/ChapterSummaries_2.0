<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1763610407">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0125_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1 • script.core.js</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by "><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label=""> <strong>Summary / Purpose</strong><br><br><code>script.core.js</code> is a self-contained client-side module that provides the core runtime for PasteToTable: UI utilities (toasts, clipboard, downloads), conversion orchestration (POST <code>/api/render</code>), DOM rendering of server HTML, caption injection based on externally-loaded <code>labels_injected.json</code>, lightweight TOC loader (<code>script.toc.js</code>), and safe attach/detach of event handlers. The file emphasizes resilience and “best-effort” behavior: nearly every operation is wrapped with <code>try/catch</code> to avoid runtime failures propagating to host pages. Primary responsibilities: reliable conversion workflow (<code>__tv_do_convert</code>), robust caption injection and labels/toc installation (<code>installTocAndLabels</code>, <code>__ptt_apply_injected_captions</code>), progressive script loading (<code>loadExtraSequentially</code>), and utility helpers used across the UI. The module is intentionally defensive and designed to run in varied embedding contexts (iframes, different hosts) with minimal assumptions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label=""> <strong>High-level guarantees & design principles</strong><br><br>• <strong>Fail-safe / non-throwing</strong>: functions use <code>try/catch</code> liberally so the script degrades silently on failure rather than crashing the host page. <br>• <strong>Idempotence & non-destructiveness</strong>: caption injection is idempotent (reuses existing captions when present) and avoids overwriting non-caption nodes with the same ID. <br>• <strong>Progressive enhancement</strong>: loads <code>extra.js</code>, <code>script.toc.js</code>, and <code>labels_injected.json</code> opportunistically from multiple candidate URLs, tolerating fetch failures or timeouts. <br>• <strong>DOM-first short-circuiting</strong>: many helpers check for <code>document.readyState</code> and either run immediately or attach <code>DOMContentLoaded</code> callbacks. <br>• <strong>Minimal global pollution</strong>: exposes a small surface (<code>window.tvUtils</code>, <code>window.PasteToTable.processRenderedHtml</code>, <code>window.__ptt_apply_injected_captions</code>, common aliases) but otherwise keeps helpers scoped to the IIFE. <br>• <strong>Best-effort UX</strong>: toast durations, clipboard fallbacks, and download fallbacks are implemented to maximize success across browsers.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label=""> <strong>Top-level structure & exports</strong><br><br>• <strong>Exports / globals set</strong>: <code>window.tvUtils</code> (copyToClipboard, sanitizeFileName, downloadBlob, showToast, debounce, getSearchEl), <code>window.__tv_utils</code> (internal variants), <code>window.PasteToTable.processRenderedHtml</code>, <code>window.showToast/downloadBlob/copyToClipboard/sanitizeFileName</code> aliases, <code>window.__ptt_apply_injected_captions</code>, <code>window.__ptt_labels_injected</code> (labels map), <code>window.__ptt_toc_and_labels_installed</code> (status), <code>window.__tv_do_convert</code> (conversion entrypoint). <br>• <strong>Major functional groups</strong>: configuration & base detection; debug logging helpers; network & script loaders (<code>loadExtraSequentially</code>, <code>fetchJsonWithTimeout</code>, <code>tryLoadLabels</code>, <code>installTocScript</code>); caption injection logic; conversion & rendering (<code>__tv_do_convert</code>, <code>processRenderedHtml</code>); UI helpers (toasts, clipboard, downloads); event wiring (convert button delegation, action dispatcher); header and attach helpers.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label=""> <strong>Key components & responsibilities (concise)</strong><br><br>1. <strong>Configuration & base detection</strong> — <code>detectScriptBase</code> computes <code>TV_BASE</code>; <code>window.tvConfig</code> established with defaults (highlight, debounceMs, chunkSize). <br>2. <strong>Resilient logging</strong> — <code>dbgInfo</code>, <code>dbgWarn</code>, <code>dbgDebug</code>, <code>dbgError</code> gate console calls on <code>window.tvDebug</code>. <br>3. <strong>Script & asset loader</strong> — <code>loadExtraSequentially</code> and <code>startExtraLoader</code> try multiple candidate paths sequentially; <code>installTocScript</code> wraps that to load <code>script.toc.js</code>. <br>4. <strong>Labels loader</strong> — <code>fetchJsonWithTimeout</code> (AbortController/timeouts fallback) + <code>tryLoadLabels</code> produce a labels map used for caption injection. <br>5. <strong>Caption injection</strong> — <code>__ptt_apply_injected_captions</code> and related helpers (<code>captionFor</code>, <code>injectCaptionForElement</code>) find per-table captions in <code>labels_injected.json</code> and inject or reuse <code>.table-caption</code> elements <em>before</em> the table (important: caption is inserted before the table/collapse toggle). Behavior includes preferring <code>Table{n}</code> id when available, avoiding id collisions with non-caption elements, setting <code>data-table=&quot;&quot;</code>, and inline margins. <br>6. <strong>Renderer orchestration</strong> — <code>__tv_do_convert</code> does POST <code>/api/render</code> (with fallback form-encoded), obtains JSON or HTML payload, and delegates to <code>PasteToTable.routeHtmlToAreas</code> or directly injects into <code>#tables-viewer</code>. <br>7. <strong>processRenderedHtml</strong> — central DOM insertion flow used by <code>__tv_do_convert</code> and consumers; manages <code>__tv_skip_scroll</code> coordination, schedules <code>initRenderedContent</code>, triggers TOC/labels install when <code>metadata.fromList</code> is true, and coordinates scroll-to-top retries. <br>8. <strong>UI helpers</strong> — toasts implementation (<code>showToast</code>, queue, styles, accessibility attributes), clipboard (<code>copyToClipboard</code> with legacy fallback), file download (<code>downloadBlob</code>), debounce, sanitizeFileName. <br>9. <strong>Event wiring</strong> — global convert click delegation, direct attachment to <code>#convertBtn</code>, header handlers (convert/clear/save/render/export). <br>10. <strong>Defensive utilities</strong> — <code>ensureId</code>, <code>escapeHtml</code>, <code>sanitizeForId</code>, <code>normalizeForSearchLocal</code>, small duplication of helpers exists in nested IIFEs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label=""> <strong>Detailed behavior & important implementation notes</strong><br><br><strong>Caption injection specifics</strong> — The injection flow is a focal point:<br>• The labels loader attempts multiple candidate URLs with a short timeout (2.2s in <code>tryLoadLabels</code> / 2.5s default in <code>fetchJsonWithTimeout</code>) and resolves to an object (<code>window.__ptt_labels_injected</code>).<br>• <code>__ptt_apply_injected_captions</code> builds a prioritized list of candidate prefixes (from body <code>data-file</code>/<code>data-source</code>, location basename, document.title, and prefixes inferred from labels keys). It iterates document tables in DOM order and, for each table index <code>idx</code> (1-based), tries a set of key shapes (<code>pref_01</code>, <code>pref_1</code>, <code>pref-01</code>, <code>pref01</code>, etc.) and fallback numeric keys (<code>&#x27;01&#x27;</code>, <code>&#x27;1&#x27;</code>).<br>• When a caption is available, it attempts to use <code>id=&#x27;Table{n}&#x27;</code> for the caption element. If an element with that id exists and is a <code>.table-caption</code>, it updates and reuses it. If an element with that id exists but is not a caption, it finds a unique suffixed id (<code>Table{n}-1</code>, <code>-2</code>, …) to avoid collisions.<br>• Captions are created as <code>&lt;div class=&quot;table-caption&quot; id=&quot;...&quot;&gt;</code> with <code>data-table=&quot;&quot;</code> and inline <code>style.marginTop=&#x27;2mm&#x27;</code> / <code>marginLeft=&#x27;3mm&#x27;</code>. The caption content is inserted using <code>textContent</code> for the <code>strong</code> element (safer) in most places; in one helper copy it uses <code>innerHTML = &#x27;&lt;strong&gt;&#x27; + escapeHtml(...) + &#x27;&lt;/strong&gt;&#x27;</code> (consistent escaping applied). Captions are <em>inserted before the table</em> using <code>parentNode.insertBefore(wrap, tbl)</code> or <code>insertAdjacentElement(&#x27;beforebegin&#x27;, wrap)</code> as fallback.<br><br><strong>Network & loader behavior</strong> — <code>loadExtraSequentially</code> uses synchronous script injection (<code>async: false</code>) via <code>&lt;script&gt;</code> elements appended to <code>&lt;head&gt;</code> and falls back to retrying the next path on <code>onerror</code>. <code>fetchJsonWithTimeout</code> uses <code>AbortController</code> when available and falls back to a timer-based cancel; it always resolves to <code>null</code> on failure (never rejects), in keeping with the fail-safe design.<br><br><strong>Conversion & rendering</strong> — <code>__tv_do_convert</code> tracks <code>window.__tv_convert_in_progress</code> to avoid concurrent conversions, prefers JSON <code>/api/render</code> responses, and gracefully downgrades to inserting HTML string payloads. It ensures <code>payload.metadata.fromList</code> is set only from the caller <code>opts.metadata.fromList</code> (server metadata is not trusted for this flag). After DOM insertion it schedules two <code>initRenderedContent</code> calls (60ms and 420ms) to help downstream scripts initialize. When the conversion is <code>fromList</code>, <code>processRenderedHtml</code> triggers TOC/labels install and then <code>__ptt_apply_injected_captions</code> plus PTToc build hooks where available.<br><br><strong>Toasts & accessibility</strong> — the toast container has <code>role=&quot;status&quot; aria-live=&quot;polite&quot; aria-atomic=&quot;true&quot;</code>. Toasts compute duration dynamically from message length and type, and include manual dismiss buttons. Visual styling is applied inline and color choices are changed for <code>success/warn/error</code> types (note: contrasting color choices are done inline and not via CSS class tokens).<br><br><strong>Defensive programming patterns</strong> — almost every DOM and network operation are wrapped in <code>try/catch</code>; many asynchronous flows swallow errors and record debug warnings only when <code>TV_DEBUG</code> or specific debug flags are set. Functions that mutate global state set idempotent guards (<code>window.__tv_extra_loader_attached</code>, <code>window.__tv_convert_delegation_attached</code>, <code>_attached</code> flags on attachHeaderHandlersOnce) to avoid double attachment. </td></tr><tr><td data-label=""> <strong>Error handling, robustness & failure modes</strong><br><br>• <strong>Non-throwing fail-fast semantics</strong>: the script prefers returning <code>null</code>/<code>false</code> or swallowing errors rather than propagating exceptions. This prevents the host page from breaking but can mask root causes during debugging. <br>• <strong>Partial success paths</strong>: failing to load labels or TOC scripts merely disables caption injection/TOC build; conversion still proceeds and DOM is updated from server payloads. <br>• <strong>Race conditions with DOM readiness</strong>: multiple places attach <code>DOMContentLoaded</code> or check <code>document.readyState</code>; however, asynchronous installs (labels/toc) may complete after <code>processRenderedHtml</code> and re-run caption application — code attempts to handle this via idempotence but timing-sensitive corner cases may remain. <br>• <strong>ID collision handling</strong>: careful handling prevents overwriting existing non-caption elements with <code>Table{n}</code> ids, but if a host page later mutates the DOM to remove or rename elements, captions may not find their intended anchor. <br>• <strong>Network timeouts & format variance</strong>: <code>fetchJsonWithTimeout</code> will return <code>null</code> for non-JSON (or slow) responses; <code>tryLoadLabels</code> resolves to <code>{}</code> if no candidate provides usable JSON. Labels file shape variance (flat keys, nested objects, zero-padded keys) is handled with multiple fallbacks, but unusual formats may still fail to match. <br>• <strong>Silent failure logging</strong>: unless debug flags are enabled, most failures are silent, which is safe but can hurt observability.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label=""> <strong>Concurrency / performance considerations</strong><br><br>• <strong>Conversion deduping</strong>: <code>window.__tv_convert_in_progress</code> prevents concurrent conversions; click-delegation guards prevent duplicate click handling via <code>__tv_convert_handled</code> on events. <br>• <strong>Sequential script loading</strong>: <code>loadExtraSequentially</code> tries candidate URLs one-by-one — this is slow if early candidates are unreachable but safe; the short retry delays (20ms) minimize total wait. <br>• <strong>Caption injection cost</strong>: <code>__ptt_apply_injected_captions</code> iterates all document tables and performs DOM insertions; on very large documents this is O(n) and could be noticeable. The function avoids heavy work when no labels are present. <br>• <strong>Toasts queue</strong>: single active toast with queueing keeps DOM updates small; durations scale with length but are bounded. <br>• <strong>Frequent try/catch</strong>: the pervasive use of <code>try/catch</code> has a measurable cost in hot loops; however, most functions are not performance-critical except table iteration. <br>• <strong>Network timeouts tuned for speed</strong>: label/timeouts are short (2–2.5s) to avoid blocking UX, which may lead to false negatives on slow networks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label=""> <strong>Edge cases & brittle areas</strong><br><br>1. <strong>Duplicate helper definitions</strong> — <code>_normalizeKey</code>, <code>buildPrefixCandidatesFromLabels</code>, and similar helper logic are defined more than once in nested IIFEs (observed duplication in the toc/labels IIFE). This increases maintenance burden and risk of divergence. <br>2. <strong>ID collision complexity</strong> — <code>Table{n}</code> id preference is sensible, but edge cases include servers that already emitted <code>Table{n}</code> for non-caption elements, or when multiple documents share the same DOM and IDs persist between renders. The script attempts to detect and suffix, but collisions can still produce confusing ids. <br>3. <strong>XSS risks & escaping inconsistency</strong> — most caption text is safely assigned using <code>textContent</code> on the created <code>strong</code> element; in a few helper paths the code uses <code>innerHTML = &#x27;&lt;strong&gt;&#x27; + escapeHtml(...) + &#x27;&lt;/strong&gt;&#x27;</code> which is safe if <code>escapeHtml</code> is correct (it is present), but mixed use introduces maintenance risk. Always prefer <code>textContent</code>. <br>4. <strong>Network assumptions</strong> — candidate paths assume <code>TV_BASE</code> correctness and same-origin behavior; some candidate URLs are root-absolute (<code>/labels_injected.json</code>) which may not be present in certain embedding scenarios. <br>5. <strong>Labels format variance</strong> — deeply nested or unexpected keys in labels JSON may not be matched by the key-shape heuristics; mapping logic is complex and can miss cases. <br>6. <strong>Orphaned temp state</strong> — not applicable here, but orphaned injected caption elements may persist across repeated renders if the viewer reuses the same container without a clean-up step. <br>7. <strong>Accessibility</strong> — toasts have ARIA attributes, but inserted captions lack explicit ARIA roles (they are purely presentational) — acceptable for captions but could be enhanced for screen reader announcement.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label=""> <strong>Integration points & extension hooks</strong><br><br>• <strong>Expose a single canonical helper module</strong> — consolidate duplicated helpers (<code>_normalizeKey</code>, <code>sanitizeForId</code>, <code>buildPrefixCandidatesFromLabels</code>) into <code>window.__tv_utils</code> and import from there to reduce duplication. <br>• <strong>Pluggable caption renderer</strong> — expose a hook like <code>window.__ptt_render_caption = function(el, captionText, idx) { /* custom */ }</code> so host pages can customize markup or aria attributes. <br>• <strong>Configurable timeouts & candidates</strong> — allow host to override label/script candidate arrays and fetch timeouts via <code>window.tvConfig</code> or <code>document.body</code> attributes. <br>• <strong>Observability hooks</strong> — emit custom events (e.g., <code>document.dispatchEvent(new CustomEvent(&#x27;ptt:captionsApplied&#x27;,{detail:{injectedCount: X}}))</code>) for analytics and debugging. <br>• <strong>Optional locking / dedupe</strong> — provide an API to remove stale captions before injecting or to scope captions to the viewer subtree (e.g., <code>#tables-viewer</code>) to avoid affecting unrelated tables on host pages.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label=""> <strong>Recommendations & maintainability notes</strong><br><br>• <strong>Deduplicate helper logic</strong>: centralize helpers used in multiple IIFEs (<code>_normalizeKey</code>, <code>buildPrefixCandidatesFromLabels</code>, <code>sanitizeForIdLocal</code> etc.) into <code>window.__tv_utils</code> to reduce drift. <br>• <strong>Prefer <code>textContent</code> over <code>innerHTML</code></strong> for caption insertion to avoid reliance on escaping and reduce XSS risk. Replace <code>innerHTML = &#x27;&lt;strong&gt;...&lt;/strong&gt;&#x27;</code> with <code>const s=document.createElement(&#x27;strong&#x27;); s.textContent=...; wrap.appendChild(s);</code>. <br>• <strong>Increase observability under debug mode</strong>: consolidate debug logs behind <code>TV_DEBUG</code> and optionally surface non-fatal issues via <code>showToastOnce</code> or a debug console element for integrators. <br>• <strong>Parameterize timeouts & candidate lists</strong> via <code>window.tvConfig</code> so embedding pages can tune for slow networks or different asset layouts. <br>• <strong>Document labels JSON shape</strong> and prefer a normalized lookup helper (single canonical <code>captionFor(labelsObj, prefix, idx)</code> exported) to simplify matching logic and reduce duplicate code paths. <br>• <strong>Add cleanup hooks</strong>: before injecting captions, optionally remove captions that were injected by previous runs inside the same viewer container to avoid duplication when HTML is re-rendered into the same element. <br>• <strong>Unit/integration tests</strong>: add tests for caption id collision resolution, labels formats (flat, nested, zero-padded), slow network/timeouts, and conversion error paths. <br>• <strong>Accessibility</strong>: consider adding <code>aria-describedby</code> or linking table <code>id</code> to caption <code>id</code> where semantic connection is desired (if not interfering with existing semantics).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label=""> <strong>Short checklist of behaviors to verify when integrating</strong><br><br>• Script initializes <code>TV_BASE</code> and sets <code>window.tvConfig</code> defaults. <br>• <code>loadExtraSequentially</code> attempts each candidate path and calls <code>onDone</code> on first success; <code>startExtraLoader</code> respects idempotent guards. <br>• <code>tryLoadLabels</code> returns <code>{}</code> when no valid JSON is found; <code>installTocAndLabels</code> populates <code>window.__ptt_labels_injected</code> and <code>window.__ptt_toc_and_labels_installed</code>. <br>• <code>__ptt_apply_injected_captions</code> uses inferred prefixes and numeric fallbacks to find captions; inserts <code>.table-caption</code> elements <strong>before</strong> their related <code>&lt;table&gt;</code>; prefers <code>id=&quot;Table{n}&quot;</code> when available and avoids replacing non-caption elements with same id. <br>• <code>__tv_do_convert</code> posts to <code>/api/render</code>, handles JSON or HTML responses, and delegates to <code>PasteToTable.routeHtmlToAreas</code> when available; conversion flow sets and clears <code>__tv_convert_in_progress</code>. <br>• Toasts queueing, dismiss, and accessibility attributes behave as expected; <code>downloadBlob</code> and clipboard fallbacks work in legacy browsers. <br>• Event handlers for convert, clear, save, render, and action dispatching attach once and do not duplicate.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label=""> <strong>Conclusion</strong><br><br><code>script.core.js</code> is a pragmatic, defensive core suitable for embedding in diverse host pages. It correctly implements caption injection behavior required by PasteToTable: preferring <code>Table{n}</code> ids, inserting captions before the table/collapse toggle, reusing existing caption elements, and robustly loading external labels/toc scripts with sensible fallbacks. Maintenance priorities are (1) deduplicating helper functions, (2) reducing mixed use of <code>innerHTML</code> vs <code>textContent</code> for safety, (3) improving observability under debug mode, and (4) adding configurable timeouts and candidate lists for asset loading. With those changes the module will be easier to test and extend while retaining the current resilience and UX-oriented fallbacks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr></tbody></table></div><div class="row-count">Rows: 12</div></div><div class="table-caption" id="Table2" data-table="Docu_0125_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2 • script.list.js</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by script.list.js — Exhaustive Technical Breakdown (single-column)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">script.list.js — Exhaustive Technical Breakdown (single-column)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>1) One-line summary / intent:</strong> Client-side file/group listing, selection and batch-loading subsystem for PasteToTable. Discovers server-side saved files (multiple endpoints), builds grouped UI, supports search/scoring, fetches selected files in parallel while preserving original order, populates the paste area, and schedules caption application and a <code>ptt:groupLoaded</code> event. Focus: defensive I/O, ordered assembly, immutable runtime captions, and backwards-compatible public APIs.                                           </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>2) Public API & globals:</strong> Implicit public behavior (no exported object): <code>loadFilesSequentialAndHideForm(list)</code> (kept name for compatibility), <code>buildAndPresent()</code> (internal trigger), <code>attachListHandler()</code> (attached to LIST_BTN_ID), <code>window.__ptt_runtime_captions</code>, <code>window.__tv_last_source</code>, <code>window.__tv_last_source_ts</code>, <code>window.__ptt_list_render_in_progress</code>, <code>window.__ptt_copy_raw_from_paste</code>, <code>window.__ptt_set_force_raw_copy</code>. Also writes <code>window.PTLabels</code> when labels parsed.                                            </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>3) Configuration & constants:</strong> Top-level flags and timeouts: <code>ENABLE_CACHE_BUSTER</code> (false), <code>DEBUG</code> (false), <code>FILE_FETCH_TIMEOUT_MS</code> 12,000 ms, <code>INDEX_FETCH_TIMEOUT_MS</code> 8,000 ms, <code>GROUPS_FETCH_TIMEOUT_MS</code> 4,000 ms, <code>LABELS_FETCH_TIMEOUT_MS</code> 3,000 ms, <code>MAX_LIST_ITEMS</code> 5000, <code>ENABLE_WORKER_SCORING</code>, <code>WORKER_THRESHOLD</code>, etc. Multiple candidate endpoints arrays for live files, groups.json, labels.json.                                                                                                                             </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>4) Defensive patterns & feature detection:</strong> Functions wrap most operations in <code>try/catch</code>. Feature-detects <code>AbortController</code> (used in <code>fetchWithTimeout</code> and <code>fetchFileWithTimeout</code>). Uses <code>queueMicrotask</code> in a try/catch. Uses <code>navigator.clipboard</code> when available. Many fallbacks (execCommand, hidden textarea) for older environments.                                                                                                                                                                                                  </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>5) Discovery: LIVE_FILES_ENDPOINTS probing:</strong> <code>fetchLiveFilesSequential(endpoints)</code> probes endpoints sequentially until one returns valid body. It accepts JSON arrays or object <code>{ files: [...] }</code>, or plain text line lists. Normalizes entries via <code>normalizeIndexData</code>. Returns <code>{ ok: true, data: [...], source: url }</code> or <code>{ ok:false, data:[], source:null }</code>. Sequential strategy avoids multiple parallel probes but adds latency if first endpoints fail.                                                                            </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>6) Fetch wrapper with timeout semantics:</strong> <code>fetchWithTimeout(url, timeoutMs)</code> implements an AbortController-based timeout when available and a timer fallback otherwise. Returns an object <code>{ ok, status, url, body, err }</code> — never rejects. Uses <code>cache: &#x27;no-store&#x27;</code> and <code>credentials: &#x27;same-origin&#x27;</code> and optionally appends cache-buster when <code>ENABLE_CACHE_BUSTER</code>. Defaults: INDEX_FETCH_TIMEOUT_MS.                                                                                                                                       </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>7) Index normalizer:</strong> <code>normalizeIndexData(raw)</code> accepts arrays of strings or objects and produces <code>{ name, url, path, description }</code> entries limited by <code>MAX_LIST_ITEMS</code>. It supports <code>raw.files</code> structure and attempts to pick <code>name</code> from name / filename / url / path. Filters invalid items.                                                                                                                                                                                                                                             </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>8) Labels loader & indexer:</strong> <code>loadLabels()</code> tries candidate LABELS_JSON_CANDIDATES sequentially with <code>fetchWithTimeout</code> and <code>JSON.parse</code>. On success builds <code>buildLabelIndex(parsed)</code> which produces keyed mappings (many key variants using <code>keyVariants</code>) and stores into <code>__ptt_labels_cache</code> and <code>window.PTLabels</code>. Returns cached result on subsequent calls.                                                                                                                                                                            </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>9) Label key heuristics:</strong> <code>canonKey</code>, <code>keyVariants</code>, <code>buildLabelIndex</code> produce many lookup variants (lower/no-space/underscore/dash/number normalizations). This maximizes match success for filenames like <code>chapter_01</code> / <code>chapter-1</code> / <code>chapter01</code>. Might produce collisions if labels.json uses ambiguous keys — later lookups use exact key presence first.                                                                                                                                                                               </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>10) Groups loader:</strong> <code>loadGroupDescriptions()</code> probes GROUPS_JSON_CANDIDATES and returns either a map built from <code>parsed.groups</code> (mapping id/name/canonKey variants to display names) or the parsed object. Robust per-entry guards produce several alternative keys for lookup.                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>11) Grouping heuristic:</strong> <code>groupKeyFromPath(pathOrName)</code> derives group keys using first path segment or filename tokenization. Fallbacks: remove numeric suffixes, join early segments. Returns <code>&#x27;Ungrouped&#x27;</code> for unknowns. <code>safeGroupName</code> is minimal sanitizer.                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>12) BuildGroupsFromLive:</strong> <code>buildGroupsFromLive(liveFiles, labelsIndex)</code> groups normalized live files into <code>{ name, files: [{ name, url, path, caption }] }</code>. For each file it resolves a caption (description or <code>resolveCaptionFor(base, labelsIndex)</code>), encodes saved URLs via <code>encodedSavedUrlFor</code> when needed, and sorts groups alphabetically with <code>&#x27;Ungrouped&#x27;</code> last.                                                                                                                                                                   </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>13) Caption resolution heuristics:</strong> <code>resolveCaptionFor(baseName, labelIndex)</code> builds numerous candidate keys and checks them against <code>labelIndex</code>. Uses longest-match ordering and fuzzy fallback scanning (contains/contained checks) for best label. Good odds of resolving, but may mismatch when labels are ambiguous or when filenames are nonstandard.                                                                                                                                                                                  </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>14) PresentGroupsOnly UI responsibilities:</strong> Builds a modal containing a searchable, grouped list with expand/collapse and per-group Load buttons. Styles are fully inline (many style assignments). The modal uses <code>createModal()</code> and returns a handle with a <code>close()</code> override to dispose engine.                                                                                                                                                                                                                                          </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>15) Modal builder details:</strong> <code>createModal(contentEl, title)</code> constructs overlay + panel + header + Close button, moves any existing <code>[data-ptt-search]</code> element to header if present, appends content to panel, attaches keyboard handler to close on Escape, and focuses the first focusable element. Uses CSS variables <code>--panel</code>, <code>--text</code>, <code>--muted</code> where possible.                                                                                                                                                                       </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>16) Search engine: createFileSearchEngine(items, opts):</strong> Builds an in-memory inverted index with limited postings per token. For each item it stores tokens and trigrams and provides <code>candidatesForQuery(q)</code> (fast postings lookup) and <code>scoreFiles(query, candidateIdxs)</code> (detailed scoring). Tokenization removes punctuation and limits to 50 tokens. Trigram sets used for partial-match scoring and overlap-based boost.                                                                                                                </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>17) Scoring function details:</strong> <code>scoreFiles</code> is synchronous but returns a Promise. Scoring components: exact quoted phrase (big boost), caption match, filename match, token matches (28 pts each), token-prefix beginnings (additional 10–18 pts), trigram overlap (normalized to 60 pts), cheap Damerau–Levenshtein (<code>cheapDL</code>) fuzzy boost for short queries, length penalty, and sorting by final score. Tuned weights exist but are heuristic.                                                                                            </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>18) Worker flags but no worker bootstrap:</strong> Flags <code>ENABLE_WORKER_SCORING</code>, <code>WORKER_THRESHOLD</code>, <code>WORKER_TIMEOUT_MS</code> exist but this file does not instantiate a Web Worker — indicates optional external worker integration or an omitted piece. If intended, worker orchestration must be implemented elsewhere.                                                                                                                                                                                                                                </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>19) UI rendering: incremental creation:</strong> <code>presentGroupsOnly</code> constructs <code>groupMap</code>, flattens into <code>FILE_ITEMS</code>, builds <code>engine</code>, and then creates controls for each group (<code>createGroupRowForRender</code>) — header, toggle, Load button and hidden fileList with per-file rows. File rows call <code>loadFilesSequentialAndHideForm</code> on click.                                                                                                                                                                                                         </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>20) Expand/collapse behavior:</strong> Per-group toggle buttons set <code>aria-expanded</code> and flip glyph (<code>▸</code>/<code>▾</code>). <code>expandAllBtn</code> toggles visible groups. <code>updateExpandButtonState()</code> calculates summary state and hides the expand control when no visible groups. Visibility is controlled by <code>style.display</code>.                                                                                                                                                                                                                                           </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>21) Search UI integration:</strong> Search input debounced (120ms) drives engine queries. On empty query it repopulates all groups. On query it gets candidate indexes via <code>engine.candidatesForQuery</code> then calls <code>engine.scoreFiles(q, cand)</code> and renders top results (up to 800). Robust fallback: if scoring rejects, it performs a naive substring search over <code>engine.lite</code>.                                                                                                                                                                     </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>22) Efficient render of matches:</strong> <code>renderGroupsFromFileResults</code> groups scored file matches by group index, calculates top per-group score, and populates group file lists with top files limited by 200 each. It only appends groups with visible matches and hides others. This minimizes DOM volume for large datasets.                                                                                                                                                                                                                     </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>23) Highlighting & security:</strong> <code>highlight</code> uses regex to wrap matched tokens in <code>&lt;mark&gt;</code> and returns HTML inserted into <code>innerHTML</code> of title/file/caption elements. Input for highlight is normalized via <code>tokensOf</code>. Because highlight wraps user text into HTML, content is not escaped there — this is safe <em>only</em> because filenames/captions originated from server-side sanitized data or from <code>labels</code> resolved earlier; otherwise risk of injecting markup exists. <code>escapeHtmlLocal</code> is present but not used on highlighted HTML parts. </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>24) Per-file fetch semantics (parallel ordered):</strong> <code>loadFilesSequentialAndHideForm</code> does the heavy work: it creates <code>runtimeCaptions</code>, freezes them into <code>window.__ptt_runtime_captions</code> (immutable via JSON deep-clone + <code>Object.freeze</code> fallback), then maps each file to a fetch promise via <code>fetchFileWithTimeout</code> and <code>Promise.all</code>. Fetches are parallel but results are re-ordered by <code>idx</code> to preserve original order. Failures insert inline HTML comments like <code>&lt;!-- failed to fetch: ... --&gt;</code>.                                      </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>25) fetchFileWithTimeout specifics:</strong> Uses <code>AbortController</code> when available and returns a promise resolving to text or rejecting. Uses <code>cache: &#x27;no-store&#x27;</code> and <code>credentials: &#x27;same-origin&#x27;</code>. Timer is cleared on completion. On failure rejects with <code>Error(&#x27;HTTP n&#x27;)</code> or the underlying exception.                                                                                                                                                                                                                                            </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>26) Decoding strategy & BOM handling:</strong> <code>stripBOM</code> removes U+FEFF when present. <code>safeDecode(text)</code> currently returns <code>String(text ?? &#x27;&#x27;)</code> and contains a commented/unimplemented <code>TextDecoder</code> branch — effectively a no-op because <code>Response.prototype.text()</code> already yields decoded UTF-8 in browsers. If server may send non-UTF8 or binary payloads, implement <code>TextDecoder</code> usage (detect <code>ArrayBuffer</code>/<code>Uint8Array</code> path) or clearly document UTF-8-only expectation.                                                                              </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>27) Combine & inject flow:</strong> After fetch completion the script builds <code>accMarked</code> (for convert) and <code>accRaw</code> (raw paste). If a file has a caption it prepends <code>&lt;!-- caption: ... --&gt;</code> and a markdown heading via <code>safeMarkdownHeading</code>. It writes combined text into <code>PASTE_ID</code> (textarea) or <code>#page-area.textContent</code>, updates <code>window.__tv_last_source</code> and <code>__tv_last_source_ts</code>, and may update <code>document.title</code> if the title appears to be the default. Ensure title-update uses conservative heuristics to avoid overwriting meaningful titles.     </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>28) Convert invocation strategy:</strong> Attempts <code>window.__tv_do_convert({ text, metadata:{fromList:true} })</code> then falls back to <code>window.convert(text)</code>. If neither exist it writes text to hidden textarea <code>__ptt_hidden_convert</code> and shows a toast. Convert call is invoked fire-and-forget (wrapped in a promise race with 5s) — callers cannot reliably await convert completion. Recommendation: return a Promise from top-level API (see item 40.7).                                                                                                     </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>29) Caption application loop:</strong> <code>applyRuntimeCaptions</code> polls for caption nodes (<code>.table-caption</code> or specific headings) and writes <code>__ptt_runtime_captions</code> into them, inserting escaped <code>&lt;strong&gt;</code> parts or removing defaults. It retries up to <code>maxRetries</code> (default 120) with <code>intervalMs</code> 160ms (~19.2s). Polling tolerates async renderers but is noisy and brittle; prefer a renderer readiness hook/event to reduce poll retries and false timeouts.                                                                                                </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>30) Event dispatch semantics:</strong> After assembly a microtask dispatches <code>new CustomEvent(&#x27;ptt:groupLoaded&#x27;, { detail: { runtimeCaptions, count } })</code>. <code>queueMicrotask</code> is used but guarded; environments lacking it will still run (try/catch). Consumers should handle duplicate events and not assume single delivery.                                                                                                                                                                                                                                    </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>31) Metadata POSTs:</strong> <code>trySendActiveGroupMetadata(groupObj, client_req_id)</code> POSTs sanitized JSON to <code>/api/group/load</code> (non-blocking). Errors are logged via <code>dbg</code>; failures are ignored. Ensure server expects <code>same-origin</code> credentials and that CSRF protections exist for this endpoint.                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>32) Copy & paste handling:</strong> Global click delegation handles <code>copy-markdown</code> and <code>copy-plain</code> selectors. If <code>window.copyTableMarkdown</code> / <code>window.copyTablePlain</code> exist and <code>window.__ptt_force_raw_copy</code> is false, delegates there. Otherwise it extracts the Markdown block from raw paste and copies via <code>navigator.clipboard</code> with <code>execCommand</code> fallback. Exposes <code>window.__ptt_copy_raw_from_paste</code> and <code>window.__ptt_set_force_raw_copy</code>.                                                                                                           </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>33) Input sync:</strong> <code>attachPasteSync</code> binds <code>input</code> event on <code>PASTE_ID</code> to update <code>window.__tv_last_source</code> and timestamp. Event listener is passive where possible. This keeps metadata in sync with manual edits.                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>34) Memory & lifecycle concerns:</strong> Modal <code>modalHandle.close()</code> calls <code>engine.dispose()</code> but global listeners (copy delegation, paste sync, LIST_BTN_ID click) remain attached. For SPAs or hot reloads add a global <code>dispose()</code> that removes those listeners and clears <code>__ptt_labels_cache</code> when appropriate.                                                                                                                                                                                                                                            </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>35) Security considerations:</strong> Mixed use of <code>innerHTML</code> (highlighting, title/caption rendering) creates XSS risk if server data is untrusted. <code>sanitizeCaptionForInjection</code> strips tags for <code>&lt;!-- caption --&gt;</code> and <code>mdHeading</code> but <code>highlight</code> returns unescaped HTML. Fix by escaping before highlight and then performing safe DOM wraps (text nodes + <code>&lt;mark&gt;</code> nodes) instead of setting <code>innerHTML</code>. Verify CSRF for metadata POSTs.                                                                                                                  </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>36) Accessibility (a11y) notes:</strong> Modal uses <code>role=&quot;dialog&quot;</code> and <code>aria-modal=&quot;true&quot;</code>, buttons use <code>aria-expanded</code>/<code>aria-pressed</code>, search input has <code>aria-label</code>. Improvements: restore focus after close, add <code>aria-controls</code> on group toggles, provide <code>aria-live</code> updates for search results counts, and enable arrow-key navigation between file rows.                                                                                                                                                                                                 </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>37) Performance characteristics & limits:</strong> Heavy CPU work is inverted-index build and scoring. Engine caps postings/candidates with <code>MAX_POSTINGS</code>/<code>MAX_CANDIDATES</code>. Rendering creates only visible groups and limited file lists. <code>MAX_LIST_ITEMS = 5000</code> bounds input size but building <code>engine.lite</code> for many items can still be slow on weak devices — consider incremental indexing or worker offload.                                                                                                                                              </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>38) Edge cases & failure modes:</strong> Partial fetch failures insert <code>&lt;!-- failed to fetch: ... --&gt;</code> which may break downstream parsers. If convert never generates caption nodes, caption polling times out. <code>document.title</code> heuristic can overwrite legitimate titles. <code>encodeSavedUrlFor</code> can mishandle already-encoded or absolute saved URLs. Include robust fail-safes and clearer user feedback on partial failures.                                                                                                                                   </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>39) Test matrix & integration checks to add:</strong> Verify <code>fetchLiveFilesSequential</code> normalizes JSON arrays, <code>{ files }</code>, and plain text; <code>loadLabels</code> tolerates malformed JSON and caches; <code>resolveCaptionFor</code> matches filename variants; <code>createFileSearchEngine</code> tokenization/trigram/fuzzy behavior; <code>loadFilesSequentialAndHideForm</code> preserves order on mixed success/failure; <code>applyRuntimeCaptions</code> works when captions appear late.                                                                                                                   </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>40) Concrete prioritized improvements (recommended):</strong><br>1) Escape-before-highlight and perform DOM-based highlighting.<br>2) Implement <code>TextDecoder</code> fallback for non-UTF8/binary if needed.<br>3) Workerize scoring when <code>engine.lite.length &gt; WORKER_THRESHOLD</code> (flags present).<br>4) Add <code>dispose()</code> to remove global listeners and clear caches.<br>5) Replace inline styles with CSS classes.<br>6) Replace polling caption loop with renderer readiness event hook.<br>7) Make <code>loadFilesSequentialAndHideForm</code> return a Promise so integrators can await completion. </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>41) Observability & debugging enhancements:</strong> Add <code>scriptList._diagnostics()</code> returning counts (endpoints tried, labels cached, groups loaded, files fetched, timing). Replace silent <code>dbg</code> catches with <code>DEBUG</code>-gated <code>console.warn</code> including stack/context. Log last-successful labels/groups URL for troubleshooting.                                                                                                                                                                                                                                 </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>42) Backwards compatibility & API preservation:</strong> Maintain exported entry points and side-effects: <code>loadFilesSequentialAndHideForm</code> name, click-binding behavior, <code>window.__tv_last_source</code>, <code>window.__ptt_runtime_captions</code> deep-freeze semantics, and the <code>ptt:groupLoaded</code> event schema. Any refactor must preserve these or provide compatibility shims.                                                                                                                                                                                              </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>43) Security checklist before edits:</strong> Escape highlighted HTML or rework to DOM highlighting; ensure <code>fetch</code> calls use correct credentials and do not leak across origins; validate server CSRF/CORS policies; sanitize <code>labels.json</code> and <code>groups.json</code> inputs; ensure metadata POSTs exclude user-supplied scripts.                                                                                                                                                                                                                                      </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>44) Compatibility & browser support:</strong> Uses modern APIs (<code>fetch</code>, <code>AbortController</code>, <code>queueMicrotask</code>) but includes guarded fallbacks for <code>queueMicrotask</code> and <code>navigator.clipboard</code>. Works on evergreen browsers; document minimum supported browsers and polyfills for legacy environments if required.                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>45) Maintainability & separation of concerns:</strong> File currently mixes UI, network, scoring, and copy logic. Long-term split recommended: <code>labels-loader</code>, <code>groups-loader</code>, <code>search-engine</code> (worker-friendly), <code>modal-ui</code>, and <code>fetcher</code>. That enables smaller, testable modules and targeted workerization.                                                                                                                                                                                                                                                </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>46) Minor bugs / gotchas found on careful pass:</strong> <code>safeDecode</code> contains dead TextDecoder code — implement or remove. <code>encodeSavedUrlFor</code> prepends <code>/saved/</code> and may double up. Highlight regex should use Unicode (<code>u</code>) flag for Unicode tokens. <code>presentGroupsOnly</code> sets <code>role=&quot;list&quot;</code> but group items lack <code>role=&quot;listitem&quot;</code>.                                                                                                                                                                                                                           </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>47) Suggested unit tests (concrete):</strong> - <code>fetchWithTimeout</code> times out and returns <code>{ok:false, err:&#x27;timeout&#x27;}</code>. - <code>normalizeIndexData</code> accepts varied JSON shapes. - <code>resolveCaptionFor(&#x27;chapter-01.md&#x27;)</code> finds <code>chapter_1</code> in sample labelIndex. - <code>createFileSearchEngine</code> returns expected candidates and ordering. - <code>loadFilesSequentialAndHideForm</code> preserves order when the 2nd file fails. - <code>applyRuntimeCaptions</code> applies a caption when node appears after 300ms.                                                                               </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>48) Documentation suggestions:</strong> Document config flags (cache-buster, timeouts), valid <code>labels.json</code> and <code>groups.json</code> formats, <code>ptt:groupLoaded</code> event schema, and public globals. Add integration note on how to wire an external worker for scoring.                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>49) Migration & rollout guidance:</strong> Gate worker scoring and verbose <code>DEBUG</code> behind runtime feature flags. Deploy to staging with <code>DEBUG</code> enabled, exercise live-files fallbacks, and ensure <code>dispose()</code> exists before rolling to SPAs. Provide rollback plan and feature flag toggles.                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="script.list.js — Exhaustive Technical Breakdown (single-column)"> <strong>50) Final checklist before editing or refactor:</strong><br>(1) Preserve public entry points and emitted events.<br>(2) Keep or replace <code>window.__ptt_runtime_captions</code> deep-freeze behavior.<br>(3) Escape user data before any <code>innerHTML</code> insertion or rework highlight to operate on DOM text nodes.<br>(4) Implement or remove dead <code>TextDecoder</code> code.<br>(5) Add <code>dispose()</code> and diagnostics.<br>(6) Add unit tests covering fetch/parse/score/caption/error paths.<br>(7) Consider workerization for scoring on large lists. </td></tr></tbody></table></div><div class="row-count">Rows: 50</div></div><div class="table-caption" id="Table3" data-table="Docu_0125_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3 • script.table.js</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by assets/script.table.js — Exhaustive Technical Breakdown (expanded)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">assets/script.table.js — Exhaustive Technical Breakdown (expanded)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>1) One-line summary / intent</strong>: A defensive, caption-safe client-side table interaction and export subsystem for PasteToTable: builds TOCs from server-rendered caption-like elements (does not create captions), provides single-table row anchors, Unicode-aware search & highlighting, reversible three-state column sorting, collapse/expand UX, copy/export (plain, Markdown, CSV, JSON, XLSX, PDF), responsive control layout, idempotent initialization, and cooperative integration points (PTToc, tvUtils, XLSX, tableVirtualizer).                                                                                                                                                                                                                                    </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>2) Design principles (explicit)</strong>: Non-destructive (reads caption-like nodes but never invents them), idempotent re-init (dataset flags prevent duplicative listeners), feature-graceful (prefer global helpers), defensive (widespread try/catch to avoid runtime crashes), accessible (aria attributes, focus management), compatible (checks APIs like AbortController, matchMedia), observable-extensible (exposes functions on <code>window</code> for other modules).                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>3) Public API & global exposure</strong>: Exposes <code>window.PasteToTable.initRenderedContent</code>, <code>window.PTTable.buildTocs</code>, <code>window.copyTablePlain</code>, <code>window.copyTableMarkdown</code>, <code>window.exportTableCSV</code>, <code>window.exportTableJSON</code>, <code>window.exportTableXLSX</code>, <code>window.exportTablePDF</code>, <code>window.exportAllBtnHandler</code>, <code>window.searchTable</code>, <code>window.toggleTable</code>, <code>window.toggleAllTables</code>, and <code>window.backToTop</code>. Also writes dataset flags (e.g., <code>data-tvHandlerAttached</code>) to DOM elements for idempotency.                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>4) High-level control flow (init)</strong>: On DOMContentLoaded or immediate if ready: <code>initRenderedContent()</code> is invoked → ensure <code>.table-container</code> wrappers exist → build TOCs (<code>buildTocs()</code>) → assign row UIDs and snapshot ordering (<code>_ensureRowUidsAndSnapshot</code>) → cache <code>data-orig-html</code> for cells → attach per-table handlers idempotently → optimize controls layout → update row counts → scroll first table into view.                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>5) TOC behavior & heuristics</strong>: <code>buildTocs()</code> first defers to <code>window.PTToc.init/build</code> (if present) with selectors; fallback runs <code>buildSingleTableToc()</code> and <code>buildTocFromCaptions()</code>. <code>buildSingleTableToc()</code> triggers when a single logical table is present, enumerates body rows (skips <code>thead</code>), creates anchor <code>&lt;li&gt;&lt;a href=&quot;#id&quot;&gt;</code> entries using a stable ID per row. <code>buildTocFromCaptions()</code> collects <code>.table-caption</code>, <code>.table-title</code>, <code>.table-heading</code> nodes, ensures unique IDs (suffixes collisions), and appends links to <code>#toc</code> and <code>#tocBar</code>. Important: it only reads caption nodes — it does not create or mutate caption text.                                                                                                                             </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>6) ID collision strategy</strong>: When an intended id (e.g., <code>Table1</code> or <code>table-1</code>) is already present and not the same element, code suffixes with <code>-1</code>, <code>-2</code>, ... until unique. This prevents accidental anchor conflicts but can lead to proliferating suffixed IDs over repeated runs or interactions by other scripts.                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>7) Row UID snapshotting & sort restoration</strong>: <code>_ensureRowUidsAndSnapshot(table, tableIdx)</code> assigns <code>data-tv-uid = tvuid-N</code> for each row if not present and records <code>originalRowOrders[tableIdx] = [uid...]</code>. <code>sortTableByColumn</code> reorders DOM rows based on comparison, and on 3rd state restores original order by re-attaching rows in the snapshot order, searching by <code>tr[data-tv-uid=&quot;...&quot;]</code>. Restoration fails to include rows added after snapshot or rows without UIDs.                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>8) Sorting algorithm & rules</strong>: Three state per column: 0 (unsorted) → 1 (ascending) → 2 (descending) → 0 (restore). Sorting determines numeric vs lexical ordering by <code>parseFloat</code> on sanitized cell text (commas removed). Numeric sort applied if both parse to numbers. For ties fallback to <code>localeCompare</code>. Sorting mutates DOM by appending rows in sorted order (may cause many reflows). <code>sortStates</code> array stores per-table per-column state; header buttons get <code>sort-state-*</code> classes and <code>aria-sort</code> attributes updated.                                                                                                                                                                                                                                           </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>9) Complexity & performance of sorting</strong>: Sorting cost O(n log n) comparisons for n rows; cost dominated by string parsing/comparisons. DOM reattachment is O(n) append operations causing layout thrashing. For large tables (thousands of rows) this is slow: recommendation — build <code>DocumentFragment</code>, append all sorted rows once, then replace <code>tbody</code> contents in a single operation.                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>10) Search normalization & Unicode handling</strong>: <code>normalizeForSearchLocal</code> uses NFD normalization + removal of combining diacritics <code>\u0300-\u036f</code>, then strips non-letter/number characters. If <code>window.__tv_utils.normalizeForSearchLocal</code> exists, it defers to it. This yields case-insensitive, diacritic-insensitive search.                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>11) Highlight matching algorithm (detailed)</strong>: <code>buildNormalizedMapForCell(cell)</code> walks text nodes with a <code>TreeWalker</code>, constructs <code>normStr</code> — a per-codepoint filtered normalized string — and a <code>map</code> array mapping each normalized character position back to <code>{ nodeIndex, offsetInNode }</code>. This supports matching across multiple adjacent text nodes and surrogate pairs. <code>highlightMatches(cell, filterNorm)</code> finds all occurrences of <code>needle</code> in <code>normStr</code>, then for each match uses <code>map</code> entries to compute start and end text-node offsets and splits/ wraps matched text in <code>&lt;mark&gt;</code> elements. Matches are applied right-to-left to preserve indices. Clearing highlights uses <code>data-orig-html</code> (preferred) or replaces <code>&lt;mark&gt;</code> elements with their text children. </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>12) Edge cases in highlighting (subtle)</strong>: Complex emoji sequences (ZWJ, skin tone modifiers) contain multiple codepoints that may normalize unexpectedly; zero-width joiners and grapheme clusters can cause off-by-one mapping leading to split grapheme rendering. The algorithm attempts codepoint-aware offsets (checks <code>codePointAt</code> and char length) but may still mishandle complex sequences. Recommendation: consider using a grapheme cluster library (e.g., Intl.Segmenter or third-party) or a simpler highlight that searches on node.textContent boundaries for extreme cases.                                                                                                                                                                                   </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>13) Search runtime & mitigation</strong>: Building the normalized map is linear in the number of codepoints in a cell; worst-case for many large cells CPU & memory heavy. Mitigations present in code: debouncing search input; <code>window.tvConfig.highlight</code> guard to skip highlight; recommend: threshold-based skip (e.g., skip highlights for cells > 10k chars), incremental/async chunking, or Web Worker offload for normalization in very large docs.                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>14) Hiding non-matching rows</strong>: <code>searchTable()</code> runs per-table: for each row, clears highlights, computes normalized cell text and checks inclusion of <code>filterNorm</code> (normalized). Rows with no cell matching are hidden (<code>row.style.display = &#x27;none&#x27;</code>). First matching row is scrolled into view. Virtualized tables must call <code>tableVirtualizer.refresh()</code> or <code>update()</code>; code checks for <code>window.tableVirtualizer</code> and tries to call refresh/update if available.                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>15) Copy plain & Markdown behavior</strong>: <code>copyTablePlain(btn)</code> builds tab-separated plain-text from DOM cells and uses <code>copyToClipboard</code>. If table absent, falls back to <code>window.__tv_last_source</code> (raw source) if present. <code>copyTableMarkdown(btn)</code> first tries <code>getPreferredSourceForTable(table)</code> — which tries to map DOM table to its original markdown block in <code>window.__tv_last_source</code> using heuristics (block splitting by blank lines, header matching), preferring original source for accurate Markdown. If not found, <code>tableToMarkdownLines()</code> converts DOM table to pipe-table Markdown. Both use either <code>tvUtils.showCopyModal</code> if available or <code>copyToClipboard</code>.                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>16) Export formats & fallbacks</strong>: CSV: joins rows with commas, quotes containing <code>&quot;</code> by doubling, adds BOM (<code>\uFEFF</code>) to help Excel with UTF-8. JSON: builds array of objects using header row (thead) if present, otherwise <code>ColN</code> keys. XLSX: attempts <code>window.XLSX.utils.book_new</code> + <code>aoa_to_sheet</code> + <code>writeFile</code> or <code>write</code> variations; if unavailable or fails, falls back to creating TSV inside a Blob but warns user. PDF: constructs simple HTML with inline minimal CSS and <code>table.outerHTML</code>, opens a new window, writes HTML and calls <code>print()</code> after a small timeout — may be blocked by popup blockers.                                                                                                                                                          </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>17) Export caveats</strong>: XLSX fallback as TSV is not a true <code>.xlsx</code> binary — consumers expecting native <code>.xlsx</code> may be confused. CSV/TSV use simple quoting but do not attempt advanced escaping for multiline fields beyond simple <code>&quot;</code> quoting. PDF relies on <code>window.open</code> (popup blockers) and on client-side print to PDF support — not guaranteed.                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>18) Collapse/Expand details</strong>: <code>toggleTable(btn)</code> finds wrapper, toggles <code>tbody.style.display</code> between <code>none</code> and <code>&quot;&quot;</code>, toggles button text between 'Collapse Table' and 'Expand Table', updates <code>aria-expanded</code>. <code>toggleAllTables()</code> checks any expanded state and flips globally. This approach toggles visual display but leaves rows present in DOM; virtualizers or accessibility readers may still enumerate hidden rows unless <code>aria-hidden</code> or <code>hidden</code> attributes are used — current code uses style only.                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>19) Layout optimization & responsiveness</strong>: <code>optimizeTableControls()</code> moves control nodes into a <code>.table-header-wrapper</code>, creates a <code>.copy-buttons</code> container if needed, and adapts button sizing/padding for narrow screens (<code>(max-width:600px)</code>). It debounces via <code>window.tvConfig.debounceMs</code>. It also ensures toggle button placement and normalizes classes (<code>table-toggle-inline</code>).                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>20) Event binding & idempotency</strong>: Per-wrapper per-button attachments set <code>btn.dataset.tvTableIndex</code> and <code>btn.dataset.tvHandlerAttached = &quot;1&quot;</code>, avoiding duplicate handlers. Search input bound once (<code>sb.dataset.tvBound</code>). Global delegated click handlers capture sort clicks (by <code>.sort-btn</code>/<code>.th-with-sort</code>) and <code>#tocBar</code> anchor clicks. Keyboard handlers bind <code>/</code> to focus search and <code>Escape</code> to <code>backToTop</code>. All handlers wrapped in <code>try/catch</code>.                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>21) Memory & lifecycle</strong>: The module stores <code>originalRowOrders</code> and cell <code>data-orig-html</code> for each table. No explicit <code>dispose()</code> is provided; if tables are torn down or replaced frequently, memory may grow or stale references remain. Recommendation: add <code>PasteToTable.dispose()</code> to clear <code>originalRowOrders</code>, remove dataset flags, and optionally remove attached listeners.                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>22) Error handling trade-offs</strong>: The code prefers silence over loud failures (many <code>try/catch</code> with empty catches). This avoids user-facing crashes but complicates debugging. Recommendation: add an optional <code>DEBUG</code> flag to log caught errors to <code>console.warn</code> with contextual metadata while preserving stability.                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>23) Integration touchpoints</strong>: Code cooperates with: <code>window.PTToc</code> (TOC builder), <code>window.tvUtils</code> (copy/download/showToast/debounce), <code>window.XLSX</code> (SheetJS), <code>window.tableVirtualizer</code> (refresh/update), <code>window.tvConfig</code> (highlight/debounceMs). Provide these objects for richer behavior. <code>getPreferredSourceForTable</code> depends on <code>window.__tv_last_source</code> populated by other modules.                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>24) Security & sanitization</strong>: Exported HTML for PDF and copy operations uses <code>table.outerHTML</code> and <code>innerHTML</code> in places. Input flow largely reads existing DOM; injection risk is limited because server-rendered content is assumed trusted. However, when producing HTML blobs for download or print, ensure consumers expect raw HTML. <code>escapeHtml</code> is used in other files; this module relies on safe existing DOM and uses <code>textContent</code> in many places to avoid XSS when building strings.                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>25) Accessibility considerations (detailed)</strong>: Sets <code>aria-sort</code> on headers, <code>aria-expanded</code> on toggle buttons, <code>role=&quot;list&quot;</code> on resultsWrap in group UI. TOC links get <code>aria-label</code> and row anchors get <code>tabindex=&quot;-1&quot;</code>. However: hiding rows via <code>style.display = &#x27;none&#x27;</code> does remove them from the accessibility tree in practice, but adding ARIA live announcements for search result counts would improve screen-reader feedback. Also consider adding <code>aria-controls</code> linking TOC items to target tables/captions and <code>aria-live</code> updates for export success/failure.                                                                                                                                                                                                     </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>26) Test matrix & unit/integration checks to add:</strong><br>(1) Sorting correctness with numeric strings containing commas, negative numbers, and empty cells.<br>(2) Restoration of original row order after sorting when rows have been added or removed.<br>(3) Highlight correctness across adjacent text nodes, surrogate pairs, ZWJ sequences, and long text segments.<br>(4) TOC ID-collision handling when a non-caption element already uses <code>Table1</code> (or similar) IDs.<br>(5) Correct precedence logic in <code>getPreferredSourceForTable</code> for Copy/Markdown workflows.<br>(6) XLSX export compatibility across differing SheetJS build variants.<br>(7) PDF printing behavior when <code>window.open</code> is blocked by the browser.<br>(8) Performance profiling and stability verification for large tables (5k+ rows). </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>27) Performance profiling guidance</strong>: Instrument timings for <code>buildNormalizedMapForCell</code> and <code>highlightMatches</code> per-cell (sample slow cells). Measure DOM reflow cost in <code>sortTableByColumn</code> using <code>performance.now()</code> before/after sort and before/after DOM reattachment. Track memory use for <code>data-orig-html</code> sizes with <code>innerHTML.length</code>. If hotspots exceed thresholds, consider Web Worker normalization, using <code>DocumentFragment</code> batch DOM updates, or virtualization (only render visible rows).                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>28) Concrete code improvements (prioritized):</strong><br>1) Replace row-by-row reappend with <code>DocumentFragment</code> batch insertion in <code>sortTableByColumn</code>.<br>2) Add <code>dispose()</code> to remove dataset flags, clear snapshots, and detach event listeners.<br>3) Add a <code>HIGHLIGHT_MAX_CHARS</code> guard and fall back to non-highlighted filtering for very large cells.<br>4) Add optional verbose logging under <code>window.__ptt_debug</code> or <code>window.tvDebug</code>.<br>5) Use <code>requestAnimationFrame</code> when performing many DOM writes so the browser can batch paints.<br>6) Improve XLSX fallback by shipping a minimal client-side library for real <code>.xlsx</code> output or move export server-side. </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>29) Developer ergonomics / debugging suggestions</strong>: Expose a <code>window.PTTable._diagnostics()</code> that returns counts: number of tables, total rows, total characters in <code>data-orig-html</code>, size of <code>originalRowOrders</code>, memory hints. When <code>window.__ptt_debug</code> true, have critical caught errors <code>console.warn</code> with a context object. Include verbose timestamps for long-running operations.                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>30) Example traces (what happens on group-load -> convert)</strong>: (A) Group UI loads files → <code>loadFilesSequentialAndHideForm</code> fetches and concatenates raw sources → it sets <code>window.__tv_group_load_mode = true</code> and dispatches <code>ptt:groupLoaded</code> event → it calls <code>__tv_do_convert({text, metadata:{fromList:true}})</code> → <code>processRenderedHtml</code> injects HTML into <code>#tables-viewer</code> → sets <code>window.__tv_skip_scroll = true</code> → calls <code>PasteToTable.initRenderedContent()</code> via timeouts → <code>initRenderedContent</code> builds wrappers, caches HTML, builds TOCs (reads captions), attaches handlers, optimizes layout, updates row counts, and clears skip flags after coordinated scroll attempts.                                                                                          </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>31) Known behavior differences vs server-side caption injection</strong>: Because this module never creates caption nodes, pages that expect client-side caption injection will not get captions from this script. Server must provide <code>labels_injected.json</code> and <code>script.toc.js</code> (other files) if captions are desired. This module is intentionally caption-safe to avoid duplicate/inconsistent caption DOM mutations.                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>32) Inter-module invariants to preserve</strong>: - Do not assign IDs that collide with meaningful non-caption elements (use suffixing). - Do not overwrite <code>data-*</code> that other scripts may rely on (use <code>data-tv-*</code> namespace). - Maintain idempotency: repeated <code>initRenderedContent()</code> must not attach duplicate listeners or corrupt <code>data-orig-html</code>. - Honor <code>window.tvConfig.highlight</code> and <code>debounceMs</code> when available.                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>33) Backwards compatibility & browser support</strong>: Checks for <code>dataset</code>, <code>closest</code>, <code>AbortController</code>, <code>matchMedia</code>; avoids ES2020-only features (mostly ES6 used). Uses fallbacks (e.g., <code>document.querySelector</code> variants) so it works on evergreen browsers; some Unicode features rely on <code>String.prototype.normalize(&#x27;NFD&#x27;)</code> — widely available but not in very old engines.                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>34) Security checklist for deployments</strong>: Ensure HTML saved/served to users is sanitized on server-side if users can upload content (this module will render and export table HTML). Avoid including untrusted script tags inside <code>table.outerHTML</code> during export. When invoking <code>downloadBlob</code> for user-generated filenames, still sanitize with <code>sanitizeFileName</code> (file name sanitization exists in other shared utilities).                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>35) Migration notes for heavy pages</strong>: For pages with many tables or very large tables, consider: server-side pagination or server-rendered precomputed exports, enable virtualization and ensure <code>tableVirtualizer</code> integration, or lazy-init this module only for the currently visible table to reduce upfront cost.                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>36) Suggested unit/integration test list (concrete cases)</strong>: - Sort numeric columns with values: <code>[&quot;1,234&quot;, &quot;12.5&quot;, &quot;-3&quot;, &quot;&quot;]</code>. - Highlight across nodes: <code>&lt;td&gt;foo&lt;b&gt;bar&lt;/b&gt;baz&lt;/td&gt;</code> search "barbaz". - TOC collision: page has <code>&lt;div id=&quot;table-1&quot;&gt;&lt;/div&gt;</code> and a caption node — ensure caption id gets suffix. - CSV encoding: cell contains <code>He said &quot;hello&quot;, then left</code> → CSV line should be <code>&quot;He said &quot;&quot;hello&quot;&quot;, then left&quot;</code>. - XLSX SheetJS permutations: stub <code>window.XLSX</code> with <code>writeFile</code>, <code>write</code>, only <code>utils</code> available, or no XLSX. - PDF fallback when <code>window.open</code> returns null. - Group-load -> <code>ptt:groupLoaded</code> event fired, <code>__tv_group_load_mode</code> set to true.                                                                                             </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>37) Developer TODOs / low-effort wins</strong>: Add <code>data-ptt-version</code> comment to file header; instrument <code>window.__ptt_metrics</code> object to track calls & durations; add feature-flag toggles for heavy features (<code>highlight</code>, <code>sortSnapshotting</code>, <code>xlsxSupport</code>); small unit tests for <code>keyVariants</code>, <code>canonKey</code> in other modules (consistency); include optional <code>aria-live</code> region to announce search result counts.                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>38) Long-term architectural suggestions:</strong><br>(A) <strong>toc-reader</strong> — read-only caption and row-anchor builder.<br>(B) <strong>search-highlighter</strong> — pure normalization and highlight logic with a fully testable API.<br>(C) <strong>sorter</strong> — snapshot management and sort operations using batch-DOM techniques.<br>(D) <strong>exporters</strong> — isolated CSV/JSON/XLSX/PDF modules.<br>(E) <strong>ui-optimizer</strong> — rendering, throttling, and interaction efficiency.<br>This modular split allows independent performance tuning and clearer unit/integration coverage. </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>39) Risk matrix (likelihood × impact)</strong>: High-likelihood, high-impact: heavy highlight CPU on large tables → UI lock. Medium-likelihood, medium-impact: XLSX API mismatch → failed exports. Low-likelihood, high-impact: ID collisions with important page elements → broken anchors/navigation. Mitigations listed above reduce these risks.                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>40) Final concise checklist before deployment:</strong><br>(1) Enable debug logging temporarily and run integration tests.<br>(2) Profile <code>searchTable()</code> and <code>sortTableByColumn</code> on real datasets.<br>(3) Add <code>dispose()</code> if pages dynamically replace table content.<br>(4) Ensure <code>window.XLSX</code> is available when XLSX export is required; otherwise communicate fallback clearly.<br>(5) Confirm <code>window.__tv_last_source</code> flow when copy-markdown must prefer original markdown.<br>(6) Add ARIA announcements for search result counts and export completions. </td></tr></tbody></table></div><div class="row-count">Rows: 40</div></div><div class="table-caption" id="Table4" data-table="Docu_0125_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4 • script.toc.js</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by script.toc.js — Exhaustive Technical Breakdown (single-column)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">script.toc.js — Exhaustive Technical Breakdown (single-column)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>1) One-line summary / intent</strong>: Centralized Table-of-Contents and caption/label loader for PasteToTable. Reads heading and table DOM to build TOCs, optionally injects captions from external <code>labels_injected.json</code> sources, keeps a normalized labels cache, schedules background label reloads, and wires lightweight fetch/XHR interceptors to refresh the TOC after group-load or convert operations. Emphasis: defensive, idempotent, non-destructive.                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>2) Public API surface</strong>: Exposes <code>window.PTToc</code> with: <code>PTToc.init(options)</code>, <code>PTToc.build()</code>, <code>PTToc.reloadLabels(opts)</code> (installed by helpers), <code>PTToc.getLabels()</code> (installed by helpers), <code>PTToc.scheduleTocRefresh(opts)</code>, <code>PTToc.applyLabelsNow(labelsObj)</code>. Also writes <code>window.__ptt_labels_injected</code> and <code>window.__ptt_labels_reload_promise</code> as global coordination points. Flags: <code>window.__pt_toc_installed</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>3) High-level control flow on load</strong>: Immediately installs if not already present. Calls <code>PTToc.init()</code> at DOM ready (or immediately if readyState !== loading). <code>init()</code> attaches delegated handlers, either loads labels synchronously (if <code>deferLabelsReload=false</code>) or uses existing <code>window.__ptt_labels_injected</code> and warms background fetches (if <code>deferLabelsReload=true</code>), then calls <code>buildOnce()</code> and starts a <code>MutationObserver</code> to debounce rebuilds.                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>4) Configuration object & defaults</strong>: <code>PTToc.config</code> holds selectors and behavior flags: selectors for <code>toc</code>, <code>tocList</code>, <code>tocBarList</code>, <code>headingSelector</code> (<code>.table-heading</code>), <code>contentSelector</code> (defaults <code>#content</code> then <code>#tables-viewer</code> then <code>body</code>), <code>tableSelector</code> (<code>table</code>), <code>rowLabelPrefix</code> (<code>Topic</code>), <code>labelsPaths</code> (array of candidate JSON paths), <code>bookPrefix</code> (null), <code>deferLabelsReload</code> (true), <code>autoSelectTable1Enabled</code> (true), <code>autoSelectThrottleMs</code> (1200). Debounce for rebuild: <code>_debounceMs</code> = 150 ms.                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>5) Defensive/idempotent guards</strong>: Global guard <code>window.__pt_toc_installed</code> prevents double installation. Internal flags: <code>_fetchWrapped</code>, <code>_xhrWrapped</code>, <code>_delegatedAttached</code>, <code>_mutationObserver</code> used to avoid duplicate wrappers/listeners. <code>scheduleTocRefresh</code> uses <code>_scheduledRefreshFlag</code> to avoid duplicate scheduled work.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>6) Utilities — normalization & sanitization</strong>: <code>sanitizeText(s)</code> trims safely. <code>_normalize_heading_text(raw)</code> strips HTML tags and <code>&lt;br&gt;</code>, normalizes whitespace and returns trimmed text — used when creating IDs and labels. <code>escapeHtml(str)</code> used for safe caption HTML. <code>canonKey(s)</code> returns a lowercased, trimmed, normalized key used to canonicalize label keys for lookups. <code>joinUrl(base, rel)</code> attempts <code>new URL</code> then falls back to string concat.                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>7) ID management & collision strategy</strong>: <code>ensureId(el, prefix)</code> keeps existing <code>el.id</code> if present; otherwise constructs an id from the element text (normalized, slugified, truncated to 60 chars) prefixed by given prefix (default <code>ptt-</code>). If generated id collides with existing DOM id, appends <code>-1</code>, <code>-2</code>, ... until unique. It assigns <code>el.id</code> when possible and returns the id. This avoids collisions but can create new suffixed IDs across runs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>8) Link creation</strong>: <code>makeLink(id, text, extraClass)</code> builds an <code>&lt;li&gt;&lt;a&gt;</code> node with <code>href=&quot;#id&quot;</code>, <code>data-pt-target=id</code>, <code>role=&quot;link&quot;</code>, <code>aria-label</code> and provided className. <code>textContent</code> is used (no innerHTML insertion from user input).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>9) fetchJsonOnce behavior</strong>: Single-attempt fetch with optional AbortController timeout (default 2500ms). If <code>AbortController</code> available uses signal and explicit timeout to abort; otherwise uses <code>setTimeout</code> fallback. Resolves <code>null</code> on any non-OK response, parse error, timeout, or fetch failure. Debug logging points provided (<code>dbg</code>). Not retrying within this function — minimal and conservative.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>10) Labels normalization</strong>: <code>normalizeLabels(raw)</code> produces a flat object <code>out</code> where keys are <code>canonKey</code> variants. If a top-level value is an object it flattens subkeys as <code>canonKey(parent_subkey)</code>. Also preserves <code>canonKey(k)</code> to map nested or top-level names. Returns empty object for invalid input. This creates predictable keys for lookup.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>11) Global label coordination</strong>: The module uses <code>window.__ptt_labels_injected</code> as the authoritative global cache (if present). <code>PTToc._labels</code> mirrors that. <code>PTToc.getLabels()</code> returns a defensive copy of <code>_labels</code> or the global. <code>PTToc.applyLabelsNow(labelsObj)</code> normalizes and sets <code>PTToc._labels</code>, sets the global, and calls <code>PTToc.build()</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>12) reloadLabels — sequential candidate loader</strong>: <code>PTToc.reloadLabels(opts)</code> is a prioritized-sequence loader over <code>labelsPaths</code> (optionally expanded relative to <code>window.__tv_base</code>). Behavior details: builds candidate list, ensures uniqueness, supports <code>force</code> (adds cache-bust <code>?t=</code>), and returns a promise that resolves to normalized labels or existing labels. If <code>window.__ptt_labels_reload_promise</code> exists it returns that existing promise to avoid duplicate concurrent requests.                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>13) reloadLabels — background refresh optimization</strong>: If a global <code>window.__ptt_labels_injected</code> already exists and <code>force</code> is false, <code>reloadLabels</code> returns that immediately and schedules a background refresh that tries each candidate with cache-bust until one returns valid JSON — then updates <code>PTToc._labels</code>/global and calls <code>PTToc.build()</code>. This is designed to avoid blocking init while still warming cache.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>14) reloadLabels — sequential attempt flow</strong>: If no existing global or <code>force</code> true, it attempts candidates sequentially using <code>fetchJsonOnce</code>. On first valid JSON object it normalizes, sets <code>PTToc._labels</code> and <code>window.__ptt_labels_injected</code>, calls <code>PTToc.build()</code> and resolves. On failure of all candidates sets <code>_labels</code> to <code>{}</code> and resolves. Uses <code>_reloadPromise</code> and <code>window.__ptt_labels_reload_promise</code> to coordinate state.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>15) applyLabelsNow (explicit apply)</strong>: Lightweight helper that accepts a raw labels object, normalizes, writes to <code>_labels</code> and <code>window.__ptt_labels_injected</code>, then triggers <code>PTToc.build()</code>. Useful for programmatic injection without network fetch.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>16) fetchLabels (fallback loader)</strong>: Simpler promise-based loader that cycles through a provided <code>paths</code> array, trying each <code>fetch(path)</code> and returning the first parsed JSON object or <code>{}</code> if none succeed. This is used when <code>reloadLabels</code> isn't available. Differences vs <code>reloadLabels</code>: <code>fetchLabels</code> will attempt without normalization/sequence promise handling specifics; limited error handling.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>17) scheduleTocRefresh behavior</strong>: Public method that schedules two reload attempts (firstDelay default 150ms, secondDelay default 900ms) and sets <code>_scheduledRefreshFlag</code> to avoid duplicates. On each scheduled run it calls <code>PTToc.reloadLabels({ candidates, force: true })</code> if available; otherwise falls back to <code>doFallbackFetch</code> which calls <code>fetchLabels</code>. It merges cache-busted candidate URLs and non-busted ones (tries both). After the second attempt it clears <code>_scheduledRefreshFlag</code>. If <code>opts.autoSelect</code> true, sets <code>_pendingAutoSelect</code> to trigger <code>selectTable1()</code> after build.                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>18) Automatic select Table1 logic</strong>: <code>selectTable1()</code> attempts to find an anchor in the TOC whose <code>data-pt-target</code> or <code>href</code> matches <code>Table1</code>/<code>Table01</code> (case-insensitive). If not found, searches anchors whose visible text matches <code>Table 01</code> patterns <code>/^Table\s*0?1$/i</code> or prefixed <code>01.</code> or <code>Table 1:</code> patterns. If still not found, clicks the first TOC entry as a fallback. Throttled by <code>autoSelectThrottleMs</code> (default 1200 ms) using <code>_lastAutoSelectAt</code>. Focus/click operations are done defensively in try/catch.                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>19) Lightweight fetch/XHR interceptors</strong>: <code>installGroupLoadInterceptor()</code> wraps <code>window.fetch</code> and replaces <code>window.XMLHttpRequest</code> with a thin wrapper to listen for requests that indicate group-load (<code>/api/group/load</code>) or convert endpoints (<code>/api/convert</code> or <code>/convert</code>). On success or failure of those requests the wrappers call <code>PTToc.scheduleTocRefresh({ autoSelect: true })</code>. The fetch wrapper preserves calling the native fetch and returns its promise; the XHR wrapper returns a proxied XMLHttpRequest instance that delegates <code>open</code> and <code>send</code> but attaches <code>load</code>/<code>error</code> listeners. Wrapping is guarded by <code>_fetchWrapped</code> and <code>_xhrWrapped</code> to avoid double-wrapping.                                                                                                                                                                                                                                          </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>20) Build logic — single table vs headings</strong>: <code>buildOnce()</code> finds <code>tocList</code>/<code>tocBarList</code> and the <code>contentRoot</code>, enumerates tables (by <code>tableSelector</code>) under contentRoot. If exactly one table exists it calls <code>buildItemsFromSingleTable(table, labels, bookPrefix)</code> which enumerates data rows and creates <code>id</code> per row (<code>row-</code> prefix) and a label from labels or fallback to <code>rowLabelPrefix N</code>. If zero or multiple tables, it uses <code>buildItemsFromHeadings(labels, bookPrefix)</code> which enumerates heading elements matched by <code>headingSelector</code> and uses normalized heading text or label from labels.                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>21) Caption injection policy</strong>: When labels are available, <code>buildOnce()</code> attempts to inject captions via <code>injectCaptionForElement(anchorEl, bookPrefix, idx, cap)</code> only when a target anchor exists (table or heading). <code>injectCaptionForElement</code> constructs a <code>.table-caption</code> <code>&lt;div&gt;</code>, tries to set id <code>Table{idx}</code> (handling collisions by suffixing), sets <code>data-ptt-injected=&quot;1&quot;</code>, applies minimal inline margins, and inserts it before the anchor or as fallback into <code>document.body</code>. It intentionally avoids creating caption nodes unless a label is present and avoids overwriting non-caption elements. If an existing element has the intended id and class <code>table-caption</code>, it updates the innerHTML and sets <code>data-ptt-injected</code>.                                                                                                                                                                                         </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>22) TOC DOM update strategy</strong>: <code>buildOnce()</code> constructs two <code>DocumentFragment</code>s <code>fragList</code> and <code>fragBar</code>, clears existing children of <code>tocList</code>/<code>tocBarList</code> using <code>clearChildren</code>, then appends cloned <code>&lt;li&gt;&lt;a&gt;</code> nodes for each <code>items</code> entry into fragments and attaches fragments in one operation to the respective containers — minimizes reflows. After append it calls <code>highlightCurrentFromLocation()</code> and triggers <code>selectTable1()</code> if <code>_pendingAutoSelect</code> was set.                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>23) Highlighting current location & click handler</strong>: <code>highlightCurrentFromLocation()</code> reads <code>location.hash</code> and marks the corresponding TOC anchor(s) with <code>aria-current=&#x27;page&#x27;</code>. <code>onTocClick(ev)</code> is a delegated click handler that locates the closest <code>a[data-pt-target]</code>, prevents default, resolves the target element by id, computes scroll offset considering <code>PTToc.config.stickyHeaderId</code> height, scrolls smoothly (fallback to immediate), and replaces history with <code>#id</code>. It schedules <code>highlightCurrentFromLocation</code> shortly after.                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>24) Delegated handlers & mutation observer</strong>: <code>attachDelegatedHandlers()</code> attaches a document-level click listener for TOC clicks and another click listener to detect convert-trigger elements (<code>#convert, .convert-btn, [data-action=&quot;convert&quot;]</code>) that will schedule a TOC refresh. Also hooks <code>hashchange</code>. <code>observeMutations()</code> sets up a <code>MutationObserver</code> on <code>getContentRoot()</code> (childList + subtree) that calls <code>debounceBuild()</code> on changes to rebuild the TOC; observer is idempotently replaced if already present.                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>25) Debounce & rebuild schedule</strong>: <code>debounceBuild()</code> uses <code>_rebuildTimer</code> + <code>_debounceMs</code> (150ms) to batch rapid DOM mutations into a single <code>buildOnce()</code> call. <code>PTToc.build()</code> is a public alias that calls debounce (so callers do not need to worry about debouncing themselves).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>26) Error handling & logging strategy</strong>: Code wraps almost every operation in <code>try/catch</code> and uses <code>dbg()</code> and <code>warn()</code> helpers to <code>console.debug</code>/<code>console.warn</code> only when <code>window.tvDebug</code> is truthy. Many catch blocks are silent — favors stability over noisy failures but reduces visibility into errors. Several <code>dbg</code> calls annotate lifecycle steps (fetch attempts, wrapper installs, build events).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>27) Security considerations</strong>: The module reads server-rendered DOM and remote JSON; when injecting caption HTML it escapes label text with <code>escapeHtml()</code>. However, <code>div.innerHTML = &#x27;&lt;strong&gt;&#x27; + escapeHtml(caption) + &#x27;&lt;/strong&gt;&#x27;</code> is used — safe for caption text but <code>buildOnce()</code> uses <code>textContent</code> in most places. Exports or other code that uses <code>table.outerHTML</code> elsewhere could carry unsafe markup, but this file is conservative. Fetch loaders use <code>credentials: &#x27;same-origin&#x27;</code> for <code>fetchJsonOnce</code> and <code>fetch</code> calls.                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>28) Performance characteristics</strong>: Normal operation is lightweight: DOM queries limited to <code>contentRoot.querySelectorAll(tableSelector)</code> and <code>document.querySelectorAll(headingSelector)</code> for headings, plus building small fragments. The heaviest parts are sequential network attempts in <code>reloadLabels</code> (but those run with short timeouts and background warm refresh). MutationObserver on a large subtree can trigger frequent rebuilds — mitigated by debounce 150ms but still could be heavy if many mutations occur. Fetch/XHR wrappers add negligible overhead since they forward promises/events.                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>29) Edge cases and subtle behaviors</strong>: • If <code>document.getElementById(expectedId)</code> exists but is not a <code>.table-caption</code>, <code>injectCaptionForElement</code> will create suffixed id — good but may leave unrelated node with <code>Table1</code> id. • <code>ensureId</code> uses textContent/innerText; headings with markup result in slugified text which may lose semantic content. • <code>buildItemsFromSingleTable</code> assigns <code>row-</code> ids to rows (via ensureId) which remain after subsequent rebuilds — repeated runs can produce consistent ids but if row content changes ID text may change. • <code>selectTable1</code> relies on TOC anchors being present — if TOC is empty but anchors exist elsewhere the heuristics may misfire.                                                                                                                                                                                                                                          </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>30) Integration touchpoints</strong>: The module expects or cooperates with globals: <code>window.__tv_base</code> (base path for labels), <code>window.__ptt_labels_injected</code>, <code>window.__ptt_labels_reload_promise</code>, <code>window.tvDebug</code> (debug logging), <code>PTToc.build()</code> being callable externally, and potential other paste-to-table modules that set <code>window.__tv_last_source</code> etc. It schedules rebuilds in response to network flows from group-load/convert endpoints by wrapping fetch/XHR.                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>31) Test cases to add / verify</strong>: • reloadLabels success/failure sequencing, and global promise deduping. • Background warm path when <code>window.__ptt_labels_injected</code> exists (ensure background refresh replaces labels when newer file available). • injectCaptionForElement id-collision handling (existing non-caption node with <code>Table1</code>). • ensureId uniqueness when many identical headings present. • MutationObserver rebuild debounce under heavy mutation load. • Click handling for sticky header offset correctness. • fetch/XHR wrapper not interfering with non-related fetches.                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>32) Known limitations & risks</strong>: • Silent catches hamper observability—bugs can be hidden. • If labels JSON is large or malformed, normalization may produce unintended keys. • Use of <code>innerHTML</code> for caption insertion is safe for escaped strings but still writes HTML; if external labels include HTML intentionally, it will be escaped so OK. • <code>window.XMLHttpRequest</code> replacement could conflict with other code that relies on <code>instanceof</code> checks or original constructor semantics (the wrapper sets <code>WrappedXHR.prototype = NativeXHR.prototype</code> but assigns <code>window.XMLHttpRequest = WrappedXHR</code>, which may break detection that uses <code>XMLHttpRequest.prototype</code> references). • Replacing <code>window.fetch</code> similarly could interfere with code relying on function identity (rare but possible).                                                                                                                             </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>33) Suggested concrete improvements (prioritized):</strong><br>1) Replace silent <code>catch {}</code> blocks with <code>if (window.tvDebug) console.warn(...)</code> or an optional <code>PTToc.DEBUG</code> flag so debugging failures become visible.<br>2) Add a <code>dispose()</code> method to disconnect the <code>MutationObserver</code>, remove delegated handlers, and optionally unwrap fetch/XHR (or at least record that wrapping occurred).<br>3) Use <code>Element.insertAdjacentElement(&#x27;beforebegin&#x27;, div)</code> consistently and prefer semantic <code>&lt;figure&gt;/&lt;figcaption&gt;</code> or <code>&lt;caption&gt;</code> when suitable while maintaining the caption-safe rules.<br>4) Add a micro-throttle/guard to prevent excessive rebuilds when <code>contentRoot</code> mutations occur rapidly (e.g., ignore rebuilds triggered within X ms of the previous successful one).<br>5) Allow <code>labelsPaths</code> configuration via <code>PTToc.init({ labelsPaths: [...] })</code> as already supported, and document <code>window.__tv_base</code> precedence explicitly. </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>34) Compatibility & browser support</strong>: Uses widely available APIs: <code>fetch</code>, <code>AbortController</code> (feature-detected), <code>MutationObserver</code>, <code>history.replaceState</code>. Contains fallbacks where not available (e.g., fetch without AbortController). Avoids ES2020 features; code is compatible with evergreen browsers. However, the <code>new URL</code> usage in <code>joinUrl</code> is wrapped in try/catch so older environments fall back.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>35) Accessibility considerations</strong>: TOC links get <code>role=&quot;link&quot;</code> and <code>aria-label</code>. <code>highlightCurrentFromLocation</code> sets <code>aria-current=&quot;page&quot;</code>. <code>injectCaptionForElement</code> sets <code>data-ptt-injected</code> but not ARIA attributes; consider adding <code>aria-labelledby</code> or linking TOC items via <code>aria-controls</code>. Scrolling uses <code>behavior: &#x27;smooth&#x27;</code> which can be disruptive for some users (no <code>prefers-reduced-motion</code> consideration).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>36) Observability & diagnostics to add</strong>: Expose <code>PTToc._diagnostics()</code> returning counts: number of tables found, number of headings, number and timestamp of last build, current <code>_labels</code> keys count, <code>_scheduledRefreshFlag</code> state, and whether fetch/XHR wrappers are installed. Also record last successful labels source URL for easier troubleshooting.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>37) Security checklist before deployment</strong>: Ensure labels JSON is served from trusted origin (the code defaults to same-origin <code>credentials: &#x27;same-origin&#x27;</code>). Ensure <code>window.__tv_base</code> is not user-controlled in an unsafe way. When injecting captions, the module escapes label text; maintain that escape. Avoid enabling any path that would insert raw HTML from external sources.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>38) Performance profiling guidance</strong>: Measure time in <code>buildOnce()</code> for DOM queries and fragment assembly (use <code>performance.now()</code> around table/heading enumeration). Profile MutationObserver-triggered rebuild frequency on representative pages. Monitor label reload latencies and number of attempted fetches per schedule.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>39) Long-term architecture suggestions:</strong><br>(A) <strong>labels-loader</strong> — isolate network fetch, normalization, caching.<br>(B) <strong>toc-builder</strong> — DOM-only build and caption injection.<br>(C) <strong>integration</strong> — fetch/XHR wrappers and event wiring.<br>This separation improves unit testing and prevents coupling network heuristics with DOM logic.<br>Provide a programmatic API <code>PTToc.refreshNow()</code> that returns a Promise for deterministic integration. </td></tr><tr><td data-label="script.toc.js — Exhaustive Technical Breakdown (single-column)"> <strong>40) Final checklist before editing or refactor:</strong><br>(1) Preserve public API and global flags (<code>PTToc</code>, <code>window.__ptt_labels_injected</code>, <code>window.__ptt_labels_reload_promise</code>).<br>(2) Add tests for <code>reloadLabels</code> (force vs background) and fetch/XHR wrappers.<br>(3) Add a <code>DEBUG</code> toggle or optional logger instead of silent catches.<br>(4) Add <code>dispose()</code> for clean teardown.<br>(5) Document <code>labelsPaths</code> precedence and <code>window.__tv_base</code> expansion.<br>(6) Avoid unwrapping fetch/XHR in other modules — coordinate wrapper ownership to prevent conflicts. </td></tr></tbody></table></div><div class="row-count">Rows: 40</div></div><div class="table-caption" id="Table5" data-table="Docu_0125_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5 • script.save.js</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Details**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Details</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Details"> <code>assets/script.save.js</code> provides client-side functionality for saving Markdown content via a POST request to <code>/save-md</code>. It handles the user interface (UI) elements for saving, such as filename prompts and status updates, along with necessary checks (e.g., file size limits). The script integrates with other parts of the page via events to handle Markdown content save actions. It includes features like network error handling, content validation, and status feedback, ensuring a smooth user experience.                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Details"> <strong>High-level guarantees & design principles</strong>: • <strong>User-friendly error handling</strong>: Displays status messages for success/failure with appropriate roles for accessibility. <br>• <strong>File size validation</strong>: Checks the size of the content before attempting to save. <br>• <strong>Filename handling</strong>: Ensures proper filename extension and sanitizes user input for the filename. <br>• <strong>Event-driven</strong>: Uses custom events (<code>EVENT_REQUEST_MD</code>, <code>EVENT_RESPONSE_MD</code>) to trigger and handle the save process. <br>• <strong>Graceful degradation</strong>: If the fetch API or the request fails, fallback options (like direct prompt for user input) ensure continued functionality. <br>• <strong>Extensibility</strong>: The script exposes public methods (like <code>PTT_SAVE.save</code>) for other scripts to programmatically trigger save actions.                                                                                                                                                              </td></tr><tr><td data-label="Details"> <strong>Top-level structure & exports</strong>: • <strong>Public API</strong>: <code>PTT_SAVE.save</code> provides a method for external scripts to save Markdown content. <br>• <strong>Save flow</strong>: Manages the logic for reading, validating, and posting Markdown content. <br>• <strong>Events</strong>: Emits <code>EVENT_REQUEST_MD</code> for custom integrations to request a save, and <code>EVENT_RESPONSE_MD</code> for responding with save results. <br>• <strong>UI elements</strong>: Manages status feedback via <code>STATUS_ID</code> and handles user interactions like filename prompts and save button clicks. <br>• <strong>Error handling</strong>: Provides a robust mechanism for network and client errors, ensuring graceful failure modes.                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Details"> <strong>Key components & responsibilities (concise)</strong>: 1. <strong>Save Button Handler</strong> — Listens for clicks on the save button (<code>SAVE_BTN_ID</code>), preventing default behavior, and dispatches a custom event to trigger the save. <br>2. <strong>Filename Prompt</strong> — Prompts the user to provide a filename for the saved Markdown file, ensuring a valid file name and <code>.md</code> extension. <br>3. <strong>Size Validation</strong> — Checks the size of the content before attempting to save, and rejects files that exceed the client-defined maximum size (<code>getClientMaxSize</code>). <br>4. <strong>POST Request</strong> — Sends the Markdown content as JSON to the backend via a POST request to <code>/save-md</code> using the <code>postSaveMarkdown</code> function. <br>5. <strong>Error Handling</strong> — Handles errors gracefully, displaying status updates and triggering appropriate response events in case of failures (e.g., network issues, invalid server response).                                                                             </td></tr><tr><td data-label="Details"> <strong>Detailed behavior & important implementation notes</strong>: <strong>Save Flow</strong>: The script reads content from a designated element (<code>PASTE_ID</code> or <code>FALLBACK_AREA_ID</code>), validates the content, checks the file size, prompts the user for a filename (if not already provided), and then sends the data via a <code>POST</code> request to <code>/save-md</code>. If the save operation is successful, a message is displayed, and a download link may be provided. In case of errors, appropriate feedback is given. <br> <strong>POST Request</strong>: The request is made with a JSON payload containing the Markdown content and the filename. The server's response is processed to check for success or failure. <br> <strong>UI Feedback</strong>: The script updates a status element (<code>STATUS_ID</code>) to show the user the current state of the save operation, including any errors. <br> <strong>Filename Handling</strong>: The filename is ensured to have a <code>.md</code> extension, and input is sanitized to avoid issues with special characters. </td></tr><tr><td data-label="Details"> <strong>Error handling, robustness & failure modes</strong>: • <strong>Network errors</strong>: Handled by <code>catch</code> blocks in the <code>postSaveMarkdown</code> function, which ensures users are notified of any issues while saving. <br>• <strong>Invalid server response</strong>: If the server returns a non-JSON response, an error is thrown. <br>• <strong>Size limits</strong>: The content is checked against a client-side maximum size (<code>DEFAULT_MAX_PASTE_SIZE</code> or <code>getClientMaxSize</code>). If the content exceeds the limit, the save is rejected. <br>• <strong>Filename validation</strong>: Ensures the filename input is valid, sanitized, and includes the <code>.md</code> extension. <br>• <strong>Event dispatching</strong>: If an error occurs at any point in the save process, custom error events (<code>EVENT_RESPONSE_MD</code>) are dispatched to ensure other scripts can react to failures.                                                                                                                                                                          </td></tr><tr><td data-label="Details"> <strong>Concurrency / performance considerations</strong>: • <strong>POST request</strong>: The <code>POST</code> request to <code>/save-md</code> is asynchronous, and the UI remains responsive during the save process. <br>• <strong>Size checks</strong>: The size of the Markdown content is checked before making the network request, avoiding unnecessary network traffic for large files. <br>• <strong>Debounced save</strong>: The event-based save triggers allow for decoupling the save process from UI actions, minimizing unnecessary requests. <br>• <strong>Network retries</strong>: The script does not retry failed network requests, but it ensures users are informed of any failures, with fallback mechanisms where possible.                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Details"> <strong>Edge cases & brittle areas</strong>: 1. <strong>No Markdown content</strong>: If no Markdown is found in the target element, the save is prevented, and an error message is displayed. <br>2. <strong>File size too large</strong>: Content exceeding the maximum size (<code>DEFAULT_MAX_PASTE_SIZE</code> or <code>getClientMaxSize</code>) is rejected, and the user is notified. <br>3. <strong>Invalid server response</strong>: If the server returns a response that cannot be parsed as JSON, the save fails. <br>4. <strong>Filename conflicts</strong>: If a user-provided filename contains illegal characters or exceeds the allowed length, it is sanitized and truncated to meet the constraints.                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Details"> <strong>Integration points & extension hooks</strong>: • <strong>Custom save triggers</strong>: Exposes <code>EVENT_REQUEST_MD</code> for other scripts to trigger a save request. <br>• <strong>Response handling</strong>: <code>EVENT_RESPONSE_MD</code> can be used by other scripts to react to the save result. <br>• <strong>Custom filename handling</strong>: Allows external code to influence the filename prompt behavior. <br>• <strong>Configurable limits</strong>: External code can modify the client-side maximum paste size through <code>window.PTT_CONFIG.MAX_PASTE_SIZE</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Details"> <strong>Recommendations & maintainability notes</strong>: • <strong>Error visibility</strong>: Improve error visibility by logging server responses more thoroughly for debugging. <br>• <strong>Size validation</strong>: Consider adding a visual indication of file size before submission to inform users when content exceeds the client limit. <br>• <strong>Filename customization</strong>: Add a callback to customize the filename prompt behavior (e.g., to fetch the filename dynamically based on user input or document metadata). <br>• <strong>Event logging</strong>: Add debug logs or verbose mode to help with diagnostics during development. <br>• <strong>Unit tests</strong>: Test the filename sanitization and content size validation separately to avoid issues with edge cases.                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Details"> <strong>Short checklist of behaviors to verify when integrating</strong>: • Save process should be initiated when the save button is clicked, and should trigger the appropriate events. <br>• The filename should be sanitized, and the <code>.md</code> extension should be appended if missing. <br>• Content size must be validated before the save request is made. <br>• The server response should be handled correctly, with status updates and any available download links. <br>• In case of errors (e.g., network, invalid response), appropriate messages should be shown to the user.                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Details"> <strong>Conclusion</strong>: <code>assets/script.save.js</code> provides a streamlined client-side mechanism for saving Markdown content. It integrates error handling, file size validation, and filename sanitization with a user-friendly interface and feedback system. Through custom events and configurable parameters, it is extensible and can be integrated into various environments. Key areas for improvement include enhanced error visibility, customizable filename handling, and additional user feedback for content size limitations. The file is well-suited for further enhancements, including support for more complex file-saving workflows.                                                                                                                                                                                                                                                                                                                                      </td></tr></tbody></table></div><div class="row-count">Rows: 12</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>