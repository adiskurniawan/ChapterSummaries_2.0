<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1763746404">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0125_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1 • script.core.js</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical breakdown (script.core.js)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical breakdown (script.core.js)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Overview & intent</strong><br>Central client-side core for PasteToTable. Responsibilities: bootstrapping runtime configuration, locating auxiliary assets (index/worker/extra scripts), providing safe utility primitives (debounce, clipboard, download, toasts), wiring UI actions (convert/clear/save/export), performing the conversion request to <code>/api/render</code> (<code>__tv_do_convert</code>), routing/rendering server HTML into the viewer (<code>processRenderedHtml</code>), applying injected captions and TOC initialization when appropriate, and coordinating scroll behavior. The file emphasizes defensive programming, feature-detection, non-breaking fallbacks, and progressive enhancement for environments lacking modern APIs. Designed to integrate with optional global collaborators (<code>window.PasteToTable</code>, <code>window.PTToc</code>, external <code>script.toc.js</code>, <code>labels_injected.json</code>). </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>High-level architecture & modules</strong><br>1. Config & bootstrap — <code>defaultConfig</code>, <code>window.tvConfig</code>, <code>detectScriptBase</code>, <code>ensureIndexAndWorkerAttrs</code>, <code>startExtraLoader</code>.<br>2. Scroll coordination shim — <code>PTTScroll</code>.<br>3. Loader utilities — sequential loaders, TOC loader, label loader.<br>4. Utility primitives — debounce, normalize, clipboard, filename sanitization, download helpers.<br>5. Toast system — queued lightweight notifications.<br>6. Caption & TOC orchestration — install/inject helpers.<br>7. Conversion pipeline — <code>__tv_do_convert</code>, <code>processRenderedHtml</code>.<br>8. Event wiring — action dispatcher, header wiring. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Global contracts & exposed API</strong><br><code>window.tvConfig</code>, <code>window.tvIndexUrl</code>, <code>window.tvWorkerUrl</code>, <code>window.__tv_base</code>, <code>window.tvUtils</code>, <code>window.__tv_utils</code>, <code>window.__ptt_apply_injected_captions</code>, <code>window.__ptt_labels_injected</code>, <code>window.__ptt_toc_and_labels_installed</code>, <code>window.PasteToTable.processRenderedHtml</code>, <code>window.__tv_do_convert</code>, <code>window.convertButtonHandler</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>detectScriptBase()</strong><br>Purpose: determine script base URL. Uses <code>document.currentScript</code>, scans <code>&lt;script&gt;</code> tags, or falls back to <code>location.origin + path</code>. Returns <code>&#x27;/&#x27;</code> on failure. Handles missing <code>currentScript</code>, relative paths, malformed DOM. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>ensureIndexAndWorkerAttrs(base)</strong><br>Purpose: ensure <code>&lt;body&gt;</code> has <code>data-index-url</code> and <code>data-worker-url</code>. Computes defaults from base. Writes DOM attrs and assigns globals. Swallows CSP failures. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>PTTScroll (IIFE)</strong><br>Purpose: neutral scroll coordinator. Methods: <code>enable</code>, <code>disable</code>, <code>isEnabled</code>, <code>initObserver</code>, <code>scrollToTop</code> (noop). MutationObserver emits <code>ptt:renderStable</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>createScriptElement(src, opts)</strong><br>Creates a <code>&lt;script&gt;</code> with optional flags. Returns element for caller to append. Empty <code>src</code> tolerated. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>loadExtraSequentially(possiblePaths, onDone, onAllFailed)</strong><br>Sequential script loader. Appends candidate; on error removes and tries next. Reduces race conditions. Worst-case latency O(N). </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>startExtraLoader()</strong><br>Guards against duplicates, checks for existing extras, invokes sequential loader, logs success/failure. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>joinUrl(base, rel)</strong> — Robust absolute-URL builder using <code>new URL(rel, base).href</code> with string-concat fallback on failure; handles malformed inputs via fallback. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>normalizeForSearchLocal(s)</strong> — Unicode-aware normalizer. Tries <code>Shared.normalizeForSearchLocal</code>; default lowercases, NFD-decomposes, strips combining marks, removes non-letter/number/space with <code>\p{}</code> regex, collapses whitespace; safe fallback when Unicode regex unsupported. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>debounce(fn, wait)</strong> — Debounces a function using timer; prefers <code>Shared.debounce</code>; preserves <code>this</code> via <code>apply</code>; <code>wait</code> defaults to <code>tvConfig.debounceMs</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>copyToClipboard(text) / tryLegacyCopy(t)</strong> — Clipboard copy using <code>navigator.clipboard.writeText</code>; falls back to hidden <code>&lt;textarea&gt;</code> + <code>execCommand(&#x27;copy&#x27;)</code>; Promise-based; handles CSP/UA failures. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>sanitizeFileName(name)</strong> — Produces safe filename: replaces invalid chars, compresses spaces, trims to ≤200 chars; returns <code>&#x27;download&#x27;</code> if empty; <code>Shared.sanitizeFileName</code> override supported. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>downloadBlob(blob, filename)</strong> — Client-side download using <code>URL.createObjectURL</code> + anchor click; revokes URL after 150 ms; returns success boolean; supports <code>Shared.downloadBlob</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Toast system</strong> — <code>_ensureToastContainer</code>, <code>_computeToastDuration</code>, <code>showToast</code>, <code>showToastOnce</code>, <code>_processToastQueue</code>, <code>_hideActiveToast</code>, <code>_dismissToastById</code>.<br>Creates ARIA-aware toast container; queue-based display; auto-dismiss; duplicate-prevention; DOM creation, animation, cleanup; inline style usage; relies on CSS vars for colors. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>getSearchEl()</strong> — Returns search input element by checking ids: <code>searchBox</code>, <code>searchInput</code>, <code>search</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>tvUtils / __tv_utils export block</strong> — Exposes utilities globally (<code>copyToClipboard</code>, <code>debounce</code>, <code>sanitizeFileName</code>, <code>downloadBlob</code>, <code>getSearchEl</code>, <code>formatCellForMarkdown</code>, <code>tableToMarkdownLines</code>, <code>normalizeForSearchLocal</code>); respects existing definitions and <code>Shared</code> hooks. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>ID & escape helpers</strong> — <code>_normalizeKey</code>, <code>buildPrefixCandidatesFromLabels</code>, <code>sanitizeForId</code>, <code>ensureId</code>, <code>escapeHtml</code>.<br><code>ensureId</code> builds deterministic unique IDs from label text; <code>escapeHtml</code> escapes <code>&amp;&lt;&gt;\&quot;&#x27;</code> for safe caption/content usage. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>fetchJsonWithTimeout(url, timeoutMs)</strong> — Fetch JSON with timeout; uses AbortController or manual timeout; always resolves <code>null</code> on error; no-store, same-origin. Defensive but could return richer diagnostics. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>tryLoadLabels(candidates)</strong> — Sequentially tests label URLs using <code>fetchJsonWithTimeout</code>; returns first non-empty object or <code>{}</code>; fully error-tolerant; O(N) latency. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>installTocScript(candidates)</strong> — Tries to load <code>script.toc.js</code> candidates in order; resolves <code>true</code> on first success else <code>false</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>captionFor(labelsObj, bookPrefix, idx)</strong> — Resolves caption text through multiple permutations: flat keys, nested objects, underscore/dash variants, padded/unpadded indices; returns string or <code>null</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>inferBookPrefix()</strong> — Picks prefix from <code>data-file</code>/<code>data-source</code>, or URL filename, or sanitized document title. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>injectCaptionForElement(anchorEl, bookPrefix, idx, captionText)</strong> — Inserts or updates a <code>&lt;div.table-caption&gt;</code> before a table/anchor; ensures unique <code>Table{n}</code> ID; reuses existing caption when present; uses inline styles; primarily uses <code>innerHTML</code> with escaped input. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>installTocAndLabels()</strong> — One-time installer for TOC script and labels; guarded by global flag; loads TOC, then labels; stores <code>window.__ptt_labels_injected</code> and installation status. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>__ptt_apply_injected_captions()</strong> — Scans all tables; builds candidate prefix list; finds caption by trying permutations; enforces unique IDs; reuses or injects caption nodes; reports whether any caption was inserted or updated. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>processRenderedHtml(responseData)</strong> — Main renderer and post-processor:<br>1. Normalizes HTML string.<br>2. Parses metadata (e.g., <code>fromList</code>).<br>3. Sets skip-scroll flag.<br>4. Routes HTML via <code>PasteToTable.routeHtmlToAreas</code> with fallback to innerHTML injection.<br>5. Calls <code>PasteToTable.initRenderedContent()</code> twice (timing guard).<br>6. If <code>fromList</code>: ensures TOC/labels installed; applies captions; initializes TOC (<code>__tv_init_pttoc_from_core</code> or <code>PTToc.build</code>).<br>7. Attempts TOC init unconditionally.<br>8. Performs multiple scroll-to-top attempts with fail-safe clearing of skip flag.<br>Returns <code>true</code>/<code>false</code> based on handled success. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>__tv_do_convert(opts)</strong> — Primary conversion pipeline. Posts pasted text to <code>/api/render</code>, receives HTML/JSON, delegates to <code>processRenderedHtml</code>, manages UI state, and performs auto-selection of Table 1. Key steps: guard reentrancy; extract/validate text; dual-mode fetch (JSON then form fallback); handle non-OK responses; normalize payload (JSON or wrapped HTML); delegate to <code>window.PasteToTable.processRenderedHtml</code> if present; sanitize <code>fromList</code>; inject HTML on fallback path; toast status; deferred multi-strategy TOC auto-select; final cleanup of flags. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>convertButtonHandler(ev)</strong> — UI wrapper calling <code>__tv_do_convert</code>. Checks concurrency flag, then awaits conversion. Exposed as <code>window.convertButtonHandler</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>convert click delegation (IIFE)</strong> — Global click capture to route clicks on <code>#convertBtn</code> or <code>[data-action=&quot;convert&quot;]</code> to conversion handler. Prevents duplicate handling via <code>ev.__tv_convert_handled</code>. Attaches direct click listener as fallback. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>attachActionDispatcher()</strong> — Universal <code>[data-action]</code> dispatcher. Single bubbling click listener finds the nearest <code>[data-action]</code> and dispatches to <code>window.__tv_action_handlers[action]</code>. Pre-registers <code>&#x27;convert&#x27;</code> if available. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>clearButtonHandler()</strong> — Clears <code>#paste</code>, <code>#tables-viewer</code>, <code>#page-area</code>, resets <code>#status</code>, and shows toast. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>saveHtmlHandler(ev)</strong> — Saves current rendered HTML. Detects visible area (<code>#page-area</code> or <code>#tables-viewer</code>), builds minimal HTML document, and attempts server-side save via <code>window.PasteToTable.save</code>. On failure, falls back to <code>downloadBlob</code>. Uses sanitized filename from <code>document.title</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>attachHeaderHandlersOnce()</strong> — Attaches header button handlers (<code>convert</code>, <code>clear</code>, <code>save</code>, <code>exportAllBtn</code>, <code>renderBtn</code>) once. Uses internal <code>_attached</code> and dataset flags for idempotence. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Action dispatcher & final wiring</strong> — Exports <code>showToast</code>, <code>downloadBlob</code>, <code>copyToClipboard</code>, <code>sanitizeFileName</code>. Wires <code>window.PasteToTable.processRenderedHtml</code>. Logs final environment info. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Defensive patterns</strong> — Extensive <code>try/catch</code>; idempotent event binding; robust fallback logic; global coordination flags (<code>__tv_convert_in_progress</code>, <code>__tv_skip_scroll</code>, etc.); tolerant fetch helpers returning <code>null</code>. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Compatibility & security choices</strong> — Uses <code>innerHTML</code> for injection (trusted server required); inline styles may conflict with CSP; fetch defaults keep same-origin cookies; avoids assuming modern APIs by feature detection. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Performance & scalability notes</strong><br>- Asset discovery (<code>loadExtraSequentially</code>, <code>tryLoadLabels</code>) is sequential — predictable but adds cumulative latency; acceptable for small candidate lists.<br>- Toast rendering & DOM ops are lightweight.<br>- Caption injection loops over all <code>table</code> nodes — O(T); for extremely large documents consider throttling or incremental insertion. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Bugs / risky assumptions / edge cases</strong><br>1. innerHTML vs textContent inconsistency — risk of double-escaping or missed sanitization.<br>2. ID collision detection limited — only global check, not table-scoped.<br>3. Sequential candidate probing latency — cumulative timeout cost.<br>4. TOC coupling assumptions — new TOC implementations may break auto-select.<br>5. Scroll coordination race — shared flag <code>__tv_skip_scroll</code> may conflict with other scripts.<br>6. Ambiguous <code>fromList</code> semantics — caller must set correctly.<br>7. Toast focus side-effect — may steal focus in SPAs. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Maintainability observations</strong><br>- Large file with many responsibilities; split into modules.<br>- Global variable proliferation; document global API contract.<br>- Inline style use and duplicated utility functions; factor into shared helpers. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Concrete recommended fixes / improvements</strong><br><strong>High priority</strong>: replace innerHTML caption insertion with DOM-safe construction; externalize styles; add cancellation hooks.<br><strong>Medium</strong>: improve discovery concurrency; structured error returns.<br><strong>Low</strong>: config entry-point for URLs; centralize utilities. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Suggested tests</strong><br><strong>Unit</strong>: unicode normalization, filename sanitization, HTML escaping, caption generation, timeout behavior.<br><strong>Integration</strong>: complex DOM caption injection, routing logic, convert flow with varying server responses.<br><strong>E2E</strong>: verify TOC behaviors, performance on large table counts. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Compatibility & integration checklist</strong><br>- Document global hooks (PasteToTable, PTToc).<br>- Ensure server <code>/api/render</code> is trusted or avoid innerHTML injection.<br>- Provide tvConfig pre-init override pattern; describe CSP considerations. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Potential regressions to watch</strong><br>- Caption ID naming changes break TOC.<br>- innerHTML → DOM refactor may affect whitespace/layout.<br>- Refactoring event wiring may double-bind handlers; preserve guards. </td></tr><tr><td data-label="Technical breakdown (script.core.js)"> <strong>Final concise verdict</strong><br>Strong defensive design with good fallbacks. Main issues: innerHTML reliance, inline styles, sequential probing, duplicated helpers. Implement recommended fixes for production readiness. </td></tr></tbody></table></div><div class="row-count">Rows: 46</div></div><div class="table-caption" id="Table2" data-table="Docu_0125_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2 • script.list.js</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical breakdown (script.list.js)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical breakdown (script.list.js)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Overview & intent</strong><br>Client-side module that discovers server-side saved table/index endpoints, normalizes file metadata, builds logical groups, presents a searchable/expandable modal UI for selecting groups or individual files, fetches chosen files (parallel fetch with ordered assembly), exposes runtime captions safely, invokes the renderer/convert pipeline, applies captions into the rendered DOM, and provides robust copy-from-paste behavior. Emphasis on defensive coding, timeouts, graceful fallbacks, and preserving legacy public APIs and function names for backward compatibility.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Top-level configuration & flags</strong><br>- <code>LIST_BTN_ID</code>, <code>PASTE_ID</code>, <code>STATUS_ID</code> — DOM IDs used throughout.<br>- <code>LIVE_FILES_ENDPOINTS</code>, <code>GROUPS_JSON_CANDIDATES</code>, <code>LABELS_JSON_CANDIDATES</code> — ordered probe lists for discovery with fallback candidates.<br>- Timeouts & limits: <code>FILE_FETCH_TIMEOUT_MS</code> (12000), <code>INDEX_FETCH_TIMEOUT_MS</code> (8000), <code>GROUPS_FETCH_TIMEOUT_MS</code> (4000), <code>LABELS_FETCH_TIMEOUT_MS</code> (3000), <code>MAX_LIST_ITEMS</code> (5000).<br>- Feature flags: <code>ENABLE_CACHE_BUSTER</code>, <code>ENABLE_INVERTED_INDEX</code>, <code>ENABLE_WORKER_SCORING</code>, <code>WORKER_THRESHOLD</code>, <code>WORKER_TIMEOUT_MS</code>, <code>MAX_CANDIDATES_FROM_INDEX</code>. Many flags present for tunability; some (worker scoring) are not fully wired.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>High-level architecture</strong><br>1. <strong>Fetch layer</strong> — <code>fetchWithTimeout</code> (generic) and <code>fetchFileWithTimeout</code> (per-file) wrap <code>fetch</code> with AbortController/timeouts and return normalized shapes (resolve-with-object for index fetch; reject on failure for <code>fetchFileWithTimeout</code>).<br>2. <strong>Index & normalization</strong> — <code>normalizeIndexData</code>, <code>tryParseListBodyAsArray</code>, <code>encodedSavedUrlFor</code>, helpers for BOM stripping and safe string ops.<br>3. <strong>Labels & groups</strong> — <code>loadLabels</code>, <code>buildLabelIndex</code>, <code>resolveCaptionFor</code> for caption resolution; <code>loadGroupDescriptions</code> parses <code>groups.json</code> candidates.<br>4. <strong>Group building & keys</strong> — <code>groupKeyFromPath</code>, <code>safeGroupName</code>, <code>buildGroupsFromLive</code> create grouped structures consumed by UI.<br>5. <strong>Search engine</strong> — <code>createFileSearchEngine</code> builds a lightweight inverted index, trigrams, token lists, and exposes <code>candidatesForQuery</code> and <code>scoreFiles</code> for ranking (with internal tokenize, trigrams, cheapDL edit-distance helper).<br>6. <strong>UI modal</strong> — <code>createModal</code> and <code>presentGroupsOnly</code> build a polished modal UI, search box, group rows, expand/collapse controls, and per-file load handlers.<br>7. <strong>Load & assemble</strong> — <code>loadFilesSequentialAndHideForm</code> (keeps name) performs parallel file fetches preserving order, assembles <code>combinedMarked</code> and <code>combinedRaw</code>, writes into paste area or page-area, invokes conversion, applies captions, and dispatches <code>ptt:groupLoaded</code> on microtask queue.<br>8. <strong>Copy and clipboard</strong> — encapsulated copy override to delegate to renderer (if available) or to fallback raw/markdown extraction via <code>findFirstMarkdownBlockInSource</code> and <code>copyTextToClipboard</code>.<br>9. <strong>Public hooks</strong> — <code>buildAndPresent</code>, <code>attachListHandler</code>, <code>attachPasteSync</code>, and small exported globals (<code>window.__ptt_copy_raw_from_paste</code>, <code>window.__ptt_set_force_raw_copy</code>) implement integration points.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Key functions — concise technical summary</strong><br><strong>dbg(...)</strong> — gated logging controlled by <code>DEBUG</code> flag; safe <code>console.log</code> usage.<br><strong>safeTrim, basenameFromPath, removeExtension</strong> — lightweight, defensive string utilities used by normalizers.<br><strong>encodedSavedUrlFor(relPath)</strong> — constructs <code>/saved/</code> encoded path unless <code>relPath</code> is absolute URL; returns <code>null</code> on error. Hardcoded base path may not match server routing in all deployments.<br><strong>stripBOM, updateStatus, showToastOrStatus, generateClientReqId</strong> — UI helpers and client trace id generator used across flows.<br><strong>fetchWithTimeout(url, timeoutMs)</strong> — robust wrapper: supports AbortController when available; appends cache-buster if enabled; returns promise resolving to <code>{ok,status,url,body,err}</code>. Important behavior: resolves rather than rejects, simplifying callers when probing endpoints.<br><strong>normalizeIndexData(raw)</strong> — accepts array-of-strings, array-of-objects, or <code>{files: [...]}</code> shape and produces canonical <code>{ name, url, path, description }</code> entries up to <code>MAX_LIST_ITEMS</code> with defensive guards.<br><strong>tryParseListBodyAsArray(txt)</strong> — attempts JSON parse with fallback to detect <code>{files:[]}</code> wrappers; returns <code>null</code> if not JSON.<br><strong>fetchLiveFilesSequential(endpoints)</strong> — sequentially probes candidate endpoints using <code>fetchWithTimeout</code>; accepts JSON arrays or line-oriented text lists; returns first valid normalized index — sequential probing increases worst-case latency.<br><strong>escapeHtml, canonKey, keyVariants, buildLabelIndex</strong> — label normalization and tolerant key generation to map many naming variants to captions; <code>buildLabelIndex</code> populates <code>__ptt_labels_cache</code> and <code>window.PTLabels</code> when available.<br><strong>loadLabels()</strong> — sequentially attempts <code>LABELS_JSON_CANDIDATES</code>, parses JSON, builds label index, caches result; falls back to empty map.<br><strong>resolveCaptionFor(baseName, labelIndex)</strong> — complex heuristic: many candidate normalizations (underscores, dashes, numeric suffixes) and fallback substring matching against labelIndex; returns first-match caption or empty string.<br><strong>loadGroupDescriptions()</strong> — similar candidate probing to <code>loadLabels</code>, parses groups.json formats (array <code>groups</code> or object) and returns a descriptive map.<br><strong>groupKeyFromPath(pathOrName) / safeGroupName(s)</strong> — heuristics to derive grouping key from path structure, underscores, or numeric suffixes; returns <code>&#x27;Ungrouped&#x27;</code> as default.<br><strong>buildGroupsFromLive(liveFiles, labelsIndex)</strong> — groups normalized files by <code>groupKeyFromPath</code>, resolves per-file captions via <code>resolveCaptionFor</code>, encodes saved URL via <code>encodedSavedUrlFor</code> when needed, and returns sorted group array (<code>Ungrouped</code> last).<br><strong>createFileSearchEngine(items, opts)</strong> — builds <code>lite</code> array (tokens, trigrams), an <code>inverted</code> postings map, a small LRU query cache, and exposes: <code>candidatesForQuery(q)</code> (postings intersection/union logic, MAX_POSTINGS), <code>scoreFiles(query, candidateIdxs)</code> (promised scoring using token matches, caption/name boosting, trigram overlap, cheapDL fuzzy distance), <code>dispose</code>. Internal helpers: <code>tokenize</code> (ASCII-only), <code>trigramsOf</code>, <code>cheapDL</code> (edit distance).<br><strong>createModal(contentEl, title)</strong> — constructs an accessible modal overlay with inline styles, moves existing search node into header when present, appends to document, and returns <code>{overlay,panel,close}</code> handle; ensures Escape key and overlay click close behavior.<br><strong>presentGroupsOnly(groups, descriptions)</strong> — builds persistent DOM: container, search input, expand/collapse controls, <code>FILE_ITEMS</code> flattening, creates <code>engine</code> (search), renders initial group rows, supports incremental search via debounced scoring, <code>renderGroupsFromFileResults</code> to assemble per-group ranked file lists, <code>createGroupRowForRender</code> to make interactive rows with per-file click handlers invoking <code>loadFilesSequentialAndHideForm</code>. Contains local highlight/token/trigram utilities (note duplication with engine).<br><strong>fetchFileWithTimeout(url, timeoutMs)</strong> — per-file fetch wrapper returning <code>Promise</code> that resolves to <code>res.text()</code> or rejects; uses AbortController when available; interface unchanged to preserve legacy callers.<br><strong>trySendActiveGroupMetadata(groupObj, client_req_id)</strong> — validates group and files, constructs payload with filenames, paths, captions, and posts to <code>/api/group/load</code> (non-blocking). Logs responses with <code>dbg</code> and <code>console.warn</code> on failures. <strong>Privacy note:</strong> sends per-file metadata by default.<br><strong>loadFilesSequentialAndHideForm(listOfFiles)</strong> — centerpiece file-load function (legacy name preserved): validates input, updates status, builds runtime captions array (dedupes default names), exposes <code>window.__ptt_runtime_captions</code> (deep-clone + <code>Object.freeze</code> where possible), prepares <code>fetchPromises</code> (parallel <code>fetchFileWithTimeout</code>), <code>Promise.all</code> to preserve order, assembles <code>accMarked</code> and <code>accRaw</code> (inserts safe caption markers and markdown headings when captions present via <code>sanitizeCaptionForInjection</code> and <code>safeMarkdownHeading</code>), writes to <code>PASTE_ID</code> element or <code>page-area</code>, sets <code>window.__tv_last_source</code>, calls renderer if available (<code>__tv_do_convert</code> preferred), fallback hidden textarea <code>__ptt_hidden_convert</code>, schedules caption-application loop (<code>applyRuntimeCaptions</code>) with polling up to <code>maxRetries</code>, then dispatches <code>ptt:groupLoaded</code> via <code>queueMicrotask</code> with <code>runtimeCaptions</code> and count. Handles many errors defensively.<br><strong>sanitizeCaptionForInjection, safeMarkdownHeading</strong> — caption sanitization removing comments/scripts/tags and escaping for safe insertion; markdown heading normalization.<br><strong>triggerConvertIfAvailable()</strong> — simple detection for renderer presence.<br><strong>buildAndPresent()</strong> — top-level orchestrator: updates status, concurrently resolves <code>fetchLiveFilesSequential</code>, <code>loadGroupDescriptions</code>, <code>loadLabels</code>, normalizes <code>liveFiles</code>, builds <code>groups</code>, updates status, calls <code>presentGroupsOnly</code> to show modal.<br><strong>attachListHandler()</strong> — binds click handler on <code>#listBtn</code> once; marks element with <code>__ptt_list_attached</code> to avoid duplicate binding. Uses DOMContentLoaded fallback.<br><strong>attachPasteSync()</strong> — keeps <code>window.__tv_last_source</code> and timestamp in sync with user edits to paste textarea.<br><strong>Copy/clipboard closure</strong> — installs a delegated <code>document</code> click handler for copy-markdown / copy-plain selectors; functions: <code>getRawPasteText</code>, <code>copyTextToClipboard</code> (Clipboard API preferred with <code>navigator.clipboard.writeText</code>, fallback to <code>execCommand</code>), <code>ensureTvTableIndex</code>, <code>findFirstMarkdownBlockInSource</code>, and UI toast helpers. Exposes <code>window.__ptt_copy_raw_from_paste</code> and <code>window.__ptt_set_force_raw_copy</code>. Delegates to <code>window.copyTableMarkdown</code> / <code>window.copyTablePlain</code> (renderer) when available unless forced raw copy is set. </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Defensive patterns & helpful fallbacks</strong><br>- Frequent <code>try/catch</code> blocks around almost every operation to avoid throwing and breaking UI.<br>- Feature-detection for <code>AbortController</code>, <code>TextDecoder</code>, <code>navigator.clipboard</code>, and renderer functions (<code>__tv_do_convert</code>, <code>convert</code>).<br>- Fetch utilities return normalized shapes or controlled rejection to simplify consumer code.<br>- Limits & timeouts everywhere (per-fetch, per-endpoint, caption-apply retry limits) to avoid indefinite stalls.<br>- Deep-copy + <code>Object.freeze</code> for <code>__ptt_runtime_captions</code> to avoid accidental mutation by other scripts.<br>- Uses <code>queueMicrotask</code> to dispatch <code>ptt:groupLoaded</code> to improve delivery reliability across sync/async renderer implementations.<br>- Fallbacks for renderer absence (hidden textarea) and copy fallback (execCommand).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Notable behaviors & compatibility choices</strong><br>- Preserves legacy names and public signals (<code>loadFilesSequentialAndHideForm</code>, <code>attachListHandler</code>, <code>__tv_last_source</code>) for backward compatibility.<br>- Keeps <code>encodedSavedUrlFor()</code> synthesizing <code>/saved/</code> paths — convenient but coupling to server routing.<br>- <code>fetchLiveFilesSequential</code> probes sequentially (first-to-last) to preserve candidate priority; increases latency when valid endpoint is late in list.<br>- <code>trySendActiveGroupMetadata</code> posts file-level metadata by default to <code>/api/group/load</code> — may be undesired for privacy-sensitive deployments.<br>- Modal uses inline styles heavily for portability — may conflict with strict CSPs that disallow inline styles. <code>createModal</code> attempts to read CSS custom properties but still writes many inline rules.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Performance & scalability notes</strong><br>- Parallel per-file fetch with <code>Promise.all</code> preserves order while achieving concurrency — good for typical workloads.<br>- <code>fetchLiveFilesSequential</code> is sequential and can add up latencies equal to sum of endpoint probe times; consider bounded parallelization for faster discovery.<br>- <code>createFileSearchEngine</code> builds inverted postings limited by <code>MAX_POSTINGS</code>; this mitigates memory blow-up but reduces recall for very large collections. Tokenization and scoring run on main thread — flags exist for worker scoring (<code>ENABLE_WORKER_SCORING</code>) but no worker implementation present; for large datasets (>= <code>WORKER_THRESHOLD</code>) scoring will block UI. <br>- Caption application loop polls DOM up to <code>maxRetries</code> (default 120 every 160ms) — worst-case ~19s of polling; safe but could delay perceived completion.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Security, privacy & injection considerations</strong><br>- <strong>XSS risk mitigation:</strong> highlights and injected HTML use <code>.innerHTML</code> in multiple places (e.g., <code>nameLine.innerHTML = highlight(...)</code>, <code>fname.innerHTML = highlight(...)</code>). The code uses <code>escapeHtmlLocal</code> or <code>escapeHtml</code> before highlighting in most places, but ensure that all highlight code paths always escape user-controlled strings. <code>sanitizeCaptionForInjection</code> aggressively strips tags and scripts before inserting captions into markdown comments/headings — good practice.<br>- <strong>Telemetry/privacy:</strong> <code>trySendActiveGroupMetadata</code> transmits filenames, captions, and paths to <code>/api/group/load</code> by default. This can leak sensitive metadata. Recommend opt-in telemetry or redaction by default, and server-side CSRF/auth protection for the endpoint.<br>- <strong>CSP</strong>: heavy inline style usage in <code>createModal</code> may violate strict CSPs; provide a CSS class alternative or allow injection of a nonce-controlled <code>&lt;style&gt;</code> block.<br>- <strong>Clipboard fallback</strong>: the <code>execCommand(&#x27;copy&#x27;)</code> fallback may be unreliable in some environments; code already prefers <code>navigator.clipboard</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Bugs, risky assumptions & edge-cases</strong><br>1. <strong>ASCII-only tokenization</strong> — <code>tokenize</code> in <code>createFileSearchEngine</code> and <code>norm</code> in <code>presentGroupsOnly</code> use <code>/[^a-z0-9\s]+/g</code> which strips non-Latin characters; CJK, accented, Cyrillic, Arabic searches and tokenization will fail. Requires Unicode-aware tokenization (e.g., <code>\p{L}\p{N}</code> with <code>u</code> flag).<br>2. <strong>Worker scoring flags unused</strong> — <code>ENABLE_WORKER_SCORING</code> and <code>WORKER_TIMEOUT_MS</code> exist but no Web Worker is spawned; large indexes will perform scoring on main thread. Either implement worker or remove confusing flags.<br>3. <strong>Duplicate utilities</strong> — <code>trigramsOf</code>/<code>tokenize</code> implementations exist both inside the engine and inside <code>presentGroupsOnly</code> — risk of drift. Factor to shared helpers.<br>4. <strong>Sequential endpoint probing</strong> — <code>fetchLiveFilesSequential</code> checks endpoints one-by-one leading to worst-case latency equal to sum of probe times. Bounded parallel probing would improve UX without breaking priority.<br>5. <strong>Hardcoded saved base path</strong> — <code>encodedSavedUrlFor</code> uses <code>/saved/</code> prefix; if server uses different base, synthesized URLs may 404. Make base configurable or prefer server-provided URLs when available.<br>6. <strong>No global cancellation</strong> — the <code>loadFilesSequentialAndHideForm</code> flow spawns many fetches via <code>fetchFileWithTimeout</code> but provides no central cancellation token when modal closed or user navigates away. Add an AbortController group for cancellation and to stop caption-polling ticks.<br>7. <strong>Title mutation side-effect</strong> — code may set <code>document.title</code> to first caption when <code>document.title</code> is missing or default. This mutates host page and may be unexpected. Limit or make optional.<br>8. <strong>Caption-apply heuristics may mis-target nodes</strong> — <code>applyRuntimeCaptions</code> attempts matching by <code>.table-caption</code> or heading elements and heuristics for "Table N" names; fragile with custom renderer markup. Consider exposing an integration hook to map runtime captions to renderer-specific caption nodes.<br>9. <strong>Potential silent failures</strong> — <code>fetchFileWithTimeout</code> rejects on HTTP error; callers swallow errors into <code>ok:false</code> slots and insert fail notes into assembled text. This is intentional, but ensure host UX accounts for partially failed loads.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Maintainability & integration observations</strong><br>- File is modular with clear function boundaries but contains many global exposures (<code>window.__ptt_runtime_captions</code>, <code>__tv_last_source</code>, <code>__ptt_list_render_in_progress</code>, <code>__ptt_hidden_convert</code>, <code>PTLabels</code>, <code>__ptt_force_raw_copy</code>) — document integration contract.<br>- Inline styles and duplicated utility functions complicate visual adjustments and maintenance; centralize CSS and common helpers.<br>- Logging controlled by <code>DEBUG</code> flag; consider a scoped logger with levels and runtime toggle to avoid editing source for debugging.<br>- Good separation: label-injection and server POST responsibility removed from this file (explicit comment) — reduces coupling.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Concrete recommended fixes (priority order)</strong><br><strong>High-priority</strong><br>- Replace ASCII-only tokenizers with Unicode-aware tokenization (e.g., <code>s.replace(/[^\p{L}\p{N}\s]+/gu, &#x27; &#x27;)</code> and use Unicode-aware splitting). Update highlight code to use the same canonical tokens to avoid mismatch.<br>- Add a cancellation mechanism for group loads: return a cancellable handle from <code>loadFilesSequentialAndHideForm</code> or use a shared <code>AbortController</code> that <code>attachListHandler</code>/modal close can call; stop caption polling on cancel.<br>- Make telemetry opt-in: require configuration like <code>PTT_CONFIG.telemetry === true</code> before POSTing filenames/captions; redact or aggregate file metadata by default (send counts and anonymized group id only).<br>- Make <code>/saved/</code> base path configurable via top-level config (e.g., <code>PTT_CONFIG.savedBasePath</code>) rather than hardcoding.[br]<br><strong>Medium-priority</strong><br>- Implement worker-based scoring or remove <code>ENABLE_WORKER_SCORING</code> flag. If implementing, serialize minimal engine data and set a worker timeout/fallback path.<br>- Parallelize initial live-endpoint probes with bounded concurrency (N=2) while preserving candidate priority (e.g., race first two, then remaining sequentially).<br>- Factor duplicated helpers (<code>tokenize</code>, <code>trigramsOf</code>, <code>escapeHtmlLocal</code>) into shared utilities to avoid divergence.<br><br><strong>Low-priority / nice-to-have</strong><br>- Move inline modal styles to a CSS class / stylesheet and support CSP nonce injection.<br>- Expose integration hooks to map runtime captions to renderer-specific caption nodes (e.g., <code>PTT.on(&#x27;findCaptionNode&#x27;, fn)</code>).<br>- Make document title mutation optional or guarded by <code>PTT_CONFIG.titlesFromCaptions</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Suggested tests</strong><br><strong>Unit tests</strong>: <code>normalizeIndexData</code> for array/string/object shapes; <code>tryParseListBodyAsArray</code> with broken JSON and line lists; <code>buildLabelIndex</code> and <code>resolveCaptionFor</code> across many naming variants and numeric suffixes; <code>groupKeyFromPath</code> heuristics; <code>encodedSavedUrlFor</code> encoding edge cases; <code>tokenize</code> with Unicode inputs.<br><strong>Integration tests</strong>: <code>fetchWithTimeout</code> abort behavior with simulated slow endpoints; <code>fetchLiveFilesSequential</code> with a late-valid endpoint to reproduce latency; <code>loadFilesSequentialAndHideForm</code> with partial failures and large files; caption-apply flow with renderer mocking different DOM structures.<br><strong>E2E / Load</strong>: large index (>WORKER_THRESHOLD) to validate search performance and UI responsiveness; simulate mobile and CSP-restricted hosts to validate modal style behavior.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Compatibility & deployment checklist</strong><br>- Document and allow runtime overrides for top-level config (endpoints, savedBasePath, timeouts, MAX_LIST_ITEMS, cache-buster, telemetry).<br>- Document global variables and expected renderer API (<code>__tv_do_convert</code>, <code>convert</code>, <code>copyTableMarkdown</code>, <code>copyTablePlain</code>) and how to opt-out of telemetry/auto-posting.<br>- Ensure server-side <code>/api/group/load</code> endpoint has appropriate CSRF/auth checks if telemetry is enabled.<br>- Provide instructions for CSP environments (nonce or external CSS) and non-UTF8 servers (if any TextDecoder fallback needed).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Potential regressions to watch for when changing code</strong><br>- Changing tokenizer/normalizer behavior will change search results and label lookups (<code>labels.json</code> matching). Maintain backward compatibility or provide migration notes.<br>- Making <code>/saved/</code> path configurable will alter generated URLs; include compatibility shim or fallback to server-provided <code>url</code> when available.<br>- Moving inline styles to classes may alter visual layout; provide default stylesheet to keep parity with the current UI.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Final concise verdict</strong><br>Robust, defensive, and well-structured saved-groups/list loader with careful fallbacks and strong UX considerations. Primary technical risks: ASCII-only tokenization (non-Latin search failure), unused worker-scoring flags (main-thread scoring on large datasets), sequential endpoint probing (worst-case latency), hardcoded <code>/saved/</code> path assumption, and lack of a centralized cancellation mechanism for in-flight loads and caption polling. Addressing those items (Unicode tokenization, worker or remove flag, bounded-parallel endpoint probing, configurable saved base path, opt-in telemetry, and an AbortController group) plus factoring duplicated utilities will make the module production-ready and easier to maintain.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr></tbody></table></div><div class="row-count">Rows: 15</div></div><div class="table-caption" id="Table3" data-table="Docu_0125_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3 • script.table.js</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical breakdown (script.table.js)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical breakdown (script.table.js)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Overview & intent</strong><br>Client-side table utilities for PasteToTable focused on read-only caption safety, robust copying/export, TOC building, search/highlight, sorting, UI optimization, and multi-format export (CSV/JSON/XLSX/PDF). Designed to be defensive and interoperable with optional host utilities (<code>window.tvUtils</code>, <code>window.PTToc</code>, <code>window.XLSX</code>, <code>window.tvConfig</code>). The module avoids creating caption DOM (reads server-rendered captions only), prefers non-destructive operations (stores <code>data-orig-html</code>), and provides idempotent initialization via <code>initRenderedContent</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>High-level architecture</strong><br>1. <strong>Feature-detection wrappers</strong> — lightweight <code>safe</code>, <code>isString</code>, and fallbacks for clipboard/download/toast/debounce. <br>2. <strong>DOM helpers & locators</strong> — <code>getContentRoot</code>, <code>_findTocBarUl</code>, <code>safeGetTBody</code>, <code>getTableFromButton</code>, <code>getWrapperTitle</code>. <br>3. <strong>TOC builders</strong> — <code>buildSingleTableToc</code>, <code>buildTocFromCaptions</code>, <code>buildTocs</code> (prefers <code>window.PTToc</code>). <br>4. <strong>Row / sort state management</strong> — <code>_ensureRowUidsAndSnapshot</code>, <code>sortStates</code>, <code>originalRowOrders</code>, <code>updateHeaderSortUI</code>, <code>sortTableByColumn</code>, <code>headerSortButtonClicked</code>. <br>5. <strong>Collapse/expand & controls</strong> — <code>toggleTable</code>, <code>toggleAllTables</code>, <code>optimizeTableControls</code>, responsive adjustments and control re-parenting. <br>6. <strong>Search & highlighting</strong> — <code>normalizeForSearchLocal</code>, <code>buildNormalizedMapForCell</code>, <code>highlightMatches</code>, <code>clearHighlights</code>, <code>searchTable</code>. <br>7. <strong>Copy / export</strong> — <code>copyTablePlain</code>, <code>copyTableMarkdown</code>, <code>tableToMarkdownLines</code>, <code>formatCellForMarkdown</code>, <code>exportTableCSV</code>, <code>exportTableJSON</code>, <code>exportTableXLSX</code>, <code>exportTablePDF</code>, <code>exportAllBtnHandler</code>. <br>8. <strong>Source snapshot & mapping</strong> — IIFE <code>attachSourceSnapshotters</code>, <code>getPreferredSourceForTable</code>, <code>findMarkdownTableBlocks</code>, <code>splitSourceByBlankLines</code>. <br>9. <strong>Init & events</strong> — <code>initRenderedContent</code>, DOMContentLoaded/ready path, global click delegations for sort and TOC links, keybindings (<code>/</code>, <code>Escape</code>), <code>backToTop</code>. <br>10. <strong>Exports & integration</strong> — exposes <code>PasteToTable.initRenderedContent</code>, <code>PTTable.buildTocs</code>, and many <code>window.*</code> helpers for host usage.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Key functions (concise per-function notes)</strong><br><strong>safe(fn)</strong> — wrapper executes <code>fn()</code> catching exceptions; returns <code>undefined</code> on error. Use: protect optional one-off calls.<br><strong>isString(x)</strong> — strict <code>typeof x === &quot;string&quot;</code> predicate used across markdown/source helpers.<br><strong>copyToClipboard(text)</strong> — adaptive copy: uses <code>navigator.clipboard.writeText</code> when available; falls back to hidden <code>&lt;textarea&gt;</code> + <code>document.execCommand(&#x27;copy&#x27;)</code>. Returns Promise; rejects on failure. Handles focus/select and cleans up element. <br><strong>downloadBlob(blob, filename)</strong> — creates <code>ObjectURL</code>, injects hidden <code>&lt;a download&gt;</code>, clicks, schedules cleanup + revoke. Best-effort; silent on error. <br><strong>showToast(...)</strong> — delegates to host <code>tvUtils.showToast</code> or global <code>showToast</code>; final fallback logs to console. Used for user feedback on exports/copy. <br><strong>debounce(fn, wait)</strong> — fallback debounce (simple timeout) if host <code>tvUtils.debounce</code> absent. <br><strong>sanitizeText(s)</strong> — safe trimming with try/catch. <br><strong>getContentRoot()</strong> — returns content container (<code>#content</code>, <code>#tables-viewer</code>, or <code>document.body</code>) with try/catch fallback. <br><strong>_findTocBarUl(tocBar)</strong> — ensures a <code>&lt;ul&gt;</code> exists inside tocBar; returns existing <code>#tocBarList</code> or creates one. Defensive about nulls. <br><strong>buildSingleTableToc()</strong> — when a single table exists, finds canonical wrapper and table rows, creates stable per-row anchors (<code>tv-row-N</code>), sets <code>tabindex=-1</code>, builds list items in <code>#tocBar</code> with click handlers that smooth-scroll and focus target. Idempotent: clears existing <code>ul</code> children. Avoids inventing captions; uses row text summarization for labels. <br><strong>buildTocFromCaptions()</strong> — reads server-provided caption-like nodes (<code>.table-caption</code>, <code>.table-title</code>, <code>.table-heading</code>), ensures unique IDs without creating caption nodes, builds TOC entries in <code>#toc</code> and <code>#tocBar</code> by cloning list nodes. If none found, clears existing TOC lists. Click handlers similar to <code>buildSingleTableToc</code>. <br><strong>buildTocs()</strong> — integration entry that prefers <code>window.PTToc.init/build()</code> with specific selectors; falls back to <code>buildSingleTableToc</code> and <code>buildTocFromCaptions</code> and schedules delayed re-runs for dynamic content. <br><strong>safeGetTBody(table)</strong> — returns first <code>tBodies[0]</code> or <code>null</code> safely. <br><strong>_ensureRowUidsAndSnapshot(table, tableIdx)</strong> — assigns stable <code>data-tv-uid</code> to each row and stores original order into <code>originalRowOrders[tableIdx]</code> for stable restore; increments <code>_tv_row_uid_counter</code>. <br><strong>updateHeaderSortUI(tableIdx)</strong> — updates header button classes (<code>sort-state-0/1/2</code>), sets <code>aria-sort</code>, and swaps inline SVGs inside <code>.sort-icon</code> according to <code>sortStates</code>. Defensive DOM checks. <br><strong>sortTableByColumn(tableIdx, colIdx)</strong> — three-state sort cycle: (0) default → ascending numeric/lexicographic, (1) ascending → descending, (2) descending → restore original order using <code>originalRowOrders</code>. Numeric detection: <code>parseFloat</code> after removing commas/spaces. Preserves <code>data-orig-html</code> for cells, appends rows to tbody in new order, normalizes other header states to <code>0</code>, updates UI and row counts. <br><strong>headerSortButtonClicked(tableIdx, colIdx, btnEl)</strong> — simple wrapper to call <code>sortTableByColumn</code> and focus the button. Exposed on <code>window</code>. <br><strong>toggleTable(btn)</strong> — collapse/expand a single wrapper's tbody by toggling <code>display: none</code> and ARIA label & button text; updates <code>toggleAllBtn</code> text and calls <code>updateRowCounts</code>. Exposed. <br><strong>toggleAllTables()</strong> — toggles all wrappers collapsed/expanded collectively; updates per-wrapper toggle labels and <code>toggleAllBtn</code> label; calls <code>updateRowCounts</code>. Exposed. <br><strong>updateRowCounts()</strong> — per-wrapper row counting UI: writes "Showing X rows" or "Showing V of T rows" into <code>.row-count</code> elements; accounts for hidden rows (display: none). Robust to missing wrappers. <br><strong>formatCellForMarkdown(cell)</strong> — escapes pipe <code>|</code> with <code>\|</code>, replaces newlines with <code>&lt;br&gt;</code> and returns string suitable for inline pipe-markdown cell. Used by <code>tableToMarkdownLines</code>. <br><strong>tableToMarkdownLines(table, title)</strong> — builds array of markdown lines: optional bold title, header row from <code>rows[0]</code>, separator <code>---</code>, then data rows using <code>formatCellForMarkdown</code>; safe for empty tables. <br><strong>attachSourceSnapshotters() (IIFE)</strong> — binds input listener on <code>#paste</code> to set <code>window.__tv_last_source</code> on edits; captures click on convert buttons to snapshot and set <code>__tv_last_source_ts</code>. Idempotent and defensive. <br><strong>findMarkdownTableBlocks(source)</strong> — parses raw source into contiguous pipe-table blocks using header+separator detection; returns <code>[{start,end,lines}]</code>. Conservative rules: looks for <code>|</code> lines and <code>-</code> separator. <br><strong>splitSourceByBlankLines(source)</strong> — splits source on blank-line blocks and trims entries; used to match preferred source per table. <br><strong>getPreferredSourceForTable(table)</strong> — attempts to map <code>window.__tv_last_source</code> blocks to a DOM table: strategies — (a) if number of <code>.table-container table</code> equals number of source blocks, pick corresponding indexed block; (b) match by wrapper title proximity to lines near block start; (c) match by header cell content (token/length heuristics); (d) fallback to single block or source with <code>|</code>. Returns block string or <code>null</code>. Defensive: many fall-through heuristics and try/catch wrappers; returns null if uncertain. <br><strong>getWrapperTitle(wrapper)</strong> — read-only lookup for wrapper caption: checks <code>.table-caption</code>, h3/h2/h1, <code>aria-label</code>, and <code>data-table-id</code> dataset attributes; returns empty string if nothing found. Important: does NOT create caption nodes. <br><strong>getTableFromButton(btn)</strong> — resolves table by <code>data-tv-table-index</code> dataset (preferred) or nearest wrapper (<code>.table-wrapper</code>, <code>.table-container</code>, <code>[data-table-id]</code>) and returns the table element. Defensive parsing of dataset. <br><strong>copyTablePlain(btn)</strong> — copies tab-separated table text: builds title + rows (cells joined by <code>\t</code>), tries <code>tvUtils.showCopyModal</code> if available, else <code>copyToClipboard</code> then toasts success/failure with fallback to show modal on failure. If no table, falls back to <code>window.__tv_last_source</code>. Shows warnings if nothing to copy. Exposed on <code>window</code>. <br><strong>copyTableMarkdown(btn)</strong> — tries <code>getPreferredSourceForTable</code> first and copies raw markdown when available; otherwise builds markdown via <code>tableToMarkdownLines</code> and copies it; falls back to <code>__tv_last_source</code> if table absent. Uses same modal/copy/toast pattern as plain copy. Exposed. <br><strong>sanitizeFileName(name)</strong> — strips invalid filesystem characters, trims to 160 chars, default "table". Used by exports. <br><strong>exportTableCSV(btn, { filename } )</strong> — builds CSV from table rows with proper quoting for <code>&quot;</code> and <code>,</code> and newline handling; prepends BOM <code>\uFEFF</code>; uses <code>downloadBlob</code> to trigger save. Uses wrapper title or provided filename. Toasts. Exposed. <br><strong>exportTableJSON(btn, { filename })</strong> — extracts headers from <code>thead</code> or first row fallback <code>ColN</code>, builds array of objects (keys→cell text), stringifies prettily, creates Blob and triggers <code>downloadBlob</code>. Exposed. <br><strong>exportTableXLSX(btn, { filename })</strong> — attempts true XLSX export via SheetJS (<code>window.XLSX.utils</code>) if available (supports <code>writeFile</code> or <code>write</code> paths). If SheetJS missing, falls back to TSV saved with Excel-compatible MIME and warns. Uses <code>aoa</code> conversion of table rows. Exposed. <br><strong>exportTablePDF(btn, { filename })</strong> — builds small standalone HTML doc (inline styles), opens new window/tab, writes document and calls <code>print()</code> to let user save as PDF; toasts on failure. Exposed. <br><strong>clearHighlights(cell)</strong> — restores <code>cell.innerHTML</code> from <code>data-orig-html</code> if present, else unwraps <code>&lt;mark&gt;</code> elements by replacing them with text nodes. Non-destructive. <br><strong>normalizeForSearchLocal(s)</strong> — Unicode-aware normalization: prefers host <code>__tv_utils.normalizeForSearchLocal</code>; otherwise attempts <code>toLowerCase().normalize(&quot;NFD&quot;)</code>, strips diacritics, removes non-letter/number/space using <code>\p{L}\p{N}</code> with <code>u</code> flag, falls back to <code>\w</code>. Defensive try/catch branches for environment support. <br><strong>buildNormalizedMapForCell(cell)</strong> — builds a normalized string and a positional <code>map</code> linking each normalized character back to a specific text node and offset. Uses a TreeWalker to collect text nodes, iterates by codepoints (handles surrogate pairs), applies NFD decomposition and diacritic stripping, and preserves per-character mapping for accurate highlight insertion. Returns <code>{normStr, map, nodes}</code>. <br><strong>highlightMatches(cell, filterNorm)</strong> — uses <code>buildNormalizedMapForCell</code> to find matches of normalized needle inside <code>normStr</code>, computes start/end node/offsets for each match, then wraps matched text ranges in <code>&lt;mark&gt;</code> elements. Works backward from end to start to preserve offsets; supports matches spanning multiple text nodes by extracting and moving nodes under <code>&lt;mark&gt;</code>. Respects <code>data-orig-html</code> to reset first. <br><strong>searchTable()</strong> — main search entry: reads search input (multiple selectors), computes <code>filterNorm</code>, iterates tables and rows, clears previous highlights, hides non-matching rows (<code>display: none</code>), applies <code>highlightMatches</code> if <code>window.tvConfig.highlight</code> truthy, scrolls to firstMatch smoothly, requests table virtualizer refresh if present, and updates row counts. Exposed. <br><strong>optimizeTableControls()</strong> — responsive control layout adjustments: detects mobile via <code>(max-width:600px)</code>, moves copy buttons into <code>.copy-buttons</code> container, repositions toggle button to left, applies per-button inline style adjustments for mobile vs desktop. Uses best-effort DOM mutations; non-destructive. Debounced and bound to <code>resize</code>/<code>matchMedia</code> change. <br><strong>initRenderedContent()</strong> — consolidated initialization: wraps standalone tables into <code>.table-container</code> if missing, calls <code>buildTocs</code>, ensures row uids/snapshots, caches <code>data-orig-html</code>, updates header UI icons, sets toggle button labels, creates <code>backToTop</code> if missing, wires search box listeners (debounced), attaches per-table handlers for copy/export/toggle buttons (idempotent via dataset flags), calls <code>optimizeTableControls</code>, <code>updateRowCounts</code>, and scrolls first table into view. Idempotent and safe to call multiple times. Exposed via <code>PasteToTable.initRenderedContent</code>. <br><strong>exportAllBtnHandler()</strong> — collects all <code>.table-wrapper</code> tables and does multi-sheet XLSX export if SheetJS present; otherwise concatenates markdown for all tables and downloads as <code>all_tables.md</code>. Uses <code>getWrapperTitle</code> for sheet names (limited to 31 chars). Exposed. <br><strong>backToTop()</strong> — smooth scroll to top; exposed and bound to <code>backToTop</code> button. <br><strong>Event delegations & global listeners</strong> — two delegated <code>document.click</code> handlers: (1) sorting via <code>.sort-btn</code> / <code>.th-with-sort</code> detection which maps to <code>headerSortButtonClicked</code>; (2) TOC link clicks under <code>#tocBar</code> to smooth-scroll to id or wrapper. <code>window.scroll</code> listener toggles <code>#backToTop</code> visibility. Keydown listener (<code>/</code> to focus search; <code>Escape</code> triggers backToTop) bound on init. Many listeners are defensive and wrapped.                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Defensive patterns used</strong><br>- Ubiquitous <code>try/catch</code> to avoid breaking host pages.<br>- Feature detection for <code>navigator.clipboard</code>, <code>window.XLSX</code>, <code>window.PTToc</code>, <code>window.tvUtils</code>, <code>window.__tv_utils</code>.<br>- Idempotent init: uses dataset flags (<code>tvBound</code>, <code>tvHandlerAttached</code>) and checks for existing wrappers/elements before creation.<br>- Non-destructive content handling: caches original HTML in <code>data-orig-html</code> and uses it to restore highlights; does not create caption elements (read-only principle).<br>- Unicode-aware processing with fallbacks: uses <code>\p{L}\p{N}</code> where supported, falls back to <code>\w</code> when not. Handles surrogate pairs and diacritics explicitly. <br>- Accessibility considerations: sets <code>tabindex=-1</code> on row anchors, <code>aria-sort</code> proper values, <code>aria-label</code> on anchors, and updates <code>aria-expanded</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Notable behaviors & integration choices</strong><br>- <strong>Caption safety</strong>: intentionally reads caption-like nodes only; never creates captions; avoids content injection. <br>- <strong>Source-first copy</strong>: <code>copyTableMarkdown</code> prefers the original source block (<code>__tv_last_source</code>) when it confidently maps to a table — preserves author intent and runtime provenance. <br>- <strong>SheetJS optional</strong>: XLSX exports prefer SheetJS but provide TSV fallback for environments where SheetJS isn't loaded. <br>- <strong>UI styling</strong>: many inline style manipulations inside <code>optimizeTableControls</code> to ensure control layout without requiring external CSS; acceptable but may clash with strict CSP or theming. <br>- <strong>Search tokenization</strong>: <code>normalizeForSearchLocal</code> aggressively strips punctuation but attempts robust Unicode normalization; this behavior affects what is considered a match (good for accent-insensitive search). <br>- <strong>Non-blocking UX</strong>: debounced search, delayed re-builds (<code>setTimeout</code>), and best-effort layout moves reduce layout thrashing on init.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Performance & scalability notes</strong><br>- <strong>Highlighting complexity</strong>: <code>buildNormalizedMapForCell</code> iterates every text node and every character by codepoint; for very large cells or tables with thousands of rows, highlighting can be CPU-heavy. Consider throttling or virtualizing highlight operations for very large tables. <br>- <strong>Sorting stability</strong>: restoring original order relies on <code>originalRowOrders</code> captured on init; subsequent DOM mutations (rows added/removed) may desynchronize snapshots — callers must re-run <code>initRenderedContent</code> when tables change. <br>- <strong>I/O & Blob generation</strong>: export functions create in-memory strings/blobs; exporting extremely large tables may cause memory spikes. Suggest streaming exports for huge datasets or server-side export endpoints. <br>- <strong>DOM reflows</strong>: <code>optimizeTableControls</code> manipulates inline styles and element insertion per-wrapper; on pages with many wrappers this can cause layout churn. Debounced invocation mitigates but consider batching or CSS-only approach.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Security, privacy & CSP considerations</strong><br>- <strong>CSP</strong>: inline <code>style</code> assignments and <code>innerHTML</code> usage for SVG icons and <code>table.outerHTML</code> in PDF export may be blocked by CSP policies. Recommend providing CSS classes and using safe DOM methods for icons (SVG <code>&lt;use&gt;</code> or CSS). <br>- <strong>HTML injection risk</strong>: <code>updateHeaderSortUI</code> uses <code>innerHTML</code> to insert SVG markup; it's low-risk but ensure the SVG strings are constant and not influenced by user input. <br>- <strong>Clipboard fallback</strong>: using <code>document.execCommand(&#x27;copy&#x27;)</code> relies on DOM insertion of a textarea; some environments may restrict clipboard access — fallback shows copy modal when available. <br>- <strong>Open window printing</strong>: <code>exportTablePDF</code> opens a new window and writes <code>table.outerHTML</code> into it. If a host page's table contains sensitive inline scripts or event handlers, those are serialized to HTML but not executed in the new doc; still verify sanitized content if host requires strict privacy.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Bugs / risky assumptions / edge cases</strong><br>1. <strong>Header detection for markdown</strong>: <code>tableToMarkdownLines</code> assumes the first row is header; pages using <code>thead</code> properly are fine, but tables with multi-row headers or no explicit header may produce poor markdown. <br>2. <strong>Original-order restoration fragility</strong>: <code>originalRowOrders</code> keyed by <code>tableIdx</code> is captured during <code>initRenderedContent</code>. If tables reflow or DOM order changes (insertion/removal), <code>tableIdx</code> may no longer map to the same table. Consider using a Map keyed by a stable table identifier (e.g., <code>data-table-id</code> or <code>table</code> element reference) instead of numeric index. <br>3. <strong>normalizeForSearchLocal fallback inconsistency</strong>: fallback branch uses <code>\w</code> which includes underscore and digits but may behave differently across locales; tests required for CJK behavior. <br>4. <strong>Highlight spanning complex nodes</strong>: <code>highlightMatches</code> extracts and reparent nodes between start and end text nodes; it can break if those nodes cross element boundaries with non-text children (e.g., images, nested tags with event handlers) — need to ensure semantic integrity when reparenting. <br>5. <strong>Performance on large tables</strong>: search + highlight on many rows can be slow; no in-page virtualization by default. If <code>tableVirtualizer</code> exists it's refreshed, but file does not include a fallback virtualizer. <br>6. <strong>Button wiring limited selectors</strong>: handlers are attached to first matching selector per wrapper (<code>wrapper.querySelector(h.sel)</code>); if a wrapper contains multiple identical buttons, only the first is wired. Intention may be to wire primary action only — document this. <br>7. <strong>Event delegation duplication</strong>: two <code>document.addEventListener(&quot;click&quot;, ...)</code> handlers are defined; they are targeted and safe but could be consolidated for clarity. <br>8. <strong>CSV BOM use</strong>: <code>exportTableCSV</code> prepends <code>\uFEFF</code> universally; while good for Excel/UTF-8 detection, some consumers may prefer raw CSV without BOM. Consider configurability.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Maintainability observations</strong><br>- File is well-structured with clear regions (TOC, sorting, export, search). Abundant try/catch makes logic safe but noisy; consider scoping common try/catch wrapper utility to reduce repetition. <br>- Many implicit globals and dataset flags: document expected dataset keys (<code>tvTableIndex</code>, <code>tvHandlerAttached</code>, <code>tvBound</code>) and global hooks (<code>tvUtils</code>, <code>tvConfig</code>, <code>PTToc</code>, <code>XLSX</code>, <code>tableVirtualizer</code>). <br>- Inline SVG strings and style manipulations are duplicated in <code>updateHeaderSortUI</code> and <code>optimizeTableControls</code>; factor to shared utilities or small templates for clarity. <br>- Consider extracting heavy text-processing (normalization + map building) into a dedicated module to enable unit tests and performance optimization.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Concrete recommended fixes (priority order)</strong><br><strong>High-priority</strong><br>- Replace <code>originalRowOrders[tableIdx]</code> indexing with a Map keyed by a stable identifier (e.g., <code>table.dataset.tableId</code> or <code>table</code> element reference via <code>WeakMap</code>) to ensure restore correctness after DOM changes. <br>- Limit highlight work for very large cells/tables: add a maximum length/rows threshold before enabling fine-grained <code>highlightMatches</code>, or progressively highlight visible viewport rows only (integrate with virtualizer). <br>- Make CSV BOM prepend configurable via <code>tvConfig.exportBom</code> to support host preferences. <br><strong>Medium-priority</strong><br>- Make handlers attach to <code>querySelectorAll(h.sel)</code> instead of first <code>querySelector</code> when multiple identical buttons should be wired; or document the intended single-button assumption. <br>- Add a <code>PTTable.rebuild()</code> API that re-captures <code>originalRowOrders</code>, rebinds handlers, and reinitializes snapshots for dynamic content injection. <br><strong>Low-priority / niceties</strong><br>- Move inline SVG icon templates into small functions <code>getSortIcon(state)</code> to reduce duplication. <br>- Replace many <code>try/catch</code> blocks with <code>safe(()=&gt;...)</code> helper where appropriate to reduce noise and ensure consistent error reporting.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Suggested tests</strong><br><strong>Unit</strong>: <code>findMarkdownTableBlocks</code> edge cases (multiline cells, stray pipes), <code>getPreferredSourceForTable</code> with varied source layouts, <code>normalizeForSearchLocal</code> with accented/emoji/CJK text, <code>buildNormalizedMapForCell</code> mapping accuracy (with surrogate pairs). <br><strong>Integration</strong>: <code>copyTablePlain</code> and <code>copyTableMarkdown</code> success/failure paths including clipboard API absence; <code>exportTableXLSX</code> SheetJS vs fallback; <code>buildSingleTableToc</code> idempotence and unique ID collision handling. <br><strong>Performance</strong>: highlight throughput on large table (10k rows), sorting on wide tables (100+ columns), repeated <code>initRenderedContent</code> calls for dynamic DOM. <br><strong>Accessibility</strong>: <code>aria-sort</code>, <code>aria-expanded</code>, <code>tabindex</code> behavior and keyboard focus after anchor clicks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Compatibility & integration checklist</strong><br>- Document optional global hooks: <code>tvUtils</code> (copy/download/toast/debounce), <code>PTToc</code> (external TOC builder), <code>tvConfig</code> (highlight, debounceMs), <code>XLSX</code> (SheetJS), <code>tableVirtualizer</code>. <br>- Ensure CSP compatibility: provide CSS-only alternative or host-provided nonce for inline styles if required. <br>- Expose <code>PTTable.rebuild</code> (recommended) to allow host to re-run snapshots after dynamic DOM changes. <br>- Recommend host opt-in for <code>tvConfig.highlight</code> to avoid heavy DOM changes on pages with large tables.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Potential regressions to watch for when changing code</strong><br>- Changing <code>normalizeForSearchLocal</code> regex can alter search results and highlight positions; ensure backward-compatible normalization or configurable normalizer. <br>- Altering <code>data-orig-html</code> handling or clearing strategy may break highlight restoration and custom cell formatting. <br>- Moving inline style logic into classes without preserving all adjustments may change appearance on smaller screens; provide default CSS to maintain parity.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical breakdown (script.table.js)"> <strong>Final concise verdict</strong><br>Comprehensive, defensive, and integration-friendly table utility module with strong emphasis on caption-safety and preserving source provenance. Primary risks are performance of per-character normalized mapping & highlight on large tables, fragility of row-order restoration using numeric indexes, and inline-style/CSP concerns. Addressing the high-priority fixes (stable original-order tracking, highlight throttling/virtualization, and configurable CSV BOM) plus adding a public <code>rebuild()</code> API and unit tests will make this production-ready and robust for dynamic host environments. Reviewed carefully and cross-checked against the provided file for completeness. </td></tr></tbody></table></div><div class="row-count">Rows: 14</div></div><div class="table-caption" id="Table4" data-table="Docu_0125_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4 • script.toc.js</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical breakdown (script.toc.js)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical breakdown (script.toc.js)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Overview & intent</strong><br>Lightweight, defensive Table-of-Contents (TOC) and caption-injection module for PasteToTable. Responsibilities: discover headings/tables, compute stable IDs, build minimal DOM TOC fragments, idempotently update UI (diff + signature), inject or reuse table captions from external label data, throttle and debounce rebuilds/injections to reduce flicker, and auto-select a likely first table. Maintains backward-compatible public surface (<code>window.PTToc</code>, <code>PTToc.build</code>, <code>PTToc.init</code>, <code>PTToc.reloadLabels</code>, <code>PTToc.getLabels</code>, <code>PTToc.applyLabelsNow</code>, <code>PTToc.scheduleTocRefresh</code>). Designed for resilience (try/catch) and minimal visual churn.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>High-level architecture</strong><br>1. <strong>Singleton guard & config</strong> — top-level IIFE prevents double-install via <code>window.__pt_toc_installed</code>. <code>PTToc.config</code> centralizes selectors, label paths, timings, and feature flags (<code>deferLabelsReload</code>, <code>autoSelectTable1Enabled</code>).<br>2. <strong>Label subsystem</strong> — <code>reloadLabels</code>, <code>getLabels</code>, <code>normalizeLabels</code>, and a lazy install IIFE <code>installLabelsHelpers()</code> that wires <code>PTToc._reloadPromise</code> and global aliases (<code>window.__ptt_labels_reload_promise</code>, <code>window.__ptt_labels_injected</code>).<br>3. <strong>Fetch helpers</strong> — <code>fetchJsonOnce</code> uses <code>fetch</code> + <code>AbortController</code> (if available) with a per-request timeout and returns <code>null</code> on any failure; <code>fetchLabels</code> is a simple sequential candidate fetch fallback without explicit timeout handling.<br>4. <strong>ID & caption helpers</strong> — <code>ensureId</code>, <code>canonKey</code>, <code>captionFor</code>, <code>injectCaptionForElement</code> provide stable id generation, canonicalization of label keys, label lookup, and throttled caption injection/reuse.<br>5. <strong>TOC builder</strong> — <code>buildItemsFromSingleTable</code>, <code>buildItemsFromHeadings</code>, <code>itemsSignature</code>, <code>buildOnce</code>, <code>debounceBuild</code> assemble item lists and apply DOM changes only when signature differs.<br>6. <strong>Minimal DOM-apply layer</strong> — <code>applyFragmentIfChanged</code> performs a shallow compare of existing vs new child nodes then atomically replaces children only when necessary.<br>7. <strong>Event wiring & lifecycle</strong> — <code>attachDelegatedHandlers</code> attaches delegated click/hash handlers and conversion-button listener; <code>observeMutations</code> monitors content root and debounces rebuilds; init flow (<code>PTToc.init</code>) supports deferred label warm/cold flows and background label warming.<br>8. <strong>Network instrumentation</strong> — <code>installGroupLoadInterceptor</code> safely wraps <code>fetch</code> and <code>XMLHttpRequest</code> once to trigger <code>scheduleTocRefresh</code> on <code>/api/group/load</code> or <code>/api/convert</code> traffic.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Key functions & responsibilities (concise)</strong><br><strong>ensureId(el, prefix)</strong> — produce a stable element id from element text, normalize and sanitize, truncate to 60 chars; avoid collisions by suffixing numeric increments; assigns id to element.<br><strong>_normalize_heading_text(raw)</strong> — strip tags/linebreaks and collapse whitespace for id/text normalization.<br><strong>makeLink(id, text, extraClass)</strong> — DOM helper: create <code>&lt;li&gt;&lt;a&gt;</code> with <code>href=#id</code>, <code>data-pt-target</code> and aria attributes.<br><strong>fetchJsonOnce(url, timeoutMs)</strong> — safe fetch with optional AbortController timeout; returns parsed JSON or <code>null</code> on any error; logs via <code>dbg</code>.<br><strong>canonKey(s)</strong> — minimal canonicalization for label keys: trims, collapses spaces, strips non-alphanumeric at ends, lowercases.<br><strong>normalizeLabels(raw)</strong> — flattens nested label objects and maps keys through <code>canonKey</code>, producing <code>PTToc._labels</code> map.<br><strong>installLabelsHelpers() / PTToc.reloadLabels(opts)</strong> — sequence over candidate <code>labelsPaths</code> (expanded by <code>__tv_base</code>), optional cache-bust, sequential probe with per-candidate timeout (uses <code>fetchJsonOnce</code>), sets <code>_labels</code> and calls <code>PTToc.build()</code> when successful.<br><strong>PTToc.getLabels() / PTToc.applyLabelsNow(labelsObj)</strong> — read and write helpers; <code>applyLabelsNow</code> replaces <code>_labels</code> and rebuilds immediately.<br><strong>fetchLabels(paths)</strong> — fallback sequential fetcher returning first JSON body; lacks per-request timeout; used where <code>reloadLabels</code> not present.<br><strong>captionFor(labelsObj, bookPrefix, idx)</strong> — multiple lookup strategies (flat key variants, nested book prefix, padded numbers, canonKey) to return caption string or <code>null</code>.<br><strong>injectCaptionForElement(anchorEl, bookPrefix, idx, captionText)</strong> — idempotent caption injection with suppression window (<code>injectionSuppressMs</code>), reuses existing caption nodes, updates text if changed, avoids heavy churn, assigns <code>data-ptt-injected</code>, inline styling and generated id <code>TableNN</code> (with collision resolution).<br><strong>buildItemsFromSingleTable(table, labels, bookPrefix)</strong> — iterate rows (tbody precedence), ensure row ids, resolve caption label for each row or fall back to <code>rowLabelPrefix</code>.<br><strong>buildItemsFromHeadings(labels, bookPrefix)</strong> — collect configured headings, ensure ids, normalize text, optionally inject captions for matched headings.<br><strong>itemsSignature(items)</strong> — create compact signature string from id::label pairs used to detect changes.<br><strong>applyFragmentIfChanged(container, frag)</strong> — shallow compare childNodes (textContent and first anchor href), replace only if necessary; atomic replacement via clearChildren+appendChild.<br><strong>buildOnce()</strong> — orchestrates table/heading discovery, label-driven caption injection, signature check, fragment creation, minimal apply, highlight current location, and pending auto-select handling.<br><strong>debounceBuild()</strong> — debounce timer wrapper for <code>buildOnce</code> using <code>_debounceMs</code>.<br><strong>highlightCurrentFromLocation()</strong> — set <code>aria-current</code> on matching TOC link based on <code>location.hash</code>.<br><strong>onTocClick(ev)</strong> — delegated click handler: smooth scroll to target accounting for sticky header offset, prevent default, update history/hash and call <code>highlightCurrentFromLocation</code> after scroll.<br><strong>selectTable1()</strong> — heuristic auto-click of first Table1 candidate (by <code>data-pt-target</code> or visible text); throttle via <code>autoSelectThrottleMs</code> and <code>_lastAutoSelectAt</code>.<br><strong>scheduleTocRefresh(opts)</strong> — guarded scheduled refresh that can perform two label reload attempts (firstDelay, secondDelay), builds expanded candidate lists with <code>__tv_base</code>, uses cache-busted variants, updates <code>_labels</code> and calls <code>PTToc.build()</code>; deduplicates concurrent scheduling via <code>_scheduledRefreshFlag</code>.<br><strong>installGroupLoadInterceptor()</strong> — wraps global <code>fetch</code> and <code>XMLHttpRequest</code> once; when targets match <code>/api/group/load</code> or <code>/api/convert</code> triggers <code>scheduleTocRefresh({autoSelect:true})</code> on load/error; sets flags <code>_fetchWrapped</code>/<code>_xhrWrapped</code> to avoid double-wrapping.<br><strong>attachDelegatedHandlers() / observeMutations()</strong> — wire up document-level click, hashchange, mutation observer on content root (childList + subtree), and convert-click listener. <br><strong>PTToc.init(options)</strong> — merge runtime options into config, attach handlers, either do deferred build + background label warm (if <code>deferLabelsReload</code>) or block for initial <code>reloadLabels</code> then <code>buildOnce</code> and <code>observeMutations</code>. </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Defensive & resilience patterns used</strong><br>- Systematic <code>try/catch</code> around nearly every operation to avoid throwing and breaking host page.<br>- Singleton guard (<code>window.__pt_toc_installed</code>) and idempotent wrapper flags for wrappers and helpers.<br>- Feature-detection: <code>AbortController</code>, <code>MutationObserver</code>, <code>window.fetch</code>, <code>XMLHttpRequest</code> before using them.<br>- Timeouts for <code>fetchJsonOnce</code> to avoid long hangs; cache-bust query-params for label warming.<br>- Debounce (build) and throttle (auto-select, injectionSuppressMs) to reduce UI thrash and CPU load.<br>- DOM diffing (<code>itemsSignature</code>, <code>applyFragmentIfChanged</code>) to minimize repaint/DOM churn.<br>- Reuse of existing caption nodes when possible (<code>data-ptt-injected</code> marking) to reduce destructive DOM operations.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Notable behaviors & compatibility choices</strong><br>- <code>injectCaptionForElement</code> uses generated caption id <code>TableNN</code> — matches legacy expectations but may collide with existing pages using same id naming.<br>- <code>installGroupLoadInterceptor</code> watches for <code>/api/group/load</code> and <code>/api/convert</code> by substring — easy to trigger on similarly named endpoints; wrapper returns original Promise to callers to preserve behavior.<br>- <code>reloadLabels</code> expands relative candidates using global <code>__tv_base</code> if present to support deployments behind base paths.<br>- <code>deferLabelsReload</code> default <code>true</code> prefers fast initial UI paint and warms labels in background to avoid blocking page load.<br>- <code>PTToc</code> exposes <code>.build()</code> so host pages can force rebuilds; many globals used for cross-module coordination (<code>window.__ptt_labels_reload_promise</code>, <code>window.__ptt_labels_injected</code>).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Performance & scalability notes</strong><br>- Designed for small-to-medium pages: DOM diffing and debounce reduce cost of frequent changes.<br>- <code>fetchJsonOnce</code> per-candidate timeout prevents long stalls; <code>reloadLabels</code> is sequential—worst-case time = sum of per-candidate timeouts. For many label candidates this can be slow; <code>scheduleTocRefresh</code> mitigates by running two attempts spaced by <code>firstDelay</code>/<code>secondDelay</code>.<br>- <code>applyFragmentIfChanged</code> does shallow child-level comparison only (textContent/href), so it is cheap but can produce false positives on attribute-only changes requiring full replace.<br>- <code>injectCaptionForElement</code> suppression map (<code>_lastInjectionAt</code>) prevents repeated DOM ops but the per-target key is derived from <code>dataset.pttAnchorId</code> which may be newly generated — if anchors are re-created frequently, suppression loses effect.<br>- MutationObserver covers entire content root subtree which can be noisy on highly dynamic pages; debounce prevents excessive rebuilds but repeated large subtree mutations may still cause CPU work. Consider scoped observers or attribute filters if needed.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Security, integration & side-effect considerations</strong><br>- <strong>Global patching</strong>: overrides <code>window.fetch</code> and <code>window.XMLHttpRequest</code> (once) — may interact poorly with other instrumentation or polyfills. Flags <code>_fetchWrapped</code> / <code>_xhrWrapped</code> mitigate multi-wrap, but wrapping order with other libraries is unpredictable.<br>- <strong>DOM id generation</strong>: <code>ensureId</code> writes ids to host DOM; collisions are resolved but altering host markup may break other code depending on original node structure/ids.<br>- <strong>Inline styles</strong>: <code>injectCaptionForElement</code> sets <code>style.marginTop</code>/<code>marginLeft</code> inline — may violate strict CSP that blocks inline styles; recommend CSS classes instead.<br>- <strong>Logging</strong>: conditional <code>dbg</code>/<code>warn</code> rely on <code>window.tvDebug</code> — safe, but leaking debug output in production could reveal internal behavior.<br>- <strong>Label data trust</strong>: fetched <code>labels</code> are JSON and normalized into DOM text via <code>escapeHtml</code> in injection — good, but ensure <code>build</code>/<code>inject</code> paths always call escapeHtml before innerHTML insertion (they do in this file).<br>- <strong>History mutation</strong>: <code>onTocClick</code> uses <code>history.replaceState</code> without preserving scroll/rest state — acceptable but host should be aware.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Bugs, risky assumptions & edge cases</strong><br>1. <strong>fetchLabels lacks timeout</strong> — <code>fetchLabels</code> uses plain <code>fetch</code> and iterates sequentially; a single slow endpoint can delay fallback resolution. Use <code>fetchJsonOnce</code> or add per-request timeouts. <br>2. <strong>canonKey lossy</strong> — <code>canonKey</code> strips non-alphanumeric only at ends; internal punctuation remains and might produce inconsistent canonical keys across different label sources; consider full-normalization using Unicode <code>\p{L}\p{N}</code> and <code>String.prototype.normalize(&#x27;NFKC&#x27;)</code> for robust matching.<br>3. <strong>ID uniqueness assumptions</strong> — <code>ensureId</code> truncates to 60 chars then linear-probes <code>document.getElementById</code> for collisions. On very large DOMs this loop could be slow; also generating ids from textContent may produce unstable ids if host updates text frequently.<br>4. <strong>injection key instability</strong> — <code>injectCaptionForElement</code> uses <code>dataset.pttAnchorId</code> but assigns it lazily; if anchor elements are re-created (e.g., virtual DOM) keys are lost and suppression may not prevent thrash.<br>5. <strong>overbroad fetch/XHR detection</strong> — substring matching <code>&#x27;/api/group/load&#x27;</code> or <code>&#x27;/api/convert&#x27;</code> may match unrelated endpoints (e.g., <code>/internal/api/group/loadstats</code>) causing extra reloads; consider stricter matching or configurable patterns.<br>6. <strong>applyFragmentIfChanged shallow compare</strong> — it only compares textContent and first anchor href; structural or attribute-only changes will be considered equal and skipped even when they matter (e.g., <code>data-*</code> changes).<br>7. <strong>Unclear error recovery for reloadLabels promise</strong> — code resets <code>window.__ptt_labels_reload_promise</code> in places; concurrent callers may race. Use a single canonical promise and explicit cancelation semantics.<br>8. <strong>MutationObserver scope & filters</strong> — observes entire content root subtree without attribute filters and may trigger on unrelated mutations; heavy pages could see many debounce cycles. Consider <code>characterData</code>/<code>subtree</code> tuning or filtering by added/removed nodes that match selectors.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Maintainability observations</strong><br>- File is well-commented inline and uses consistent defensive style; however pervasive try/catch adds noise and can mask root causes during debugging.<br>- Many globals exposed/used (<code>window.__ptt_labels_reload_promise</code>, <code>window.__ptt_labels_injected</code>, <code>window.PTToc</code>, <code>window.__pt_toc_installed</code>) — document these integration contracts.<br>- Inline style operations and manual DOM creation repeats patterns (e.g., link creation, caption building) — factor into small helpers to reduce duplication.<br>- Wrapping native APIs (<code>fetch</code>, <code>XMLHttpRequest</code>) has maintenance burden and risks; consider event-based hooks (emit/dispatch) instead of global monkey-patching where possible.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Concrete recommended fixes (priority order)</strong><br><strong>High-priority</strong><br>- Replace <code>fetchLabels</code> with a timeout-aware variant (use <code>fetchJsonOnce</code> or add AbortController). <br>- Make <code>/api/*</code> trigger patterns configurable via <code>PTToc.config</code> and use stricter matching (exact path or regex).<br>- Move inline caption styles to CSS class and allow host to override via config, to avoid CSP and styling inconsistencies.<br>- Stabilize injection keys: compute stable keys from element <code>id</code> (ensureId) rather than ephemeral dataset generation; expose a cancellation API for pending injections if node removed. <br><strong>Medium-priority</strong><br>- Strengthen <code>canonKey</code> using <code>String.prototype.normalize(&#x27;NFKC&#x27;)</code> and Unicode-aware normalization; ensure key-matching tests cover non-ASCII scripts.<br>- Improve <code>applyFragmentIfChanged</code> to compare attributes or include a digest (e.g., text+href+dataset keys) to reduce false-negatives/positives.<br><strong>Low-priority / nice-to-have</strong><br>- Consider using <code>Element.replaceChildren()</code> when available for clearer semantics.<br>- Expose <code>PTToc.on(&#x27;labelsUpdated&#x27;, fn)</code> event so hosts can react instead of relying on global mutation scheduling.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Suggested tests</strong><br><strong>Unit</strong>: <code>ensureId</code> uniqueness & determinism with repeated runs and special characters; <code>canonKey</code> normalization across inputs (ASCII & Unicode); <code>normalizeLabels</code> flattening edge cases; <code>captionFor</code> lookup precedence (flat, prefix, padded); <code>itemsSignature</code> stability with whitespace changes. <br><strong>Integration</strong>: <code>fetchJsonOnce</code> timeout behavior; <code>reloadLabels</code> candidate fallback order and cache-bust handling; <code>injectCaptionForElement</code> reuse vs update vs collision path; <code>applyFragmentIfChanged</code> no-op vs replace behavior. <br><strong>E2E</strong>: Page with many dynamic nodes (virtual DOM or frequent mutations) to confirm debounce/injection suppression prevents flicker; pages with CSP forbidding inline-style to verify caption styling still shows when using CSS class fallback.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Compatibility & integration checklist</strong><br>- Document global names and side effects: <code>window.PTToc</code>, <code>window.__ptt_labels_reload_promise</code>, <code>window.__ptt_labels_injected</code>, <code>window.__pt_toc_installed</code>.<br>- Allow overriding of: label candidate list (<code>config.labelsPaths</code>), base expansion (<code>__tv_base</code> used by code), trigger patterns for refresh, debounce/throttle timings, and <code>injectionSuppressMs</code> for tight UIs.<br>- Provide opt-out for network instrumentation (a <code>PTToc.config.disableNetworkWrap = true</code>) to avoid interfering with other global wrappers.<br>- Provide a CSS snippet for <code>.table-caption</code> to avoid reliance on inline styles, and include a class-based fallback path in injection.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Potential regressions to watch for when changing code</strong><br>- Changing <code>ensureId</code> output format or truncation length will break any host code or bookmarks that rely on stable ids.<br>- Altering caption id strategy away from <code>TableNN</code> may break external anchors, legacy links, or host page automation expecting that id format.<br>- Removing or altering fetch/XHR wrappers will change auto-refresh behaviour for conversions and group-loads; document the change and provide migration path.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Final concise verdict</strong><br>Robust, pragmatic TOC/caption module emphasizing non-destructive updates, debouncing, and defensive coding. Well-suited for embedding in varied hosting contexts. Key improvements needed before large-scale deployment: add timeouts to all network fallbacks, harden key/canonicalization for Unicode, make network instrumentation configurable/safer, remove inline styles in favor of CSS classes, and stabilize injection keys to handle dynamic DOM frameworks. After those fixes and a small test-suite (ID/caption/injection/label-load), the module is production-ready for typical documentation and table-heavy pages.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr></tbody></table></div><div class="row-count">Rows: 14</div></div><div class="table-caption" id="Table5" data-table="Docu_0125_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5 • script.save.js</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical breakdown (script.save.js)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical breakdown (script.save.js)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Overview & intent</strong><br>Small, self-contained client-side module that provides a safe, UX-friendly flow for saving Markdown to a server endpoint (<code>/save-md</code>). Responsibilities: read Markdown from page elements, enforce a client-side max payload, prompt for a filename (sanitizing it), POST JSON to the save endpoint, present user-visible status updates (ARIA-friendly), emit namespaced CustomEvents for request/response, and expose a minimal programmatic API (<code>window.PTT_SAVE</code>). Designed to be drop-in via <code>&lt;script src=&quot;assets/script.save.js&quot; defer&gt;&lt;/script&gt;</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>High-level architecture</strong><br>1. <strong>Top-level config constants</strong> — <code>DEFAULT_MAX_PASTE_SIZE</code>, <code>SAVE_ENDPOINT</code>, DOM ID constants, and namespaced event names (<code>ptt:save-md-request</code>, <code>ptt:save-md-response</code>).<br>2. <strong>Utilities</strong> — small helpers for safe string trimming, element text extraction, meta lookup, UTF-8 byte-length calculation, filename sanitization, and debug logging.<br>3. <strong>Network layer</strong> — <code>postSaveMarkdown(markdown, filename, opts)</code> wraps <code>fetch</code> to POST JSON and normalizes server response to <code>{status, ok, json}</code> (JSON parsed with try/catch, non-JSON handled as <code>invalid_server_response</code>).<br>4. <strong>High-level save flow</strong> — <code>doSaveAction(opts)</code> coordinates validation, size enforcement, filename selection, calls <code>postSaveMarkdown</code>, updates status UI, dispatches response events, and returns Promises resolving to result objects for programmatic consumers.<br>5. <strong>Event wiring & host integration</strong> — <code>onSaveButtonClick</code> dispatches a cancelable <code>EVENT_REQUEST_MD</code> to allow integration interception; <code>attachHandlers</code> wires button click, window event listener for programmatic requests, and exposes <code>window.PTT_SAVE</code> API.<br>6. <strong>Initialization</strong> — <code>ready(fn)</code> executes <code>attachHandlers</code> on DOM ready.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Key functions (concise)</strong><br><strong>logDebug(...args)</strong> — Console debug wrapper using <code>console.debug</code> if present; defensive <code>apply</code> call. Useful only in development; no-op when console is absent. <br><strong>safeTrim(s)</strong> — Null-safe <code>String(s).trim()</code> wrapper with try/catch; always returns string. Protects callers from unexpected types or throwing <code>toString</code>. <br><strong>readElementText(id)</strong> — Safely reads an element by ID; returns <code>.value</code> when present, otherwise <code>textContent</code>/<code>innerText</code>, trimmed; returns <code>null</code> on error or if element missing. Used as primary content source for <code>PASTE_ID</code> and fallback area. <br><strong>getMeta(name)</strong> — Returns <code>&lt;meta name=&quot;...&quot;&gt;</code> <code>content</code> attribute or <code>null</code>; defensive try/catch. Used to override client max size via <code>ptt-max-paste-size</code> meta tag. <br><strong>getClientMaxSize()</strong> — Resolution order: <code>window.PTT_CONFIG.MAX_PASTE_SIZE</code> (only when that property is already a finite number), then <code>meta[name=&quot;ptt-max-paste-size&quot;]</code> parsed as int, otherwise <code>DEFAULT_MAX_PASTE_SIZE</code>. Returns integer bytes. <br><strong>utf8BytesLength(str)</strong> — Returns UTF-8 byte length. Preferred implementation uses <code>TextEncoder</code>; fallback uses <code>unescape(encodeURIComponent(str)).length</code>. Defensive try/catch for legacy environments. <br><strong>ensureMdSuffix(filename)</strong> — Ensures <code>.md</code> suffix (case-insensitive) using <code>String.prototype.endsWith</code>. Returns <code>undefined</code>-safe result. <br><strong>promptFilename(defaultName)</strong> — Uses <code>window.prompt</code> to get filename; trims, replaces path separators (<code>[\\/]+</code>) with <code>-</code>, then replaces characters outside <code>[a-zA-Z0-9._\- \u00A0-\uFFFF]</code> with <code>-</code>, caps length at 200, and appends <code>.md</code> if missing. Returns <code>null</code> when cancelled or invalid. Robust for basic localization due to <code>\u00A0-\uFFFF</code> unicode allowance. <br><strong>updateStatus(message, isError)</strong> — Writes message to element with id <code>STATUS_ID</code> if present; otherwise creates a visually-hidden but ARIA-live div (<code>ptt-live-status</code>) and sets <code>textContent</code>. Adds <code>role=&quot;alert&quot;</code> when <code>isError</code> to make screen-readers prioritize. Uses inline styles to hide offscreen element. <br><strong>dispatchResponseEvent(detail)</strong> — Creates and <code>window.dispatchEvent(new CustomEvent(EVENT_RESPONSE_MD, { detail }))</code>. Wraps in try/catch and logs failures. Response event is non-cancelable and bubbles. <br><strong>postSaveMarkdown(markdown, filename, opts)</strong> — Posts <code>{&quot;markdown&quot;, &quot;filename&quot;}</code> as JSON to <code>SAVE_ENDPOINT</code> via <code>fetch</code>. Uses <code>credentials</code> default <code>&#x27;same-origin&#x27;</code>, <code>cache: &#x27;no-store&#x27;</code>. Parses response as text then tries <code>JSON.parse</code>; on parse failure returns <code>{ok:false,error:invalid_server_response}</code> shape inside <code>json</code>. Always resolves a Promise with <code>{status, ok, json}</code>; network errors bubble to <code>.catch</code> in caller. <br><strong>doSaveAction(opts)</strong> — High-level flow: read markdown (from opts or DOM), validate presence, enforce size limit using <code>getClientMaxSize</code> and <code>utf8BytesLength</code>, determine filename (opts → prompt using document title fallback → cancellation handling), update status, call <code>postSaveMarkdown</code>, handle success (update status, create link if <code>json.url</code> present, dispatch response event with success detail), handle server error and network error paths. Errors are returned as resolved Promises with consistent error objects to simplify host code. Wraps most operations in try/catch and returns <code>Promise.resolve(...)</code> on synchronous errors. <br><strong>onSaveButtonClick(e)</strong> — Prevents default, dispatches a cancelable <code>EVENT_REQUEST_MD</code> (integrators may call <code>preventDefault()</code> on that event to cancel save). If not canceled, reads <code>detail.markdown</code> or UI sources and <code>detail.filename</code>, then calls <code>doSaveAction</code>. Catches and logs handler errors. <br><strong>attachHandlers()</strong> — Finds save button by <code>SAVE_BTN_ID</code> and attaches <code>onSaveButtonClick</code> unless <code>btn.dataset.__tv_save_attached</code> indicates core claimed it, or this script already attached <code>__ptt_save_md_attached</code>. Adds a global <code>window</code> listener for <code>EVENT_REQUEST_MD</code> allowing programmatic saves (<code>{ markdown, filename }</code>). Exposes <code>window.PTT_SAVE</code> API with <code>save(opts)</code> and <code>getClientMaxSize()</code>, or if <code>PTT_SAVE</code> already exists, attaches <code>saveMd</code>. Defensive dataset writes wrapped in try/catch. <br><strong>ready(fn)</strong> — DOM ready helper: if <code>document.readyState</code> is <code>&#x27;complete&#x27;</code> or <code>&#x27;interactive&#x27;</code> call <code>fn</code> via <code>setTimeout(fn,0)</code> else attach <code>DOMContentLoaded</code> with <code>{ once: true }</code>. </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Defensive patterns used</strong><br>- <strong>Widespread <code>try/catch</code></strong> around operations that touch DOM, <code>prompt</code>, <code>fetch</code>, <code>TextEncoder</code>, or <code>console</code>.<br>- <strong>Fail-safe return shapes</strong>: functions like <code>postSaveMarkdown</code> and <code>doSaveAction</code> always resolve with an object describing success or failure instead of throwing — simplifies host integration.<br>- <strong>Feature detection</strong>: <code>TextEncoder</code> usage guarded with try/catch; <code>console.debug</code> used only when available; safe checks for <code>btn.dataset</code> existence.<br>- <strong>Input sanitization</strong>: <code>promptFilename</code> removes path separators and strips disallowed characters; <code>ensureMdSuffix</code> guards filename extension.<br>- <strong>ARIA fallback</strong>: <code>updateStatus</code> uses a hidden ARIA-live element when <code>STATUS_ID</code> is absent so screen readers still receive updates.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Notable behaviors & compatibility choices</strong><br>- <code>getClientMaxSize</code> only accepts <code>window.PTT_CONFIG.MAX_PASTE_SIZE</code> if it is already a numeric primitive (uses <code>Number.isFinite</code>), ignoring numeric strings. Meta tag <code>ptt-max-paste-size</code> is supported and parsed via <code>parseInt</code>.<br>- <code>utf8BytesLength</code> prefers <code>TextEncoder</code> but falls back to <code>unescape(encodeURIComponent(...))</code> for older browsers — a tried pattern for byte counting.<br>- Uses <code>CustomEvent</code> (may need polyfill on older IE).<br>- Default <code>fetch</code> credentials include cookies (<code>same-origin</code>), meaning server-side CSRF protections should be present; module does not add CSRF headers itself.<br>- The module expects reasonably modern browsers (ES6 methods like <code>endsWith</code>, <code>Number.isFinite</code>, <code>TextEncoder</code>) but keeps defensive fallbacks for some features.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Performance & scalability notes</strong><br>- All work is synchronous or single-request per save; memory/CPU impact negligible for typical Markdown sizes under configured limit.<br>- <code>utf8BytesLength</code> fallback builds an encoded string and counts length — O(n) CPU and memory proportional to the text; acceptable within default max (1,000,000 bytes) but large payloads could be heavier on low-memory devices.<br>- No streaming or chunked upload support — entire Markdown payload sent in a single JSON body. For very large content consider file-upload endpoint or multipart/form-data to avoid JSON size limits.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Security, privacy & CSP considerations</strong><br>- <strong>CSRF:</strong> <code>fetch</code> uses <code>credentials: &#x27;same-origin&#x27;</code> so cookies will be sent. Server must validate CSRF tokens or use same-site cookies. The script does not automatically include an <code>X-CSRF-Token</code> header; consider reading a meta tag (e.g., <code>&lt;meta name=&quot;csrf-token&quot;&gt;</code>) and sending it in <code>postSaveMarkdown</code> when present.<br>- <strong>Filename sanitization:</strong> <code>promptFilename</code> removes slashes and disallowed characters but still allows <code>.</code> and <code>..</code> sequences in principle (though slashes are removed); server MUST validate and canonicalize <code>filename</code> and reject attempts to write outside allowed directories.<br>- <strong>XSS exposure in status area:</strong> <code>updateStatus</code> uses <code>textContent</code> (safe). When constructing an anchor in success path, it sets <code>href</code> directly from server <code>json.url</code>; if server is untrusted it could contain <code>javascript:</code> — recommend validating/normalizing server-provided URLs before inserting into DOM or set <code>a.rel=&#x27;noopener noreferrer&#x27;</code> (already set) and rely on <code>a.target=&#x27;_blank&#x27;</code> to open in new tab. The code sets <code>rel</code> and <code>target</code> appropriately. <br>- <strong>Prompt dialog</strong> can be abused by the hosting page or extensions; limiting filename character set is good practice. <br>- <strong>CSP:</strong> <code>updateStatus</code> injects a visually-hidden div and uses inline <code>style</code> assignments. In strict CSP environments that disallow inline styles this will still work because style is set via <code>el.style</code> (which is allowed), but if inserting inline <code>innerHTML</code> were used it could be blocked — this script does not use <code>innerHTML</code> for status.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Bugs / risky assumptions / edge cases</strong><br>1. <strong><code>getClientMaxSize</code> strict numeric check</strong> — The condition <code>Number.isFinite(window.PTT_CONFIG.MAX_PASTE_SIZE)</code> requires a numeric primitive. If integrators set <code>window.PTT_CONFIG.MAX_PASTE_SIZE = &quot;1000000&quot;</code> (string) it will be ignored; consider using <code>Number(window.PTT_CONFIG.MAX_PASTE_SIZE)</code> and <code>Number.isFinite</code> on the result.<br>2. <strong><code>endsWith</code> and <code>Number.isFinite</code> compatibility</strong> — These ES6 APIs are used without polyfill; older browsers (IE11) may fail. The script partially guards some features but not all. <br>3. <strong>CustomEvent and fetch assumptions</strong> — <code>CustomEvent</code> and <code>fetch</code> are broadly supported in modern browsers but not in very old ones; integration requiring legacy browser support will need polyfills. <br>4. <strong>Server non-JSON responses</strong> — <code>postSaveMarkdown</code> treats non-JSON server responses as <code>invalid_server_response</code> but still returns 200/ok if fetch succeeded; callers may expect structured error codes — ensure server returns predictable JSON. <br>5. <strong>Filename length & character set</strong> — <code>promptFilename</code> allows many Unicode characters up to <code>\uFFFF</code> but server/OS filesystems may not accept them. Server-side validation is required. <br>6. <strong>No cancellation for in-flight save</strong> — There is no AbortController or cancel API. If user closes the page or wants to cancel an ongoing save, no client-side cancellation exists. <br>7. <strong>No progress UI</strong> — <code>updateStatus(&#x27;Saving…&#x27;)</code> is textual only; network progress feedback (percent) not available for <code>fetch</code> JSON body requests. <br>8. <strong>Potential double-dispatch semantics</strong> — The module both dispatches <code>EVENT_REQUEST_MD</code> from <code>onSaveButtonClick</code> and listens for window <code>EVENT_REQUEST_MD</code> in <code>attachHandlers</code>. These have different intents (one is a cancelable outward event; the other listens for programmatic inbound requests). It's correct but could confuse integrators expecting symmetrical semantics.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Maintainability observations</strong><br>- File is short (~200–300 LOC) and well compartmentalized — good for maintenance.<br>- Clear separation between utilities, network, flow, and event wiring.<br>- Many <code>try/catch</code> blocks increase resilience but can hide bugs during development; consider enabling <code>logDebug</code> behind a runtime flag for better diagnostics.<br>- Global names introduced: <code>window.PTT_SAVE</code>, <code>ptt:save-md-request</code>, <code>ptt:save-md-response</code>, and <code>ptt-live-status</code>. Document these in integration docs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Concrete recommended fixes (priority order)</strong><br><strong>High-priority</strong><br>- <strong>Accept numeric-string config</strong>: change <code>getClientMaxSize</code> to coerce <code>window.PTT_CONFIG.MAX_PASTE_SIZE</code> using <code>Number(...)</code> then test <code>Number.isFinite(result)</code> so integrators using strings are supported.<br>- <strong>CSRF token support</strong>: read common meta names (e.g., <code>meta[name=&quot;csrf-token&quot;]</code>) and send an <code>X-CSRF-Token</code> header in <code>postSaveMarkdown</code> if present. Document server expectations. <br>- <strong>Filename server-side validation reminder</strong>: Add explicit comment/documentation warning that server must validate <code>filename</code> and not rely solely on client sanitization. <br><strong>Medium-priority</strong><br>- <strong>Add cancel API</strong>: expose a cancel mechanism (e.g., return an object from <code>doSaveAction</code> that includes an <code>abort()</code> using <code>AbortController</code> wired into <code>fetch</code>) so callers can cancel in-flight saves.<br>- <strong>Polyfills or graceful degradation for older browsers</strong>: either polyfill <code>CustomEvent</code>, <code>fetch</code>, <code>TextEncoder</code>, <code>endsWith</code>, <code>Number.isFinite</code> or detect and provide a clear no-op fallback and a console warning. <br>- <strong>Configurable endpoint</strong>: make <code>SAVE_ENDPOINT</code> overrideable via <code>window.PTT_CONFIG.SAVE_ENDPOINT</code> to avoid hardcoding. <br><strong>Low-priority / nice-to-have</strong><br>- Provide progress UI (upload progress) by switching to <code>XMLHttpRequest</code> for large payloads or use <code>fetch</code> with <code>ReadableStream</code> when supported.<br>- Allow injecting a <code>statusElement</code> or callback for host apps that want custom UI handling.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Suggested tests</strong><br><strong>Unit tests</strong>: <code>safeTrim</code> with edge types; <code>readElementText</code> on inputs and non-input elements; <code>getClientMaxSize</code> with numeric primitive, numeric string, meta tag present/absent; <code>utf8BytesLength</code> against known Unicode strings (ASCII, multi-byte, emojis); <code>ensureMdSuffix</code> with <code>.MD</code> uppercase; <code>promptFilename</code> sanitization for path-traversal chars and long names; <code>postSaveMarkdown</code> mock <code>fetch</code> returning JSON and non-JSON (text) to verify normalization.<br><strong>Integration tests</strong>: full <code>doSaveAction</code> flow against a test server verifying cookies/CSRF handling, saved file metadata returned, and link creation behavior; test <code>EVENT_REQUEST_MD</code> cancelation via <code>preventDefault()</code> on request event.<br><strong>E2E / load</strong>: attempt saving a near-limit payload (just under <code>MAX_PASTE_SIZE</code>) and one just above, confirm client rejects large payload; test upload on mobile/low-memory devices.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Compatibility & integration checklist</strong><br>- Document global API and events: <code>ptt:save-md-request</code> (cancelable), <code>ptt:save-md-response</code> (non-cancelable), and <code>window.PTT_SAVE.save(opts)</code> / <code>getClientMaxSize()</code>.<br>- Document server contract: expected JSON shape on success (<code>{ ok:true, filename, url, size, id, rel_path }</code>) and on error; require server to validate filename and enforce write paths.<br>- Recommend server return <code>Content-Type: application/json; charset=utf-8</code> and meaningful <code>status</code> codes for easier client diagnostics.<br>- Provide guidance for integrators that want to supply custom <code>SAVE_ENDPOINT</code>, custom status element id, or to opt out of prompt UX.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Potential regressions to watch for when changing code</strong><br>- Relaxing filename sanitization may introduce filesystem/path risks if server code relies on client sanitization (server must remain authoritative).<br>- Changing <code>getClientMaxSize</code> behavior may allow much larger payloads to be attempted — ensure server and network path can handle them.<br>- Introducing AbortController without fallback could break older browsers unless guarded.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical breakdown (script.save.js)"> <strong>Final concise verdict</strong><br>Well-scoped, defensive, and pragmatic save helper suitable for modern browsers. It correctly balances UX (prompt + status + ARIA) and robustness (many try/catch blocks, normalized fetch responses). Priorities before production hardening: accept numeric-string <code>PTT_CONFIG</code> values, add CSRF header support, and expose cancellation for in-flight saves. After those changes and adding a small integration note about server-side filename validation, the module is production-ready for single-page sites and progressive integrations.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr></tbody></table></div><div class="row-count">Rows: 14</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>