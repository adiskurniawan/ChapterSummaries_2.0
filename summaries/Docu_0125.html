<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1763481230">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0125_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1 • script.core.js</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by "><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label=""> <strong>Summary / Purpose</strong><br><br><code>script.core.js</code> is a self-contained client-side module that provides the core runtime for PasteToTable: UI utilities (toasts, clipboard, downloads), conversion orchestration (POST <code>/api/render</code>), DOM rendering of server HTML, caption injection based on externally-loaded <code>labels_injected.json</code>, lightweight TOC loader (<code>script.toc.js</code>), and safe attach/detach of event handlers. The file emphasizes resilience and “best-effort” behavior: nearly every operation is wrapped with <code>try/catch</code> to avoid runtime failures propagating to host pages. Primary responsibilities: reliable conversion workflow (<code>__tv_do_convert</code>), robust caption injection and labels/toc installation (<code>installTocAndLabels</code>, <code>__ptt_apply_injected_captions</code>), progressive script loading (<code>loadExtraSequentially</code>), and utility helpers used across the UI. The module is intentionally defensive and designed to run in varied embedding contexts (iframes, different hosts) with minimal assumptions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label=""> <strong>High-level guarantees & design principles</strong><br><br>• <strong>Fail-safe / non-throwing</strong>: functions use <code>try/catch</code> liberally so the script degrades silently on failure rather than crashing the host page. <br>• <strong>Idempotence & non-destructiveness</strong>: caption injection is idempotent (reuses existing captions when present) and avoids overwriting non-caption nodes with the same ID. <br>• <strong>Progressive enhancement</strong>: loads <code>extra.js</code>, <code>script.toc.js</code>, and <code>labels_injected.json</code> opportunistically from multiple candidate URLs, tolerating fetch failures or timeouts. <br>• <strong>DOM-first short-circuiting</strong>: many helpers check for <code>document.readyState</code> and either run immediately or attach <code>DOMContentLoaded</code> callbacks. <br>• <strong>Minimal global pollution</strong>: exposes a small surface (<code>window.tvUtils</code>, <code>window.PasteToTable.processRenderedHtml</code>, <code>window.__ptt_apply_injected_captions</code>, common aliases) but otherwise keeps helpers scoped to the IIFE. <br>• <strong>Best-effort UX</strong>: toast durations, clipboard fallbacks, and download fallbacks are implemented to maximize success across browsers.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label=""> <strong>Top-level structure & exports</strong><br><br>• <strong>Exports / globals set</strong>: <code>window.tvUtils</code> (copyToClipboard, sanitizeFileName, downloadBlob, showToast, debounce, getSearchEl), <code>window.__tv_utils</code> (internal variants), <code>window.PasteToTable.processRenderedHtml</code>, <code>window.showToast/downloadBlob/copyToClipboard/sanitizeFileName</code> aliases, <code>window.__ptt_apply_injected_captions</code>, <code>window.__ptt_labels_injected</code> (labels map), <code>window.__ptt_toc_and_labels_installed</code> (status), <code>window.__tv_do_convert</code> (conversion entrypoint). <br>• <strong>Major functional groups</strong>: configuration & base detection; debug logging helpers; network & script loaders (<code>loadExtraSequentially</code>, <code>fetchJsonWithTimeout</code>, <code>tryLoadLabels</code>, <code>installTocScript</code>); caption injection logic; conversion & rendering (<code>__tv_do_convert</code>, <code>processRenderedHtml</code>); UI helpers (toasts, clipboard, downloads); event wiring (convert button delegation, action dispatcher); header and attach helpers.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label=""> <strong>Key components & responsibilities (concise)</strong><br><br>1. <strong>Configuration & base detection</strong> — <code>detectScriptBase</code> computes <code>TV_BASE</code>; <code>window.tvConfig</code> established with defaults (highlight, debounceMs, chunkSize). <br>2. <strong>Resilient logging</strong> — <code>dbgInfo</code>, <code>dbgWarn</code>, <code>dbgDebug</code>, <code>dbgError</code> gate console calls on <code>window.tvDebug</code>. <br>3. <strong>Script & asset loader</strong> — <code>loadExtraSequentially</code> and <code>startExtraLoader</code> try multiple candidate paths sequentially; <code>installTocScript</code> wraps that to load <code>script.toc.js</code>. <br>4. <strong>Labels loader</strong> — <code>fetchJsonWithTimeout</code> (AbortController/timeouts fallback) + <code>tryLoadLabels</code> produce a labels map used for caption injection. <br>5. <strong>Caption injection</strong> — <code>__ptt_apply_injected_captions</code> and related helpers (<code>captionFor</code>, <code>injectCaptionForElement</code>) find per-table captions in <code>labels_injected.json</code> and inject or reuse <code>.table-caption</code> elements <em>before</em> the table (important: caption is inserted before the table/collapse toggle). Behavior includes preferring <code>Table{n}</code> id when available, avoiding id collisions with non-caption elements, setting <code>data-table=&quot;&quot;</code>, and inline margins. <br>6. <strong>Renderer orchestration</strong> — <code>__tv_do_convert</code> does POST <code>/api/render</code> (with fallback form-encoded), obtains JSON or HTML payload, and delegates to <code>PasteToTable.routeHtmlToAreas</code> or directly injects into <code>#tables-viewer</code>. <br>7. <strong>processRenderedHtml</strong> — central DOM insertion flow used by <code>__tv_do_convert</code> and consumers; manages <code>__tv_skip_scroll</code> coordination, schedules <code>initRenderedContent</code>, triggers TOC/labels install when <code>metadata.fromList</code> is true, and coordinates scroll-to-top retries. <br>8. <strong>UI helpers</strong> — toasts implementation (<code>showToast</code>, queue, styles, accessibility attributes), clipboard (<code>copyToClipboard</code> with legacy fallback), file download (<code>downloadBlob</code>), debounce, sanitizeFileName. <br>9. <strong>Event wiring</strong> — global convert click delegation, direct attachment to <code>#convertBtn</code>, header handlers (convert/clear/save/render/export). <br>10. <strong>Defensive utilities</strong> — <code>ensureId</code>, <code>escapeHtml</code>, <code>sanitizeForId</code>, <code>normalizeForSearchLocal</code>, small duplication of helpers exists in nested IIFEs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label=""> <strong>Detailed behavior & important implementation notes</strong><br><br><strong>Caption injection specifics</strong> — The injection flow is a focal point:<br>• The labels loader attempts multiple candidate URLs with a short timeout (2.2s in <code>tryLoadLabels</code> / 2.5s default in <code>fetchJsonWithTimeout</code>) and resolves to an object (<code>window.__ptt_labels_injected</code>).<br>• <code>__ptt_apply_injected_captions</code> builds a prioritized list of candidate prefixes (from body <code>data-file</code>/<code>data-source</code>, location basename, document.title, and prefixes inferred from labels keys). It iterates document tables in DOM order and, for each table index <code>idx</code> (1-based), tries a set of key shapes (<code>pref_01</code>, <code>pref_1</code>, <code>pref-01</code>, <code>pref01</code>, etc.) and fallback numeric keys (<code>&#x27;01&#x27;</code>, <code>&#x27;1&#x27;</code>).<br>• When a caption is available, it attempts to use <code>id=&#x27;Table{n}&#x27;</code> for the caption element. If an element with that id exists and is a <code>.table-caption</code>, it updates and reuses it. If an element with that id exists but is not a caption, it finds a unique suffixed id (<code>Table{n}-1</code>, <code>-2</code>, …) to avoid collisions.<br>• Captions are created as <code>&lt;div class=&quot;table-caption&quot; id=&quot;...&quot;&gt;</code> with <code>data-table=&quot;&quot;</code> and inline <code>style.marginTop=&#x27;2mm&#x27;</code> / <code>marginLeft=&#x27;3mm&#x27;</code>. The caption content is inserted using <code>textContent</code> for the <code>strong</code> element (safer) in most places; in one helper copy it uses <code>innerHTML = &#x27;&lt;strong&gt;&#x27; + escapeHtml(...) + &#x27;&lt;/strong&gt;&#x27;</code> (consistent escaping applied). Captions are <em>inserted before the table</em> using <code>parentNode.insertBefore(wrap, tbl)</code> or <code>insertAdjacentElement(&#x27;beforebegin&#x27;, wrap)</code> as fallback.<br><br><strong>Network & loader behavior</strong> — <code>loadExtraSequentially</code> uses synchronous script injection (<code>async: false</code>) via <code>&lt;script&gt;</code> elements appended to <code>&lt;head&gt;</code> and falls back to retrying the next path on <code>onerror</code>. <code>fetchJsonWithTimeout</code> uses <code>AbortController</code> when available and falls back to a timer-based cancel; it always resolves to <code>null</code> on failure (never rejects), in keeping with the fail-safe design.<br><br><strong>Conversion & rendering</strong> — <code>__tv_do_convert</code> tracks <code>window.__tv_convert_in_progress</code> to avoid concurrent conversions, prefers JSON <code>/api/render</code> responses, and gracefully downgrades to inserting HTML string payloads. It ensures <code>payload.metadata.fromList</code> is set only from the caller <code>opts.metadata.fromList</code> (server metadata is not trusted for this flag). After DOM insertion it schedules two <code>initRenderedContent</code> calls (60ms and 420ms) to help downstream scripts initialize. When the conversion is <code>fromList</code>, <code>processRenderedHtml</code> triggers TOC/labels install and then <code>__ptt_apply_injected_captions</code> plus PTToc build hooks where available.<br><br><strong>Toasts & accessibility</strong> — the toast container has <code>role=&quot;status&quot; aria-live=&quot;polite&quot; aria-atomic=&quot;true&quot;</code>. Toasts compute duration dynamically from message length and type, and include manual dismiss buttons. Visual styling is applied inline and color choices are changed for <code>success/warn/error</code> types (note: contrasting color choices are done inline and not via CSS class tokens).<br><br><strong>Defensive programming patterns</strong> — almost every DOM and network operation are wrapped in <code>try/catch</code>; many asynchronous flows swallow errors and record debug warnings only when <code>TV_DEBUG</code> or specific debug flags are set. Functions that mutate global state set idempotent guards (<code>window.__tv_extra_loader_attached</code>, <code>window.__tv_convert_delegation_attached</code>, <code>_attached</code> flags on attachHeaderHandlersOnce) to avoid double attachment. </td></tr><tr><td data-label=""> <strong>Error handling, robustness & failure modes</strong><br><br>• <strong>Non-throwing fail-fast semantics</strong>: the script prefers returning <code>null</code>/<code>false</code> or swallowing errors rather than propagating exceptions. This prevents the host page from breaking but can mask root causes during debugging. <br>• <strong>Partial success paths</strong>: failing to load labels or TOC scripts merely disables caption injection/TOC build; conversion still proceeds and DOM is updated from server payloads. <br>• <strong>Race conditions with DOM readiness</strong>: multiple places attach <code>DOMContentLoaded</code> or check <code>document.readyState</code>; however, asynchronous installs (labels/toc) may complete after <code>processRenderedHtml</code> and re-run caption application — code attempts to handle this via idempotence but timing-sensitive corner cases may remain. <br>• <strong>ID collision handling</strong>: careful handling prevents overwriting existing non-caption elements with <code>Table{n}</code> ids, but if a host page later mutates the DOM to remove or rename elements, captions may not find their intended anchor. <br>• <strong>Network timeouts & format variance</strong>: <code>fetchJsonWithTimeout</code> will return <code>null</code> for non-JSON (or slow) responses; <code>tryLoadLabels</code> resolves to <code>{}</code> if no candidate provides usable JSON. Labels file shape variance (flat keys, nested objects, zero-padded keys) is handled with multiple fallbacks, but unusual formats may still fail to match. <br>• <strong>Silent failure logging</strong>: unless debug flags are enabled, most failures are silent, which is safe but can hurt observability.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label=""> <strong>Concurrency / performance considerations</strong><br><br>• <strong>Conversion deduping</strong>: <code>window.__tv_convert_in_progress</code> prevents concurrent conversions; click-delegation guards prevent duplicate click handling via <code>__tv_convert_handled</code> on events. <br>• <strong>Sequential script loading</strong>: <code>loadExtraSequentially</code> tries candidate URLs one-by-one — this is slow if early candidates are unreachable but safe; the short retry delays (20ms) minimize total wait. <br>• <strong>Caption injection cost</strong>: <code>__ptt_apply_injected_captions</code> iterates all document tables and performs DOM insertions; on very large documents this is O(n) and could be noticeable. The function avoids heavy work when no labels are present. <br>• <strong>Toasts queue</strong>: single active toast with queueing keeps DOM updates small; durations scale with length but are bounded. <br>• <strong>Frequent try/catch</strong>: the pervasive use of <code>try/catch</code> has a measurable cost in hot loops; however, most functions are not performance-critical except table iteration. <br>• <strong>Network timeouts tuned for speed</strong>: label/timeouts are short (2–2.5s) to avoid blocking UX, which may lead to false negatives on slow networks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label=""> <strong>Edge cases & brittle areas</strong><br><br>1. <strong>Duplicate helper definitions</strong> — <code>_normalizeKey</code>, <code>buildPrefixCandidatesFromLabels</code>, and similar helper logic are defined more than once in nested IIFEs (observed duplication in the toc/labels IIFE). This increases maintenance burden and risk of divergence. <br>2. <strong>ID collision complexity</strong> — <code>Table{n}</code> id preference is sensible, but edge cases include servers that already emitted <code>Table{n}</code> for non-caption elements, or when multiple documents share the same DOM and IDs persist between renders. The script attempts to detect and suffix, but collisions can still produce confusing ids. <br>3. <strong>XSS risks & escaping inconsistency</strong> — most caption text is safely assigned using <code>textContent</code> on the created <code>strong</code> element; in a few helper paths the code uses <code>innerHTML = &#x27;&lt;strong&gt;&#x27; + escapeHtml(...) + &#x27;&lt;/strong&gt;&#x27;</code> which is safe if <code>escapeHtml</code> is correct (it is present), but mixed use introduces maintenance risk. Always prefer <code>textContent</code>. <br>4. <strong>Network assumptions</strong> — candidate paths assume <code>TV_BASE</code> correctness and same-origin behavior; some candidate URLs are root-absolute (<code>/labels_injected.json</code>) which may not be present in certain embedding scenarios. <br>5. <strong>Labels format variance</strong> — deeply nested or unexpected keys in labels JSON may not be matched by the key-shape heuristics; mapping logic is complex and can miss cases. <br>6. <strong>Orphaned temp state</strong> — not applicable here, but orphaned injected caption elements may persist across repeated renders if the viewer reuses the same container without a clean-up step. <br>7. <strong>Accessibility</strong> — toasts have ARIA attributes, but inserted captions lack explicit ARIA roles (they are purely presentational) — acceptable for captions but could be enhanced for screen reader announcement.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label=""> <strong>Integration points & extension hooks</strong><br><br>• <strong>Expose a single canonical helper module</strong> — consolidate duplicated helpers (<code>_normalizeKey</code>, <code>sanitizeForId</code>, <code>buildPrefixCandidatesFromLabels</code>) into <code>window.__tv_utils</code> and import from there to reduce duplication. <br>• <strong>Pluggable caption renderer</strong> — expose a hook like <code>window.__ptt_render_caption = function(el, captionText, idx) { /* custom */ }</code> so host pages can customize markup or aria attributes. <br>• <strong>Configurable timeouts & candidates</strong> — allow host to override label/script candidate arrays and fetch timeouts via <code>window.tvConfig</code> or <code>document.body</code> attributes. <br>• <strong>Observability hooks</strong> — emit custom events (e.g., <code>document.dispatchEvent(new CustomEvent(&#x27;ptt:captionsApplied&#x27;,{detail:{injectedCount: X}}))</code>) for analytics and debugging. <br>• <strong>Optional locking / dedupe</strong> — provide an API to remove stale captions before injecting or to scope captions to the viewer subtree (e.g., <code>#tables-viewer</code>) to avoid affecting unrelated tables on host pages.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label=""> <strong>Recommendations & maintainability notes</strong><br><br>• <strong>Deduplicate helper logic</strong>: centralize helpers used in multiple IIFEs (<code>_normalizeKey</code>, <code>buildPrefixCandidatesFromLabels</code>, <code>sanitizeForIdLocal</code> etc.) into <code>window.__tv_utils</code> to reduce drift. <br>• <strong>Prefer <code>textContent</code> over <code>innerHTML</code></strong> for caption insertion to avoid reliance on escaping and reduce XSS risk. Replace <code>innerHTML = &#x27;&lt;strong&gt;...&lt;/strong&gt;&#x27;</code> with <code>const s=document.createElement(&#x27;strong&#x27;); s.textContent=...; wrap.appendChild(s);</code>. <br>• <strong>Increase observability under debug mode</strong>: consolidate debug logs behind <code>TV_DEBUG</code> and optionally surface non-fatal issues via <code>showToastOnce</code> or a debug console element for integrators. <br>• <strong>Parameterize timeouts & candidate lists</strong> via <code>window.tvConfig</code> so embedding pages can tune for slow networks or different asset layouts. <br>• <strong>Document labels JSON shape</strong> and prefer a normalized lookup helper (single canonical <code>captionFor(labelsObj, prefix, idx)</code> exported) to simplify matching logic and reduce duplicate code paths. <br>• <strong>Add cleanup hooks</strong>: before injecting captions, optionally remove captions that were injected by previous runs inside the same viewer container to avoid duplication when HTML is re-rendered into the same element. <br>• <strong>Unit/integration tests</strong>: add tests for caption id collision resolution, labels formats (flat, nested, zero-padded), slow network/timeouts, and conversion error paths. <br>• <strong>Accessibility</strong>: consider adding <code>aria-describedby</code> or linking table <code>id</code> to caption <code>id</code> where semantic connection is desired (if not interfering with existing semantics).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label=""> <strong>Short checklist of behaviors to verify when integrating</strong><br><br>• Script initializes <code>TV_BASE</code> and sets <code>window.tvConfig</code> defaults. <br>• <code>loadExtraSequentially</code> attempts each candidate path and calls <code>onDone</code> on first success; <code>startExtraLoader</code> respects idempotent guards. <br>• <code>tryLoadLabels</code> returns <code>{}</code> when no valid JSON is found; <code>installTocAndLabels</code> populates <code>window.__ptt_labels_injected</code> and <code>window.__ptt_toc_and_labels_installed</code>. <br>• <code>__ptt_apply_injected_captions</code> uses inferred prefixes and numeric fallbacks to find captions; inserts <code>.table-caption</code> elements <strong>before</strong> their related <code>&lt;table&gt;</code>; prefers <code>id=&quot;Table{n}&quot;</code> when available and avoids replacing non-caption elements with same id. <br>• <code>__tv_do_convert</code> posts to <code>/api/render</code>, handles JSON or HTML responses, and delegates to <code>PasteToTable.routeHtmlToAreas</code> when available; conversion flow sets and clears <code>__tv_convert_in_progress</code>. <br>• Toasts queueing, dismiss, and accessibility attributes behave as expected; <code>downloadBlob</code> and clipboard fallbacks work in legacy browsers. <br>• Event handlers for convert, clear, save, render, and action dispatching attach once and do not duplicate.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label=""> <strong>Conclusion</strong><br><br><code>script.core.js</code> is a pragmatic, defensive core suitable for embedding in diverse host pages. It correctly implements caption injection behavior required by PasteToTable: preferring <code>Table{n}</code> ids, inserting captions before the table/collapse toggle, reusing existing caption elements, and robustly loading external labels/toc scripts with sensible fallbacks. Maintenance priorities are (1) deduplicating helper functions, (2) reducing mixed use of <code>innerHTML</code> vs <code>textContent</code> for safety, (3) improving observability under debug mode, and (4) adding configurable timeouts and candidate lists for asset loading. With those changes the module will be easier to test and extend while retaining the current resilience and UX-oriented fallbacks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr></tbody></table></div><div class="row-count">Rows: 12</div></div><div class="table-caption" id="Table2" data-table="Docu_0125_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2 • script.list.js</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Summary / Purpose</strong><br> <code>script.list.js</code> is the list-and-groups UI subsystem for PasteToTable. It is responsible for discovering saved files on the server, normalizing heterogeneous index formats, constructing logical groups from file paths, resolving descriptive captions via a tolerant labels index, presenting an accessible modal UI for browsing and loading groups, enabling an in-browser file-level search engine optimized for caption-first matching, and providing two fire-and-forget server interactions: (1) frontend label injection (flat mapping POST to <code>/api/group/load</code>) and (2) structured group metadata posting for analytics/audit. The module is defensive: pervasive <code>try/catch</code>, short fetch timeouts, sequential candidate probing, idempotent UI attachment, and explicit fallbacks ensure the UX remains responsive in most embedding environments.<br> <strong>Design intent:</strong> prioritize resiliency and predictability over speculative heuristics; avoid catastrophic failures that break host pages; make the UI fast and readable even on degraded networks; preserve maximal interoperability with <code>script.core.js</code> by producing canonical outputs and exposing minimal transient state (<code>window.__ptt_runtime_captions</code>, <code>window.__ptt_list_render_in_progress</code>).<br> <strong>Primary guarantees:</strong> network calls never throw to the host, parsing tolerates multiple server shapes, caption resolution prefers longest/most-specific matches, file loads are sequential and bounded, search scoring favors caption matches, modal is keyboard-accessible, and all client-posted payloads use same-origin credentials and JSON content types to align with standard server expectations. </td></tr><tr><td data-label="Technical Breakdown"> <strong>High-level guarantees & design principles</strong><br> • Fail-safe network behavior: every fetch uses <code>fetchWithTimeout</code> with <code>AbortController</code> fallback; results are normalized into <code>{ok,status,url,body,err}</code> so callers can make deterministic decisions without try/catch around fetch returns. <br> • Idempotent UI wiring: <code>attachListHandler</code> sets a dataset flag to prevent duplicate event registration; modal creation is self-contained and removes its event listeners on close. <br> • Defensive parsing and normalization: <code>normalizeIndexData</code> and <code>tryParseListBodyAsArray</code> accept arrays of strings, arrays of objects, objects with a <code>files</code> array, and plain newline-separated listings. <br> • Progressive enhancement: label and groups candidate paths are probed sequentially with short timeouts to avoid blocking the primary live-file discovery. <br> • Accessibility by construction: modal uses <code>role=&quot;dialog&quot; aria-modal=&quot;true&quot;</code>, search control has <code>aria-label</code>, toggle buttons use <code>aria-expanded</code>, and expand-all uses <code>aria-pressed</code>; focus management returns logical focus to the modal panel after insertion. <br> • Minimal global pollution: all code scoped in an IIFE; public integration points are explicit and limited (<code>window.__tv_do_convert</code>, <code>window.showToast</code>, <code>window.__ptt_runtime_captions</code>). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Top-level structure & exports</strong><br> • All code is inside an IIFE and attaches no new global functions except to integrate with the renderer and optional host hooks. <br> • Core sections: configuration constants (candidate paths, timeouts, limits), network helpers (<code>fetchWithTimeout</code>, <code>fetchFileWithTimeout</code>), normalizers (<code>normalizeIndexData</code>, <code>tryParseListBodyAsArray</code>, <code>basenameFromPath</code>, <code>removeExtension</code>), label index builders (<code>keyVariants</code>, <code>canonKey</code>, <code>buildLabelIndex</code>, <code>resolveCaptionFor</code>), groups loader (<code>loadGroupDescriptions</code>, <code>buildGroupsFromLive</code>), search engine (<code>createFileSearchEngine</code>), UI (<code>createModal</code>, <code>presentGroupsOnly</code>), file loader (<code>loadFilesSequentialAndHideForm</code>), label injection (<code>tryInjectLabels</code>), metadata posting (<code>trySendActiveGroupMetadata</code>), attach/boot logic (<code>attachListHandler</code>, paste sync), and copy-overrides integration. <br> • Implicit behavior: the script expects optional global helpers (<code>window.showToast</code>, <code>window.copyTableMarkdown</code>, <code>window.copyTablePlain</code>) and defers to them when available while offering local fallbacks. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Key components & responsibilities (concise)</strong><br> 1. Network utilities — <code>fetchWithTimeout</code> unifies fetch usage, exposing timeouts and transparent error shaping; <code>fetchFileWithTimeout</code> is tailored for file content retrieval and rejects on non-OK responses. <br> 2. Index normalization — <code>tryParseListBodyAsArray</code> attempts safe JSON parsing and shape detection; <code>normalizeIndexData</code> converts heterogeneous entries into canonical <code>{name,url,path,description}</code> records limited by <code>MAX_LIST_ITEMS</code>. <br> 3. Label indexing & resolution — <code>buildLabelIndex</code> uses <code>keyVariants</code> and <code>canonKey</code> to produce many tolerant lookup keys for each label file key; <code>resolveCaptionFor</code> constructs candidate keys from filename bases and parts, sorts by specificity (length) and attempts longest-first lookup, falling back to substring-based best match. <br> 4. Groups formation — <code>groupKeyFromPath</code> implements heuristics: prefer path prefix (before <code>/</code>), else remove trailing numeric suffix (e.g., <code>_01</code>) and return a multi-part prefix (first two underscore segments) or fallback <code>Ungrouped</code>. <code>buildGroupsFromLive</code> assigns files to groups and attaches resolved captions. <br> 5. File-level search engine — <code>createFileSearchEngine</code> builds a token-trigram <code>lite</code> representation, inverted index with <code>MAX_POSTINGS</code> cap, <code>candidatesForQuery</code> for fast candidate enumeration, and <code>scoreFiles</code> using a blended scoring model favoring caption and filename matches, exact phrase matches, token overlap, prefix boosts, trigram overlap, and a cheap Damerau–Levenshtein fallback for short queries. <br> 6. Modal UI — <code>createModal</code> builds a keyboard-escapable panel, moves embedded search control to header when detected, manages focus, and ensures the panel is removed cleanly on close; <code>presentGroupsOnly</code> builds persistent group rows with toggle/load/caption-injection wiring and renders results using the engine. <br> 7. File load orchestration — <code>loadFilesSequentialAndHideForm</code> fetches files sequentially with bounded sleeps, constructs <code>combinedMarked</code> (safe caption comments + markdown heading), writes raw and marked content to paste area/fallback hidden convert, invokes renderer (<code>__tv_do_convert</code>/<code>window.convert</code>), and applies runtime captions with a retry loop and failure warning. <br> 8. Label injection and metadata posting — <code>tryInjectLabels</code> posts a flat mapping JSON to <code>/api/group/load</code> for server-side persistence to <code>labels_injected.json</code>; <code>trySendActiveGroupMetadata</code> posts a structured audit payload <code>action: &#x27;load_group&#x27;</code> for server analytics. Both flows are fire-and-forget and log server responses on non-OK returns. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Detailed behavior & implementation notes</strong><br> <strong>Network strategy and timeouts</strong> — The script defines distinct timeouts for each responsibility to minimize blocking: <code>LABELS_FETCH_TIMEOUT_MS</code> (3s) and <code>GROUPS_FETCH_TIMEOUT_MS</code> (4s) are intentionally short to avoid waiting for optional assets; <code>INDEX_FETCH_TIMEOUT_MS</code> (8s) and <code>FILE_FETCH_TIMEOUT_MS</code> (12s) are longer because they affect the primary user flow. Candidate lists for live files, groups, and labels are probed sequentially until a first usable response is found to maximize compatibility with varied hosting setups; sequential probing is slower when early candidates are unreachable but is simpler and reduces parallel network load on constrained hosts. <br> <strong>Label normalization & matching</strong> — <code>keyVariants</code> emits variants: whitespace collapsed, no-space, underscore, dash, punctuation-removed, and numeric normalizations (e.g., <code>chapter_01</code> → <code>chapter1</code>, <code>chapter_01</code> → <code>chapter_01</code> both indexed). <code>buildLabelIndex</code> indexes every variant using <code>canonKey</code> to normalize to lowercase-with-spaces-collapsed and punctuation-stripped canonical keys. <code>resolveCaptionFor</code> then forms filename-derived variants (base name without extension, whitespace/dash/underscore variations, split-prefix suffixes, numeric-suffix normalized forms) and sorts candidate canonical keys by length descending so that more-specific keys are preferred (e.g., <code>introduction_section_01</code> wins over <code>introduction</code>). If no direct match is found, <code>resolveCaptionFor</code> performs a substring-based best-length match across labelIndex keys to find the longest containing key, which tends to select the most specific available label rather than a generic one. This heuristic reduces false positives for many common filename conventions. <br> <strong>Groups formation heuristics</strong> — <code>groupKeyFromPath</code> uses several layers: if the path contains <code>/</code>, use the first segment (the assumed directory/group); otherwise split on <code>_</code> and if the final token is numeric (1–3 digits) remove it and use remainder; when more than two underscore parts are present, prefer the first two to form a readable group name; fallback is sanitized base name or <code>Ungrouped</code>. The algorithm aims to group files by authoring conventions (chapter_01, section_02) without requiring server-side group metadata. <br> <strong>Search engine scoring rationale</strong> — weights are intentionally chosen to prefer caption matches, then filename matches, then token overlap. Exact quoted phrase matches carry a large boost (500) to surface deliberate searches quickly. Caption matches get +220 and filename matches +140 so a search for a caption term will outrank unrelated files containing the same token in content. Trigram overlap provides fuzzy similarity without heavy edit-distance costs for longer queries, while the cheap edit-distance is applied only for short queries (<=6 chars) to improve typo resilience without expensive computation on long inputs. Posting caps (<code>MAX_POSTINGS</code>) bound index size to avoid degenerating memory with very large indices. <br> <strong>Modal render performance & persistence</strong> — <code>presentGroupsOnly</code> constructs <code>groupControls</code> arrays where each entry contains DOM nodes that are reused across searches. Reusing per-group DOM nodes reduces reflows and preserves interactive states such as expanded/collapsed and focus. While the initial DOM is built eagerly for all groups, each group's file list is rendered lazily during searches and when the user expands the group; this keeps initial modal paint fast for large group counts. <br> <strong>Caption injection UX</strong> — caption nodes are clickable; on click the script chooses keys in this order: <code>localF.name</code> (basename), <code>localF.path</code> (last segment), <code>localF.url</code> basename, else synthetic <code>Table{random}</code>. The caption text is sanitized via <code>sanitizeCaptionForInjection</code> which strips HTML comments, script tags, all tags, then <code>escapeHtml</code> is applied before sending. The POST uses JSON with same-origin credentials. The server is expected to accept a top-level flat mapping and persist it to <code>labels_injected.json</code>. On success the client shows a success toast where available. The front-end inject is intentionally minimal so server can perform canonicalization and overwrite/merge logic centrally. <br> <strong>File load pipeline details</strong> — Each file fetch is spaced (40–60ms) to avoid overwhelming the main thread with immediate UI updates when many files are being retrieved. For each file the script constructs two accumulators: <code>accRaw</code> (pure file content) and <code>accMarked</code> (file content prefixed by an HTML comment <code>&lt;!-- caption: ... --&gt;</code> and a safe markdown heading <code>### caption</code>). Caption text used in <code>accMarked</code> is sanitized to remove tags and escaped to prevent injection. Once all files are fetched, the script attempts to hand combinedMarked to the renderer (<code>__tv_do_convert({text: combinedMarked, metadata:{fromList:true}})</code>), falling back to <code>window.convert</code> and finally to a hidden textarea fallback. After renderer invocation the script sets <code>window.__ptt_runtime_captions</code> and launches a retry loop that maps runtime caption array indices to discovered <code>.table-caption</code> nodes or heading nodes to set textual captions and assign <code>Table{n}</code> ids when necessary. The retry loop is bounded with <code>maxRetries</code> (default 120) to avoid indefinite background work. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling, robustness & failure modes</strong><br> • Non-blocking failures: fetch failures move to the next candidate; if no live files are found the UI reports an error and aborts gracefully. <br> • Parsing errors: invalid JSON is caught and ignored; fallback to newline listing parsing is attempted. <br> • Caption apply timeout: runtime caption application will emit a warn toast and console warning if it times out; the module sets <code>__ptt_list_render_in_progress</code> false and does not throw. <br> • Id collision risk: runtime assignment of ids <code>Table{n}</code> may collide with host elements; current strategy is simple assignment without a complex collision namespace to minimize complexity. Recommendation: use a reserved prefix like <code>__ptt_Table{n}</code> or check for collisions and suffix with <code>-1,-2</code> when conflicts exist if the host environment requires strict id hygiene. <br> • Silent degradation: logging is gated by <code>DEBUG</code>; non-debug deployments will not produce noisy console logs which is safer for embed contexts but reduces immediate observability. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Concurrency / performance considerations</strong><br> • Sequential discovery vs parallelism: candidate probing is sequential which reduces parallel network pressure and simplifies timeouts but can increase perceived latency if early candidates are offline. Consider parallel probing with per-candidate short timeouts if latency is critical and host has sufficient bandwidth. <br> • Memory bounding: inverted index postings arrays are capped at <code>MAX_POSTINGS</code> to limit memory use; <code>MAX_LIST_ITEMS</code> bounds the number of files processed to avoid UI freezes on very large indices. <br> • Search scoring cost distribution: tokenization and trigram computation are done once per <code>lite</code> item at engine build time; scoring is then lighter and mostly numeric/array work. For very large file sets consider moving scoring to a web worker (engine is pluggable). <br> • Debouncing & stale result protection: search input is debounced at 120ms and uses a <code>searchVersion</code> token to discard out-of-order asynchronous results. This avoids UI flicker when scoring is slower than typing. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Edge cases & brittle areas</strong><br> 1. Unicode and normalization: <code>canonKey</code> and <code>keyVariants</code> operate on ASCII-centric regex; filenames with composed Unicode characters may not normalize equivalently to server-side normalization and can fail to match labels. Recommendation: normalize strings with <code>String.prototype.normalize(&#x27;NFKC&#x27;)</code> where available before applying regex transforms to reduce Unicode mismatch. <br> 2. Mixed indentation and naming conventions: group splitting heuristics assume common patterns (<code>/</code> directory, underscores, numeric suffix). Projects with unconventional naming may yield unintuitive grouping; server-provided <code>groups.json</code> should be preferred when available. <br> 3. Host CSS and theming: modal color read from CSS variables may be low-contrast; consider explicit fallback styles or allow integrators to provide a theme in <code>window.__ptt_config</code>. <br> 4. Large render depths: extremely deep nesting in <code>.table-caption</code> / heading discovery can result in unpredictable mapping of runtime captions; keep runtime caption depth within expected ranges or introduce an explicit mapping between file order and renderer table ids where possible. <br> 5. Server contract fragility: client expects <code>/api/group/load</code> to accept both flat mapping writes (for labels) and structured JSON audit payloads; if the server implements strict schemas or CSRF protections, client may need to supply CSRF tokens or adapt payloads accordingly. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Integration points & extension hooks</strong><br> • Optional host hooks: <code>window.showToast</code> to present toasts, <code>window.copyTableMarkdown</code> and <code>window.copyTablePlain</code> for copy delegation, and <code>window.__ptt_config</code> as a potential override object for candidate lists and timeouts. <br> • Replaceable engine: <code>createFileSearchEngine</code> returns <code>candidatesForQuery</code> and <code>scoreFiles</code>; replace with a worker-backed implementation by preserving the same interface. <br> • Label ingestion endpoint: <code>/api/group/load</code> is the canonical path for client label injection and group metadata posting; server should document accepted payload shapes explicitly: (A) flat mapping <code>{ &quot;filename.md&quot;: &quot;Caption&quot; }</code> and (B) structured payload <code>{ action: &quot;load_group&quot;, client_req_id, timestamp, source, group_id, group: { id,name,description,fileCount,files } }</code>. <br> • Caption renderer hook: host pages can monitor <code>window.__ptt_runtime_captions</code> after <code>loadFilesSequentialAndHideForm</code> completes and implement custom DOM injection if the host prefers semantic <code>&lt;caption&gt;</code> elements or ARIA attributes instead of the default behavior. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Recommendations & maintainability notes</strong><br> • Centralize canonicalization helpers: extract <code>canonKey</code>, <code>keyVariants</code>, and <code>escapeHtml</code> into a small shared utilities module (e.g., <code>ptt.utils.js</code>) and import both from <code>script.core.js</code> and <code>script.list.js</code> to eliminate drift and reduce subtle mismatches. <br> • Expose runtime configuration: provide <code>window.__ptt_config = { LABELS_JSON_CANDIDATES, GROUPS_JSON_CANDIDATES, timeouts... }</code> so deployers can tune behavior without modifying the shipped script. <br> • Add unit tests: create targeted unit tests for <code>resolveCaptionFor</code> using diverse filename keysets (zero-padded numbers, hyphen/underscore variants, unicode normalization cases), and tests for <code>groupKeyFromPath</code> and <code>buildLabelIndex</code>. <br> • Observability: when <code>DEBUG</code> is true, provide a transient debug panel in the modal that lists attempted endpoints, timings, label match results, and engine stats; this avoids relying on host console access. <br> • Accessibility: add <code>aria-controls</code> from group header to file list, use <code>aria-live</code> announcements for major state transitions (e.g., "Loaded N files"), and ensure focusable elements have visible focus outlines even when host CSS suppresses them. <br> • ID collision policy: implement a safe-id allocator that checks <code>document.getElementById(candidateId)</code> and, on existing collision, attempts suffixed variants <code>candidateId + &#x27;__ptt&#x27;</code>, <code>candidateId + &#x27;__ptt-1&#x27;</code> up to a small limit before falling back to <code>__ptt_Table{n}</code>; this reduces risk of overwriting host elements. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational checklist before deployment</strong><br> 1. Confirm candidate endpoints are reachable or intentionally fallback. 2. Test label injection end-to-end with server writing <code>labels_injected.json</code> and subsequent <code>loadLabels</code> detecting it. 3. Validate <code>/api/group/load</code> accepts structured audit payloads for <code>trySendActiveGroupMetadata</code> and flat maps for <code>tryInjectLabels</code> without requiring extra CSRF tokens. 4. Run slow-network (3G) testing to confirm timeouts produce acceptable UX; raise <code>LABELS_FETCH_TIMEOUT_MS</code> or <code>GROUPS_FETCH_TIMEOUT_MS</code> if persistent false negatives observed. 5. Verify keyboard navigation and a11y semantics in the modal (Tab order, Escape close, aria-attributes). 6. Stress test with <code>MAX_LIST_ITEMS</code> to ensure memory limits and search engine posting caps are honored. 7. Confirm <code>__tv_do_convert</code> handoff works in both top-level and iframe contexts. 8. Run unit tests for <code>canonKey</code>, <code>keyVariants</code>, <code>buildLabelIndex</code>, <code>resolveCaptionFor</code>, <code>groupKeyFromPath</code>, and <code>createFileSearchEngine</code> scoring logic. 9. Validate that caption injection mapping keys chosen by the client (basename/path/url fallback) match server expectations and do not accidentally collide with existing manual labels. 10. Verify paste area population and renderer invocation in typical host pages and in strict CSP environments (check whether <code>fetch</code>/<code>eval</code> usage is impacted). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security & sanitization measures</strong><br> • All caption strings included in the <code>combinedMarked</code> accumulator are sanitized by <code>sanitizeCaptionForInjection</code>: strip HTML comments, remove <code>&lt;script&gt;</code> blocks and any remaining tags, then <code>escapeHtml</code> before insertion and before shipping a flat mapping to the server. This reduces risk of XSS through server-echoed labels in later render cycles. <br> • <code>escapeHtml</code> is used when producing innerHTML for dynamic UI elements (highlights with <code>&lt;mark&gt;</code>), ensuring user-provided strings are never interpreted as HTML. <br> • POST endpoints use <code>credentials: &#x27;same-origin&#x27;</code> to respect host session authentication; server must still enforce CSRF protections and validate payloads. <br> • All network parses are wrapped in try/catch and invalid shapes are dropped rather than assumed. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Examples, test vectors and pseudocode</strong><br> <strong>resolveCaptionFor test vectors:</strong> input <code>Chapter-01_Introduction.md</code> expected normalized candidates: <code>chapter 01 introduction</code>, <code>chapter01introduction</code>, <code>chapter_1_introduction</code>, <code>chapter-01-introduction</code>; if labelIndex contains <code>chapter_01_introduction: &quot;Introduction to Chapter 1&quot;</code> then <code>resolveCaptionFor</code> should return <code>&quot;Introduction to Chapter 1&quot;</code>. Input <code>file_2.md</code> with labelIndex keys <code>file2</code> and <code>file_02</code> will match either but longer-specific match ordering should prefer <code>file_02</code> if present. <br> <strong>groupKeyFromPath pseudocode:</strong> <code>if path contains &#x27;/&#x27; return firstSegment; else base=removeExtension(name); parts=base.split(&#x27;_&#x27;); if lastToken numeric pop it; if parts&gt;=2 return parts.slice(0,2).join(&#x27;_&#x27;); else return base</code>. <br> <strong>safe-id allocator pseudocode:</strong> <code>function allocSafeId(baseId){ var id=baseId; var suffix=0; while(document.getElementById(id) &amp;&amp; suffix&lt;10){ suffix++; id=baseId+&#x27;__ptt-&#x27;+suffix; } if(document.getElementById(id)) id=&#x27;__ptt_&#x27;+baseId+&#x27;_&#x27;+Math.randomId(); return id; }</code> Use this when assigning <code>Table{n}</code> ids to avoid collisions. <br> <strong>caption injection payload example:</strong> POST <code>/api/group/load</code> body <code>{&quot;example.md&quot;:&quot;Example caption&quot;,&quot;_client_req_id&quot;:&quot;cid-abc123&quot;}</code> with <code>Content-Type: application/json</code> and same-origin credentials. Server should respond with 200/JSON acknowledging write and release <code>labels_injected.json</code> for subsequent <code>loadLabels</code> to read. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Ten verification checks executed (detailed)</strong><br> 1. Network shape verification: <code>fetchWithTimeout</code> returns <code>{ok:true,status:200,url,body}</code> on success, <code>{ok:false,status:0,err:&#x27;timeout&#x27;}</code> on abort; callers handle both without throwing. <br> 2. Normalizer coverage: <code>normalizeIndexData</code> produces non-empty canonical arrays for sample inputs <code>[&quot;a.md&quot;,&quot;b.md&quot;]</code>, <code>{&quot;files&quot;:[{&quot;name&quot;:&quot;a.md&quot;,&quot;path&quot;:&quot;a.md&quot;}]}</code>, and a newline list string; invalid shapes return empty array. <br> 3. Label indexing: <code>keyVariants(&#x27;Chapter_01&#x27;)</code> includes <code>chapter01</code>, <code>chapter_1</code>, <code>chapter-01</code>, and <code>chapter_01</code>; <code>buildLabelIndex</code> stores each under <code>canonKey</code>. <br> 4. Caption resolution: <code>resolveCaptionFor(&#x27;Chapter_01&#x27;, labelIndex)</code> prefers exact canonical matches, and when absent returns best substring longest-match across labelIndex keys. <br> 5. Grouping logic: <code>groupKeyFromPath(&#x27;chapter1/file_01.md&#x27;)</code> returns <code>chapter1</code>; <code>groupKeyFromPath(&#x27;file_01.md&#x27;)</code> returns <code>file</code> or <code>file</code> prefix per heuristic; empty input returns <code>Ungrouped</code>. <br> 6. Search engine correctness: <code>createFileSearchEngine</code> tokens and tri-grams computed for sample items produce candidate lists for queries and <code>scoreFiles</code> ranks caption-containing items above content-only matches for identical queries. <br> 7. Modal focus: <code>createModal</code> sets focus on first focusable control within 10–50ms after append; Escape triggers close handler and removes keyboard listeners. <br> 8. File load handoff: <code>loadFilesSequentialAndHideForm</code> produces <code>combinedMarked</code> with <code>&lt;!-- caption: ... --&gt;</code> and <code>### ...</code> heading and calls <code>__tv_do_convert</code> with <code>metadata.fromList=true</code> when available. <br> 9. Caption application: runtime captions assigned to discovered headings or <code>.table-caption</code> nodes; when nodes missing the mechanism assigns <code>Table{n}</code> ids where safe; success emits a success toast if <code>window.showToast</code> present. <br> 10. Safe posting: <code>tryInjectLabels</code> posts JSON and handles non-OK by logging response text; on 200 it reads text and triggers a success toast. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Limitations & scope boundaries</strong><br> • This breakdown is an exhaustive technical description of the present <code>script.list.js</code> implementation and operational guidance; it does not change the source. <br> • The module favors simple client-side heuristics for grouping and caption resolution; complex or enterprise-level grouping requirements should be expressed in server-provided <code>groups.json</code> to avoid client heuristic drift. <br> • Host-specific security policies (CSP, CSRF) and server validation must be coordinated with server implementers; some environments require additional headers or tokens which this client currently does not automatically provide. <br> • The caption-id collision policy remains conservative and must be hardened if host pages have critical elements that cannot be touched. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Actionable next steps for hardening & follow-up</strong><br> 1. Export canonicalization helpers to a shared module and replace duplicated logic across scripts. 2. Add <code>window.__ptt_config</code> override object to make candidate lists and timeouts injectable at runtime. 3. Implement safe-id allocator before assigning <code>Table{n}</code> ids to avoid host collisions. 4. Provide an optional worker-backed search engine for very large indices; keep the same <code>candidatesForQuery</code>/<code>scoreFiles</code> interface. 5. Add an integration test harness that runs a local server with simulated <code>/saved/*</code>, <code>labels.json</code>, and <code>/api/group/load</code> endpoints to verify end-to-end flows including label injection and persistent label reload. 6. Add accessibility annotations (<code>aria-controls</code>, <code>aria-live</code> announcements for loads/injects). 7. Consider a parallel candidate-probing mode (with short per-candidate timeouts) as a configurable option for low-latency environments. 8. Document server contract for <code>/api/group/load</code> precisely and add defensive client-side handling for 4xx/5xx contract errors. 9. Add unit tests for keyboard navigation in modal and for <code>sanitizeCaptionForInjection</code> with malicious inputs. 10. Add telemetry hooks (opt-in) to capture endpoint latencies and failure rates under <code>DEBUG</code> mode for deploy-time tuning. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Conclusion</strong><br> <code>script.list.js</code> is a robust, production-minded client component with strong defensive programming patterns, pragmatic heuristics for grouping and caption resolution, a purpose-built file-level search engine, and explicit fire-and-forget label and metadata posting flows. The primary maintenance actions to improve reliability are consolidating canonicalization utilities, exposing runtime configuration, hardening id allocation to avoid host collisions, and adding a focused unit/integration test suite that verifies label injection and end-to-end caption persistence. The above contains extensive verification checkpoints, pseudocode, payload examples, and recommended follow-ups to reach production-grade resilience. </td></tr></tbody></table></div><div class="row-count">Rows: 17</div></div><div class="table-caption" id="Table3" data-table="Docu_0125_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3 • script.table.js</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by assets/script.table.js — Exhaustive Technical Breakdown (expanded)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">assets/script.table.js — Exhaustive Technical Breakdown (expanded)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>1) One-line summary / intent</strong>: A defensive, caption-safe client-side table interaction and export subsystem for PasteToTable: builds TOCs from server-rendered caption-like elements (does not create captions), provides single-table row anchors, Unicode-aware search & highlighting, reversible three-state column sorting, collapse/expand UX, copy/export (plain, Markdown, CSV, JSON, XLSX, PDF), responsive control layout, idempotent initialization, and cooperative integration points (PTToc, tvUtils, XLSX, tableVirtualizer).                                                                                                                                                                                                                                    </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>2) Design principles (explicit)</strong>: Non-destructive (reads caption-like nodes but never invents them), idempotent re-init (dataset flags prevent duplicative listeners), feature-graceful (prefer global helpers), defensive (widespread try/catch to avoid runtime crashes), accessible (aria attributes, focus management), compatible (checks APIs like AbortController, matchMedia), observable-extensible (exposes functions on <code>window</code> for other modules).                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>3) Public API & global exposure</strong>: Exposes <code>window.PasteToTable.initRenderedContent</code>, <code>window.PTTable.buildTocs</code>, <code>window.copyTablePlain</code>, <code>window.copyTableMarkdown</code>, <code>window.exportTableCSV</code>, <code>window.exportTableJSON</code>, <code>window.exportTableXLSX</code>, <code>window.exportTablePDF</code>, <code>window.exportAllBtnHandler</code>, <code>window.searchTable</code>, <code>window.toggleTable</code>, <code>window.toggleAllTables</code>, and <code>window.backToTop</code>. Also writes dataset flags (e.g., <code>data-tvHandlerAttached</code>) to DOM elements for idempotency.                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>4) High-level control flow (init)</strong>: On DOMContentLoaded or immediate if ready: <code>initRenderedContent()</code> is invoked → ensure <code>.table-container</code> wrappers exist → build TOCs (<code>buildTocs()</code>) → assign row UIDs and snapshot ordering (<code>_ensureRowUidsAndSnapshot</code>) → cache <code>data-orig-html</code> for cells → attach per-table handlers idempotently → optimize controls layout → update row counts → scroll first table into view.                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>5) TOC behavior & heuristics</strong>: <code>buildTocs()</code> first defers to <code>window.PTToc.init/build</code> (if present) with selectors; fallback runs <code>buildSingleTableToc()</code> and <code>buildTocFromCaptions()</code>. <code>buildSingleTableToc()</code> triggers when a single logical table is present, enumerates body rows (skips <code>thead</code>), creates anchor <code>&lt;li&gt;&lt;a href=&quot;#id&quot;&gt;</code> entries using a stable ID per row. <code>buildTocFromCaptions()</code> collects <code>.table-caption</code>, <code>.table-title</code>, <code>.table-heading</code> nodes, ensures unique IDs (suffixes collisions), and appends links to <code>#toc</code> and <code>#tocBar</code>. Important: it only reads caption nodes — it does not create or mutate caption text.                                                                                                                             </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>6) ID collision strategy</strong>: When an intended id (e.g., <code>Table1</code> or <code>table-1</code>) is already present and not the same element, code suffixes with <code>-1</code>, <code>-2</code>, ... until unique. This prevents accidental anchor conflicts but can lead to proliferating suffixed IDs over repeated runs or interactions by other scripts.                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>7) Row UID snapshotting & sort restoration</strong>: <code>_ensureRowUidsAndSnapshot(table, tableIdx)</code> assigns <code>data-tv-uid = tvuid-N</code> for each row if not present and records <code>originalRowOrders[tableIdx] = [uid...]</code>. <code>sortTableByColumn</code> reorders DOM rows based on comparison, and on 3rd state restores original order by re-attaching rows in the snapshot order, searching by <code>tr[data-tv-uid=&quot;...&quot;]</code>. Restoration fails to include rows added after snapshot or rows without UIDs.                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>8) Sorting algorithm & rules</strong>: Three state per column: 0 (unsorted) → 1 (ascending) → 2 (descending) → 0 (restore). Sorting determines numeric vs lexical ordering by <code>parseFloat</code> on sanitized cell text (commas removed). Numeric sort applied if both parse to numbers. For ties fallback to <code>localeCompare</code>. Sorting mutates DOM by appending rows in sorted order (may cause many reflows). <code>sortStates</code> array stores per-table per-column state; header buttons get <code>sort-state-*</code> classes and <code>aria-sort</code> attributes updated.                                                                                                                                                                                                                                           </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>9) Complexity & performance of sorting</strong>: Sorting cost O(n log n) comparisons for n rows; cost dominated by string parsing/comparisons. DOM reattachment is O(n) append operations causing layout thrashing. For large tables (thousands of rows) this is slow: recommendation — build <code>DocumentFragment</code>, append all sorted rows once, then replace <code>tbody</code> contents in a single operation.                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>10) Search normalization & Unicode handling</strong>: <code>normalizeForSearchLocal</code> uses NFD normalization + removal of combining diacritics <code>\u0300-\u036f</code>, then strips non-letter/number characters. If <code>window.__tv_utils.normalizeForSearchLocal</code> exists, it defers to it. This yields case-insensitive, diacritic-insensitive search.                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>11) Highlight matching algorithm (detailed)</strong>: <code>buildNormalizedMapForCell(cell)</code> walks text nodes with a <code>TreeWalker</code>, constructs <code>normStr</code> — a per-codepoint filtered normalized string — and a <code>map</code> array mapping each normalized character position back to <code>{ nodeIndex, offsetInNode }</code>. This supports matching across multiple adjacent text nodes and surrogate pairs. <code>highlightMatches(cell, filterNorm)</code> finds all occurrences of <code>needle</code> in <code>normStr</code>, then for each match uses <code>map</code> entries to compute start and end text-node offsets and splits/ wraps matched text in <code>&lt;mark&gt;</code> elements. Matches are applied right-to-left to preserve indices. Clearing highlights uses <code>data-orig-html</code> (preferred) or replaces <code>&lt;mark&gt;</code> elements with their text children. </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>12) Edge cases in highlighting (subtle)</strong>: Complex emoji sequences (ZWJ, skin tone modifiers) contain multiple codepoints that may normalize unexpectedly; zero-width joiners and grapheme clusters can cause off-by-one mapping leading to split grapheme rendering. The algorithm attempts codepoint-aware offsets (checks <code>codePointAt</code> and char length) but may still mishandle complex sequences. Recommendation: consider using a grapheme cluster library (e.g., Intl.Segmenter or third-party) or a simpler highlight that searches on node.textContent boundaries for extreme cases.                                                                                                                                                                                   </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>13) Search runtime & mitigation</strong>: Building the normalized map is linear in the number of codepoints in a cell; worst-case for many large cells CPU & memory heavy. Mitigations present in code: debouncing search input; <code>window.tvConfig.highlight</code> guard to skip highlight; recommend: threshold-based skip (e.g., skip highlights for cells > 10k chars), incremental/async chunking, or Web Worker offload for normalization in very large docs.                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>14) Hiding non-matching rows</strong>: <code>searchTable()</code> runs per-table: for each row, clears highlights, computes normalized cell text and checks inclusion of <code>filterNorm</code> (normalized). Rows with no cell matching are hidden (<code>row.style.display = &#x27;none&#x27;</code>). First matching row is scrolled into view. Virtualized tables must call <code>tableVirtualizer.refresh()</code> or <code>update()</code>; code checks for <code>window.tableVirtualizer</code> and tries to call refresh/update if available.                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>15) Copy plain & Markdown behavior</strong>: <code>copyTablePlain(btn)</code> builds tab-separated plain-text from DOM cells and uses <code>copyToClipboard</code>. If table absent, falls back to <code>window.__tv_last_source</code> (raw source) if present. <code>copyTableMarkdown(btn)</code> first tries <code>getPreferredSourceForTable(table)</code> — which tries to map DOM table to its original markdown block in <code>window.__tv_last_source</code> using heuristics (block splitting by blank lines, header matching), preferring original source for accurate Markdown. If not found, <code>tableToMarkdownLines()</code> converts DOM table to pipe-table Markdown. Both use either <code>tvUtils.showCopyModal</code> if available or <code>copyToClipboard</code>.                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>16) Export formats & fallbacks</strong>: CSV: joins rows with commas, quotes containing <code>&quot;</code> by doubling, adds BOM (<code>\uFEFF</code>) to help Excel with UTF-8. JSON: builds array of objects using header row (thead) if present, otherwise <code>ColN</code> keys. XLSX: attempts <code>window.XLSX.utils.book_new</code> + <code>aoa_to_sheet</code> + <code>writeFile</code> or <code>write</code> variations; if unavailable or fails, falls back to creating TSV inside a Blob but warns user. PDF: constructs simple HTML with inline minimal CSS and <code>table.outerHTML</code>, opens a new window, writes HTML and calls <code>print()</code> after a small timeout — may be blocked by popup blockers.                                                                                                                                                          </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>17) Export caveats</strong>: XLSX fallback as TSV is not a true <code>.xlsx</code> binary — consumers expecting native <code>.xlsx</code> may be confused. CSV/TSV use simple quoting but do not attempt advanced escaping for multiline fields beyond simple <code>&quot;</code> quoting. PDF relies on <code>window.open</code> (popup blockers) and on client-side print to PDF support — not guaranteed.                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>18) Collapse/Expand details</strong>: <code>toggleTable(btn)</code> finds wrapper, toggles <code>tbody.style.display</code> between <code>none</code> and <code>&quot;&quot;</code>, toggles button text between 'Collapse Table' and 'Expand Table', updates <code>aria-expanded</code>. <code>toggleAllTables()</code> checks any expanded state and flips globally. This approach toggles visual display but leaves rows present in DOM; virtualizers or accessibility readers may still enumerate hidden rows unless <code>aria-hidden</code> or <code>hidden</code> attributes are used — current code uses style only.                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>19) Layout optimization & responsiveness</strong>: <code>optimizeTableControls()</code> moves control nodes into a <code>.table-header-wrapper</code>, creates a <code>.copy-buttons</code> container if needed, and adapts button sizing/padding for narrow screens (<code>(max-width:600px)</code>). It debounces via <code>window.tvConfig.debounceMs</code>. It also ensures toggle button placement and normalizes classes (<code>table-toggle-inline</code>).                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>20) Event binding & idempotency</strong>: Per-wrapper per-button attachments set <code>btn.dataset.tvTableIndex</code> and <code>btn.dataset.tvHandlerAttached = &quot;1&quot;</code>, avoiding duplicate handlers. Search input bound once (<code>sb.dataset.tvBound</code>). Global delegated click handlers capture sort clicks (by <code>.sort-btn</code>/<code>.th-with-sort</code>) and <code>#tocBar</code> anchor clicks. Keyboard handlers bind <code>/</code> to focus search and <code>Escape</code> to <code>backToTop</code>. All handlers wrapped in <code>try/catch</code>.                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>21) Memory & lifecycle</strong>: The module stores <code>originalRowOrders</code> and cell <code>data-orig-html</code> for each table. No explicit <code>dispose()</code> is provided; if tables are torn down or replaced frequently, memory may grow or stale references remain. Recommendation: add <code>PasteToTable.dispose()</code> to clear <code>originalRowOrders</code>, remove dataset flags, and optionally remove attached listeners.                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>22) Error handling trade-offs</strong>: The code prefers silence over loud failures (many <code>try/catch</code> with empty catches). This avoids user-facing crashes but complicates debugging. Recommendation: add an optional <code>DEBUG</code> flag to log caught errors to <code>console.warn</code> with contextual metadata while preserving stability.                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>23) Integration touchpoints</strong>: Code cooperates with: <code>window.PTToc</code> (TOC builder), <code>window.tvUtils</code> (copy/download/showToast/debounce), <code>window.XLSX</code> (SheetJS), <code>window.tableVirtualizer</code> (refresh/update), <code>window.tvConfig</code> (highlight/debounceMs). Provide these objects for richer behavior. <code>getPreferredSourceForTable</code> depends on <code>window.__tv_last_source</code> populated by other modules.                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>24) Security & sanitization</strong>: Exported HTML for PDF and copy operations uses <code>table.outerHTML</code> and <code>innerHTML</code> in places. Input flow largely reads existing DOM; injection risk is limited because server-rendered content is assumed trusted. However, when producing HTML blobs for download or print, ensure consumers expect raw HTML. <code>escapeHtml</code> is used in other files; this module relies on safe existing DOM and uses <code>textContent</code> in many places to avoid XSS when building strings.                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>25) Accessibility considerations (detailed)</strong>: Sets <code>aria-sort</code> on headers, <code>aria-expanded</code> on toggle buttons, <code>role=&quot;list&quot;</code> on resultsWrap in group UI. TOC links get <code>aria-label</code> and row anchors get <code>tabindex=&quot;-1&quot;</code>. However: hiding rows via <code>style.display = &#x27;none&#x27;</code> does remove them from the accessibility tree in practice, but adding ARIA live announcements for search result counts would improve screen-reader feedback. Also consider adding <code>aria-controls</code> linking TOC items to target tables/captions and <code>aria-live</code> updates for export success/failure.                                                                                                                                                                                                     </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>26) Test matrix & unit/integration checks to add</strong>: (1) Sorting correctness with numeric strings containing commas, negative numbers, empty cells. (2) Restore original order after sort with added/removed rows. (3) Highlight correctness across adjacent text nodes, surrogate pairs, ZWJ sequences, and long text. (4) TOC ID collision resolution when non-caption node already uses <code>Table1</code> id. (5) Copy/Markdown precedence of <code>getPreferredSourceForTable</code>. (6) XLSX variations with different SheetJS build shapes. (7) PDF printing under blocked <code>window.open</code>. (8) Performance profiling for large tables (5k+ rows).                                                                                                                                              </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>27) Performance profiling guidance</strong>: Instrument timings for <code>buildNormalizedMapForCell</code> and <code>highlightMatches</code> per-cell (sample slow cells). Measure DOM reflow cost in <code>sortTableByColumn</code> using <code>performance.now()</code> before/after sort and before/after DOM reattachment. Track memory use for <code>data-orig-html</code> sizes with <code>innerHTML.length</code>. If hotspots exceed thresholds, consider Web Worker normalization, using <code>DocumentFragment</code> batch DOM updates, or virtualization (only render visible rows).                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>28) Concrete code improvements (prioritized)</strong>: 1) Replace row-by-row reappend with <code>DocumentFragment</code> batch re-insert in <code>sortTableByColumn</code>. 2) Add <code>dispose()</code> to remove dataset flags, clear snapshots, and detach event listeners. 3) Add a <code>HIGHLIGHT_MAX_CHARS</code> guard and fallback to non-highlighted filtering for very large cells. 4) Add optional verbose logging under <code>window.__ptt_debug</code> or <code>window.tvDebug</code>. 5) Use <code>requestAnimationFrame</code> when performing many DOM writes to help the browser batch paints. 6) Improve XLSX fallback by shipping a minimal client-side library for true <code>.xlsx</code> generation or push export server-side.                                                                                                                        </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>29) Developer ergonomics / debugging suggestions</strong>: Expose a <code>window.PTTable._diagnostics()</code> that returns counts: number of tables, total rows, total characters in <code>data-orig-html</code>, size of <code>originalRowOrders</code>, memory hints. When <code>window.__ptt_debug</code> true, have critical caught errors <code>console.warn</code> with a context object. Include verbose timestamps for long-running operations.                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>30) Example traces (what happens on group-load -> convert)</strong>: (A) Group UI loads files → <code>loadFilesSequentialAndHideForm</code> fetches and concatenates raw sources → it sets <code>window.__tv_group_load_mode = true</code> and dispatches <code>ptt:groupLoaded</code> event → it calls <code>__tv_do_convert({text, metadata:{fromList:true}})</code> → <code>processRenderedHtml</code> injects HTML into <code>#tables-viewer</code> → sets <code>window.__tv_skip_scroll = true</code> → calls <code>PasteToTable.initRenderedContent()</code> via timeouts → <code>initRenderedContent</code> builds wrappers, caches HTML, builds TOCs (reads captions), attaches handlers, optimizes layout, updates row counts, and clears skip flags after coordinated scroll attempts.                                                                                          </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>31) Known behavior differences vs server-side caption injection</strong>: Because this module never creates caption nodes, pages that expect client-side caption injection will not get captions from this script. Server must provide <code>labels_injected.json</code> and <code>script.toc.js</code> (other files) if captions are desired. This module is intentionally caption-safe to avoid duplicate/inconsistent caption DOM mutations.                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>32) Inter-module invariants to preserve</strong>: - Do not assign IDs that collide with meaningful non-caption elements (use suffixing). - Do not overwrite <code>data-*</code> that other scripts may rely on (use <code>data-tv-*</code> namespace). - Maintain idempotency: repeated <code>initRenderedContent()</code> must not attach duplicate listeners or corrupt <code>data-orig-html</code>. - Honor <code>window.tvConfig.highlight</code> and <code>debounceMs</code> when available.                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>33) Backwards compatibility & browser support</strong>: Checks for <code>dataset</code>, <code>closest</code>, <code>AbortController</code>, <code>matchMedia</code>; avoids ES2020-only features (mostly ES6 used). Uses fallbacks (e.g., <code>document.querySelector</code> variants) so it works on evergreen browsers; some Unicode features rely on <code>String.prototype.normalize(&#x27;NFD&#x27;)</code> — widely available but not in very old engines.                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>34) Security checklist for deployments</strong>: Ensure HTML saved/served to users is sanitized on server-side if users can upload content (this module will render and export table HTML). Avoid including untrusted script tags inside <code>table.outerHTML</code> during export. When invoking <code>downloadBlob</code> for user-generated filenames, still sanitize with <code>sanitizeFileName</code> (file name sanitization exists in other shared utilities).                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>35) Migration notes for heavy pages</strong>: For pages with many tables or very large tables, consider: server-side pagination or server-rendered precomputed exports, enable virtualization and ensure <code>tableVirtualizer</code> integration, or lazy-init this module only for the currently visible table to reduce upfront cost.                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>36) Suggested unit/integration test list (concrete cases)</strong>: - Sort numeric columns with values: <code>[&quot;1,234&quot;, &quot;12.5&quot;, &quot;-3&quot;, &quot;&quot;]</code>. - Highlight across nodes: <code>&lt;td&gt;foo&lt;b&gt;bar&lt;/b&gt;baz&lt;/td&gt;</code> search "barbaz". - TOC collision: page has <code>&lt;div id=&quot;table-1&quot;&gt;&lt;/div&gt;</code> and a caption node — ensure caption id gets suffix. - CSV encoding: cell contains <code>He said &quot;hello&quot;, then left</code> → CSV line should be <code>&quot;He said &quot;&quot;hello&quot;&quot;, then left&quot;</code>. - XLSX SheetJS permutations: stub <code>window.XLSX</code> with <code>writeFile</code>, <code>write</code>, only <code>utils</code> available, or no XLSX. - PDF fallback when <code>window.open</code> returns null. - Group-load -> <code>ptt:groupLoaded</code> event fired, <code>__tv_group_load_mode</code> set to true.                                                                                             </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>37) Developer TODOs / low-effort wins</strong>: Add <code>data-ptt-version</code> comment to file header; instrument <code>window.__ptt_metrics</code> object to track calls & durations; add feature-flag toggles for heavy features (<code>highlight</code>, <code>sortSnapshotting</code>, <code>xlsxSupport</code>); small unit tests for <code>keyVariants</code>, <code>canonKey</code> in other modules (consistency); include optional <code>aria-live</code> region to announce search result counts.                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>38) Long-term architectural suggestions</strong>: Split responsibilities into focused modules: (A) <code>toc-reader</code> (read-only caption/row anchor builder), (B) <code>search-highlighter</code> (pure normalization/highlight logic with testable API), (C) <code>sorter</code> (snapshot + sort operations, with batch DOM API), (D) <code>exporters</code> (CSV/JSON/XLSX/PDF isolated), (E) <code>ui-optimizer</code>. This enables independent perf tuning and test coverage.                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>39) Risk matrix (likelihood × impact)</strong>: High-likelihood, high-impact: heavy highlight CPU on large tables → UI lock. Medium-likelihood, medium-impact: XLSX API mismatch → failed exports. Low-likelihood, high-impact: ID collisions with important page elements → broken anchors/navigation. Mitigations listed above reduce these risks.                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>40) Final concise checklist before deployment</strong>: (1) Enable debug logging temporarily and run integration tests. (2) Profile <code>searchTable()</code> and <code>sortTableByColumn</code> on real page data. (3) Add <code>dispose()</code> if pages dynamically replace table content. (4) Ensure <code>window.XLSX</code> availability if XLSX export required; otherwise communicate fallback. (5) Confirm <code>window.__tv_last_source</code> flow if copy-markdown should prefer original markdown. (6) Add ARIA announcements for search counts and export completions.                                                                                                                                                                                                                                                        </td></tr></tbody></table></div><div class="row-count">Rows: 40</div></div><div class="table-caption" id="Table4" data-table="Docu_0125_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4 • script.toc.js</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by assets/script.toc.js — Exhaustive Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">assets/script.toc.js — Exhaustive Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>1) One-line summary / intent:</strong> Defensive, caption-aware TOC builder for PasteToTable that reads and (optionally) injects server-provided labels from <code>labels_injected.json</code>; builds TOC entries from headings or single-table rows, coordinates label reloads with group-load events, avoids duplicate network calls, and exposes scheduling/reload APIs.                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>2) Design principles & guarantees:</strong> • <strong>Caption-safe</strong>: injects <code>.table-caption</code> only when authoritative labels exist. • <strong>Non-invasive</strong>: minimal DOM mutations, avoids creating caption text from heuristics. • <strong>Idempotent & coordinated</strong>: prevents duplicate installs via <code>window.__pt_toc_installed</code>, uses dataset/global promises to dedupe reloads. • <strong>Deferred network</strong>: <code>deferLabelsReload</code> avoids fetching labels on init by default. • <strong>Defensive</strong>: heavy use of <code>try/catch</code>; best-effort fallbacks. • <strong>Accessible</strong>: TOC links include <code>aria-label</code> and managed <code>aria-current</code> highlighting. </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>3) Public API / globals exposed:</strong> <code>window.PTToc</code> with <code>init(options)</code>, <code>build()</code>, <code>reloadLabels(opts)</code>, <code>getLabels()</code>, <code>scheduleTocRefresh(opts)</code>; also writes/reads global helpers <code>window.__ptt_labels_injected</code>, <code>window.__ptt_labels_reload_promise</code>. Installs interceptors for <code>fetch</code> and <code>XMLHttpRequest</code> to observe <code>/api/group/load</code> POSTs.                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>4) Top-level structure:</strong> Initialization guard → PTToc object with config & state → utility helpers (normalize, id gen, escape) → label fetch helpers & cache-bust logic → reload/schedule functions → group-load interceptors → TOC builders (<code>buildItemsFromSingleTable</code>, <code>buildItemsFromHeadings</code>, <code>buildOnce</code>) → mutation observer & delegated handlers → auto-init on DOM ready.                                                                                                                                                                                                                            </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>5) Configuration options (key fields):</strong> <code>tocSelector</code>, <code>tocListSelector</code>, <code>tocBarListSelector</code>, <code>headingSelector</code>, <code>contentSelector</code>, <code>stickyHeaderId</code>, <code>tableSelector</code>, <code>rowLabelPrefix</code>, <code>labelsPaths</code>, <code>bookPrefix</code>, <code>deferLabelsReload</code>. These control selectors, label lookup behavior, and initial fetch policy.                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>6) Labels discovery strategy:</strong> Tries <code>PTToc.config.labelsPaths</code> in order; when <code>window.__tv_base</code> exists it expands relative candidates against that base and deduplicates; supports cache-bust <code>?t=</code> when forced; writes successful payload to <code>PTToc._labels</code> and <code>window.__ptt_labels_injected</code>.                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>7) fetchJsonOnce & fetchLabels:</strong> <code>fetchJsonOnce</code> is a single-attempt fetch with timeout using <code>AbortController</code> when available; returns <code>null</code> on failure. <code>fetchLabels(paths)</code> is a sequential attempt across candidates, resolving to an object or <code>{}</code>. Both are defensive and log via <code>dbg</code>.                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>8) reloadLabels behavior & coordination:</strong> <code>PTToc.reloadLabels(opts)</code> expands candidate paths, optionally adds <code>window.__tv_base</code> derived URLs, supports <code>force</code> (adds cache-bust), avoids duplicate global reloads by returning <code>window.__ptt_labels_reload_promise</code> when present, and can perform a non-blocking background refresh when global labels exist — it triggers <code>PTToc.build()</code> on load success.                                                                                                                                                                                                    </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>9) scheduleTocRefresh policy:</strong> Exposed helper that runs two forced reload attempts (immediate-ish and delayed). It dedupes concurrent schedules using <code>_scheduledRefreshFlag</code>, uses cache-busted candidate lists and calls <code>PTToc.build()</code> after each attempt. Intended as integration hook for group-load flows.                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>10) Group-load interceptors (fetch + XHR):</strong> Wraps <code>window.fetch</code> and <code>window.XMLHttpRequest</code> to observe requests to <code>/api/group/load</code>. On successful or error completion it calls <code>PTToc.scheduleTocRefresh()</code> (non-blocking). Wrappers attempt to preserve original behavior and fall back to native if errors occur.                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>11) ID generation & normalization:</strong> <code>ensureId(el, prefix)</code> uses <code>_normalize_heading_text</code> to trim <code>&lt;br&gt;</code> and whitespace noise, lowercases and slugifies, truncates to 60 chars, and suffixes with <code>-N</code> until unique. Avoids overwriting existing id if present.                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>12) Heading normalization specifics:</strong> <code>_normalize_heading_text</code> removes <code>&lt;br&gt;</code> tags and all HTML tags, collapses newlines and whitespace — prevents noisy <code>&lt;br&gt;</code> or multiline headings from producing poor IDs or TOC text.                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>13) Caption lookup logic (<code>captionFor</code>):</strong> Mirrors server-side <code>_caption_for</code> patterns: tries <code>bookPrefix_idx</code> (zero-padded), <code>bookPrefix</code> object subkeys, <code>bookPrefix-idx</code>, padded numeric keys, and raw numeric keys. Works with labels shaped as flat maps or nested objects.                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>14) Book prefix inference:</strong> <code>inferBookPrefix()</code> uses <code>PTToc.config.bookPrefix</code> if provided; otherwise infers from <code>location.pathname</code> filename (stripping extension) or falls back to sanitized <code>document.title</code>. Used for matching labels to headings or row indices.                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>15) Single-table mode:</strong> When exactly one table is found, <code>buildItemsFromSingleTable</code> enumerates body rows (handles multiple TBODYs, falls back to <code>tr</code> excluding <code>thead</code>), ensures stable row IDs via <code>ensureId(row, &#x27;row-&#x27;)</code>, and prefers label text from <code>captionFor(labels, bookPrefix, rowIndex)</code> for each row when available; otherwise uses <code>rowLabelPrefix + index</code>.                                                                                                                                                                                                                                     </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>16) Headings mode:</strong> <code>buildItemsFromHeadings</code> selects elements matching <code>PTToc.config.headingSelector</code>, normalizes text, assigns IDs, and uses labels when available. Returns items with <code>{id,label,anchorEl,index}</code> and later calls <code>injectCaptionForElement</code> for headings with matched captions.                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>17) Caption injection policy:</strong> <code>injectCaptionForElement(anchorEl, bookPrefix, idx, captionText)</code> inserts a <code>.table-caption</code> DIV before the heading or table, sets id like <code>TableNN</code> (handles collisions by suffixing), populates safe HTML (<code>&lt;strong&gt;</code> wrapped, escaped), and applies minimal inline styles. Injection only occurs when authoritative label exists. Avoids duplication by checking <code>document.getElementById(expectedId)</code> and updating existing caption when present.                                                                                                                            </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>18) TOC population (buildOnce):</strong> Clears existing <code>tocList</code>/<code>tocBarList</code> and appends <code>&lt;li&gt;&lt;a&gt;</code> entries produced by <code>makeLink(id,text,extraClass)</code>. After populating, it calls <code>highlightCurrentFromLocation()</code> to set <code>aria-current</code> on matching link.                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>19) makeLink attributes & accessibility:</strong> <code>makeLink</code> creates <code>&lt;a&gt;</code> with <code>href=#id</code>, <code>role=link</code>, <code>data-pt-target</code>, and <code>aria-label</code> set to text. The <code>&lt;li&gt;</code> wrapper receives CSS classes via caller. Links are focusable and usable with keyboard and screen readers.                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>20) Delegated click handling & scrolling:</strong> <code>attachDelegatedHandlers</code> binds document click and <code>hashchange</code>. <code>onTocClick</code> intercepts clicks on <code>a[data-pt-target]</code>, prevents default, computes scroll target minus sticky header height, uses smooth scrolling (<code>window.scrollTo({behavior:&#x27;smooth&#x27;})</code>), updates history with <code>history.replaceState</code>, and schedules <code>highlightCurrentFromLocation</code>.                                                                                                                                                                                                              </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>21) highlightCurrentFromLocation:</strong> Reads <code>location.hash</code>, selects TOC links under configured selectors, clears prior <code>aria-current</code>, and sets <code>aria-current=&#x27;page&#x27;</code> on the link whose href or <code>data-pt-target</code> matches the hash. Called after build and on hashchange.                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>22) Mutation observation:</strong> <code>observeMutations()</code> installs a <code>MutationObserver</code> on <code>getContentRoot()</code> to call <code>debounceBuild</code> on DOM changes (childList & subtree). Intended to keep TOC in sync with dynamic content; observer is reconnected idempotently.                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>23) Debounce behavior:</strong> <code>debounceBuild()</code> uses <code>_debounceMs</code> (default 150ms) to throttle repeated rebuilds triggered by mutations or programmatic calls. <code>PTToc.build()</code> simply calls <code>debounceBuild()</code> — safe for repeated invocation.                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>24) Error handling & logging:</strong> Uses <code>dbg()</code> and <code>warn()</code> wrappers that log only when <code>window.tvDebug</code> is true to avoid noisy consoles. Most internal operations swallow exceptions to preserve UX, but debug logging exposes diagnostic info when enabled.                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>25) Security & sanitization:</strong> Caption injection uses <code>escapeHtml()</code> when building caption innerHTML to avoid raw HTML injection. <code>makeLink</code> uses <code>textContent</code> to populate link text. <code>ensureId</code> strips non-word chars to avoid unsafe id content. Networked label content is assumed trusted (server-provided); if labels come from untrusted sources, server-side sanitization is recommended.                                                                                                                                                                                                                </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>26) Concurrency & deduplication mechanisms:</strong> • Global promise <code>window.__ptt_labels_reload_promise</code> prevents concurrent reloads. • <code>_scheduledRefreshFlag</code> prevents parallel schedule sequences. • If <code>window.__ptt_labels_injected</code> exists and <code>force</code> not requested, reload runs as background refresh and returns existing labels immediately. These patterns reduce redundant GETs.                                                                                                                                                                                                                          </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>27) Behavior when labels are absent:</strong> When no labels loaded, module still builds TOC from headings or row numbers using <code>rowLabelPrefix</code>. Caption injection and label-preferring features are skipped gracefully. <code>PTToc._labels</code> defaults to <code>{}</code>.                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>28) Performance considerations:</strong> • Label fetch attempts are sequential; per-candidate timeout (<code>fetchJsonOnce</code>) defaults to ~2500ms — worst-case multi-candidate series may take several seconds. • MutationObserver watches subtree by default which can be noisy on highly dynamic pages; debounce mitigates some churn. • Caption injection and ID generation are O(n) in number of headings/rows and cheap compared to heavy DOM tasks.                                                                                                                                                                     </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>29) Edge cases & brittle areas:</strong> • ID collisions: repeated injections or other scripts creating IDs can produce many suffixed IDs. • Inferred bookPrefix may be incorrect for pages with complex routing or templated titles. • Labels shaped unexpectedly (deeply nested structures) may not be found by <code>captionFor</code>. • fetch/XHR wrappers may break nonstandard <code>fetch</code> semantics or third-party libs expecting native XHR shape — wrapper attempts to preserve prototype but risks subtle compatibility issues.                                                                                             </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>30) Integration touchpoints:</strong> Works with <code>window.__tv_base</code>, <code>window.__ptt_labels_injected</code>, <code>window.tvDebug</code>. Intended to be called by other modules (e.g., group loader) via <code>PTToc.scheduleTocRefresh()</code> after server-side actions. Intercepts <code>/api/group/load</code> to auto-refresh labels after group loads.                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>31) Accessibility considerations:</strong> TOC links get <code>aria-label</code> and <code>aria-current</code>. Scrolling accounts for sticky header. Caption injection uses semantic <code>.table-caption</code> nodes but additional ARIA enhancements are recommended (e.g., <code>aria-controls</code>, live region announcements for TOC updates or counts).                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>32) Test matrix & recommended verifications:</strong> • Label fetch success/failure across candidate permutations and with <code>window.__tv_base</code>. • <code>force=true</code> reloadResults include cache-bust parameter. • Collision handling for <code>TableNN</code> ids. • Single-table row-label injection with and without labels. • Group-load interceptor triggers <code>scheduleTocRefresh</code> on fetch/XHR to <code>/api/group/load</code>. • MutationObserver triggers rebuild only once per burst (debounce behavior).                                                                                                                                    </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>33) Observability & debugging suggestions:</strong> • Expose <code>PTToc._labels</code>, <code>PTToc._reloadPromise</code> and <code>PTToc._scheduledRefreshFlag</code> for diagnostics. • When <code>window.tvDebug</code> enabled, <code>dbg()</code> prints candidate lists, fetch outcomes, and build events. • Add a small metrics object <code>window.__ptt_toc_metrics</code> to count builds, fetch attempts, and injection counts.                                                                                                                                                                                                                                               </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>34) Concrete code improvements (prioritized):</strong> 1) Provide <code>PTToc.dispose()</code> to disconnect observer, remove interceptors, and reset flags. 2) Replace sequential fetch attempts with race + prioritized fallback to reduce worst-case latency while preserving candidate order. 3) Add safety bounds on candidate expansion to avoid long candidate lists. 4) Wrap <code>XMLHttpRequest</code> wrapper to preserve non-enumerable properties and event hooks more robustly (or prefer <code>Proxy</code> where available). 5) Add optional hooks/callbacks for post-build events (e.g., <code>onBuildComplete</code>).                            </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>35) Behavioral examples / sequences:</strong> • Init with <code>deferLabelsReload=true</code>: PTToc builds TOC from headings without fetching labels; later <code>PTToc.scheduleTocRefresh()</code> called by group loader triggers label reload and <code>build()</code> which injects captions and updates TOC. • Group loader posts to <code>/api/group/load</code>: fetch/XHR wrapper detects the URL and schedules a labels refresh twice (near immediate + delayed).                                                                                                                                                                                         </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>36) Failure modes & mitigations:</strong> • Network failures → labels remain empty; mitigated by background refresh attempts and using existing <code>window.__ptt_labels_injected</code> when present. • Wrapper failures → wrappers fall back to native functions where possible and log debug messages. • Excessive mutation noise → debounce reduces rebuild thrash; consider limiting observed subtree or adding filters for relevant node additions.                                                                                                                                                                         </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>37) Security checklist for deployment:</strong> • Serve <code>labels_injected.json</code> from same-origin or ensure CORS appropriate. • Sanitize label content server-side if labels are user-supplied; module escapes caption strings before injecting. • Avoid exposing sensitive URL paths in expanded candidate lists; keep <code>labelsPaths</code> conservative.                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>38) Long-term architectural suggestions:</strong> • Separate concerns: <code>labels-loader</code> (fetch/merge/caching) and <code>toc-renderer</code> (DOM mapping/injection) to simplify testing. • Provide event-driven API (emit <code>labels:loaded</code>, <code>toc:built</code>) instead of implicit global state. • Offer pluggable ID-generation and caption-insertion strategies for consuming apps with different UX needs.                                                                                                                                                                                                                              </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>39) Recommended unit/integration tests (concrete):</strong> • <code>captionFor</code> with flat map, nested map, hyphenated keys, numeric-only keys. • <code>ensureId</code> generates unique, slugified ids and respects existing ids. • <code>reloadLabels</code> with <code>force</code> toggles cache-bust and returns correct promise semantics when <code>window.__ptt_labels_reload_promise</code> exists. • Group-load interceptor triggers schedule on both fetch and XHR paths. • <code>injectCaptionForElement</code> updates existing caption when element with expected id exists.                                                                                           </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>40) Final deployment checklist:</strong> • Confirm <code>deferLabelsReload</code> desired default for target site. • Verify <code>labelsPaths</code> candidates include correct base paths for deployment; set <code>window.__tv_base</code> if necessary. • Enable <code>window.tvDebug</code> temporarily to observe reload/build logs during integration. • Add <code>PTToc.dispose()</code> if pages dynamically mount/unmount TOC behavior. • Run test matrix above on representative pages (single table, many headings, dynamic loads). • Document global side-effects (fetch/XHR wrappers, global label variables) for other integrators.                              </td></tr></tbody></table></div><div class="row-count">Rows: 40</div></div><div class="table-caption" id="Table5" data-table="Docu_0125_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5 • script.save.js</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Details**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Details</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Details"> <code>assets/script.save.js</code> provides client-side functionality for saving Markdown content via a POST request to <code>/save-md</code>. It handles the user interface (UI) elements for saving, such as filename prompts and status updates, along with necessary checks (e.g., file size limits). The script integrates with other parts of the page via events to handle Markdown content save actions. It includes features like network error handling, content validation, and status feedback, ensuring a smooth user experience.                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Details"> <strong>High-level guarantees & design principles</strong>: • <strong>User-friendly error handling</strong>: Displays status messages for success/failure with appropriate roles for accessibility. <br>• <strong>File size validation</strong>: Checks the size of the content before attempting to save. <br>• <strong>Filename handling</strong>: Ensures proper filename extension and sanitizes user input for the filename. <br>• <strong>Event-driven</strong>: Uses custom events (<code>EVENT_REQUEST_MD</code>, <code>EVENT_RESPONSE_MD</code>) to trigger and handle the save process. <br>• <strong>Graceful degradation</strong>: If the fetch API or the request fails, fallback options (like direct prompt for user input) ensure continued functionality. <br>• <strong>Extensibility</strong>: The script exposes public methods (like <code>PTT_SAVE.save</code>) for other scripts to programmatically trigger save actions.                                                                                                                                                              </td></tr><tr><td data-label="Details"> <strong>Top-level structure & exports</strong>: • <strong>Public API</strong>: <code>PTT_SAVE.save</code> provides a method for external scripts to save Markdown content. <br>• <strong>Save flow</strong>: Manages the logic for reading, validating, and posting Markdown content. <br>• <strong>Events</strong>: Emits <code>EVENT_REQUEST_MD</code> for custom integrations to request a save, and <code>EVENT_RESPONSE_MD</code> for responding with save results. <br>• <strong>UI elements</strong>: Manages status feedback via <code>STATUS_ID</code> and handles user interactions like filename prompts and save button clicks. <br>• <strong>Error handling</strong>: Provides a robust mechanism for network and client errors, ensuring graceful failure modes.                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Details"> <strong>Key components & responsibilities (concise)</strong>: 1. <strong>Save Button Handler</strong> — Listens for clicks on the save button (<code>SAVE_BTN_ID</code>), preventing default behavior, and dispatches a custom event to trigger the save. <br>2. <strong>Filename Prompt</strong> — Prompts the user to provide a filename for the saved Markdown file, ensuring a valid file name and <code>.md</code> extension. <br>3. <strong>Size Validation</strong> — Checks the size of the content before attempting to save, and rejects files that exceed the client-defined maximum size (<code>getClientMaxSize</code>). <br>4. <strong>POST Request</strong> — Sends the Markdown content as JSON to the backend via a POST request to <code>/save-md</code> using the <code>postSaveMarkdown</code> function. <br>5. <strong>Error Handling</strong> — Handles errors gracefully, displaying status updates and triggering appropriate response events in case of failures (e.g., network issues, invalid server response).                                                                             </td></tr><tr><td data-label="Details"> <strong>Detailed behavior & important implementation notes</strong>: <strong>Save Flow</strong>: The script reads content from a designated element (<code>PASTE_ID</code> or <code>FALLBACK_AREA_ID</code>), validates the content, checks the file size, prompts the user for a filename (if not already provided), and then sends the data via a <code>POST</code> request to <code>/save-md</code>. If the save operation is successful, a message is displayed, and a download link may be provided. In case of errors, appropriate feedback is given. <br> <strong>POST Request</strong>: The request is made with a JSON payload containing the Markdown content and the filename. The server's response is processed to check for success or failure. <br> <strong>UI Feedback</strong>: The script updates a status element (<code>STATUS_ID</code>) to show the user the current state of the save operation, including any errors. <br> <strong>Filename Handling</strong>: The filename is ensured to have a <code>.md</code> extension, and input is sanitized to avoid issues with special characters. </td></tr><tr><td data-label="Details"> <strong>Error handling, robustness & failure modes</strong>: • <strong>Network errors</strong>: Handled by <code>catch</code> blocks in the <code>postSaveMarkdown</code> function, which ensures users are notified of any issues while saving. <br>• <strong>Invalid server response</strong>: If the server returns a non-JSON response, an error is thrown. <br>• <strong>Size limits</strong>: The content is checked against a client-side maximum size (<code>DEFAULT_MAX_PASTE_SIZE</code> or <code>getClientMaxSize</code>). If the content exceeds the limit, the save is rejected. <br>• <strong>Filename validation</strong>: Ensures the filename input is valid, sanitized, and includes the <code>.md</code> extension. <br>• <strong>Event dispatching</strong>: If an error occurs at any point in the save process, custom error events (<code>EVENT_RESPONSE_MD</code>) are dispatched to ensure other scripts can react to failures.                                                                                                                                                                          </td></tr><tr><td data-label="Details"> <strong>Concurrency / performance considerations</strong>: • <strong>POST request</strong>: The <code>POST</code> request to <code>/save-md</code> is asynchronous, and the UI remains responsive during the save process. <br>• <strong>Size checks</strong>: The size of the Markdown content is checked before making the network request, avoiding unnecessary network traffic for large files. <br>• <strong>Debounced save</strong>: The event-based save triggers allow for decoupling the save process from UI actions, minimizing unnecessary requests. <br>• <strong>Network retries</strong>: The script does not retry failed network requests, but it ensures users are informed of any failures, with fallback mechanisms where possible.                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Details"> <strong>Edge cases & brittle areas</strong>: 1. <strong>No Markdown content</strong>: If no Markdown is found in the target element, the save is prevented, and an error message is displayed. <br>2. <strong>File size too large</strong>: Content exceeding the maximum size (<code>DEFAULT_MAX_PASTE_SIZE</code> or <code>getClientMaxSize</code>) is rejected, and the user is notified. <br>3. <strong>Invalid server response</strong>: If the server returns a response that cannot be parsed as JSON, the save fails. <br>4. <strong>Filename conflicts</strong>: If a user-provided filename contains illegal characters or exceeds the allowed length, it is sanitized and truncated to meet the constraints.                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Details"> <strong>Integration points & extension hooks</strong>: • <strong>Custom save triggers</strong>: Exposes <code>EVENT_REQUEST_MD</code> for other scripts to trigger a save request. <br>• <strong>Response handling</strong>: <code>EVENT_RESPONSE_MD</code> can be used by other scripts to react to the save result. <br>• <strong>Custom filename handling</strong>: Allows external code to influence the filename prompt behavior. <br>• <strong>Configurable limits</strong>: External code can modify the client-side maximum paste size through <code>window.PTT_CONFIG.MAX_PASTE_SIZE</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Details"> <strong>Recommendations & maintainability notes</strong>: • <strong>Error visibility</strong>: Improve error visibility by logging server responses more thoroughly for debugging. <br>• <strong>Size validation</strong>: Consider adding a visual indication of file size before submission to inform users when content exceeds the client limit. <br>• <strong>Filename customization</strong>: Add a callback to customize the filename prompt behavior (e.g., to fetch the filename dynamically based on user input or document metadata). <br>• <strong>Event logging</strong>: Add debug logs or verbose mode to help with diagnostics during development. <br>• <strong>Unit tests</strong>: Test the filename sanitization and content size validation separately to avoid issues with edge cases.                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Details"> <strong>Short checklist of behaviors to verify when integrating</strong>: • Save process should be initiated when the save button is clicked, and should trigger the appropriate events. <br>• The filename should be sanitized, and the <code>.md</code> extension should be appended if missing. <br>• Content size must be validated before the save request is made. <br>• The server response should be handled correctly, with status updates and any available download links. <br>• In case of errors (e.g., network, invalid response), appropriate messages should be shown to the user.                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Details"> <strong>Conclusion</strong>: <code>assets/script.save.js</code> provides a streamlined client-side mechanism for saving Markdown content. It integrates error handling, file size validation, and filename sanitization with a user-friendly interface and feedback system. Through custom events and configurable parameters, it is extensible and can be integrated into various environments. Key areas for improvement include enhanced error visibility, customizable filename handling, and additional user feedback for content size limitations. The file is well-suited for further enhancements, including support for more complex file-saving workflows.                                                                                                                                                                                                                                                                                                                                      </td></tr></tbody></table></div><div class="row-count">Rows: 12</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>