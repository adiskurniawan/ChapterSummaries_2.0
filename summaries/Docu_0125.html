<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1763456580">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0125_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1 • script.core.js test</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by "><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label=""> <strong>Summary / Purpose</strong><br><br><code>script.core.js</code> is a self-contained client-side module that provides the core runtime for PasteToTable: UI utilities (toasts, clipboard, downloads), conversion orchestration (POST <code>/api/render</code>), DOM rendering of server HTML, caption injection based on externally-loaded <code>labels_injected.json</code>, lightweight TOC loader (<code>script.toc.js</code>), and safe attach/detach of event handlers. The file emphasizes resilience and “best-effort” behavior: nearly every operation is wrapped with <code>try/catch</code> to avoid runtime failures propagating to host pages. Primary responsibilities: reliable conversion workflow (<code>__tv_do_convert</code>), robust caption injection and labels/toc installation (<code>installTocAndLabels</code>, <code>__ptt_apply_injected_captions</code>), progressive script loading (<code>loadExtraSequentially</code>), and utility helpers used across the UI. The module is intentionally defensive and designed to run in varied embedding contexts (iframes, different hosts) with minimal assumptions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label=""> <strong>High-level guarantees & design principles</strong><br><br>• <strong>Fail-safe / non-throwing</strong>: functions use <code>try/catch</code> liberally so the script degrades silently on failure rather than crashing the host page. <br>• <strong>Idempotence & non-destructiveness</strong>: caption injection is idempotent (reuses existing captions when present) and avoids overwriting non-caption nodes with the same ID. <br>• <strong>Progressive enhancement</strong>: loads <code>extra.js</code>, <code>script.toc.js</code>, and <code>labels_injected.json</code> opportunistically from multiple candidate URLs, tolerating fetch failures or timeouts. <br>• <strong>DOM-first short-circuiting</strong>: many helpers check for <code>document.readyState</code> and either run immediately or attach <code>DOMContentLoaded</code> callbacks. <br>• <strong>Minimal global pollution</strong>: exposes a small surface (<code>window.tvUtils</code>, <code>window.PasteToTable.processRenderedHtml</code>, <code>window.__ptt_apply_injected_captions</code>, common aliases) but otherwise keeps helpers scoped to the IIFE. <br>• <strong>Best-effort UX</strong>: toast durations, clipboard fallbacks, and download fallbacks are implemented to maximize success across browsers.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label=""> <strong>Top-level structure & exports</strong><br><br>• <strong>Exports / globals set</strong>: <code>window.tvUtils</code> (copyToClipboard, sanitizeFileName, downloadBlob, showToast, debounce, getSearchEl), <code>window.__tv_utils</code> (internal variants), <code>window.PasteToTable.processRenderedHtml</code>, <code>window.showToast/downloadBlob/copyToClipboard/sanitizeFileName</code> aliases, <code>window.__ptt_apply_injected_captions</code>, <code>window.__ptt_labels_injected</code> (labels map), <code>window.__ptt_toc_and_labels_installed</code> (status), <code>window.__tv_do_convert</code> (conversion entrypoint). <br>• <strong>Major functional groups</strong>: configuration & base detection; debug logging helpers; network & script loaders (<code>loadExtraSequentially</code>, <code>fetchJsonWithTimeout</code>, <code>tryLoadLabels</code>, <code>installTocScript</code>); caption injection logic; conversion & rendering (<code>__tv_do_convert</code>, <code>processRenderedHtml</code>); UI helpers (toasts, clipboard, downloads); event wiring (convert button delegation, action dispatcher); header and attach helpers.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label=""> <strong>Key components & responsibilities (concise)</strong><br><br>1. <strong>Configuration & base detection</strong> — <code>detectScriptBase</code> computes <code>TV_BASE</code>; <code>window.tvConfig</code> established with defaults (highlight, debounceMs, chunkSize). <br>2. <strong>Resilient logging</strong> — <code>dbgInfo</code>, <code>dbgWarn</code>, <code>dbgDebug</code>, <code>dbgError</code> gate console calls on <code>window.tvDebug</code>. <br>3. <strong>Script & asset loader</strong> — <code>loadExtraSequentially</code> and <code>startExtraLoader</code> try multiple candidate paths sequentially; <code>installTocScript</code> wraps that to load <code>script.toc.js</code>. <br>4. <strong>Labels loader</strong> — <code>fetchJsonWithTimeout</code> (AbortController/timeouts fallback) + <code>tryLoadLabels</code> produce a labels map used for caption injection. <br>5. <strong>Caption injection</strong> — <code>__ptt_apply_injected_captions</code> and related helpers (<code>captionFor</code>, <code>injectCaptionForElement</code>) find per-table captions in <code>labels_injected.json</code> and inject or reuse <code>.table-caption</code> elements <em>before</em> the table (important: caption is inserted before the table/collapse toggle). Behavior includes preferring <code>Table{n}</code> id when available, avoiding id collisions with non-caption elements, setting <code>data-table=&quot;&quot;</code>, and inline margins. <br>6. <strong>Renderer orchestration</strong> — <code>__tv_do_convert</code> does POST <code>/api/render</code> (with fallback form-encoded), obtains JSON or HTML payload, and delegates to <code>PasteToTable.routeHtmlToAreas</code> or directly injects into <code>#tables-viewer</code>. <br>7. <strong>processRenderedHtml</strong> — central DOM insertion flow used by <code>__tv_do_convert</code> and consumers; manages <code>__tv_skip_scroll</code> coordination, schedules <code>initRenderedContent</code>, triggers TOC/labels install when <code>metadata.fromList</code> is true, and coordinates scroll-to-top retries. <br>8. <strong>UI helpers</strong> — toasts implementation (<code>showToast</code>, queue, styles, accessibility attributes), clipboard (<code>copyToClipboard</code> with legacy fallback), file download (<code>downloadBlob</code>), debounce, sanitizeFileName. <br>9. <strong>Event wiring</strong> — global convert click delegation, direct attachment to <code>#convertBtn</code>, header handlers (convert/clear/save/render/export). <br>10. <strong>Defensive utilities</strong> — <code>ensureId</code>, <code>escapeHtml</code>, <code>sanitizeForId</code>, <code>normalizeForSearchLocal</code>, small duplication of helpers exists in nested IIFEs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label=""> <strong>Detailed behavior & important implementation notes</strong><br><br><strong>Caption injection specifics</strong> — The injection flow is a focal point:<br>• The labels loader attempts multiple candidate URLs with a short timeout (2.2s in <code>tryLoadLabels</code> / 2.5s default in <code>fetchJsonWithTimeout</code>) and resolves to an object (<code>window.__ptt_labels_injected</code>).<br>• <code>__ptt_apply_injected_captions</code> builds a prioritized list of candidate prefixes (from body <code>data-file</code>/<code>data-source</code>, location basename, document.title, and prefixes inferred from labels keys). It iterates document tables in DOM order and, for each table index <code>idx</code> (1-based), tries a set of key shapes (<code>pref_01</code>, <code>pref_1</code>, <code>pref-01</code>, <code>pref01</code>, etc.) and fallback numeric keys (<code>&#x27;01&#x27;</code>, <code>&#x27;1&#x27;</code>).<br>• When a caption is available, it attempts to use <code>id=&#x27;Table{n}&#x27;</code> for the caption element. If an element with that id exists and is a <code>.table-caption</code>, it updates and reuses it. If an element with that id exists but is not a caption, it finds a unique suffixed id (<code>Table{n}-1</code>, <code>-2</code>, …) to avoid collisions.<br>• Captions are created as <code>&lt;div class=&quot;table-caption&quot; id=&quot;...&quot;&gt;</code> with <code>data-table=&quot;&quot;</code> and inline <code>style.marginTop=&#x27;2mm&#x27;</code> / <code>marginLeft=&#x27;3mm&#x27;</code>. The caption content is inserted using <code>textContent</code> for the <code>strong</code> element (safer) in most places; in one helper copy it uses <code>innerHTML = &#x27;&lt;strong&gt;&#x27; + escapeHtml(...) + &#x27;&lt;/strong&gt;&#x27;</code> (consistent escaping applied). Captions are <em>inserted before the table</em> using <code>parentNode.insertBefore(wrap, tbl)</code> or <code>insertAdjacentElement(&#x27;beforebegin&#x27;, wrap)</code> as fallback.<br><br><strong>Network & loader behavior</strong> — <code>loadExtraSequentially</code> uses synchronous script injection (<code>async: false</code>) via <code>&lt;script&gt;</code> elements appended to <code>&lt;head&gt;</code> and falls back to retrying the next path on <code>onerror</code>. <code>fetchJsonWithTimeout</code> uses <code>AbortController</code> when available and falls back to a timer-based cancel; it always resolves to <code>null</code> on failure (never rejects), in keeping with the fail-safe design.<br><br><strong>Conversion & rendering</strong> — <code>__tv_do_convert</code> tracks <code>window.__tv_convert_in_progress</code> to avoid concurrent conversions, prefers JSON <code>/api/render</code> responses, and gracefully downgrades to inserting HTML string payloads. It ensures <code>payload.metadata.fromList</code> is set only from the caller <code>opts.metadata.fromList</code> (server metadata is not trusted for this flag). After DOM insertion it schedules two <code>initRenderedContent</code> calls (60ms and 420ms) to help downstream scripts initialize. When the conversion is <code>fromList</code>, <code>processRenderedHtml</code> triggers TOC/labels install and then <code>__ptt_apply_injected_captions</code> plus PTToc build hooks where available.<br><br><strong>Toasts & accessibility</strong> — the toast container has <code>role=&quot;status&quot; aria-live=&quot;polite&quot; aria-atomic=&quot;true&quot;</code>. Toasts compute duration dynamically from message length and type, and include manual dismiss buttons. Visual styling is applied inline and color choices are changed for <code>success/warn/error</code> types (note: contrasting color choices are done inline and not via CSS class tokens).<br><br><strong>Defensive programming patterns</strong> — almost every DOM and network operation are wrapped in <code>try/catch</code>; many asynchronous flows swallow errors and record debug warnings only when <code>TV_DEBUG</code> or specific debug flags are set. Functions that mutate global state set idempotent guards (<code>window.__tv_extra_loader_attached</code>, <code>window.__tv_convert_delegation_attached</code>, <code>_attached</code> flags on attachHeaderHandlersOnce) to avoid double attachment. </td></tr><tr><td data-label=""> <strong>Error handling, robustness & failure modes</strong><br><br>• <strong>Non-throwing fail-fast semantics</strong>: the script prefers returning <code>null</code>/<code>false</code> or swallowing errors rather than propagating exceptions. This prevents the host page from breaking but can mask root causes during debugging. <br>• <strong>Partial success paths</strong>: failing to load labels or TOC scripts merely disables caption injection/TOC build; conversion still proceeds and DOM is updated from server payloads. <br>• <strong>Race conditions with DOM readiness</strong>: multiple places attach <code>DOMContentLoaded</code> or check <code>document.readyState</code>; however, asynchronous installs (labels/toc) may complete after <code>processRenderedHtml</code> and re-run caption application — code attempts to handle this via idempotence but timing-sensitive corner cases may remain. <br>• <strong>ID collision handling</strong>: careful handling prevents overwriting existing non-caption elements with <code>Table{n}</code> ids, but if a host page later mutates the DOM to remove or rename elements, captions may not find their intended anchor. <br>• <strong>Network timeouts & format variance</strong>: <code>fetchJsonWithTimeout</code> will return <code>null</code> for non-JSON (or slow) responses; <code>tryLoadLabels</code> resolves to <code>{}</code> if no candidate provides usable JSON. Labels file shape variance (flat keys, nested objects, zero-padded keys) is handled with multiple fallbacks, but unusual formats may still fail to match. <br>• <strong>Silent failure logging</strong>: unless debug flags are enabled, most failures are silent, which is safe but can hurt observability.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label=""> <strong>Concurrency / performance considerations</strong><br><br>• <strong>Conversion deduping</strong>: <code>window.__tv_convert_in_progress</code> prevents concurrent conversions; click-delegation guards prevent duplicate click handling via <code>__tv_convert_handled</code> on events. <br>• <strong>Sequential script loading</strong>: <code>loadExtraSequentially</code> tries candidate URLs one-by-one — this is slow if early candidates are unreachable but safe; the short retry delays (20ms) minimize total wait. <br>• <strong>Caption injection cost</strong>: <code>__ptt_apply_injected_captions</code> iterates all document tables and performs DOM insertions; on very large documents this is O(n) and could be noticeable. The function avoids heavy work when no labels are present. <br>• <strong>Toasts queue</strong>: single active toast with queueing keeps DOM updates small; durations scale with length but are bounded. <br>• <strong>Frequent try/catch</strong>: the pervasive use of <code>try/catch</code> has a measurable cost in hot loops; however, most functions are not performance-critical except table iteration. <br>• <strong>Network timeouts tuned for speed</strong>: label/timeouts are short (2–2.5s) to avoid blocking UX, which may lead to false negatives on slow networks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label=""> <strong>Edge cases & brittle areas</strong><br><br>1. <strong>Duplicate helper definitions</strong> — <code>_normalizeKey</code>, <code>buildPrefixCandidatesFromLabels</code>, and similar helper logic are defined more than once in nested IIFEs (observed duplication in the toc/labels IIFE). This increases maintenance burden and risk of divergence. <br>2. <strong>ID collision complexity</strong> — <code>Table{n}</code> id preference is sensible, but edge cases include servers that already emitted <code>Table{n}</code> for non-caption elements, or when multiple documents share the same DOM and IDs persist between renders. The script attempts to detect and suffix, but collisions can still produce confusing ids. <br>3. <strong>XSS risks & escaping inconsistency</strong> — most caption text is safely assigned using <code>textContent</code> on the created <code>strong</code> element; in a few helper paths the code uses <code>innerHTML = &#x27;&lt;strong&gt;&#x27; + escapeHtml(...) + &#x27;&lt;/strong&gt;&#x27;</code> which is safe if <code>escapeHtml</code> is correct (it is present), but mixed use introduces maintenance risk. Always prefer <code>textContent</code>. <br>4. <strong>Network assumptions</strong> — candidate paths assume <code>TV_BASE</code> correctness and same-origin behavior; some candidate URLs are root-absolute (<code>/labels_injected.json</code>) which may not be present in certain embedding scenarios. <br>5. <strong>Labels format variance</strong> — deeply nested or unexpected keys in labels JSON may not be matched by the key-shape heuristics; mapping logic is complex and can miss cases. <br>6. <strong>Orphaned temp state</strong> — not applicable here, but orphaned injected caption elements may persist across repeated renders if the viewer reuses the same container without a clean-up step. <br>7. <strong>Accessibility</strong> — toasts have ARIA attributes, but inserted captions lack explicit ARIA roles (they are purely presentational) — acceptable for captions but could be enhanced for screen reader announcement.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label=""> <strong>Integration points & extension hooks</strong><br><br>• <strong>Expose a single canonical helper module</strong> — consolidate duplicated helpers (<code>_normalizeKey</code>, <code>sanitizeForId</code>, <code>buildPrefixCandidatesFromLabels</code>) into <code>window.__tv_utils</code> and import from there to reduce duplication. <br>• <strong>Pluggable caption renderer</strong> — expose a hook like <code>window.__ptt_render_caption = function(el, captionText, idx) { /* custom */ }</code> so host pages can customize markup or aria attributes. <br>• <strong>Configurable timeouts & candidates</strong> — allow host to override label/script candidate arrays and fetch timeouts via <code>window.tvConfig</code> or <code>document.body</code> attributes. <br>• <strong>Observability hooks</strong> — emit custom events (e.g., <code>document.dispatchEvent(new CustomEvent(&#x27;ptt:captionsApplied&#x27;,{detail:{injectedCount: X}}))</code>) for analytics and debugging. <br>• <strong>Optional locking / dedupe</strong> — provide an API to remove stale captions before injecting or to scope captions to the viewer subtree (e.g., <code>#tables-viewer</code>) to avoid affecting unrelated tables on host pages.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label=""> <strong>Recommendations & maintainability notes</strong><br><br>• <strong>Deduplicate helper logic</strong>: centralize helpers used in multiple IIFEs (<code>_normalizeKey</code>, <code>buildPrefixCandidatesFromLabels</code>, <code>sanitizeForIdLocal</code> etc.) into <code>window.__tv_utils</code> to reduce drift. <br>• <strong>Prefer <code>textContent</code> over <code>innerHTML</code></strong> for caption insertion to avoid reliance on escaping and reduce XSS risk. Replace <code>innerHTML = &#x27;&lt;strong&gt;...&lt;/strong&gt;&#x27;</code> with <code>const s=document.createElement(&#x27;strong&#x27;); s.textContent=...; wrap.appendChild(s);</code>. <br>• <strong>Increase observability under debug mode</strong>: consolidate debug logs behind <code>TV_DEBUG</code> and optionally surface non-fatal issues via <code>showToastOnce</code> or a debug console element for integrators. <br>• <strong>Parameterize timeouts & candidate lists</strong> via <code>window.tvConfig</code> so embedding pages can tune for slow networks or different asset layouts. <br>• <strong>Document labels JSON shape</strong> and prefer a normalized lookup helper (single canonical <code>captionFor(labelsObj, prefix, idx)</code> exported) to simplify matching logic and reduce duplicate code paths. <br>• <strong>Add cleanup hooks</strong>: before injecting captions, optionally remove captions that were injected by previous runs inside the same viewer container to avoid duplication when HTML is re-rendered into the same element. <br>• <strong>Unit/integration tests</strong>: add tests for caption id collision resolution, labels formats (flat, nested, zero-padded), slow network/timeouts, and conversion error paths. <br>• <strong>Accessibility</strong>: consider adding <code>aria-describedby</code> or linking table <code>id</code> to caption <code>id</code> where semantic connection is desired (if not interfering with existing semantics).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label=""> <strong>Short checklist of behaviors to verify when integrating</strong><br><br>• Script initializes <code>TV_BASE</code> and sets <code>window.tvConfig</code> defaults. <br>• <code>loadExtraSequentially</code> attempts each candidate path and calls <code>onDone</code> on first success; <code>startExtraLoader</code> respects idempotent guards. <br>• <code>tryLoadLabels</code> returns <code>{}</code> when no valid JSON is found; <code>installTocAndLabels</code> populates <code>window.__ptt_labels_injected</code> and <code>window.__ptt_toc_and_labels_installed</code>. <br>• <code>__ptt_apply_injected_captions</code> uses inferred prefixes and numeric fallbacks to find captions; inserts <code>.table-caption</code> elements <strong>before</strong> their related <code>&lt;table&gt;</code>; prefers <code>id=&quot;Table{n}&quot;</code> when available and avoids replacing non-caption elements with same id. <br>• <code>__tv_do_convert</code> posts to <code>/api/render</code>, handles JSON or HTML responses, and delegates to <code>PasteToTable.routeHtmlToAreas</code> when available; conversion flow sets and clears <code>__tv_convert_in_progress</code>. <br>• Toasts queueing, dismiss, and accessibility attributes behave as expected; <code>downloadBlob</code> and clipboard fallbacks work in legacy browsers. <br>• Event handlers for convert, clear, save, render, and action dispatching attach once and do not duplicate.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label=""> <strong>Conclusion</strong><br><br><code>script.core.js</code> is a pragmatic, defensive core suitable for embedding in diverse host pages. It correctly implements caption injection behavior required by PasteToTable: preferring <code>Table{n}</code> ids, inserting captions before the table/collapse toggle, reusing existing caption elements, and robustly loading external labels/toc scripts with sensible fallbacks. Maintenance priorities are (1) deduplicating helper functions, (2) reducing mixed use of <code>innerHTML</code> vs <code>textContent</code> for safety, (3) improving observability under debug mode, and (4) adding configurable timeouts and candidate lists for asset loading. With those changes the module will be easier to test and extend while retaining the current resilience and UX-oriented fallbacks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr></tbody></table></div><div class="row-count">Rows: 12</div></div><div class="table-caption" id="Table2" data-table="Docu_0125_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2 • script.list.js</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by "><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label=""> <strong>Summary / Purpose</strong><br><br><code>script.list.js</code> (saved-files / groups UI) is a client-side module for discovering, organizing, searching, and loading previously-saved table source documents from a server. It queries a set of candidate endpoints for a live index, normalizes varied index shapes into a canonical file list, optionally augments group metadata from a <code>groups.json</code> resource (multiple accepted shapes), presents a modal UI with group rows and per-file load actions, and streams selected files into the paste area (then triggers conversion). The module emphasizes robustness (timeouts, fallbacks), tolerant parsing of heterogeneous server responses, and a high-quality search / scoring UX via an in-memory file search engine. It intentionally does not attempt client-side caption injection — metadata only.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label=""> <strong>High-level guarantees & design principles</strong><br><br>• <strong>Resilient network behavior</strong>: multiple candidate endpoints for live index and groups.json with per-request timeouts and AbortController fallbacks; resolves gracefully on failure. <br>• <strong>Normalization-first</strong>: varied server index shapes (arrays, <code>{ files: [...] }</code>, text listings) are normalized to a canonical <code>{ name, url, path, description }</code> shape via <code>normalizeIndexData</code>. <br>• <strong>Non-destructive UI</strong>: modal-driven group browsing that does not modify server state; load actions send only metadata (fire-and-forget) and then fetch file content to populate the paste area. <br>• <strong>Performance-aware search</strong>: local inverted-index style search implemented in <code>createFileSearchEngine</code> with tokenization/trigrams, candidate pruning, and scoring heuristics tuned for relevance and small latency. <br>• <strong>Fail-safe & defensive</strong>: pervasive <code>try/catch</code> and guarded DOM operations prevent script failures from breaking host pages. <br>• <strong>Accessibility-minded defaults</strong>: dialog role, aria attributes, keyboard escape handling, and focus management for modal UX.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label=""> <strong>Top-level structure & exports</strong><br><br>• No explicit module exports; script runs in global IIFE and attaches behavior via DOM hooks (list button). <br>• Key IDs/constants: <code>LIST_BTN_ID</code>, <code>PASTE_ID</code>, <code>STATUS_ID</code>. <br>• Configurable candidate lists & timeouts: <code>LIVE_FILES_ENDPOINTS</code>, <code>GROUPS_JSON_CANDIDATES</code>, <code>FILE_FETCH_TIMEOUT_MS</code>, <code>INDEX_FETCH_TIMEOUT_MS</code>, <code>GROUPS_FETCH_TIMEOUT_MS</code>. <br>• Main flows: <code>buildAndPresent()</code> (entry), <code>fetchLiveFilesSequential()</code>, <code>loadGroupDescriptions()</code>, <code>presentGroupsOnly()</code>, <code>loadFilesSequentialAndHideForm()</code>, and helper <code>attachListHandler()</code>. <br>• Internal utilities: fetch wrappers (<code>fetchWithTimeout</code>, <code>fetchFileWithTimeout</code>), normalization (<code>normalizeIndexData</code>, <code>tryParseListBodyAsArray</code>), grouping (<code>groupKeyFromPath</code>, <code>buildGroupsFromLive</code>), search engine (<code>createFileSearchEngine</code>), modal builder (<code>createModal</code>).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label=""> <strong>Key components & responsibilities (concise)</strong><br><br>1. <strong>Network fetch with timeout</strong> — <code>fetchWithTimeout(url, timeoutMs)</code> uses <code>AbortController</code> when available, returns <code>{ ok, status, url, body, err }</code> and never rejects; used for index/groups discovery. <br>2. <strong>Index normalization</strong> — <code>normalizeIndexData</code> accepts arrays, <code>{files: []}</code> shapes, or plain text lines and produces canonical entries limited by <code>MAX_LIST_ITEMS</code>. <br>3. <strong>Groups JSON loader</strong> — <code>loadGroupDescriptions()</code> attempts multiple candidate paths, accepts several JSON shapes: <code>{ groups: [...] }</code> array, <code>{ groups: {...} }</code> map, or top-level array of group objects. It returns a mapping for group name/id → human name string with canonKey/keyVariants augmentation. <br>4. <strong>Grouping</strong> — <code>groupKeyFromPath</code> and <code>buildGroupsFromLive</code> assign files to groups heuristically (based on path prefixes, underscore-separated tokens, numeric suffixes), and preserve per-file captions from <code>description</code>. <br>5. <strong>Search engine</strong> — <code>createFileSearchEngine(items, opts)</code> builds an inverted posting map for tokens, supports <code>candidatesForQuery</code> and <code>scoreFiles</code> (asynchronous scoring), tokenization, trigrams, and a cheap Damerau–Levenshtein (<code>cheapDL</code>) for fuzzy short queries. <br>6. <strong>Modal UI & rendering</strong> — <code>presentGroupsOnly(groups, descriptions)</code> builds a searchable modal with group headers, expand/collapse, load buttons, per-file rows, highlight and pagination safeguards. It calls <code>createModal</code> to show the UI and returns a <code>modalHandle</code>. <br>7. <strong>Sequential file loader</strong> — <code>loadFilesSequentialAndHideForm(listOfFiles)</code> fetches each file (with <code>fetchFileWithTimeout</code>), accumulates raw contents with short delays, writes aggregated content into <code>#paste</code> or <code>#page-area</code>, sets <code>window.__tv_group_load_mode = true</code>, dispatches <code>ptt:groupLoaded</code> event, and calls <code>__tv_do_convert</code> (or fallback convert paths). <br>8. <strong>Telemetry post</strong> — <code>trySendActiveGroupMetadata</code> posts a minimal metadata payload to <code>/api/group/load</code> in fire-and-forget manner and logs non-OK responses for debugging.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label=""> <strong>Detailed behavior & important implementation notes</strong><br><br><strong>Discovery & normalization</strong> — <code>buildAndPresent()</code> coordinates parallel <code>fetchLiveFilesSequential(LIVE_FILES_ENDPOINTS)</code> and <code>loadGroupDescriptions()</code>. <code>fetchLiveFilesSequential</code> tries endpoints sequentially until it finds usable body content (JSON array, JSON <code>{files:[]}</code> or newline text list), normalizes entries with <code>normalizeIndexData</code>, and returns <code>{ok, data, source}</code>. Normalizer extracts <code>name</code>, <code>url</code>, <code>path</code>, and <code>description</code> robustly from different shapes. <br><br><strong>Groups loader flexibility</strong> — <code>loadGroupDescriptions</code> accepts: a top-level object with <code>groups</code> array of <code>{id,name}</code>, producing maps keyed by id/name plus canonical and keyVariants; a <code>{ groups: { ... } }</code> object mapping keys to descriptions; or a top-level array of group objects. This maximizes compatibility with varied deployments. <br><br><strong>Group assembly</strong> — <code>buildGroupsFromLive</code> applies <code>groupKeyFromPath</code> to cluster files by inferred group keys (path prefix or base name parts), preserves <code>caption</code> from file description, and sorts groups alphabetically with <code>Ungrouped</code> last. <br><br><strong>Search & scoring</strong> — <code>createFileSearchEngine</code> precomputes <code>tokens</code> and <code>triArr</code> for each item. <code>candidatesForQuery</code> looks up token postings for query tokens and returns candidate indexes. <code>scoreFiles</code> applies boosting: exact quoted phrase, caption/name matches, token matches, prefix beginnings, trigram overlap, short-term fuzzy via <code>cheapDL</code>, and length-based damping. Returns a sorted array of <code>{idx, score}</code>. Heavy loops are synchronous but scoring returns a Promise to avoid blocking the caller. <br><br><strong>Modal & interaction design</strong> — modal includes a search input (focus moved into modal), expand/collapse control, group rows with per-file lists, keyboard support (header <code>tabIndex=0</code>, ESC to close), and click handlers for loading individual files or a whole group. <code>presentGroupsOnly</code> binds per-file click to <code>loadFilesSequentialAndHideForm</code> and uses <code>data-caption</code> attributes for UI. The modal closes on load actions and attempts to send metadata beforehand. <br><br><strong>Sequential file fetching</strong> — <code>loadFilesSequentialAndHideForm</code> fetches each file with a timeout and short inter-request delays (60ms), collects text or failure comments (<code>&lt;!-- failed to fetch ... --&gt;</code>), and then writes combined content into the paste textarea or <code>page-area</code>. It sets <code>window.__tv_last_source</code> and triggers conversion via <code>__tv_do_convert({ text: combinedRaw, metadata: { fromList: true } })</code> when available; otherwise attempts older fallback hooks or a hidden textarea-based approach. It dispatches <code>ptt:groupLoaded</code> and sets <code>window.__tv_group_load_mode = true</code>. </td></tr><tr><td data-label=""> <strong>Error handling, robustness & failure modes</strong><br><br>• <strong>Graceful discovery failure</strong>: <code>fetchLiveFilesSequential</code> and <code>loadGroupDescriptions</code> both return default empty results when all candidates fail; <code>buildAndPresent</code> surfaces status to the user and aborts presenting the modal. <br>• <strong>Per-file fetch failures</strong>: <code>loadFilesSequentialAndHideForm</code> pushes an HTML comment placeholder for failures so the combined payload remains usable and traceable. <br>• <strong>Silent logging</strong>: <code>dbg()</code> only logs if <code>DEBUG</code> or <code>window.__ptt_debug</code> are set; otherwise most failures are suppressed to avoid noisy console output. <br>• <strong>Network race & AbortController differences</strong>: code gracefully handles environments without AbortController by using timers and treating slow fetches as failures; this may produce false negatives on very slow networks. <br>• <strong>Potential large result sets</strong>: <code>MAX_LIST_ITEMS</code> bounds normalization; extremely large index payloads are trimmed. <br>• <strong>UI detachement</strong>: if modal is closed early or DOM mutated, in-flight handlers may attempt to update removed nodes — most DOM operations are guarded but rare exceptions could be swallowed silently.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label=""> <strong>Concurrency / performance considerations</strong><br><br>• <strong>Sequential endpoint probing</strong>: <code>fetchLiveFilesSequential</code> tries endpoints one-by-one, which can add latency if early endpoints are unreachable; however this design reduces parallel network load and is simpler for candidate-fallback semantics. <br>• <strong>Sequential file fetching</strong>: <code>loadFilesSequentialAndHideForm</code> fetches files serially with small delays to avoid overloading the server and to provide incremental progress; this is slower than parallel but more predictable on constrained servers. <br>• <strong>Search scaling</strong>: inverted postings and trigrams keep searches fast for thousands of items; <code>MAX_POSTINGS</code> and <code>MAX_CANDIDATES</code> in the search engine prevent pathological memory growth. <br>• <strong>Synchronous DOM work</strong>: <code>presentGroupsOnly</code> creates many DOM nodes synchronously for groups and files; rendering cost could be noticeable for thousands of files but mitigated by grouping and slicing (per-group file lists sliced to 200 during render). <br>• <strong>Cost of try/catch</strong>: pervasive defensive wrapping has runtime cost but is acceptable given UI-driven (non-hot) workloads.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label=""> <strong>Edge cases & brittle areas</strong><br><br>1. <strong>Heterogeneous index formats</strong> — while normalization covers common shapes, extremely custom index schemas might not map correctly (e.g., nested metadata structures, unusual field names). <br>2. <strong>Group inference heuristics</strong> — <code>groupKeyFromPath</code> uses path prefix and base parts heuristics; files placed with unexpected naming conventions may be mis-grouped. <br>3. <strong>Slow networks & timeouts</strong> — configured timeouts (8–12s) are pragmatic, but environments with CDN or slow mounts may require tuning via config constants. <br>4. <strong>Untrusted server content</strong> — combinedRaw is inserted into a textarea or <code>page-area</code> as text; when falling back to <code>page-area.textContent</code> it's safe, but some other fallback paths (e.g., hidden textarea innerHTML writes) are avoided — overall XSS exposure is low but integrators should ensure server content is sanitized if later inserted as HTML. <br>5. <strong>Large payload memory</strong> — concatenating many large files into memory could be heavy on low-RAM clients; consider streaming or size caps. <br>6. <strong>Event duplication on repeated modal opens</strong> — <code>createModal</code> returns a handle and sets modal closing behavior; <code>attachListHandler</code> uses dataset guard to prevent duplicate bindings, but repeated runs in single-page apps that rehydrate DOM might need explicit cleanup.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label=""> <strong>Integration points & extension hooks</strong><br><br>• <strong>Config overrides</strong> — expose <code>LIVE_FILES_ENDPOINTS</code>, <code>GROUPS_JSON_CANDIDATES</code>, and timeout constants via <code>window</code> config or data attributes so integrators can tune for deployment. <br>• <strong>Pluggable fetch policy</strong> — allow optional parallel file fetching or configurable concurrency via an options parameter to <code>loadFilesSequentialAndHideForm</code>. <br>• <strong>Custom group payload endpoint</strong> — provide a hook <code>onGroupSelected(groupObj)</code> to let host handle loading differently (server-side rendering, streaming). <br>• <strong>Observable events</strong> — emit detailed events (<code>ptt:filesLoaded</code>, <code>ptt:groupsResolved</code>, <code>ptt:fileFetchFailed</code>) with payload for analytics and debugging. <br>• <strong>Search tuning</strong> — allow passing custom tokenizer/stopwords or a richer fuzzy-match library for better results on noisy captions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label=""> <strong>Recommendations & maintainability notes</strong><br><br>• <strong>Expose configuration</strong>: move candidate endpoints and timeout constants into an overridable <code>window.__ptt_list_config</code> so deployments can tune without editing the script. <br>• <strong>Parallelize optional fetches</strong>: add an opt-in concurrent fetch mode with limited concurrency (e.g., 3–6 parallel) to speed up group loads on modern servers while preserving a sequential fallback. <br>• <strong>Backpressure / size cap</strong>: enforce a per-file size cap or aggregated size limit to avoid exhausting client memory when loading many large files. <br>• <strong>Improve logging under debug</strong>: add structured debug logs (including <code>source</code> and counts) and surface non-fatal issues to the modal status area when <code>DEBUG</code> is enabled. <br>• <strong>Test index formats</strong>: add unit tests/fixtures for index shapes (plain arrays, <code>{files:[]}</code>, textual listings) and for <code>groups.json</code> shapes to avoid regressions. <br>• <strong>Avoid innerHTML where unnecessary</strong>: most uses of <code>innerHTML</code> in UI rendering are safe (from sanitized highlights), but prefer <code>textContent</code> + element creation or ensure highlight HTML is sanitized to protect against injected tokens in server-provided names/descriptions. <br>• <strong>Modal reuse/performance</strong>: reuse modal DOM between opens (pool) rather than reconstructing if lists are large to reduce GC churn.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label=""> <strong>Short checklist of behaviors to verify when integrating</strong><br><br>• <code>attachListHandler</code> binds to <code>#listBtn</code> once and <code>buildAndPresent()</code> is invoked on click. <br>• <code>fetchLiveFilesSequential</code> successfully resolves index from at least one candidate or reports 'No live files discovered' via <code>updateStatus</code>. <br>• <code>loadGroupDescriptions</code> accepts <code>{groups: [...]}</code>, <code>{groups: {...}}</code>, and array shapes and returns a usable descriptions map. <br>• <code>buildGroupsFromLive</code> groups files consistently and preserves <code>description</code> → <code>caption</code> for file entries. <br>• <code>presentGroupsOnly</code> modal shows groups, supports search, expand/collapse, load single file and load group actions, and calls <code>loadFilesSequentialAndHideForm</code>. <br>• <code>loadFilesSequentialAndHideForm</code> fetches files with timeouts, concatenates contents in order, places result into <code>#paste</code> and triggers <code>__tv_do_convert</code> with <code>metadata.fromList=true</code>. <br>• <code>trySendActiveGroupMetadata</code> posts metadata to <code>/api/group/load</code> and logs non-OK responses in debug mode.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label=""> <strong>Conclusion</strong><br><br><code>script.list.js</code> is a robust, production-oriented client component for listing and loading saved table sources. It prioritizes compatibility with varied server index formats, provides a capable local search and scoring engine, and presents a polished modal UI for browsing groups and files. Key maintenance opportunities are exposing runtime configuration (endpoints/timeouts), offering optional parallel fetch mode with backpressure, centralizing debug observability, and ensuring modal reuse to reduce DOM churn on large lists. Overall the module aligns well with PasteToTable’s fail-safe, pragmatic design and integrates cleanly with the conversion pipeline (writes to paste area and invokes <code>__tv_do_convert</code>).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr></tbody></table></div><div class="row-count">Rows: 12</div></div><div class="table-caption" id="Table3" data-table="Docu_0125_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3 • script.table.js</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by assets/script.table.js — Exhaustive Technical Breakdown (expanded)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">assets/script.table.js — Exhaustive Technical Breakdown (expanded)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>1) One-line summary / intent</strong>: A defensive, caption-safe client-side table interaction and export subsystem for PasteToTable: builds TOCs from server-rendered caption-like elements (does not create captions), provides single-table row anchors, Unicode-aware search & highlighting, reversible three-state column sorting, collapse/expand UX, copy/export (plain, Markdown, CSV, JSON, XLSX, PDF), responsive control layout, idempotent initialization, and cooperative integration points (PTToc, tvUtils, XLSX, tableVirtualizer).                                                                                                                                                                                                                                    </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>2) Design principles (explicit)</strong>: Non-destructive (reads caption-like nodes but never invents them), idempotent re-init (dataset flags prevent duplicative listeners), feature-graceful (prefer global helpers), defensive (widespread try/catch to avoid runtime crashes), accessible (aria attributes, focus management), compatible (checks APIs like AbortController, matchMedia), observable-extensible (exposes functions on <code>window</code> for other modules).                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>3) Public API & global exposure</strong>: Exposes <code>window.PasteToTable.initRenderedContent</code>, <code>window.PTTable.buildTocs</code>, <code>window.copyTablePlain</code>, <code>window.copyTableMarkdown</code>, <code>window.exportTableCSV</code>, <code>window.exportTableJSON</code>, <code>window.exportTableXLSX</code>, <code>window.exportTablePDF</code>, <code>window.exportAllBtnHandler</code>, <code>window.searchTable</code>, <code>window.toggleTable</code>, <code>window.toggleAllTables</code>, and <code>window.backToTop</code>. Also writes dataset flags (e.g., <code>data-tvHandlerAttached</code>) to DOM elements for idempotency.                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>4) High-level control flow (init)</strong>: On DOMContentLoaded or immediate if ready: <code>initRenderedContent()</code> is invoked → ensure <code>.table-container</code> wrappers exist → build TOCs (<code>buildTocs()</code>) → assign row UIDs and snapshot ordering (<code>_ensureRowUidsAndSnapshot</code>) → cache <code>data-orig-html</code> for cells → attach per-table handlers idempotently → optimize controls layout → update row counts → scroll first table into view.                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>5) TOC behavior & heuristics</strong>: <code>buildTocs()</code> first defers to <code>window.PTToc.init/build</code> (if present) with selectors; fallback runs <code>buildSingleTableToc()</code> and <code>buildTocFromCaptions()</code>. <code>buildSingleTableToc()</code> triggers when a single logical table is present, enumerates body rows (skips <code>thead</code>), creates anchor <code>&lt;li&gt;&lt;a href=&quot;#id&quot;&gt;</code> entries using a stable ID per row. <code>buildTocFromCaptions()</code> collects <code>.table-caption</code>, <code>.table-title</code>, <code>.table-heading</code> nodes, ensures unique IDs (suffixes collisions), and appends links to <code>#toc</code> and <code>#tocBar</code>. Important: it only reads caption nodes — it does not create or mutate caption text.                                                                                                                             </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>6) ID collision strategy</strong>: When an intended id (e.g., <code>Table1</code> or <code>table-1</code>) is already present and not the same element, code suffixes with <code>-1</code>, <code>-2</code>, ... until unique. This prevents accidental anchor conflicts but can lead to proliferating suffixed IDs over repeated runs or interactions by other scripts.                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>7) Row UID snapshotting & sort restoration</strong>: <code>_ensureRowUidsAndSnapshot(table, tableIdx)</code> assigns <code>data-tv-uid = tvuid-N</code> for each row if not present and records <code>originalRowOrders[tableIdx] = [uid...]</code>. <code>sortTableByColumn</code> reorders DOM rows based on comparison, and on 3rd state restores original order by re-attaching rows in the snapshot order, searching by <code>tr[data-tv-uid=&quot;...&quot;]</code>. Restoration fails to include rows added after snapshot or rows without UIDs.                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>8) Sorting algorithm & rules</strong>: Three state per column: 0 (unsorted) → 1 (ascending) → 2 (descending) → 0 (restore). Sorting determines numeric vs lexical ordering by <code>parseFloat</code> on sanitized cell text (commas removed). Numeric sort applied if both parse to numbers. For ties fallback to <code>localeCompare</code>. Sorting mutates DOM by appending rows in sorted order (may cause many reflows). <code>sortStates</code> array stores per-table per-column state; header buttons get <code>sort-state-*</code> classes and <code>aria-sort</code> attributes updated.                                                                                                                                                                                                                                           </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>9) Complexity & performance of sorting</strong>: Sorting cost O(n log n) comparisons for n rows; cost dominated by string parsing/comparisons. DOM reattachment is O(n) append operations causing layout thrashing. For large tables (thousands of rows) this is slow: recommendation — build <code>DocumentFragment</code>, append all sorted rows once, then replace <code>tbody</code> contents in a single operation.                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>10) Search normalization & Unicode handling</strong>: <code>normalizeForSearchLocal</code> uses NFD normalization + removal of combining diacritics <code>\u0300-\u036f</code>, then strips non-letter/number characters. If <code>window.__tv_utils.normalizeForSearchLocal</code> exists, it defers to it. This yields case-insensitive, diacritic-insensitive search.                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>11) Highlight matching algorithm (detailed)</strong>: <code>buildNormalizedMapForCell(cell)</code> walks text nodes with a <code>TreeWalker</code>, constructs <code>normStr</code> — a per-codepoint filtered normalized string — and a <code>map</code> array mapping each normalized character position back to <code>{ nodeIndex, offsetInNode }</code>. This supports matching across multiple adjacent text nodes and surrogate pairs. <code>highlightMatches(cell, filterNorm)</code> finds all occurrences of <code>needle</code> in <code>normStr</code>, then for each match uses <code>map</code> entries to compute start and end text-node offsets and splits/ wraps matched text in <code>&lt;mark&gt;</code> elements. Matches are applied right-to-left to preserve indices. Clearing highlights uses <code>data-orig-html</code> (preferred) or replaces <code>&lt;mark&gt;</code> elements with their text children. </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>12) Edge cases in highlighting (subtle)</strong>: Complex emoji sequences (ZWJ, skin tone modifiers) contain multiple codepoints that may normalize unexpectedly; zero-width joiners and grapheme clusters can cause off-by-one mapping leading to split grapheme rendering. The algorithm attempts codepoint-aware offsets (checks <code>codePointAt</code> and char length) but may still mishandle complex sequences. Recommendation: consider using a grapheme cluster library (e.g., Intl.Segmenter or third-party) or a simpler highlight that searches on node.textContent boundaries for extreme cases.                                                                                                                                                                                   </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>13) Search runtime & mitigation</strong>: Building the normalized map is linear in the number of codepoints in a cell; worst-case for many large cells CPU & memory heavy. Mitigations present in code: debouncing search input; <code>window.tvConfig.highlight</code> guard to skip highlight; recommend: threshold-based skip (e.g., skip highlights for cells > 10k chars), incremental/async chunking, or Web Worker offload for normalization in very large docs.                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>14) Hiding non-matching rows</strong>: <code>searchTable()</code> runs per-table: for each row, clears highlights, computes normalized cell text and checks inclusion of <code>filterNorm</code> (normalized). Rows with no cell matching are hidden (<code>row.style.display = &#x27;none&#x27;</code>). First matching row is scrolled into view. Virtualized tables must call <code>tableVirtualizer.refresh()</code> or <code>update()</code>; code checks for <code>window.tableVirtualizer</code> and tries to call refresh/update if available.                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>15) Copy plain & Markdown behavior</strong>: <code>copyTablePlain(btn)</code> builds tab-separated plain-text from DOM cells and uses <code>copyToClipboard</code>. If table absent, falls back to <code>window.__tv_last_source</code> (raw source) if present. <code>copyTableMarkdown(btn)</code> first tries <code>getPreferredSourceForTable(table)</code> — which tries to map DOM table to its original markdown block in <code>window.__tv_last_source</code> using heuristics (block splitting by blank lines, header matching), preferring original source for accurate Markdown. If not found, <code>tableToMarkdownLines()</code> converts DOM table to pipe-table Markdown. Both use either <code>tvUtils.showCopyModal</code> if available or <code>copyToClipboard</code>.                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>16) Export formats & fallbacks</strong>: CSV: joins rows with commas, quotes containing <code>&quot;</code> by doubling, adds BOM (<code>\uFEFF</code>) to help Excel with UTF-8. JSON: builds array of objects using header row (thead) if present, otherwise <code>ColN</code> keys. XLSX: attempts <code>window.XLSX.utils.book_new</code> + <code>aoa_to_sheet</code> + <code>writeFile</code> or <code>write</code> variations; if unavailable or fails, falls back to creating TSV inside a Blob but warns user. PDF: constructs simple HTML with inline minimal CSS and <code>table.outerHTML</code>, opens a new window, writes HTML and calls <code>print()</code> after a small timeout — may be blocked by popup blockers.                                                                                                                                                          </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>17) Export caveats</strong>: XLSX fallback as TSV is not a true <code>.xlsx</code> binary — consumers expecting native <code>.xlsx</code> may be confused. CSV/TSV use simple quoting but do not attempt advanced escaping for multiline fields beyond simple <code>&quot;</code> quoting. PDF relies on <code>window.open</code> (popup blockers) and on client-side print to PDF support — not guaranteed.                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>18) Collapse/Expand details</strong>: <code>toggleTable(btn)</code> finds wrapper, toggles <code>tbody.style.display</code> between <code>none</code> and <code>&quot;&quot;</code>, toggles button text between 'Collapse Table' and 'Expand Table', updates <code>aria-expanded</code>. <code>toggleAllTables()</code> checks any expanded state and flips globally. This approach toggles visual display but leaves rows present in DOM; virtualizers or accessibility readers may still enumerate hidden rows unless <code>aria-hidden</code> or <code>hidden</code> attributes are used — current code uses style only.                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>19) Layout optimization & responsiveness</strong>: <code>optimizeTableControls()</code> moves control nodes into a <code>.table-header-wrapper</code>, creates a <code>.copy-buttons</code> container if needed, and adapts button sizing/padding for narrow screens (<code>(max-width:600px)</code>). It debounces via <code>window.tvConfig.debounceMs</code>. It also ensures toggle button placement and normalizes classes (<code>table-toggle-inline</code>).                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>20) Event binding & idempotency</strong>: Per-wrapper per-button attachments set <code>btn.dataset.tvTableIndex</code> and <code>btn.dataset.tvHandlerAttached = &quot;1&quot;</code>, avoiding duplicate handlers. Search input bound once (<code>sb.dataset.tvBound</code>). Global delegated click handlers capture sort clicks (by <code>.sort-btn</code>/<code>.th-with-sort</code>) and <code>#tocBar</code> anchor clicks. Keyboard handlers bind <code>/</code> to focus search and <code>Escape</code> to <code>backToTop</code>. All handlers wrapped in <code>try/catch</code>.                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>21) Memory & lifecycle</strong>: The module stores <code>originalRowOrders</code> and cell <code>data-orig-html</code> for each table. No explicit <code>dispose()</code> is provided; if tables are torn down or replaced frequently, memory may grow or stale references remain. Recommendation: add <code>PasteToTable.dispose()</code> to clear <code>originalRowOrders</code>, remove dataset flags, and optionally remove attached listeners.                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>22) Error handling trade-offs</strong>: The code prefers silence over loud failures (many <code>try/catch</code> with empty catches). This avoids user-facing crashes but complicates debugging. Recommendation: add an optional <code>DEBUG</code> flag to log caught errors to <code>console.warn</code> with contextual metadata while preserving stability.                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>23) Integration touchpoints</strong>: Code cooperates with: <code>window.PTToc</code> (TOC builder), <code>window.tvUtils</code> (copy/download/showToast/debounce), <code>window.XLSX</code> (SheetJS), <code>window.tableVirtualizer</code> (refresh/update), <code>window.tvConfig</code> (highlight/debounceMs). Provide these objects for richer behavior. <code>getPreferredSourceForTable</code> depends on <code>window.__tv_last_source</code> populated by other modules.                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>24) Security & sanitization</strong>: Exported HTML for PDF and copy operations uses <code>table.outerHTML</code> and <code>innerHTML</code> in places. Input flow largely reads existing DOM; injection risk is limited because server-rendered content is assumed trusted. However, when producing HTML blobs for download or print, ensure consumers expect raw HTML. <code>escapeHtml</code> is used in other files; this module relies on safe existing DOM and uses <code>textContent</code> in many places to avoid XSS when building strings.                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>25) Accessibility considerations (detailed)</strong>: Sets <code>aria-sort</code> on headers, <code>aria-expanded</code> on toggle buttons, <code>role=&quot;list&quot;</code> on resultsWrap in group UI. TOC links get <code>aria-label</code> and row anchors get <code>tabindex=&quot;-1&quot;</code>. However: hiding rows via <code>style.display = &#x27;none&#x27;</code> does remove them from the accessibility tree in practice, but adding ARIA live announcements for search result counts would improve screen-reader feedback. Also consider adding <code>aria-controls</code> linking TOC items to target tables/captions and <code>aria-live</code> updates for export success/failure.                                                                                                                                                                                                     </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>26) Test matrix & unit/integration checks to add</strong>: (1) Sorting correctness with numeric strings containing commas, negative numbers, empty cells. (2) Restore original order after sort with added/removed rows. (3) Highlight correctness across adjacent text nodes, surrogate pairs, ZWJ sequences, and long text. (4) TOC ID collision resolution when non-caption node already uses <code>Table1</code> id. (5) Copy/Markdown precedence of <code>getPreferredSourceForTable</code>. (6) XLSX variations with different SheetJS build shapes. (7) PDF printing under blocked <code>window.open</code>. (8) Performance profiling for large tables (5k+ rows).                                                                                                                                              </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>27) Performance profiling guidance</strong>: Instrument timings for <code>buildNormalizedMapForCell</code> and <code>highlightMatches</code> per-cell (sample slow cells). Measure DOM reflow cost in <code>sortTableByColumn</code> using <code>performance.now()</code> before/after sort and before/after DOM reattachment. Track memory use for <code>data-orig-html</code> sizes with <code>innerHTML.length</code>. If hotspots exceed thresholds, consider Web Worker normalization, using <code>DocumentFragment</code> batch DOM updates, or virtualization (only render visible rows).                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>28) Concrete code improvements (prioritized)</strong>: 1) Replace row-by-row reappend with <code>DocumentFragment</code> batch re-insert in <code>sortTableByColumn</code>. 2) Add <code>dispose()</code> to remove dataset flags, clear snapshots, and detach event listeners. 3) Add a <code>HIGHLIGHT_MAX_CHARS</code> guard and fallback to non-highlighted filtering for very large cells. 4) Add optional verbose logging under <code>window.__ptt_debug</code> or <code>window.tvDebug</code>. 5) Use <code>requestAnimationFrame</code> when performing many DOM writes to help the browser batch paints. 6) Improve XLSX fallback by shipping a minimal client-side library for true <code>.xlsx</code> generation or push export server-side.                                                                                                                        </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>29) Developer ergonomics / debugging suggestions</strong>: Expose a <code>window.PTTable._diagnostics()</code> that returns counts: number of tables, total rows, total characters in <code>data-orig-html</code>, size of <code>originalRowOrders</code>, memory hints. When <code>window.__ptt_debug</code> true, have critical caught errors <code>console.warn</code> with a context object. Include verbose timestamps for long-running operations.                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>30) Example traces (what happens on group-load -> convert)</strong>: (A) Group UI loads files → <code>loadFilesSequentialAndHideForm</code> fetches and concatenates raw sources → it sets <code>window.__tv_group_load_mode = true</code> and dispatches <code>ptt:groupLoaded</code> event → it calls <code>__tv_do_convert({text, metadata:{fromList:true}})</code> → <code>processRenderedHtml</code> injects HTML into <code>#tables-viewer</code> → sets <code>window.__tv_skip_scroll = true</code> → calls <code>PasteToTable.initRenderedContent()</code> via timeouts → <code>initRenderedContent</code> builds wrappers, caches HTML, builds TOCs (reads captions), attaches handlers, optimizes layout, updates row counts, and clears skip flags after coordinated scroll attempts.                                                                                          </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>31) Known behavior differences vs server-side caption injection</strong>: Because this module never creates caption nodes, pages that expect client-side caption injection will not get captions from this script. Server must provide <code>labels_injected.json</code> and <code>script.toc.js</code> (other files) if captions are desired. This module is intentionally caption-safe to avoid duplicate/inconsistent caption DOM mutations.                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>32) Inter-module invariants to preserve</strong>: - Do not assign IDs that collide with meaningful non-caption elements (use suffixing). - Do not overwrite <code>data-*</code> that other scripts may rely on (use <code>data-tv-*</code> namespace). - Maintain idempotency: repeated <code>initRenderedContent()</code> must not attach duplicate listeners or corrupt <code>data-orig-html</code>. - Honor <code>window.tvConfig.highlight</code> and <code>debounceMs</code> when available.                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>33) Backwards compatibility & browser support</strong>: Checks for <code>dataset</code>, <code>closest</code>, <code>AbortController</code>, <code>matchMedia</code>; avoids ES2020-only features (mostly ES6 used). Uses fallbacks (e.g., <code>document.querySelector</code> variants) so it works on evergreen browsers; some Unicode features rely on <code>String.prototype.normalize(&#x27;NFD&#x27;)</code> — widely available but not in very old engines.                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>34) Security checklist for deployments</strong>: Ensure HTML saved/served to users is sanitized on server-side if users can upload content (this module will render and export table HTML). Avoid including untrusted script tags inside <code>table.outerHTML</code> during export. When invoking <code>downloadBlob</code> for user-generated filenames, still sanitize with <code>sanitizeFileName</code> (file name sanitization exists in other shared utilities).                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>35) Migration notes for heavy pages</strong>: For pages with many tables or very large tables, consider: server-side pagination or server-rendered precomputed exports, enable virtualization and ensure <code>tableVirtualizer</code> integration, or lazy-init this module only for the currently visible table to reduce upfront cost.                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>36) Suggested unit/integration test list (concrete cases)</strong>: - Sort numeric columns with values: <code>[&quot;1,234&quot;, &quot;12.5&quot;, &quot;-3&quot;, &quot;&quot;]</code>. - Highlight across nodes: <code>&lt;td&gt;foo&lt;b&gt;bar&lt;/b&gt;baz&lt;/td&gt;</code> search "barbaz". - TOC collision: page has <code>&lt;div id=&quot;table-1&quot;&gt;&lt;/div&gt;</code> and a caption node — ensure caption id gets suffix. - CSV encoding: cell contains <code>He said &quot;hello&quot;, then left</code> → CSV line should be <code>&quot;He said &quot;&quot;hello&quot;&quot;, then left&quot;</code>. - XLSX SheetJS permutations: stub <code>window.XLSX</code> with <code>writeFile</code>, <code>write</code>, only <code>utils</code> available, or no XLSX. - PDF fallback when <code>window.open</code> returns null. - Group-load -> <code>ptt:groupLoaded</code> event fired, <code>__tv_group_load_mode</code> set to true.                                                                                             </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>37) Developer TODOs / low-effort wins</strong>: Add <code>data-ptt-version</code> comment to file header; instrument <code>window.__ptt_metrics</code> object to track calls & durations; add feature-flag toggles for heavy features (<code>highlight</code>, <code>sortSnapshotting</code>, <code>xlsxSupport</code>); small unit tests for <code>keyVariants</code>, <code>canonKey</code> in other modules (consistency); include optional <code>aria-live</code> region to announce search result counts.                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>38) Long-term architectural suggestions</strong>: Split responsibilities into focused modules: (A) <code>toc-reader</code> (read-only caption/row anchor builder), (B) <code>search-highlighter</code> (pure normalization/highlight logic with testable API), (C) <code>sorter</code> (snapshot + sort operations, with batch DOM API), (D) <code>exporters</code> (CSV/JSON/XLSX/PDF isolated), (E) <code>ui-optimizer</code>. This enables independent perf tuning and test coverage.                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>39) Risk matrix (likelihood × impact)</strong>: High-likelihood, high-impact: heavy highlight CPU on large tables → UI lock. Medium-likelihood, medium-impact: XLSX API mismatch → failed exports. Low-likelihood, high-impact: ID collisions with important page elements → broken anchors/navigation. Mitigations listed above reduce these risks.                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>40) Final concise checklist before deployment</strong>: (1) Enable debug logging temporarily and run integration tests. (2) Profile <code>searchTable()</code> and <code>sortTableByColumn</code> on real page data. (3) Add <code>dispose()</code> if pages dynamically replace table content. (4) Ensure <code>window.XLSX</code> availability if XLSX export required; otherwise communicate fallback. (5) Confirm <code>window.__tv_last_source</code> flow if copy-markdown should prefer original markdown. (6) Add ARIA announcements for search counts and export completions.                                                                                                                                                                                                                                                        </td></tr></tbody></table></div><div class="row-count">Rows: 40</div></div><div class="table-caption" id="Table4" data-table="Docu_0125_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4 • script.toc.js</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by assets/script.toc.js — Exhaustive Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">assets/script.toc.js — Exhaustive Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>1) One-line summary / intent:</strong> Defensive, caption-aware TOC builder for PasteToTable that reads and (optionally) injects server-provided labels from <code>labels_injected.json</code>; builds TOC entries from headings or single-table rows, coordinates label reloads with group-load events, avoids duplicate network calls, and exposes scheduling/reload APIs.                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>2) Design principles & guarantees:</strong> • <strong>Caption-safe</strong>: injects <code>.table-caption</code> only when authoritative labels exist. • <strong>Non-invasive</strong>: minimal DOM mutations, avoids creating caption text from heuristics. • <strong>Idempotent & coordinated</strong>: prevents duplicate installs via <code>window.__pt_toc_installed</code>, uses dataset/global promises to dedupe reloads. • <strong>Deferred network</strong>: <code>deferLabelsReload</code> avoids fetching labels on init by default. • <strong>Defensive</strong>: heavy use of <code>try/catch</code>; best-effort fallbacks. • <strong>Accessible</strong>: TOC links include <code>aria-label</code> and managed <code>aria-current</code> highlighting. </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>3) Public API / globals exposed:</strong> <code>window.PTToc</code> with <code>init(options)</code>, <code>build()</code>, <code>reloadLabels(opts)</code>, <code>getLabels()</code>, <code>scheduleTocRefresh(opts)</code>; also writes/reads global helpers <code>window.__ptt_labels_injected</code>, <code>window.__ptt_labels_reload_promise</code>. Installs interceptors for <code>fetch</code> and <code>XMLHttpRequest</code> to observe <code>/api/group/load</code> POSTs.                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>4) Top-level structure:</strong> Initialization guard → PTToc object with config & state → utility helpers (normalize, id gen, escape) → label fetch helpers & cache-bust logic → reload/schedule functions → group-load interceptors → TOC builders (<code>buildItemsFromSingleTable</code>, <code>buildItemsFromHeadings</code>, <code>buildOnce</code>) → mutation observer & delegated handlers → auto-init on DOM ready.                                                                                                                                                                                                                            </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>5) Configuration options (key fields):</strong> <code>tocSelector</code>, <code>tocListSelector</code>, <code>tocBarListSelector</code>, <code>headingSelector</code>, <code>contentSelector</code>, <code>stickyHeaderId</code>, <code>tableSelector</code>, <code>rowLabelPrefix</code>, <code>labelsPaths</code>, <code>bookPrefix</code>, <code>deferLabelsReload</code>. These control selectors, label lookup behavior, and initial fetch policy.                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>6) Labels discovery strategy:</strong> Tries <code>PTToc.config.labelsPaths</code> in order; when <code>window.__tv_base</code> exists it expands relative candidates against that base and deduplicates; supports cache-bust <code>?t=</code> when forced; writes successful payload to <code>PTToc._labels</code> and <code>window.__ptt_labels_injected</code>.                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>7) fetchJsonOnce & fetchLabels:</strong> <code>fetchJsonOnce</code> is a single-attempt fetch with timeout using <code>AbortController</code> when available; returns <code>null</code> on failure. <code>fetchLabels(paths)</code> is a sequential attempt across candidates, resolving to an object or <code>{}</code>. Both are defensive and log via <code>dbg</code>.                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>8) reloadLabels behavior & coordination:</strong> <code>PTToc.reloadLabels(opts)</code> expands candidate paths, optionally adds <code>window.__tv_base</code> derived URLs, supports <code>force</code> (adds cache-bust), avoids duplicate global reloads by returning <code>window.__ptt_labels_reload_promise</code> when present, and can perform a non-blocking background refresh when global labels exist — it triggers <code>PTToc.build()</code> on load success.                                                                                                                                                                                                    </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>9) scheduleTocRefresh policy:</strong> Exposed helper that runs two forced reload attempts (immediate-ish and delayed). It dedupes concurrent schedules using <code>_scheduledRefreshFlag</code>, uses cache-busted candidate lists and calls <code>PTToc.build()</code> after each attempt. Intended as integration hook for group-load flows.                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>10) Group-load interceptors (fetch + XHR):</strong> Wraps <code>window.fetch</code> and <code>window.XMLHttpRequest</code> to observe requests to <code>/api/group/load</code>. On successful or error completion it calls <code>PTToc.scheduleTocRefresh()</code> (non-blocking). Wrappers attempt to preserve original behavior and fall back to native if errors occur.                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>11) ID generation & normalization:</strong> <code>ensureId(el, prefix)</code> uses <code>_normalize_heading_text</code> to trim <code>&lt;br&gt;</code> and whitespace noise, lowercases and slugifies, truncates to 60 chars, and suffixes with <code>-N</code> until unique. Avoids overwriting existing id if present.                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>12) Heading normalization specifics:</strong> <code>_normalize_heading_text</code> removes <code>&lt;br&gt;</code> tags and all HTML tags, collapses newlines and whitespace — prevents noisy <code>&lt;br&gt;</code> or multiline headings from producing poor IDs or TOC text.                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>13) Caption lookup logic (<code>captionFor</code>):</strong> Mirrors server-side <code>_caption_for</code> patterns: tries <code>bookPrefix_idx</code> (zero-padded), <code>bookPrefix</code> object subkeys, <code>bookPrefix-idx</code>, padded numeric keys, and raw numeric keys. Works with labels shaped as flat maps or nested objects.                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>14) Book prefix inference:</strong> <code>inferBookPrefix()</code> uses <code>PTToc.config.bookPrefix</code> if provided; otherwise infers from <code>location.pathname</code> filename (stripping extension) or falls back to sanitized <code>document.title</code>. Used for matching labels to headings or row indices.                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>15) Single-table mode:</strong> When exactly one table is found, <code>buildItemsFromSingleTable</code> enumerates body rows (handles multiple TBODYs, falls back to <code>tr</code> excluding <code>thead</code>), ensures stable row IDs via <code>ensureId(row, &#x27;row-&#x27;)</code>, and prefers label text from <code>captionFor(labels, bookPrefix, rowIndex)</code> for each row when available; otherwise uses <code>rowLabelPrefix + index</code>.                                                                                                                                                                                                                                     </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>16) Headings mode:</strong> <code>buildItemsFromHeadings</code> selects elements matching <code>PTToc.config.headingSelector</code>, normalizes text, assigns IDs, and uses labels when available. Returns items with <code>{id,label,anchorEl,index}</code> and later calls <code>injectCaptionForElement</code> for headings with matched captions.                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>17) Caption injection policy:</strong> <code>injectCaptionForElement(anchorEl, bookPrefix, idx, captionText)</code> inserts a <code>.table-caption</code> DIV before the heading or table, sets id like <code>TableNN</code> (handles collisions by suffixing), populates safe HTML (<code>&lt;strong&gt;</code> wrapped, escaped), and applies minimal inline styles. Injection only occurs when authoritative label exists. Avoids duplication by checking <code>document.getElementById(expectedId)</code> and updating existing caption when present.                                                                                                                            </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>18) TOC population (buildOnce):</strong> Clears existing <code>tocList</code>/<code>tocBarList</code> and appends <code>&lt;li&gt;&lt;a&gt;</code> entries produced by <code>makeLink(id,text,extraClass)</code>. After populating, it calls <code>highlightCurrentFromLocation()</code> to set <code>aria-current</code> on matching link.                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>19) makeLink attributes & accessibility:</strong> <code>makeLink</code> creates <code>&lt;a&gt;</code> with <code>href=#id</code>, <code>role=link</code>, <code>data-pt-target</code>, and <code>aria-label</code> set to text. The <code>&lt;li&gt;</code> wrapper receives CSS classes via caller. Links are focusable and usable with keyboard and screen readers.                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>20) Delegated click handling & scrolling:</strong> <code>attachDelegatedHandlers</code> binds document click and <code>hashchange</code>. <code>onTocClick</code> intercepts clicks on <code>a[data-pt-target]</code>, prevents default, computes scroll target minus sticky header height, uses smooth scrolling (<code>window.scrollTo({behavior:&#x27;smooth&#x27;})</code>), updates history with <code>history.replaceState</code>, and schedules <code>highlightCurrentFromLocation</code>.                                                                                                                                                                                                              </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>21) highlightCurrentFromLocation:</strong> Reads <code>location.hash</code>, selects TOC links under configured selectors, clears prior <code>aria-current</code>, and sets <code>aria-current=&#x27;page&#x27;</code> on the link whose href or <code>data-pt-target</code> matches the hash. Called after build and on hashchange.                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>22) Mutation observation:</strong> <code>observeMutations()</code> installs a <code>MutationObserver</code> on <code>getContentRoot()</code> to call <code>debounceBuild</code> on DOM changes (childList & subtree). Intended to keep TOC in sync with dynamic content; observer is reconnected idempotently.                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>23) Debounce behavior:</strong> <code>debounceBuild()</code> uses <code>_debounceMs</code> (default 150ms) to throttle repeated rebuilds triggered by mutations or programmatic calls. <code>PTToc.build()</code> simply calls <code>debounceBuild()</code> — safe for repeated invocation.                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>24) Error handling & logging:</strong> Uses <code>dbg()</code> and <code>warn()</code> wrappers that log only when <code>window.tvDebug</code> is true to avoid noisy consoles. Most internal operations swallow exceptions to preserve UX, but debug logging exposes diagnostic info when enabled.                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>25) Security & sanitization:</strong> Caption injection uses <code>escapeHtml()</code> when building caption innerHTML to avoid raw HTML injection. <code>makeLink</code> uses <code>textContent</code> to populate link text. <code>ensureId</code> strips non-word chars to avoid unsafe id content. Networked label content is assumed trusted (server-provided); if labels come from untrusted sources, server-side sanitization is recommended.                                                                                                                                                                                                                </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>26) Concurrency & deduplication mechanisms:</strong> • Global promise <code>window.__ptt_labels_reload_promise</code> prevents concurrent reloads. • <code>_scheduledRefreshFlag</code> prevents parallel schedule sequences. • If <code>window.__ptt_labels_injected</code> exists and <code>force</code> not requested, reload runs as background refresh and returns existing labels immediately. These patterns reduce redundant GETs.                                                                                                                                                                                                                          </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>27) Behavior when labels are absent:</strong> When no labels loaded, module still builds TOC from headings or row numbers using <code>rowLabelPrefix</code>. Caption injection and label-preferring features are skipped gracefully. <code>PTToc._labels</code> defaults to <code>{}</code>.                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>28) Performance considerations:</strong> • Label fetch attempts are sequential; per-candidate timeout (<code>fetchJsonOnce</code>) defaults to ~2500ms — worst-case multi-candidate series may take several seconds. • MutationObserver watches subtree by default which can be noisy on highly dynamic pages; debounce mitigates some churn. • Caption injection and ID generation are O(n) in number of headings/rows and cheap compared to heavy DOM tasks.                                                                                                                                                                     </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>29) Edge cases & brittle areas:</strong> • ID collisions: repeated injections or other scripts creating IDs can produce many suffixed IDs. • Inferred bookPrefix may be incorrect for pages with complex routing or templated titles. • Labels shaped unexpectedly (deeply nested structures) may not be found by <code>captionFor</code>. • fetch/XHR wrappers may break nonstandard <code>fetch</code> semantics or third-party libs expecting native XHR shape — wrapper attempts to preserve prototype but risks subtle compatibility issues.                                                                                             </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>30) Integration touchpoints:</strong> Works with <code>window.__tv_base</code>, <code>window.__ptt_labels_injected</code>, <code>window.tvDebug</code>. Intended to be called by other modules (e.g., group loader) via <code>PTToc.scheduleTocRefresh()</code> after server-side actions. Intercepts <code>/api/group/load</code> to auto-refresh labels after group loads.                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>31) Accessibility considerations:</strong> TOC links get <code>aria-label</code> and <code>aria-current</code>. Scrolling accounts for sticky header. Caption injection uses semantic <code>.table-caption</code> nodes but additional ARIA enhancements are recommended (e.g., <code>aria-controls</code>, live region announcements for TOC updates or counts).                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>32) Test matrix & recommended verifications:</strong> • Label fetch success/failure across candidate permutations and with <code>window.__tv_base</code>. • <code>force=true</code> reloadResults include cache-bust parameter. • Collision handling for <code>TableNN</code> ids. • Single-table row-label injection with and without labels. • Group-load interceptor triggers <code>scheduleTocRefresh</code> on fetch/XHR to <code>/api/group/load</code>. • MutationObserver triggers rebuild only once per burst (debounce behavior).                                                                                                                                    </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>33) Observability & debugging suggestions:</strong> • Expose <code>PTToc._labels</code>, <code>PTToc._reloadPromise</code> and <code>PTToc._scheduledRefreshFlag</code> for diagnostics. • When <code>window.tvDebug</code> enabled, <code>dbg()</code> prints candidate lists, fetch outcomes, and build events. • Add a small metrics object <code>window.__ptt_toc_metrics</code> to count builds, fetch attempts, and injection counts.                                                                                                                                                                                                                                               </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>34) Concrete code improvements (prioritized):</strong> 1) Provide <code>PTToc.dispose()</code> to disconnect observer, remove interceptors, and reset flags. 2) Replace sequential fetch attempts with race + prioritized fallback to reduce worst-case latency while preserving candidate order. 3) Add safety bounds on candidate expansion to avoid long candidate lists. 4) Wrap <code>XMLHttpRequest</code> wrapper to preserve non-enumerable properties and event hooks more robustly (or prefer <code>Proxy</code> where available). 5) Add optional hooks/callbacks for post-build events (e.g., <code>onBuildComplete</code>).                            </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>35) Behavioral examples / sequences:</strong> • Init with <code>deferLabelsReload=true</code>: PTToc builds TOC from headings without fetching labels; later <code>PTToc.scheduleTocRefresh()</code> called by group loader triggers label reload and <code>build()</code> which injects captions and updates TOC. • Group loader posts to <code>/api/group/load</code>: fetch/XHR wrapper detects the URL and schedules a labels refresh twice (near immediate + delayed).                                                                                                                                                                                         </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>36) Failure modes & mitigations:</strong> • Network failures → labels remain empty; mitigated by background refresh attempts and using existing <code>window.__ptt_labels_injected</code> when present. • Wrapper failures → wrappers fall back to native functions where possible and log debug messages. • Excessive mutation noise → debounce reduces rebuild thrash; consider limiting observed subtree or adding filters for relevant node additions.                                                                                                                                                                         </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>37) Security checklist for deployment:</strong> • Serve <code>labels_injected.json</code> from same-origin or ensure CORS appropriate. • Sanitize label content server-side if labels are user-supplied; module escapes caption strings before injecting. • Avoid exposing sensitive URL paths in expanded candidate lists; keep <code>labelsPaths</code> conservative.                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>38) Long-term architectural suggestions:</strong> • Separate concerns: <code>labels-loader</code> (fetch/merge/caching) and <code>toc-renderer</code> (DOM mapping/injection) to simplify testing. • Provide event-driven API (emit <code>labels:loaded</code>, <code>toc:built</code>) instead of implicit global state. • Offer pluggable ID-generation and caption-insertion strategies for consuming apps with different UX needs.                                                                                                                                                                                                                              </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>39) Recommended unit/integration tests (concrete):</strong> • <code>captionFor</code> with flat map, nested map, hyphenated keys, numeric-only keys. • <code>ensureId</code> generates unique, slugified ids and respects existing ids. • <code>reloadLabels</code> with <code>force</code> toggles cache-bust and returns correct promise semantics when <code>window.__ptt_labels_reload_promise</code> exists. • Group-load interceptor triggers schedule on both fetch and XHR paths. • <code>injectCaptionForElement</code> updates existing caption when element with expected id exists.                                                                                           </td></tr><tr><td data-label="assets/script.toc.js — Exhaustive Technical Breakdown"> <strong>40) Final deployment checklist:</strong> • Confirm <code>deferLabelsReload</code> desired default for target site. • Verify <code>labelsPaths</code> candidates include correct base paths for deployment; set <code>window.__tv_base</code> if necessary. • Enable <code>window.tvDebug</code> temporarily to observe reload/build logs during integration. • Add <code>PTToc.dispose()</code> if pages dynamically mount/unmount TOC behavior. • Run test matrix above on representative pages (single table, many headings, dynamic loads). • Document global side-effects (fetch/XHR wrappers, global label variables) for other integrators.                              </td></tr></tbody></table></div><div class="row-count">Rows: 40</div></div><div class="table-caption" id="Table5" data-table="Docu_0125_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5 • script.save.js</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Details**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Details</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Details"> <code>assets/script.save.js</code> provides client-side functionality for saving Markdown content via a POST request to <code>/save-md</code>. It handles the user interface (UI) elements for saving, such as filename prompts and status updates, along with necessary checks (e.g., file size limits). The script integrates with other parts of the page via events to handle Markdown content save actions. It includes features like network error handling, content validation, and status feedback, ensuring a smooth user experience.                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Details"> <strong>High-level guarantees & design principles</strong>: • <strong>User-friendly error handling</strong>: Displays status messages for success/failure with appropriate roles for accessibility. <br>• <strong>File size validation</strong>: Checks the size of the content before attempting to save. <br>• <strong>Filename handling</strong>: Ensures proper filename extension and sanitizes user input for the filename. <br>• <strong>Event-driven</strong>: Uses custom events (<code>EVENT_REQUEST_MD</code>, <code>EVENT_RESPONSE_MD</code>) to trigger and handle the save process. <br>• <strong>Graceful degradation</strong>: If the fetch API or the request fails, fallback options (like direct prompt for user input) ensure continued functionality. <br>• <strong>Extensibility</strong>: The script exposes public methods (like <code>PTT_SAVE.save</code>) for other scripts to programmatically trigger save actions.                                                                                                                                                              </td></tr><tr><td data-label="Details"> <strong>Top-level structure & exports</strong>: • <strong>Public API</strong>: <code>PTT_SAVE.save</code> provides a method for external scripts to save Markdown content. <br>• <strong>Save flow</strong>: Manages the logic for reading, validating, and posting Markdown content. <br>• <strong>Events</strong>: Emits <code>EVENT_REQUEST_MD</code> for custom integrations to request a save, and <code>EVENT_RESPONSE_MD</code> for responding with save results. <br>• <strong>UI elements</strong>: Manages status feedback via <code>STATUS_ID</code> and handles user interactions like filename prompts and save button clicks. <br>• <strong>Error handling</strong>: Provides a robust mechanism for network and client errors, ensuring graceful failure modes.                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Details"> <strong>Key components & responsibilities (concise)</strong>: 1. <strong>Save Button Handler</strong> — Listens for clicks on the save button (<code>SAVE_BTN_ID</code>), preventing default behavior, and dispatches a custom event to trigger the save. <br>2. <strong>Filename Prompt</strong> — Prompts the user to provide a filename for the saved Markdown file, ensuring a valid file name and <code>.md</code> extension. <br>3. <strong>Size Validation</strong> — Checks the size of the content before attempting to save, and rejects files that exceed the client-defined maximum size (<code>getClientMaxSize</code>). <br>4. <strong>POST Request</strong> — Sends the Markdown content as JSON to the backend via a POST request to <code>/save-md</code> using the <code>postSaveMarkdown</code> function. <br>5. <strong>Error Handling</strong> — Handles errors gracefully, displaying status updates and triggering appropriate response events in case of failures (e.g., network issues, invalid server response).                                                                             </td></tr><tr><td data-label="Details"> <strong>Detailed behavior & important implementation notes</strong>: <strong>Save Flow</strong>: The script reads content from a designated element (<code>PASTE_ID</code> or <code>FALLBACK_AREA_ID</code>), validates the content, checks the file size, prompts the user for a filename (if not already provided), and then sends the data via a <code>POST</code> request to <code>/save-md</code>. If the save operation is successful, a message is displayed, and a download link may be provided. In case of errors, appropriate feedback is given. <br> <strong>POST Request</strong>: The request is made with a JSON payload containing the Markdown content and the filename. The server's response is processed to check for success or failure. <br> <strong>UI Feedback</strong>: The script updates a status element (<code>STATUS_ID</code>) to show the user the current state of the save operation, including any errors. <br> <strong>Filename Handling</strong>: The filename is ensured to have a <code>.md</code> extension, and input is sanitized to avoid issues with special characters. </td></tr><tr><td data-label="Details"> <strong>Error handling, robustness & failure modes</strong>: • <strong>Network errors</strong>: Handled by <code>catch</code> blocks in the <code>postSaveMarkdown</code> function, which ensures users are notified of any issues while saving. <br>• <strong>Invalid server response</strong>: If the server returns a non-JSON response, an error is thrown. <br>• <strong>Size limits</strong>: The content is checked against a client-side maximum size (<code>DEFAULT_MAX_PASTE_SIZE</code> or <code>getClientMaxSize</code>). If the content exceeds the limit, the save is rejected. <br>• <strong>Filename validation</strong>: Ensures the filename input is valid, sanitized, and includes the <code>.md</code> extension. <br>• <strong>Event dispatching</strong>: If an error occurs at any point in the save process, custom error events (<code>EVENT_RESPONSE_MD</code>) are dispatched to ensure other scripts can react to failures.                                                                                                                                                                          </td></tr><tr><td data-label="Details"> <strong>Concurrency / performance considerations</strong>: • <strong>POST request</strong>: The <code>POST</code> request to <code>/save-md</code> is asynchronous, and the UI remains responsive during the save process. <br>• <strong>Size checks</strong>: The size of the Markdown content is checked before making the network request, avoiding unnecessary network traffic for large files. <br>• <strong>Debounced save</strong>: The event-based save triggers allow for decoupling the save process from UI actions, minimizing unnecessary requests. <br>• <strong>Network retries</strong>: The script does not retry failed network requests, but it ensures users are informed of any failures, with fallback mechanisms where possible.                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Details"> <strong>Edge cases & brittle areas</strong>: 1. <strong>No Markdown content</strong>: If no Markdown is found in the target element, the save is prevented, and an error message is displayed. <br>2. <strong>File size too large</strong>: Content exceeding the maximum size (<code>DEFAULT_MAX_PASTE_SIZE</code> or <code>getClientMaxSize</code>) is rejected, and the user is notified. <br>3. <strong>Invalid server response</strong>: If the server returns a response that cannot be parsed as JSON, the save fails. <br>4. <strong>Filename conflicts</strong>: If a user-provided filename contains illegal characters or exceeds the allowed length, it is sanitized and truncated to meet the constraints.                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Details"> <strong>Integration points & extension hooks</strong>: • <strong>Custom save triggers</strong>: Exposes <code>EVENT_REQUEST_MD</code> for other scripts to trigger a save request. <br>• <strong>Response handling</strong>: <code>EVENT_RESPONSE_MD</code> can be used by other scripts to react to the save result. <br>• <strong>Custom filename handling</strong>: Allows external code to influence the filename prompt behavior. <br>• <strong>Configurable limits</strong>: External code can modify the client-side maximum paste size through <code>window.PTT_CONFIG.MAX_PASTE_SIZE</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Details"> <strong>Recommendations & maintainability notes</strong>: • <strong>Error visibility</strong>: Improve error visibility by logging server responses more thoroughly for debugging. <br>• <strong>Size validation</strong>: Consider adding a visual indication of file size before submission to inform users when content exceeds the client limit. <br>• <strong>Filename customization</strong>: Add a callback to customize the filename prompt behavior (e.g., to fetch the filename dynamically based on user input or document metadata). <br>• <strong>Event logging</strong>: Add debug logs or verbose mode to help with diagnostics during development. <br>• <strong>Unit tests</strong>: Test the filename sanitization and content size validation separately to avoid issues with edge cases.                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Details"> <strong>Short checklist of behaviors to verify when integrating</strong>: • Save process should be initiated when the save button is clicked, and should trigger the appropriate events. <br>• The filename should be sanitized, and the <code>.md</code> extension should be appended if missing. <br>• Content size must be validated before the save request is made. <br>• The server response should be handled correctly, with status updates and any available download links. <br>• In case of errors (e.g., network, invalid response), appropriate messages should be shown to the user.                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Details"> <strong>Conclusion</strong>: <code>assets/script.save.js</code> provides a streamlined client-side mechanism for saving Markdown content. It integrates error handling, file size validation, and filename sanitization with a user-friendly interface and feedback system. Through custom events and configurable parameters, it is extensible and can be integrated into various environments. Key areas for improvement include enhanced error visibility, customizable filename handling, and additional user feedback for content size limitations. The file is well-suited for further enhancements, including support for more complex file-saving workflows.                                                                                                                                                                                                                                                                                                                                      </td></tr></tbody></table></div><div class="row-count">Rows: 12</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>