<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1763718488">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#Table6">Table 6</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0125_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1 • script.core.js</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by "><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label=""> <strong>Summary / Purpose</strong><br><br><code>script.core.js</code> is a self-contained client-side module that provides the core runtime for PasteToTable: UI utilities (toasts, clipboard, downloads), conversion orchestration (POST <code>/api/render</code>), DOM rendering of server HTML, caption injection based on externally-loaded <code>labels_injected.json</code>, lightweight TOC loader (<code>script.toc.js</code>), and safe attach/detach of event handlers. The file emphasizes resilience and “best-effort” behavior: nearly every operation is wrapped with <code>try/catch</code> to avoid runtime failures propagating to host pages. Primary responsibilities: reliable conversion workflow (<code>__tv_do_convert</code>), robust caption injection and labels/toc installation (<code>installTocAndLabels</code>, <code>__ptt_apply_injected_captions</code>), progressive script loading (<code>loadExtraSequentially</code>), and utility helpers used across the UI. The module is intentionally defensive and designed to run in varied embedding contexts (iframes, different hosts) with minimal assumptions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label=""> <strong>High-level guarantees & design principles</strong><br><br>• <strong>Fail-safe / non-throwing</strong>: functions use <code>try/catch</code> liberally so the script degrades silently on failure rather than crashing the host page. <br>• <strong>Idempotence & non-destructiveness</strong>: caption injection is idempotent (reuses existing captions when present) and avoids overwriting non-caption nodes with the same ID. <br>• <strong>Progressive enhancement</strong>: loads <code>extra.js</code>, <code>script.toc.js</code>, and <code>labels_injected.json</code> opportunistically from multiple candidate URLs, tolerating fetch failures or timeouts. <br>• <strong>DOM-first short-circuiting</strong>: many helpers check for <code>document.readyState</code> and either run immediately or attach <code>DOMContentLoaded</code> callbacks. <br>• <strong>Minimal global pollution</strong>: exposes a small surface (<code>window.tvUtils</code>, <code>window.PasteToTable.processRenderedHtml</code>, <code>window.__ptt_apply_injected_captions</code>, common aliases) but otherwise keeps helpers scoped to the IIFE. <br>• <strong>Best-effort UX</strong>: toast durations, clipboard fallbacks, and download fallbacks are implemented to maximize success across browsers.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label=""> <strong>Top-level structure & exports</strong><br><br>• <strong>Exports / globals set</strong>: <code>window.tvUtils</code> (copyToClipboard, sanitizeFileName, downloadBlob, showToast, debounce, getSearchEl), <code>window.__tv_utils</code> (internal variants), <code>window.PasteToTable.processRenderedHtml</code>, <code>window.showToast/downloadBlob/copyToClipboard/sanitizeFileName</code> aliases, <code>window.__ptt_apply_injected_captions</code>, <code>window.__ptt_labels_injected</code> (labels map), <code>window.__ptt_toc_and_labels_installed</code> (status), <code>window.__tv_do_convert</code> (conversion entrypoint). <br>• <strong>Major functional groups</strong>: configuration & base detection; debug logging helpers; network & script loaders (<code>loadExtraSequentially</code>, <code>fetchJsonWithTimeout</code>, <code>tryLoadLabels</code>, <code>installTocScript</code>); caption injection logic; conversion & rendering (<code>__tv_do_convert</code>, <code>processRenderedHtml</code>); UI helpers (toasts, clipboard, downloads); event wiring (convert button delegation, action dispatcher); header and attach helpers.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label=""> <strong>Key components & responsibilities (concise)</strong><br><br>1. <strong>Configuration & base detection</strong> — <code>detectScriptBase</code> computes <code>TV_BASE</code>; <code>window.tvConfig</code> established with defaults (highlight, debounceMs, chunkSize). <br>2. <strong>Resilient logging</strong> — <code>dbgInfo</code>, <code>dbgWarn</code>, <code>dbgDebug</code>, <code>dbgError</code> gate console calls on <code>window.tvDebug</code>. <br>3. <strong>Script & asset loader</strong> — <code>loadExtraSequentially</code> and <code>startExtraLoader</code> try multiple candidate paths sequentially; <code>installTocScript</code> wraps that to load <code>script.toc.js</code>. <br>4. <strong>Labels loader</strong> — <code>fetchJsonWithTimeout</code> (AbortController/timeouts fallback) + <code>tryLoadLabels</code> produce a labels map used for caption injection. <br>5. <strong>Caption injection</strong> — <code>__ptt_apply_injected_captions</code> and related helpers (<code>captionFor</code>, <code>injectCaptionForElement</code>) find per-table captions in <code>labels_injected.json</code> and inject or reuse <code>.table-caption</code> elements <em>before</em> the table (important: caption is inserted before the table/collapse toggle). Behavior includes preferring <code>Table{n}</code> id when available, avoiding id collisions with non-caption elements, setting <code>data-table=&quot;&quot;</code>, and inline margins. <br>6. <strong>Renderer orchestration</strong> — <code>__tv_do_convert</code> does POST <code>/api/render</code> (with fallback form-encoded), obtains JSON or HTML payload, and delegates to <code>PasteToTable.routeHtmlToAreas</code> or directly injects into <code>#tables-viewer</code>. <br>7. <strong>processRenderedHtml</strong> — central DOM insertion flow used by <code>__tv_do_convert</code> and consumers; manages <code>__tv_skip_scroll</code> coordination, schedules <code>initRenderedContent</code>, triggers TOC/labels install when <code>metadata.fromList</code> is true, and coordinates scroll-to-top retries. <br>8. <strong>UI helpers</strong> — toasts implementation (<code>showToast</code>, queue, styles, accessibility attributes), clipboard (<code>copyToClipboard</code> with legacy fallback), file download (<code>downloadBlob</code>), debounce, sanitizeFileName. <br>9. <strong>Event wiring</strong> — global convert click delegation, direct attachment to <code>#convertBtn</code>, header handlers (convert/clear/save/render/export). <br>10. <strong>Defensive utilities</strong> — <code>ensureId</code>, <code>escapeHtml</code>, <code>sanitizeForId</code>, <code>normalizeForSearchLocal</code>, small duplication of helpers exists in nested IIFEs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label=""> <strong>Detailed behavior & important implementation notes</strong><br><br><strong>Caption injection specifics</strong> — The injection flow is a focal point:<br>• The labels loader attempts multiple candidate URLs with a short timeout (2.2s in <code>tryLoadLabels</code> / 2.5s default in <code>fetchJsonWithTimeout</code>) and resolves to an object (<code>window.__ptt_labels_injected</code>).<br>• <code>__ptt_apply_injected_captions</code> builds a prioritized list of candidate prefixes (from body <code>data-file</code>/<code>data-source</code>, location basename, document.title, and prefixes inferred from labels keys). It iterates document tables in DOM order and, for each table index <code>idx</code> (1-based), tries a set of key shapes (<code>pref_01</code>, <code>pref_1</code>, <code>pref-01</code>, <code>pref01</code>, etc.) and fallback numeric keys (<code>&#x27;01&#x27;</code>, <code>&#x27;1&#x27;</code>).<br>• When a caption is available, it attempts to use <code>id=&#x27;Table{n}&#x27;</code> for the caption element. If an element with that id exists and is a <code>.table-caption</code>, it updates and reuses it. If an element with that id exists but is not a caption, it finds a unique suffixed id (<code>Table{n}-1</code>, <code>-2</code>, …) to avoid collisions.<br>• Captions are created as <code>&lt;div class=&quot;table-caption&quot; id=&quot;...&quot;&gt;</code> with <code>data-table=&quot;&quot;</code> and inline <code>style.marginTop=&#x27;2mm&#x27;</code> / <code>marginLeft=&#x27;3mm&#x27;</code>. The caption content is inserted using <code>textContent</code> for the <code>strong</code> element (safer) in most places; in one helper copy it uses <code>innerHTML = &#x27;&lt;strong&gt;&#x27; + escapeHtml(...) + &#x27;&lt;/strong&gt;&#x27;</code> (consistent escaping applied). Captions are <em>inserted before the table</em> using <code>parentNode.insertBefore(wrap, tbl)</code> or <code>insertAdjacentElement(&#x27;beforebegin&#x27;, wrap)</code> as fallback.<br><br><strong>Network & loader behavior</strong> — <code>loadExtraSequentially</code> uses synchronous script injection (<code>async: false</code>) via <code>&lt;script&gt;</code> elements appended to <code>&lt;head&gt;</code> and falls back to retrying the next path on <code>onerror</code>. <code>fetchJsonWithTimeout</code> uses <code>AbortController</code> when available and falls back to a timer-based cancel; it always resolves to <code>null</code> on failure (never rejects), in keeping with the fail-safe design.<br><br><strong>Conversion & rendering</strong> — <code>__tv_do_convert</code> tracks <code>window.__tv_convert_in_progress</code> to avoid concurrent conversions, prefers JSON <code>/api/render</code> responses, and gracefully downgrades to inserting HTML string payloads. It ensures <code>payload.metadata.fromList</code> is set only from the caller <code>opts.metadata.fromList</code> (server metadata is not trusted for this flag). After DOM insertion it schedules two <code>initRenderedContent</code> calls (60ms and 420ms) to help downstream scripts initialize. When the conversion is <code>fromList</code>, <code>processRenderedHtml</code> triggers TOC/labels install and then <code>__ptt_apply_injected_captions</code> plus PTToc build hooks where available.<br><br><strong>Toasts & accessibility</strong> — the toast container has <code>role=&quot;status&quot; aria-live=&quot;polite&quot; aria-atomic=&quot;true&quot;</code>. Toasts compute duration dynamically from message length and type, and include manual dismiss buttons. Visual styling is applied inline and color choices are changed for <code>success/warn/error</code> types (note: contrasting color choices are done inline and not via CSS class tokens).<br><br><strong>Defensive programming patterns</strong> — almost every DOM and network operation are wrapped in <code>try/catch</code>; many asynchronous flows swallow errors and record debug warnings only when <code>TV_DEBUG</code> or specific debug flags are set. Functions that mutate global state set idempotent guards (<code>window.__tv_extra_loader_attached</code>, <code>window.__tv_convert_delegation_attached</code>, <code>_attached</code> flags on attachHeaderHandlersOnce) to avoid double attachment. </td></tr><tr><td data-label=""> <strong>Error handling, robustness & failure modes</strong><br><br>• <strong>Non-throwing fail-fast semantics</strong>: the script prefers returning <code>null</code>/<code>false</code> or swallowing errors rather than propagating exceptions. This prevents the host page from breaking but can mask root causes during debugging. <br>• <strong>Partial success paths</strong>: failing to load labels or TOC scripts merely disables caption injection/TOC build; conversion still proceeds and DOM is updated from server payloads. <br>• <strong>Race conditions with DOM readiness</strong>: multiple places attach <code>DOMContentLoaded</code> or check <code>document.readyState</code>; however, asynchronous installs (labels/toc) may complete after <code>processRenderedHtml</code> and re-run caption application — code attempts to handle this via idempotence but timing-sensitive corner cases may remain. <br>• <strong>ID collision handling</strong>: careful handling prevents overwriting existing non-caption elements with <code>Table{n}</code> ids, but if a host page later mutates the DOM to remove or rename elements, captions may not find their intended anchor. <br>• <strong>Network timeouts & format variance</strong>: <code>fetchJsonWithTimeout</code> will return <code>null</code> for non-JSON (or slow) responses; <code>tryLoadLabels</code> resolves to <code>{}</code> if no candidate provides usable JSON. Labels file shape variance (flat keys, nested objects, zero-padded keys) is handled with multiple fallbacks, but unusual formats may still fail to match. <br>• <strong>Silent failure logging</strong>: unless debug flags are enabled, most failures are silent, which is safe but can hurt observability.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label=""> <strong>Concurrency / performance considerations</strong><br><br>• <strong>Conversion deduping</strong>: <code>window.__tv_convert_in_progress</code> prevents concurrent conversions; click-delegation guards prevent duplicate click handling via <code>__tv_convert_handled</code> on events. <br>• <strong>Sequential script loading</strong>: <code>loadExtraSequentially</code> tries candidate URLs one-by-one — this is slow if early candidates are unreachable but safe; the short retry delays (20ms) minimize total wait. <br>• <strong>Caption injection cost</strong>: <code>__ptt_apply_injected_captions</code> iterates all document tables and performs DOM insertions; on very large documents this is O(n) and could be noticeable. The function avoids heavy work when no labels are present. <br>• <strong>Toasts queue</strong>: single active toast with queueing keeps DOM updates small; durations scale with length but are bounded. <br>• <strong>Frequent try/catch</strong>: the pervasive use of <code>try/catch</code> has a measurable cost in hot loops; however, most functions are not performance-critical except table iteration. <br>• <strong>Network timeouts tuned for speed</strong>: label/timeouts are short (2–2.5s) to avoid blocking UX, which may lead to false negatives on slow networks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label=""> <strong>Edge cases & brittle areas</strong><br><br>1. <strong>Duplicate helper definitions</strong> — <code>_normalizeKey</code>, <code>buildPrefixCandidatesFromLabels</code>, and similar helper logic are defined more than once in nested IIFEs (observed duplication in the toc/labels IIFE). This increases maintenance burden and risk of divergence. <br>2. <strong>ID collision complexity</strong> — <code>Table{n}</code> id preference is sensible, but edge cases include servers that already emitted <code>Table{n}</code> for non-caption elements, or when multiple documents share the same DOM and IDs persist between renders. The script attempts to detect and suffix, but collisions can still produce confusing ids. <br>3. <strong>XSS risks & escaping inconsistency</strong> — most caption text is safely assigned using <code>textContent</code> on the created <code>strong</code> element; in a few helper paths the code uses <code>innerHTML = &#x27;&lt;strong&gt;&#x27; + escapeHtml(...) + &#x27;&lt;/strong&gt;&#x27;</code> which is safe if <code>escapeHtml</code> is correct (it is present), but mixed use introduces maintenance risk. Always prefer <code>textContent</code>. <br>4. <strong>Network assumptions</strong> — candidate paths assume <code>TV_BASE</code> correctness and same-origin behavior; some candidate URLs are root-absolute (<code>/labels_injected.json</code>) which may not be present in certain embedding scenarios. <br>5. <strong>Labels format variance</strong> — deeply nested or unexpected keys in labels JSON may not be matched by the key-shape heuristics; mapping logic is complex and can miss cases. <br>6. <strong>Orphaned temp state</strong> — not applicable here, but orphaned injected caption elements may persist across repeated renders if the viewer reuses the same container without a clean-up step. <br>7. <strong>Accessibility</strong> — toasts have ARIA attributes, but inserted captions lack explicit ARIA roles (they are purely presentational) — acceptable for captions but could be enhanced for screen reader announcement.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label=""> <strong>Integration points & extension hooks</strong><br><br>• <strong>Expose a single canonical helper module</strong> — consolidate duplicated helpers (<code>_normalizeKey</code>, <code>sanitizeForId</code>, <code>buildPrefixCandidatesFromLabels</code>) into <code>window.__tv_utils</code> and import from there to reduce duplication. <br>• <strong>Pluggable caption renderer</strong> — expose a hook like <code>window.__ptt_render_caption = function(el, captionText, idx) { /* custom */ }</code> so host pages can customize markup or aria attributes. <br>• <strong>Configurable timeouts & candidates</strong> — allow host to override label/script candidate arrays and fetch timeouts via <code>window.tvConfig</code> or <code>document.body</code> attributes. <br>• <strong>Observability hooks</strong> — emit custom events (e.g., <code>document.dispatchEvent(new CustomEvent(&#x27;ptt:captionsApplied&#x27;,{detail:{injectedCount: X}}))</code>) for analytics and debugging. <br>• <strong>Optional locking / dedupe</strong> — provide an API to remove stale captions before injecting or to scope captions to the viewer subtree (e.g., <code>#tables-viewer</code>) to avoid affecting unrelated tables on host pages.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label=""> <strong>Recommendations & maintainability notes</strong><br><br>• <strong>Deduplicate helper logic</strong>: centralize helpers used in multiple IIFEs (<code>_normalizeKey</code>, <code>buildPrefixCandidatesFromLabels</code>, <code>sanitizeForIdLocal</code> etc.) into <code>window.__tv_utils</code> to reduce drift. <br>• <strong>Prefer <code>textContent</code> over <code>innerHTML</code></strong> for caption insertion to avoid reliance on escaping and reduce XSS risk. Replace <code>innerHTML = &#x27;&lt;strong&gt;...&lt;/strong&gt;&#x27;</code> with <code>const s=document.createElement(&#x27;strong&#x27;); s.textContent=...; wrap.appendChild(s);</code>. <br>• <strong>Increase observability under debug mode</strong>: consolidate debug logs behind <code>TV_DEBUG</code> and optionally surface non-fatal issues via <code>showToastOnce</code> or a debug console element for integrators. <br>• <strong>Parameterize timeouts & candidate lists</strong> via <code>window.tvConfig</code> so embedding pages can tune for slow networks or different asset layouts. <br>• <strong>Document labels JSON shape</strong> and prefer a normalized lookup helper (single canonical <code>captionFor(labelsObj, prefix, idx)</code> exported) to simplify matching logic and reduce duplicate code paths. <br>• <strong>Add cleanup hooks</strong>: before injecting captions, optionally remove captions that were injected by previous runs inside the same viewer container to avoid duplication when HTML is re-rendered into the same element. <br>• <strong>Unit/integration tests</strong>: add tests for caption id collision resolution, labels formats (flat, nested, zero-padded), slow network/timeouts, and conversion error paths. <br>• <strong>Accessibility</strong>: consider adding <code>aria-describedby</code> or linking table <code>id</code> to caption <code>id</code> where semantic connection is desired (if not interfering with existing semantics).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label=""> <strong>Short checklist of behaviors to verify when integrating</strong><br><br>• Script initializes <code>TV_BASE</code> and sets <code>window.tvConfig</code> defaults. <br>• <code>loadExtraSequentially</code> attempts each candidate path and calls <code>onDone</code> on first success; <code>startExtraLoader</code> respects idempotent guards. <br>• <code>tryLoadLabels</code> returns <code>{}</code> when no valid JSON is found; <code>installTocAndLabels</code> populates <code>window.__ptt_labels_injected</code> and <code>window.__ptt_toc_and_labels_installed</code>. <br>• <code>__ptt_apply_injected_captions</code> uses inferred prefixes and numeric fallbacks to find captions; inserts <code>.table-caption</code> elements <strong>before</strong> their related <code>&lt;table&gt;</code>; prefers <code>id=&quot;Table{n}&quot;</code> when available and avoids replacing non-caption elements with same id. <br>• <code>__tv_do_convert</code> posts to <code>/api/render</code>, handles JSON or HTML responses, and delegates to <code>PasteToTable.routeHtmlToAreas</code> when available; conversion flow sets and clears <code>__tv_convert_in_progress</code>. <br>• Toasts queueing, dismiss, and accessibility attributes behave as expected; <code>downloadBlob</code> and clipboard fallbacks work in legacy browsers. <br>• Event handlers for convert, clear, save, render, and action dispatching attach once and do not duplicate.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label=""> <strong>Conclusion</strong><br><br><code>script.core.js</code> is a pragmatic, defensive core suitable for embedding in diverse host pages. It correctly implements caption injection behavior required by PasteToTable: preferring <code>Table{n}</code> ids, inserting captions before the table/collapse toggle, reusing existing caption elements, and robustly loading external labels/toc scripts with sensible fallbacks. Maintenance priorities are (1) deduplicating helper functions, (2) reducing mixed use of <code>innerHTML</code> vs <code>textContent</code> for safety, (3) improving observability under debug mode, and (4) adding configurable timeouts and candidate lists for asset loading. With those changes the module will be easier to test and extend while retaining the current resilience and UX-oriented fallbacks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr></tbody></table></div><div class="row-count">Rows: 12</div></div><div class="table-caption" id="Table2" data-table="Docu_0125_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2 • script.list.js</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical breakdown (script.list.js)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical breakdown (script.list.js)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Overview & intent</strong><br>Provides a robust client-side “Saved groups / list” UI and loader for PasteToTable. Responsibilities: discover server-side saved-file indices, normalize file metadata, build group structures, present a searchable modal UI, fetch selected files (parallel with ordered assembly), expose runtime captions, invoke conversion/rendering, and optionally post lightweight group-load metadata. The file emphasizes defensive coding, timeouts, and graceful fallbacks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>High-level architecture</strong><br>1. <strong>Config & feature flags</strong> — multiple tunables at top (endpoints, timeouts, MAX_LIST_ITEMS, cache-buster, ENABLE_WORKER_SCORING, etc.).<br>2. <strong>Core fetch layer</strong> — <code>fetchWithTimeout</code> and <code>fetchFileWithTimeout</code> provide timed fetches with AbortController when available.<br>3. <strong>Index normalization</strong> — <code>normalizeIndexData</code> + <code>tryParseListBodyAsArray</code> sanitize various index shapes into canonical <code>{ name, url, path, description }</code> items.<br>4. <strong>Label & groups loaders</strong> — <code>loadLabels()</code> reads labels.json candidates and builds a label index; <code>loadGroupDescriptions()</code> reads groups.json candidates; both attempt multiple candidates sequentially with fallback.<br>5. <strong>Group building</strong> — <code>buildGroupsFromLive</code> groups normalized files by <code>groupKeyFromPath()</code> and resolves per-file captions via <code>resolveCaptionFor()</code> using the label index.<br>6. <strong>Search engine</strong> — <code>createFileSearchEngine</code> creates an in-memory inverted index + trigram arrays and exposes <code>candidatesForQuery</code> and <code>scoreFiles</code> for ranking. (Worker flags exist but worker plumbing is not present here.)<br>7. <strong>UI modal</strong> — <code>presentGroupsOnly</code> constructs the modal, search input, group rows, expansion controls, and wire-ups; uses <code>createModal</code> to render a styled dialog with many inline styles.<br>8. <strong>File loading</strong> — <code>loadFilesSequentialAndHideForm</code> (keeps original name) performs parallel fetches of selected files, preserves order, assembles combined raw/marked content, writes to paste area (or page-area), freezes <code>window.__ptt_runtime_captions</code>, calls renderer (<code>__tv_do_convert</code> or fallback hidden textarea), applies runtime captions by polling for DOM caption nodes, and dispatches <code>ptt:groupLoaded</code> on microtask queue.<br>9. <strong>Copy handling & paste-sync</strong> — copy delegation to renderer (<code>copyTableMarkdown</code>, <code>copyTablePlain</code>) with robust clipboard fallback; keeps <code>__tv_last_source</code> synced on textarea edits.<br>10. <strong>Public entrypoint</strong> — <code>attachListHandler</code> binds to <code>#listBtn</code> to call <code>buildAndPresent</code>. </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Key functions (concise)</strong><br><strong>fetchWithTimeout(url, timeoutMs)</strong> — fetch wrapper returning <code>{ok,status,url,body,err}</code>; uses AbortController and resolves rather than throwing to simplify callers.<br><strong>normalizeIndexData(raw)</strong> — supports array-of-strings, array-of-objects, and <code>{files: [...]}</code> shapes; protects MAX_LIST_ITEMS.<br><strong>fetchLiveFilesSequential(endpoints)</strong> — sequential probe over candidate endpoints, unchanged from prior version; returns first valid index (array or text list).<br><strong>loadLabels()</strong> — sequentially attempts LABELS_JSON_CANDIDATES and builds <code>__ptt_labels_cache</code> using <code>buildLabelIndex</code>.<br><strong>buildLabelIndex(raw)</strong> — builds many key-variants for tolerant caption lookup (keyVariants, canonKey).<br><strong>buildGroupsFromLive(liveFiles, labelsIndex)</strong> — groups files by <code>groupKeyFromPath</code>, sorts keys (Ungrouped last), forms group objects with <code>files: [{name,url,path,caption}]</code>.<br><strong>createFileSearchEngine(items, opts)</strong> — builds lite index with tokenization, tri-arrays, inverted postings; exposes <code>candidatesForQuery</code> and <code>scoreFiles</code> (synchronous CPU scoring wrapped in Promise).<br><strong>loadFilesSequentialAndHideForm(listOfFiles)</strong> — parallel fetch preserving original order, safe decode, runtime-caption extraction & freeze, assemble combinedMarked/combinedRaw, write to paste area, call convert (or hidden fallback), schedule caption application attempts (polling loop), microtask-dispatch ptt:groupLoaded.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Defensive patterns used</strong><br>- Extensive <code>try/catch</code> blocks around most operations to avoid breakage.<br>- Feature-detection for <code>AbortController</code>, <code>TextDecoder</code>, and clipboard API.<br>- Return-value shapes for fetch utils instead of throwing, simplifying callers.<br>- Immutability attempts: runtime captions are deep-cloned and <code>Object.freeze</code>d before exposure.<br>- Timeouts & limits (per-fetch timeouts, MAX_LIST_ITEMS, MAX_CANDIDATES_FROM_INDEX).<br>- Non-blocking UI: DocumentFragment usage, debounce on search, Promise-based scoring.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Notable behaviors & compatibility choices</strong><br>- Keeps legacy function names and API (e.g., <code>loadFilesSequentialAndHideForm</code>) for backward compatibility.<br>- Removed per-file label injection responsibilities (moved to script.toc.js) — separation of concerns.<br>- Posts group metadata to <code>/api/group/load</code> with full file list by default in <code>trySendActiveGroupMetadata</code> (see privacy note below).<br>- Uses <code>encodedSavedUrlFor()</code> that synthesizes <code>/saved/</code> paths for local files.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Performance & scalability notes</strong><br>- Parallel file fetch with ordered assembly: fetchPromises = map(...) + <code>Promise.all</code> preserves order while enabling concurrency — good for latency.<br>- <code>fetchLiveFilesSequential</code> is still sequential: endpoint discovery worst-case latency equals sum of probe times (recommend bounded parallelization).<br>- Scoring is CPU-heavy and runs synchronously inside <code>scoreFiles</code>; flags for worker scoring exist but no worker fallback is wired — for large datasets (>= WORKER_THRESHOLD) consider moving scoring to a Web Worker.<br>- <code>createFileSearchEngine</code> builds inverted postings limited by MAX_POSTINGS — prevents memory blowups but may reduce recall on very large collections.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Security, privacy & CSP considerations</strong><br>- <strong>Telemetry privacy</strong>: <code>trySendActiveGroupMetadata</code> by default includes filenames, captions, and file paths in POST body to <code>/api/group/load</code>. This can leak sensitive metadata; code does not require opt-in. Recommend opt-in or redaction by default.<br>- <strong>CSP / inline styles</strong>: modal and many UI elements use inline <code>style</code> assignments. In CSP environments disallowing inline style attributes or 'unsafe-inline' for style-src, these styles may be blocked or require nonces. Recommend moving styles to CSS classes and an external stylesheet or CSP-compatible injected <code>&lt;style&gt;</code> with nonce support.<br>- <strong>HTML injection</strong>: <code>presentGroupsOnly</code> uses <code>innerHTML</code> for highlighting by inserting <code>&lt;mark&gt;</code> and sanitized highlight output. <code>sanitizeCaptionForInjection</code> and <code>escapeHtml</code> are used where appropriate, but several places set <code>.innerHTML</code> (e.g., nameLine.innerHTML) using output of <code>highlight()</code> which uses <code>escapeHtmlLocal</code> — OK but must ensure <code>escapeHtmlLocal</code> is always applied before HTML insertion.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Bugs / risky assumptions / edge cases</strong><br>1. <strong>ASCII-only tokenizer</strong>: <code>tokenize</code> in <code>createFileSearchEngine</code> uses <code>/[^a-z0-9\s]+/g</code> — strips non-Latin characters. Non-Latin (CJK, accented, Cyrillic, Arabic) search and tokenization will fail. Recommend Unicode-aware tokenization (e.g., <code>\p{L}\p{N}</code> with <code>u</code> flag).<br>2. <strong>Worker flags unused</strong>: <code>ENABLE_WORKER_SCORING</code> and <code>WORKER_THRESHOLD</code> exist but no worker spawn or fallback implemented; large datasets will run scoring on main thread. Either implement worker or remove flag.<br>3. <strong>fetchLiveFilesSequential sequential probes</strong>: endpoint discovery remains sequential; can produce high latency if first valid endpoint is last. Consider probing first N in parallel with bounded concurrency and fallback to sequential order.<br>4. <strong>encodedSavedUrlFor() routing assumption</strong>: mandates <code>/saved/</code> base for encoded paths — if server routing differs, generated URLs may 404. Make base path configurable or consult server-provided URLs before synthesizing. <br>5. <strong>No global cancellation</strong>: <code>loadFilesSequentialAndHideForm</code> creates per-fetch AbortControllers but no mechanism to cancel the whole set if user closes modal or navigates away. Add an AbortController group or cancellation token to abort in-flight fetches and stop polling caption-apply ticks.<br>6. <strong>Label loading race</strong>: runtime captions are frozen and exposed, but <code>loadLabels()</code> sets <code>window.PTLabels</code> and <code>__ptt_labels_cache</code> — merging runtime captions vs static labels might conflict; ensure resolution precedence is clear.<br>7. <strong>Duplicate trigram/token functions</strong>: <code>trigramsOf</code> exists in both engine and modal-local scope — consider factoring to single utility to ensure consistency.                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Maintainability observations</strong><br>- File is lengthy (~2000+ lines across parts) with many nested try/catch blocks — resilient but noisy.<br>- Many global variables and window names used (<code>__ptt_runtime_captions</code>, <code>__tv_last_source</code>, <code>__ptt_list_render_in_progress</code>, <code>__ptt_labels_cache</code>, <code>PTLabels</code>, etc.). Document these globals as integration contract.<br>- Inline style proliferation makes visual adjustments tedious; centralize CSS.<br>- Logging via <code>dbg()</code> controlled by DEBUG flag — consider a scoped logger that can be toggled at runtime without editing code.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Concrete recommended fixes (priority order)</strong><br><strong>High-priority</strong><br>- Replace ASCII tokenizer with Unicode-aware tokenizer (e.g., <code>s.replace(/[^\p{L}\p{N}\s]+/gu,&#x27; &#x27;)</code> and split). Update highlighting to use same tokenizer. <br>- Make telemetry opt-in and redact by default: require <code>PTT_CONFIG.telemetry === true</code> to POST, and avoid sending filenames/captions unless explicitly authorized; otherwise send group id and counts only.<br>- Add configurable <code>savedBasePath</code> to avoid hardcoded <code>/saved/</code> and make <code>encodedSavedUrlFor</code> use config.<br>- Implement overall cancellation for <code>loadFilesSequentialAndHideForm</code>: return an object with <code>.cancel()</code> or use a shared AbortController to abort fetches and stop caption polling when modal closed. <br><strong>Medium-priority</strong><br>- Wire up worker-based scoring when <code>ENABLE_WORKER_SCORING === true</code> and fall back gracefully if worker not available; or remove flags.<br>- Parallelize initial live-endpoint probes with bounded concurrency (N=2) to reduce worst-case discovery latency.<br>- Move inline modal styles into a CSS class and offer <code>PTT_CONFIG.cspNonce</code> or external stylesheet option. <br><strong>Low-priority / nice-to-have</strong><br>- Factor common utilities (trigrams/tokenize/escapeHtml) into shared helpers.<br>- Add more explicit logging levels and a <code>PTT_CONFIG.debug</code> runtime switch.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Suggested tests</strong><br><strong>Unit</strong>: <code>normalizeIndexData</code> with many index shapes; <code>tryParseListBodyAsArray</code>; <code>buildLabelIndex</code> and <code>resolveCaptionFor</code> with variant keys; <code>createFileSearchEngine</code> token/posting correctness; tokenizer Unicode cases; <code>encodedSavedUrlFor</code> with edge segment characters.<br><strong>Integration</strong>: <code>fetchWithTimeout</code> network timeout & abort behavior; <code>loadLabels</code> candidate fallback; <code>fetchLiveFilesSequential</code> when endpoints return JSON vs text list; <code>loadFilesSequentialAndHideForm</code> parallel fetch order and failure handling.<br><strong>E2E / Load</strong>: Large index (thousands) to test indexing time, memory, and search latency; verify worker fallback and UI responsiveness.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Compatibility & integration checklist</strong><br>- Document and allow overriding of all top-level config flags at runtime (endpoints, timeouts, saved base path, cache-buster).<br>- Provide <code>PTT</code> hooks: <code>PTT.on(&#x27;groupLoad&#x27;, fn)</code> or <code>PTT.notifyCancel()</code> for host to cancel operations.<br>- Ensure server side protects <code>/api/group/load</code> (CSRF/auth checks) before accepting metadata posts.<br>- Provide an integration guide listing expected global names (e.g., <code>__tv_do_convert</code>, <code>__tv_last_source</code>) and how to opt-out of telemetry/auto-posting.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Potential regressions to watch for when changing code</strong><br>- Changing tokenizer or ID/key normalization will alter search behavior and may break saved label lookups (<code>labels.json</code> key variants).<br>- Making <code>/saved/</code> base configurable may change produced URLs — ensure backward compatibility for existing deployments or provide a migration shim.<br>- Moving styles to CSS classes may alter appearance slightly; provide default stylesheet to keep parity.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Technical breakdown (script.list.js)"> <strong>Final concise verdict</strong><br>Well-engineered, defensive list loader and UI with careful fallbacks and thoughtful UX. Required hard fixes before broad production rollout: Unicode-aware tokenization & highlighting, telemetry opt-in/redaction, configurable saved-path generation, cancellation for in-flight fetches, and either implement or remove worker-scoring flags. After applying these fixes and adding unit/integration tests, the module is appropriate for single-tenant and small-to-medium deployments.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr></tbody></table></div><div class="row-count">Rows: 14</div></div><div class="table-caption" id="Table3" data-table="Docu_0125_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3 • script.table.js</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by assets/script.table.js — Exhaustive Technical Breakdown (expanded)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">assets/script.table.js — Exhaustive Technical Breakdown (expanded)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>1) One-line summary / intent</strong>: A defensive, caption-safe client-side table interaction and export subsystem for PasteToTable: builds TOCs from server-rendered caption-like elements (does not create captions), provides single-table row anchors, Unicode-aware search & highlighting, reversible three-state column sorting, collapse/expand UX, copy/export (plain, Markdown, CSV, JSON, XLSX, PDF), responsive control layout, idempotent initialization, and cooperative integration points (PTToc, tvUtils, XLSX, tableVirtualizer).                                                                                                                                                                                                                                    </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>2) Design principles (explicit)</strong>: Non-destructive (reads caption-like nodes but never invents them), idempotent re-init (dataset flags prevent duplicative listeners), feature-graceful (prefer global helpers), defensive (widespread try/catch to avoid runtime crashes), accessible (aria attributes, focus management), compatible (checks APIs like AbortController, matchMedia), observable-extensible (exposes functions on <code>window</code> for other modules).                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>3) Public API & global exposure</strong>: Exposes <code>window.PasteToTable.initRenderedContent</code>, <code>window.PTTable.buildTocs</code>, <code>window.copyTablePlain</code>, <code>window.copyTableMarkdown</code>, <code>window.exportTableCSV</code>, <code>window.exportTableJSON</code>, <code>window.exportTableXLSX</code>, <code>window.exportTablePDF</code>, <code>window.exportAllBtnHandler</code>, <code>window.searchTable</code>, <code>window.toggleTable</code>, <code>window.toggleAllTables</code>, and <code>window.backToTop</code>. Also writes dataset flags (e.g., <code>data-tvHandlerAttached</code>) to DOM elements for idempotency.                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>4) High-level control flow (init)</strong>: On DOMContentLoaded or immediate if ready: <code>initRenderedContent()</code> is invoked → ensure <code>.table-container</code> wrappers exist → build TOCs (<code>buildTocs()</code>) → assign row UIDs and snapshot ordering (<code>_ensureRowUidsAndSnapshot</code>) → cache <code>data-orig-html</code> for cells → attach per-table handlers idempotently → optimize controls layout → update row counts → scroll first table into view.                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>5) TOC behavior & heuristics</strong>: <code>buildTocs()</code> first defers to <code>window.PTToc.init/build</code> (if present) with selectors; fallback runs <code>buildSingleTableToc()</code> and <code>buildTocFromCaptions()</code>. <code>buildSingleTableToc()</code> triggers when a single logical table is present, enumerates body rows (skips <code>thead</code>), creates anchor <code>&lt;li&gt;&lt;a href=&quot;#id&quot;&gt;</code> entries using a stable ID per row. <code>buildTocFromCaptions()</code> collects <code>.table-caption</code>, <code>.table-title</code>, <code>.table-heading</code> nodes, ensures unique IDs (suffixes collisions), and appends links to <code>#toc</code> and <code>#tocBar</code>. Important: it only reads caption nodes — it does not create or mutate caption text.                                                                                                                             </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>6) ID collision strategy</strong>: When an intended id (e.g., <code>Table1</code> or <code>table-1</code>) is already present and not the same element, code suffixes with <code>-1</code>, <code>-2</code>, ... until unique. This prevents accidental anchor conflicts but can lead to proliferating suffixed IDs over repeated runs or interactions by other scripts.                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>7) Row UID snapshotting & sort restoration</strong>: <code>_ensureRowUidsAndSnapshot(table, tableIdx)</code> assigns <code>data-tv-uid = tvuid-N</code> for each row if not present and records <code>originalRowOrders[tableIdx] = [uid...]</code>. <code>sortTableByColumn</code> reorders DOM rows based on comparison, and on 3rd state restores original order by re-attaching rows in the snapshot order, searching by <code>tr[data-tv-uid=&quot;...&quot;]</code>. Restoration fails to include rows added after snapshot or rows without UIDs.                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>8) Sorting algorithm & rules</strong>: Three state per column: 0 (unsorted) → 1 (ascending) → 2 (descending) → 0 (restore). Sorting determines numeric vs lexical ordering by <code>parseFloat</code> on sanitized cell text (commas removed). Numeric sort applied if both parse to numbers. For ties fallback to <code>localeCompare</code>. Sorting mutates DOM by appending rows in sorted order (may cause many reflows). <code>sortStates</code> array stores per-table per-column state; header buttons get <code>sort-state-*</code> classes and <code>aria-sort</code> attributes updated.                                                                                                                                                                                                                                           </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>9) Complexity & performance of sorting</strong>: Sorting cost O(n log n) comparisons for n rows; cost dominated by string parsing/comparisons. DOM reattachment is O(n) append operations causing layout thrashing. For large tables (thousands of rows) this is slow: recommendation — build <code>DocumentFragment</code>, append all sorted rows once, then replace <code>tbody</code> contents in a single operation.                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>10) Search normalization & Unicode handling</strong>: <code>normalizeForSearchLocal</code> uses NFD normalization + removal of combining diacritics <code>\u0300-\u036f</code>, then strips non-letter/number characters. If <code>window.__tv_utils.normalizeForSearchLocal</code> exists, it defers to it. This yields case-insensitive, diacritic-insensitive search.                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>11) Highlight matching algorithm (detailed)</strong>: <code>buildNormalizedMapForCell(cell)</code> walks text nodes with a <code>TreeWalker</code>, constructs <code>normStr</code> — a per-codepoint filtered normalized string — and a <code>map</code> array mapping each normalized character position back to <code>{ nodeIndex, offsetInNode }</code>. This supports matching across multiple adjacent text nodes and surrogate pairs. <code>highlightMatches(cell, filterNorm)</code> finds all occurrences of <code>needle</code> in <code>normStr</code>, then for each match uses <code>map</code> entries to compute start and end text-node offsets and splits/ wraps matched text in <code>&lt;mark&gt;</code> elements. Matches are applied right-to-left to preserve indices. Clearing highlights uses <code>data-orig-html</code> (preferred) or replaces <code>&lt;mark&gt;</code> elements with their text children. </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>12) Edge cases in highlighting (subtle)</strong>: Complex emoji sequences (ZWJ, skin tone modifiers) contain multiple codepoints that may normalize unexpectedly; zero-width joiners and grapheme clusters can cause off-by-one mapping leading to split grapheme rendering. The algorithm attempts codepoint-aware offsets (checks <code>codePointAt</code> and char length) but may still mishandle complex sequences. Recommendation: consider using a grapheme cluster library (e.g., Intl.Segmenter or third-party) or a simpler highlight that searches on node.textContent boundaries for extreme cases.                                                                                                                                                                                   </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>13) Search runtime & mitigation</strong>: Building the normalized map is linear in the number of codepoints in a cell; worst-case for many large cells CPU & memory heavy. Mitigations present in code: debouncing search input; <code>window.tvConfig.highlight</code> guard to skip highlight; recommend: threshold-based skip (e.g., skip highlights for cells > 10k chars), incremental/async chunking, or Web Worker offload for normalization in very large docs.                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>14) Hiding non-matching rows</strong>: <code>searchTable()</code> runs per-table: for each row, clears highlights, computes normalized cell text and checks inclusion of <code>filterNorm</code> (normalized). Rows with no cell matching are hidden (<code>row.style.display = &#x27;none&#x27;</code>). First matching row is scrolled into view. Virtualized tables must call <code>tableVirtualizer.refresh()</code> or <code>update()</code>; code checks for <code>window.tableVirtualizer</code> and tries to call refresh/update if available.                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>15) Copy plain & Markdown behavior</strong>: <code>copyTablePlain(btn)</code> builds tab-separated plain-text from DOM cells and uses <code>copyToClipboard</code>. If table absent, falls back to <code>window.__tv_last_source</code> (raw source) if present. <code>copyTableMarkdown(btn)</code> first tries <code>getPreferredSourceForTable(table)</code> — which tries to map DOM table to its original markdown block in <code>window.__tv_last_source</code> using heuristics (block splitting by blank lines, header matching), preferring original source for accurate Markdown. If not found, <code>tableToMarkdownLines()</code> converts DOM table to pipe-table Markdown. Both use either <code>tvUtils.showCopyModal</code> if available or <code>copyToClipboard</code>.                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>16) Export formats & fallbacks</strong>: CSV: joins rows with commas, quotes containing <code>&quot;</code> by doubling, adds BOM (<code>\uFEFF</code>) to help Excel with UTF-8. JSON: builds array of objects using header row (thead) if present, otherwise <code>ColN</code> keys. XLSX: attempts <code>window.XLSX.utils.book_new</code> + <code>aoa_to_sheet</code> + <code>writeFile</code> or <code>write</code> variations; if unavailable or fails, falls back to creating TSV inside a Blob but warns user. PDF: constructs simple HTML with inline minimal CSS and <code>table.outerHTML</code>, opens a new window, writes HTML and calls <code>print()</code> after a small timeout — may be blocked by popup blockers.                                                                                                                                                          </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>17) Export caveats</strong>: XLSX fallback as TSV is not a true <code>.xlsx</code> binary — consumers expecting native <code>.xlsx</code> may be confused. CSV/TSV use simple quoting but do not attempt advanced escaping for multiline fields beyond simple <code>&quot;</code> quoting. PDF relies on <code>window.open</code> (popup blockers) and on client-side print to PDF support — not guaranteed.                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>18) Collapse/Expand details</strong>: <code>toggleTable(btn)</code> finds wrapper, toggles <code>tbody.style.display</code> between <code>none</code> and <code>&quot;&quot;</code>, toggles button text between 'Collapse Table' and 'Expand Table', updates <code>aria-expanded</code>. <code>toggleAllTables()</code> checks any expanded state and flips globally. This approach toggles visual display but leaves rows present in DOM; virtualizers or accessibility readers may still enumerate hidden rows unless <code>aria-hidden</code> or <code>hidden</code> attributes are used — current code uses style only.                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>19) Layout optimization & responsiveness</strong>: <code>optimizeTableControls()</code> moves control nodes into a <code>.table-header-wrapper</code>, creates a <code>.copy-buttons</code> container if needed, and adapts button sizing/padding for narrow screens (<code>(max-width:600px)</code>). It debounces via <code>window.tvConfig.debounceMs</code>. It also ensures toggle button placement and normalizes classes (<code>table-toggle-inline</code>).                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>20) Event binding & idempotency</strong>: Per-wrapper per-button attachments set <code>btn.dataset.tvTableIndex</code> and <code>btn.dataset.tvHandlerAttached = &quot;1&quot;</code>, avoiding duplicate handlers. Search input bound once (<code>sb.dataset.tvBound</code>). Global delegated click handlers capture sort clicks (by <code>.sort-btn</code>/<code>.th-with-sort</code>) and <code>#tocBar</code> anchor clicks. Keyboard handlers bind <code>/</code> to focus search and <code>Escape</code> to <code>backToTop</code>. All handlers wrapped in <code>try/catch</code>.                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>21) Memory & lifecycle</strong>: The module stores <code>originalRowOrders</code> and cell <code>data-orig-html</code> for each table. No explicit <code>dispose()</code> is provided; if tables are torn down or replaced frequently, memory may grow or stale references remain. Recommendation: add <code>PasteToTable.dispose()</code> to clear <code>originalRowOrders</code>, remove dataset flags, and optionally remove attached listeners.                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>22) Error handling trade-offs</strong>: The code prefers silence over loud failures (many <code>try/catch</code> with empty catches). This avoids user-facing crashes but complicates debugging. Recommendation: add an optional <code>DEBUG</code> flag to log caught errors to <code>console.warn</code> with contextual metadata while preserving stability.                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>23) Integration touchpoints</strong>: Code cooperates with: <code>window.PTToc</code> (TOC builder), <code>window.tvUtils</code> (copy/download/showToast/debounce), <code>window.XLSX</code> (SheetJS), <code>window.tableVirtualizer</code> (refresh/update), <code>window.tvConfig</code> (highlight/debounceMs). Provide these objects for richer behavior. <code>getPreferredSourceForTable</code> depends on <code>window.__tv_last_source</code> populated by other modules.                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>24) Security & sanitization</strong>: Exported HTML for PDF and copy operations uses <code>table.outerHTML</code> and <code>innerHTML</code> in places. Input flow largely reads existing DOM; injection risk is limited because server-rendered content is assumed trusted. However, when producing HTML blobs for download or print, ensure consumers expect raw HTML. <code>escapeHtml</code> is used in other files; this module relies on safe existing DOM and uses <code>textContent</code> in many places to avoid XSS when building strings.                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>25) Accessibility considerations (detailed)</strong>: Sets <code>aria-sort</code> on headers, <code>aria-expanded</code> on toggle buttons, <code>role=&quot;list&quot;</code> on resultsWrap in group UI. TOC links get <code>aria-label</code> and row anchors get <code>tabindex=&quot;-1&quot;</code>. However: hiding rows via <code>style.display = &#x27;none&#x27;</code> does remove them from the accessibility tree in practice, but adding ARIA live announcements for search result counts would improve screen-reader feedback. Also consider adding <code>aria-controls</code> linking TOC items to target tables/captions and <code>aria-live</code> updates for export success/failure.                                                                                                                                                                                                     </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>26) Test matrix & unit/integration checks to add:</strong><br>(1) Sorting correctness with numeric strings containing commas, negative numbers, and empty cells.<br>(2) Restoration of original row order after sorting when rows have been added or removed.<br>(3) Highlight correctness across adjacent text nodes, surrogate pairs, ZWJ sequences, and long text segments.<br>(4) TOC ID-collision handling when a non-caption element already uses <code>Table1</code> (or similar) IDs.<br>(5) Correct precedence logic in <code>getPreferredSourceForTable</code> for Copy/Markdown workflows.<br>(6) XLSX export compatibility across differing SheetJS build variants.<br>(7) PDF printing behavior when <code>window.open</code> is blocked by the browser.<br>(8) Performance profiling and stability verification for large tables (5k+ rows). </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>27) Performance profiling guidance</strong>: Instrument timings for <code>buildNormalizedMapForCell</code> and <code>highlightMatches</code> per-cell (sample slow cells). Measure DOM reflow cost in <code>sortTableByColumn</code> using <code>performance.now()</code> before/after sort and before/after DOM reattachment. Track memory use for <code>data-orig-html</code> sizes with <code>innerHTML.length</code>. If hotspots exceed thresholds, consider Web Worker normalization, using <code>DocumentFragment</code> batch DOM updates, or virtualization (only render visible rows).                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>28) Concrete code improvements (prioritized):</strong><br>1) Replace row-by-row reappend with <code>DocumentFragment</code> batch insertion in <code>sortTableByColumn</code>.<br>2) Add <code>dispose()</code> to remove dataset flags, clear snapshots, and detach event listeners.<br>3) Add a <code>HIGHLIGHT_MAX_CHARS</code> guard and fall back to non-highlighted filtering for very large cells.<br>4) Add optional verbose logging under <code>window.__ptt_debug</code> or <code>window.tvDebug</code>.<br>5) Use <code>requestAnimationFrame</code> when performing many DOM writes so the browser can batch paints.<br>6) Improve XLSX fallback by shipping a minimal client-side library for real <code>.xlsx</code> output or move export server-side. </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>29) Developer ergonomics / debugging suggestions</strong>: Expose a <code>window.PTTable._diagnostics()</code> that returns counts: number of tables, total rows, total characters in <code>data-orig-html</code>, size of <code>originalRowOrders</code>, memory hints. When <code>window.__ptt_debug</code> true, have critical caught errors <code>console.warn</code> with a context object. Include verbose timestamps for long-running operations.                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>30) Example traces (what happens on group-load -> convert)</strong>: (A) Group UI loads files → <code>loadFilesSequentialAndHideForm</code> fetches and concatenates raw sources → it sets <code>window.__tv_group_load_mode = true</code> and dispatches <code>ptt:groupLoaded</code> event → it calls <code>__tv_do_convert({text, metadata:{fromList:true}})</code> → <code>processRenderedHtml</code> injects HTML into <code>#tables-viewer</code> → sets <code>window.__tv_skip_scroll = true</code> → calls <code>PasteToTable.initRenderedContent()</code> via timeouts → <code>initRenderedContent</code> builds wrappers, caches HTML, builds TOCs (reads captions), attaches handlers, optimizes layout, updates row counts, and clears skip flags after coordinated scroll attempts.                                                                                          </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>31) Known behavior differences vs server-side caption injection</strong>: Because this module never creates caption nodes, pages that expect client-side caption injection will not get captions from this script. Server must provide <code>labels_injected.json</code> and <code>script.toc.js</code> (other files) if captions are desired. This module is intentionally caption-safe to avoid duplicate/inconsistent caption DOM mutations.                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>32) Inter-module invariants to preserve</strong>: - Do not assign IDs that collide with meaningful non-caption elements (use suffixing). - Do not overwrite <code>data-*</code> that other scripts may rely on (use <code>data-tv-*</code> namespace). - Maintain idempotency: repeated <code>initRenderedContent()</code> must not attach duplicate listeners or corrupt <code>data-orig-html</code>. - Honor <code>window.tvConfig.highlight</code> and <code>debounceMs</code> when available.                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>33) Backwards compatibility & browser support</strong>: Checks for <code>dataset</code>, <code>closest</code>, <code>AbortController</code>, <code>matchMedia</code>; avoids ES2020-only features (mostly ES6 used). Uses fallbacks (e.g., <code>document.querySelector</code> variants) so it works on evergreen browsers; some Unicode features rely on <code>String.prototype.normalize(&#x27;NFD&#x27;)</code> — widely available but not in very old engines.                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>34) Security checklist for deployments</strong>: Ensure HTML saved/served to users is sanitized on server-side if users can upload content (this module will render and export table HTML). Avoid including untrusted script tags inside <code>table.outerHTML</code> during export. When invoking <code>downloadBlob</code> for user-generated filenames, still sanitize with <code>sanitizeFileName</code> (file name sanitization exists in other shared utilities).                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>35) Migration notes for heavy pages</strong>: For pages with many tables or very large tables, consider: server-side pagination or server-rendered precomputed exports, enable virtualization and ensure <code>tableVirtualizer</code> integration, or lazy-init this module only for the currently visible table to reduce upfront cost.                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>36) Suggested unit/integration test list (concrete cases)</strong>: - Sort numeric columns with values: <code>[&quot;1,234&quot;, &quot;12.5&quot;, &quot;-3&quot;, &quot;&quot;]</code>. - Highlight across nodes: <code>&lt;td&gt;foo&lt;b&gt;bar&lt;/b&gt;baz&lt;/td&gt;</code> search "barbaz". - TOC collision: page has <code>&lt;div id=&quot;table-1&quot;&gt;&lt;/div&gt;</code> and a caption node — ensure caption id gets suffix. - CSV encoding: cell contains <code>He said &quot;hello&quot;, then left</code> → CSV line should be <code>&quot;He said &quot;&quot;hello&quot;&quot;, then left&quot;</code>. - XLSX SheetJS permutations: stub <code>window.XLSX</code> with <code>writeFile</code>, <code>write</code>, only <code>utils</code> available, or no XLSX. - PDF fallback when <code>window.open</code> returns null. - Group-load -> <code>ptt:groupLoaded</code> event fired, <code>__tv_group_load_mode</code> set to true.                                                                                             </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>37) Developer TODOs / low-effort wins</strong>: Add <code>data-ptt-version</code> comment to file header; instrument <code>window.__ptt_metrics</code> object to track calls & durations; add feature-flag toggles for heavy features (<code>highlight</code>, <code>sortSnapshotting</code>, <code>xlsxSupport</code>); small unit tests for <code>keyVariants</code>, <code>canonKey</code> in other modules (consistency); include optional <code>aria-live</code> region to announce search result counts.                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>38) Long-term architectural suggestions:</strong><br>(A) <strong>toc-reader</strong> — read-only caption and row-anchor builder.<br>(B) <strong>search-highlighter</strong> — pure normalization and highlight logic with a fully testable API.<br>(C) <strong>sorter</strong> — snapshot management and sort operations using batch-DOM techniques.<br>(D) <strong>exporters</strong> — isolated CSV/JSON/XLSX/PDF modules.<br>(E) <strong>ui-optimizer</strong> — rendering, throttling, and interaction efficiency.<br>This modular split allows independent performance tuning and clearer unit/integration coverage. </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>39) Risk matrix (likelihood × impact)</strong>: High-likelihood, high-impact: heavy highlight CPU on large tables → UI lock. Medium-likelihood, medium-impact: XLSX API mismatch → failed exports. Low-likelihood, high-impact: ID collisions with important page elements → broken anchors/navigation. Mitigations listed above reduce these risks.                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="assets/script.table.js — Exhaustive Technical Breakdown (expanded)"> <strong>40) Final concise checklist before deployment:</strong><br>(1) Enable debug logging temporarily and run integration tests.<br>(2) Profile <code>searchTable()</code> and <code>sortTableByColumn</code> on real datasets.<br>(3) Add <code>dispose()</code> if pages dynamically replace table content.<br>(4) Ensure <code>window.XLSX</code> is available when XLSX export is required; otherwise communicate fallback clearly.<br>(5) Confirm <code>window.__tv_last_source</code> flow when copy-markdown must prefer original markdown.<br>(6) Add ARIA announcements for search result counts and export completions. </td></tr></tbody></table></div><div class="row-count">Rows: 40</div></div><div class="table-caption" id="Table4" data-table="Docu_0125_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4 • script.toc.js</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical breakdown (script.toc.js)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical breakdown (script.toc.js)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Overview & intent</strong><br>Provides a single, idempotent Table of Contents (TOC) and caption-injection subsystem for a PasteToTable viewer. It centralizes caption injection (replacing previous injectors), merges static <code>labels_injected.json</code> with runtime captions, listens for rendering and group events, keeps behavior compatible with legacy <code>PTToc.reloadLabels/getLabels</code>, is defensive against missing APIs, and attempts to be safe for integration (uses <code>textContent</code> rather than <code>innerHTML</code> except for an escaped fallback). The module is lightweight and DOM-scoped to the "viewer/content root".                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>High-level architecture</strong><br>1. <strong>Initialization guard</strong>: <code>window.__pt_toc_installed</code> prevents double-installation.<br>2. <strong>Configuration object</strong>: <code>PTToc.config</code> holds selectors, paths, feature flags, and tunables (debounce, auto-select throttle, label paths, etc.).<br>3. <strong>Utilities</strong>: small helpers for logging (<code>dbg/warn</code>), safe execution (<code>tryCatch</code>), text normalization, ID generation (<code>ensureId</code>), URL joining, and a robust <code>fetchJsonOnce</code> that uses <code>AbortController</code> when available.<br>4. <strong>Label system</strong>: merges static injected labels with runtime captions; provides <code>captionFor</code>, <code>inferBookPrefix</code>, <code>buildEffectiveLabelIndex</code>.<br>5. <strong>Caption injection</strong>: <code>injectCaptionForElement</code> performs idempotent, safe insertion/updating of caption elements immediately before table/heading; conservative DOM writes, uses <code>textContent</code> and <code>strong</code> child.<br>6. <strong>TOC build</strong>: <code>buildItemsFromSingleTable</code>, <code>buildItemsFromHeadings</code>, <code>buildOnce</code> create TOC entries and populate <code>tocList</code>/<code>tocBarList</code> fragments, then call <code>applyCaptions</code> and <code>highlightCurrentFromLocation</code>.<br>7. <strong>Label loading</strong>: <code>fetchLabels</code>, <code>PTToc.reloadLabels</code>, and <code>PTToc.getLabels</code> implement fallback-first sequential or background refresh logic with cache-bust options and global promise caching (<code>window.__ptt_labels_reload_promise</code>).<br>8. <strong>Event / network interception</strong>: wraps <code>fetch</code> and <code>XMLHttpRequest</code> to detect <code>/api/group/load</code> and convert endpoints, scheduling TOC refresh/auto-select after load/convert activity.<br>9. <strong>Delegated handlers & mutation observer</strong>: delegated click handling for TOC and convert buttons, hashchange handling, mutation observer to rebuild TOC on DOM changes, and custom event listeners for <code>ptt:groupLoaded</code>, <code>ptt:htmlRendered</code>, <code>ptt:rendered</code>.<br>10. <strong>Public API</strong>: <code>PTToc.init</code>, <code>PTToc.build</code>, <code>PTToc.applyCaptions</code>, <code>PTToc.reloadLabels</code>, <code>PTToc.getLabels</code>, <code>PTToc.scheduleTocRefresh</code>, and <code>window.PTToc</code> exposure. </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Key flows & sequence diagrams (text)</strong><br><strong>Init</strong> → attach handlers → (if <code>deferLabelsReload</code>) use injected labels & <code>buildOnce</code> → observe mutations; otherwise call <code>reloadLabels</code> then <code>buildOnce</code>.<br><strong>Group load/convert fetch/XHR</strong> → fetch/XHR wrapper detects endpoint → on completion schedule <code>scheduleTocRefresh({autoSelect:true})</code> → <code>reloadLabels</code> may fetch static labels → <code>buildOnce</code> → <code>applyCaptions</code> → optional <code>selectTable1</code> auto-select.<br><strong>DOM change</strong> → MutationObserver debounce → <code>buildOnce</code> → update TOC and captions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Defensive coding patterns used</strong><br>- Widespread <code>try/catch</code> around most blocks to avoid script-halting errors.<br>- Feature detection (<code>AbortController</code>, <code>MutationObserver</code>, <code>fetch</code>, <code>XMLHttpRequest</code>).<br>- Idempotency: <code>window.__pt_toc_installed</code>, <code>PTToc._delegatedAttached</code>, <code>PTToc._labels_helpers_installed</code> guards.<br>- Non-destructive DOM updates: prefer updating existing caption nodes if present; conservative element creation.<br>- Global caching of reload promises to avoid redundant network calls (<code>window.__ptt_labels_reload_promise</code>).<br>- Non-blocking background refresh when existing labels are present.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Important functions explained</strong><br><strong>ensureId(el, prefix)</strong>: normalizes heading text, builds safe id (slug), avoids collisions by suffixing. Good: retains readability, caps length, avoids invalid characters. Edge: may generate different ids across navigations if heading text changes — used to match injected caption ids.<br><strong>fetchJsonOnce(url, timeoutMs)</strong>: single-attempt JSON fetch with optional <code>AbortController</code> timeout, robust fallback when <code>AbortController</code> absent. Returns <code>null</code> on any failure. Potential risk: uses <code>cache: &#x27;no-store&#x27;</code>, <code>credentials: &#x27;same-origin&#x27;</code> — appropriate for same-origin label fetches.<br><strong>captionFor(labelsObj, bookPrefix, idx)</strong>: multi-key lookup supporting object or nested label structures, numeric keys with/without zero-pad, and alternate hyphenated keys. Good compatibility with legacy shapes.<br><strong>injectCaptionForElement(anchorEl, idx, captionText)</strong>: idempotent injection. Behavior: if an element with expected <code>TableXX</code> id exists and is <code>.table-caption</code>, it updates; if a <code>.table-caption</code> exists immediately before anchorEl, updates it; otherwise creates <code>div.table-caption</code> with <code>strong</code> child and small inline styles. Uses <code>data-ptt-injected=1</code> attribute for provenance.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Label loading & merging details</strong><br>- <code>PTToc.config.labelsPaths</code> is a prioritized list of candidate paths.<br>- <code>PTToc.reloadLabels()</code> expands relative candidates against <code>window.__tv_base</code>, deduplicates, and attempts each candidate sequentially until a valid JSON object (non-empty) is found. Returns a promise cached in <code>window.__ptt_labels_reload_promise</code> to prevent parallel reloads.<br>- If labels already exist globally and not forcing, it performs a background refresh that stops as soon as one candidate returns a non-empty object, then replaces labels and calls <code>PTToc.build()</code>.<br>- <code>buildEffectiveLabelIndex()</code> merges <code>PTToc._labels</code>, <code>window.__ptt_labels_injected</code> and <code>window.__ptt_runtime_captions</code> (the latter can be array or object), producing numeric and padded-key aliases for lookup.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Event & network instrumentation</strong><br>- Wraps global <code>fetch</code> and <code>XMLHttpRequest</code> to intercept requests to <code>/api/group/load</code>, <code>/api/convert</code> (and <code>/convert</code>). On observed completion (success or failure), schedule <code>scheduleTocRefresh({autoSelect: true})</code> to refresh labels and do possible auto-selection.<br>- Adds delegated click listener for convert buttons to kick off scheduling.<br>- Listens to <code>ptt:groupLoaded</code>, <code>ptt:htmlRendered</code>, and <code>ptt:rendered</code> custom events to apply captions after list render completes.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Accessibility considerations</strong><br>- Uses <code>textContent</code> and creates <code>strong</code> elements for captions (semantic emphasis).<br>- TOC links set <code>role=&quot;link&quot;</code>, <code>data-pt-target</code>, and <code>aria-label</code> attributes. <code>highlightCurrentFromLocation</code> sets <code>aria-current=&quot;page&quot;</code> on the active TOC link.<br>- Focus/click behavior in <code>selectTable1</code> attempts to focus then click target entries for keyboard support.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Performance & scalability</strong><br>- Debounced rebuild (<code>_debounceMs</code>, default 150ms) reduces thrash from mutation events.<br>- <code>fetchLabels</code> and <code>reloadLabels</code> attempt sequential candidate fetches; background refresh halts early when a candidate succeeds — avoids unnecessary fetches but can be slow if valid candidate is late in the list.<br>- Uses DocumentFragment to build TOC lists before appending to DOM (good).<br>- MutationObserver scoped to content root with <code>childList:true, subtree:true</code> — fine for moderate DOM, but heavy frequent mutations may still cause repeated rebuilds (debounce mitigates).<br>- No worker usage; for pages with thousands of headings/tables, the synchronous build might block the main thread briefly.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Potential failure modes & edge cases</strong><br>1. <strong>Label race</strong>: if runtime captions arrive while <code>reloadLabels</code> is in progress, merges may not reflect latest runtime captions. <code>ptt:groupLoaded</code> stores runtime captions into <code>window.__ptt_runtime_captions</code> and schedules <code>applyCaptions</code>, but <code>reloadLabels</code> may overwrite <code>_labels</code> without merging runtime captions — acceptable because runtime captions are kept separately via <code>buildEffectiveLabelIndex()</code> but watch for overwrite of <code>window.__ptt_labels_injected</code> in reload.<br>2. <strong>ID mismatch</strong>: <code>ensureId</code> uses heading text to build IDs; any server-side anchored URLs that differ will not match. Also <code>encodedSavedUrlFor</code> issues (from prior file) could cause mismatch — note only indirectly relevant here.<br>3. <strong>CSP risk</strong>: <code>injectCaptionForElement</code> sets inline styles (<code>div.style.marginTop/Left</code>) — in strict CSP environments inline styles are not blocked per se (unless style-src 'unsafe-inline' is disallowed for style attributes via CSP nonces); but style attributes are allowed in most CSPs. Still, moving to CSS classes is recommended.<br>4. <strong>Network failures</strong>: <code>fetchJsonOnce</code> returns <code>null</code> on many failures — code handles it but user-visible TOC may stay empty if none of label candidates succeed.<br>5. <strong>Overwriting existing captions</strong>: if page already contained user-supplied <code>.table-caption</code> elements that are not PTT-injected, code sometimes replaces them only if they look like default "Table n" — conservative but could still update unexpected nodes if markup diverges.<br>6. <strong>Double-wrapping fetch/XHR</strong>: reassigning <code>window.fetch</code> and <code>window.XMLHttpRequest</code> could conflict with other instrumentation libraries; wrappers attempt to be conservative but may break code that depends on strict <code>instanceof</code> or the original XHR prototype behavior.                                                                                                                           </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Security & privacy flags</strong><br>- No obvious data exfiltration in this file, but the global fetch/XHR wrapper inspects URLs and triggers reloads. Ensure telemetry code elsewhere does not send captions/filenames without opt-in.<br>- <code>fetch</code> calls use <code>credentials: &#x27;same-origin&#x27;</code> which is proper for same-origin label fetching — ensure server enforces CSRF protections for label update endpoints.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Maintainability observations</strong><br>- Code is modular and well-namespaced under <code>PTToc</code> with clear responsibilities.<br>- Extensive try/catch blocks make the code resilient but can hide bugs during development; consider logging levels or conditional debug flags to surface problems during integration testing.<br>- Several global/window properties are used (<code>__ptt_labels_injected</code>, <code>__ptt_labels_reload_promise</code>, <code>__ptt_runtime_captions</code>, <code>__ptt_current_group_id</code>, <code>__tv_base</code>) — this is pragmatic for integration but increases coupling with host environment. Document these globals as a public contract.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Test matrix suggestions</strong><br><strong>Unit tests</strong>: <code>ensureId</code> (collision & special characters), <code>captionFor</code> (various shapes), <code>buildEffectiveLabelIndex</code> (array vs object runtime captions), <code>fetchJsonOnce</code> (timeout & parse failure), <code>injectCaptionForElement</code> (existing caption update vs new insertion).<br><strong>Integration tests</strong>: pages with single table, multiple tables, no tables but headings; deferred vs forced label reload; groupLoaded event with runtime captions; page with existing caption nodes that should be preserved.<br><strong>E2E</strong>: simulate fetch/XHR wrapping with fake endpoints to ensure <code>scheduleTocRefresh</code> triggers and <code>selectTable1</code> behavior.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Concrete recommended improvements (prioritized)</strong><br>1. <strong>Avoid global fetch/XHR replacement collision</strong>: instead of full replacement, consider a small wrapper registration API or use <code>addEventListener(&#x27;fetch&#x27;)</code> when ServiceWorker appropriate; if replacement must stay, preserve original references and provide <code>PTToc.unwrap()</code> for integrators to restore original behavior for debugging.<br>2. <strong>Make label paths and base configurable and document <code>__tv_base</code> expectations</strong> to avoid mismatch. Expose a <code>PTToc.config.labelsPaths</code> API at runtime.<br>3. <strong>Merge runtime captions with label reload</strong>: when <code>reloadLabels</code> completes, merge <code>window.__ptt_runtime_captions</code> into <code>_labels</code> (or ensure <code>buildEffectiveLabelIndex()</code> consistently gives runtime precedence) so dynamically-provided captions are never lost.<br>4. <strong>Remove inline styles</strong>: replace <code>div.style.*</code> with <code>div.className += &#x27; ptt-caption-injected&#x27;</code> and ship a small CSS block inserted as a <code>link</code>ed stylesheet or an injectable style element with CSP nonce support; provide <code>PTToc.injectStyles()</code> that respects CSP when given a nonce or external URL.<br>5. <strong>Expose lifecycle hooks</strong>: <code>PTToc.on(&#x27;built&#x27;, fn)</code> or events to allow host to react without wrapping fetch/XHR.<br>6. <strong>Add AbortController support to long-running builds</strong>: allow cancellation of <code>buildOnce</code> if heavy (not as necessary for small docs).<br>7. <strong>Telemetry opt-out</strong>: confirm other modules do not send PTT-injected caption text in telemetry by default; if they do, require explicit opt-in.                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Potential regressions to watch for in changes</strong><br>- Changing ID generation may break external deep links.<br>- Moving caption styling to CSS classes requires updating any integrator-authoring that relied on inline style behavior.<br>- Removing <code>window.fetch</code> wrapping may break sites that relied on the wrapper behavior to schedule TOC refresh — replace with explicit <code>PTToc.notifyGroupLoad()</code> call for integrators.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Integration checklist for deploy</strong><br>- Document and expose <code>PTToc.config</code> defaults and the <code>labelsPaths</code> resolution rules.<br>- Provide a way to opt-out of fetch/XHR wrapping or to disable auto-scheduling (<code>PTToc.config.disableFetchInterceptor = true</code>).<br>- Include minimal CSS for <code>.table-caption</code> and <code>.pt-toc-link</code> in the integration guide and prefer external stylesheet for CSP environments.<br>- Add a debug mode that logs more verbosely without polluting production consoles (<code>PTToc.config.debug</code>).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Suggested unit/integration assertions (for CI)</strong><br>- <code>PTToc.init()</code> is idempotent when called multiple times.<br>- <code>PTToc.reloadLabels()</code> resolves to a non-empty object when any candidate returns valid JSON.<br>- <code>applyCaptions()</code> should not duplicate <code>.table-caption</code> nodes on repeated calls.<br>- Delegated click handler must prevent default and scroll to correct anchor with offset when sticky header present.<br>- <code>selectTable1()</code> must respect throttle interval.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Estimated maintenance & complexity notes</strong><br>- LOC ~700+ lines; moderate complexity due to many corner-case handlers and environment integrations.<br>- Reasonable to maintain by a single engineer; ensure good test coverage around network and DOM mutation behavior.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical breakdown (script.toc.js)"> <strong>Final concise verdict on this file</strong><br>Well-structured, defensive TOC/caption subsystem suitable for integration into PasteToTable-style viewers. Production-ready with caveats: document globals and wrapper behavior, remove inline styles for CSP compatibility, make label path/base configurable, and add a small set of unit/integration tests to guard against regressions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr></tbody></table></div><div class="row-count">Rows: 19</div></div><div class="table-caption" id="Table5" data-table="Docu_0125_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5 • script.save.js</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Details**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Details</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Details"> <code>assets/script.save.js</code> provides client-side functionality for saving Markdown content via a POST request to <code>/save-md</code>. It handles the user interface (UI) elements for saving, such as filename prompts and status updates, along with necessary checks (e.g., file size limits). The script integrates with other parts of the page via events to handle Markdown content save actions. It includes features like network error handling, content validation, and status feedback, ensuring a smooth user experience.                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Details"> <strong>High-level guarantees & design principles</strong>: • <strong>User-friendly error handling</strong>: Displays status messages for success/failure with appropriate roles for accessibility. <br>• <strong>File size validation</strong>: Checks the size of the content before attempting to save. <br>• <strong>Filename handling</strong>: Ensures proper filename extension and sanitizes user input for the filename. <br>• <strong>Event-driven</strong>: Uses custom events (<code>EVENT_REQUEST_MD</code>, <code>EVENT_RESPONSE_MD</code>) to trigger and handle the save process. <br>• <strong>Graceful degradation</strong>: If the fetch API or the request fails, fallback options (like direct prompt for user input) ensure continued functionality. <br>• <strong>Extensibility</strong>: The script exposes public methods (like <code>PTT_SAVE.save</code>) for other scripts to programmatically trigger save actions.                                                                                                                                                              </td></tr><tr><td data-label="Details"> <strong>Top-level structure & exports</strong>: • <strong>Public API</strong>: <code>PTT_SAVE.save</code> provides a method for external scripts to save Markdown content. <br>• <strong>Save flow</strong>: Manages the logic for reading, validating, and posting Markdown content. <br>• <strong>Events</strong>: Emits <code>EVENT_REQUEST_MD</code> for custom integrations to request a save, and <code>EVENT_RESPONSE_MD</code> for responding with save results. <br>• <strong>UI elements</strong>: Manages status feedback via <code>STATUS_ID</code> and handles user interactions like filename prompts and save button clicks. <br>• <strong>Error handling</strong>: Provides a robust mechanism for network and client errors, ensuring graceful failure modes.                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Details"> <strong>Key components & responsibilities (concise)</strong>: 1. <strong>Save Button Handler</strong> — Listens for clicks on the save button (<code>SAVE_BTN_ID</code>), preventing default behavior, and dispatches a custom event to trigger the save. <br>2. <strong>Filename Prompt</strong> — Prompts the user to provide a filename for the saved Markdown file, ensuring a valid file name and <code>.md</code> extension. <br>3. <strong>Size Validation</strong> — Checks the size of the content before attempting to save, and rejects files that exceed the client-defined maximum size (<code>getClientMaxSize</code>). <br>4. <strong>POST Request</strong> — Sends the Markdown content as JSON to the backend via a POST request to <code>/save-md</code> using the <code>postSaveMarkdown</code> function. <br>5. <strong>Error Handling</strong> — Handles errors gracefully, displaying status updates and triggering appropriate response events in case of failures (e.g., network issues, invalid server response).                                                                             </td></tr><tr><td data-label="Details"> <strong>Detailed behavior & important implementation notes</strong>: <strong>Save Flow</strong>: The script reads content from a designated element (<code>PASTE_ID</code> or <code>FALLBACK_AREA_ID</code>), validates the content, checks the file size, prompts the user for a filename (if not already provided), and then sends the data via a <code>POST</code> request to <code>/save-md</code>. If the save operation is successful, a message is displayed, and a download link may be provided. In case of errors, appropriate feedback is given. <br> <strong>POST Request</strong>: The request is made with a JSON payload containing the Markdown content and the filename. The server's response is processed to check for success or failure. <br> <strong>UI Feedback</strong>: The script updates a status element (<code>STATUS_ID</code>) to show the user the current state of the save operation, including any errors. <br> <strong>Filename Handling</strong>: The filename is ensured to have a <code>.md</code> extension, and input is sanitized to avoid issues with special characters. </td></tr><tr><td data-label="Details"> <strong>Error handling, robustness & failure modes</strong>: • <strong>Network errors</strong>: Handled by <code>catch</code> blocks in the <code>postSaveMarkdown</code> function, which ensures users are notified of any issues while saving. <br>• <strong>Invalid server response</strong>: If the server returns a non-JSON response, an error is thrown. <br>• <strong>Size limits</strong>: The content is checked against a client-side maximum size (<code>DEFAULT_MAX_PASTE_SIZE</code> or <code>getClientMaxSize</code>). If the content exceeds the limit, the save is rejected. <br>• <strong>Filename validation</strong>: Ensures the filename input is valid, sanitized, and includes the <code>.md</code> extension. <br>• <strong>Event dispatching</strong>: If an error occurs at any point in the save process, custom error events (<code>EVENT_RESPONSE_MD</code>) are dispatched to ensure other scripts can react to failures.                                                                                                                                                                          </td></tr><tr><td data-label="Details"> <strong>Concurrency / performance considerations</strong>: • <strong>POST request</strong>: The <code>POST</code> request to <code>/save-md</code> is asynchronous, and the UI remains responsive during the save process. <br>• <strong>Size checks</strong>: The size of the Markdown content is checked before making the network request, avoiding unnecessary network traffic for large files. <br>• <strong>Debounced save</strong>: The event-based save triggers allow for decoupling the save process from UI actions, minimizing unnecessary requests. <br>• <strong>Network retries</strong>: The script does not retry failed network requests, but it ensures users are informed of any failures, with fallback mechanisms where possible.                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Details"> <strong>Edge cases & brittle areas</strong>: 1. <strong>No Markdown content</strong>: If no Markdown is found in the target element, the save is prevented, and an error message is displayed. <br>2. <strong>File size too large</strong>: Content exceeding the maximum size (<code>DEFAULT_MAX_PASTE_SIZE</code> or <code>getClientMaxSize</code>) is rejected, and the user is notified. <br>3. <strong>Invalid server response</strong>: If the server returns a response that cannot be parsed as JSON, the save fails. <br>4. <strong>Filename conflicts</strong>: If a user-provided filename contains illegal characters or exceeds the allowed length, it is sanitized and truncated to meet the constraints.                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Details"> <strong>Integration points & extension hooks</strong>: • <strong>Custom save triggers</strong>: Exposes <code>EVENT_REQUEST_MD</code> for other scripts to trigger a save request. <br>• <strong>Response handling</strong>: <code>EVENT_RESPONSE_MD</code> can be used by other scripts to react to the save result. <br>• <strong>Custom filename handling</strong>: Allows external code to influence the filename prompt behavior. <br>• <strong>Configurable limits</strong>: External code can modify the client-side maximum paste size through <code>window.PTT_CONFIG.MAX_PASTE_SIZE</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Details"> <strong>Recommendations & maintainability notes</strong>: • <strong>Error visibility</strong>: Improve error visibility by logging server responses more thoroughly for debugging. <br>• <strong>Size validation</strong>: Consider adding a visual indication of file size before submission to inform users when content exceeds the client limit. <br>• <strong>Filename customization</strong>: Add a callback to customize the filename prompt behavior (e.g., to fetch the filename dynamically based on user input or document metadata). <br>• <strong>Event logging</strong>: Add debug logs or verbose mode to help with diagnostics during development. <br>• <strong>Unit tests</strong>: Test the filename sanitization and content size validation separately to avoid issues with edge cases.                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Details"> <strong>Short checklist of behaviors to verify when integrating</strong>: • Save process should be initiated when the save button is clicked, and should trigger the appropriate events. <br>• The filename should be sanitized, and the <code>.md</code> extension should be appended if missing. <br>• Content size must be validated before the save request is made. <br>• The server response should be handled correctly, with status updates and any available download links. <br>• In case of errors (e.g., network, invalid response), appropriate messages should be shown to the user.                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Details"> <strong>Conclusion</strong>: <code>assets/script.save.js</code> provides a streamlined client-side mechanism for saving Markdown content. It integrates error handling, file size validation, and filename sanitization with a user-friendly interface and feedback system. Through custom events and configurable parameters, it is extensible and can be integrated into various environments. Key areas for improvement include enhanced error visibility, customizable filename handling, and additional user feedback for content size limitations. The file is well-suited for further enhancements, including support for more complex file-saving workflows.                                                                                                                                                                                                                                                                                                                                      </td></tr></tbody></table></div><div class="row-count">Rows: 12</div></div><div class="table-caption" id="Table6" data-table="Docu_0125_06" style="margin-top:2mm;margin-left:3mm;"><strong>Table 6</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Aspect"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Aspect</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Before (original)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Before (original)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by After (revised)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">After (revised)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Aspect"> <strong>Location</strong>                      </td><td data-label="Before (original)">                                                                                         <code>createFileSearchEngine</code> (inside <code>presentGroupsOnly</code>) </td><td data-label="After (revised)"> Same function only — implementation refined in-place                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Aspect"> <strong>Index structure</strong>               </td><td data-label="Before (original)">                            Simple <code>inverted[token] = [postings]</code> built on the fly; postings could contain duplicates and were not normalized. </td><td data-label="After (revised)"> Post-build normalization: dedupe postings, sort arrays. Postings are bounded by <code>MAX_POSTINGS</code>.                                                                                                                                                                                                              </td></tr><tr><td data-label="Aspect"> <strong>Tokenization & trigrams</strong>       </td><td data-label="Before (original)">                                                            <code>tokenize()</code> and <code>trigramsOf()</code> existed and were used; tokens added into postings. </td><td data-label="After (revised)"> Same tokenizers preserved for behavioral parity; used consistently for building normalized postings and caches.                                                                                                                                                                                              </td></tr><tr><td data-label="Aspect"> <strong>Candidate retrieval algorithm</strong> </td><td data-label="Before (original)">       <code>candidatesForQuery</code> scanned postings per token and accumulated a set (object) of IDs up to limit — effectively a union-first approach. </td><td data-label="After (revised)"> Multi-step retrieval: uses token postings lists, sorts by posting length, then attempts efficient intersection (hash-based for small lists or merge-style for large lists). If intersection is tiny, fall back to union. This yields much smaller candidate sets for scoring in typical multi-token queries. </td></tr><tr><td data-label="Aspect"> <strong>Query caching</strong>                 </td><td data-label="Before (original)">                                                                                                                                         None. </td><td data-label="After (revised)"> Lightweight LRU-like cache (<code>QUERY_CACHE_SIZE = 128</code>) storing recent query → candidate lists to avoid recomputing across keystrokes.                                                                                                                                                                         </td></tr><tr><td data-label="Aspect"> <strong>Complexity (typical)</strong>          </td><td data-label="Before (original)">                                                 Potentially O(T * P) where T = tokens, P = postings per token; repeated on every input event. </td><td data-label="After (revised)"> Much faster for multi-token queries: intersection reduces candidates dramatically; cache avoids recomputation for short-term repeated queries. Worst-case behavior remains bounded by configured limits.                                                                                                     </td></tr><tr><td data-label="Aspect"> <strong>Scoring (<code>scoreFiles</code>)</strong>        </td><td data-label="Before (original)"> Present and unchanged: same scoring heuristics (exact-phrase boost, caption/name boosts, token matches, tri-gram overlap, cheap DL fallback). </td><td data-label="After (revised)"> Preserved exactly — scoring function left intact to keep result ordering/behavior identical. Only candidate set passed to it is reduced.                                                                                                                                                                     </td></tr><tr><td data-label="Aspect"> <strong>Memory overhead</strong>               </td><td data-label="Before (original)">                                                                                                Only inverted postings and lite = items array. </td><td data-label="After (revised)"> Small additional memory for (1) normalized postings arrays (no duplicates but explicit arrays), (2) <code>queryCache</code> and <code>queryCacheOrder</code> entries (configurable, default 128). Overall modest and transient (per modal).                                                                                        </td></tr><tr><td data-label="Aspect"> <strong>Behavioral compatibility</strong>      </td><td data-label="Before (original)">                                                                          Deterministic, but potentially slower on large lists and keystrokes. </td><td data-label="After (revised)"> Behavioral output (scores, order) preserved because scoring is unchanged; search results can be equal or improved due to better candidate selection. Public API unchanged (<code>candidatesForQuery</code>, <code>scoreFiles</code>, <code>lite</code>, <code>dispose</code>).                                                                           </td></tr><tr><td data-label="Aspect"> <strong>Robustness / edge-cases</strong>       </td><td data-label="Before (original)">                                                                    Could re-scan many items on each keystroke; postings contained duplicates. </td><td data-label="After (revised)"> Postings normalized; code chooses intersection or union depending on data size; cached results mitigate input burst; errors are caught and fall back to safe union or full-scan fallback (unchanged catch path).                                                                                             </td></tr><tr><td data-label="Aspect"> <strong>Config knobs</strong>                  </td><td data-label="Before (original)">                                                                                                        <code>MAX_POSTINGS</code>, <code>MAX_CANDIDATES</code> used. </td><td data-label="After (revised)"> Same knobs used. Added internal <code>QUERY_CACHE_SIZE</code> (default 128) and heuristics (hash-vs-merge threshold at ~2000) which are local to the engine and easy to tune.                                                                                                                                           </td></tr><tr><td data-label="Aspect"> <strong>Performance risk</strong>              </td><td data-label="Before (original)">                                                                                  Slow for many tokens / many items; higher CPU per keystroke. </td><td data-label="After (revised)"> Much lower CPU for typical multi-token searches and repeated edits. Slight extra cost once at engine initialization to normalize postings. Cache prevents repeated work.                                                                                                                                     </td></tr><tr><td data-label="Aspect"> <strong>When to disable</strong>               </td><td data-label="Before (original)">                                                                                                                  N/A (no opt-out previously). </td><td data-label="After (revised)"> Can be treated as a no-op if inverted index disabled; change is localized — safe to revert if needed. No external API or DOM changes required.                                                                                                                                                               </td></tr><tr><td data-label="Aspect"> <strong>Testing & validation</strong>          </td><td data-label="Before (original)">                                                                                            Manual observation; heavier load could reveal lag. </td><td data-label="After (revised)"> Recommended tests: large synthetic index (10k+ items) to confirm responsiveness, verify identical top-N ordering on small datasets, and verify cache eviction behavior.                                                                                                                                      </td></tr></tbody></table></div><div class="row-count">Rows: 14</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>