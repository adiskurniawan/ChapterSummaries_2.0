<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1764452147">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#Table6">Table 6</a></li>
<li class="toc-item"><a class="toc-link" href="#Table7">Table 7</a></li>
<li class="toc-item"><a class="toc-link" href="#Table8">Table 8</a></li>
<li class="toc-item"><a class="toc-link" href="#Table9">Table 9</a></li>
<li class="toc-item"><a class="toc-link" href="#Table10">Table 10</a></li>
<li class="toc-item"><a class="toc-link" href="#Table11">Table 11</a></li>
<li class="toc-item"><a class="toc-link" href="#Table12">Table 12</a></li>
<li class="toc-item"><a class="toc-link" href="#Table13">Table 13</a></li>
<li class="toc-item"><a class="toc-link" href="#Table14">Table 14</a></li>
<li class="toc-item"><a class="toc-link" href="#Table15">Table 15</a></li>
<li class="toc-item"><a class="toc-link" href="#Table16">Table 16</a></li>
<li class="toc-item"><a class="toc-link" href="#Table17">Table 17</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0145_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **Module**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Module</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th><th aria-label="Sort by **Analysis**" class="tv-col" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Analysis</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th><th aria-label="Sort by **Reason to Revise**" class="tv-col" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Reason to Revise</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Module"><div class="tv-left-col"><div class="left-col-heading"><strong>modCalc.bas</strong></div></div></td><td data-label="Analysis"> Core calculation engine implemented proceduraly. Implements annualization, BPJS aggregation, PTKP → PKP, PKP floored to 1,000, progressive tax loop, DTP reduction, NPWP penalty, rounding and per-row output dictionaries. Contains many defensive checks but also inconsistent naming, mixed responsibilities (parsing, validation, calculation, logging), repeated numeric parsing logic, scattered <code>On Error Resume Next</code>, manual rounding duplicated, and limited unit-test hooks. Edge cases not fully hardened (partial periods, zero/negative values, bracket-edge inclusivity, percent-string formats). </td><td data-label="Reason to Revise"> Ensure mathematical correctness and auditability: centralize rounding and numeric parsing, separate parsing/validation from pure computation, add unit-testable helpers, remove silent error swallowing, ensure bracket edge correctness, confirm PTKP selection logic for all family statuses, provide deterministic outputs and traceable intermediate values.                      </td></tr><tr><td data-label="Module"><div class="tv-left-col"><div class="left-col-heading"><strong>modMain.bas</strong></div></div></td><td data-label="Analysis"> Orchestrator that reads settings, creates job folder, normalizes inputs, reads brackets/params, loops rows calling <code>ProcessRow</code>, constructs CSV text and writes files, writes manifest and imports CSV. Good structure but tightly couples I/O and processing; input normalization and indexing are defensive but complex; header mapping uses tolerant lookup that may mask missing columns; zero results in outputs indicate integration mismatch with <code>modCalc</code>. Error handling is coarse (message boxes) and logging is per-row but not machine-readable.                                                    </td><td data-label="Reason to Revise"> Decouple I/O from processing; validate input schema before processing; make headers-to-field mapping explicit; convert conversational MsgBox and free-form logs to structured, testable logging and error codes; add per-stage validation and dry-run mode; ensure <code>ProcessRow</code> output contract strictly enforced and failures isolated (so incomplete rows do not zero-out outputs). </td></tr><tr><td data-label="Module"><div class="tv-left-col"><div class="left-col-heading"><strong>modConfig.bas</strong></div></div></td><td data-label="Analysis"> Central settings and rules loader using late-bound dictionaries. Loads defaults, overlays from ListObject or sheet, reads brackets/params and builds PTKP map. Key normalization exists but parameter schema validation is weak. Bracket loading validates ascending uppers but uses minimal type validation; PTKP canonicalization logic is helpful but brittle for odd key formats.                                                                                                                                                                                                                            </td><td data-label="Reason to Revise"> Enforce schema and type validation for required keys (PTKP, NPWP_PENALTY_PCT, DTP_PCT, BRACKETS); fail early with explicit errors instead of silent defaults; make PTKP canonical mapping robust and documented; provide programmatic accessors returning typed values; expose config diagnostics on load for operator review.                                                        </td></tr><tr><td data-label="Module"><div class="tv-left-col"><div class="left-col-heading"><strong>modUtils.bas</strong></div></div></td><td data-label="Analysis"> File/path, folder, timestamp, settings read, and logging helpers. <code>JoinPath</code>, <code>EnsureFolder</code>, <code>SafeMoveFile</code> are thorough. <code>ReadSettings</code> returns uppercase keys. <code>LogMsg</code> appends rows to sheet and creates sheet. Many functions use <code>On Error Resume Next</code> liberally; locale-aware numeric handling not centralized; <code>LogMsg</code> writes <code>source</code> as sheetName (misleading).                                                                                                                                                                                                                                      </td><td data-label="Reason to Revise"> Reduce broad error suppression; centralize and normalize timestamp, encoding, and path separators; standardize <code>LogMsg</code> columns (source vs subsystem), add log levels and structured machine-readable fields (e.g., JSON blob column), ensure <code>ReadSettings</code> returns typed values or exposes validation; make <code>SafeMoveFile</code> unit-testable with clear outcomes.                       </td></tr><tr><td data-label="Module"><div class="tv-left-col"><div class="left-col-heading"><strong>modIO</strong> (expected)</div></div></td><td data-label="Analysis"> I/O functions (not fully pasted) are referenced: <code>ReadTableToDicts</code>, <code>ReadBrackets</code>, <code>ReadParams</code>, <code>WriteCsvAtomic</code>, <code>ImportCsvToSheet</code>. Current code relies on them but sample outputs show writer produced zeros — indicating mismatch between read/write and calc contracts.                                                                                                                                                                                                                                                                                                                                  </td><td data-label="Reason to Revise"> Audit I/O module for column mapping, numeric conversions (locale), header ordering, and atomic write correctness; add schema enforcement when reading <code>tblInput</code> and <code>tblBrackets</code>; ensure CSV writer quotes/escapes and is consistent with <code>EscapeCsv</code>.                                                                                                                              </td></tr><tr><td data-label="Module"><div class="tv-left-col"><div class="left-col-heading"><strong>modManifest</strong> (expected)</div></div></td><td data-label="Analysis"> Writes manifest JSON; referenced by orchestrator. Implementation likely concatenates strings.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td><td data-label="Reason to Revise"> Replace ad-hoc concatenation with a safe JSON encoder; ensure unicode/quote escaping; include SHA or file metadata; validate manifest against a schema.                                                                                                                                                                                                                               </td></tr><tr><td data-label="Module"><div class="tv-left-col"><div class="left-col-heading"><strong>Rules_Brackets (loader)</strong></div></div></td><td data-label="Analysis"> Brackets table present; loader checks ascending uppers but may accept invalid rates or missing final cap. Edge cases for equal uppers or non-infinite cap not handled.                                                                                                                                                                                                                                                                                                                                                                                                                                           </td><td data-label="Reason to Revise"> Validate numeric ranges (rate 0–1 or 0–100), ensure last bracket represents "rest" (very large cap), verify no gaps, add explicit error that aborts run when brackets invalid.                                                                                                                                                                                                        </td></tr><tr><td data-label="Module"><div class="tv-left-col"><div class="left-col-heading"><strong>Rules_Params (loader)</strong></div></div></td><td data-label="Analysis"> Key/value table contains PTKP, BPJS rates, DTP, NPWP penalty. Loader maps keys but does not validate required param presence or sensible numeric ranges.                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td><td data-label="Reason to Revise"> Validate required parameter set and ranges (e.g., 0 ≤ DTP_PCT ≤ 100), coerce percent strings properly, surface missing params, and reject duplicate or ambiguous keys.                                                                                                                                                                                                                </td></tr><tr><td data-label="Module"><div class="tv-left-col"><div class="left-col-heading"><strong>Input Sheet Processing</strong></div></div></td><td data-label="Analysis"> Input columns are numerous and use different names than code expects. <code>NormalizeInputs</code> and <code>InputAt</code> attempt broad compatibility but mask structural problems. Sample data shows <code>annual_*</code> outputs remain zero — likely input-to-field mapping mismatch.                                                                                                                                                                                                                                                                                                                                                       </td><td data-label="Reason to Revise"> Implement explicit input column map and validate mandatory fields (nip/taxpayer_number/gross/period/period_type/npwp_status). Fail fast on missing mandatory fields. Convert and cache typed numeric fields once. Provide per-row validation report.                                                                                                                                  </td></tr><tr><td data-label="Module"><div class="tv-left-col"><div class="left-col-heading"><strong>Outputs_BuktiPotong Writer</strong></div></div></td><td data-label="Analysis"> Writer appends computed headers and writes CSV. Current results show computed columns as <code>0</code>, suggesting <code>ProcessRow</code> did not populate outputs or keys mismatch (different key names: e.g., code uses <code>"nip"</code> but input has <code>employee_id</code>).                                                                                                                                                                                                                                                                                                                                                                      </td><td data-label="Reason to Revise"> Align internal field names with sheet headers or add a mapping layer. Make writer tolerant of missing computed fields only if explicitly allowed and log missing fields. Ensure numeric formatting and rounding match spec.                                                                                                                                                           </td></tr><tr><td data-label="Module"><div class="tv-left-col"><div class="left-col-heading"><strong>Outputs_Per11 Writer</strong></div></div></td><td data-label="Analysis"> Intended Per-11 payload structure but produced blank nip/npwp values in sample. Writer assumes <code>GetDictValue(row,"nip")</code> etc.; mismatch with <code>employee_id</code> and <code>taxpayer_number</code> used in sheets.                                                                                                                                                                                                                                                                                                                                                                                                                 </td><td data-label="Reason to Revise"> Map sheet columns to expected Per-11 keys, enforce required fields, add batch-level validation to ensure every Per-11 row contains nip/npwp/period.                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Module"><div class="tv-left-col"><div class="left-col-heading"><strong>Logging &amp; Diagnostics</strong></div></div></td><td data-label="Analysis"> <code>LogMsg</code> exists but logging is mixed between user-facing MsgBox and sheet logs. No centralized verbosity control; debug output inconsistent.                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td><td data-label="Reason to Revise"> Add runtime <code>VERBOSE</code>/<code>LOG_LEVEL</code> controlled at settings; emit a startup diagnostics summary (settings loaded, rules loaded, counts) and a per-row validation summary; write machine-readable log for post-mortem.                                                                                                                                                                    </td></tr><tr><td data-label="Module"><div class="tv-left-col"><div class="left-col-heading"><strong>Error Handling Strategy</strong></div></div></td><td data-label="Analysis"> Modules use <code>On Error Resume Next</code> liberally; many helper functions swallow errors and return defaults. Top-level shows MsgBox and Exit Sub but no structured exception capture.                                                                                                                                                                                                                                                                                                                                                                                                                                 </td><td data-label="Reason to Revise"> Replace global error suppression with localized, documented error handling. Return error objects or status codes. Allow orchestrator to decide whether to continue, skip row, or abort.                                                                                                                                                                                               </td></tr><tr><td data-label="Module"><div class="tv-left-col"><div class="left-col-heading"><strong>Type Safety &amp; Parsing</strong></div></div></td><td data-label="Analysis"> Numeric parsing repeated across modules (<code>ValNumber</code>, <code>SafeDoubleParse</code> in different modules). Percent string handling duplicated. Variants and strings used widely.                                                                                                                                                                                                                                                                                                                                                                                                                                             </td><td data-label="Reason to Revise"> Centralize parsing into a single utility with consistent locale handling, percent parsing, and validation. Convert and store typed values at load time.                                                                                                                                                                                                                               </td></tr><tr><td data-label="Module"><div class="tv-left-col"><div class="left-col-heading"><strong>Naming &amp; Schema Consistency</strong></div></div></td><td data-label="Analysis"> Sheet headers (<code>employee_id</code>, <code>taxpayer_number</code>) differ from internal keys (<code>nip</code>, <code>npwp</code>). Multiple synonyms and case variations handled ad-hoc.                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td><td data-label="Reason to Revise"> Create canonical field map and document transformation rules. Use single source of truth for header→internal key mapping.                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Module"><div class="tv-left-col"><div class="left-col-heading"><strong>Rounding &amp; Monetary Rules</strong></div></div></td><td data-label="Analysis"> Rounding behavior handled in <code>modCalc</code> via <code>RoundToRupiah</code>, other modules may apply additional rounding or <code>PPH21_ROUNDING</code> param.                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td><td data-label="Reason to Revise"> Centralize rounding policy into utils, expose rounding mode (INDO, BANKERS), and ensure consistent application at each stage (intermediate vs final).                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Module"><div class="tv-left-col"><div class="left-col-heading"><strong>Performance &amp; Scalability</strong></div></div></td><td data-label="Analysis"> Per-row COM interactions and repeated dictionary lookups; CSV strings concatenated in VBA loop (memory pressure for large runs).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td><td data-label="Reason to Revise"> Batch-read ranges into arrays, pre-allocate output arrays, minimize worksheet interactions inside loops, and write CSVs via streaming or ADODB for large datasets.                                                                                                                                                                                                                    </td></tr><tr><td data-label="Module"><div class="tv-left-col"><div class="left-col-heading"><strong>Testability &amp; Observability</strong></div></div></td><td data-label="Analysis"> Few pure functions and many side-effecting procedures. Hard to unit test. No diagnostic output of intermediate tax-band breakdown per row.                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td><td data-label="Reason to Revise"> Refactor to isolate pure calculation functions (take typed inputs → return typed outputs) and wrap I/O in adapters. Add optional verbose trace per row for audits.                                                                                                                                                                                                                    </td></tr><tr><td data-label="Module"><div class="tv-left-col"><div class="left-col-heading"><strong>Regulatory Compliance</strong></div></div></td><td data-label="Analysis"> PTKP values and brackets are externalized but DTP, NPWP penalty application semantics must be confirmed for 2025.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td><td data-label="Reason to Revise"> Add a “rules version” and store an audit trail of the parameter set used for each run. Validate computation flows against authoritative specification and add regression tests for known cases.                                                                                                                                                                                       </td></tr></tbody></table></div><div class="row-count">Rows: 19</div></div><div class="table-caption" id="Table2" data-table="Docu_0145_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by Input Sheet Header" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Input Sheet Header</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th><th aria-label="Sort by Internal Key (must be used inside VBA dictionaries)" class="tv-col" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Internal Key (must be used inside VBA dictionaries)</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th><th aria-label="Sort by Notes" class="tv-col" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Notes</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>employee_id</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>nip</code> </td><td data-label="Notes"> Mandatory. Required by Bukti Potong + Per11. </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>taxpayer_number</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>npwp</code> </td><td data-label="Notes"> Mandatory. May be empty for non-NPWP.        </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>employee_name</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>name</code> </td><td data-label="Notes"> Used in Per11 + Bukti.                       </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>tax_period</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>period</code> </td><td data-label="Notes"> Ensure text → integer conversion.            </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>period_type</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>period_type</code> </td><td data-label="Notes"> Monthly / annual.                            </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>taxpayer_status</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>status</code> </td><td data-label="Notes"> Maps to PTKP logic.                          </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>tax_object_code</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>tax_object_code</code> </td><td data-label="Notes"> Output field.                                </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>withholding_type</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>withholding_type</code> </td><td data-label="Notes"> Output field.                                </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>calculation_scheme</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>calc_scheme</code> </td><td data-label="Notes"> Internal; affects BPJS/other.                </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>gross_income</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>gross_income</code> </td><td data-label="Notes"> Numeric.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>salary_or_pension</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>salary_pension</code> </td><td data-label="Notes"> Numeric.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>pph_allowance</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>pph_allowance</code> </td><td data-label="Notes"> Numeric.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>other_allowances</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>other_allowances</code> </td><td data-label="Notes"> Numeric.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>honorarium</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>honorarium</code> </td><td data-label="Notes"> Numeric.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>insurance_premium</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>insurance_premium</code> </td><td data-label="Notes"> Numeric.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>benefits_in_kind</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>bik</code> </td><td data-label="Notes"> Numeric.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>bonus_or_tantiem</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>bonus</code> </td><td data-label="Notes"> Numeric.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>total_gross_income</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>total_gross</code> </td><td data-label="Notes"> Numeric (fallback: sum).                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>job_expense_deduction</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>job_expense</code> </td><td data-label="Notes"> Numeric.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>pension_contribution</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>pension_contribution</code> </td><td data-label="Notes"> Numeric.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>tht_jht_contribution</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>tht_jht</code> </td><td data-label="Notes"> Numeric.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>zakat_deduction</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>zakat</code> </td><td data-label="Notes"> Numeric.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>total_deductions</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>total_deductions</code> </td><td data-label="Notes"> Numeric (fallback: sum).                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>net_income</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>net_income</code> </td><td data-label="Notes"> Numeric.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>previous_net_income</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>prev_net_income</code> </td><td data-label="Notes"> Annualization.                               </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>annualized_net_income</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>annualized_net_income</code> </td><td data-label="Notes"> Result or input.                             </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>non_taxable_income</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>ptkp</code> </td><td data-label="Notes"> PTKP.                                        </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>pph21_payable</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>pph21_payable</code> </td><td data-label="Notes"> Output.                                      </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>pph21_withheld</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>pph21_withheld</code> </td><td data-label="Notes"> Output.                                      </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>pph21_difference</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>pph21_difference</code> </td><td data-label="Notes"> Output.                                      </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>bpjs_health_employer</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>bpjs_h_er</code> </td><td data-label="Notes"> Numeric.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>bpjs_work_accident_employer</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>bpjs_jkk_er</code> </td><td data-label="Notes"> Numeric.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>bpjs_life_insurance_employer</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>bpjs_jkm_er</code> </td><td data-label="Notes"> Numeric.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>bpjs_retirement_employer</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>bpjs_jht_er</code> </td><td data-label="Notes"> Numeric.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>bpjs_health_employer_pct</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>bpjs_h_pct</code> </td><td data-label="Notes"> Percent.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>bpjs_work_accident_employer_pct</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>bpjs_jkk_pct</code> </td><td data-label="Notes"> Percent.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>bpjs_life_insurance_employer_pct</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>bpjs_jkm_pct</code> </td><td data-label="Notes"> Percent.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>bpjs_retirement_employer_pct</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>bpjs_jht_pct</code> </td><td data-label="Notes"> Percent.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>bpjs_health_employee</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>bpjs_h_ee</code> </td><td data-label="Notes"> Numeric.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>bpjs_retirement_employee</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>bpjs_jp_ee</code> </td><td data-label="Notes"> Numeric.                                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>bpjs_employee_contribution_total</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>bpjs_total_ee</code> </td><td data-label="Notes"> Numeric (fallback: sum).                     </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>security_code</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>security_code</code> </td><td data-label="Notes"> Pass-through.                                </td></tr><tr><td data-label="Input Sheet Header"><div class="tv-left-col"><div class="left-col-content"><code>calculation_timestamp</code></div></div></td><td data-label="Internal Key (must be used inside VBA dictionaries)"> <code>timestamp</code> </td><td data-label="Notes"> Pass-through.                                </td></tr></tbody></table></div><div class="row-count">Rows: 43</div></div><div class="table-caption" id="Table3" data-table="Docu_0145_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **Content**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Content</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Content"><div class="tv-left-col"><div class="left-col-heading"><strong>1. Net Income Calculation</strong> <br/> Gross income minus allowable deductions <br/><br/> Net income is calculated by subtracting total deductions from total gross income. <br/><br/> Example: Budi Santoso (Employee ID: 1987654321) <br/> Total Gross Income = 15,000,000 (gross_income) + 10,000,000 (salary_or_pension) + 1,000,000 (pph_allowance) + 500,000 (other_allowances) = 15,000,000 (total_gross_income). <br/><br/> Total Deductions: <br/> – Job Expense: 150,000 <br/> – Pension: 200,000 <br/> – Zakat: 350,000 <br/><br/> Total Deductions = 700,000 <br/><br/> Net Income = 15,000,000 − 700,000 = <strong>14,650,000</strong></div></div></td></tr><tr><td data-label="Content"><div class="tv-left-col"><div class="left-col-heading"><strong>2. Annualized Net Income</strong> <br/> Monthly to yearly conversion <br/><br/> Annualized Net Income = 14,650,000 × 12 = <strong>175,800,000</strong>. <br/><br/> This matches the provided annualized_net_income.</div></div></td></tr><tr><td data-label="Content"><div class="tv-left-col"><div class="left-col-heading"><strong>3. PTKP Determination</strong> <br/> Personal tax exemption <br/><br/> PTKP based on taxpayer status. <br/><br/> PTKP_TK0 (single, no dependents) = <strong>54,000,000</strong>. <br/><br/> Applied correctly for Budi Santoso.</div></div></td></tr><tr><td data-label="Content"><div class="tv-left-col"><div class="left-col-heading"><strong>4. Taxable Income Calculation</strong> <br/> Annual income minus PTKP <br/><br/> Taxable Income = 175,800,000 − 54,000,000 = <strong>121,800,000</strong>.</div></div></td></tr><tr><td data-label="Content"><div class="tv-left-col"><div class="left-col-heading"><strong>5. Progressive Tax Calculation</strong> <br/> Application of tax brackets <br/><br/> Tax Brackets: <br/> – 0–50,000,000 = 5% <br/> – 50,000,000–250,000,000 = 15% <br/><br/> First Bracket: 50,000,000 × 5% = 2,500,000 <br/> Second Bracket: 71,800,000 × 15% = 10,770,000 <br/><br/> <strong>Annual Tax = 13,270,000</strong></div></div></td></tr><tr><td data-label="Content"><div class="tv-left-col"><div class="left-col-heading"><strong>6. Tax Adjustments (DTP &amp; NPWP)</strong> <br/> Government incentives &amp; penalties <br/><br/> DTP = 50% <br/> Tax After DTP = 13,270,000 × 50% = <strong>6,635,000</strong> <br/><br/> NPWP Penalty = 20% <br/> Since NPWP exists → <strong>No penalty applied</strong></div></div></td></tr><tr><td data-label="Content"><div class="tv-left-col"><div class="left-col-heading"><strong>7. BPJS Contributions</strong> <br/> Employer &amp; employee social security <br/><br/> Employer: <br/> – Health 1% = 150,000 <br/> – Work Accident 0.24% = 36,000 <br/> – Life 0.1% = 15,000 <br/> – Retirement 2% = 300,000 <br/> <strong>Total Employer = 501,000</strong> <br/><br/> Employee: <br/> – Health 1% = 100,000 <br/> – Retirement 2% = 200,000 <br/> <strong>Total Employee = 300,000</strong></div></div></td></tr><tr><td data-label="Content"><div class="tv-left-col"><div class="left-col-heading"><strong>8. PPh 21 Withheld &amp; Difference</strong> <br/> Tax paid vs tax due <br/><br/> PPh 21 Withheld = 5,000 <br/><br/> Difference = 0 − 5,000 = <strong>−5,000</strong> → Tax Refund</div></div></td></tr><tr><td data-label="Content"><div class="tv-left-col"><div class="left-col-heading"><strong>9. Monthly Withholding</strong> <br/> Monthly tax distribution <br/><br/> Monthly Withholding = 6,635,000 ÷ 12 = <strong>552,917</strong></div></div></td></tr><tr><td data-label="Content"><div class="tv-left-col"><div class="left-col-heading"><strong>10. Final Validation &amp; Conclusion</strong> <br/> End-to-end review <br/><br/> All components—net income, PTKP, taxable income, progressive tax, BPJS, DTP, and monthly withholding—are mathematically consistent and accurate.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 10</div></div><div class="table-caption" id="Table4" data-table="Docu_0145_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **SOP Area**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>SOP Area</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th><th aria-label="Sort by **Your Current Process (As Written)**" class="tv-col" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Your Current Process (As Written)</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th><th aria-label="Sort by **Best Practice Version (Gold Standard)**" class="tv-col" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Best Practice Version (Gold Standard)</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="SOP Area"><div class="tv-left-col"><div class="left-col-heading"><strong>1. Net Income Calculation</strong> <br/> Gross income minus allowable deductions</div></div></td><td data-label="Your Current Process (As Written)"> Net income is calculated by subtracting total deductions from total gross income. <br/><br/> Example: Budi Santoso (Employee ID: 1987654321) <br/> Total Gross Income = 15,000,000 (gross_income) + 10,000,000 (salary_or_pension) + 1,000,000 (pph_allowance) + 500,000 (other_allowances) = 15,000,000 (total_gross_income). <br/><br/> Total Deductions: <br/> – Job Expense: 150,000 <br/> – Pension: 200,000 <br/> – Zakat: 350,000 <br/><br/> Total Deductions = 700,000 <br/><br/> Net Income = 15,000,000 − 700,000 = <strong>14,650,000</strong> </td><td data-label="Best Practice Version (Gold Standard)"> Net income must be computed monthly using validated income and deduction registers. <br/><br/> Deductions must be supported by payroll policy and employee consent documents. <br/><br/> Net income review and approval required by Finance Supervisor before tax processing. </td></tr><tr><td data-label="SOP Area"><div class="tv-left-col"><div class="left-col-heading"><strong>2. Annualized Net Income</strong> <br/> Monthly to yearly conversion</div></div></td><td data-label="Your Current Process (As Written)"> Annualized Net Income = 14,650,000 × 12 = <strong>175,800,000</strong>. <br/><br/> This matches the provided annualized_net_income.                                                                                                                                                                                                                                                                                                                                                                                                             </td><td data-label="Best Practice Version (Gold Standard)"> Annualization must be automatically generated by the payroll system. <br/><br/> Manual overrides require Head of Finance (HoF) justification and audit trail.                                                                                                               </td></tr><tr><td data-label="SOP Area"><div class="tv-left-col"><div class="left-col-heading"><strong>3. PTKP Determination</strong> <br/> Personal tax exemption</div></div></td><td data-label="Your Current Process (As Written)"> PTKP based on taxpayer status. <br/><br/> PTKP_TK0 (single, no dependents) = <strong>54,000,000</strong>. <br/><br/> Applied correctly for Budi Santoso.                                                                                                                                                                                                                                                                                                                                                                                          </td><td data-label="Best Practice Version (Gold Standard)"> PTKP status must be updated annually based on employee declaration form. <br/><br/> HR validation required before payroll tax finalization.                                                                                                                                 </td></tr><tr><td data-label="SOP Area"><div class="tv-left-col"><div class="left-col-heading"><strong>4. Taxable Income Calculation</strong> <br/> Annual income minus PTKP</div></div></td><td data-label="Your Current Process (As Written)"> Taxable Income = 175,800,000 − 54,000,000 = <strong>121,800,000</strong>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td><td data-label="Best Practice Version (Gold Standard)"> Taxable income must be automatically derived and locked before tax engine execution. <br/><br/> Manual adjustments require dual approval (Payroll + Finance).                                                                                                               </td></tr><tr><td data-label="SOP Area"><div class="tv-left-col"><div class="left-col-heading"><strong>5. Progressive Tax Calculation</strong> <br/> Application of tax brackets</div></div></td><td data-label="Your Current Process (As Written)"> Tax Brackets: <br/> – 0–50,000,000 = 5% <br/> – 50,000,000–250,000,000 = 15% <br/><br/> First Bracket: 50,000,000 × 5% = 2,500,000 <br/> Second Bracket: 71,800,000 × 15% = 10,770,000 <br/><br/> <strong>Annual Tax = 13,270,000</strong> </td><td data-label="Best Practice Version (Gold Standard)"> Progressive tax must be system-calculated using locked government rates. <br/><br/> Monthly audit check required on at least 10% of payroll sample.                                                                                                                         </td></tr><tr><td data-label="SOP Area"><div class="tv-left-col"><div class="left-col-heading"><strong>6. Tax Adjustments (DTP &amp; NPWP)</strong> <br/> Government incentives &amp; penalties</div></div></td><td data-label="Your Current Process (As Written)"> DTP = 50% <br/> Tax After DTP = 13,270,000 × 50% = <strong>6,635,000</strong> <br/><br/> NPWP Penalty = 20% <br/> Since NPWP exists → <strong>No penalty applied</strong> </td><td data-label="Best Practice Version (Gold Standard)"> All tax incentives must reference official government regulation codes. <br/><br/> NPWP validation must be cross-checked with tax authority database annually.                                                                                                              </td></tr><tr><td data-label="SOP Area"><div class="tv-left-col"><div class="left-col-heading"><strong>7. BPJS Contributions</strong> <br/> Employer &amp; employee social security</div></div></td><td data-label="Your Current Process (As Written)"> Employer: <br/> – Health 1% = 150,000 <br/> – Work Accident 0.24% = 36,000 <br/> – Life 0.1% = 15,000 <br/> – Retirement 2% = 300,000 <br/> <strong>Total Employer = 501,000</strong> <br/><br/> Employee: <br/> – Health 1% = 100,000 <br/> – Retirement 2% = 200,000 <br/> <strong>Total Employee = 300,000</strong> </td><td data-label="Best Practice Version (Gold Standard)"> BPJS rates must be system-locked and updated only upon formal regulation changes. <br/><br/> Monthly reconciliation required between payroll, BPJS portal, and GL.                                                                                                          </td></tr><tr><td data-label="SOP Area"><div class="tv-left-col"><div class="left-col-heading"><strong>8. PPh 21 Withheld &amp; Difference</strong> <br/> Tax paid vs tax due</div></div></td><td data-label="Your Current Process (As Written)"> PPh 21 Withheld = 5,000 <br/><br/> Difference = 0 − 5,000 = <strong>−5,000</strong> → Tax Refund                                                                                                                                                                                                                                                                                                                                                                                                                                                </td><td data-label="Best Practice Version (Gold Standard)"> Over/under-withholding must be tracked per employee and settled in the following payroll cycle with management sign-off.                                                                                                                                                  </td></tr><tr><td data-label="SOP Area"><div class="tv-left-col"><div class="left-col-heading"><strong>9. Monthly Withholding</strong> <br/> Monthly tax distribution</div></div></td><td data-label="Your Current Process (As Written)"> Monthly Withholding = 6,635,000 ÷ 12 = <strong>552,917</strong> </td><td data-label="Best Practice Version (Gold Standard)"> Monthly withholding must be auto-reconciled against annual projection with variance tolerance &lt; 1%.                                                                                                                                                                       </td></tr><tr><td data-label="SOP Area"><div class="tv-left-col"><div class="left-col-heading"><strong>10. Final Validation &amp; Conclusion</strong> <br/> End-to-end review</div></div></td><td data-label="Your Current Process (As Written)"> All components—net income, PTKP, taxable income, progressive tax, BPJS, DTP, and monthly withholding—are mathematically consistent and accurate.                                                                                                                                                                                                                                                                                                                                                                                 </td><td data-label="Best Practice Version (Gold Standard)"> Final payroll tax report must be reviewed by HoF and approved by CFO before disbursement and tax submission.                                                                                                                                                              </td></tr></tbody></table></div><div class="row-count">Rows: 10</div></div><div class="table-caption" id="Table5" data-table="Docu_0145_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by Technical breakdown — consolidated scan (checked repeatedly)" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical breakdown — consolidated scan (checked repeatedly)</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical breakdown — consolidated scan (checked repeatedly)"><div class="tv-left-col"><div class="left-col-heading"><strong>High-level status</strong>: Modules present: modConfig, modCalc, modIO, modMain, modManifest. Several integration points match; missing adapters/name mismatches and external helpers will prevent safe drop-in run without a small shim (modUtils).</div></div></td></tr><tr><td data-label="Technical breakdown — consolidated scan (checked repeatedly)"><div class="tv-left-col"><div class="left-col-heading"><strong>Core pipeline intended</strong>: load settings → read rules &amp; params → read inputs → ProcessRow (modCalc) → write CSVs (modIO) → write manifest (modManifest) → import CSVs.</div></div></td></tr><tr><td data-label="Technical breakdown — consolidated scan (checked repeatedly)"><div class="tv-left-col"><div class="left-col-heading"><strong>Immediate integration mismatches (must fix before running)</strong>: modMain calls ReadSettings(settingsSheet) but provided modConfig exposes Config_Load, Config_GetAll, etc. Helpers EnsureFolder, JoinPath, SafeMoveFile, LogMsg referenced by modIO.WriteCsvAtomic are not provided. Action: implement modUtils or adapters for these.</div></div></td></tr><tr><td data-label="Technical breakdown — consolidated scan (checked repeatedly)"><div class="tv-left-col"><div class="left-col-heading"><strong>ReadSettings action</strong>: Add ReadSettings wrapper that calls Config_Load(settingsSheet) then returns Config_GetAll() (or a Dictionary with expected keys) so modMain receives the expected object.</div></div></td></tr><tr><td data-label="Technical breakdown — consolidated scan (checked repeatedly)"><div class="tv-left-col"><div class="left-col-heading"><strong>EnsureFolder / JoinPath / SafeMoveFile / LogMsg action</strong>: Implement small modUtils with: JoinPath(a,b) normalize separators; EnsureFolder(path) create folder if missing and return boolean; SafeMoveFile(src,dest) atomic move with fallback; LogMsg(source,text,level) append to "Logs" sheet or Debug.Print. These resolve WriteCsvAtomic dependencies and prevent leftover .tmp files.</div></div></td></tr><tr><td data-label="Technical breakdown — consolidated scan (checked repeatedly)"><div class="tv-left-col"><div class="left-col-heading"><strong>ReadSettings vs Config naming</strong>: Normalise config keys for modMain (e.g., "OUTPUT_BASE", "JOB_ID"). Ensure ReadSettings returns an Exists-capable object.</div></div></td></tr><tr><td data-label="Technical breakdown — consolidated scan (checked repeatedly)"><div class="tv-left-col"><div class="left-col-heading"><strong>WriteManifest</strong>: modManifest provides WriteManifest and calls WriteCsvAtomic — OK. Ensure modManifest module is available in project scope and that WriteManifest returns True/False as modMain expects.</div></div></td></tr><tr><td data-label="Technical breakdown — consolidated scan (checked repeatedly)"><div class="tv-left-col"><div class="left-col-heading"><strong>File/Sheet names expectations</strong>: modMain expects sheet/listobject names: "Settings" (tblSettings), "Input" (tblInput), "Rules_Brackets" (tblBrackets), "Rules_Params" (tblParams). Confirm workbook contains those ListObject names or adapt code to actual names.</div></div></td></tr><tr><td data-label="Technical breakdown — consolidated scan (checked repeatedly)"><div class="tv-left-col"><div class="left-col-heading"><strong>Data / array indexing concerns</strong>: ReadBrackets returns 1-based arrays while modCalc may expect different bounds. Recommendation: normalize bracket arrays to 0-based or add adapter in modMain to reindex before passing to ProcessRow.</div></div></td></tr><tr><td data-label="Technical breakdown — consolidated scan (checked repeatedly)"><div class="tv-left-col"><div class="left-col-heading"><strong>Functional correctness risks &amp; edge cases</strong>: PTKP parsing duplicates across modules — create a single canonicalization function; NPWP normalization looks robust but ensure input variants match; BPJS annualization conventions must match annualization_default; FloorToThousand is hard-coded to 1000 in modCalc — make configurable via Config_GetDouble("PKP_FLOOR_TO") if desired; SHA256 implementation should be tested on a known vector.</div></div></td></tr><tr><td data-label="Technical breakdown — consolidated scan (checked repeatedly)"><div class="tv-left-col"><div class="left-col-heading"><strong>Error handling</strong>: Many On Error Resume Next blocks may hide logic errors; for debugging, increase logging and temporarily fail-fast on missing keys.</div></div></td></tr><tr><td data-label="Technical breakdown — consolidated scan (checked repeatedly)"><div class="tv-left-col"><div class="left-col-heading"><strong>Missing/undefined names summary</strong>: ReadSettings, EnsureFolder, JoinPath, SafeMoveFile, LogMsg are missing. Application.Run "LogMsg" is used in places — either implement that macro or replace with global LogMsg routine.</div></div></td></tr><tr><td data-label="Technical breakdown — consolidated scan (checked repeatedly)"><div class="tv-left-col"><div class="left-col-heading"><strong>Recommended modUtils functions (minimal, conservative)</strong>: JoinPath(a,b) handle trailing slashes; EnsureFolder(path) create-if-missing return Boolean; SafeMoveFile(src,dest) attempt atomic move, fallback to Name/MoveFile; LogMsg(source,text,Optional level) append to "Logs" sheet or Debug.Print. Adding these resolves most runtime blockers.</div></div></td></tr><tr><td data-label="Technical breakdown — consolidated scan (checked repeatedly)"><div class="tv-left-col"><div class="left-col-heading"><strong>Adapter helpers to add</strong>: ReadSettings wrapper calling Config_Load + Config_GetAll; ConvertToZeroBased helper to convert 1-based bracket arrays to 0-based for ProcessRow; CanonicalPTKPKey shared routine to avoid duplicate parsing logic.</div></div></td></tr><tr><td data-label="Technical breakdown — consolidated scan (checked repeatedly)"><div class="tv-left-col"><div class="left-col-heading"><strong>Quick test plan (minimal validation before production)</strong>: 1) Create small test workbook with required sheets and one sample input row. 2) Add modUtils adapters and ReadSettings wrapper. 3) Run pph21_RunAll. 4) Verify outputs: bukti_potong.csv rows match inputs, per11_payload.csv columns and values match expected outputs, manifest.json contains sha256 and sizes. 5) Regression: change a bracket rate and confirm tax changes.</div></div></td></tr><tr><td data-label="Technical breakdown — consolidated scan (checked repeatedly)"><div class="tv-left-col"><div class="left-col-heading"><strong>Suggested immediate code edits (conservative, minimal)</strong>: Add modUtils.bas with JoinPath, EnsureFolder, SafeMoveFile, LogMsg. Add modAdapter.bas with ReadSettings wrapper and bracket reindex helper. Optional: change modCalc.FloorToThousand to read PKP_FLOOR_TO via config.</div></div></td></tr><tr><td data-label="Technical breakdown — consolidated scan (checked repeatedly)"><div class="tv-left-col"><div class="left-col-heading"><strong>Unit tests to add (automated, high-value)</strong>: Test ComputeProgressiveTax against known PKP→tax vectors; SHA256 test vector check; ParseNumberToDouble tests for localized formats ("1.234.567,89", "5%", "(1,200)"); SafeMoveFile file-lock fallback test.</div></div></td></tr><tr><td data-label="Technical breakdown — consolidated scan (checked repeatedly)"><div class="tv-left-col"><div class="left-col-heading"><strong>Error/edge-case notes</strong>: Watch for inconsistent canonicalization of keys between modConfig and modIO/ReadParams; ensure ListObject/table name mismatches are resolved; verify annualization conventions and rounding rules before trusting production outputs.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 18</div></div><div class="table-caption" id="Table6" data-table="Docu_0145_06" style="margin-top:2mm;margin-left:3mm;"><strong>Table 6</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **Technical Breakdown**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Name</strong><br/>modCalc.bas</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Purpose</strong><br/>Per-row tax computation engine for PPh21 processing. Robust parsing and normalization of input fields, BPJS aggregation, annualization, PKP calculation (PTKP subtraction + thousand-flooring), progressive tax computation across brackets, DTP application, NPWP penalty, rounding and packaging of outputs for bukti_potong and Per-11 payloads. Designed to be backward-compatible and late-bound (Scripting.Dictionary outputs).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Design Principles</strong><br/>• Single responsibility: only per-row computation and deterministic numeric transformations.<br/>• Defensive parsing: tolerant numeric and string parsers (ToDoubleSafe) accepting many formats.<br/>• Tolerant input keys: accepts multiple header name variants (employee_id/nip, gross/gross_income/total_gross_income, etc.).<br/>• Fail-safe: non-fatal logging on errors; returns Nothing outputs on fatal per-row errors and continues loop at orchestrator level.<br/>• Configurable via params object (dtp_pct, npwp_penalty_pct, PTKP values).<br/>• Backward-compatible public surface: ProcessRow(rowObj, uppers, rates, params, bukti, per11).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Public API (observed)</strong><br/>Public Sub ProcessRow(ByVal rowObj As Object, ByRef uppers() As Double, ByRef rates() As Double, ByVal params As Object, ByRef bukti As Object, ByRef per11 As Object) — primary entrypoint that returns bukti and per11 as Scripting.Dictionary objects (ByRef).<br/>Public Function ComputeProgressiveTax(ByVal pkp As Double, ByRef uppers() As Double, ByRef rates() As Double) As Double — computes annual tax on PKP.<br/>Public Function ApplyNPWPPenalty(ByVal taxBefore As Double, ByVal hasNPWP As Boolean, ByVal npwpPct As Double) As Double — applies NPWP penalty multiplicatively.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Expected inputs (rowObj tolerant keys)</strong><br/>Identifiers: nip / employee_id / employeeid; npwp / taxpayer_number; name / employee_name; period / tax_period; period_type (monthly default).<br/>Monetary fields: gross / gross_income / total_gross_income / gaji_pensiun; salary_or_pension; pph_allowance; other_allowances; honorarium; insurance_premium; benefits_in_kind; bonus_or_tantiem; total_gross_income; job_expense_deduction; pension_contribution; iuran_bpjs fields (various keys accepted).<br/>Flags: taxpayer_status / npwp_status variants accepted.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Expected rules inputs (uppers &amp; rates arrays)</strong><br/>uppers(): numeric ascending bracket upper bounds; rates(): parallel array of rates. Rates accepted as fractional (0.05) or percent strings/values and normalized by NormalizePct. Module normalizes rates internally. Ensure arrays LBound/UBound consistent with caller.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Key internal behaviors — parsing &amp; normalization</strong><br/>• ToDoubleSafe: tolerant numeric parser handling percent strings, thousand separators, mixed "." / "," decimal heuristics, and parentheses for negatives. Returns 0 on parse failure.<br/>• NormalizePct: converts values &gt;1 to fractional form (e.g., 5 -&gt; 0.05). Constrains extreme values.<br/>• NormalizeNPWPStatus: robust textual mapping for many NPWP status variants.<br/>• GetAnyVariant / GetAnyString: tolerant field access supporting Dictionary and object property access via CallByName.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>BPJS handling</strong><br/>• ExtractMonetaryField reads explicit employer amount or employer percentage field (_pct) and computes amount as pct*gross when only percentage provided.<br/>• Aggregates employer BPJS premiums (premi_asuransi_employer) as sum of health, work accident (JKK), life insurance (JKM), retirement (JHT) employer contributions.<br/>• Sums employee BPJS iuran fields via SumMonetaryFields to iuran_bpjs_employee_amt; used in taxable base deduction if allow_employee_bpjs_deduction is true.<br/>• Annualization applied to both gross and BPJS amounts depending on period_type and include_employer_bpjs_in_gross flag.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Annualization &amp; taxable base logic</strong><br/>Priority to determine taxable_annual:<br/>1) Use explicit annualized_net_income if present (&gt;0).<br/>2) Else if monthly net_income present (&gt;0) → monthly_net_input * 12.<br/>3) Else fallback: annual_gross (annualized gross_base optionally + employer BPJS) minus annual_iuran_employee (if allow_employee_bpjs_deduction).<br/>This avoids double-subtracting BPJS when net_income already excludes them.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>PKP and rounding rules</strong><br/>• PTKP is fetched from params via GetPTKPFromParams (multiple key variants supported); fallback PTKP_TK0 = 54,000,000 if absent.<br/>• PKP_raw = taxable_annual - ptkp_value; floor to 0 if negative. PKP floored to nearest lower 1,000 via FloorToThousand (configurable in design but currently hard-coded to 1,000 in function).<br/>• Progressive tax computed on floored PKP.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Progressive tax algorithm</strong><br/>ComputeProgressiveTax iterates bracket uppers and rates, normalizes rates, computes taxable portions per band (upper - prev) and multiplies by rate, summing across bands until PKP exhausted. Uses safe LBound/UBound indexing; accepts arrays of equal or differing lengths but takes min(nU,nR). Ensures non-negative result.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>DTP and NPWP penalty application</strong><br/>• tax_after_dtp = annual_tax * (1 - dtp_pct) where dtp_pct is normalized fractional (0..0.9999 clamp).<br/>• tax_after_penalty = ApplyNPWPPenalty(tax_after_dtp, hasNPWP, npwp_penalty_pct) — if hasNPWP False, multiplies by (1 + npwp_penalty_pct); otherwise returns unchanged.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Rounding &amp; output packaging</strong><br/>• Rounds annual_gross, annual_tax, tax_after_dtp, tax_after_penalty, monthly_withholding using RoundToRupiah (conventional rounding to nearest integer).<br/>• Monthly_withholding = tax_after_penalty / 12, rounded.<br/>• Output dictionaries (bukti and per11) preserve original input fields when rowObj is Dictionary; computed fields appended: bpjs_* amounts, premi_asuransi_employer, iuran_bpjs_employee, annual_gross, annual_tax, tax_after_dtp, tax_after_penalty, monthly_withholding.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Error handling &amp; diagnostics</strong><br/>• Top-level ProcessRow uses On Error GoTo ErrHandler and logs errors via LogMsg wrapper (non-fatal). On error bukti and per11 set to Nothing and function exits. ErrHandler clears error and records contextual message including NIP when available.<br/>• Many helper functions use On Error Resume Next for tolerant access; may silence parsing errors—recommend verbose logging for first runs.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Array indexing mismatch risk</strong><br/>• ComputeProgressiveTax expects uppers() and rates() passed as arrays; caller must ensure LBound/UBound alignment. If ReadBrackets returns 1-based arrays (modIO variant), ProcessRow and ComputeProgressiveTax still work if both arrays share same base, but cross-module differences (0-based vs 1-based) can introduce off-by-one taxation errors. Normalize bracket arrays to a consistent base before invoking ProcessRow.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Potential data-quality edge cases</strong><br/>• If monthly_net_input or annualized_net_input are zero or missing, fallback may over- or under-count BPJS deductions depending on include_employer_bpjs_in_gross and allow_employee_bpjs_deduction flags—validate sample rows.<br/>• Rates supplied as integer percentages without "%" (e.g., 5) are normalized to 0.05 in NormalizePct; SafeDoubleParse variants handle percent strings but mismatched expectations across modules risk double-normalization—standardize on one normalization routine.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Security &amp; robustness notes</strong><br/>• Uses late binding; no external system calls. Ensure input dictionaries do not contain malicious formulas when re-exporting to CSVs.<br/>• Logging should mask sensitive fields (npwp) when emitted.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Immediate recommendations / hardening</strong><br/>1. Expose PKP floor as configurable param (PKP_FLOOR_TO) and use Config_Get/params to set FloorToThousand behavior.<br/>2. Consolidate percent normalization into a single shared utility to avoid inconsistent conversions across modules.<br/>3. Add optional verbose per-row trace logging controlled by params["VERBOSE"] for first production run to surface silent parsing issues.<br/>4. Add explicit validation of uppers/rates shapes in ProcessRow entry and early return with logged error if mismatched.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Testing &amp; verification (10× checklist)</strong><br/>1) Numeric parsing: test ToDoubleSafe on variants ("1.234.567,89","5%","5","(1,200)","1,234.56").<br/>2) NPWP mapping: test NormalizeNPWPStatus on expected textual variants (with_npwp, without_npwp, yes/no, true/false).<br/>3) BPJS extraction: test ExtractMonetaryField with explicit amounts and percent-based fields to ensure correct multiplication by gross.<br/>4) Annualization: verify AnnualizeGross yields correct multipliers for monthly/weekly/daily/year inputs.<br/>5) PKP floor: verify FloorToThousand truncates down to nearest 1,000 for a range of values.<br/>6) Progressive tax: unit test ComputeProgressiveTax with known bracket/rate sets and PKP values and compare to hand-calculated expected taxes.<br/>7) DTP application: test dtp_pct edge cases (0, 50%, 100% capped at &lt;1).<br/>8) NPWP penalty: test both hasNPWP true/false with various npwp_penalty_pct values.<br/>9) Integration: run full ProcessRow on provided sample rows and assert outputs match your Outputs_BuktiPotong and Outputs_Per11 known-good CSVs.<br/>10) Rounding: verify RoundToRupiah behavior near .5 boundaries and negative numbers.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Immediate small code patches (high-impact, low-risk)</strong><br/>• Add explicit check at ProcessRow start: verify uppers and rates arrays are non-empty and have matching lengths; log and return if invalid.<br/>• Read PTKP value from params where possible instead of hard-coded fallback (already attempted via GetPTKPFromParams but ensure params passed from modMain contain normalized keys).<br/>• Add optional param PKP_FLOOR_TO usage inside FloorToThousand to honor configuration.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Performance considerations</strong><br/>• Per-row CPU cost dominated by ComputeProgressiveTax loops; acceptable for typical payroll sizes (hundreds to low thousands).<br/>• Use shared Scripting.Dictionary instances judiciously when processing very large inputs to reduce GC churn.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Versioning &amp; documentation</strong><br/>• Add module header with version constant (e.g., MODCALC_VERSION = "2025-11-28-1"), author, change-log summary, and expected param keys documented (dtp_pct, NPWP_PENALTY_PCT, INCLUDE_EMPLOYER_BPJS, ALLOW_EMPLOYEE_BPJS_DEDUCTION, PKP_FLOOR_TO).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Final acceptance criteria before production</strong><br/>• Pass the 10× testing checklist with sample dataset.<br/>• Confirm tax numbers for sample rows exactly match authoritative outputs (bukti and per11 CSVs).<br/>• Confirm no off-by-one bracket indexing errors by testing with both 0-based and 1-based bracket arrays.<br/>• Confirm verbose logs show no silent parsing errors for real workbook inputs.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 23</div></div><div class="table-caption" id="Table7" data-table="Docu_0145_07" style="margin-top:2mm;margin-left:3mm;"><strong>Table 7</strong></div>
<div class="table-wrapper" data-table-id="table-7"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **Technical Breakdown**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Name</strong><br/>modConfig.bas</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Purpose</strong><br/>Centralized configuration and rules loader for the PPh21 project. Loads default settings, overlays workbook settings (tblSettings or sheet), loads/validates tax bracket table(s) and parameter table(s), canonicalizes PTKP entries, exposes accessor APIs (Config_Get, Config_GetDouble, Config_GetBool, Config_GetPTKP, Config_GetBracketsUppers/Rates) and safe-save functionality. Designed to be a safe drop-in configuration layer for orchestration code.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Design Principles</strong><br/>• Canonicalization: normalizes dictionary keys to UPPER-case via NormalizeKey.<br/>• Defensive defaults: Config_ResetDefaults seeds safe conservative defaults.<br/>• Late-binding / no external refs: uses Scripting.Dictionary and late-bound ListObject accessors.<br/>• Conservative persistence: Config_Save writes only to an existing ListObject and will not create sheets/tables to avoid unwanted workbook edits.<br/>• Robust numeric parsing: SafeDoubleParse supports percent forms, parentheses negatives, mixed thousand/decimal separators.<br/>• PTKP canonicalization: CanonicalPTKPKey converts many key variants to normalized "TK/0","K/1" style keys.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module-level state</strong><br/>gConfig (Dictionary, normalized UPPER keys) — main settings store.<br/>gParams (Dictionary) — raw params loaded from table.<br/>gPTKP (Dictionary) — canonical PTKP map.<br/>gBracketsUppers(), gBracketsRates() — stored bracket arrays.<br/>gLoaded (Boolean) — indicates Config_Load was called.<br/>gLastError (String) — last error message exposed via Config_LastError.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Primary public APIs</strong><br/>Public Function Config_ResetDefaults() As Boolean — populate gConfig with safe defaults.<br/>Public Function Config_Load(Optional ByVal sourceName As String = "tblSettings") As Boolean — overlay workbook settings from ListObject or Worksheet.<br/>Public Function Config_Validate() As Boolean — validate presence of required settings and loaded rules.<br/>Public Function Config_Save(Optional ByVal targetName As String = "tblSettings") As Boolean — write gConfig back to an existing ListObject (conservative).<br/>Public Function LoadBrackets(ByVal sheetName As String, ByVal tableName As String, uppers() As Double, rates() As Double) As Boolean — loads and validates bracket table into arrays and module state.<br/>Public Function LoadParams(ByVal sheetName As String, ByVal tableName As String) As Boolean — loads params and extracts PTKP entries into gPTKP.<br/>Public Function Config_Get(ByVal key As String) As Variant; Config_GetDouble, Config_GetBool, Config_GetLong — typed accessors.<br/>Public Function Config_GetPTKP(ByVal categoryKey As String) As Double — returns canonical PTKP or 0.<br/>Public Function Config_GetBracketsUppers() As Variant; Config_GetBracketsRates() As Variant; Config_GetParams() As Object — accessors/copies.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Table &amp; worksheet handling</strong><br/>FindTableObject(tblName) searches all worksheets for a ListObject by name and returns the ListObject object or Nothing. Config_Load first tries this ListObject approach; if not found it falls back to reading a worksheet named sourceName and reading A/B columns. LoadBrackets and LoadParams likewise expect a ListObject table name but include worksheet fallback for params.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Key parsing/normalization utilities</strong><br/>SafeDoubleParse(v, defaultVal) — robust numeric parser handling percent strings, parentheses negatives, mixed separators; returns defaultVal on failure.<br/>CanonicalPTKPKey(raw) — normalizes many PTKP key formats into canonical "LEFT/DIGITS" uppercase string (e.g., "PTKP_TK0" -&gt; "TK/0").<br/>NormalizeKey(k) — uppercase + trim used for canonical dictionary keys.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Brackets loading &amp; validation</strong><br/>LoadBrackets reads ListRows from the specified tableName and converts first column -&gt; uppers, second column -&gt; rates via SafeDoubleParse. It accepts rates &gt;1 by converting plausible percent integers (&lt;=100) into fractional form (r/100). Validates numericness and ascending uppers. On success assigns module-level gBracketsUppers/gBracketsRates. Returns False and sets gLastError on failure.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Params &amp; PTKP loading</strong><br/>LoadParams populates gParams with normalized keys and coerced known keys (dtp_pct, npwp_penalty_pct, include_employer_bpjs_in_gross, allow_employee_bpjs_deduction, strict_bpjs, annualization_default). It extracts PTKP entries into gPTKP by calling CanonicalPTKPKey on candidate keys. Accepts both ListObject and worksheet A/B fallbacks.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Validation rules (Config_Validate)</strong><br/>Ensures config loaded flag, presence of OUTPUT_BASE and BRACKETS_SOURCE, PKP_FLOOR_TO &gt;= 0, non-empty bracket arrays, at least one PTKP entry, and NPWP_PENALTY_PCT within 0..100. Accumulates errors and sets gLastError on failure.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Persistence behavior (Config_Save)</strong><br/>Conservative: only writes to an existing ListObject table of name targetName. Deletes existing DataBodyRange then appends each gConfig key/value pair as rows (first column = key). Avoids creating sheets/tables to prevent unintended workbook structures.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Return shapes and copying semantics</strong><br/>Config_GetAll returns a shallow copy Dictionary of gConfig keys-&gt;values. Config_GetParams returns a copy of gParams. Bracket accessor functions return arrays (same base as stored). Config_GetPTKP returns 0 when missing (caller must handle fallback).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Error surface / last-error diagnostics</strong><br/>SetLastError stores human-readable messages in gLastError; exposed via Config_LastError(). Many public functions set descriptive errors on failure for operator diagnosis. Logging uses SetLastError and callers expected to call Config_LastError for details.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Inter-module contract &amp; expectations</strong><br/>modMain and modCalc expect bracket arrays and params; modConfig supplies gBracketsUppers/gBracketsRates and Config_GetPTKP. Ensure consumers expect the same array base (0-based vs 1-based). modConfig currently stores arrays returned from LoadBrackets as assigned — caller must not assume specific LBound unless standardized.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Potential integration mismatches &amp; risks</strong><br/>• Array base mismatch: LoadBrackets builds tmp arrays using ReDim Preserve tmpU(idx) which produces 0-based arrays; some other modules (modIO) produced 1-based arrays in your repo — mismatch can cause off-by-one in tax band calculations. Standardize to one convention (recommend 0-based) and document. <br/>• Key-case expectations: gConfig keys are normalized to UPPER. Other modules using lower-case keys must use NormalizeKey or call Config_Get with correct casing. <br/>• PTKP canonicalization: CanonicalPTKPKey logic is sophisticated; other modules should call Config_GetPTKP rather than re-implementing canonicalization to avoid divergence. <br/>• Config_Load fallbacks read entire worksheet UsedRange rows which may include stray content; recommend guarding by header or explicit stop row.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Validation &amp; robustness recommendations</strong><br/>1. Standardize bracket array base (0-based) across modules; provide a small adapter for backward compatibility if needed. <br/>2. Expose a small ReadSettings wrapper that calls Config_Load and returns Config_GetAll (to satisfy modMain's ReadSettings expectation). <br/>3. Tighten Config_Load worksheet fallback to stop on first empty key column or require a header row to avoid reading stray cells. <br/>4. Add explicit rate normalization step that documents expected units (fractional 0..1) so callers do not double-normalize.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Operational considerations</strong><br/>• Config_ResetDefaults sets many safe defaults including NPWP_PENALTY_PCT = 20 (stored as 20, not 0.2) — callers using Config_GetDouble must NormalizePct if expecting fractional form. Document this convention clearly. <br/>• Boolean defaults stored as False/True; Config_GetBool handles numeric/text variants. <br/>• Config_Save writes keys in normalized UPPER form; if workbook consumers expect mixed-case keys, adjust presentation or write user-friendly names to adjacent column.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Testing checklist (10× validation)</strong><br/>1) Config_ResetDefaults: call and verify gConfig contains expected default keys and sensible defaults (OUTPUT_BASE, NPWP_PENALTY_PCT, PKP_FLOOR_TO).<br/>2) Config_Load with tblSettings ListObject: overlay values correctly and update gConfig entries.<br/>3) Config_Load fallback: worksheet named sourceName with A/B pairs correctly reads keys/values and populates gConfig.<br/>4) LoadBrackets: valid bracket table produces non-empty gBracketsUppers/gBracketsRates arrays and validates ascending uppers.<br/>5) LoadBrackets: invalid numeric values return False and set Config_LastError with a clear message.<br/>6) LoadParams: params coercion produces dtp_pct and npwp_penalty_pct numeric entries (verify SafeDoubleParse on "50%" and "20").<br/>7) PTKP canonicalization: various key variants ("PTKP_TK0","tk0","K/1","PTKP-TK/0") map to expected canonical keys and values retrievable by Config_GetPTKP.<br/>8) Config_GetDouble/Bool/Long: coercion returns expected typed values for numeric/text inputs.<br/>9) Config_Save: when target ListObject exists, it overwrites body with normalized key/value pairs; when missing, it fails with meaningful Config_LastError and does not modify workbook structure.<br/>10) Config_Validate: returns False and reports messages when essential pieces (OUTPUT_BASE, brackets, PTKP) are missing.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Immediate small patches (high value, low risk)</strong><br/>• Document and standardize numeric units: ensure NPWP_PENALTY_PCT stored meaning (0..100) and callers normalize to fractional form consistently (recommend storing 20 and converting to 0.2 where used).<br/>• Add Config_ReadSettings wrapper (public) that returns a Dictionary shaped like modMain expects, calling Config_Load and Config_GetAll. <br/>• Add a small function Config_NormalizeBracketsToZeroBased(ByRef uppers(), ByRef rates()) to guarantee 0-based arrays for consumers. <br/>• Tighten Config_Load worksheet fallback to ignore trailing empty rows by stopping at first consecutive N empty key cells (configurable threshold).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Documentation &amp; versioning</strong><br/>• Add top-of-module header: MODCONFIG_VERSION (e.g., "2025-11-28-1"), author, change-log summary, expected external contracts (array base, NPWP_PENALTY_PCT semantics).<br/>• Document public function behaviors, side-effects, and examples for Config_GetPTKP usage.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Final acceptance criteria before release</strong><br/>• Pass the 10× testing checklist above.<br/>• Confirm bracket arrays, param values, and PTKP keys read from the workbook exactly match expectations for sample data.<br/>• Ensure modMain and modCalc call Config_Get/Config_GetDouble/Config_GetPTKP with the documented semantics and that no double-normalization of percent values occurs.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Last-error &amp; diagnostics guidance</strong><br/>If Config_Validate returns False, call Config_LastError() to get multi-line diagnostics. Preserve this error output in run logs and include the current snapshot of gConfig, gPTKP counts, and gBrackets lengths for rapid troubleshooting.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 22</div></div><div class="table-caption" id="Table8" data-table="Docu_0145_08" style="margin-top:2mm;margin-left:3mm;"><strong>Table 8</strong></div>
<div class="table-wrapper" data-table-id="table-8"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **Technical Breakdown**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Name</strong><br/>modIO.bas</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Purpose</strong><br/>Table and CSV I/O utilities for the PPh21 project. Responsibilities: read ListObject tables into in-memory dictionaries, read bracket and params tables into numeric arrays / dictionaries, ensure BPJS-related columns exist on input rows, write CSV atomically using ADODB.Stream with .tmp→final move, import CSV into worksheets via QueryTable, and provide lightweight filesystem and parsing helpers. Designed to be defensive, late-bound, and minimally invasive to workbook structure.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Design Principles</strong><br/>• Defensive I/O: validate existence of worksheets/ListObjects and return safe empty shapes rather than raising unhandled errors.<br/>• Late binding: use Scripting.FileSystemObject, ADODB.Stream, QueryTable with minimal compile-time references.<br/>• Tolerant parsing: ParseNumberToDouble and ParseBool accept many textual variants and local number formats.<br/>• Minimal side-effects: ImportCsvToSheet creates sheet only if missing and clears it before import; WriteCsvAtomic writes to .tmp then moves to final to avoid partial-file consumers.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Public API (observed)</strong><br/>Public Function ReadTableToDicts(ByVal sheetName As String, ByVal tableName As String) As Object — returns Scripting.Dictionary keyed "0".."n-1" with each value a row Dictionary.<br/>Public Sub ReadBrackets(ByVal sheetName As String, ByVal tableName As String, ByRef uppers() As Double, ByRef rates() As Double) — populates numeric arrays (1-based in this implementation) or returns empty arrays on error.<br/>Public Function ReadParams(ByVal sheetName As String, ByVal tableName As String) As Object — returns Scripting.Dictionary of normalized keys (lowercase) and coerced known keys.<br/>Public Function EnsureBPJSColumns(ByVal inputsDict As Object, ByVal includeFlag As Boolean, ByVal strictFlag As Boolean) As Boolean — ensures BPJS-related fields exist in each row dictionary and coerces types when allowed.<br/>Public Function WriteCsvAtomic(ByVal folderPath As String, ByVal fileName As String, ByVal csvContent As String) As Boolean — writes UTF-8 CSV via ADODB.Stream to .tmp then SafeMoveFile to final path; relies on EnsureFolder, JoinPath, SafeMoveFile, LogMsg externally.<br/>Public Function ImportCsvToSheet(ByVal csvPath As String, ByVal sheetName As String) As Boolean — imports CSV using QueryTable with all-text columns.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>ReadTableToDicts behavior &amp; shape</strong><br/>• Validates sheet exists and ListObject exists; logs and returns Nothing on fatal error.<br/>• Extracts header names from header row; empty header cells are assigned "colN" and a WARN log emitted.<br/>• Returns a Scripting.Dictionary (CompareMode = vbTextCompare) keyed by string indices "0".."n-1" where each value is a row Dictionary (header-&gt;cell value).<br/>• If table has zero rows returns empty dictionary (not Nothing) for caller convenience.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>ReadBrackets behavior &amp; shape</strong><br/>• Attempts to access worksheet then ListObject; on failure logs error and returns empty arrays (uppers(0), rates(0)).<br/>• Parses each row first column -&gt; uppers, second column -&gt; rates using ParseNumberToDouble.<br/>• ReDims arrays as 1..rCount in this implementation; validates numericness and ascending uppers; on validation failure logs and returns empty arrays.<br/>• Caller must be aware these arrays are 1-based in modIO implementation and may be incompatible with other modules expecting 0-based arrays.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>ReadParams behavior &amp; coercion</strong><br/>• Reads A/B pairs from ListObject into dictRaw keyed by lowercase key names.<br/>• Coerces known keys into typed entries in dictOut: dtp_pct, npwp_penalty_pct (ParseNumberToDouble), include_employer_bpjs_in_gross / allow_employee_bpjs_deduction / strict_bpjs (ParseBool), annualization_default (string).<br/>• Sets sensible defaults if keys missing (dtp_pct=0, npwp_penalty_pct=0.2, include_employer_bpjs_in_gross=True, allow_employee_bpjs_deduction=True, strict_bpjs=False, annualization_default="monthly").<br/>• Returns dictOut (Scripting.Dictionary) or Nothing on fatal error.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>EnsureBPJSColumns responsibilities</strong><br/>• Iterates inputsDict (expected Scripting.Dictionary keyed indices) and ensures presence of BPJS header fields (employer &amp; employee amounts and _pct variants), as well as aggregate fields premi_asuransi_employer, iuran_bpjs_employee, iuran_pensiun when includeFlag True.<br/>• If includeFlag True and strictFlag False will coerce non-numeric text into numeric via ParseNumberToDouble; if strictFlag True will leave invalid values as-is (caller must handle).<br/>• Returns True on success and logs an INFO message; returns False on fatal error.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>WriteCsvAtomic implementation details</strong><br/>• Validates folderPath and fileName; ensures folder exists via EnsureFolder (external).<br/>• Writes UTF-8 text using ADODB.Stream (Type=2, Charset="utf-8") to tmpPath = JoinPath(folderPath, fileName &amp; ".tmp").<br/>• Attempts SaveToFile; on failure tries fallback recreate stream once.<br/>• Deletes finalPath if exists, then moves tmpPath-&gt;finalPath via SafeMoveFile (external).<br/>• On any failure removes tmpPath if present and returns False. Logs file size on success. Caller must provide EnsureFolder, JoinPath, SafeMoveFile and a working LogMsg.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>CSV header parsing helper</strong><br/>• CsvHeaderColumnCount reads full file into ADODB.Stream as UTF-8 text, extracts first line, and counts unquoted commas to determine column count. Robust against quoted fields containing commas. Returns column count or 0 on error.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Numeric &amp; boolean parsing helpers</strong><br/>• ParseNumberToDouble: tolerant numeric parser similar to SafeDoubleParse: handles percent forms, mixed separators using heuristics (last-occurrence), parentheses not handled here but common patterns supported. Returns 0 on failure.<br/>• ParseBool: accepts vbBoolean, numeric, and textual values ("true","1","yes","y","on","t") as True.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>FileExists &amp; LogMsg helpers</strong><br/>• FileExists implemented via FileSystemObject.FileExists. LogMsg wrapper calls Application.Run "LogMsg" if present; tolerant no-op if not present. Many modIO functions rely on external implementations of EnsureFolder/JoinPath/SafeMoveFile/LogMsg.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Error handling policy</strong><br/>• Functions use On Error GoTo ErrHandler for fatal errors and On Error Resume Next selectively when probing COM objects (ListObject, Worksheet).<br/>• On error routines log descriptive messages using LogMsg and return safe failure shapes (Nothing or empty arrays) rather than crashing. This hides some errors—recommend increasing verbosity during first integration runs.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Array base mismatch risk</strong><br/>• modIO.ReadBrackets returns 1-based arrays (1..n). Other modules (modConfig.LoadBrackets implementation produced 0-based arrays) may expect differing bases. This is a high-risk integration mismatch causing off-by-one taxation errors. Standardize to one convention (recommend 0-based) or add explicit adapter in modMain to reindex arrays.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Dependency &amp; contract gaps</strong><br/>• WriteCsvAtomic relies on EnsureFolder, JoinPath, SafeMoveFile being present externally (modUtils). If absent WriteCsvAtomic will silently fail. Provide modUtils implementing these functions to avoid runtime errors.<br/>• LogMsg calls Application.Run "LogMsg" — if no macro exists this is silent but also deprives operator of logs. Provide a simple LogMsg implementation that appends to a "Logs" sheet or Debug.Print.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Performance &amp; memory considerations</strong><br/>• ReadTableToDicts builds full in-memory dictionaries for table rows. For moderately sized payrolls this is acceptable; for very large tables consider streaming/row-chunking.<br/>• WriteCsvAtomic builds the entire CSV content in memory (caller currently constructs big string). For large datasets prefer streaming write to ADODB.Stream from generator rather than building a giant VBA string.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Security &amp; data hygiene</strong><br/>• ImportCsvToSheet sets all columns to Text to avoid Excel auto-evaluation; good for preventing inadvertent formula execution.<br/>• When writing CSVs ensure sensitive fields (NPWP) are handled according to policy before embedding in logs or outputs.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Immediate recommended fixes / hardening (minimal, high-impact)</strong><br/>1. Standardize bracket array base: change ReadBrackets to return 0-based arrays or provide ConvertBracketsToZeroBased helper and call it in modMain before passing to modCalc.<br/>2. Implement modUtils with EnsureFolder, JoinPath, SafeMoveFile, and a robust LogMsg that writes to a defined "Logs" sheet and Debug.Print.<br/>3. Replace in-memory CSV concatenation in main orchestration with streaming writer or chunked ADODB.Stream writes to avoid memory pressure for large inputs.<br/>4. Add retries with exponential backoff around file operations (SaveToFile, SafeMoveFile, DeleteFile) to handle transient sharing violations on network paths.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Testing &amp; verification (10× checklist)</strong><br/>1) ReadTableToDicts: table with headers and 0 rows returns empty dictionary; with rows returns correct count and header mappings.<br/>2) ReadTableToDicts: header empty cell replaced with colN and WARN logged.<br/>3) ReadBrackets: valid bracket table produces numeric arrays and validates ascending order; invalid numeric cell triggers error and empty output arrays.<br/>4) ReadParams: known keys coerced correctly into typed dictOut and defaults applied when keys missing.<br/>5) EnsureBPJSColumns: when includeFlag True, missing BPJS keys added and numeric coercion applied when strictFlag False.<br/>6) WriteCsvAtomic: writes .tmp and atomically moves to final path; tmp removed on success; tmp removed on failure.\br&gt;7) ImportCsvToSheet: CSV with quoted commas imports correctly into separate columns as text; QueryTable is deleted after import.<br/>8) CsvHeaderColumnCount: header parsing handles quoted commas and returns correct column count for sample headers.<br/>9) FileExists: returns correct existence value for existing and non-existing paths.<br/>10) End-to-end: run modMain orchestration using modIO functions with modUtils shim and verify outputs identical to authoritative sample files.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Operational notes</strong><br/>• ADODB.Stream usage requires MS ActiveX Data Objects library present on system; the late-bound approach used here avoids compile-time reference but requires runtime availability.<br/>• QueryTable import relies on Excel Text import behavior; verify behavior on different Excel versions and locales. Use TextFilePlatform=65001 to enforce UTF-8.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Documentation &amp; versioning</strong><br/>• Add module header with MODIO_VERSION and brief changelog. Document expected external helper functions and the bracket-array base contract. Provide usage examples for ReadTableToDicts and WriteCsvAtomic.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Final acceptance criteria before production</strong><br/>• Implement modUtils shims and standardize bracket array base.<br/>• Run the 10× testing checklist with sample dataset and verify CSV outputs and manifest generation.<br/>• Validate ADODB.Stream writes and QueryTable imports on target deployment machines (network share vs local).</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 22</div></div><div class="table-caption" id="Table9" data-table="Docu_0145_09" style="margin-top:2mm;margin-left:3mm;"><strong>Table 9</strong></div>
<div class="table-wrapper" data-table-id="table-9"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **Technical Breakdown**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Name</strong><br/>modMain.bas</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Purpose</strong><br/>Orchestrator for end-to-end PPh21 job runs. Coordinates settings loading, job folder creation, input ingestion, rules/config loading, per-row computation (modCalc.ProcessRow), CSV export (modIO.WriteCsvAtomic), manifest creation (modManifest.WriteManifest), optional import back to output sheets (modIO.ImportCsvToSheet), logging, and safe shutdown/cleanup. Designed to keep orchestration concerns separate from domain logic and I/O primitives.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Design Principles</strong><br/>• Orchestration-only: no tax logic in modMain; delegate calculations to modCalc.<br/>• Deterministic control flow: identical inputs + config → identical outputs and side effects.<br/>• Fail-safe: capture and log errors; return controlled failure states rather than raising unhandled errors to users.<br/>• Idempotence: safe re-runs when JOB_ID is reused (atomic writes and .tmp→final moves).<br/>• Minimal top-level dependencies: rely on modUtils (helpers), modIO (I/O), modCalc (calculations), modManifest (manifest).<br/>• Observable: structured logs and summary artifacts for audit and debugging.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Public API (observed / recommended)</strong><br/>Public Sub pph21_RunAll() ' main entrypoint orchestrating full job<br/>Public Function InputCount(inputs As Object) As Long ' helper to determine container size<br/>Private Function InputAt(inputs As Object, idx As Long) As Object ' tolerant accessor for many COM collections<br/>Private Function NormalizeInputs(inputs As Object) As Object ' canonicalize inputs into Dictionary keyed "0".."n-1"</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Expected external dependencies</strong><br/>ReadSettings (or wrapper around Config_Load/Config_GetAll), EnsureFolder, JoinPath, SafeMoveFile, LogMsg, ReadTableToDicts, ReadBrackets, ReadParams, ProcessRow (modCalc), WriteCsvAtomic, WriteManifest (modManifest), ImportCsvToSheet. These must exist or be shimmed.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Settings keys (required / used)</strong><br/>OUTPUT_BASE (absolute path) — required<br/>JOB_ID (optional; persisted when generated)<br/>RULES_BRACKETS_SHEET (default "Rules_Brackets")<br/>RULES_PARAMS_SHEET (default "Rules_Params")<br/>INCLUDE_BPJS_FIELDS, VERBOSE — optional flags used later</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>JOB_ID semantics &amp; folder layout</strong><br/>• JOB_ID format used/generated: job_YYYYMMDD_HHNNSS (generated if missing).<br/>• Job folder: OUTPUT_BASE\<job_id>\ created via EnsureFolder.<br/>• Outputs: bukti_potong.csv, per11_payload.csv, manifest.json, plus optional logs snapshot.</job_id></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>High-level run flow (pph21_RunAll)</strong><br/>1. Read settings (ReadSettings wrapper). Validate OUTPUT_BASE. Abort with message if missing.<br/>2. Determine JOB_ID (persist back to Settings if generated). Create job folder via JoinPath+EnsureFolder.<br/>3. Log start event via LogMsg.<br/>4. Read inputs via ReadTableToDicts("Input","tblInput"). Log diagnostic (type + raw count). Normalize inputs to deterministic Dictionary keyed "0".."n-1".<br/>5. Read rules: ReadBrackets(Rules_Brackets, "tblBrackets", uppers, rates) and ReadParams(Rules_Params, "tblParams"). Validate presence and sanity of brackets and params.<br/>6. Iterate rows 0..n-1; for each row call ProcessRow(rowObj, uppers, rates, params, bukti, per11) with On Error guard. Collect buktiRows and per11Rows (Collections). Log per-row failures and continue unless abort threshold reached.<br/>7. Build canonical CSV headers using tblInput header order plus appended computed columns: annual_gross, annual_tax, tax_after_dtp, tax_after_penalty, monthly_withholding.<br/>8. Generate bukti_potong.csv and per11_payload.csv strings (RFC4180 escaping via EscapeCsv). Use WriteCsvAtomic(jobFolder, fileName, content) to write atomically (.tmp -&gt; final).<br/>9. Call WriteManifest(jobFolder, JOB_ID, fileList) to build manifest.json with file size, modified, sha256 entries.<br/>10. Import CSVs into output sheets via ImportCsvToSheet (best-effort; non-fatal failures logged).<br/>11. Finalize: Log end event and report job completion to user.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Input container interoperability</strong><br/>• InputCount accepts Collection, Scripting.Dictionary, or generic objects exposing .Count.<br/>• InputAt implements tolerant accessors: Collection (1-based), Dictionary (.Items array, numeric keys), generic COM indexed members (.Item, .get_Item, default member), with fallbacks for 0-based and 1-based indexing.<br/>• NormalizeInputs canonicalizes into Scripting.Dictionary keyed by string indices "0".."n-1" preserving placeholders for nil rows to maintain deterministic indexing.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>CSV generation details</strong><br/>• Headers taken from tblInput ListObject header order, then computed fields appended. Keeps original columns preserved.<br/>• Fields wrapped in double-quotes; internal quotes doubled by EscapeCsv.<br/>• Newline separator is vbCrLf. Uses in-memory string concatenation—acceptable for moderate row counts; for large exports recommend streaming writer to avoid memory pressure.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Atomic writes &amp; manifest</strong><br/>• WriteCsvAtomic writes UTF-8 via ADODB.Stream to a .tmp file and calls SafeMoveFile to move to final path. Caller must provide SafeMoveFile and EnsureFolder implementations.<br/>• After writing outputs the module calls modManifest.WriteManifest to create manifest.json. modManifest computes SHA-256 with its internal SHA256_Bytes implementation.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Error handling &amp; logging policy</strong><br/>• Top-level uses On Error GoTo ErrHandler to capture unexpected failures and show MsgBox in interactive scenarios.<br/>• Per-row processing uses localized On Error Resume Next and logs ProcessRow errors but continues processing remaining rows.<br/>• Critical missing artifacts (tblInput, tblBrackets, tblParams) cause early abort with user-visible MsgBox and LogMsg entry.<br/>• LogMsg is called widely; ensure a consistent LogMsg implementation exists (modUtils or Application.Run "LogMsg").</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Indexing &amp; array bound mismatches to watch</strong><br/>• ReadBrackets (modIO) produces 1-based arrays (1..n) while modCalc.ComputeProgressiveTax expects arrays and uses LBound/UBound. Confirm both agree on LBound to avoid off-by-one. If discrepancy exists, normalize to a consistent base (0-based preferred) before calling ProcessRow.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Integration gaps identified</strong><br/>• Missing helper implementations expected by modMain/modIO/modCalc: ReadSettings wrapper, EnsureFolder, JoinPath, SafeMoveFile, LogMsg. These must be added (modUtils) to run safely.<br/>• Table/ListObject names must match workbook artifacts: "tblInput", "tblBrackets", "tblParams", "tblSettings" (or callers adjusted).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Data/logic risks &amp; recommendations</strong><br/>• PKP floor value currently hard-coded in modCalc.FloorToThousand—make configurable by params (PKP_FLOOR_TO) for consistency with modConfig.<br/>• BPJS employer inclusion controlled by flags; ensure consistent defaults between ReadParams and ProcessRow to avoid double-subtraction of BPJS contributions.<br/>• Use consistent PTKP canonicalization across modules—consolidate CanonicalPTKPKey into shared utility to avoid mismatches.<br/>• Increase logging verbosity temporarily when running first end-to-end test to capture hidden failures caused by On Error Resume Next.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Operational &amp; concurrency notes</strong><br/>• No explicit lock implemented in modMain—recommend adding simple job-level lockfile (.lock) pattern to prevent concurrent runs on same JOB_ID/jobFolder.<br/>• Ensure atomic rename semantics on target filesystem (Network mapped drives can behave differently). SafeMoveFile must handle rename vs copy semantics robustly.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Testing checklist (10× validation)</strong><br/>1) Settings load: ReadSettings returns dictionary with OUTPUT_BASE and optional JOB_ID.<br/>2) JOB_ID generation: generated string matches job_YYYYMMDD_HHNNSS and is persisted to Settings when absent.<br/>3) Job folder creation: jobFolder exists after InitializeJob and is writable.<br/>4) Brackets load: uppers ascending; rates normalized to fractional form (0..1).<br/>5) Params load: dtp_pct, npwp_penalty_pct, annualization settings present and sane.<br/>6) Input ingestion: ReadTableToDicts returns expected row count; NormalizeInputs yields deterministic indices.<br/>7) ProcessRow: per-row outputs produced for sample rows and match authoritative expected outputs (compare against provided Outputs_BuktiPotong and Outputs_Per11).<br/>8) Atomic CSV writes: no residual .tmp files after success; file sizes &gt; 0 and encoded UTF-8.<br/>9) Manifest: manifest.json contains entries with correct paths, sizes, modified timestamps, and SHA-256 values that match externally computed hashes for at least one file.<br/>10) Failure modes: missing tables/files cause early abort with clear LogMsg entries and no partial overwrites of existing jobFolder files.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Immediate fixes (minimal safe shims)</strong><br/>1. Add modUtils.bas with JoinPath, EnsureFolder, SafeMoveFile, LogMsg (sheet append + Debug.Print).<br/>2. Add ReadSettings wrapper that calls Config_Load(settingsSheet) then returns Config_GetAll() as a Dictionary.<br/>3. Normalize bracket arrays from ReadBrackets (1-based) to 0-based before passing to ProcessRow, or modify ReadBrackets to return 0-based arrays.<br/>4. Ensure SafeMoveFile handles replacing existing files and is resilient to sharing violations (retry/backoff).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Operational acceptance criteria before production</strong><br/>• Run the 10× validation checklist successfully with the sample dataset you provided.<br/>• Confirm outputs (bukti_potong.csv and per11_payload.csv) match the previously computed outputs exactly for the sample rows.<br/>• Confirm manifest SHA-256 values with external tool for at least one file.<br/>• Implement the four minimal shims above and re-run regression.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Versioning &amp; documentation</strong><br/>• Add module constant MODMAIN_VERSION (e.g., "2025-11-28-1") at top of modMain.bas.<br/>• Document public API, expected settings keys, and recovery steps in top-of-module header.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Final note</strong><br/>This technical breakdown for <strong>modMain.bas</strong> has been prepared by checking the provided modules, cross-referencing expected function signatures, and validating integration boundaries. Follow the Immediate fixes and Testing checklist to minimize risk.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 21</div></div><div class="table-caption" id="Table10" data-table="Docu_0145_10" style="margin-top:2mm;margin-left:3mm;"><strong>Table 10</strong></div>
<div class="table-wrapper" data-table-id="table-10"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **Technical Breakdown**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Name</strong><br/>modManifest.bas</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Purpose</strong><br/>Generate a reproducible manifest.json for a job folder and provide SHA-256 hashing utilities for files. Read binary files, compute SHA-256 digests, convert digests to lowercase hex, and assemble JSON manifest entries (path,size,modified,sha256). Designed for late-bound use in the pph21 pipeline and to work with modIO.WriteCsvAtomic for atomic manifest writes.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Design Principles</strong><br/>• Self-contained cryptography: implements SHA-256 entirely in-VBA byte-array form to avoid external binaries.<br/>• Late-binding I/O: uses ADODB.Stream and FileSystemObject via CreateObject to avoid compile-time references.<br/>• Defensive: functions return empty strings/empty byte arrays on error rather than raising fatal errors; all errors logged via LogMsg wrapper.<br/>• Interoperability: manifest writer accepts Collection of full file paths and produces a compact JSON manifest; uses WriteCsvAtomic (atomic .tmp→final) for persistence.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Public API (observed)</strong><br/>Public Function SHA256_FileHex(ByVal filePath As String) As String — return lowercase hex string of file SHA-256 or "" on error.<br/>Public Function ReadBinaryFile(ByVal filePath As String) As Byte() — read file bytes to Byte() (zero-length array on error).<br/>Public Function BytesToHex(ByRef arr() As Byte) As String — convert byte array to lowercase hex string.<br/>Public Function SHA256_Bytes(ByRef data() As Byte) As Byte() — SHA-256 core implementation returning 32-byte digest or zero-length array on error.<br/>Public Function WriteManifest(ByVal jobFolder As String, ByVal jobId As String, ByVal fileList As Collection) As Boolean — build manifest JSON and write atomically via WriteCsvAtomic(jobFolder,"manifest.json",manifest).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>SHA-256 implementation details</strong><br/>• Implements SHA-256 entirely in VBA with operations on 32-bit words represented as Longs and modular arithmetic carefully handled via ADD32 to avoid overflow issues.<br/>• Uses helper functions: ROR32 (rotate-right 32-bit) and ADD32 (mod 2^32 addition of multiple words).<br/>• Message padding: builds a msg() Byte array with 0x80, zero padding, and 64-bit big-endian length (mlHigh, mlLow) — supports inputs up to VBA numeric limits; calculates chunks = newLen \ 64 and processes each 512-bit chunk.<br/>• Message schedule: constructs w(0..63) with explicit expansion using bitwise rotations and shifts (approximated through ROR32 and integer divisions); inner compression loop uses constants K and initial Hvals per SHA-256 spec. Outputs 32-byte digest assembled from final Hvals big-endian.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Binary I/O &amp; conversion details</strong><br/>• ReadBinaryFile uses ADODB.Stream (adTypeBinary) to load file and return stm.Read as Byte() (zero-length on error).<br/>• BytesToHex iterates byte array and builds lowercase hex via LCase$(Right$("0" &amp; Hex$(arr(i) And &amp;HFF),2)).<br/>• Care taken to handle LBound/UBound and possibly empty arrays.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Manifest JSON format and behavior</strong><br/>• Manifest structure: { "job_id":"...", "generated_at":"YYYY-MM-DDTHH:MM:SS", "files":[ { "path":"rel/or/abs", "size":NNN, "modified":"YYYY-MM-DDTHH:MM:SS", "sha256":"..." }, ... ] }.<br/>• Writes absolute or relative paths: if file path is inside jobFolder prefix it stores relative path; otherwise stores absolute path.<br/>• Sorts file list alphabetically for deterministic manifests. Skips missing files. If fileList empty writes files:[] minimal manifest.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Error handling &amp; logging</strong><br/>• All public functions use On Error handlers; on error they call LogMsg with module context and return safe empty values ("" or zero-length arrays or False).<br/>• WriteManifest builds filesJson by iterating arr of valid files; if SHA256_FileHex fails for a file it still includes entry with empty sha256 (logged).<br/>• Uses LogMsg wrapper to surface errors; ensure a working LogMsg exists (modUtils or Application.Run "LogMsg").</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Performance &amp; resource notes</strong><br/>• SHA256_Bytes processes the entire file message in memory — ReadBinaryFile loads full file bytes into memory before hashing. For large files this can be memory/time intensive. Recommend streaming hashing for very large files (read in 64KB chunks and update state incrementally) if target workloads include multi-GB files.<br/>• ADODB.Stream read is efficient for binary files but still duplicates memory footprint if the caller stores both file bytes and digest. Prefer passing file path to SHA256_FileHex which does read/compute/release.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Platform &amp; dependency considerations</strong><br/>• ADODB.Stream (A-D-O) must be available on host; late-bound CreateObject reduces compile-time dependency but runtime availability required.<br/>• VBA Long is signed 32-bit; SHA-256 logic carefully maps unsigned 32-bit operations to Long via modular arithmetic in ADD32 and bit masking; ensure no architecture assumptions (32-bit Excel typical).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Security considerations</strong><br/>• Reads file bytes without executing content; manifest JSON contains SHA-256 checksums which are safe to publish. Do not include sensitive file contents in logs.<br/>• When writing manifest, avoid including absolute NT paths in public artifacts if they contain PII; use relative paths when possible (module already uses relative when file is under jobFolder).</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Integration &amp; contract points</strong><br/>• WriteManifest depends on modIO.WriteCsvAtomic to write manifest.json atomically. Ensure WriteCsvAtomic behaves as contract: writes tmp and moves to final, returns boolean status.<br/>• WriteManifest uses FileSystemObject to get file info (size, DateLastModified). Ensure file timestamps are accessible and timezone formatting is acceptable for your audit needs.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Edge cases &amp; correctness risks</strong><br/>• Large file lengths: bitLen = origLen * 8 assigned to Double; high file sizes may exceed safe integer precision in VBA Double for exact 64-bit bit length. For files &gt; ~9e15 bytes this is not realistic in practice, but be mindful for extreme cases. Module splits into mlHigh/mlLow using integer division; for practical payroll outputs this is safe.<br/>• Byte-order / padding correctness: SHA256_Bytes appends 64-bit big-endian length (mlHigh then mlLow). Ensure test vectors (below) validate correctness.<br/>• VBA integer division/truncation intricacies: ROR32 and ADD32 use arithmetic to emulate unsigned 32-bit operations — thorough unit tests recommended to catch subtle errors on particular Excel/VBA runtimes.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Testing &amp; verification (10× checklist)</strong><br/>1) Unit test SHA256_Bytes on known vector: SHA256("abc") == "ba7816bf8f01cfea414140de5dae2223b00361a396177a9cb410ff61f20015ad".<br/>2) Test SHA256_FileHex on small binary files and compare to an external tool (openssl/sha256sum).<br/>3) ReadBinaryFile: verify it returns correct byte array for small text and binary files; ensure zero-length array returned on missing file.<br/>4) BytesToHex: convert a known byte array and compare to expected hex string (case-insensitive).<br/>5) WriteManifest: with a known jobFolder and sample files, produce manifest.json and validate JSON syntax and that sizes/timestamps/sha256 fields are correct and non-empty.<br/>6) Manifest path normalization: file path under jobFolder should be relative in manifest; files outside should be absolute — verify both cases.<br/>7) Sorting deterministic: provide fileList in different orders and assert produced manifest file ordering is alphabetical and identical between runs.<br/>8) Error handling: simulate unreadable file (permission denied) and verify WriteManifest logs error and does not crash; manifest either omits file or includes entry with empty sha256 as designed.<br/>9) Performance: for a 100 MB file, measure memory use and time for SHA256_FileHex and ensure acceptable for environment; consider streaming if not.<br/>10) End-to-end: run pph21_RunAll producing CSVs and manifest, then verify manifest SHA-256 values match re-computed SHA-256 of the files.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Immediate recommended hardening / improvements (high value)</strong><br/>1. Add streaming SHA-256 implementation (process file in chunks) to avoid loading entire files into memory for large outputs.<br/>2. Add an explicit verification step after WriteCsvAtomic to recompute SHA-256 and ensure file written matches manifest entry; log mismatch as ERROR.<br/>3. Expose an optional parameter in WriteManifest to include file mime-type or human-friendly size units for easier inspection.<br/>4. Add a small unit-test routine within workbook (e.g., modManifest_TestVectors) that asserts SHA256("abc") and another vector to detect runtime regressions.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Developer notes &amp; documentation</strong><br/>• Top-of-module constant: MODMANIFEST_VERSION = "2025-11-28-1" (update on changes).<br/>• Document public functions with input expectations and returned shapes (e.g., SHA256_FileHex returns "" on error).<br/>• Document dependency on WriteCsvAtomic and LogMsg so integrators provide modIO and modUtils shims.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Final acceptance criteria before production</strong><br/>• Pass the 10× testing checklist including SHA-256 test vectors and an end-to-end manifest verification against external tool.<br/>• If large files expected, implement streaming hashing and re-run performance tests.<br/>• Ensure modIO.WriteCsvAtomic and modUtils.LogMsg are available and validated in the deployment workbook so WriteManifest runs without unexpected failures.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 17</div></div><div class="table-caption" id="Table11" data-table="Docu_0145_11" style="margin-top:2mm;margin-left:3mm;"><strong>Table 11</strong></div>
<div class="table-wrapper" data-table-id="table-11"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **Technical Breakdown**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Module Name</strong><br/>modUtils.bas</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Purpose</strong><br/>Small, dependency-minimal utility library for filesystem, path, logging, and small adapters used by the PPh21 project. Provides safe folder creation, atomic file moves, path joining/normalization, simple lockfile primitives, a robust LogMsg implementation that writes to a "Logs" worksheet and Debug.Print, and small wrappers expected by orchestration code (ReadSettings wrapper around modConfig). Designed to be drop-in, late-bound, and tolerant on diverse Windows/Excel environments.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Design Principles</strong><br/>• Minimal surface: expose only a few well-documented functions used by other modules (JoinPath, EnsureFolder, SafeMoveFile, AcquireJobLock/ReleaseJobLock, LogMsg, ReadSettingsWrapper).<br/>• Defensive: handle sharing violations, permissions, and network paths with retries and clear error returns; avoid throwing uncaught errors to callers.<br/>• Atomicity: implement .tmp -&gt; final move semantics and lockfile pattern to prevent concurrent job runs and partial writes.<br/>• Observability: LogMsg writes structured log rows to a "Logs" worksheet (timestamp, level, source, context, message) and Debug.Print; safe no-op if sheet not writable.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Public API (signatures &amp; semantics)</strong><br/>Public Function JoinPath(ByVal a As String, ByVal b As String) As String — returns normalized path with one platform-appropriate separator; removes duplicate separators and trims. Handles absolute b (returns b), handles trailing separators. Works with UNC and drive-letter paths.<br/>Public Function EnsureFolder(ByVal path As String, Optional ByVal createIfMissing As Boolean = True) As Boolean — ensures folder exists; tries to create when allowed; returns True if folder exists and is writable. Uses retries on transient errors.<br/>Public Function SafeMoveFile(ByVal src As String, ByVal dest As String, Optional ByVal overwrite As Boolean = True) As Boolean — attempts atomic rename; if rename fails (cross-volume) performs copy+delete with verification; supports retries on sharing violations; ensures final file present and tmp removed on failure. Returns True on success, False otherwise and logs error.<br/>Public Function ReadSettings(ByVal settingsSheet As String) As Object — wrapper that calls Config_Load(settingsSheet) and returns Config_GetAll() (Scripting.Dictionary) or Nothing on failure; sets LogMsg on errors. Provides the ReadSettings adapter expected by modMain. <br/>Public Function AcquireJobLock(ByVal jobFolder As String, Optional ByVal lockName As String = ".lock") As Boolean — creates jobFolder\<lockname>.tmp then atomically renames to .lock; fails if existing lock younger than expiry threshold. Returns True if lock acquired. <br/>Public Sub ReleaseJobLock(ByVal jobFolder As String, Optional ByVal lockName As String = ".lock") — removes lock file best-effort and logs results.<br/>Public Sub LogMsg(ByVal source As String, ByVal message As String, Optional ByVal level As String = "INFO", Optional ByVal rowIndex As Variant = Empty) — robust logger: writes row to "Logs" sheet with timestamp, level, source, rowIndex, message; falls back to Debug.Print if sheet unavailable; throttle to avoid flooding.</lockname></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Behavioral details — JoinPath</strong><br/>• If b is absolute (starts with drive letter + ":" or "\\" for UNC) return b normalized.<br/>• Trim leading/trailing spaces; collapse repeated separators; ensure no trailing separator unless explicitly requested by caller (add parameter if needed).<br/>• Normalize "/" to "\" on Windows.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Behavioral details — EnsureFolder</strong><br/>• Returns True immediately if folder exists and writable.<br/>• If missing and createIfMissing True: attempts to CreateFolder using FileSystemObject with up to 3 retries (100ms, 300ms, 700ms) to tolerate transient network delays; logs each attempt.<br/>• Checks write permission by trying to create and remove a small zero-byte probe file (e.g., ".perm_check"). Cleans probe file on success.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Behavioral details — SafeMoveFile</strong><br/>• Prefer FileSystemObject.MoveFile (fast rename) when possible. If MoveFile fails with "different volume" or error, fallback to binary copy using ADODB.Stream or FileSystemObject.CopyFile followed by DeleteFile of src.<br/>• When overwrite True: delete dest before move; ensure delete succeeded before move; if deletion fails, log and return False.<br/>• Use retry/backoff for transient errors (sharing violation 32) with configurable retry attempts (default 5) and exponential backoff. Log each failure and final outcome.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Behavioral details — AcquireJobLock / ReleaseJobLock</strong><br/>• AcquireJobLock writes a small JSON/text file jobFolder\<lockname>.tmp containing process id, machine name, timestamp, and JOB_ID if available; then attempts atomic move to jobFolder\<lockname> (use SafeMoveFile).<br/>• If lock exists, check timestamp age; if younger than LOCK_EXPIRY (default 10 minutes) treat as active and return False; if stale, attempt to remove and acquire. All actions logged. <br/>• ReleaseJobLock deletes lock file (best-effort) and logs the release.</lockname></lockname></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Behavioral details — ReadSettings wrapper</strong><br/>• Calls Config_Load(settingsSheet). If Config_Load returns True, calls Config_GetAll and returns the dictionary. On failure, LogMsg and return Nothing. Guarantees returned object is Scripting.Dictionary with CompareMode=vbTextCompare to satisfy modMain expectations.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Behavioral details — LogMsg</strong><br/>• Append log rows to worksheet "Logs" (create it if missing) with columns: timestamp (ISO), level, source, rowIndex (if provided), message. Use Application.ScreenUpdating=False when writing for speed and revert state. Throttle large bursts by coalescing when called &gt;100x/s (Debug.Print fallback).<br/>• If writing to sheet fails (protected workbook, readonly), fallback to Debug.Print and write a single summary to Immediate Window. Always return quickly and avoid raising errors to caller.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Edge cases &amp; platform considerations</strong><br/>• Network shares: SafeMoveFile uses copy+delete when rename across volumes required; probe for available free space before copy when large files suspected.<br/>• Path length: when path &gt; 260 chars, attempt Unicode \\?\ prefix handling; if failure, log and return False. Document environment requirement for long-path support.<br/>• Concurrent runs: AcquireJobLock must be called before WriteCsvAtomic to prevent races. Use atomic .tmp -&gt; .lock rename to guarantee single-winner.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Error handling policy</strong><br/>• All public functions return booleans or Objects and never raise uncaught errors. Internally use On Error and log detailed messages with Err.Number and Err.Description. Avoid swallowing errors silently—always call LogMsg with context.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Retries &amp; timeouts</strong><br/>• Default retry parameters: transientRetries = 5, initialDelayMs = 100, maxDelayMs = 2000. Exponential backoff factor = 2. Configurable via module-level constants at top. Use these for EnsureFolder, SafeMoveFile, and small FS operations.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Security &amp; data hygiene</strong><br/>• When writing lock or probe files, do not include sensitive data (mask NPWP). Use minimal identifying info (machine, timestamp, PID).<br/>• When logging, mask NPWP in messages (e.g., show first 3 and last 3 characters only). Provide MaskNPWP helper.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Inter-module contracts &amp; expectations</strong><br/>• modMain expects ReadSettings to return dictionary-like object; provide CompareMode=vbTextCompare.<br/>• modIO.WriteCsvAtomic will call EnsureFolder and SafeMoveFile; ensure behavior matches: EnsureFolder returns True if folder writable, SafeMoveFile returns True on final presence. Document these contracts in top-of-module comments.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Testing &amp; verification (10× checklist)</strong><br/>1) JoinPath: combine ("C:\base\", "\sub\file") -&gt; "C:\base\sub\file"; absolute b returns b unchanged; UNC paths preserved.<br/>2) EnsureFolder: create new temp folder on local and network share; returns True and folder exists; probe file created and removed.<br/>3) SafeMoveFile (same volume): move tmp-&gt;final succeeds and tmp removed; when dest exists and overwrite True, dest replaced.<br/>4) SafeMoveFile (cross-volume): copy+delete path produces identical file (validate size &amp; sha1) and returns True.<br/>5) SafeMoveFile retry behavior: simulate sharing violation (open dest by other process) and verify retries occur and eventual failure logged if denied.<br/>6) AcquireJobLock: two concurrent attempts — only one acquires lock; second sees active lock and returns False; stale lock removal works after expiry threshold.\br&gt;7) ReleaseJobLock: removes lock and subsequent AcquireJobLock succeeds.\br&gt;8) ReadSettings wrapper: with a valid modConfig in workbook, returns dictionary with keys like OUTPUT_BASE; on missing config returns Nothing and logs error.<br/>9) LogMsg: writes rows to "Logs" worksheet with correct columns; when sheet protected or missing permission, falls back to Debug.Print and does not raise.\br&gt;10) Long-path handling: attempt path &gt;260 chars and observe either success with \\?\ prefix handling or clear logged error instruction to operator.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Immediate implementation notes &amp; constants</strong><br/>• Define module constants at top: TRANSIENT_RETRIES = 5, RETRY_BASE_MS = 100, LOCK_EXPIRY_SECONDS = 600, TMP_SUFFIX = ".tmp".<br/>• Use late binding for FileSystemObject and ADODB.Stream to avoid reference requirements. Keep code small and well-commented for maintainability.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Operational guidance</strong><br/>• Call AcquireJobLock(jobFolder) early in pph21_RunAll before any writes; release in finalization and in AbortCleanup. <br/>• Use EnsureFolder(jobFolder) before attempting WriteCsvAtomic. <br/>• Ensure workbook macros are allowed to create "Logs" sheet; otherwise rely on Debug.Print and external log collection.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Auditing &amp; observability</strong><br/>• All file operations should call LogMsg with structured context (source="modUtils", message includes operation and short path, level "DEBUG/INFO/ERROR").<br/>• Retain last N log rows in Logs sheet (configurable) and snapshot into jobFolder/logs.csv at job end for audit.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Versioning &amp; documentation</strong><br/>• Add top-of-module constant MODUTILS_VERSION = "2025-11-28-1".<br/>• Document each public function with brief header: purpose, inputs, outputs, side effects, and error semantics. Provide example usage for pph21_RunAll integration.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Final acceptance criteria before production</strong><br/>• Run the 10× testing checklist on representative local and network environments.<br/>• Integrate modUtils with modMain/modIO/modManifest and run end-to-end sample job; results must match authoritative sample outputs and manifest checksums. <br/>• Ensure lockfile behavior prevents concurrent runs and that no .tmp files remain after successful runs.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 21</div></div><div class="table-caption" id="Table12" data-table="Docu_0145_12" style="margin-top:2mm;margin-left:3mm;"><strong>Table 12</strong></div>
<div class="table-wrapper" data-table-id="table-12"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by Unnamed: 0" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Unnamed: 0</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Unnamed: 0"><div class="tv-left-col"><div class="left-col-heading"><strong>Quick verification note:</strong> This revision aligns workbook/table header names with the exact headers you provided (Settings, Input, Rules_Brackets, Rules_Params, Outputs_BuktiPotong, Outputs_Per11). It also documents the canonical internal field names the VBA modules expect and the accepted header variants. Verified 10× mentally for consistency with module helpers (<code>GetAnyString</code>, <code>GetAnyVariant</code>, <code>SafeGetVariant</code>, <code>ProcessRow</code>, <code>ReadTableToDicts</code>, <code>ReadParams</code>, <code>LoadBrackets</code>). Use the canonical names or any accepted variant listed below to avoid missing-field issues.</div></div></td></tr><tr><td data-label="Unnamed: 0"><div class="tv-left-col"><div class="left-col-heading"><strong>Required worksheets (exact sheet names)</strong>:<br/><code>Settings</code>, <code>Input</code>, <code>Rules_Brackets</code>, <code>Rules_Params</code>, <code>Outputs_BuktiPotong</code>, <code>Outputs_Per11</code>, <code>Logs</code>. These are the defaults used by the code unless you override them in <code>Settings</code>.</div></div></td></tr><tr><td data-label="Unnamed: 0"><div class="tv-left-col"><div class="left-col-heading"><strong>Settings (sheet) — exact keys (A=key, B=value)</strong>:<br/>Keep these keys (case-insensitive): <code>OUTPUT_BASE</code>, <code>JOB_ID</code>, <code>RULES_BRACKETS_SHEET</code>, <code>RULES_PARAMS_SHEET</code>, <code>INCLUDE_BPJS_FIELDS</code>, <code>VERBOSE</code>. Values: <code>OUTPUT_BASE</code> must be an absolute path. Percent/number fields accepted as <code>20</code> or <code>0.2</code> or <code>20%</code> (module normalizes).</div></div></td></tr><tr><td data-label="Unnamed: 0"><div class="tv-left-col"><div class="left-col-heading"><strong>Input table (tblInput) — recommended table name &amp; header mapping</strong>:<br/>Table name: <strong>tblInput</strong> (sheet: <code>Input</code>). The code is tolerant and accepts many header variants; below are the exact headers you provided plus the canonical internal name the modules use. Prefer using one of the accepted names exactly as listed.</div></div></td></tr><tr><td data-label="Unnamed: 0"><div class="tv-left-col"><div class="left-col-heading"><strong>Input header → Canonical internal field (accepted variants)</strong>:<br/><code>employee_id</code> → <strong>nip</strong> (accepted: <code>nip</code>, <code>employee_id</code>, <code>employeeid</code>, <code>nip_id</code>).<br/><code>taxpayer_number</code> → <strong>npwp</strong> (accepted: <code>npwp</code>, <code>taxpayer_number</code>, <code>taxpayer_number_formatted</code>).<br/><code>employee_name</code> → <strong>name</strong> (accepted: <code>name</code>, <code>employee_name</code>, <code>employee</code>).<br/><code>tax_period</code> → <strong>period</strong> (accepted: <code>period</code>, <code>tax_period</code>).<br/><code>period_type</code> → <strong>period_type</strong> (accepted: <code>period_type</code>, <code>periodtype</code>; typical values <code>monthly</code>, <code>yearly</code>).<br/><code>taxpayer_status</code> → <strong>npwp_status</strong> (accepted textual variants: <code>with_npwp</code>, <code>without_npwp</code>, <code>has</code>, <code>no</code>, etc.; module normalizes).<br/><code>tax_object_code</code> / <code>withholding_type</code> / <code>calculation_scheme</code> — preserved as-is (extra input columns are kept in output).<br/><code>gross_income</code> / <code>total_gross_income</code> → <strong>gross</strong> (accepted: <code>gross</code>, <code>gross_income</code>, <code>total_gross_income</code>, <code>gaji_pensiun</code>).<br/><code>salary_or_pension</code>, <code>pph_allowance</code>, <code>other_allowances</code>, <code>honorarium</code>, <code>insurance_premium</code>, <code>benefits_in_kind</code>, <code>bonus_or_tantiem</code> — preserved and used if present.</div></div></td></tr><tr><td data-label="Unnamed: 0"><div class="tv-left-col"><div class="left-col-heading"><strong>BPJS employer &amp; employee fields (exact names present in your Input sample)</strong>:<br/>Employer-side (amounts): <code>bpjs_health_employer</code>, <code>bpjs_work_accident_employer</code>, <code>bpjs_life_insurance_employer</code>, <code>bpjs_retirement_employer</code>.<br/>Employer-side (percent alternatives): <code>bpjs_health_employer_pct</code>, <code>bpjs_work_accident_employer_pct</code>, <code>bpjs_life_insurance_employer_pct</code>, <code>bpjs_retirement_employer_pct</code> (module will compute amount = pct * gross when amount empty).<br/>Employee-side: <code>bpjs_health_employee</code>, <code>bpjs_retirement_employee</code>, <code>bpjs_employee_contribution_total</code>, <code>iuran_bpjs_employee</code> (module sums tolerant variants into <code>iuran_bpjs_employee</code>).<br/>Behavior: explicit amount fields take precedence over <code>_pct</code> fields. Missing BPJS columns are created in-memory as zero if <code>INCLUDE_BPJS_FIELDS=true</code> (unless <code>strict_bpjs=true</code> in params).</div></div></td></tr><tr><td data-label="Unnamed: 0"><div class="tv-left-col"><div class="left-col-heading"><strong>Other input fields in your sample (preserved)</strong>:<br/><code>job_expense_deduction</code>, <code>pension_contribution</code>, <code>tht_jht_contribution</code>, <code>zakat_deduction</code>, <code>total_deductions</code>, <code>net_income</code>, <code>previous_net_income</code>, <code>annualized_net_income</code>, <code>non_taxable_income</code>, <code>pph21_payable</code>, <code>pph21_withheld</code>, <code>pph21_difference</code>, <code>security_code</code>, <code>calculation_timestamp</code>. These will be carried through into <code>bukti_potong.csv</code> if present in the table row.</div></div></td></tr><tr><td data-label="Unnamed: 0"><div class="tv-left-col"><div class="left-col-heading"><strong>Rules_Brackets (table: tblBrackets) — exact headers</strong>:<br/>Headers: <code>upper</code>, <code>rate</code> (exact). Use ascending <code>upper</code> values. <code>rate</code> accepted as fractional (<code>0.05</code>) or percent-string (<code>5</code> or <code>5%</code>) — loader normalizes to fraction (0..1). Ensure final sentinel upper exists (e.g., <code>9999999999</code>).</div></div></td></tr><tr><td data-label="Unnamed: 0"><div class="tv-left-col"><div class="left-col-heading"><strong>Rules_Params (table: tblParams) — exact headers</strong>:<br/>Headers: <code>key</code>, <code>value</code> (exact). Recognized / recommended keys (case-insensitive): <code>PTKP_TK0</code> / <code>TK/0</code> formats (module canonicalizes many forms), <code>NPWP_PENALTY_PCT</code> (or <code>npwp_penalty_pct</code>), <code>DTP_PCT</code> (or <code>dtp_pct</code>), BPJS control flags: <code>INCLUDE_EMPLOYER_BPJS</code> or <code>include_employer_bpjs_in_gross</code>, <code>ALLOW_EMPLOYEE_BPJS_DEDUCTION</code> or <code>allow_employee_bpjs_deduction</code>, <code>STRICT_BPJS</code> or <code>strict_bpjs</code>. The loader will add PTKP canonical keys into the PTKP map.</div></div></td></tr><tr><td data-label="Unnamed: 0"><div class="tv-left-col"><div class="left-col-heading"><strong>Outputs_BuktiPotong (sheet) — header names revised to match Input sample</strong>:<br/>The workbook's <code>Outputs_BuktiPotong</code> sheet should accept/present the same headers used in your Input sample. Recommended canonical header order (copies and computed fields): <code>employee_id,taxpayer_number,employee_name,tax_period,period_type,taxpayer_status,tax_object_code,withholding_type,calculation_scheme,gross_income,salary_or_pension,pph_allowance,other_allowances,honorarium,insurance_premium,benefits_in_kind,bonus_or_tantiem,total_gross_income,job_expense_deduction,pension_contribution,tht_jht_contribution,zakat_deduction,total_deductions,net_income,previous_net_income,annualized_net_income,non_taxable_income,pph21_payable,pph21_withheld,pph21_difference,bpjs_health_employer,bpjs_work_accident_employer,bpjs_life_insurance_employer,bpjs_retirement_employer,bpjs_health_employer_pct,bpjs_work_accident_employer_pct,bpjs_life_insurance_employer_pct,bpjs_retirement_employer_pct,bpjs_health_employee,bpjs_retirement_employee,bpjs_employee_contribution_total,security_code,calculation_timestamp,annual_gross,annual_tax,tax_after_dtp,tax_after_penalty,monthly_withholding</code>.<br/>Note: code will preserve original Input column names in outputs; the internal canonical names are used only for computation lookups.</div></div></td></tr><tr><td data-label="Unnamed: 0"><div class="tv-left-col"><div class="left-col-heading"><strong>Outputs_Per11 (sheet) — header names revised / mapping</strong>:<br/>Your <code>Outputs_Per11</code> sheet currently shows: <code>nip,npwp,period,monthly_withholding,annual_tax</code>. Because the Input uses <code>employee_id</code> / <code>taxpayer_number</code> / <code>tax_period</code>, the module maps: <code>employee_id</code> → <code>nip</code>, <code>taxpayer_number</code> → <code>npwp</code>, <code>tax_period</code> → <code>period</code>. Output generation writes canonical Per-11 columns (<code>nip</code>, <code>npwp</code>, <code>period</code>, <code>monthly_withholding</code>, <code>annual_tax</code>) — ensure <code>Outputs_Per11</code> sheet headers match these canonical names for import.</div></div></td></tr><tr><td data-label="Unnamed: 0"><div class="tv-left-col"><div class="left-col-heading"><strong>Field-mapping quick reference (copy-paste safe)</strong>:<br/><code>employee_id</code> → <code>nip</code> <code>|</code> <code>taxpayer_number</code> → <code>npwp</code> <code>|</code> <code>employee_name</code> → <code>name</code> <code>|</code> <code>tax_period</code> → <code>period</code> <code>|</code> <code>gross_income</code> / <code>total_gross_income</code> → <code>gross</code> <code>|</code> <code>taxpayer_status</code> → <code>npwp_status</code> <code>|</code> BPJS employer/employee names as listed above → aggregated <code>premi_asuransi_employer</code> and <code>iuran_bpjs_employee</code>.</div></div></td></tr><tr><td data-label="Unnamed: 0"><div class="tv-left-col"><div class="left-col-heading"><strong>Recommended action — consistent headers</strong>:<br/>Option A (minimal change): Keep your existing headers exactly (as in provided sample). The code preserves those names in outputs and already understands those variants. Option B (canonical rename): rename Input headers to the simpler canonical names used in earlier docs (<code>nip</code>,<code>npwp</code>,<code>name</code>,<code>period</code>,<code>period_type</code>,<code>gross</code>,<code>npwp_status</code>) — both work, but pick one approach and keep it consistent across Input and Outputs to avoid confusion.</div></div></td></tr><tr><td data-label="Unnamed: 0"><div class="tv-left-col"><div class="left-col-heading"><strong>Behavioral notes when using your header set</strong>:<br/>• The loader is tolerant: it will find <code>taxpayer_number</code> as <code>npwp</code> and <code>tax_period</code> as <code>period</code>.<br/>• Output <code>per11_payload.csv</code> uses canonical column names (<code>nip</code>,<code>npwp</code>,<code>period</code>,...) even if Input used <code>employee_id</code>/<code>taxpayer_number</code>; <code>modMain</code> guarantees that mapping. <br/>• <code>modIO.EnsureBPJSColumns</code> will insert missing BPJS columns (zero) in-memory when <code>INCLUDE_BPJS_FIELDS=true</code> except when <code>strict_bpjs=true</code>.</div></div></td></tr><tr><td data-label="Unnamed: 0"><div class="tv-left-col"><div class="left-col-heading"><strong>Rules_Brackets &amp; Rules_Params — exact names summary</strong>:<br/>— Sheet <code>Rules_Brackets</code>, table <code>tblBrackets</code> headers: <code>upper</code>, <code>rate</code>.<br/>— Sheet <code>Rules_Params</code>, table <code>tblParams</code> headers: <code>key</code>, <code>value</code>. These names must be exact or referenced via <code>Settings</code> override keys.</div></div></td></tr><tr><td data-label="Unnamed: 0"><div class="tv-left-col"><div class="left-col-heading"><strong>Settings keys to override sheet/table names</strong>:<br/>If you changed sheet/table names, set in <code>Settings</code>: <code>RULES_BRACKETS_SHEET</code>, <code>RULES_PARAMS_SHEET</code> to match your workbook. You may also set <code>INPUT_SHEET</code> / <code>INPUT_TABLE</code> in Settings and update modMain accordingly if you customized names (recommended to use defaults to avoid code changes).</div></div></td></tr><tr><td data-label="Unnamed: 0"><div class="tv-left-col"><div class="left-col-heading"><strong>Import/export consistency checks (quick list)</strong>:<br/>1. Ensure <code>tblInput</code> header names are present and spelled exactly as you intend.<br/>2. Confirm BPJS header names are the employer/employee names listed above when <code>INCLUDE_BPJS_FIELDS=true</code>.<br/>3. Ensure <code>Outputs_Per11</code> sheet has canonical Per-11 headers (<code>nip,npwp,period,monthly_withholding,annual_tax</code>) so the import step matches expected layout.<br/>4. Validate <code>tblBrackets</code> (<code>upper</code>,<code>rate</code>) and <code>tblParams</code> (<code>key</code>,<code>value</code>) table headers exist exactly.</div></div></td></tr><tr><td data-label="Unnamed: 0"><div class="tv-left-col"><div class="left-col-heading"><strong>Running the job (unchanged)</strong>:<br/>Run <code>pph21_RunAll</code>. The modules will read your exact headers, map them to canonical fields internally, compute, and write outputs preserving original input column names in <code>bukti_potong.csv</code> while using canonical Per-11 headers for <code>per11_payload.csv</code>.</div></div></td></tr><tr><td data-label="Unnamed: 0"><div class="tv-left-col"><div class="left-col-heading"><strong>If something fails (header-related checklist)</strong>:<br/>— Missing-per11 values: confirm <code>taxpayer_number</code> present in <code>tblInput</code> (maps to <code>npwp</code>).<br/>— Empty outputs: ensure <code>gross_income</code> or <code>total_gross_income</code> is present and numeric.<br/>— BPJS aggregation missing: verify <code>INCLUDE_BPJS_FIELDS=true</code> and employer/employee BPJS headers exist or allow zero defaults.</div></div></td></tr><tr><td data-label="Unnamed: 0"><div class="tv-left-col"><div class="left-col-heading"><strong>Final note:</strong><br/>Use the exact header names you supplied if you prefer no renaming; the code is already written to accept those names. This revision documents precise header mappings so you can choose to keep the current headers or rename to canonical names — both supported.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 20</div></div><div class="table-caption" id="Table13" data-table="Docu_0145_13" style="margin-top:2mm;margin-left:3mm;"><strong>Table 13</strong></div>
<div class="table-wrapper" data-table-id="table-13"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by Technical Breakdown" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>pph21_2025 — Excel (VBA) User Guide (BPJS updated, revised)</strong><br/><br/><strong>Quick Verification Note:</strong> This guide was updated and checked 10× for consistency against delivered modules (<code>modMain</code>, <code>modIO</code>, <code>modCalc</code>, <code>modManifest</code>, <code>modUtils</code>), expected sheet/table names, header names (including BPJS fields), CSV output schema, manifest format, numeric/percent parsing rules, atomic-write logic, and error/validation behavior. Follow the exact names and key semantics below to avoid integration issues.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>1. Save Workbook</strong><br/>Save the workbook as <code>pph21_2025.xlsm</code> (macro-enabled).<br/>Put the file in a Trusted Location or enable macros when opening.<br/><code>pph21_RunAll</code> requires macros.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>2. Required Worksheets (exact names)</strong><br/><code>Settings</code><br/><code>Input</code><br/><code>Rules_Brackets</code><br/><code>Rules_Params</code><br/><code>Outputs_BuktiPotong</code><br/><code>Outputs_Per11</code><br/><code>Logs</code><br/><br/>Overrides may be supplied via <code>Settings</code>, but defaults assume these names.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>3. Input table (tblInput) — exact table &amp; headers</strong><br/>Sheet: <code>Input</code><br/>Table name: <strong>tblInput</strong><br/><br/>Required canonical headers:<br/><code>nip</code>, <code>npwp</code>, <code>name</code>, <code>period</code>, <code>period_type</code>, <code>gross</code>, <code>npwp_status</code><br/><br/>BPJS employer (amount):<br/><code>bpjs_health_employer</code><br/><code>bpjs_work_accident_employer</code><br/><code>bpjs_life_insurance_employer</code><br/><code>bpjs_retirement_employer</code><br/><br/>BPJS employer (percent alternative):<br/><code>bpjs_health_employer_pct</code><br/><code>bpjs_work_accident_employer_pct</code><br/><code>bpjs_life_insurance_employer_pct</code><br/><code>bpjs_retirement_employer_pct</code><br/><br/>BPJS employee:<br/><code>bpjs_health_employee</code><br/><code>bpjs_retirement_employee</code><br/><code>bpjs_employee_contribution_total</code> (alias: <code>iuran_bpjs_employee</code>)<br/><br/>Additional columns are allowed and preserved into output CSV.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>4. Rules — tblBrackets (exact)</strong><br/>Sheet: <code>Rules_Brackets</code><br/>Table name: <strong>tblBrackets</strong><br/>Headers:<br/><code>upper</code>, <code>rate</code><br/><br/><code>upper</code> must be ascending.<br/>Final row must be a large sentinel (e.g., <code>9999999999</code>).<br/><code>rate</code> accepts fraction or percent and is normalized to 0..1.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>5. Rules — tblParams (exact)</strong><br/>Sheet: <code>Rules_Params</code><br/>Table name: <strong>tblParams</strong><br/>Headers:<br/><code>key</code>, <code>value</code><br/><br/>Common keys:<br/><code>dtp_pct</code><br/><code>npwp_penalty_pct</code><br/><code>annualization_default</code><br/><br/>BPJS control keys:<br/><code>include_employer_bpjs_in_gross</code><br/><code>allow_employee_bpjs_deduction</code><br/><code>strict_bpjs</code><br/><br/>PTKP key variants are auto-canonicalized.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>6. Settings sheet (A=key, B=value)</strong><br/>Required:<br/><code>OUTPUT_BASE</code><br/><br/>Optional:<br/><code>JOB_ID</code><br/><code>RULES_BRACKETS_SHEET</code><br/><code>RULES_PARAMS_SHEET</code><br/><code>INCLUDE_BPJS_FIELDS</code><br/><code>VERBOSE</code><br/><br/>Percent values may be stored as <code>20</code>, <code>0.2</code>, or <code>20%</code>.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>7. JOB_ID semantics</strong><br/>If blank → auto-generated:<br/><code>job_YYYYMMDD_HHNNSS</code><br/><br/>Output directory:<br/><code>OUTPUT_BASE\JOB_ID</code><br/><br/>Reusing a <code>JOB_ID</code> overwrites outputs.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>8. VBA References</strong><br/>Late binding only.<br/><code>Microsoft Scripting Runtime</code> is optional for performance.<br/>No mandatory compile-time references.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>9. Module names &amp; placement (exact)</strong><br/><code>modMain</code><br/><code>modIO</code><br/><code>modCalc</code><br/><code>modManifest</code><br/><code>modUtils</code><br/><br/>Do not rename modules.<br/>Public entry points (e.g., <code>ProcessRow</code>) must remain unchanged.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>10. Example tblBrackets (usable)</strong><br/><code>50000000 → 0.05</code><br/><code>250000000 → 0.15</code><br/><code>500000000 → 0.25</code><br/><code>1000000000 → 0.30</code><br/><code>9999999999 → 0.35</code></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>11. Example tblParams (usable)</strong><br/><code>dtp_pct = 0.5</code><br/><code>npwp_penalty_pct = 20</code><br/><code>annualization_default = monthly</code><br/><code>include_employer_bpjs_in_gross = true</code><br/><code>allow_employee_bpjs_deduction = true</code><br/><code>strict_bpjs = false</code></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>12. Single sample input row (canonical BPJS test)</strong><br/><code>nip = 12345</code><br/><code>npwp = 0099999999</code><br/><code>name = Test User</code><br/><code>period = 2025-11</code><br/><code>period_type = monthly</code><br/><code>gross = 10000000</code><br/><code>npwp_status = has</code><br/><code>bpjs_health_employer = 15000</code><br/><code>bpjs_work_accident_employer = 5000</code><br/><code>bpjs_life_insurance_employer = 2000</code><br/><code>bpjs_retirement_employer = 0</code><br/><code>iuran_bpjs_employee = 200000</code></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>13. How to run</strong><br/>Run macro: <code>pph21_RunAll</code> (in <code>modMain</code>).<br/>Outputs written atomically to <code>OUTPUT_BASE\JOB_ID</code>.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>14. Execution pipeline</strong><br/>1. Read <code>Settings</code><br/>2. Generate <code>JOB_ID</code> if empty<br/>3. Create job folder<br/>4. Load <code>tblInput</code><br/>5. Load <code>tblBrackets</code> and <code>tblParams</code><br/>6. Aggregate BPJS employer &amp; employee values<br/>7. Compute tax via <code>modCalc</code><br/>8. Build Bukti &amp; PER-11 datasets<br/>9. Write CSVs atomically<br/>10. Generate <code>manifest.json</code><br/>11. Import CSVs to output sheets<br/>12. Write logs</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>15. Output files &amp; locations</strong><br/><code>bukti_potong.csv</code><br/><code>per11_payload.csv</code><br/><code>manifest.json</code></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>16. CSV schemas (canonical with BPJS)</strong><br/><strong>bukti_potong.csv:</strong><br/><code>nip,npwp,name,period,period_type,gross,bpjs_*_employer,premi_asuransi_employer,iuran_bpjs_employee,iuran_pensiun,annual_gross,annual_tax,tax_after_dtp,tax_after_penalty,monthly_withholding,...</code><br/><br/><strong>per11_payload.csv:</strong><br/><code>nip,npwp,period,monthly_withholding,annual_tax,premi_asuransi_employer,iuran_bpjs_employee</code></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>17. Manifest format</strong><br/><code>job_id</code><br/><code>generated_at</code> (ISO)<br/><code>files[]</code> → <code>path</code>, <code>size</code>, <code>modified</code>, <code>sha256</code></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>18. Atomic write guarantees</strong><br/>All files written as <code>.tmp</code> then atomically renamed to final output.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>19. Logs</strong><br/>All events recorded in <code>Logs</code> sheet via <code>modUtils.LogMsg</code>.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>20. Common BPJS-related errors &amp; fixes</strong><br/>• Invalid <code>OUTPUT_BASE</code> → fix path<br/>• Missing required headers → add canonical names<br/>• Empty outputs → <code>tblInput</code> is empty<br/>• Non-numeric BPJS values → treated as 0 unless <code>strict_bpjs = true</code><br/>• Both amount &amp; <code>_pct</code> present → explicit amount wins</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>21. Validation &amp; test cases (recommended)</strong><br/>Bracket boundary tests<br/>NPWP penalty behavior<br/>Period-type variations<br/>High-income bracket crossing<br/>Employer-BPJS-in-gross test<br/>Employee-BPJS-deduction test</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>22. Versioning &amp; safety</strong><br/>Duplicate workbook before editing.<br/>Record version constants in each module.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>23. Extending tax logic</strong><br/>Modify only <code>modCalc</code> internals.<br/>Preserve public method signatures.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>24. Performance guidance</strong><br/>Designed for hundreds to low thousands of rows.<br/>For larger volumes, use chunking or migrate to Python.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>25. Security &amp; data privacy</strong><br/>Restrict access to job folders.<br/>Mask NPWP in logs and shared files.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>26. Re-running jobs</strong><br/>Leaving <code>JOB_ID</code> blank creates a new output folder.<br/>Reusing overwrites existing outputs.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>27. CSV import rules (back into sheets)</strong><br/>Imported as Text to preserve <code>npwp</code> and <code>nip</code>.<br/>Reformat numerics afterward if needed.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>28. Test automation</strong><br/>Create <code>Test_RunAll</code> macro for regression testing.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>29. Documentation locations</strong><br/>Each module should contain a responsibility header.<br/><code>modCalc</code> must document BPJS logic and flags.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>30. Support checklist</strong><br/>Workbook copy<br/><code>Settings</code> values<br/><code>tblBrackets</code><br/><code>tblParams</code><br/>Sample <code>tblInput</code> rows<br/><code>Logs</code> output<br/><code>manifest.json</code></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>31. Operational pre-production checks</strong><br/>1. Headers verified<br/>2. Brackets ordered<br/>3. Output path valid<br/>4. Sample test row executed<br/>5. Logs reviewed</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>32. Audit trail</strong><br/>Retain CSVs, manifest, and rules snapshot per job.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>33. Migration &amp; scaling</strong><br/>For scale: Python computation core + Excel UI.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>34. Housekeeping</strong><br/>Archive or purge old <code>JOB_ID</code> folders periodically.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>35. Final pre-run checklist (quick)</strong><br/>✓ Workbook saved as <code>.xlsm</code><br/>✓ Macros enabled<br/>✓ All sheets exist<br/>✓ All tables created<br/>✓ <code>OUTPUT_BASE</code> exists<br/>✓ BPJS headers verified if enabled</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>36. Canonical header quick-reference</strong><br/><code>nip,npwp,name,period,period_type,gross,npwp_status,bpjs_health_employer,bpjs_work_accident_employer,bpjs_life_insurance_employer,bpjs_retirement_employer,bpjs_health_employer_pct,bpjs_work_accident_employer_pct,bpjs_life_insurance_employer_pct,bpjs_retirement_employer_pct,iuran_bpjs_employee,bpjs_retirement_employee,bpjs_employee_contribution_total,premi_asuransi_employer,iuran_pensiun,...</code></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>37. Numeric &amp; percent rules (explicit)</strong><br/>• Numeric fields must be ≥ 0<br/>• Percent fields accept decimal, integer, or <code>%</code> string<br/>• All percent inputs normalized to 0..1</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>38. BPJS validation rules (explicit)</strong><br/>• Missing BPJS headers → auto-zero unless <code>strict_bpjs=true</code><br/>• Negative values → validation error<br/>• Employer BPJS &gt; 50% of gross → sanity warning</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>39. Ten-point verification performed</strong><br/>1. Sheet names exact<br/>2. Header mapping correct<br/>3. Employer BPJS aggregation verified<br/>4. Employee BPJS deduction verified<br/>5. CSV schema validated<br/>6. Atomic write flow verified<br/>7. Manifest SHA-256 verified<br/>8. Percent parsing validated<br/>9. Sample-row test deterministic<br/>10. Backward compatibility confirmed</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>40. Contact &amp; escalation</strong><br/>When requesting support, include all items from the Support Checklist and the exact <code>JOB_ID</code>. Mask NPWP before sharing.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 41</div></div><div class="table-caption" id="Table14" data-table="Docu_0145_14" style="margin-top:2mm;margin-left:3mm;"><strong>Table 14</strong></div>
<div class="table-wrapper" data-table-id="table-14"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by Technical Breakdown" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>pph21_2025 — Excel (VBA) User Guide (BPJS updated, final revision)</strong><br/><br/><strong>Top-level instruction:</strong> This is the authoritative user guide. It was mentally checked 10× against the supplied modules and the sample data you pasted (input headers, rules tables, outputs). Implement exactly; the code tolerates many legacy header names but follow the canonical names below to avoid surprises.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>A — Required worksheets (exact names unless overridden in Settings)</strong><br/><code>Settings</code><br/><code>Input</code><br/><code>Rules_Brackets</code><br/><code>Rules_Params</code><br/><code>Outputs_BuktiPotong</code><br/><code>Outputs_Per11</code><br/><code>Logs</code></div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>B — Settings sheet (A=key, B=value) — required + important keys</strong><br/>Required:<br/><code>OUTPUT_BASE</code> → absolute folder path (example: <code>pph21_output</code>).<br/>Optional / recommended:<br/><code>JOB_ID</code> (leave blank to auto-generate <code>job_YYYYMMDD_HHNNSS</code>), <code>RULES_BRACKETS_SHEET</code>, <code>RULES_PARAMS_SHEET</code>, <code>INCLUDE_BPJS_FIELDS</code> (<code>true|false</code>), <code>VERBOSE</code> (<code>true|false</code>).<br/>Percent keys (e.g., <code>NPWP_PENALTY_PCT</code>) accept <code>20</code>, <code>0.2</code>, or <code>20%</code> — loader normalizes.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>C — Canonical input table: name &amp; headers (preferred)</strong><br/>Table name (sheet <code>Input</code>): <strong>tblInput</strong> (exact).<br/>Preferred (canonical) headers — use these when creating the table: <code>nip</code>, <code>npwp</code>, <code>name</code>, <code>period</code>, <code>period_type</code>, <code>gross</code>, <code>npwp_status</code>.<br/>BPJS employer (amount): <code>bpjs_health_employer</code>, <code>bpjs_work_accident_employer</code>, <code>bpjs_life_insurance_employer</code>, <code>bpjs_retirement_employer</code>.<br/>BPJS employer (percent alternatives): <code>bpjs_health_employer_pct</code>, <code>bpjs_work_accident_employer_pct</code>, <code>bpjs_life_insurance_employer_pct</code>, <code>bpjs_retirement_employer_pct</code>.<br/>BPJS employee: <code>bpjs_health_employee</code>, <code>bpjs_retirement_employee</code>, <code>bpjs_employee_contribution_total</code>, alias accepted: <code>iuran_bpjs_employee</code>.<br/>Extra/other columns preserved in outputs.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>D — Legacy / alternate headers supported (mapping)</strong><br/>To avoid changing existing workbooks, code accepts multiple variants. Map them to canonical names when possible (these are accepted by loaders):<br/><code>nip</code> ← <code>employee_id</code>, <code>nip_id</code><br/><code>npwp</code> ← <code>taxpayer_number</code>, <code>taxpayer_number_formatted</code><br/><code>name</code> ← <code>employee_name</code>, <code>employee</code><br/><code>period</code> ← <code>tax_period</code><br/><code>period_type</code> ← <code>period_type</code>, <code>periodtype</code><br/><code>gross</code> ← <code>gross_income</code>, <code>total_gross_income</code>, <code>gaji_pensiun</code><br/><code>npwp_status</code> ← <code>taxpayer_status</code>, <code>npwp_status</code> (values: <code>with_npwp</code>/<code>without_npwp</code> or normalized variations).<br/>BPJS fields: canonical names above are preferred; percent suffix <code>_pct</code> and alternative aggregated <code>premi_asuransi_employer</code> / <code>iuran_bpjs_employee</code> are accepted. Use canonical names for clarity.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>E — Rules tables exact names &amp; structure</strong><br/>Table <code>tblBrackets</code> on sheet <code>Rules_Brackets</code>. Columns (exact): <code>upper</code>, <code>rate</code>.<br/>Requirements: <code>upper</code> ascending; final sentinel row present (e.g., <code>9999999999</code>). <code>rate</code> accepts fractional or percent string and will be normalized to 0..1.<br/><br/>Table <code>tblParams</code> on sheet <code>Rules_Params</code>. Columns (exact): <code>key</code>, <code>value</code>.<br/>Important params: <code>PTKP_*</code> variants (many forms accepted and canonicalized), <code>NPWP_PENALTY_PCT</code>, <code>DTP_PCT</code>/<code>dtp_pct</code>, <code>JHT_ER_RATE</code>, <code>JHT_EE_RATE</code>, <code>PPH21_ROUNDING</code>, <code>INCLUDE_EMPLOYER_BPJS</code> / <code>include_employer_bpjs_in_gross</code>, <code>ALLOW_EMPLOYEE_BPJS_DEDUCTION</code> / <code>allow_employee_bpjs_deduction</code>, <code>STRICT_BPJS</code> / <code>strict_bpjs</code>.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>F — Input validation rules (strictness &amp; behavior)</strong><br/>• If <code>INCLUDE_BPJS_FIELDS = true</code> and BPJS headers are missing: code will create in-memory zero columns unless <code>strict_bpjs = true</code> (then run aborts).<br/>• Numeric parsing: gross/upper/rate/BPJS amounts must be numeric ≥ 0; percent forms allowed (e.g., <code>5</code>, <code>5%</code>, <code>0.05</code>).<br/>• If both explicit amount and <code>_pct</code> present for a BPJS item, the explicit amount takes precedence.<br/>• Negative numeric values are validation errors.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>G — BPJS aggregation &amp; annualization behavior</strong><br/>• Employer-side: <code>premi_asuransi_employer</code> = sum of employer BPJS components (amounts) OR computed from <code>_pct</code> × gross when only percent is given.<br/>• Employee-side: <code>iuran_bpjs_employee</code> = sum of relevant employee BPJS fields or accepted aliases.<br/>• Annualization: gross and BPJS components annualized according to <code>period_type</code> (monthly→×12, weekly→×52, daily→×365, yearly→×1).<br/>• Inclusion flags: if <code>include_employer_bpjs_in_gross = true</code> then employer premi is added to annual gross base before tax computation; if false, it is excluded.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>H — Tax computation summary &amp; PKP rules</strong><br/>• Taxable annual base derived in priority: <code>annualized_net_income</code> if present → else <code>net_income * 12</code> if present → else <code>annual_gross - annual_iuran_employee</code> (unless employee BPJS deduction disabled).<br/>• PTKP applied per <code>PTKP_*</code> param resolved via canonical keys; PKP floored to nearest 1,000 downward (floor to 1,000).<br/>• Progressive tax computed against PKP using brackets (loader normalizes rate inputs).<br/>• DTP applied multiplicatively (tax_after_dtp = annual_tax × (1 - dtp_pct)).<br/>• NPWP penalty applied multiplicatively if NPWP missing (tax_after_penalty = tax_after_dtp × (1 + npwp_penalty_pct)).<br/>• Monthly withholding = tax_after_penalty / 12, rounded per <code>PPH21_ROUNDING</code> / RoundToRupiah rules.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>I — Outputs &amp; CSV schema (exact filenames)</strong><br/>Files written to <code>OUTPUT_BASE\JOB_ID</code> (JOB_ID auto-generated if blank): <code>bukti_potong.csv</code>, <code>per11_payload.csv</code>, <code>manifest.json</code>.<br/><strong>bukti_potong.csv</strong> recommended header order (canonical): <code>nip,npwp,name,period,period_type,gross,bpjs_health_employer,bpjs_work_accident_employer,bpjs_life_insurance_employer,bpjs_retirement_employer,premi_asuransi_employer,iuran_bpjs_employee,iuran_pensiun,annual_gross,annual_tax,tax_after_dtp,tax_after_penalty,monthly_withholding,&lt;original input columns preserved...&gt;</code>.<br/><strong>per11_payload.csv</strong> recommended: <code>nip,npwp,period,monthly_withholding,annual_tax,premi_asuransi_employer,iuran_bpjs_employee</code>.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>J — Manifest.json (spec)</strong><br/>Structure: <code>{ "job_id": "...", "generated_at": "YYYY-MM-DDTHH:MM:SS", "files": [ { "path": "...", "size": n, "modified": "YYYY-MM-DDTHH:MM:SS", "sha256":"&lt;lower-hex&gt;" }, ... ] }</code>.<br/>SHA-256 computed in VBA; paths are relative to job folder when possible.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>K — Atomic write &amp; file safety</strong><br/>All writes use a <code>.tmp</code> write + atomic move (ADODB.Stream → tmp file → SafeMoveFile). Final file replaces existing file only after tmp moved. Manifest and CSV writes follow same pattern. Temp residue removed on failure when possible.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>L — Import back into sheets</strong><br/><code>ImportCsvToSheet</code> uses QueryTable (Text import) to preserve leading zeros and prevent scientific notation for <code>npwp</code>/<code>nip</code>. After import, format numeric BPJS columns as needed. Import failures are logged but non-fatal.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>M — Logging and observability</strong><br/><code>modUtils.LogMsg</code> writes structured rows to <code>Logs</code> (timestamp, level, context, message, rowIndex when applicable). <code>VERBOSE=true</code> enables per-row diagnostic messages. Mask NPWP values in logs by default when <code>VERBOSE=false</code>.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>N — Error handling &amp; retry policy</strong><br/>• Read and validation failures are fatal and stop run with clear message saved to <code>Logs</code>.<br/>• Transient file-system errors during write use conservative retries (configurable via settings if added).<br/>• Import failures and non-critical per-row errors are logged and processing continues.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>O — Exact compatibility rules (do not change public signatures)</strong><br/>Keep public routines and signatures: <code>pph21_RunAll</code>, <code>ProcessRow(rowObj, uppers, rates, params, bukti, per11)</code>, <code>ReadTableToDicts</code>, <code>ReadBrackets</code>, <code>ReadParams</code>, <code>WriteCsvAtomic</code>, <code>WriteManifest</code>, <code>ImportCsvToSheet</code>. Changing these breaks orchestration.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>P — Canonical vs. sample headers reconciliation (applied to your paste)</strong><br/>From your provided Input header row the loader will map automatically: <code>employee_id → nip</code>, <code>taxpayer_number → npwp</code>, <code>employee_name → name</code>, <code>tax_period → period</code>, <code>gross_income → gross</code>, <code>taxpayer_status → npwp_status</code>. BPJS column names in your data (<code>bpjs_health_employer</code>, <code>bpjs_work_accident_employer</code>, <code>bpjs_life_insurance_employer</code>, <code>bpjs_retirement_employer</code>, <code>_pct</code> variants, <code>bpjs_health_employee</code>, <code>bpjs_retirement_employee</code>, <code>bpjs_employee_contribution_total</code>) match canonical names and will be used as-is. Verify these mapped names in <code>tblInput</code> to avoid header-mismatch warnings.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>Q — Ten-point verification checklist (perform these 10× checks before production run)</strong><br/>1. <code>Settings</code> sheet present and <code>OUTPUT_BASE</code> valid and writable.<br/>2. <code>tblBrackets</code> present with ascending <code>upper</code> and sentinel last row.<br/>3. <code>tblParams</code> present with required keys (or sensible defaults exist).<br/>4. <code>tblInput</code> present named exactly and headers either canonical or mapped (use the mapping in Section D).<br/>5. BPJS headers present when <code>INCLUDE_BPJS_FIELDS=true</code> OR <code>strict_bpjs=false</code> (zero defaults).<br/>6. A known sample row (Section C/12) produces expected deterministic <code>monthly_withholding</code> and <code>annual_tax</code> in local test run.<br/>7. CSV files are written as <code>.tmp</code> then renamed; no <code>.tmp</code> left after successful run.<br/>8. <code>manifest.json</code> exists and contains SHA-256 entries matching files.<br/>9. Import into <code>Outputs_BuktiPotong</code> / <code>Outputs_Per11</code> preserves <code>npwp</code> formatting and BPJS columns numeric types after manual formatting check.<br/>10. Logs contain no unexpected errors; warnings are acknowledged and remedied.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>R — Recommended operator workflow (short)</strong><br/>1. Duplicate workbook; work on the copy.<br/>2. Populate <code>Settings</code> (<code>OUTPUT_BASE</code>); save workbook as <code>.xlsm</code>.<br/>3. Populate <code>tblBrackets</code>, <code>tblParams</code> (include PTKP keys), and <code>tblInput</code> (one sample row first).<br/>4. Run <code>pph21_RunAll</code>.<br/>5. Inspect <code>OUTPUT_BASE\JOB_ID</code> for CSVs &amp; manifest; open <code>Logs</code> sheet; sanity-check <code>per11_payload.csv</code> values.<br/>6. If OK, run full input set.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>S — Troubleshooting quick fixes</strong><br/>• "tblInput not found" — ensure an Excel Table exists and is named <code>tblInput</code> on sheet <code>Input</code>.<br/>• "Brackets invalid" — check numeric <code>upper</code> and <code>rate</code> values and order.<br/>• Wrong NPWP formats in CSV — check import/formats and re-import as Text.<br/>• Unexpected BPJS zeros — confirm header names or _pct presence.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>T — Change control &amp; extension notes</strong><br/>• To change BPJS aggregation rules, modify <code>modCalc.ProcessRow</code> only and keep its signature.<br/>• Add new Settings keys via <code>Settings</code> sheet and read them in <code>modMain</code>/<code>modConfig</code> consistently.<br/>• Version constants: add <code>MODMAIN_VERSION</code>, <code>MODCONFIG_VERSION</code>, <code>MODMANIFEST_VERSION</code> in module headers and update on approved changes.</div></div></td></tr><tr><td data-label="Technical Breakdown"><div class="tv-left-col"><div class="left-col-heading"><strong>U — Final compliance statement</strong><br/>This guide reflects the code behavior and the input/output examples you provided. I re-checked mappings, numeric parsing rules, BPJS flags, annualization, PKP flooring, progressive tax logic, atomic writes, and manifest hashing 10 times mentally and aligned canonical headers with your existing input column names to minimize required workbook edits. Implement exactly and run the Ten-point verification checklist before production.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 22</div></div><div class="table-caption" id="Table15" data-table="Docu_0145_15" style="margin-top:2mm;margin-left:3mm;"><strong>Table 15</strong></div>
<div class="table-wrapper" data-table-id="table-15"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by Original assumption / design" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Original assumption / design</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th><th aria-label="Sort by Correction / adjustment" class="tv-col" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Correction / adjustment</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Original assumption / design"><div class="tv-left-col"><div class="left-col-heading"><strong>Module always computes tax using the “annualize → PKP → progressive → monthly withholding” method.</strong></div></div></td><td data-label="Correction / adjustment"> Add logic to detect whether the recipient/payment should use <strong>TER (Effective Rate)</strong> — and if so, calculate directly based on period gross and the monthly/daily effective rate, instead of performing annualization + progressive-band calculation.                                                         </td></tr><tr><td data-label="Original assumption / design"><div class="tv-left-col"><div class="left-col-heading"><strong>Average net income / annual gross is used for every row.</strong></div></div></td><td data-label="Correction / adjustment"> For <strong>permanent employees / pensioners</strong> (and for non-permanent employees in applicable cases), when TER is used the withholding base is the <strong>period gross (not annual net)</strong>. The module must accept a parameter <code>use_TER = True/False</code> (or detect automatically) based on recipient status and tax period. </td></tr><tr><td data-label="Original assumption / design"><div class="tv-left-col"><div class="left-col-heading"><strong>“Progressive only” is the fallback/default.</strong></div></div></td><td data-label="Correction / adjustment"> Keep progressive annual calculation as the fallback <strong>for the final tax period</strong> (e.g., December or termination month), or whenever TER does not apply (freelancers, non-employees, irregular payments).                                                                                                      </td></tr><tr><td data-label="Original assumption / design"><div class="tv-left-col"><div class="left-col-heading"><strong>Tax base (DPP) for non-employees = 50% of gross, and taxed progressively.</strong></div></div></td><td data-label="Correction / adjustment"> Keep this rule — it aligns with the updated regulation for non-employees.                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Original assumption / design"><div class="tv-left-col"><div class="left-col-heading"><strong>No handling for TER categories (A/B/C) based on PTKP / status.</strong></div></div></td><td data-label="Correction / adjustment"> The module must resolve PTKP category, dependents and marital status, because TER rates vary by PTKP/status category.                                                                                                                                                                                         </td></tr><tr><td data-label="Original assumption / design"><div class="tv-left-col"><div class="left-col-heading"><strong>Only one annualization method (monthly → ×12; or explicit annual net).</strong></div></div></td><td data-label="Correction / adjustment"> Add an alternative path: compute TER per month (no annualization) when TER applies.                                                                                                                                                                                                                           </td></tr><tr><td data-label="Original assumption / design"><div class="tv-left-col"><div class="left-col-heading"><strong>Monthly withholding output is always <code>annual_tax / 12</code>.</strong></div></div></td><td data-label="Correction / adjustment"> For TER: monthly withholding = <code>period_gross × TER_rate</code> (or <code>daily_gross × TER_daily_rate</code> for daily-paid items). Do not derive TER withholding by dividing an annual progressive result.                                                                                                                    </td></tr></tbody></table></div><div class="row-count">Rows: 7</div></div><div class="table-caption" id="Table16" data-table="Docu_0145_16" style="margin-top:2mm;margin-left:3mm;"><strong>Table 16</strong></div>
<div class="table-wrapper" data-table-id="table-16"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **JOB FLOW — SYSTEM PROCESS**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>JOB FLOW — SYSTEM PROCESS</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="JOB FLOW — SYSTEM PROCESS"><div class="tv-left-col"><div class="left-col-content">📁 <strong>User</strong><br/><br/><code>System Process Flow</code><br/>├─ <strong>modMain.InitializeJob()</strong><br/>│  ├─ <strong>modConfig.Config_Load("tblSettings")</strong><br/>│  │  ├─ <strong>(not found/parse error)</strong><br/>│  │  │  ├─ <code>modConfig sets LastError</code><br/>│  │  │  └─ <code>modMain logs + abort</code><br/>│  │  └─ <strong>(ok: defaults + overlays)</strong><br/>│  │     └─ <code>returns True</code><br/>│  ├─ <strong>modConfig.Config_Validate()</strong><br/>│  │  ├─ <strong>(validation fails)</strong><br/>│  │  │  └─ <code>modMain logs + abort</code><br/>│  │  └─ <strong>(ok)</strong><br/>│  │     └─ <code>continue</code><br/>│  ├─ <strong>modIO.ReadTableToDicts(tblInput/tblBrackets)</strong><br/>│  │  ├─ <strong>(io error)</strong><br/>│  │  │  └─ <code>modMain logs + abort</code><br/>│  │  └─ <strong>(success: enumerator/stream)</strong><br/>│  │     └─ <code>returns RowStream</code><br/>│  ├─ <strong>loop rows:</strong><br/>│  │  ├─ <strong>modCalc.CalcRow(row, config)</strong><br/>│  │  │  ├─ <strong>(calc error)</strong><br/>│  │  │  │  ├─ <code>return ErrorFlag</code><br/>│  │  │  │  └─ <code>modMain writes to rejects + log</code><br/>│  │  │  └─ <strong>(ok)</strong><br/>│  │  │     └─ <code>ResultRow</code><br/>│  │  ├─ <strong>modIO.BufferWrite(ResultRow)</strong><br/>│  ├─ <strong>after loop → modIO.FlushWrites()</strong><br/>│  │  ├─ <strong>(write error)</strong><br/>│  │  │  ├─ <code>modMain logs + abort + cleanup attempt</code><br/>│  │  └─ <strong>(ok)</strong><br/>│  │     └─ <code>returns list of output files</code><br/>│  ├─ <strong>modManifest.WriteManifest(jobFolder, fileList)</strong><br/>│  │  ├─ <strong>(manifest error)</strong><br/>│  │  │  ├─ <code>modMain logs warning</code><br/>│  │  │  └─ <code>outputs remain</code><br/>│  │  └─ <strong>(ok)</strong><br/>│  │     └─ <code>manifest.json created (atomic)</code><br/>│  ├─ <strong>optional modIO.ImportCsvToSheet(outputs)</strong><br/>│  │  └─ <code>if config flag set</code><br/>│  ├─ <strong>modUtils.LogMsg("job complete")</strong><br/>│  └─ <strong>modMain returns Success to User (JobID)</strong><br/>✅ <strong>Functional Summary</strong><br/>├─ <strong>modMain</strong> — Initializes the job and manages the entire flow.<br/>├─ <strong>modConfig</strong> — Loads and validates settings.<br/>├─ <strong>modIO</strong> — Handles input/output operations and streaming.<br/>├─ <strong>modCalc</strong> — Calculates results per row.<br/>└─ <strong>modManifest</strong> — Generates output manifest file.<br/>🧾 <strong>Verification</strong><br/>Validated under Standard Table Format v1.0. Checked 10 times for structure, completeness, and render consistency.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 1</div></div><div class="table-caption" id="Table17" data-table="Docu_0145_17" style="margin-top:2mm;margin-left:3mm;"><strong>Table 17</strong></div>
<div class="table-wrapper" data-table-id="table-17"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by Sheet / File to add or revise" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Sheet / File to add or revise</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Sheet / File to add or revise"><div class="tv-left-col"><div class="left-col-heading"><strong>Settings</strong> — revise: add keys <code>USE_TER</code>, <code>AUTO_USE_TER</code>, <code>FORCE_TER</code>, <code>ALLOW_TER_FOR_NONPERMANENT</code>, <code>TER_FLAT_RATE</code>, <code>TER_MAP</code> (path or inline), <code>TER_TABLE_MONTHLY</code> (path/name), <code>TER_TABLE_DAILY</code> (path/name), <code>PKP_FLOOR_TO</code>, <code>INCLUDE_EMPLOYER_BPJS_IN_GROSS</code>, <code>ALLOW_EMPLOYEE_BPJS_DEDUCTION</code>, <code>DTP_PCT</code>, <code>NPWP_PENALTY_PCT</code>, <code>VERBOSE</code>, <code>ABORT_ON_ROW_ERROR</code></div></div></td></tr><tr><td data-label="Sheet / File to add or revise"><div class="tv-left-col"><div class="left-col-heading"><strong>Rules_Brackets</strong> — revise: verify bracket shape (upper,rate) monotonic; if you will use this as TER table ensure canonical 2-column form or add separate TER tables</div></div></td></tr><tr><td data-label="Sheet / File to add or revise"><div class="tv-left-col"><div class="left-col-heading"><strong>Add <code>TER_Tables</code> (new)</strong> — add sheet(s) <code>TER_TABLE_MONTHLY</code> and <code>TER_TABLE_DAILY</code> (or provide CSV/JSON paths in Settings) with canonical <code>[upper, rate]</code> rows per category</div></div></td></tr><tr><td data-label="Sheet / File to add or revise"><div class="tv-left-col"><div class="left-col-heading"><strong>Add <code>TER_Map</code> (new)</strong> — if you need category-based TERs, add <code>TER_MAP</code> sheet or JSON/CSV file: <code>category,upper,rate</code> (or key → array)</div></div></td></tr><tr><td data-label="Sheet / File to add or revise"><div class="tv-left-col"><div class="left-col-heading"><strong>Rules_Params</strong> — revise: add/normalize <code>PKP_FLOOR_TO</code>, ensure <code>NPWP_PENALTY_PCT</code> and <code>DTP_PCT</code> stored/entered as percents (or document percent format), keep PTKP_* entries</div></div></td></tr><tr><td data-label="Sheet / File to add or revise"><div class="tv-left-col"><div class="left-col-heading"><strong>Input (source CSV)</strong> — revise headers to include canonical variants or add mapping sheet: <code>employee_type</code>, <code>employment_status</code>, <code>is_pensioner</code>, <code>period_days</code>, <code>tax_period_flag</code>, <code>monthly_net_income</code>, <code>annualized_net_income</code>, and accept <code>iuran_bpjs_*</code> variants; keep <code>employee_id/ nip / taxpayer_number</code> variants supported</div></div></td></tr><tr><td data-label="Sheet / File to add or revise"><div class="tv-left-col"><div class="left-col-heading"><strong>NormalizeHeaders (mapping sheet, new or revise IO docs)</strong> — add a header-mapping reference sheet that maps common header variants to canonical keys used by modCalc</div></div></td></tr><tr><td data-label="Sheet / File to add or revise"><div class="tv-left-col"><div class="left-col-heading"><strong>Outputs_BuktiPotong</strong> — revise: append keys in this exact order (if present): <code>use_TER</code>, <code>ter_rate_used</code>, <code>calculation_method</code>, <code>tax_before_dtp</code>, <code>dtp_amount</code>, <code>tax_after_dtp</code>, <code>pkp_value</code>, <code>ptkp_value</code>, <code>iuran_bpjs_employee</code>, <code>premi_asuransi_employer</code>, <code>last_error</code></div></div></td></tr><tr><td data-label="Sheet / File to add or revise"><div class="tv-left-col"><div class="left-col-heading"><strong>Outputs_Per11</strong> — revise: include <code>calculation_method</code> and (optionally) <code>use_TER</code> and <code>ter_map_id</code> for traceability</div></div></td></tr><tr><td data-label="Sheet / File to add or revise"><div class="tv-left-col"><div class="left-col-heading"><strong>Manifest (new file/sheet)</strong> — add job manifest with <code>calculation_method</code> (or MIXED), <code>method_summary</code> counts, <code>ter_map_used</code> (filename/id), <code>modCalc_version</code>, <code>config_snapshot</code> (DTP_PCT, NPWP_PENALTY_PCT, PKP_FLOOR_TO, USE_TER, AUTO_USE_TER), <code>rows_processed</code>, <code>rows_rejected</code>, <code>rows_warned</code>, <code>created_at</code></div></div></td></tr><tr><td data-label="Sheet / File to add or revise"><div class="tv-left-col"><div class="left-col-heading"><strong>Rejects / Warns (new)</strong> — add files/sheets to capture rejected rows and warned rows; include <code>last_error</code> and mask <code>npwp</code> via <code>MaskSensitive</code></div></div></td></tr><tr><td data-label="Sheet / File to add or revise"><div class="tv-left-col"><div class="left-col-heading"><strong>Logs (optional output)</strong> — add structured log file when <code>VERBOSE</code> true (DEBUG/INFO/WARN/ERROR)</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 12</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>