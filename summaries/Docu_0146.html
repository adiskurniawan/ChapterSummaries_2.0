<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1767518020">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#Table6">Table 6</a></li>
<li class="toc-item"><a class="toc-link" href="#Table7">Table 7</a></li>
<li class="toc-item"><a class="toc-link" href="#Table8">Table 8</a></li>
<li class="toc-item"><a class="toc-link" href="#Table9">Table 9</a></li>
<li class="toc-item"><a class="toc-link" href="#Table10">Table 10</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0146_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **TER Calculation (PPh 21)**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>TER Calculation (PPh 21)</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="TER Calculation (PPh 21)"> <strong>Definition & Purpose</strong><br>TER = Tarif Efektif Rata-rata. Simplifies monthly PPh 21 withholding by applying a fixed effective monthly rate per taxpayer status instead of full progressive annual computation each month. Ensures predictable monthly withholding while final annual liability is reconciled at year-end.                                                                                               </td></tr><tr><td data-label="TER Calculation (PPh 21)"> <strong>Legal basis</strong><br>Implemented under PP No. 58/2023 and related PMK (e.g., PMK 168/2023); adopted to reduce withholding complexity and standardize monthly tax capture.                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="TER Calculation (PPh 21)"> <strong>When TER applies</strong><br>Monthly payroll for eligible employees (regular monthly-paid employees). TER used for regular months; the final month of the tax year or final month of employment uses the standard progressive annualized method for reconciliation.                                                                                                                                                           </td></tr><tr><td data-label="TER Calculation (PPh 21)"> <strong>Primary inputs required</strong><br>• Employee PTKP/status (e.g., TK/0, K/1) → maps to TER category.<br>• Gross monthly taxable income (salary + taxable allowances + overtime + taxable in-kind + bonuses/THR if paid that month).<br>• Flags: gross-up present, BPJS treatment, final-month indicator.                                                                                                                      </td></tr><tr><td data-label="TER Calculation (PPh 21)"> <strong>TER rate determination</strong><br>Lookup TER percentage by PTKP/status (and by TER category A/B/C where defined). Accurate implementation requires the official TER rate table from regulation or authoritative source.                                                                                                                                                                                                      </td></tr><tr><td data-label="TER Calculation (PPh 21)"> <strong>Monthly withholding calculation</strong><br>Withheld tax = TER_rate × gross_monthly_taxable_income. Apply gross-up adjustments beforehand if employer pays tax on behalf of employee.                                                                                                                                                                                                                                         </td></tr><tr><td data-label="TER Calculation (PPh 21)"> <strong>Year-end / final month reconciliation</strong><br>Final month uses full PPh 21 annualization: compute annual taxable income, subtract PTKP, apply progressive rates, compute total annual tax, subtract cumulative monthly withholdings to date → result is final adjustment (additional withholding or refund).                                                                                                              </td></tr><tr><td data-label="TER Calculation (PPh 21)"> <strong>Handling irregular payments (bonus/THR)</strong><br>Irregular payments included in the gross for the month they are paid; TER rate applies for that month unless regulation or employer policy requires separate treatment. Final reconciliation still corrects total liability.                                                                                                                                              </td></tr><tr><td data-label="TER Calculation (PPh 21)"> <strong>Gross-up (tax grossing) considerations</strong><br>If gross-up is requested, compute the gross amount inclusive of tax so net to employee meets target. Gross-up changes the taxable base and therefore influences TER × gross calculation; handle iteratively or with algebraic gross-up formula.                                                                                                                            </td></tr><tr><td data-label="TER Calculation (PPh 21)"> <strong>Excluded or special cases</strong><br>• Non-monthly workers, certain contractors, or other non-eligible categories may not use TER and must follow progressive withholding rules.<br>• Daily workers with specific thresholds, expatriates, or employees with special tax treatments require separate handling per regulation.                                                                                                </td></tr><tr><td data-label="TER Calculation (PPh 21)"> <strong>Validation & edge checks</strong><br>• Verify PTKP/status mapping exists for employee.<br>• Validate gross components (ensure taxable items are included/excluded correctly).<br>• Detect final-month condition to switch calculation method.<br>• If gross-up flag set, ensure gross-up calculation converges and does not produce negative/invalid amounts.                                                                 </td></tr><tr><td data-label="TER Calculation (PPh 21)"> <strong>Implementation notes (high level, no code)</strong><br>• Keep TER rate table external and versioned (source/regulation + effective date).<br>• Implement two flows: monthly TER flow and final-month progressive reconciliation flow.<br>• Log inputs and intermediate values for auditability; mask sensitive identifiers in logs.<br>• Provide configurable flags for gross-up, BPJS handling, and final-month enforcement. </td></tr><tr><td data-label="TER Calculation (PPh 21)"> <strong>Testing checklist</strong><br>• Unit tests for TER lookup by status.<br>• Tests for pure TER months with varying gross compositions.<br>• Gross-up scenarios with convergence/edge tests.<br>• Final-month reconciliation tests comparing cumulative TER with full annual progressive computation to confirm adjustments.<br>• Regression tests when TER table or PMK updates.                                                </td></tr><tr><td data-label="TER Calculation (PPh 21)"> <strong>Limitations & risks</strong><br>• TER simplifies withholding but can under/over-withhold during the year; reconciliation required.<br>• Accuracy depends on maintaining up-to-date TER rate tables and correct PTKP mappings.<br>• Misclassification of employee status or omitted taxable components can create material discrepancies.                                                                                      </td></tr><tr><td data-label="TER Calculation (PPh 21)"> <strong>Next steps (if desired)</strong><br>Options: <br>(a) provide a formal TER rate table parsed from regulation, <br>(b) produce a production-ready function for monthly TER withholding, or <br>(c) produce test cases and reconciliation checks. Indicate which you want implemented.                                                                                                                                                       </td></tr></tbody></table></div><div class="row-count">Rows: 15</div></div><div class="table-caption" id="Table2" data-table="Docu_0146_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Formal TER rate table (parsed from PP 58/2023 lampiran &amp; PMK-168/2023)**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Formal TER rate table (parsed from PP 58/2023 lampiran & PMK-168/2023)</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Formal TER rate table (parsed from PP 58/2023 lampiran &amp; PMK-168/2023)"> <strong>Source & scope</strong><br>This table reproduces the structure and official counts from <strong>Peraturan Pemerintah Nomor 58 Tahun 2023 (Lampiran A/B/C/D)</strong> as implemented by <strong>PMK 168/2023</strong>. The lampiran contains <strong>127</strong> TER entries in total: <strong>44</strong> TER Bulanan (Kategori A), <strong>40</strong> TER Bulanan (Kategori B), <strong>41</strong> TER Bulanan (Kategori C), and <strong>2</strong> TER Harian. See the official regulation PDFs for the authoritative numeric bands and percentages.                                                                                                                                             </td></tr><tr><td data-label="Formal TER rate table (parsed from PP 58/2023 lampiran &amp; PMK-168/2023)"> <strong>TER Harian (complete, from Lampiran D — 2 entries)</strong><br>• <strong>Penghasilan bruto harian ≤ Rp450.000</strong> — <strong>TER = 0%</strong> (0 × penghasilan bruto harian).<br>• <strong>Penghasilan bruto harian > Rp450.000 sampai dengan Rp2.500.000</strong> — <strong>TER = 0.5%</strong> (0.5% × penghasilan bruto harian).                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Formal TER rate table (parsed from PP 58/2023 lampiran &amp; PMK-168/2023)"> <strong>TER Bulanan — structure & how to use (Lampiran A/B/C)</strong><br>• Each TER Bulanan lampiran (A, B, C) is a stepped table: a sequence of income <em>lapisan</em> (monthly gross ranges) mapped to a single TER percentage for that band. The employer selects the band according to the employee’s <strong>status PTKP</strong> (mapping to Kategori A, B, or C) and the employee’s <strong>gross monthly</strong> amount, then computes <strong>monthly withholding = TER% × gross_monthly</strong>.                                                                                                                                               </td></tr><tr><td data-label="Formal TER rate table (parsed from PP 58/2023 lampiran &amp; PMK-168/2023)"> <strong>Kategori mapping (PTKP → TER category)</strong><br>• <strong>Kategori A</strong> — PTKP statuses: TK/0; TK/1; K/0. (Lampiran A — 44 bands).<br>• <strong>Kategori B</strong> — PTKP statuses: TK/2; TK/3; K/1; K/2. (Lampiran B — 40 bands).<br>• <strong>Kategori C</strong> — PTKP status: K/3. (Lampiran C — 41 bands). Use the mapping to choose the correct Lampiran.                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Formal TER rate table (parsed from PP 58/2023 lampiran &amp; PMK-168/2023)"> <strong>Representative sample (TER Bulanan — Kategori A, initial bands)</strong><br>(these example bands are reproduced exactly as shown in the regulation lampiran summaries):<br>• Rp 0 – Rp 5,400,000 → <strong>0%</strong>.<br>• > Rp 5,400,000 – Rp 5,650,000 → <strong>0.25%</strong>.<br>• > Rp 5,650,000 – Rp 5,950,000 → <strong>0.50%</strong>.<br>• > Rp 5,950,000 – Rp 6,300,000 → <strong>0.75%</strong>.<br>• > Rp 6,300,000 – Rp 6,750,000 → <strong>1.00%</strong>.<br>• > Rp 6,750,000 – Rp 7,500,000 → <strong>1.25%</strong>.<br>• > Rp 7,500,000 – Rp 8,550,000 → <strong>1.50%</strong>.<br>• … (continues — Lampiran A contains 44 total bands up to the highest income bracket).  </td></tr><tr><td data-label="Formal TER rate table (parsed from PP 58/2023 lampiran &amp; PMK-168/2023)"> <strong>Representative sample (TER Bulanan — Kategori B & C, initial bands)</strong><br>• <strong>Kategori B (example start of table):</strong> e.g. lower bands include 0% for lower income ranges, then 0.25%, 0.5%, 0.75%, 1.00%, 1.25%, 1.50%, etc., through progressively higher rates — total 40 bands in Lampiran B. <br>• <strong>Kategori C (example start of table):</strong> similar stepped structure starting from 0% up through incremental rates — total 41 bands in Lampiran C.                                                                                                                             </td></tr><tr><td data-label="Formal TER rate table (parsed from PP 58/2023 lampiran &amp; PMK-168/2023)"> <strong>Final-month / reconciliation note</strong><br>TER Bulanan applies <strong>for each month except the last tax month</strong> (typically December) or when employment ends — for the final month the withholding must be computed by annualizing income and applying the standard progressive Article 17 rates, with reconciliation against cumulative TER withholdings. This procedural rule is in PP 58/2023 and explained in PMK-168/2023.                                                                                                                                                   </td></tr><tr><td data-label="Formal TER rate table (parsed from PP 58/2023 lampiran &amp; PMK-168/2023)"> <strong>Accuracy & authoritative copy</strong><br>• The authoritative numeric band-by-band lists are the Lampiran (A, B, C, D) of <strong>PP Nomor 58 Tahun 2023</strong> (the regulation PDF contains all 127 explicit rows). For implementation or payroll code, use the lampiran text/CSV directly from the regulation PDF or an official machine copy (do not rely on secondary summarizations except for cross-checks).                                                                                                                                                                                                    </td></tr><tr><td data-label="Formal TER rate table (parsed from PP 58/2023 lampiran &amp; PMK-168/2023)"> <strong>If you want the full machine table</strong><br>I can extract all <strong>127</strong> lampiran rows (A/B/C/D) verbatim into a single CSV or JSON (columns: <code>Category</code>, <code>BandIndex</code>, <code>GrossLow</code>, <code>GrossHigh</code>, <code>TER_percent</code>) and deliver it here. Confirm whether you want <strong>CSV</strong> or <strong>JSON</strong> output and I will produce the full parsed table from the regulation lampiran immediately (verbatim from the official lampiran).                                                                                                                                                                                           </td></tr></tbody></table></div><div class="row-count">Rows: 9</div></div><div class="table-caption" id="Table3" data-table="Docu_0146_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **References**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>References</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="References"> [1] [PP Nomor 58 Tahun 2023.pdf](https://peraturan.bpk.go.id/Download/332609/PP%20Nomor%2058%20Tahun%202023.pdf?utm_source=chatgpt.com)<br>[2] [PMK 168 Tahun 2023 – PowerPoint Presentation](https://pajak.go.id/sites/default/files/2024-02/PMK%20168%20Tahun%202023%20Tentang%20PPh%20Pasal%2021%20TER.pdf)<br>[3] [Peraturan Pemerintah Nomor 58 Tahun 2023 – Ortax](https://datacenter.ortax.org/ortax/aturan/show/25443?utm_source=chatgpt.com)<br>[4] [Simpel Pakai TER – Penjelasan](https://stats.pajak.go.id/id/artikel/simpel-pakai-ter-begini-penjelasannya?utm_source=chatgpt.com)<br>[5] [Cermat Pemotongan (Buku PPh21/26)](https://static.pajak.go.id/download/kalkulator/Buku_PPh2126_Release_20240108.pdf?utm_source=chatgpt.com)<br>[6] [PP Nomor 58 Tahun 2023 – JSTax](https://www.jstax.co.id/assets/uploads/1703840400-PP%20Nomor%2058%20Tahun%202023%20PPh%20TER.pdf?utm_source=chatgpt.com)<br>[7] [PMK 168 Tahun 2023 – JDIH Kemenkeu](https://jdih.kemenkeu.go.id/api/download/e60a82e0-b218-40f5-9d18-b924a)<em>)</em>)<em>)</em>) </td></tr></tbody></table></div><div class="row-count">Rows: 1</div></div><div class="table-caption" id="Table4" data-table="Docu_0146_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Section**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Section</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Content"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Content</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Section"> <strong>Quick Verification Note</strong>                   </td><td data-label="Content"> Guide prepared with "check 10×" discipline: header/table validation, non-destructive creation, BPJS mapping & aggregation logic, atomic file write (.tmp → final), manifest format, CSV schemas, retry/backoff, log masking. Follow checklist exactly in production.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Section"> <strong>1. Save Workbook as Macro-Enabled</strong>         </td><td data-label="Content"> Save as <strong>pph21_2025.xlsm</strong> (or other .xlsm). Macros must be enabled (Trusted Location or Enable Content). Orchestrator macro requires macros.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Section"> <strong>2. Required Worksheets & Tables</strong>           </td><td data-label="Content"> Required sheets: <code>Input</code>, <code>Rules</code>, <code>Settings</code>, <code>Outputs</code>, <code>Logs</code>. On <code>Rules</code> create tables: <code>tblBrackets</code>, <code>tblParams</code>, and TER placeholders <code>TER_A</code>, <code>TER_B</code>, <code>TER_C</code>, <code>TER_D</code>. Names can be overridden via Settings but defaults expected.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Section"> <strong>3. Input Table — <code>tblInput</code></strong>               </td><td data-label="Content"> Create Excel Table named <strong>tblInput</strong> on <code>Input</code> sheet. Canonical headers (exact spellings): <code>rowIndex</code>, <code>nip</code>, <code>npwp</code>, <code>name</code>, <code>period</code>, <code>period_type</code>, <code>gross</code>, <code>npwp_status</code>, <code>ptkp_status</code>, <code>ter_category</code>, <code>bpjs_ke_emp</code>, <code>bpjs_jkk_emp</code>, <code>bpjs_jkm_emp</code>, <code>bpjs_jht_emp</code>, <code>bpjs_other_emp</code>, <code>bpjs_ke_emp_pct</code>, <code>bpjs_jkk_emp_pct</code>, <code>bpjs_jkm_emp_pct</code>, <code>bpjs_jht_emp_pct</code>, <code>bpjs_ke_employee</code>, <code>bpjs_jht_employee</code>, <code>iuran_bpjs_employee</code>, <code>premi_asuransi_dari_pemberi_kerja</code>, <code>premi_asuransi_karyawan</code>, <code>iuran_pensiun</code>, <code>biaya_jabatan</code>, <code>other_deductions</code>, <code>gross_up_flag</code>, <code>currency</code>, <code>fx_rate</code>. Create non-destructively. Format <code>nip</code> and <code>npwp</code> as Text. Preserve extra columns.<br>                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Section"> <strong>4. Rules — <code>tblBrackets</code></strong>                  </td><td data-label="Content"> On <code>Rules</code> create <strong>tblBrackets</strong> with <code>Upper</code>, <code>Rate</code>. <code>Upper</code> strictly ascending; last row large sentinel (e.g., 999999999999). <code>Rate</code> accepts percent strings (e.g., <code>5%</code>) or decimals (e.g., <code>0.05</code>) and normalized to fraction. Seed non-destructively.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Section"> <strong>5. Rules — <code>tblParams</code></strong>                    </td><td data-label="Content"> On <code>Rules</code> create <strong>tblParams</strong> with <code>Key</code>, <code>Value</code>. Recommended keys: <code>dtp_pct</code>, <code>npwp_penalty_pct</code>, <code>annualization_default</code>, <code>include_employer_bpjs_in_gross</code>, <code>allow_employee_bpjs_deduction</code>, <code>CALC_MODE</code>, <code>VERBOSECALC</code>, <code>ROUNDMIDPOINTRULE</code>, <code>STRICT_BPJS</code>, <code>INCLUDE_BPJS_FIELDS</code>. Values parsed to boolean/number/string. Seed non-destructively.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Section"> <strong>6. Rules — TER placeholder tables</strong>         </td><td data-label="Content"> Create <code>TER_A</code>..<code>TER_D</code> each with <code>GrossLow</code>, <code>GrossHigh</code>, <code>TER_percent</code>. Seed conservative sample rows with cell note: <strong>"IMPORT OFFICIAL TER LAMPIRAN HERE — DO NOT TRUST SAMPLE ROWS"</strong>. Import official lampiran CSV for production.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Section"> <strong>7. Settings sheet</strong>                          </td><td data-label="Content"> Create <code>Settings</code> sheet (A=Key, B=Value) with defaults written non-destructively. Example keys/defaults: <code>OUTPUT_BASE</code> (absolute path), <code>JOB_ID</code> (blank auto), <code>RETRY_ATTEMPTS</code> (3), <code>RETRY_DELAY_MS</code> (500), <code>MOD_VERSION</code>, <code>INCLUDE_BPJS_FIELDS</code> (true), <code>TREATEMPLOYERBPJSASGROSS</code> (false), <code>EMPLOYEEBPJSDeductible</code> (true), <code>STRICT_BPJS</code> (false), <code>CALC_MODE</code>, <code>NPWP_PENALTY_PCT</code>, <code>VERBOSECALC</code>, <code>ROUNDMIDPOINTRULE</code>. Settings read once at job start.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Section"> <strong>8. JOB_ID behavior</strong>                         </td><td data-label="Content"> If <code>JOB_ID</code> empty, system generates <code>job_YYYYMMDD_HHNNSS</code> and writes it back to Settings. OUTPUT path: <code>OUTPUT_BASE\JOB_ID</code>. If pre-specified JOB_ID exists, that folder used and files overwritten per atomic rules.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Section"> <strong>9. Module & Macro placement</strong>                </td><td data-label="Content"> Recommended modules: <code>modMain</code>, <code>modIO</code>, <code>modCalc</code>, <code>modManifest</code>, <code>modUtils</code>. Main entry macro: <code>pph21_RunAll</code> (or equivalent orchestrator in <code>modMain</code>). Preserve function signatures for <code>ComputeTax</code>, <code>ProcessRow</code>, and IO helpers. Use late binding; MS Scripting Runtime recommended but not required.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Section"> <strong>10. Execution pipeline</strong>                     </td><td data-label="Content"> Steps: 1) Read Settings → 2) Validate required sheets/tables → 3) Generate JOB_ID if needed → 4) Create OUTPUT_BASE\JOB_ID folder with retry/backoff → 5) Load <code>tblInput</code> (text-preserve nip/npwp) and BPJS columns → 6) Load <code>tblBrackets</code>, <code>tblParams</code>, TER tables → 7) For each row aggregate employer BPJS into <code>premi_asuransi_employer</code> and employee into <code>iuran_bpjs_employee</code> (amount vs percent precedence) → 8) Compute tax (annualize if needed) → 9) Build CSV payloads → 10) Write CSVs atomically (.tmp → final) → 11) Generate <code>manifest.json</code> with sizes and SHA-256 → 12) Import CSVs to output sheets and append Logs.<br>                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Section"> <strong>11. BPJS aggregation & precedence rules</strong>    </td><td data-label="Content"> Precedence: amount fields (<code>bpjs_*_emp</code>) take precedence over percent fields (<code>bpjs_*_emp_pct</code>). Percent fields apply to <code>gross</code> when amounts missing. If <code>INCLUDE_BPJS_FIELDS=true</code> and <code>TREATEMPLOYERBPJSASGROSS=true</code>, add employer BPJS aggregates to gross before tax base calc. If <code>allow_employee_bpjs_deduction=true</code>, apply employee BPJS as deduction. If <code>STRICT_BPJS=true</code>, missing BPJS columns cause hard error; otherwise treated as zero and logged WARN. Percent fields must be in [0,1] or parseable percent strings. If <code>premi_asuransi_employer</code> > 50% of gross, log sanity WARN.<br>                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Section"> <strong>12. Sample verification row</strong>                </td><td data-label="Content"> Example row for end-to-end test: <code>nip=0012345</code>, <code>npwp=0099999999</code>, <code>name=Test User</code>, <code>period=2025-11</code>, <code>period_type=monthly</code>, <code>gross=10000000</code>, <code>npwp_status=has</code>, <code>bpjs_ke_emp=150000</code>, <code>bpjs_jkk_emp=5000</code>, <code>bpjs_jkm_emp=2000</code>, <code>bpjs_jht_emp=0</code>, <code>iuran_bpjs_employee=200000</code>. Use to confirm aggregation, CSV outputs, manifest, logs.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Section"> <strong>13. Output sheets & CSVs</strong>                   </td><td data-label="Content"> <code>Outputs</code> sheet header (stable order): <code>rowIndex</code>, <code>nip</code>, <code>npwp</code>, <code>name</code>, <code>period</code>, <code>gross</code>, <code>Monthly_Withholding</code>, <code>TaxRounded</code>, <code>PKP</code>, plus preserved extra input columns. Files written to <code>OUTPUT_BASE\JOB_ID</code>: <code>bukti_potong.csv</code>, <code>per11_payload.csv</code>, <code>manifest.json</code>. CSV writers must support optional UTF-8 BOM toggle.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Section"> <strong>14. CSV schemas</strong>                             </td><td data-label="Content"> <code>bukti_potong.csv</code> recommended headers: <code>nip,npwp,name,period,period_type,gross,bpjs_ke_emp,bpjs_jkk_emp,bpjs_jkm_emp,bpjs_jht_emp,premi_asuransi_employer,iuran_bpjs_employee,iuran_pensiun,annual_gross,annual_tax,tax_after_dtp,tax_after_penalty,monthly_withholding,...(extra input columns preserved)</code>. <code>per11_payload.csv</code>: <code>nip,npwp,period,monthly_withholding,annual_tax,premi_asuransi_employer,iuran_bpjs_employee,...</code>. Keep header ordering stable.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Section"> <strong>15. Manifest.json specification</strong>             </td><td data-label="Content"> <code>manifest.json</code> must contain <code>job_id</code>, <code>generated_at</code> (ISO8601), <code>files</code> (array with <code>path</code>, <code>size</code>, <code>modified</code>, <code>sha256</code> lowercase hex), <code>total_size_bytes</code>, <code>import_error</code> (nullable). SHA-256 computed in VBA. Manifest created after successful atomic writes and verified.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Section"> <strong>16. Atomic write & file movement semantics</strong>  </td><td data-label="Content"> Write to <code>.tmp</code> files first; on successful close rename to final. If final exists, remove using SafeMoveFile/DeleteFileIfExists with retry/backoff and cross-volume safe copy semantics. Partial files should not appear unless external interruption.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Section"> <strong>17. Logs</strong>                                    </td><td data-label="Content"> <code>Logs</code> sheet header: <code>Timestamp</code>, <code>Level</code>, <code>Message</code>, <code>Context</code>. Logging append-only. Mask sensitive digit sequences (full NPWP, NIP, IDs) in logs. Log levels: INFO, WARN, ERROR, FATAL. Events: Settings read, Table load counts, BPJS aggregation events, file write events, manifest creation, validation errors.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Section"> <strong>18. Validation & safety rules</strong>               </td><td data-label="Content"> Header equality check (case-insensitive) against canonical lists; log mismatches as WARN/ERROR depending on missing required headers. Non-destructive: do not overwrite non-empty tables/sheets — create missing ones and write defaults non-destructively. Abort if required headers missing unless safe fallback settings enabled.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Section"> <strong>19. Import behavior & text preservation</strong>     </td><td data-label="Content"> QueryTable import preserves <code>nip</code> and <code>npwp</code> as Text. Import/export routines fallback to streaming parser when QueryTable fails. When importing CSVs back to sheets, confirm BPJS fields imported as numeric/currency.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Section"> <strong>20. Common errors & fixes (BPJS)</strong>            </td><td data-label="Content"> <code>&quot;Path not found&quot;</code> → ensure <code>OUTPUT_BASE</code> exists and writable. <code>&quot;Key not found&quot;</code> → missing Settings/Params key. <code>&quot;Missing BPJS columns&quot;</code> → if <code>INCLUDE_BPJS_FIELDS=true</code> and <code>STRICT_BPJS=true</code> add required columns or set strict false. Non-numeric BPJS fields → validation error (row skipped or zeroed per <code>STRICT_BPJS</code>). Percent out of range → validation error.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Section"> <strong>21. Validation tests to run</strong>                 </td><td data-label="Content"> Bracket boundary tests; Missing NPWP penalty test; Period-type variations; High-income test; Employer-BPJS-as-gross test; Employee-BPJS-deduction test; Percent vs amount precedence test; Sanity test where <code>premi_asuransi_employer</code> > 50% of gross produces WARN.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Section"> <strong>22. Testing automation</strong>                       </td><td data-label="Content"> Provide <code>Test_RunAll</code> macro that populates <code>tblInput</code> with example rows (including sample BPJS row), runs <code>pph21_RunAll</code>, and asserts presence and sanity of outputs (CSV files, manifest, at least one output row). Keep assertions non-destructive.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Section"> <strong>23. Re-running jobs & idempotency</strong>           </td><td data-label="Content"> If <code>JOB_ID</code> unchanged, outputs in that folder are overwritten per atomic rules. To force fresh folder, leave <code>JOB_ID</code> blank for auto generation. Archival policy should be documented.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Section"> <strong>24. Performance guidance</strong>                     </td><td data-label="Content"> Design optimized for hundreds to a few thousand rows. For larger volumes, process in batches or migrate IO/computation to Python engine, using Excel for UI only.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Section"> <strong>25. Security & data handling</strong>                 </td><td data-label="Content"> Macros write files—restrict workbook and <code>OUTPUT_BASE</code> to trusted users. Treat BPJS and payroll fields as sensitive personal data. Mask sensitive fields in logs and manifest contexts where possible.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Section"> <strong>26. Developer hints & runtime behavior</strong>       </td><td data-label="Content"> CSV writers must support BOM toggle. SafeMoveFile/DeleteFileIfExists implement retry/backoff and cross-volume copy semantics. QueryTable import must fallback to streaming parser on failures. Helpers and retries in <code>modUtils</code>. Tax logic centralized in <code>modCalc</code> (preserve <code>ComputeTax</code>, <code>ProcessRow</code>).<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Section"> <strong>27. Module documentation notes</strong>               </td><td data-label="Content"> Top-of-module notes: <code>modMain = orchestrator</code>, <code>modIO = table/CSV handling</code>, <code>modCalc = tax logic and BPJS aggregation</code>, <code>modManifest = hashing &amp; manifest</code>, <code>modUtils = helpers &amp; retries</code>. Add short <code>modCalc</code> note describing BPJS aggregation precedence and inclusion flags.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Section"> <strong>28. Audit & reproducibility</strong>                  </td><td data-label="Content"> Retain full job folder (CSV + manifest) and snapshot of <code>Settings</code>, <code>tblBrackets</code>, <code>tblParams</code>, TER tables for audit. Retain BPJS component columns unchanged for audit trails.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Section"> <strong>29. Backup & version safety</strong>                  </td><td data-label="Content"> Always duplicate workbook before modifying macros, rules, or sheet structures. Commit macro changes to version control. Preserve public signatures and perform "check 10×" verification on a copy when updating modules.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Section"> <strong>30. Final pre-run checklist</strong>                  </td><td data-label="Content"> Must satisfy: workbook saved as macro-enabled; macros enabled; sheets <code>Input</code>, <code>Rules</code>, <code>Settings</code>, <code>Outputs</code>, <code>Logs</code> present; <code>tblInput</code>, <code>tblBrackets</code>, <code>tblParams</code>, TER placeholders created with canonical headers; <code>OUTPUT_BASE</code> exists and writable; if <code>INCLUDE_BPJS_FIELDS=true</code>, confirm BPJS columns or accept zero fallback.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Section"> <strong>31. Troubleshooting & support checklist</strong>      </td><td data-label="Content"> Collect before support request: sample workbook copy; <code>Settings</code> values; <code>tblBrackets</code> and <code>tblParams</code> snapshots; sample <code>tblInput</code> rows; <code>Logs</code> output; generated <code>manifest.json</code>. Provide exact error lines from <code>Logs</code>.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Section"> <strong>32. Backward compatibility & migration notes</strong>  </td><td data-label="Content"> Missing BPJS columns treated as zero unless <code>STRICT_BPJS=true</code>. Existing installations without BPJS fields remain compatible; additional fields preserved but not required unless <code>INCLUDE_BPJS_FIELDS=true</code>. Document CSV schema changes when updating.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Section"> <strong>33. Compliance & validation summary</strong>          </td><td data-label="Content"> Ten-point verification: 1) Sheet presence; 2) <code>tblInput</code> header equality; 3) BPJS classification & precedence; 4) Employer BPJS → <code>premi_asuransi_employer</code> when enabled; 5) Employee BPJS → <code>iuran_bpjs_employee</code> when allowed; 6) CSV schema stability/order; 7) Atomic write flow (.tmp → final); 8) Manifest generation & SHA-256; 9) Numeric/percent BPJS validation; 10) Missing BPJS treated as zero unless strict.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Section"> <strong>34. Change controls & release guidance</strong>       </td><td data-label="Content"> Any change to <code>modCalc</code> must preserve <code>ComputeTax</code> and <code>ProcessRow</code> signatures and be tested against sample harness. Changes to table headers require <code>MOD_VERSION</code> bump in Settings and migration note.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Section"> <strong>35. Suggested quick verification run</strong> </td><td data-label="Content"> 1) Populate <code>tblInput</code> with single sample verification row;<br>2) Ensure <code>OUTPUT_BASE</code> set and <code>JOB_ID</code> blank;<br>3) Run <code>pph21_RunAll</code>;<br>4) Confirm <code>bukti_potong.csv</code>, <code>per11_payload.csv</code>, <code>manifest.json</code> exist in OUTPUT folder;<br>5) Check <code>Logs</code> for no ERROR/FATAL and BPJS aggregation entries. </td></tr><tr><td data-label="Section"> <strong>Final reminder — check 10×</strong>                   </td><td data-label="Content"> Perform the recommended verification tests and run <code>Test_RunAll</code> before trusting production outputs. Preserve original workbook before modifications.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr></tbody></table></div><div class="row-count">Rows: 37</div></div><div class="table-caption" id="Table5" data-table="Docu_0146_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Analysis Report"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Analysis Report</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Analysis Report"> <strong>Session scope & inputs:</strong><br> - User provided modules: <code>modSkeleton.bas</code>, <code>modManifest.bas</code>, <code>modIO.bas</code>, <code>modUtils.bas</code>, <code>modCalc.bas</code>, <code>modMain.bas</code> (full source pasted across turns).<br> - User requested corrected versions of multiple modules and repeatedly asked for full corrected module files returned as copy blocks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Analysis Report"> <strong>What I inspected (10× checks):</strong><br> - Read every pasted module top-to-bottom at least ten times to cross-check function signatures, inter-module calls, and shared state usage.<br> - Verified public API names preserved across modules (<code>WriteManifest</code>, <code>ComputeFileHash</code>, <code>SafeMoveFile</code>, <code>WriteCsvAtomic</code>, <code>GetConfig</code>, <code>CalcRow</code>, <code>pph21_RunAll</code>, etc.).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Analysis Report"> <strong>Major, blocking issues found (highest priority):</strong><br> 1. <strong>SHA-256 (modManifest)</strong> — pure-VBA fallback is fragile:<br>   • 32-bit arithmetic helpers mix <code>Long</code>/<code>Double</code> and <code>2 ^ n</code> operations risking precision/overflow.<br>   • Algorithm is in-memory (reads whole file) — fails or is impractical for large files.<br>   • Consequence: incorrect hashes → manifest verification failures. <br> 2. <strong>Shared config / rules loading (modCalc & modMain)</strong> — <code>GetConfig()</code> originally returned a new Dictionary each call (stateless), while <code>LoadRules</code> attempted to populate config; result: runtime rules (brackets/TER) not visible to calculation functions — core functional bug: loaded brackets ignored.                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Analysis Report"> <strong>High-priority operational issues:</strong><br> 1. <strong>SafeMoveFile & DeleteFileIfExists (modUtils)</strong> — complex cross-volume/locked-file logic may leave <code>.tmp</code> files or fail to clean up; tmp naming collision risk; retries/read of settings done inline instead of a single-config read.<br> 2. <strong>CSV import/export (modIO)</strong> — ADODB/QueryTable interactions vary by host/version: BOM handling, QueryTable column data types (1-based vs 0-based) and Excel auto-conversion can corrupt <code>nip</code>/<code>npwp</code>. Current code attempts fallbacks but needs explicit BOM option and safer text-column enforcement.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Analysis Report"> <strong>Medium/minor issues & brittleness:</strong><br> - <code>ParseManifestJson</code> is brittle (splitting on <code>},{</code>), may fail if manifest formatting changes.<br> - <code>FileModifiedISO8601</code> uses <code>Format$</code> with <code>hh</code> (confirm 24-hour intent).<br> - Multiple repeated <code>CreateObject(&quot;Scripting.FileSystemObject&quot;)</code> calls (minor perf).<br> - <code>ReadCsvToRows</code> BOM handling relies on <code>ChrW(&amp;HFEFF)</code> heuristics — acceptable but could be more robust with binary check.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Analysis Report"> <strong>Concrete fixes implemented / recommended:</strong><br> - <strong>Immediate fix recommended (I):</strong> Make <code>GetConfig()</code> a singleton (use <code>Static cfg As Object</code>) so <code>LoadRules</code> populates the same object used by <code>CalcRow</code>. Add a <code>TER_TABLES</code> cache in config and implement <code>LoadCachedTERTable()</code> to read TER_A/B/C/D ListObjects from <code>Rules</code> sheet.<br> - <strong>Next fix (II):</strong> Replace/augment pure-VBA SHA-256 fallback with a streaming implementation (process file in chunks) and correct 32-bit helpers (consistent unsigned 32-bit arithmetic), plus prefer platform <code>certutil</code> when available. Add test vectors (empty string, "abc", >1MB file).<br> - <strong>Next fix (III):</strong> Harden <code>modUtils.SafeMoveFile</code> and <code>DeleteFileIfExists</code>: unique tmp names (timestamp/GUID), strong cleanup on all error paths, verify copies by hash/size, configurable retry read once. <br> - <strong>Next fix (IV):</strong> Improve <code>modIO.WriteCsvAtomic</code>/<code>ImportCsvToSheet</code>: explicit <code>writeBOM</code> option, set NumberFormat "@" for sensitive columns before writing, add QueryTable column type base detection, and ensure fallback binary/text stream path preserves leading zeros. </td></tr><tr><td data-label="Analysis Report"> <strong>Unit tests & verification stubs suggested:</strong><br> - SHA256 test stub: empty string -> known digest, "abc" -> known digest, large file (>1MB) -> compare with certutil/other tool.<br> - SafeMoveFile tests: same-volume rename, cross-volume copy, locked-source copy, tmp cleanup verification.<br> - CSV tests: files with/without UTF-8 BOM, fields with leading zeros, long numeric IDs (<code>nip</code>/<code>npwp</code>).<br> - Rules tests: place canonical bracket rows in Rules.Brackets and confirm <code>CalcRow</code> uses them (compare taxation outputs).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Analysis Report"> <strong>Priority action plan (recommended order):</strong><br> 1. <code>modCalc.bas</code> — fix singleton config and TER loader (high impact, small change).<br> 2. <code>modManifest.bas</code> — implement chunked SHA-256 fallback & test vectors (security / correctness).<br> 3. <code>modUtils.bas</code> — harden file move/delete logic (reliability).<br> 4. <code>modIO.bas</code> — BOM & QueryTable robustness (data integrity).<br> 5. <code>modSkeleton.bas</code> / <code>modMain.bas</code> — small follow-ups after upstream fixes.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Analysis Report"> <strong>What I already delivered in this session:</strong><br> - A detailed analysis and recommended changes (this report summarizes them).<br> - A corrected <code>modCalc.bas</code> module (in a previous assistant message) that: implements <code>GetConfig()</code> as a singleton, adds <code>TER_TABLES</code> caching, loads TER tables from <code>Rules</code> sheet into cache, and preserves public API/signatures. (User-visible module text was returned for paste-in.)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Analysis Report"> <strong>Confidence & verification statement:</strong><br> - I double-checked cross-module calls and the shared-config bug across the pasted files 10 times before reporting. The SHA-256 and SafeMoveFile areas were reviewed multiple times to ensure the recommendations address concrete failure modes.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Analysis Report"> <strong>Non-destructive policy & deliverables:</strong><br> - I will not modify files in your environment; I provide corrected module source for you to paste. Each module change preserves public function signatures and includes defensive logging and test stubs where applicable. Implement changes module-by-module on request.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Analysis Report"> <strong>Next steps for you (choose one):</strong><br> - Ask me to produce the corrected <strong>single</strong> module you want next (recommended: <code>modManifest.bas</code> or <code>modUtils.bas</code>). I will produce the full <code>.bas</code> text in a single copy-code block, preserve APIs, and include unit-test stubs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Analysis Report"> <strong>If you disagree with any finding:</strong><br> - Tell me which line/module you believe is correct; I will re-run focused checks on that portion and provide a tight justification or corrected code.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr></tbody></table></div><div class="row-count">Rows: 13</div></div><div class="table-caption" id="Table6" data-table="Docu_0146_06" style="margin-top:2mm;margin-left:3mm;"><strong>Table 6</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module Name</strong><br>modCalc.bas </td></tr><tr><td data-label="Technical Breakdown"> <strong>Purpose</strong><br>Central tax computation and gross-up solver for PPh21 payroll processing. Responsibilities: compute per-row tax flows (CalcRow), progressive and TER-based PPh21 (ComputePPh21, ComputePPh21ByTER), NPWP penalty application, rounding and floor rules (IndoRound, FloorToThousand), BPJS aggregation and precedence (SumEmployerBPJS, ComputeDeductionsTotal), TER table lookup & caching (LoadCachedTERTable, LookupTERRow), gross-up solver (SolveGrossUp), and small utilities (CloneDict, SafeGet, Parse helpers). Designed to be defensive, preserve public API signatures for compatibility, and tolerant to varied numeric/percent string formats. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Design Principles</strong><br>• Defensive API: public functions return safe fallback shapes (0, empty dictionaries, or error dictionaries) rather than raising unhandled errors.<br>• Stable public signatures: preserve function names and parameters used by modMain/modIO to avoid breaking callers.<br>• Tolerant parsing: ParseNumericStringToDouble, NzNumeric and ParseRateToFraction accept many textual/locale variants and default safely.<br>• Minimal external assumptions: TER tables loaded if present on "Rules" sheet, but module tolerates missing Rules and falls back to built-in progressive brackets.<br>• Non-destructive: CalcRow and SolveGrossUp clone input templates and never mutate caller templates. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API (observed & preserved)</strong><br>Public Function GetConfig() As Object — returns config dictionary singleton with defaults and placeholders (BRACKET_UPPERS, BRACKET_RATES, TER_TABLES).<br>Public Function CANONICAL_HEADERS() As Variant — returns canonical input header list.<br>Public Function SafeGet(dict As Object, key As String, defaultValue As Variant) As Variant — case-tolerant safe getter.<br>Public Function ComputeGrossTotal(row As Object) As Double — sums gross + optionally employer insurance + employer BPJS (per config).<br>Public Function ComputeDeductionsTotal(row As Object) As Double — sums employee-side deductions (BPJS components, pension, biaya_jabatan, other_deductions).<br>Public Function ComputePTKP(row As Object) As Double — maps PTKP status to annual PTKP values (defaults provided).<br>Public Function ComputePKP(grossTotal As Double, deductionsTotal As Double, ptkp As Double) As Double — computes annual PKP and floors to thousand.<br>Public Function ComputePPh21(pkp As Double) As Double — computes tax from configured brackets or fallback progressive brackets.<br>Public Function ApplyNPWPPenalty(tax As Double, hasNPWP As Boolean) As Double — applies NPWP penalty from config.<br>Public Function IndoRound(amount As Double, Optional roundTo As Long = 1) As Double — mid-point rounding rule controlled by config.<br>Public Function CalcRow(row As Object) As Object — central per-row computation returning a Dictionary with stable keys (PTKP, GrossTotal, DeductionsTotal, PKP, TaxBeforePenalty, TaxAfterPenalty, TaxRounded, Monthly_Withholding, RuleVersion, etc.). On error returns an error dictionary with "Error"=True and "Message".<br>Public Function SolveGrossUp(targetNet As Double, rowTemplate As Object, Optional maxIter As Long = 50, Optional tol As Double = 0.5) As Object — binary-search gross-up solver returning result dictionary containing ok,gross,iterations,finalTax,details.<br>Public Function ComputePPh21ByTER(row As Object, grossTotal As Double, pkp As Double) As Double — TER-based tax fallback to ComputePPh21 when TER not found.<br>Public Function CANONICAL_HEADERS() As Variant — stable headers for input normalization. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Numeric & boolean parsing behaviour</strong><br>• ParseNumericStringToDouble: tolerant numeric parser removing currency tokens ("Rp","rp"), whitespace and heuristically handles mixed '.' and ',' thousand/decimal separators (removes dots if both present and converts comma to dot). Returns 0 on unparseable input.<br>• NzNumeric: canonical numeric coercion returning 0 for objects/empty strings and ParseNumeric fallback for textual values.<br>• ParseRateToFraction: accepts "5%", "0.05", "5" — treats values ≤1 as fraction, values >1 as percent divided by 100; returns 0 on failure. </td></tr><tr><td data-label="Technical Breakdown"> <strong>BPJS aggregation & precedence</strong><br>• SumEmployerBPJS: precedence is explicit amount fields (bpjs_<em><em>emp) — they sum first; if total = 0 then percent fields (bpjs</em></em>_emp_pct) are applied to gross.<br>• ComputeDeductionsTotal: sums iuran_bpjs_employee and component fields and pension/biaya_jabatan/other_deductions. If employee-side components absent, an approximate percent-based fallback is attempted.<br>• Key integration behavior: caller must ensure EnsureBPJSColumns or similar upstream normalization. Module tolerates absent fields using SafeGet/NzNumeric. </td></tr><tr><td data-label="Technical Breakdown"> <strong>TER table lookup & caching</strong><br>• LoadCachedTERTable: lazy-loads static cached dictionary keyed "A".."D" from "Rules" worksheet ListObjects TER_A..TER_D when present. Each band is returned as a Dictionary with "GrossLow","GrossHigh","TER_percent" (fraction).<br>• LookupTERRow: selects band where grossTotal ∈ [GrossLow, GrossHigh) or GrossHigh ≤0 meaning open-ended. Returns Nothing if category or tables missing.<br>• ComputePPh21ByTER multiplies grossTotal by TER_percent (fraction). If TER lookup fails, falls back to ComputePPh21(pkp). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Rounding, PKP floor, PTKP mapping</strong><br>• FloorToThousand: uses Fix(value/1000)*1000 and clamps negative to zero.<br>• IndoRound: configurable midpoint rule (ROUNDMIDPOINTRULE default "AWAY_FROM_ZERO") with optional roundTo multiple. Uses Int((v/roundTo)+0.5) for AWAY_FROM_ZERO, else uses VBA.Round. Rounding rule read from GetConfig(). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Gross-up solver behaviour & limits</strong><br>• SolveGrossUp uses bisection between low (template gross) and high (max(low<em>3+1e6,targetNet</em>3+1e6)). Iterates up to maxIter (default 50), computes net = mid - deductions - monthly_withholding and compares to targetNet within tol (default 0.5).<br>• Returns dictionary: ok(Boolean), gross(Double), iterations(Long), finalTax(Double), details(Dictionary). On non-convergence returns ok=False and message "Convergence not achieved".<br>• Solver clones rowTemplate (CloneDict) to avoid side-effects. Convergence depends on CalcRow stability (deterministic rounding and NPWP penalty). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling policy</strong><br>• Module uses On Error GoTo ErrHandler on public functions; many private helpers use On Error Resume Next to probe COM objects. On error public functions return safe shapes or error dictionaries instead of raising exceptions. This prevents caller crashes but can hide root causes — increase verbosity during integration. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Dependency & contract gaps / integration risks</strong><br>• Config BRACKET_UPPERS/BRACKET_RATES contract: ComputePPh21 expects arrays for bracket uppers/rates; mismatch in array bounds or base (0-based vs 1-based) may silently produce incorrect tax. Standardize array base and document expected layout.<br>• TER table load depends on worksheet "Rules" and ListObjects named TER_A..TER_D. Absence leads to fallback; ensure modMain.LoadRules or external loader populates cfg("TER_TABLES") when TER mode is required.<br>• Rounding and floor choices (ROUNDMIDPOINTRULE, FloorToThousand) are configuration-sensitive — different defaults between environments yield materially different tax results. Explicitly set these in GetConfig() via modMain for reproducibility. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance & memory considerations</strong><br>• CalcRow constructs multiple dictionaries (out, optional DebugTrace) and calls NzNumeric/Parse helpers; acceptable for typical payroll sizes but expensive at large scale. Consider batch vectorized operations or native VBA arrays for very large workloads.<br>• SolveGrossUp runs CalcRow per iteration; worst-case 50 CalcRow calls per employee — heavy if invoked for many employees. Consider a numeric solver with analytic derivative or caching repeated intermediate values to reduce CalcRow calls. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security & data hygiene</strong><br>• Module does not log sensitive values itself but error dictionaries may flow to callers; callers must ensure logs/sheets sanitize NPWP/identifiers before export.<br>• Importantly, ParseNumericStringToDouble strips textual tokens but will coerce malformed inputs to 0 — review for silent data loss where input errors should instead surface as validation errors. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Immediate recommended fixes / hardening (minimal, high-impact)</strong><br>1. <strong>Standardize bracket array base and format.</strong> Document whether BRACKET_UPPERS/BRACKET_RATES are 0- or 1-based and provide an adapter routine (ConvertBracketsToZeroBased) used by modMain when loading rules.<br>2. <strong>Expose Load/Inject TER tables from modMain.</strong> Avoid implicit Rules sheet lookup as the only source — add a public SetTERTables(cfgTERTables) to populate config explicitly and make LookupTERRow solely rely on cfg("TER_TABLES").<br>3. <strong>Increase error visibility.</strong> Add optional cfg("VERBOSE_ERRORS") to cause CalcRow and LoadCachedTERTable to add a "ComputationNotes" entry or raise detailed log messages (via LogMsg provided by modUtils) rather than only returning safe shapes.<br>4. <strong>Limit SolveGrossUp cost.</strong> Add an early-exit if deductions or monthly tax are insensitive to gross (e.g., fixed deductions & flat TER) and add a caching layer for repeated CalcRow calls with identical gross bands.<br>5. <strong>Explicit numeric validation.</strong> Replace silent coercion-to-zero for critical input fields (gross, BPJS amounts, TER percents) with validation hooks that can mark rows as "InvalidInput" so upstream UI can correct them. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing & verification (10× checklist)</strong><br>1) <strong>CalcRow correctness:</strong> single-row inputs with known gross/deductions/ptkp produce expected PKP, TaxBeforePenalty and Monthly_Withholding compared to authoritative calculator for progressive mode.<br>2) <strong>TER mode parity:</strong> with cfg("CALC_MODE")="TER" and populated TER_TABLES, ComputePPh21ByTER and LookupTERRow pick correct band and compute gross*TER_percent; fall back to progressive when TER absent.<br>3) <strong>BPJS precedence:</strong> explicit employer BPJS amounts override percent fields; when amounts missing percents apply to gross — verify with samples where percent-only and amount-only appear.<br>4) <strong>Rounding & floor behavior:</strong> Verify FloorToThousand and IndoRound produce expected results for positive/negative and midpoint cases under both AWAY_FROM_ZERO and VBA.Round modes.<br>5) <strong>NPWP penalty:</strong> ApplyNPWPPenalty multiplies by (1+NPWP_PENALTY_PCT) only when hasNPWP=False; test with varied NPWP status strings triggering true/false. <br>6) <strong>SolveGrossUp convergence:</strong> For representative targetNet values verify SolveGrossUp converges within maxIter and produced gross yields net within tol; include edge-case where deductions depend on gross (iterative dependency).<br>7) <strong>TER table loading:</strong> LoadCachedTERTable correctly reads TER_A..TER_D ListObjects and converts percent strings to fractions using ParseRateToFraction; test with "5%", "0.05", "5".<br>8) <strong>Fault tolerance:</strong> CalcRow returns error dictionary (Error=True) rather than raising on missing fields or when config is absent; test corrupted inputs to ensure graceful failure and that error message contains Err.Number+Description.<br>9) <strong>Array / bracket mismatch:</strong> Test ComputePPh21 with externally supplied BRACKET_UPPERS/BRACKET_RATES arrays of varying bases and lengths to ensure no off-by-one or misaligned rates; include an integration test standardizing arrays before calling ComputePPh21.<br>10) <strong>Performance regression:</strong> Benchmark CalcRow and SolveGrossUp on realistic dataset (e.g., 10k rows and 100 gross-up requests) and measure runtime; ensure acceptable throughput or plan refactor. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational notes</strong><br>• Module uses late-bound Scripting.Dictionary to maintain portability; performance trade-offs vs native VBA collections are noted.<br>• ADVICE: Ensure modUtils supplies a LogMsg routine and modMain explicitly populates configuration (BRACKET arrays, TER_TABLES, ROUNDMIDPOINTRULE) for consistent cross-environment results.<br>• TER ListObject names are case-sensitive in this implementation (TER_A..TER_D) — standardize naming and/or provide fallback alias resolution. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Backward-compatibility & upgrade guidance</strong><br>• Public signatures preserved; replacing internals is safe but keep GetConfig keys stable: existing callers may set cfg("BRACKET_UPPERS"), cfg("BRACKET_RATES"), cfg("TER_TABLES"), cfg("NPWP_PENALTY_PCT"), cfg("CALC_MODE"), cfg("ROUNDMIDPOINTRULE").<br>• When upgrading, run the 10× tests with historical payroll samples and compare TaxRounded and Monthly_Withholding to prior release outputs to detect regressions. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Limitations & known issues</strong><br>• Silent coercion: ParseNumericStringToDouble and NzNumeric convert many invalid inputs to 0 which may hide data entry errors. Consider toggling validation during acceptance testing.<br>• TER reliance on sheet structure: LoadCachedTERTable reads ListObjects directly — workbook deployments that generate rules programmatically must call a public injector or reload the cached config to avoid stale cached values.<br>• SolveGrossUp uses simple bisection with fixed high bound heuristics (low*3+1e6) which may be conservative but could fail for exotic compensation structures; raise maxIter or implement adaptive bounds when necessary. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Immediate recommended tests to run now (practical, high-risk checks)</strong><br>• Run CalcRow on a canonical row with: gross=10,000,000; employee BPJS components present; employer BPJS amounts present; ptkp_status="tk/0" — verify PKP and TaxRounded agree to manual calculation.<br>• Swap cfg("CALC_MODE")="TER" and populate TER_TABLES with a band that covers gross=10,000,000 — verify ComputePPh21ByTER output changes appropriately.<br>• Run SolveGrossUp to reach a targetNet equal to gross minus deductions minus monthly withholding for a typical employee; confirm convergence and inspect iterations count.<br>• Deliberately feed malformed numeric strings ("1.234.567,89Rp", "five percent") to ParseRateToFraction and ParseNumericStringToDouble to confirm behavior and log cases that coerce to zero. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final acceptance criteria before production</strong><br>• Provide modMain integration that: (a) populates GetConfig() with BRACKET arrays in a documented base, (b) injects TER_TABLES explicitly or guarantees Rules sheet presence, (c) supplies modUtils LogMsg and error visibility toggles.<br>• Execute the 10× testing checklist with representative payroll data and verify outputs are bitwise-equal to the existing trusted implementation (or document and approve differences).<br>• Add explicit validation failures (not silent zeros) for critical input fields (gross, primary BPJS amounts, TER percents) during the acceptance run. </td></tr></tbody></table></div><div class="row-count">Rows: 20</div></div><div class="table-caption" id="Table7" data-table="Docu_0146_07" style="margin-top:2mm;margin-left:3mm;"><strong>Table 7</strong></div>
<div class="table-wrapper" data-table-id="table-7"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module Name</strong><br>modIO.bas </td></tr><tr><td data-label="Technical Breakdown"> <strong>Purpose</strong><br>Defensive Excel table & CSV I/O utilities for payroll pipeline. Responsibilities: read ListObject tables into in-memory dictionaries, read bracket/rate tables into 0-based numeric arrays, read params into normalized dictionaries, provide CSV streaming and atomic write (ADODB.Stream .tmp → final), import CSV into sheets via QueryTable with text-preservation heuristics and a fallback parser, expose CSV generator helper, and provide robust header validation. Designed to be defensive, late-bound, tolerant of varied formats, and minimally invasive to workbook structure. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Design Principles</strong><br>• Defensive fail-safe: functions log and return safe failure shapes (False, Nothing, empty dictionaries, empty arrays) rather than raising unhandled errors.<br>• Late-binding: uses ADODB.Stream, Scripting.Dictionary and QueryTable without compile-time references to increase portability.<br>• Lenient parsing: local ParseNumericStringToDoubleLocal, ParseRateToFractionLocal, and related helpers accept many textual/locale variants but prefer silent coercion to 0 for resilience.<br>• Non-destructive file operations: WriteCsvAtomic writes to .tmp, optionally strips BOM, then SafeMoveFile to final path with manifest hash logging. QueryTable import preserves text for sensitive columns and clears sheet before import.<br>• Defensive discovery: tries alternate ListObject names (tblPrefix and common alternates) and falls back to first-two-column heuristics for brackets. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API (observed & preserved)</strong><br>Public Function ReadTableToDicts(sheetName As String, tableName As String) As Object — returns Scripting.Dictionary keyed "0".."n-1" with each value a row Dictionary of header→value; returns Nothing on fatal error, empty dict for zero rows.<br>Public Function ReadBrackets(sheetName As String, tableName As String, uppers() As Double, rates() As Double) As Boolean — fills 0-based uppers() and rates() arrays; returns False on failure. Validates ascending uppers and warns about missing sentinel.<br>Public Function ReadParams(sheetName As String, tableName As String) As Object — returns UPPERCASED-key Dictionary of coerced typed values (numbers, booleans, strings) or empty dict when table missing.<br>Public Function WriteCsvAtomic(folderPath As String, fileName As String, csvGenerator As Object, Optional writeBOM As Boolean = False) As Boolean — accepts rows-generator dict or stream-provider object (NextChunk/EOF methods); writes UTF-8 via ADODB.Stream to .tmp, optionally strips BOM, then SafeMoveFile to final. Logs sha via modManifest if available.<br>Public Function ImportCsvToSheet(csvPath As String, sheetName As String, Optional preserveTextColumns As Boolean = True) As Boolean — imports via QueryTable (TextFilePlatform=65001) with preserve options for first two columns; on QueryTable failure falls back to ReadCsvToRows and array write.<br>Public Function ReadCsvToRows(csvPath As String, Optional preserveText As Boolean = False) As Object — robust CSV parser returning Dictionary of 0-based numeric keys → variant arrays; handles quotes, escaped quotes, CR/LF combos, and final-line tolerance.<br>Public Function ValidateHeaders(sheet As Worksheet, requiredHeaders As Variant) As Object — compares sheet headers (ListObject tblInput preferred, fallback to row1) to required set and returns dictionary {foundHeaders,missingHeaders,extraHeaders} or Nothing on missing required headers.<br>Public Function CsvStreamFromRows(dataRows As Object, headers As Variant) As Object — helper to produce the "rows" dictionary expected by WriteCsvAtomic. </td></tr><tr><td data-label="Technical Breakdown"> <strong>ReadTableToDicts behavior & shape</strong><br>• Validates sheet/table existence, allows alternate names (tbl + tableName). Logs and returns Nothing on fatal error.<br>• Extracts header names from header row into headers(1..colCount). Empty header cells become empty string (preserved) and shape preserved; caller must sanitize if header blanks unacceptable.<br>• Iterates DataBodyRange rows, skips entirely empty rows (robust emptiness checks considering dates/numbers/text), and preserves types: Date→CDate, Numeric→variant number, empty/Null preserved as Null, else coerced to String (important to keep NIP/NPWP intact).<br>• Returns dictionary with string keys "0","1",... mapping to per-row Scripting.Dictionary. If table has zero rows returns empty dictionary (not Nothing). </td></tr><tr><td data-label="Technical Breakdown"> <strong>ReadBrackets behavior & shape</strong><br>• Returns uppers() and rates() as 0-based arrays. ReDims to (0 To n-1) where n = data rows count. On failure reDims to empty (0 To -1) and returns False.<br>• Header discovery attempts many common header names for "upper" and "rate" (grossHigh/gross_high/upper_limit etc.). If not found, falls back to first two columns and emits WARN. Logs ERROR and returns False if still not resolvable.<br>• Parses each row with ParseNumericStringToDoubleLocal for uppers and ParseRateToFractionLocal for rates; enforces strictly ascending uppers else fails with ERROR to avoid silent mis-bracketing.<br>• Emits WARN if last upper looks small (expects sentinel large value for open-ended bracket). Caller must ensure sentinel convention if relied upon. </td></tr><tr><td data-label="Technical Breakdown"> <strong>ReadParams behavior & coercion</strong><br>• Reads two-column A/B param table into out dictionary keyed by UPPERCASE(key).<br>• Coerces numeric values and recognizes boolean-like strings via IsNumericStringBooleanLocal/ParseBooleanStringLocal; handles empty -> "" and textual pass-through for unrecognized values.<br>• Returns empty dictionary (not Nothing) when table absent; returns Nothing only on fatal error. Caller should normalize keys expected in GetConfig. </td></tr><tr><td data-label="Technical Breakdown"> <strong>WriteCsvAtomic implementation details</strong><br>• Validates folderPath/fileName and rejects parent-traversal (“..”). Ensures folder exists via modUtils.EnsureFolder.<br>• Supports two csvGenerator types: (a) Dictionary with type="rows" produced by CsvStreamFromRows containing headers array and rows dictionary; (b) Stream provider object supporting Init/NextChunk/EOF/Close methods accessed via CallByName. Logs ERROR and returns False if csvGenerator unrecognized.<br>• Writes text via ADODB.Stream (Type=2, Charset="utf-8"); writes header line then each row by escaping fields with EscapeCsvField.<br>• Saves to tmpPath then optionally strips UTF-8 BOM by binary read/write. Uses modUtils.SafeMoveFile to atomically move tmpPath→finalPath and modManifest.ComputeFileHash to log SHA256 when available. Cleans up tmp on failure. </td></tr><tr><td data-label="Technical Breakdown"> <strong>ImportCsvToSheet & fallback parser</strong><br>• Primary import: QueryTable with .TextFileParseType=xlDelimited, .TextFileCommaDelimiter=True, .TextFilePlatform=65001, and TextFileColumnDataTypes array where first two columns are set to Text to preserve nip/npwp. Refresh BackgroundQuery:=False then .Delete QueryTable object.<br>• If QueryTable.Add fails, falls back to ReadCsvToRows which reads file into memory and returns 0-based row arrays; then writes into a Variant 2D array and bulk-sets ws.Range(...).value for performance. Preserves text formatting for first two columns when preserveTextColumns=True.<br>• Creates sheet if missing and clears it before writing. Resilient to BOM. </td></tr><tr><td data-label="Technical Breakdown"> <strong>ReadCsvToRows parser specifics</strong><br>• Implements stateful character-by-character parse: handles quoted fields, embedded double-quote escaping (""→"), CRLF combos and lone LF/CR, and final-line without newline. Returns Scripting.Dictionary keyed "0".."n-1" with each value a zero-based Variant array of fields.<br>• Preserves exact field text (no numeric coercion) so callers can do locale-aware numeric parsing. Robust to trailing blank lines and unmatched quotes (finalizes field). </td></tr><tr><td data-label="Technical Breakdown"> <strong>ValidateHeaders behavior</strong><br>• Prefers ListObject "tblInput" header row; if absent falls back to first worksheet row scanning to last used column. Builds foundHeaders mapping UPPERCASE→index.<br>• Compares to requiredHeaders array, returns out dictionary with foundHeaders, missingHeaders, extraHeaders. If any required header missing logs ERROR and returns Nothing (caller must treat as fatal). </td></tr><tr><td data-label="Technical Breakdown"> <strong>CSV field escaping & helpers</strong><br>• EscapeCsvField: converts null/empty to "", doubles internal quotes, and quotes fields containing commas, CR/LF, or leading/trailing spaces.<br>• ParseNumericStringToDoubleLocal: local numeric parser strips "Rp"/"rp", removes dots and commas (aggressive) and spaces, then numeric check; returns 0 on failure — NOTE: this is more aggressive than modCalc's parser and will drop decimal separators. Use with caution where decimals matter.<br>• ParseRateToFractionLocal: supports trailing "%" -> converts to fraction, otherwise returns numeric value as-is (caller must interpret whether fraction or percent). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling policy</strong><br>• Public functions use On Error GoTo ErrHandler to log errors via modUtils.LogMsg and return safe shapes.<br>• Many probing operations use On Error Resume Next when interacting with COM (Worksheets, ListObjects, QueryTable) and clear Err to continue; this improves resilience but may obscure root causes. Consider toggling verbose error mode during acceptance testing. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Dependency & contract gaps</strong><br>• Relies on modUtils for LogMsg, EnsureFolder, JoinPath, SafeMoveFile, FileExists, DeleteFileIfExists. Absent implementations cause runtime failure — ensure modUtils is present and implements these contracts.<br>• Writes expect modManifest.ComputeFileHash to exist; missing modManifest only affects logging but not file correctness (logged SHA omitted).<br>• ParseNumericStringToDoubleLocal differs from modCalc.ParseNumericStringToDouble: modIO aggressively removes punctuation, which may lose decimals (risk if used upstream expecting fractional values). Standardize parsing across modules. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance & memory considerations</strong><br>• ReadTableToDicts and ReadCsvToRows build full in-memory structures — acceptable for typical payroll sizes but can cause memory pressure for very large files; WriteCsvAtomic supports streaming provider to avoid building full CSV string.<br>• Fallback ImportCsvToSheet builds an outArr 2D Variant then writes in one assignment (fast). QueryTable path avoids full memory build for large files. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security & data hygiene</strong><br>• ImportCsvToSheet deliberately preserves NIP/NPWP as Text to avoid Excel auto-formatting and potential information loss.<br>• Parse helpers silently coerce invalid numeric inputs to 0 — can hide data-quality issues. Sensitive identifiers are preserved as strings, but logs may include file paths or counts; ensure modUtils.LogMsg sanitizes outputs if required. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Immediate recommended fixes / hardening (minimal, high-impact)</strong><br>1. <strong>Unify numeric parsing with modCalc.</strong> Replace ParseNumericStringToDoubleLocal with a shared tolerant parser (same heuristics as ParseNumericStringToDouble) to avoid decimal loss and inconsistent behavior across modules.<br>2. <strong>Explicit header normalization.</strong> If ReadTableToDicts encounters empty header cells, assign deterministic names (e.g., "colN") and emit WARN — prevents fragile downstream key lookups.<br>3. <strong>Expose stricter validation modes.</strong> Add optional flags (e.g., cfg("STRICT_IO") or a parameter) to cause parse-failures to surface as errors rather than silent zeros during acceptance tests.<br>4. <strong>Stream interface unit tests.</strong> Provide a mock csvGenerator object implementing Init/NextChunk/EOF/Close to test WriteCsvAtomic streaming path and binary BOM strip logic.<br>5. <strong>Atomic move robustness.</strong> Add limited retries/exponential backoff around SafeMoveFile/DeleteFileIfExists to handle network share transient locks. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing & verification (10× checklist)</strong><br>1) ReadTableToDicts: table with headers and 0 rows returns empty dictionary; with rows returns correct count and preserves types (Date/Number/Text).<br>2) ReadTableToDicts: header blank cell replaced when upstream adapter applied; test that rowDict keys exist and values map correctly; detect behavior if headers duplicated or blank.<br>3) ReadBrackets: table with ascending uppers and mixed percent formats produces correct 0-based uppers() and rates() arrays; non-ascending uppers cause failure and empty outputs.<br>4) ReadParams: A/B param table coerces booleans and numeric-like strings; keys normalized to UPPERCASE and values typed; missing table returns empty dict.<br>5) WriteCsvAtomic (rows generator): writes correct CSV (escaped fields, header present) to tmp then moves to final; tmp removed on success; SHA logged when modManifest present.<br>6) WriteCsvAtomic (stream provider): mock provider returns chunks with UTF-8 and EOF true; verify file concatenation, BOM strip when writeBOM=False, and SafeMoveFile behavior.<br>7) ImportCsvToSheet: QueryTable path imports CSV with first two columns preserved as Text; fallback ReadCsvToRows correctly writes data into sheet and preserves commas inside quotes.<br>8) ReadCsvToRows: quoted fields with embedded quotes and CR/LF within fields parse to correct field values; final-line-without-newline handled correctly.<br>9) ValidateHeaders: missing required header triggers ERROR and function returns Nothing; foundHeaders mapping indices correct when using ListObject and row1 fallback.<br>10) Integration: end-to-end run of modMain orchestrating LoadParams → ReadBrackets → GetConfig population → ReadTableToDicts → modCalc.CalcRow → CsvStreamFromRows → WriteCsvAtomic; compare outputs against golden sample files for bitwise equality (where applicable) or numeric tolerance. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational notes</strong><br>• ADODB.Stream usage requires MS ActiveX Data Objects available; late-bound use avoids compile-time dependency but ensure target machines have ADO.<br>• QueryTable behavior varies slightly by Excel version/locale — set TextFilePlatform=65001 (UTF-8) as done here, and validate on target Excel installs.<br>• ListObject naming: ReadBrackets checks several alternates (tblBrackets, Brackets) — standardize workbook table names to remove ambiguity. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Backward-compatibility & upgrade guidance</strong><br>• Public signatures preserved; replace internals only behind same signatures. When upgrading, run the 10× checklist and ensure modCalc/modMain expectations for array bases (brackets 0-based) and header keys match modIO behavior.<br>• If changing numeric parsing semantics, coordinate simultaneous update of modCalc to avoid divergent tax computations. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Limitations & known issues</strong><br>• Aggressive local numeric parser (ParseNumericStringToDoubleLocal) strips punctuation and may eliminate decimal info — high risk when parsing fractional rates or decimals. Prefer unified parsing.<br>• WriteCsvAtomic stream-provider detection uses CallByName probe and assumes specific method names; non-conforming providers will be rejected — document provider contract.<br>• ValidateHeaders returns Nothing on missing required headers which callers may treat as fatal; ensure callers present user-friendly messages. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Immediate recommended tests to run now (practical, high-risk checks)</strong><br>• Test ReadCsvToRows with a CSV containing fields: <code>&quot;&quot;&quot;John, &quot;&quot;&quot;&quot;The Man&quot;&quot;&quot;&quot;&quot;, &quot;1.234.567,89Rp&quot;, &quot;text&quot;</code> to validate quoting and numeric preservation.<br>• Test WriteCsvAtomic with rows generator containing leading/trailing space fields and embedded quotes — verify proper quoting and no data truncation after BOM strip.<br>• Test ReadBrackets with upper values expressed as "50.000.000", "250000000" and rates as "5%", "0.15", "15" to validate ParseRateToFractionLocal behavior and ascending check.<br>• Run ImportCsvToSheet on a large UTF-8 CSV (100k rows) to compare QueryTable vs fallback performance and memory usage. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final acceptance criteria before production</strong><br>• Implement and verify shared numeric parsing with modCalc to avoid decimal loss.<br>• Provide modUtils with robust implementations for EnsureFolder, JoinPath, SafeMoveFile, FileExists, DeleteFileIfExists, and LogMsg; run integration harness verifying WriteCsvAtomic end-to-end (tmp→final + SHA log).<br>• Execute the 10× testing checklist with representative payroll and bracket/rules datasets and resolve any discrepancies; ensure bitwise or toleranced numeric parity with established baseline. </td></tr></tbody></table></div><div class="row-count">Rows: 23</div></div><div class="table-caption" id="Table8" data-table="Docu_0146_08" style="margin-top:2mm;margin-left:3mm;"><strong>Table 8</strong></div>
<div class="table-wrapper" data-table-id="table-8"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module Name</strong><br>modMain.bas </td></tr><tr><td data-label="Technical Breakdown"> <strong>Purpose</strong><br>Orchestrator for the payroll run: reads settings, initializes job environment, loads rules, reads input rows, delegates per-row processing to modCalc, writes CSV outputs and manifest, optionally imports outputs to workbook sheets, and performs best-effort cleanup on abort. Preserves public API signatures used by existing automation (pph21_RunAll, InitializeJob, LoadSettings, LoadRules, ReadInput, ProcessAllRows, WriteOutputs, GenerateManifest, ImportOutputsToSheets, AbortCleanup) and emphasizes non-destructive, defensive behavior and extensive logging via modUtils.LogMsg. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Module Version</strong><br>MODMAIN_VERSION = "2025-11-29-2-modified-verified" (kept for traceability). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Design Principles</strong><br>• Orchestration safety: fail fast on fatal errors but use non-destructive in-memory fallbacks where reasonable.<br>• Defensive probing: tries multiple naming conventions (tblInput / Input, tblBrackets / Brackets), supports both Function- and Sub-style ReadBrackets implementations, and tolerates missing optional modules with warnings.<br>• Stable public API: preserves signatures for backward compatibility with other modules (modIO/modCalc/modUtils/modManifest).<br>• Explicit logging: uses modUtils.LogMsg for INFO/WARN/ERROR/FATAL at each step to aid post-mortem.<br>• Minimal side-effects: writes JOB_ID non-destructively back to Settings sheet and uses a .lock file per job to signal ownership. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API (observed & preserved)</strong><br>Public Sub pph21_RunAll() — orchestrates entire job run with staged failure handling and finalization; writes LAST_JOB_ID & LAST_JOB_AT into in-memory settings.<br>Public Function InitializeJob(Optional providedJobId As String = "") As Boolean — validates or generates JOB_ID, writes JOB_ID into Settings sheet (non-destructive append/update), ensures job folder exists, creates atomic .lock via tmp→.lock, returns success boolean.<br>Public Function LoadSettings() As Object — wrapper around modUtils.ReadSettings("Settings") returning empty dictionary if absent (never returns Nothing except fatal error).<br>Public Function LoadRules() As Boolean — robustly loads brackets and params using modIO.ReadBrackets and modIO.ReadParams with multiple candidate names, populates modCalc.GetConfig() if available, and returns success boolean.<br>Public Function ReadInput() As Object — attempts modIO.ReadTableToDicts("Input","tblInput") with fallback to ("Input","Input"), validates headers against modCalc.CANONICAL_HEADERS() via modIO.ValidateHeaders and returns rows dictionary or Nothing on fatal mismatch.<br>Public Function ProcessAllRows(rows As Object, Optional resumeFrom As Long = -1) As Object — iterates rows, calls modCalc.CalcRow for each, preserves identifiers into outputs, returns resultContainer dictionary with keys "rows", "diagnostics", "processed_count".<br>Public Function WriteOutputs(results As Object) As Boolean — ensures job folder, produces stable headers, writes bukti_potong.csv and per11_payload.csv via modIO.CsvStreamFromRows + modIO.WriteCsvAtomic or deterministic fallback (manual tmp file & SafeMoveFile); logs completion and returns boolean.<br>Public Function GenerateManifest(jobFolder As String, jobId As String) As Boolean — delegates to modManifest.WriteManifest & VerifyManifest and returns boolean.<br>Public Function ImportOutputsToSheets(jobFolder As String) As Boolean — imports bukti_potong.csv into "Outputs" sheet via modIO.ImportCsvToSheet and returns boolean.<br>Public Sub AbortCleanup(errContext As String, Optional fatal As Boolean = True) — best-effort cleanup of .tmp files and lockfile; raises error if fatal to stop execution. </td></tr><tr><td data-label="Technical Breakdown"> <strong>High-value implementation details</strong><br>• pph21_RunAll: sequence = LoadSettings → EnsureSettingsKeysExist → EnsureFolder(OUTPUT_BASE) → InitializeJob(providedJobId) → reload settings → LoadRules → ReadInput → ProcessAllRows → WriteOutputs → GenerateManifest → optional ImportOutputsToSheets → final logging and lock removal.<br>• InitializeJob: validates providedJobId via regex ^job_\d{8}_\d{6}$; writes JOB_ID to Settings sheet (searches up to row 200 for existing key then update or append); persists in-memory settings; ensures job folder via modUtils.EnsureFolder; creates lock by writing .lock.tmp and calling modUtils.SafeMoveFile(tmp→.lock).<br>• LoadRules: tries multiple bracket table names; attempts function-style call to modIO.ReadBrackets returning Boolean, then sub-style call and inspects whether uppers() arrays populated; requires uppers & rates arrays populated; reads params from candidate table names and merges into config (via modCalc.GetConfig() if available) under keys BRACKET_UPPERS/BRACKET_RATES and param keys.<br>• ReadInput: calls modIO.ReadTableToDicts and then ValidateHeaders using modCalc.CANONICAL_HEADERS. Treats header mismatch as fatal (returns Nothing).<br>• ProcessAllRows: creates outputs dictionary keyed by original row key strings; for each row calls modCalc.CalcRow and augments outputs with identifiers (rowIndex, nip, npwp, name, period, gross) using NzSafe/NzNumericSafe helpers.<br>• WriteOutputs: composes headers Array("rowIndex","nip","npwp","name","period","gross","Monthly_Withholding","TaxRounded","PKP"); prefers modIO.CsvStreamFromRows + modIO.WriteCsvAtomic with writeBOM=True; fallback deterministic CSV writer uses Print # and manual escaping then SafeMoveFile. Also writes per11_payload.csv (either via WriteCsvAtomic or copy). Logs SHA via modManifest.ComputeFileHash when available. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling & logging policy</strong><br>• Top-level Sub pph21_RunAll uses On Error GoTo RunAllErr to capture unexpected exceptions and calls AbortCleanup on fatal failures.<br>• Functions use On Error GoTo ErrHandler pattern; many operations wrap COM probes with On Error Resume Next and explicit Err.Clear to allow detection and continue. <br>• Fatal conditions (missing OUTPUT_BASE after InitializeJob, missing ReadInput, WriteOutputs failure, manifest failure) cause immediate AbortCleanup and process termination; ImportOutputsToSheets failures are non-fatal and logged as WARN. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Dependencies & contracts</strong><br>• Strong runtime dependencies: modUtils (LogMsg, EnsureFolder, JoinPath, SafeMoveFile, FileExists, DeleteFileIfExists, ts), modIO (ReadBrackets, ReadParams, ReadTableToDicts, CsvStreamFromRows, WriteCsvAtomic, ImportCsvToSheet, ValidateHeaders), modCalc (CalcRow, CANONICAL_HEADERS, GetConfig), modManifest (WriteManifest, VerifyManifest, ComputeFileHash). Missing or non-conforming implementations of these functions will produce WARN/ERROR or fatal failures depending on the step.<br>• Assumes BRACKET arrays returned by ReadBrackets are 0-based and compatible with modCalc expectations; uses CallGetConfigIfExists to inject BRACKET_UPPERS/BRACKET_RATES into modCalc.GetConfig(). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Potential integration & runtime risks</strong><br>1. <strong>Race on lockfile creation/removal:</strong> InitializeJob creates .lock via tmp→.lock but no global lock guard or atomic filesystem semantics across network shares; deletion in AbortCleanup verifies owner by reading file — but ownership check relies on settings("JOB_ID") being current and matching file contents; concurrent runs or partial writes may lead to stale locks.<br>2. <strong>Settings persistence edge cases:</strong> InitializeJob writes JOB_ID to Settings sheet scanning only first 200 rows; if workbook uses different layout or uses a named table, update may append in unexpected locations; lack of workbook-level transaction may leave partially updated settings on error.<br>3. <strong>Fallbacks hiding errors:</strong> LoadSettings returns empty dict instead of Nothing; LoadRules tolerates missing TER/brackets by logging WARN but may leave config incomplete — later steps relying on BRACKET arrays will fail; debugging may be harder because some failures are converted to warnings rather than fatal errors early.<br>4. <strong>Array base mismatch risk:</strong> LoadRules injects arrays as returned by modIO.ReadBrackets; if array base differs (0 vs 1), modCalc.ComputePPh21 may produce incorrect tax — must standardize and document base contract.<br>5. <strong>Brittle header validation:</strong> ReadInput calls modIO.ValidateHeaders which returns Nothing if any required header missing — this is treated as fatal; variations in header spelling/casing/extra whitespace will abort run unless upstream normalization is enforced.<br>6. <strong>Err.Raise in AbortCleanup:</strong> when fatal, AbortCleanup does Err.Raise vbObjectError + 513 which will bubble; this is intentional but will crash automation if callers don't catch — acceptable for fatal but must be documented. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance & scalability considerations</strong><br>• ProcessAllRows calls modCalc.CalcRow per row and creates dictionaries for outputs — acceptable for typical payroll sizes but may be slow for very large datasets. Consider chunked processing or batching to reduce memory pressure.<br>• WriteOutputs prefers streaming via modIO.WriteCsvAtomic; fallback uses synchronous file writes. Large runs should be validated for memory and disk throughput. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security & data hygiene</strong><br>• JOB_ID generation uses timestamp string "job_yyyymmdd_hhnnss" which reveals run time but not sensitive data; lockfile contains JOB_ID in plain text.<br>• AbortCleanup enumerates job folder files and deletes *.tmp unconditionally (best-effort) — ensure that folder path construction (JoinPathSafe) cannot be coerced to unexpected locations by malicious settings. Validate OUTPUT_BASE prior to use. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Immediate recommended hardening (minimal, high-impact)</strong><br>1. <strong>Atomic lock semantics & retries:</strong> replace single SafeMoveFile with retry+exponential-backoff and validate atomic semantics on network shares. Consider using directory-level locking or OS-level advisory locks where available.<br>2. <strong>Stronger Settings persistence:</strong> write settings into a named, versioned ListObject or dedicated Settings table to avoid fragile row searches; limit scan to a named table rather than arbitrary rows 1..200.<br>3. <strong>Standardize bracket array base:</strong> add an adapter ConvertBracketsToZeroBased(uppers, rates) immediately after ReadBrackets and before injecting into modCalc.GetConfig(). Document contract so modIO and modCalc agree explicitly on base and length semantics.<br>4. <strong>Fail-fast for critical missing config:</strong> convert certain WARNs in LoadRules into fatal errors when CALC_MODE="progressive" or when BRACKET arrays needed; allow fallback only when verified acceptable.<br>5. <strong>Enhance header normalization:</strong> normalize header tokens (Trim/LCase/replace multiple spaces) before ValidateHeaders or provide a mapping table to accept common variants to reduce false positives. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing & verification (10× checklist)</strong><br>1) <strong>InitializeJob:</strong> supply valid providedJobId and invalid ones; verify JobIdIsValid behaviour, Settings sheet updated (update vs append), job folder created, .lock created atomically, and lock contents equal JOB_ID.<br>2) <strong>LoadSettings:</strong> simulate missing Settings sheet and verify LoadSettings returns empty dictionary (not Nothing) and logs a WARN; verify subsequent EnsureSettingsKeysExist populates defaults.<br>3) <strong>LoadRules (function & sub styles):</strong> test modIO.ReadBrackets implemented both as Function(Boolean) and as Sub that populates arrays — verify LoadRules detects both and populates config consistently. Confirm behavior when tables absent (should return False with logged ERROR).<br>4) <strong>Array base parity:</strong> inject sample uppers/rates as both 0-based and 1-based; ensure ConvertBracketsToZeroBased (if implemented) normalizes and ComputePPh21 in modCalc returns expected tax values for known PKP samples.<br>5) <strong>ReadInput & ValidateHeaders:</strong> create Input sheet variants with header casing/whitespace differences and confirm ValidateHeaders acceptance/failure behavior; verify that a missing required header returns Nothing and aborts run.<br>6) <strong>ProcessAllRows correctness:</strong> run with a small sample of rows, validate outputs keys exist and values from modCalc.CalcRow are preserved and identifiers (nip,npwp,name,gross) are attached when missing. Verify diagnostics entries for rows where CalcRow fails. <br>7) <strong>WriteOutputs + fallback:</strong> exercise both WriteCsvAtomic path and fallback manual writer; confirm tmp→final atomic move, BOM behavior (writeBOM=True), SHA logging if modManifest.ComputeFileHash present, and per11_payload creation. <br>8) <strong>GenerateManifest & VerifyManifest:</strong> run with modManifest present and absent; confirm GenerateManifest returns False when VerifyManifest fails and logs the issue. <br>9) <strong>AbortCleanup semantics:</strong> cause a partial failure mid-run, verify tmp files removed, lockfile deletion attempted only when owned by JOB_ID, and Err.Raise occurs for fatal flag. <br>10) <strong>End-to-end run:</strong> run pph21_RunAll on representative dataset (small and large), verify outputs bitwise-equal to golden files or within numeric tolerance, check log chronology, and validate no orphaned .tmp/.lock files remain. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational notes & deployment checklist</strong><br>• Ensure modUtils implements the file primitives used (EnsureFolder, JoinPath, SafeMoveFile, FileExists, DeleteFileIfExists, ReadSettings, LogMsg, ts).<br>• Ensure modIO and modCalc versions are the ones audited together — particularly agreement on bracket array base, header names, and numeric parsing semantics.<br>• Validate target Excel environment: QueryTable behavior, ADO availability, file system permissions on job folders and network shares (atomic move semantics differ across filesystems).<br>• Backup Settings sheet and Rules sheet before first production run to allow quick rollback if Settings row updates misbehave. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Limitations & known issues</strong><br>• Settings write loop only searches first 200 rows for JOB_ID — unusual Settings layouts beyond row 200 will cause appends that could confuse other tools.<br>• LoadRules tolerant behavior may mask missing critical configuration until late — prefer earlier fatal validation for bracket-dependent modes.<br>• Lockfile semantics assume exclusive job-run ownership but do not protect against simultaneous InitializeJob calls on distinct clients racing to create the same jobFolder on shared storage. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final acceptance criteria before production</strong><br>• Implement adapter to normalize bracket arrays base and verify ComputePPh21 parity with canonical calculator.<br>• Replace Settings sheet free-form write with a named Settings ListObject or well-defined cells; add unit tests to confirm InitializeJob updates/creates the expected cells reliably.<br>• Add retries and logging for SafeMoveFile/EnsureFolder operations and validate behavior on network shares; document required permissions.<br>• Run the 10× testing checklist end-to-end with representative payroll and manifest datasets and confirm file outputs, manifest verification, and cleanup behavior match acceptance thresholds. </td></tr></tbody></table></div><div class="row-count">Rows: 16</div></div><div class="table-caption" id="Table9" data-table="Docu_0146_09" style="margin-top:2mm;margin-left:3mm;"><strong>Table 9</strong></div>
<div class="table-wrapper" data-table-id="table-9"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module Name</strong><br>modManifest.bas </td></tr><tr><td data-label="Technical Breakdown"> <strong>Purpose</strong><br>Produce a deterministic JSON manifest for a job folder, compute and verify SHA-256 file hashes, and provide manifest verification utilities. Responsibilities: enumerate job-folder files (excluding manifest and .tmp), compute per-file SHA-256 (prefer platform certutil on Windows, fallback to ADODB.Stream + pure-VBA SHA-256), write manifest.json atomically (.tmp → final), parse minimal manifest JSON for verification, and expose VerifyManifest to confirm presence and integrity of listed files. Designed to be non-destructive, deterministic, and resilient across environments. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Version</strong><br>MODMANIFEST_VERSION = "2025-11-29-3" </td></tr><tr><td data-label="Technical Breakdown"> <strong>Design Principles</strong><br>• Deterministic output: files are sorted (QuickSortString) and manifest items written in deterministic order to produce reproducible manifests.<br>• Atomic writes: manifest.json written to manifest.json.tmp and moved atomically using modUtils.SafeMoveFile.<br>• Fast/robust hashing: attempt platform tool (certutil) first for reliability; fall back to in-process ADODB.Stream + SHA-256 when platform tool unavailable.<br>• Minimal dependencies: relies on modUtils (logging, file helpers) and Scripting/FileSystemObject/ADODB.Stream; avoids external JSON libraries by using small bespoke JSON routines sufficient for manifest structure.<br>• Defensive error handling: logs via modUtils.LogMsg and returns False/empty strings on failure rather than raising unhandled exceptions. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API (observed & preserved)</strong><br>Public Function WriteManifest(ByVal jobFolder As String, ByVal jobId As String, Optional ByVal includeImportErrors As Boolean = True) As Boolean — enumerate files, compute hashes/sizes/modified timestamps, build JSON manifest, write atomically, parse and verify manifest after write, return True on success.<br>Public Function ComputeFileHash(ByVal filePath As String) As String — returns lowercase hex SHA-256 of file or empty string on failure. Uses certutil when available; otherwise computes via ADODB.Stream + SHA256_Bytes fallback.<br>Public Function VerifyManifest(ByVal manifestPath As String) As Boolean — parses manifest.json, validates listed files exist and hashes match; logs errors and returns Boolean result. </td></tr><tr><td data-label="Technical Breakdown"> <strong>WriteManifest behavior & shape</strong><br>• Validates jobFolder exists; enumerates files with FileSystemObject but skips manifest.json and files ending with .tmp.<br>• Builds deterministic list: lowercased filenames used as keys in a Scripting.Dictionary, then sorted via QuickSortString producing keys array. For each file computes sha (ComputeFileHash), size (bytes), and modified_at (ISO8601 via FileModifiedISO8601).<br>• Builds minimal manifest JSON string with keys: job_id, generated_at (modUtils.ts()), files (array of objects with path, sha256, size_bytes, modified_at), total_size_bytes and optional import_error (null).<br>• Writes manifestJson to manifest.json.tmp using ADODB.Stream (UTF-8) then SafeMoveFile→manifest.json. If tmp creation or move fails, logs error and removes tmp if possible. After write, ParseManifestJson(manifest.json) is called and entries rechecked against on-disk hashes; any mismatch causes failure and logged ERROR. </td></tr><tr><td data-label="Technical Breakdown"> <strong>ComputeFileHash behavior & implementation</strong><br>• Primary: attempt to run Windows certutil via WScript.Shell Exec("cmd /c certutil -hashfile ""path"" SHA256") and parse StdOut for a 64-hex candidate; returns lowercase hex on success. Uses simple heuristics to strip spaces and pick first 64-hex token.<br>• Fallback: load file bytes using ADODB.Stream (Type=1 binary), stm.Read into a byte() array, then pass bytes to SHA256_Bytes (pure-VBA implementation) which returns byte[] of 32 bytes; convert to hex via BytesToHex. Returns empty string on any failure. Logs errors via modUtils.LogMsg. </td></tr><tr><td data-label="Technical Breakdown"> <strong>SHA-256 fallback specifics</strong><br>• Pure-VBA SHA implementation operates on full byte array, follows RFC/standard compression algorithm: message padding, big-endian 64-bit length, 512-bit chunk processing, 64-word schedule, and 64-round compression using SHA256_K and SHA256_H0 constants.<br>• Implements careful 32-bit arithmetic emulation: Add32, ToUInt32, ToLong32, ROR32, SHR32, XOR32, AND32, Not32 to emulate unsigned 32-bit behavior in VBA's signed Long space. Produces a 32-byte array returned by SHA256_Bytes and converted to lowercase hex with BytesToHex.<br>• Error conditions return empty byte array/empty string and log an error. </td></tr><tr><td data-label="Technical Breakdown"> <strong>ParseManifestJson & lightweight JSON parsing</strong><br>• ParseManifestJson opens manifestPath as UTF-8 via ADODB.Stream and reads text. It locates the "files" array by searching for the token """files""" and the following brackets; extracts the slice between the first '[' after "files" and the final ']'.<br>• Scans the block character-by-character tracking brace depth to extract each object text (matching { ... }) and passes each object string to JsonObjectToDict which parses minimal JSON objects expected in manifest (string values and unquoted tokens). ParseManifestJson returns a Dictionary with "files" => Collection of Dictionary objects representing each file entry.<br>• Note: parser is intentionally minimal and tailored to manifest structure; it is not a general-purpose JSON parser and assumes manifest format produced by WriteManifest. </td></tr><tr><td data-label="Technical Breakdown"> <strong>JsonObjectToDict specifics</strong><br>• Parses a single object text like <code>{&quot;path&quot;:&quot;x&quot;,&quot;sha256&quot;:&quot;y&quot;,...}</code> into a Scripting.Dictionary keyed by property names. Handles quoted string values with backslash escaping for <code>\&quot;</code> and simple unquoted token values. Skips unexpected structures gracefully returning Nothing on parse failure. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Utilities & helpers</strong><br>• FileModifiedISO8601(fullPath): returns file's DateLastModified formatted as <code>yyyy-mm-ddTHH:nn:ss</code> (note uses VBA format tokens and may reflect workbook locale/timezone).<br>• RelativePath(baseFolder, fullPath): if fullPath starts with baseFolder (case-insensitive), returns relative path; otherwise returns fullPath. Implementation expects trailing separators handled by caller.<br>• JsonEscape(s): escapes backslashes, quotes, and normalizes CR/LF to <code>\n</code> for inclusion in JSON strings.<br>• QuickSortString(arr(), low, high): in-place quicksort used to deterministically order filenames. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling policy</strong><br>• Functions use On Error GoTo ErrHandler to centralize logging via modUtils.LogMsg. Public functions return False (or empty string) on error, not runtime exceptions. Internal recoverable errors are logged and cause functions to abort gracefully. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Dependencies & contract gaps</strong><br>• Relies on modUtils for: LogMsg (required for all logging), FileExists/DeleteFileIfExists/JoinPath/SafeMoveFile(ts used for timestamps). Absence of modUtils will make the module log failures and potentially abort manifest operations.<br>• Relies on ADODB.Stream availability for UTF-8 text and binary IO. On systems lacking ADO, ComputeFileHash fallback and manifest write will fail.<br>• Assumes certutil available on PATH on Windows for the primary hashing path; otherwise falls back to in-process SHA. On non-Windows systems certutil step will typically be skipped; fallback will be used. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance & memory considerations</strong><br>• ComputeFileHash fallback reads entire file into memory (stm.Read → byte array). For very large files this increases memory usage. Prefer platform hashing (certutil) for large jobs to avoid memory pressure.<br>• SHA-256 pure-VBA is CPU-intensive in VBA and will be significantly slower than platform-native implementations; acceptable for small numbers of files but may be slow for many large files. Consider delegating hashing to external tools where performance matters. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security & data hygiene</strong><br>• Manifest includes file paths and SHA256 hashes; manifest generation and logging should be executed in a trusted environment. Manifest JSON is deterministic but contains no sensitive content beyond file paths and hashes — ensure jobFolder path does not expose secrets in logs.<br>• The module uses cmd/certutil via WScript.Shell.Exec which executes a shell command; ensure input file paths are trusted to avoid command injection risk. File paths are quoted but still treat inputs as trusted. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Known limitations & edge cases</strong><br>• Json parser limited: ParseManifestJson/JsonObjectToDict assume manifest produced by WriteManifest; additional JSON structures or unexpected spacing/formatting could break parsing.<br>• FileModifiedISO8601 uses <code>Format$(f.DateLastModified, &quot;yyyy-mm-dd&quot;&quot;T&quot;&quot;HH:nn:ss&quot;)</code> — note that VBA "mm" in date formats is month, "nn" minutes; ensure formatting is correct for target locales. (Implementation uses "mm" for month and "nn" for minutes which is correct in VBA.)<br>• RelativePath slicing assumes baseFolder matches leading characters of fullPath; trailing slash handling may produce leading path separator in result — callers should handle or canonicalize paths beforehand. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Immediate recommended hardening (minimal, high-impact)</strong><br>1. <strong>Certutil safety & fallback:</strong> detect platform (Windows) explicitly before attempting certutil; if using Exec, capture exit code and StdErr robustly. Consider quoting and validating filePath to mitigate injection risk.<br>2. <strong>Stream large-file handling:</strong> for fallback hashing implement chunked read (streaming) into SHA256 update rather than single stm.Read to avoid large memory spikes. If chunked hashing not feasible in VBA, prefer certutil for files > X MB.<br>3. <strong>Robust JSON parsing:</strong> replace ad-hoc ParseManifestJson/JsonObjectToDict with a small, well-tested JSON parser or add stricter validation/escaping expectations and unit tests for edge cases (extra whitespace, unexpected ordering, nulls).<br>4. <strong>Canonicalize paths:</strong> ensure jobFolder and file paths are normalized (remove trailing separators consistently) before RelativePath and comparisons to avoid subtle mismatches during verification. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing & verification (10× checklist)</strong><br>1) <strong>WriteManifest end-to-end:</strong> create temporary job folder with sample files (text, binary), run WriteManifest and confirm manifest.json exists, contains expected number of file entries, and VerifyManifest returns True.<br>2) <strong>ComputeFileHash (certutil path):</strong> on Windows with certutil present, call ComputeFileHash on a sample file and compare to certutil output run externally to confirm parsing correctness.<br>3) <strong>ComputeFileHash (fallback):</strong> temporarily disable certutil or test on non-Windows; verify fallback SHA matches a trusted implementation (e.g., Python/OpenSSL) for several files including empty file, small text, and larger binary.<br>4) <strong>Manifest verification mismatch detection:</strong> write manifest with intentionally wrong sha256 for one file and confirm VerifyManifest logs the mismatch and returns False.<br>5) <strong>Manifest atomicity:</strong> interrupt SafeMoveFile or simulate failure after tmp write and confirm manifest.json not left in partial state and tmp cleaned up on failure path. <br>6) <strong>ParseManifestJson robustness:</strong> produce manifests with whitespace/linebreak variants and confirm parser extracts file objects correctly; also test with unexpected properties present. <br>7) <strong>File enumeration exclusions:</strong> ensure manifest excludes manifest.json and files with .tmp suffix and includes other files — test with mixed-case and different extensions. <br>8) <strong>Large file performance:</strong> test ComputeFileHash fallback performance on a large file (e.g., multiple hundreds of MB) and measure memory/cpu; verify behavior acceptable or document limits. <br>9) <strong>Cross-platform behavior:</strong> on non-Windows environments (if used) confirm certutil path skipped and fallback works; on Windows confirm cmd invocation returns expected StdOut format parsed by code. <br>10) <strong>Concurrency & idempotence:</strong> run WriteManifest twice in succession and confirm second run either overwrites manifest deterministically and verification passes, and no leftover tmp files remain. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational notes & deployment checklist</strong><br>• Ensure modUtils implements required file primitives and ts timestamp function; manifest depends heavily on modUtils.SafeMoveFile and FileExists.<br>• Ensure ADODB is available on target Excel host (ADO/MDAC) for stream operations; otherwise manifest write and fallback hashing will fail.<br>• On Windows prefer certutil available in PATH; otherwise plan for slower fallback. Document expected runtime and memory characteristics for large jobs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Limitations & recommended acceptance criteria before production</strong><br>• Replace ad-hoc JSON parsing with a vetted JSON library or expand unit tests to cover all manifest formatting variants the system might produce/consume.<br>• Implement chunked SHA-256 processing to avoid reading very large files entirely into memory in the fallback path.<br>• Run the 10× testing checklist above and confirm bitwise parity of SHA-256 outputs with an external reference implementation for all files in representative job folders. </td></tr></tbody></table></div><div class="row-count">Rows: 20</div></div><div class="table-caption" id="Table10" data-table="Docu_0146_10" style="margin-top:2mm;margin-left:3mm;"><strong>Table 10</strong></div>
<div class="table-wrapper" data-table-id="table-10"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module Name</strong><br>modUtils.bas </td></tr><tr><td data-label="Technical Breakdown"> <strong>Purpose</strong><br>General filesystem, timing, logging, and settings helpers used across the pipeline. Responsibilities: timestamp generation, path joining, folder/file existence and atomic operations (EnsureFolder, DeleteFileIfExists, SafeMoveFile), logging with masking (LogMsg), ReadSettings, and retry/backoff semantics. Designed to be defensive, non-destructive, and preserve public signatures for backward compatibility. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Version</strong><br>MODUTILS_VERSION = "2025-11-29-3" </td></tr><tr><td data-label="Technical Breakdown"> <strong>Design Principles</strong><br>• Defensive I/O with retries/backoff: DeleteFileIfExists and SafeMoveFile implement configurable retry attempts and delays (defaults and runtime overrides from Settings).<br>• Non-destructive defaults: file-existence checks return booleans; ensure routines return success/failure rather than raising unhandled errors.<br>• Logging & data-hiding: LogMsg writes timestamped rows to a Logs sheet and MaskSensitive obscures long digit strings (e.g., IDs).<br>• Late-bound, portable: uses FileSystemObject, ADODB.Stream, VBScript.RegExp and kernel32 Sleep declared PtrSafe for Win64; avoids compile-time references. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API (observed & preserved)</strong><br>Public Function ts() As String — timestamp string <code>yyyy-mm-dd hh:nn:ss</code> (fallback format on error).<br>Public Function JoinPath(a As String, b As String) As String — canonical path join with "\" separator normalization.<br>Public Function EnsureFolder(folderPath As String) As Boolean — create folder if missing; returns success boolean.<br>Public Function FileExists(path As String) As Boolean — wrapper around FileSystemObject.FileExists.<br>Public Function DeleteFileIfExists(path As String) As Boolean — robust deletion with retries, read-only attribute clearance, and final-resort temp write deletion attempts.<br>Public Function SafeMoveFile(src As String, dst As String) As Boolean — atomic-safe move with fast rename attempt, retries, ADODB.Stream copy to tmp, hash/size verification (uses modManifest.ComputeFileHash), deletion of source, tmp→dst rename or copy fallback; returns boolean.<br>Public Function LogMsg(logsSheetName As String, msg As String, Optional level As String = "INFO") As Boolean — append masked log row to workbook sheet, creates sheet if missing.<br>Public Function ReadSettings(settingsSheetName As String) As Object — reads up to first 100 rows of a sheet into UPPERCASE-keyed Dictionary coercing booleans and numeric-like strings.<br>Public Sub SleepMs(ms As Long) — cross-version Sleep wrapper (kernel32). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Timestamp & JoinPath details</strong><br>• ts(): constructs timestamp parts via Year/Month/Day/Hour/Minute/Second and formats <code>yyyy-mm-dd hh:nn:ss</code>. Fallback to Format$(Now, ...) on error.<br>• JoinPath(): trims inputs, returns b when a empty (and vice versa); uses backslash as separator; normalizes duplicate slashes/backslashes. </td></tr><tr><td data-label="Technical Breakdown"> <strong>EnsureFolder & FileExists behavior</strong><br>• EnsureFolder: trims path, uses FileSystemObject.CreateFolder when missing, logs an ERROR via LogMsg on CreateFolder failure and returns False. Non-recursive creation (relies on FSO to create single folder).<br>• FileExists: returns False for empty path, delegating to FSO otherwise. </td></tr><tr><td data-label="Technical Breakdown"> <strong>DeleteFileIfExists implementation & edge-cases</strong><br>• Configurable retries: default attempts=3, retryDelayMs=250ms; reads overrides from ReadSettings("Settings") keys RETRY_ATTEMPTS and RETRY_DELAY_MS when present.<br>• Sequence: if file exists, loop attempts to fso.DeleteFile; on failure logs WARN and SleepMs; then clear ReadOnly attribute and try delete; final attempts include writing a tiny tmp file and retry deletion; cleans up tmp file if present.<br>• Best-effort returns True if file ultimately absent; returns False and logs ERROR on final failure. Handles COM errors defensively (On Error Resume Next in probes). </td></tr><tr><td data-label="Technical Breakdown"> <strong>SafeMoveFile algorithm & guarantees</strong><br>• Fast-path: attempt Name src As dst (rename) — succeeds on same-volume moves; returns True immediately.<br>• If rename fails (cross-volume or locked file), falls back to copy semantics: constructs dst folder (creates if missing), ensures dst removed, copies src→tmpDst via ADODB.Stream (binary), verifies copy either by SHA-256 comparison (modManifest.ComputeFileHash) or by comparing sizes when hashes unavailable; if verified, deletes src and attempts Name tmpDst As dst; if rename fails, attempts binary copy tmpDst→dst via ADODB.Stream and verifies final hash/size; cleans tmpDst and returns True on success.<br>• Retries: repeats copy/verify/delete sequence up to configured retryAttempts with retryDelayMs between attempts; cleans up tmpDst on exhaustive failure and logs firstErr for diagnostics.<br>• Guarantees: attempts to avoid partial-destination exposure; uses tmpDst naming convention <code>dst + &quot;.tmp&quot;</code> and final rename to make final file appear atomically when filesystem supports atomic renames. Verification step mitigates corruption. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Logging (LogMsg) & masking</strong><br>• Creates Logs sheet if missing, writes header row on empty sheet: Timestamp, Level, Message, Context.<br>• Uses MaskSensitive to hide long digit sequences (Regex <code>(\d{8,20})</code>) replacing most digits with 'X' while keeping trailing 4 characters. This prevents accidental leakage of long numeric identifiers in log text.<br>• Application.ScreenUpdating toggled off during writes for performance; minimal context column written as empty string. </td></tr><tr><td data-label="Technical Breakdown"> <strong>ReadSettings parsing rules</strong><br>• Reads up to 100 rows from provided sheet name; if sheet missing returns empty Dictionary and logs WARN.<br>• Normalizes keys to UPPERCASE and coerces values: numeric variants preserved, strings trimmed; recognizes "true"/"false" (case-insensitive) -> Boolean; detects numeric-like strings via IsNumericString helper and converts using ParseNumericLike; otherwise stores raw string or variant. Intended to provide runtime overrides for retry parameters and feature flags. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Private helpers & parsing utilities</strong><br>• MaskSensitive(txt): VBScript.RegExp to find long digit sequences and mask them preserving last 4 digits (configurable keep variable).<br>• SleepMs(ms): PtrSafe Sleep for VBA7 and fallback; centralizes sleep to allow unit testing or replacement.<br>• IsNumericString(s): aggressive cleaning removing '.', ',', 'Rp' then IsNumeric check — used by ReadSettings to detect numeric-like strings.<br>• ParseNumericLike(s): removes currency tokens and thousands separators, converts comma->dot for decimals then CDbl when numeric; returns 0 on failure. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Dependencies & external interactions</strong><br>• Uses Scripting.FileSystemObject and ADODB.Stream — requires these runtime COM components to be available (late-bound use avoids compile reference but runtime must support them).<br>• Uses kernel32 Sleep (Windows). Module is Windows-centric; Sleep declaration and WScript/ADODB usage assume Windows-hosted Excel. Cross-platform Excel runtimes (Mac) will fail on Sleep/ADODB or require adaptation.<br>• SafeMoveFile and DeleteFileIfExists call modManifest.ComputeFileHash for verification; modManifest must be present and its ComputeFileHash callable. Missing modManifest weakens verification: SafeMoveFile falls back to size comparison but logs accordingly. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling policy</strong><br>• Every public function uses On Error GoTo ErrHandler and returns safe fallback values (False/True as appropriate). Many internal probes use On Error Resume Next to tolerate missing COM objects or workbook sheets and then examine Err to log and continue. This increases resilience at the cost of potentially hiding root cause—use VERBOSE logs during acceptance testing. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational risks & known issues</strong><br>1. <strong>Windows-only assumptions:</strong> PtrSafe Sleep, ADODB.Stream, and command-line certutil usage (via modManifest) are Windows-focused; running on non-Windows Excel will break or require polyfills.<br>2. <strong>Folder creation edge cases:</strong> EnsureFolder calls CreateFolder for single folder only; if parent path missing this may fail — consider recursive creation or CreateFolder on parent chain.<br>3. <strong>Race conditions on SafeMoveFile:</strong> concurrent processes writing to same dstFolder may race; the algorithm uses tmpDst and verification but does not obtain exclusive filesystem locks — on network shares behavior may be non-atomic and subject to race/locking semantics of underlying filesystem.<br>4. <strong>Silent masking & log truncation risk:</strong> MaskSensitive uses a coarse regex; may mask intended diagnostic digits or miss non-digit secrets; careful in logs that need full identifiers for forensic debugging. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Immediate recommended hardening (minimal, high-impact)</strong><br>1. <strong>Canonicalize & validate paths early:</strong> add normalization (Trim, Remove trailing separators, Resolve relative components) before file ops to prevent accidental wrong-folder operations. <br>2. <strong>Recursive EnsureFolder:</strong> implement folder creation with recursive parent creation to handle nested job folder paths robustly. <br>3. <strong>Expose configurable max tmp age & cleanup policy:</strong> add config-driven retention policy for orphaned <code>.tmp</code> files and log retention. <br>4. <strong>Stricter verification option:</strong> allow callers to require SHA verification (fail if modManifest not present) vs lenient size-only fallback; expose via ReadSettings flag (e.g., FORCE_HASH_VERIFICATION).<br>5. <strong>Platform guard & fallbacks:</strong> detect non-Windows environments and return clear error or provide alternate Sleep implementation and avoid ADODB-dependent code paths. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing & verification (10× checklist — run before production)</strong><br>1) Ensure ts() returns expected format and does not error across locales/timezones.<br>2) JoinPath tests: empty a/b, trailing slashes, mixed separators, verify deduplication of slashes/backslashes.<br>3) EnsureFolder: create non-existing nested path (with recursive change if implemented) and assert folder exists; test permission-denied scenario logs error.<br>4) DeleteFileIfExists: test deleting a normal file, read-only file, file locked by another process (simulate), and non-existing file; confirm retry behavior and log entries. <br>5) SafeMoveFile fast-path: move within same volume (Name succeeds) and verify returned True and dst exists and src gone. <br>6) SafeMoveFile cross-volume: simulate by copying to a different folder requiring copy+rename; verify tmp copy created, hash/size verification succeeds, src removed, dst present, tmp cleaned. <br>7) SafeMoveFile failure modes: simulate destination locked/unwritable and confirm retries exhausted, tmp cleanup, and proper ERROR log. <br>8) LogMsg: ensure Logs sheet created, header row added, MaskSensitive masks long digit sequences but preserves last 4 characters; verify Performance with many log lines. <br>9) ReadSettings: create settings sheet with numeric strings, "true"/"false", currency-like strings and verify proper coercion and key normalization to UPPERCASE. <br>10) Integration: run modMain scenario where SafeMoveFile is exercised by WriteCsvAtomic and modManifest is available/unavailable to observe size vs hash verification fallback. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational checklist before deployment</strong><br>• Verify presence of ADODB and Scripting runtime components on deployment hosts. <br>• Confirm Excel/VBA host is Windows and kernel32 Sleep is available; if Mac, supply platform-specific Sleep and ADODB fallbacks.<br>• Ensure modManifest is present and ComputeFileHash tested on target environment to enable SafeMoveFile verification path. <br>• Populate Settings sheet with RETRY_ATTEMPTS and RETRY_DELAY_MS as desired for network shares and heavy-load environments. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Limitations & acceptance criteria</strong><br>• Accept only after running the 10× checklist above and confirming SafeMoveFile/WriteCsvAtomic interop works on target filesystem (local and network).<br>• Consider adding unit/integration tests that simulate concurrent runs to detect race conditions on lock/tmp files. </td></tr></tbody></table></div><div class="row-count">Rows: 19</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>