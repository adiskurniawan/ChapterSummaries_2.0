<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1764444728">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0146_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **TER Calculation (PPh 21)**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>TER Calculation (PPh 21)</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="TER Calculation (PPh 21)"><div class="tv-left-col"><div class="left-col-heading"><strong>Definition &amp; Purpose</strong><br/>TER = Tarif Efektif Rata-rata. Simplifies monthly PPh 21 withholding by applying a fixed effective monthly rate per taxpayer status instead of full progressive annual computation each month. Ensures predictable monthly withholding while final annual liability is reconciled at year-end.</div></div></td></tr><tr><td data-label="TER Calculation (PPh 21)"><div class="tv-left-col"><div class="left-col-heading"><strong>Legal basis</strong><br/>Implemented under PP No. 58/2023 and related PMK (e.g., PMK 168/2023); adopted to reduce withholding complexity and standardize monthly tax capture.</div></div></td></tr><tr><td data-label="TER Calculation (PPh 21)"><div class="tv-left-col"><div class="left-col-heading"><strong>When TER applies</strong><br/>Monthly payroll for eligible employees (regular monthly-paid employees). TER used for regular months; the final month of the tax year or final month of employment uses the standard progressive annualized method for reconciliation.</div></div></td></tr><tr><td data-label="TER Calculation (PPh 21)"><div class="tv-left-col"><div class="left-col-heading"><strong>Primary inputs required</strong><br/>• Employee PTKP/status (e.g., TK/0, K/1) → maps to TER category.<br/>• Gross monthly taxable income (salary + taxable allowances + overtime + taxable in-kind + bonuses/THR if paid that month).<br/>• Flags: gross-up present, BPJS treatment, final-month indicator.</div></div></td></tr><tr><td data-label="TER Calculation (PPh 21)"><div class="tv-left-col"><div class="left-col-heading"><strong>TER rate determination</strong><br/>Lookup TER percentage by PTKP/status (and by TER category A/B/C where defined). Accurate implementation requires the official TER rate table from regulation or authoritative source.</div></div></td></tr><tr><td data-label="TER Calculation (PPh 21)"><div class="tv-left-col"><div class="left-col-heading"><strong>Monthly withholding calculation</strong><br/>Withheld tax = TER_rate × gross_monthly_taxable_income. Apply gross-up adjustments beforehand if employer pays tax on behalf of employee.</div></div></td></tr><tr><td data-label="TER Calculation (PPh 21)"><div class="tv-left-col"><div class="left-col-heading"><strong>Year-end / final month reconciliation</strong><br/>Final month uses full PPh 21 annualization: compute annual taxable income, subtract PTKP, apply progressive rates, compute total annual tax, subtract cumulative monthly withholdings to date → result is final adjustment (additional withholding or refund).</div></div></td></tr><tr><td data-label="TER Calculation (PPh 21)"><div class="tv-left-col"><div class="left-col-heading"><strong>Handling irregular payments (bonus/THR)</strong><br/>Irregular payments included in the gross for the month they are paid; TER rate applies for that month unless regulation or employer policy requires separate treatment. Final reconciliation still corrects total liability.</div></div></td></tr><tr><td data-label="TER Calculation (PPh 21)"><div class="tv-left-col"><div class="left-col-heading"><strong>Gross-up (tax grossing) considerations</strong><br/>If gross-up is requested, compute the gross amount inclusive of tax so net to employee meets target. Gross-up changes the taxable base and therefore influences TER × gross calculation; handle iteratively or with algebraic gross-up formula.</div></div></td></tr><tr><td data-label="TER Calculation (PPh 21)"><div class="tv-left-col"><div class="left-col-heading"><strong>Excluded or special cases</strong><br/>• Non-monthly workers, certain contractors, or other non-eligible categories may not use TER and must follow progressive withholding rules.<br/>• Daily workers with specific thresholds, expatriates, or employees with special tax treatments require separate handling per regulation.</div></div></td></tr><tr><td data-label="TER Calculation (PPh 21)"><div class="tv-left-col"><div class="left-col-heading"><strong>Validation &amp; edge checks</strong><br/>• Verify PTKP/status mapping exists for employee.<br/>• Validate gross components (ensure taxable items are included/excluded correctly).<br/>• Detect final-month condition to switch calculation method.<br/>• If gross-up flag set, ensure gross-up calculation converges and does not produce negative/invalid amounts.</div></div></td></tr><tr><td data-label="TER Calculation (PPh 21)"><div class="tv-left-col"><div class="left-col-heading"><strong>Implementation notes (high level, no code)</strong><br/>• Keep TER rate table external and versioned (source/regulation + effective date).<br/>• Implement two flows: monthly TER flow and final-month progressive reconciliation flow.<br/>• Log inputs and intermediate values for auditability; mask sensitive identifiers in logs.<br/>• Provide configurable flags for gross-up, BPJS handling, and final-month enforcement.</div></div></td></tr><tr><td data-label="TER Calculation (PPh 21)"><div class="tv-left-col"><div class="left-col-heading"><strong>Testing checklist</strong><br/>• Unit tests for TER lookup by status.<br/>• Tests for pure TER months with varying gross compositions.<br/>• Gross-up scenarios with convergence/edge tests.<br/>• Final-month reconciliation tests comparing cumulative TER with full annual progressive computation to confirm adjustments.<br/>• Regression tests when TER table or PMK updates.</div></div></td></tr><tr><td data-label="TER Calculation (PPh 21)"><div class="tv-left-col"><div class="left-col-heading"><strong>Limitations &amp; risks</strong><br/>• TER simplifies withholding but can under/over-withhold during the year; reconciliation required.<br/>• Accuracy depends on maintaining up-to-date TER rate tables and correct PTKP mappings.<br/>• Misclassification of employee status or omitted taxable components can create material discrepancies.</div></div></td></tr><tr><td data-label="TER Calculation (PPh 21)"><div class="tv-left-col"><div class="left-col-heading"><strong>Next steps (if desired)</strong><br/>Options: <br/>(a) provide a formal TER rate table parsed from regulation, <br/>(b) produce a production-ready function for monthly TER withholding, or <br/>(c) produce test cases and reconciliation checks. Indicate which you want implemented.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 15</div></div><div class="table-caption" id="Table2" data-table="Docu_0146_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **Formal TER rate table (parsed from PP 58/2023 lampiran &amp; PMK-168/2023)**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Formal TER rate table (parsed from PP 58/2023 lampiran &amp; PMK-168/2023)</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Formal TER rate table (parsed from PP 58/2023 lampiran &amp; PMK-168/2023)"><div class="tv-left-col"><div class="left-col-heading"><strong>Source &amp; scope</strong><br/>This table reproduces the structure and official counts from <strong>Peraturan Pemerintah Nomor 58 Tahun 2023 (Lampiran A/B/C/D)</strong> as implemented by <strong>PMK 168/2023</strong>. The lampiran contains <strong>127</strong> TER entries in total: <strong>44</strong> TER Bulanan (Kategori A), <strong>40</strong> TER Bulanan (Kategori B), <strong>41</strong> TER Bulanan (Kategori C), and <strong>2</strong> TER Harian. See the official regulation PDFs for the authoritative numeric bands and percentages.</div></div></td></tr><tr><td data-label="Formal TER rate table (parsed from PP 58/2023 lampiran &amp; PMK-168/2023)"><div class="tv-left-col"><div class="left-col-heading"><strong>TER Harian (complete, from Lampiran D — 2 entries)</strong><br/>• <strong>Penghasilan bruto harian ≤ Rp450.000</strong> — <strong>TER = 0%</strong> (0 × penghasilan bruto harian).<br/>• <strong>Penghasilan bruto harian &gt; Rp450.000 sampai dengan Rp2.500.000</strong> — <strong>TER = 0.5%</strong> (0.5% × penghasilan bruto harian).</div></div></td></tr><tr><td data-label="Formal TER rate table (parsed from PP 58/2023 lampiran &amp; PMK-168/2023)"><div class="tv-left-col"><div class="left-col-heading"><strong>TER Bulanan — structure &amp; how to use (Lampiran A/B/C)</strong><br/>• Each TER Bulanan lampiran (A, B, C) is a stepped table: a sequence of income <em>lapisan</em> (monthly gross ranges) mapped to a single TER percentage for that band. The employer selects the band according to the employee’s <strong>status PTKP</strong> (mapping to Kategori A, B, or C) and the employee’s <strong>gross monthly</strong> amount, then computes <strong>monthly withholding = TER% × gross_monthly</strong>.</div></div></td></tr><tr><td data-label="Formal TER rate table (parsed from PP 58/2023 lampiran &amp; PMK-168/2023)"><div class="tv-left-col"><div class="left-col-heading"><strong>Kategori mapping (PTKP → TER category)</strong><br/>• <strong>Kategori A</strong> — PTKP statuses: TK/0; TK/1; K/0. (Lampiran A — 44 bands).<br/>• <strong>Kategori B</strong> — PTKP statuses: TK/2; TK/3; K/1; K/2. (Lampiran B — 40 bands).<br/>• <strong>Kategori C</strong> — PTKP status: K/3. (Lampiran C — 41 bands). Use the mapping to choose the correct Lampiran.</div></div></td></tr><tr><td data-label="Formal TER rate table (parsed from PP 58/2023 lampiran &amp; PMK-168/2023)"><div class="tv-left-col"><div class="left-col-heading"><strong>Representative sample (TER Bulanan — Kategori A, initial bands)</strong><br/>(these example bands are reproduced exactly as shown in the regulation lampiran summaries):<br/>• Rp 0 – Rp 5,400,000 → <strong>0%</strong>.<br/>• &gt; Rp 5,400,000 – Rp 5,650,000 → <strong>0.25%</strong>.<br/>• &gt; Rp 5,650,000 – Rp 5,950,000 → <strong>0.50%</strong>.<br/>• &gt; Rp 5,950,000 – Rp 6,300,000 → <strong>0.75%</strong>.<br/>• &gt; Rp 6,300,000 – Rp 6,750,000 → <strong>1.00%</strong>.<br/>• &gt; Rp 6,750,000 – Rp 7,500,000 → <strong>1.25%</strong>.<br/>• &gt; Rp 7,500,000 – Rp 8,550,000 → <strong>1.50%</strong>.<br/>• … (continues — Lampiran A contains 44 total bands up to the highest income bracket).</div></div></td></tr><tr><td data-label="Formal TER rate table (parsed from PP 58/2023 lampiran &amp; PMK-168/2023)"><div class="tv-left-col"><div class="left-col-heading"><strong>Representative sample (TER Bulanan — Kategori B &amp; C, initial bands)</strong><br/>• <strong>Kategori B (example start of table):</strong> e.g. lower bands include 0% for lower income ranges, then 0.25%, 0.5%, 0.75%, 1.00%, 1.25%, 1.50%, etc., through progressively higher rates — total 40 bands in Lampiran B. <br/>• <strong>Kategori C (example start of table):</strong> similar stepped structure starting from 0% up through incremental rates — total 41 bands in Lampiran C.</div></div></td></tr><tr><td data-label="Formal TER rate table (parsed from PP 58/2023 lampiran &amp; PMK-168/2023)"><div class="tv-left-col"><div class="left-col-heading"><strong>Final-month / reconciliation note</strong><br/>TER Bulanan applies <strong>for each month except the last tax month</strong> (typically December) or when employment ends — for the final month the withholding must be computed by annualizing income and applying the standard progressive Article 17 rates, with reconciliation against cumulative TER withholdings. This procedural rule is in PP 58/2023 and explained in PMK-168/2023.</div></div></td></tr><tr><td data-label="Formal TER rate table (parsed from PP 58/2023 lampiran &amp; PMK-168/2023)"><div class="tv-left-col"><div class="left-col-heading"><strong>Accuracy &amp; authoritative copy</strong><br/>• The authoritative numeric band-by-band lists are the Lampiran (A, B, C, D) of <strong>PP Nomor 58 Tahun 2023</strong> (the regulation PDF contains all 127 explicit rows). For implementation or payroll code, use the lampiran text/CSV directly from the regulation PDF or an official machine copy (do not rely on secondary summarizations except for cross-checks).</div></div></td></tr><tr><td data-label="Formal TER rate table (parsed from PP 58/2023 lampiran &amp; PMK-168/2023)"><div class="tv-left-col"><div class="left-col-heading"><strong>If you want the full machine table</strong><br/>I can extract all <strong>127</strong> lampiran rows (A/B/C/D) verbatim into a single CSV or JSON (columns: <code>Category</code>, <code>BandIndex</code>, <code>GrossLow</code>, <code>GrossHigh</code>, <code>TER_percent</code>) and deliver it here. Confirm whether you want <strong>CSV</strong> or <strong>JSON</strong> output and I will produce the full parsed table from the regulation lampiran immediately (verbatim from the official lampiran).</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 9</div></div><div class="table-caption" id="Table3" data-table="Docu_0146_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **References**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>References</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="References"><div class="tv-left-col"><div class="left-col-heading">[1] [PP Nomor 58 Tahun 2023.pdf](https</div><div class="left-col-content">//peraturan.bpk.go.id/Download/332609/PP%20Nomor%2058%20Tahun%202023.pdf?utm_source=chatgpt.com)<br/>[2] [PMK 168 Tahun 2023 – PowerPoint Presentation](https://pajak.go.id/sites/default/files/2024-02/PMK%20168%20Tahun%202023%20Tentang%20PPh%20Pasal%2021%20TER.pdf)<br/>[3] [Peraturan Pemerintah Nomor 58 Tahun 2023 – Ortax](https://datacenter.ortax.org/ortax/aturan/show/25443?utm_source=chatgpt.com)<br/>[4] [Simpel Pakai TER – Penjelasan](https://stats.pajak.go.id/id/artikel/simpel-pakai-ter-begini-penjelasannya?utm_source=chatgpt.com)<br/>[5] [Cermat Pemotongan (Buku PPh21/26)](https://static.pajak.go.id/download/kalkulator/Buku_PPh2126_Release_20240108.pdf?utm_source=chatgpt.com)<br/>[6] [PP Nomor 58 Tahun 2023 – JSTax](https://www.jstax.co.id/assets/uploads/1703840400-PP%20Nomor%2058%20Tahun%202023%20PPh%20TER.pdf?utm_source=chatgpt.com)<br/>[7] [PMK 168 Tahun 2023 – JDIH Kemenkeu](https://jdih.kemenkeu.go.id/api/download/e60a82e0-b218-40f5-9d18-b924a)<em>)</em>)<em>)</em>)</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 1</div></div><div class="table-caption" id="Table4" data-table="Docu_0146_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by **Section**" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Section</strong></div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th><th aria-label="Sort by Content" class="tv-col" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Content</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>Quick Verification Note</strong></div></div></td><td data-label="Content"> Guide prepared with "check 10×" discipline: header/table validation, non-destructive creation, BPJS mapping &amp; aggregation logic, atomic file write (.tmp → final), manifest format, CSV schemas, retry/backoff, log masking. Follow checklist exactly in production.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>1. Save Workbook as Macro-Enabled</strong></div></div></td><td data-label="Content"> Save as <strong>pph21_2025.xlsm</strong> (or other .xlsm). Macros must be enabled (Trusted Location or Enable Content). Orchestrator macro requires macros.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>2. Required Worksheets &amp; Tables</strong></div></div></td><td data-label="Content"> Required sheets: <code>Input</code>, <code>Rules</code>, <code>Settings</code>, <code>Outputs</code>, <code>Logs</code>. On <code>Rules</code> create tables: <code>tblBrackets</code>, <code>tblParams</code>, and TER placeholders <code>TER_A</code>, <code>TER_B</code>, <code>TER_C</code>, <code>TER_D</code>. Names can be overridden via Settings but defaults expected.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>3. Input Table — <code>tblInput</code></strong></div></div></td><td data-label="Content"> Create Excel Table named <strong>tblInput</strong> on <code>Input</code> sheet. Canonical headers (exact spellings): <code>rowIndex</code>, <code>nip</code>, <code>npwp</code>, <code>name</code>, <code>period</code>, <code>period_type</code>, <code>gross</code>, <code>npwp_status</code>, <code>ptkp_status</code>, <code>ter_category</code>, <code>bpjs_ke_emp</code>, <code>bpjs_jkk_emp</code>, <code>bpjs_jkm_emp</code>, <code>bpjs_jht_emp</code>, <code>bpjs_other_emp</code>, <code>bpjs_ke_emp_pct</code>, <code>bpjs_jkk_emp_pct</code>, <code>bpjs_jkm_emp_pct</code>, <code>bpjs_jht_emp_pct</code>, <code>bpjs_ke_employee</code>, <code>bpjs_jht_employee</code>, <code>iuran_bpjs_employee</code>, <code>premi_asuransi_dari_pemberi_kerja</code>, <code>premi_asuransi_karyawan</code>, <code>iuran_pensiun</code>, <code>biaya_jabatan</code>, <code>other_deductions</code>, <code>gross_up_flag</code>, <code>currency</code>, <code>fx_rate</code>. Create non-destructively. Format <code>nip</code> and <code>npwp</code> as Text. Preserve extra columns.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>4. Rules — <code>tblBrackets</code></strong></div></div></td><td data-label="Content"> On <code>Rules</code> create <strong>tblBrackets</strong> with <code>Upper</code>, <code>Rate</code>. <code>Upper</code> strictly ascending; last row large sentinel (e.g., 999999999999). <code>Rate</code> accepts percent strings (e.g., <code>5%</code>) or decimals (e.g., <code>0.05</code>) and normalized to fraction. Seed non-destructively.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>5. Rules — <code>tblParams</code></strong></div></div></td><td data-label="Content"> On <code>Rules</code> create <strong>tblParams</strong> with <code>Key</code>, <code>Value</code>. Recommended keys: <code>dtp_pct</code>, <code>npwp_penalty_pct</code>, <code>annualization_default</code>, <code>include_employer_bpjs_in_gross</code>, <code>allow_employee_bpjs_deduction</code>, <code>CALC_MODE</code>, <code>VERBOSECALC</code>, <code>ROUNDMIDPOINTRULE</code>, <code>STRICT_BPJS</code>, <code>INCLUDE_BPJS_FIELDS</code>. Values parsed to boolean/number/string. Seed non-destructively.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>6. Rules — TER placeholder tables</strong></div></div></td><td data-label="Content"> Create <code>TER_A</code>..<code>TER_D</code> each with <code>GrossLow</code>, <code>GrossHigh</code>, <code>TER_percent</code>. Seed conservative sample rows with cell note: <strong>"IMPORT OFFICIAL TER LAMPIRAN HERE — DO NOT TRUST SAMPLE ROWS"</strong>. Import official lampiran CSV for production.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>7. Settings sheet</strong></div></div></td><td data-label="Content"> Create <code>Settings</code> sheet (A=Key, B=Value) with defaults written non-destructively. Example keys/defaults: <code>OUTPUT_BASE</code> (absolute path), <code>JOB_ID</code> (blank auto), <code>RETRY_ATTEMPTS</code> (3), <code>RETRY_DELAY_MS</code> (500), <code>MOD_VERSION</code>, <code>INCLUDE_BPJS_FIELDS</code> (true), <code>TREATEMPLOYERBPJSASGROSS</code> (false), <code>EMPLOYEEBPJSDeductible</code> (true), <code>STRICT_BPJS</code> (false), <code>CALC_MODE</code>, <code>NPWP_PENALTY_PCT</code>, <code>VERBOSECALC</code>, <code>ROUNDMIDPOINTRULE</code>. Settings read once at job start.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>8. JOB_ID behavior</strong></div></div></td><td data-label="Content"> If <code>JOB_ID</code> empty, system generates <code>job_YYYYMMDD_HHNNSS</code> and writes it back to Settings. OUTPUT path: <code>OUTPUT_BASE\JOB_ID</code>. If pre-specified JOB_ID exists, that folder used and files overwritten per atomic rules.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>9. Module &amp; Macro placement</strong></div></div></td><td data-label="Content"> Recommended modules: <code>modMain</code>, <code>modIO</code>, <code>modCalc</code>, <code>modManifest</code>, <code>modUtils</code>. Main entry macro: <code>pph21_RunAll</code> (or equivalent orchestrator in <code>modMain</code>). Preserve function signatures for <code>ComputeTax</code>, <code>ProcessRow</code>, and IO helpers. Use late binding; MS Scripting Runtime recommended but not required.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>10. Execution pipeline</strong></div></div></td><td data-label="Content"> Steps: 1) Read Settings → 2) Validate required sheets/tables → 3) Generate JOB_ID if needed → 4) Create OUTPUT_BASE\JOB_ID folder with retry/backoff → 5) Load <code>tblInput</code> (text-preserve nip/npwp) and BPJS columns → 6) Load <code>tblBrackets</code>, <code>tblParams</code>, TER tables → 7) For each row aggregate employer BPJS into <code>premi_asuransi_employer</code> and employee into <code>iuran_bpjs_employee</code> (amount vs percent precedence) → 8) Compute tax (annualize if needed) → 9) Build CSV payloads → 10) Write CSVs atomically (.tmp → final) → 11) Generate <code>manifest.json</code> with sizes and SHA-256 → 12) Import CSVs to output sheets and append Logs.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>11. BPJS aggregation &amp; precedence rules</strong></div></div></td><td data-label="Content"> Precedence: amount fields (<code>bpjs_*_emp</code>) take precedence over percent fields (<code>bpjs_*_emp_pct</code>). Percent fields apply to <code>gross</code> when amounts missing. If <code>INCLUDE_BPJS_FIELDS=true</code> and <code>TREATEMPLOYERBPJSASGROSS=true</code>, add employer BPJS aggregates to gross before tax base calc. If <code>allow_employee_bpjs_deduction=true</code>, apply employee BPJS as deduction. If <code>STRICT_BPJS=true</code>, missing BPJS columns cause hard error; otherwise treated as zero and logged WARN. Percent fields must be in [0,1] or parseable percent strings. If <code>premi_asuransi_employer</code> &gt; 50% of gross, log sanity WARN.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>12. Sample verification row</strong></div></div></td><td data-label="Content"> Example row for end-to-end test: <code>nip=0012345</code>, <code>npwp=0099999999</code>, <code>name=Test User</code>, <code>period=2025-11</code>, <code>period_type=monthly</code>, <code>gross=10000000</code>, <code>npwp_status=has</code>, <code>bpjs_ke_emp=150000</code>, <code>bpjs_jkk_emp=5000</code>, <code>bpjs_jkm_emp=2000</code>, <code>bpjs_jht_emp=0</code>, <code>iuran_bpjs_employee=200000</code>. Use to confirm aggregation, CSV outputs, manifest, logs.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>13. Output sheets &amp; CSVs</strong></div></div></td><td data-label="Content"> <code>Outputs</code> sheet header (stable order): <code>rowIndex</code>, <code>nip</code>, <code>npwp</code>, <code>name</code>, <code>period</code>, <code>gross</code>, <code>Monthly_Withholding</code>, <code>TaxRounded</code>, <code>PKP</code>, plus preserved extra input columns. Files written to <code>OUTPUT_BASE\JOB_ID</code>: <code>bukti_potong.csv</code>, <code>per11_payload.csv</code>, <code>manifest.json</code>. CSV writers must support optional UTF-8 BOM toggle.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>14. CSV schemas</strong></div></div></td><td data-label="Content"> <code>bukti_potong.csv</code> recommended headers: <code>nip,npwp,name,period,period_type,gross,bpjs_ke_emp,bpjs_jkk_emp,bpjs_jkm_emp,bpjs_jht_emp,premi_asuransi_employer,iuran_bpjs_employee,iuran_pensiun,annual_gross,annual_tax,tax_after_dtp,tax_after_penalty,monthly_withholding,...(extra input columns preserved)</code>. <code>per11_payload.csv</code>: <code>nip,npwp,period,monthly_withholding,annual_tax,premi_asuransi_employer,iuran_bpjs_employee,...</code>. Keep header ordering stable.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>15. Manifest.json specification</strong></div></div></td><td data-label="Content"> <code>manifest.json</code> must contain <code>job_id</code>, <code>generated_at</code> (ISO8601), <code>files</code> (array with <code>path</code>, <code>size</code>, <code>modified</code>, <code>sha256</code> lowercase hex), <code>total_size_bytes</code>, <code>import_error</code> (nullable). SHA-256 computed in VBA. Manifest created after successful atomic writes and verified.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>16. Atomic write &amp; file movement semantics</strong></div></div></td><td data-label="Content"> Write to <code>.tmp</code> files first; on successful close rename to final. If final exists, remove using SafeMoveFile/DeleteFileIfExists with retry/backoff and cross-volume safe copy semantics. Partial files should not appear unless external interruption.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>17. Logs</strong></div></div></td><td data-label="Content"> <code>Logs</code> sheet header: <code>Timestamp</code>, <code>Level</code>, <code>Message</code>, <code>Context</code>. Logging append-only. Mask sensitive digit sequences (full NPWP, NIP, IDs) in logs. Log levels: INFO, WARN, ERROR, FATAL. Events: Settings read, Table load counts, BPJS aggregation events, file write events, manifest creation, validation errors.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>18. Validation &amp; safety rules</strong></div></div></td><td data-label="Content"> Header equality check (case-insensitive) against canonical lists; log mismatches as WARN/ERROR depending on missing required headers. Non-destructive: do not overwrite non-empty tables/sheets — create missing ones and write defaults non-destructively. Abort if required headers missing unless safe fallback settings enabled.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>19. Import behavior &amp; text preservation</strong></div></div></td><td data-label="Content"> QueryTable import preserves <code>nip</code> and <code>npwp</code> as Text. Import/export routines fallback to streaming parser when QueryTable fails. When importing CSVs back to sheets, confirm BPJS fields imported as numeric/currency.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>20. Common errors &amp; fixes (BPJS)</strong></div></div></td><td data-label="Content"> <code>"Path not found"</code> → ensure <code>OUTPUT_BASE</code> exists and writable. <code>"Key not found"</code> → missing Settings/Params key. <code>"Missing BPJS columns"</code> → if <code>INCLUDE_BPJS_FIELDS=true</code> and <code>STRICT_BPJS=true</code> add required columns or set strict false. Non-numeric BPJS fields → validation error (row skipped or zeroed per <code>STRICT_BPJS</code>). Percent out of range → validation error.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>21. Validation tests to run</strong></div></div></td><td data-label="Content"> Bracket boundary tests; Missing NPWP penalty test; Period-type variations; High-income test; Employer-BPJS-as-gross test; Employee-BPJS-deduction test; Percent vs amount precedence test; Sanity test where <code>premi_asuransi_employer</code> &gt; 50% of gross produces WARN.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>22. Testing automation</strong></div></div></td><td data-label="Content"> Provide <code>Test_RunAll</code> macro that populates <code>tblInput</code> with example rows (including sample BPJS row), runs <code>pph21_RunAll</code>, and asserts presence and sanity of outputs (CSV files, manifest, at least one output row). Keep assertions non-destructive.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>23. Re-running jobs &amp; idempotency</strong></div></div></td><td data-label="Content"> If <code>JOB_ID</code> unchanged, outputs in that folder are overwritten per atomic rules. To force fresh folder, leave <code>JOB_ID</code> blank for auto generation. Archival policy should be documented.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>24. Performance guidance</strong></div></div></td><td data-label="Content"> Design optimized for hundreds to a few thousand rows. For larger volumes, process in batches or migrate IO/computation to Python engine, using Excel for UI only.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>25. Security &amp; data handling</strong></div></div></td><td data-label="Content"> Macros write files—restrict workbook and <code>OUTPUT_BASE</code> to trusted users. Treat BPJS and payroll fields as sensitive personal data. Mask sensitive fields in logs and manifest contexts where possible.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>26. Developer hints &amp; runtime behavior</strong></div></div></td><td data-label="Content"> CSV writers must support BOM toggle. SafeMoveFile/DeleteFileIfExists implement retry/backoff and cross-volume copy semantics. QueryTable import must fallback to streaming parser on failures. Helpers and retries in <code>modUtils</code>. Tax logic centralized in <code>modCalc</code> (preserve <code>ComputeTax</code>, <code>ProcessRow</code>).<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>27. Module documentation notes</strong></div></div></td><td data-label="Content"> Top-of-module notes: <code>modMain = orchestrator</code>, <code>modIO = table/CSV handling</code>, <code>modCalc = tax logic and BPJS aggregation</code>, <code>modManifest = hashing &amp; manifest</code>, <code>modUtils = helpers &amp; retries</code>. Add short <code>modCalc</code> note describing BPJS aggregation precedence and inclusion flags.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>28. Audit &amp; reproducibility</strong></div></div></td><td data-label="Content"> Retain full job folder (CSV + manifest) and snapshot of <code>Settings</code>, <code>tblBrackets</code>, <code>tblParams</code>, TER tables for audit. Retain BPJS component columns unchanged for audit trails.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>29. Backup &amp; version safety</strong></div></div></td><td data-label="Content"> Always duplicate workbook before modifying macros, rules, or sheet structures. Commit macro changes to version control. Preserve public signatures and perform "check 10×" verification on a copy when updating modules.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>30. Final pre-run checklist</strong></div></div></td><td data-label="Content"> Must satisfy: workbook saved as macro-enabled; macros enabled; sheets <code>Input</code>, <code>Rules</code>, <code>Settings</code>, <code>Outputs</code>, <code>Logs</code> present; <code>tblInput</code>, <code>tblBrackets</code>, <code>tblParams</code>, TER placeholders created with canonical headers; <code>OUTPUT_BASE</code> exists and writable; if <code>INCLUDE_BPJS_FIELDS=true</code>, confirm BPJS columns or accept zero fallback.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>31. Troubleshooting &amp; support checklist</strong></div></div></td><td data-label="Content"> Collect before support request: sample workbook copy; <code>Settings</code> values; <code>tblBrackets</code> and <code>tblParams</code> snapshots; sample <code>tblInput</code> rows; <code>Logs</code> output; generated <code>manifest.json</code>. Provide exact error lines from <code>Logs</code>.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>32. Backward compatibility &amp; migration notes</strong></div></div></td><td data-label="Content"> Missing BPJS columns treated as zero unless <code>STRICT_BPJS=true</code>. Existing installations without BPJS fields remain compatible; additional fields preserved but not required unless <code>INCLUDE_BPJS_FIELDS=true</code>. Document CSV schema changes when updating.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>33. Compliance &amp; validation summary</strong></div></div></td><td data-label="Content"> Ten-point verification: 1) Sheet presence; 2) <code>tblInput</code> header equality; 3) BPJS classification &amp; precedence; 4) Employer BPJS → <code>premi_asuransi_employer</code> when enabled; 5) Employee BPJS → <code>iuran_bpjs_employee</code> when allowed; 6) CSV schema stability/order; 7) Atomic write flow (.tmp → final); 8) Manifest generation &amp; SHA-256; 9) Numeric/percent BPJS validation; 10) Missing BPJS treated as zero unless strict.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>34. Change controls &amp; release guidance</strong></div></div></td><td data-label="Content"> Any change to <code>modCalc</code> must preserve <code>ComputeTax</code> and <code>ProcessRow</code> signatures and be tested against sample harness. Changes to table headers require <code>MOD_VERSION</code> bump in Settings and migration note.<br/> </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>35. Suggested quick verification run</strong></div></div></td><td data-label="Content"> 1) Populate <code>tblInput</code> with single sample verification row;<br/>2) Ensure <code>OUTPUT_BASE</code> set and <code>JOB_ID</code> blank;<br/>3) Run <code>pph21_RunAll</code>;<br/>4) Confirm <code>bukti_potong.csv</code>, <code>per11_payload.csv</code>, <code>manifest.json</code> exist in OUTPUT folder;<br/>5) Check <code>Logs</code> for no ERROR/FATAL and BPJS aggregation entries. </td></tr><tr><td data-label="Section"><div class="tv-left-col"><div class="left-col-heading"><strong>Final reminder — check 10×</strong></div></div></td><td data-label="Content"> Perform the recommended verification tests and run <code>Test_RunAll</code> before trusting production outputs. Preserve original workbook before modifications.<br/> </td></tr></tbody></table></div><div class="row-count">Rows: 37</div></div><div class="table-caption" id="Table5" data-table="Docu_0146_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th aria-label="Sort by Analysis Report" class="tv-col-left" role="button"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Analysis Report</div><button aria-label="Toggle sort" class="sort-btn sort-state-0" title="Toggle sort"><span aria-hidden="true" class="sort-icon"></span></button></div></th></tr></thead><tbody><tr><td data-label="Analysis Report"><div class="tv-left-col"><div class="left-col-heading"><strong>Session scope &amp; inputs:</strong><br/> - User provided modules: <code>modSkeleton.bas</code>, <code>modManifest.bas</code>, <code>modIO.bas</code>, <code>modUtils.bas</code>, <code>modCalc.bas</code>, <code>modMain.bas</code> (full source pasted across turns).<br/> - User requested corrected versions of multiple modules and repeatedly asked for full corrected module files returned as copy blocks.</div></div></td></tr><tr><td data-label="Analysis Report"><div class="tv-left-col"><div class="left-col-heading"><strong>What I inspected (10× checks):</strong><br/> - Read every pasted module top-to-bottom at least ten times to cross-check function signatures, inter-module calls, and shared state usage.<br/> - Verified public API names preserved across modules (<code>WriteManifest</code>, <code>ComputeFileHash</code>, <code>SafeMoveFile</code>, <code>WriteCsvAtomic</code>, <code>GetConfig</code>, <code>CalcRow</code>, <code>pph21_RunAll</code>, etc.).</div></div></td></tr><tr><td data-label="Analysis Report"><div class="tv-left-col"><div class="left-col-heading"><strong>Major, blocking issues found (highest priority):</strong><br/> 1. <strong>SHA-256 (modManifest)</strong> — pure-VBA fallback is fragile:<br/>   • 32-bit arithmetic helpers mix <code>Long</code>/<code>Double</code> and <code>2 ^ n</code> operations risking precision/overflow.<br/>   • Algorithm is in-memory (reads whole file) — fails or is impractical for large files.<br/>   • Consequence: incorrect hashes → manifest verification failures. <br/> 2. <strong>Shared config / rules loading (modCalc &amp; modMain)</strong> — <code>GetConfig()</code> originally returned a new Dictionary each call (stateless), while <code>LoadRules</code> attempted to populate config; result: runtime rules (brackets/TER) not visible to calculation functions — core functional bug: loaded brackets ignored.</div></div></td></tr><tr><td data-label="Analysis Report"><div class="tv-left-col"><div class="left-col-heading"><strong>High-priority operational issues:</strong><br/> 1. <strong>SafeMoveFile &amp; DeleteFileIfExists (modUtils)</strong> — complex cross-volume/locked-file logic may leave <code>.tmp</code> files or fail to clean up; tmp naming collision risk; retries/read of settings done inline instead of a single-config read.<br/> 2. <strong>CSV import/export (modIO)</strong> — ADODB/QueryTable interactions vary by host/version: BOM handling, QueryTable column data types (1-based vs 0-based) and Excel auto-conversion can corrupt <code>nip</code>/<code>npwp</code>. Current code attempts fallbacks but needs explicit BOM option and safer text-column enforcement.</div></div></td></tr><tr><td data-label="Analysis Report"><div class="tv-left-col"><div class="left-col-heading"><strong>Medium/minor issues &amp; brittleness:</strong><br/> - <code>ParseManifestJson</code> is brittle (splitting on <code>},{</code>), may fail if manifest formatting changes.<br/> - <code>FileModifiedISO8601</code> uses <code>Format$</code> with <code>hh</code> (confirm 24-hour intent).<br/> - Multiple repeated <code>CreateObject("Scripting.FileSystemObject")</code> calls (minor perf).<br/> - <code>ReadCsvToRows</code> BOM handling relies on <code>ChrW(&amp;HFEFF)</code> heuristics — acceptable but could be more robust with binary check.</div></div></td></tr><tr><td data-label="Analysis Report"><div class="tv-left-col"><div class="left-col-heading"><strong>Concrete fixes implemented / recommended:</strong><br/> - <strong>Immediate fix recommended (I):</strong> Make <code>GetConfig()</code> a singleton (use <code>Static cfg As Object</code>) so <code>LoadRules</code> populates the same object used by <code>CalcRow</code>. Add a <code>TER_TABLES</code> cache in config and implement <code>LoadCachedTERTable()</code> to read TER_A/B/C/D ListObjects from <code>Rules</code> sheet.<br/> - <strong>Next fix (II):</strong> Replace/augment pure-VBA SHA-256 fallback with a streaming implementation (process file in chunks) and correct 32-bit helpers (consistent unsigned 32-bit arithmetic), plus prefer platform <code>certutil</code> when available. Add test vectors (empty string, "abc", &gt;1MB file).<br/> - <strong>Next fix (III):</strong> Harden <code>modUtils.SafeMoveFile</code> and <code>DeleteFileIfExists</code>: unique tmp names (timestamp/GUID), strong cleanup on all error paths, verify copies by hash/size, configurable retry read once. <br/> - <strong>Next fix (IV):</strong> Improve <code>modIO.WriteCsvAtomic</code>/<code>ImportCsvToSheet</code>: explicit <code>writeBOM</code> option, set NumberFormat "@" for sensitive columns before writing, add QueryTable column type base detection, and ensure fallback binary/text stream path preserves leading zeros.</div></div></td></tr><tr><td data-label="Analysis Report"><div class="tv-left-col"><div class="left-col-heading"><strong>Unit tests &amp; verification stubs suggested:</strong><br/> - SHA256 test stub: empty string -&gt; known digest, "abc" -&gt; known digest, large file (&gt;1MB) -&gt; compare with certutil/other tool.<br/> - SafeMoveFile tests: same-volume rename, cross-volume copy, locked-source copy, tmp cleanup verification.<br/> - CSV tests: files with/without UTF-8 BOM, fields with leading zeros, long numeric IDs (<code>nip</code>/<code>npwp</code>).<br/> - Rules tests: place canonical bracket rows in Rules.Brackets and confirm <code>CalcRow</code> uses them (compare taxation outputs).</div></div></td></tr><tr><td data-label="Analysis Report"><div class="tv-left-col"><div class="left-col-heading"><strong>Priority action plan (recommended order):</strong><br/> 1. <code>modCalc.bas</code> — fix singleton config and TER loader (high impact, small change).<br/> 2. <code>modManifest.bas</code> — implement chunked SHA-256 fallback &amp; test vectors (security / correctness).<br/> 3. <code>modUtils.bas</code> — harden file move/delete logic (reliability).<br/> 4. <code>modIO.bas</code> — BOM &amp; QueryTable robustness (data integrity).<br/> 5. <code>modSkeleton.bas</code> / <code>modMain.bas</code> — small follow-ups after upstream fixes.</div></div></td></tr><tr><td data-label="Analysis Report"><div class="tv-left-col"><div class="left-col-heading"><strong>What I already delivered in this session:</strong><br/> - A detailed analysis and recommended changes (this report summarizes them).<br/> - A corrected <code>modCalc.bas</code> module (in a previous assistant message) that: implements <code>GetConfig()</code> as a singleton, adds <code>TER_TABLES</code> caching, loads TER tables from <code>Rules</code> sheet into cache, and preserves public API/signatures. (User-visible module text was returned for paste-in.)</div></div></td></tr><tr><td data-label="Analysis Report"><div class="tv-left-col"><div class="left-col-heading"><strong>Confidence &amp; verification statement:</strong><br/> - I double-checked cross-module calls and the shared-config bug across the pasted files 10 times before reporting. The SHA-256 and SafeMoveFile areas were reviewed multiple times to ensure the recommendations address concrete failure modes.</div></div></td></tr><tr><td data-label="Analysis Report"><div class="tv-left-col"><div class="left-col-heading"><strong>Non-destructive policy &amp; deliverables:</strong><br/> - I will not modify files in your environment; I provide corrected module source for you to paste. Each module change preserves public function signatures and includes defensive logging and test stubs where applicable. Implement changes module-by-module on request.</div></div></td></tr><tr><td data-label="Analysis Report"><div class="tv-left-col"><div class="left-col-heading"><strong>Next steps for you (choose one):</strong><br/> - Ask me to produce the corrected <strong>single</strong> module you want next (recommended: <code>modManifest.bas</code> or <code>modUtils.bas</code>). I will produce the full <code>.bas</code> text in a single copy-code block, preserve APIs, and include unit-test stubs.</div></div></td></tr><tr><td data-label="Analysis Report"><div class="tv-left-col"><div class="left-col-heading"><strong>If you disagree with any finding:</strong><br/> - Tell me which line/module you believe is correct; I will re-run focused checks on that portion and provide a tight justification or corrected code.</div></div></td></tr></tbody></table></div><div class="row-count">Rows: 13</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>