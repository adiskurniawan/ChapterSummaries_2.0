<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1762683323">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0100_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Logic / Structure**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Logic / Structure</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Conceptual notes, failure modes, and diagnostic checkpoints**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Conceptual notes, failure modes, and diagnostic checkpoints</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Logic / Structure"> <strong>Overall goal</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> <code>script.list.js</code> builds ordered <code>sources</code> for a group. <code>core_renderer.py</code> must receive <code>sources</code> and inject captions so UI order and metadata match. Captions missing means ordering mismatch, detection failure, or silent server exceptions. </td></tr><tr><td data-label="Logic / Structure"> <code>script.list.js: _buildSourcesMeta(list)</code> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> Produces <code>{name, path, url, caption, description}</code> per file. Check every entry for completeness and type safety. Common errors: nulls, empty captions, or unreachable URLs. Log <code>sourcesMeta</code> before <code>_notifyServerRender</code>. </td></tr><tr><td data-label="Logic / Structure"> <code>script.list.js: _notifyServerRender(text, sources)</code> → POST <code>/api/render</code> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> Sends <code>{text, sources, fromList:true}</code>. Risks: wrong endpoint, CORS rejection, malformed JSON, or timeout. Client doesn’t block; result stored in <code>window.__ptt_server_render_result</code>. Validate POST payload, response, and that property. </td></tr><tr><td data-label="Logic / Structure"> <strong>Server contract</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> Server must forward <code>sources</code> into <code>render_html(..., sources=sources)</code>. If ignored or renamed, captions never appear. Confirm request handler uses the right key. </td></tr><tr><td data-label="Logic / Structure"> <code>core_renderer.render_html(..., sources=...)</code> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> Checks <code>sources</code> truthiness and list type. If empty or None, legacy caption logic runs. Log <code>len(sources)</code> and type early. </td></tr><tr><td data-label="Logic / Structure"> <code>render_html</code> → <code>fragments_map</code> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> Built by <code>render_fragments_concurrently</code>. Captions rely on positional parity between fragments and sources. If counts differ, mapping fails. Compare lengths of <code>sources</code>, <code>frag_paths_ordered</code>, and <code>fragments_map</code>. </td></tr><tr><td data-label="Logic / Structure"> <code>frag_paths_ordered</code> construction </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> Iterates <code>sorted(fragments_map.keys())</code> to create <code>(idx, path, title_id, title_text)</code>. Index order may not match client expectations. Verify sorted keys, stems, and index continuity. </td></tr><tr><td data-label="Logic / Structure"> <code>inject_captions_into_html(html_text, sources, title_ids, labels_index, book_prefix)</code> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> Splits HTML by <code>&lt;div class=&quot;table-wrapper&quot;...&gt;</code> and injects captions sequentially. Assumes exact count alignment between wrappers and sources. Mismatch causes offset captions or omissions. Add defensive checks and logging. </td></tr><tr><td data-label="Logic / Structure"> <code>_get_caption_from_sources(item, labels_index)</code> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> Resolves caption by <code>caption</code> → <code>description</code> → <code>name</code>/<code>path</code>. Falls back to <code>labels_index</code> if available. Failure when caption empty string vs None, HTML-marked text, or label normalization mismatch. Print resolved caption per source for verification. </td></tr><tr><td data-label="Logic / Structure"> <strong>Ordering assumption</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> <code>inject_captions_into_html</code> inserts captions in <code>sources</code> order matching <code>.table-wrapper</code> sequence. If the server reordered or filtered fragments, captions misalign. Most likely cause: <code>sources</code> count/order ≠ number/order of wrappers. Compare <code>#captions_nonempty</code> vs wrapper count. </td></tr><tr><td data-label="Logic / Structure"> <strong>HTML splitting fragile points</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> Regex <code>(&lt;div\s+class=[&quot;\&#x27;]table-wrapper[&quot;\&#x27;][^&gt;]*&gt;)</code> only matches exact <code>class=&quot;table-wrapper&quot;</code>. It fails for multi-class wrappers (<code>class=&quot;table-wrapper extra&quot;</code>). When split fails, injector falls back to <code>&lt;table class=&quot;tv-table&quot;...&gt;</code>. If both fail, HTML unchanged. Adjust regex for class-list tolerance. </td></tr><tr><td data-label="Logic / Structure"> <strong>Existing caption detection (<code>skip_inject</code>)</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> Function checks if preceding <code>out_parts[-1]</code> ends with caption markup. False negatives cause duplicates; false positives skip valid injection. Inspect fragment HTML around wrapper to confirm caption structure. </td></tr><tr><td data-label="Logic / Structure"> <strong>Title id usage (<code>title_ids</code> param)</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> Uses <code>title_ids</code> to set caption ids. If lists differ in length or order, wrong ids applied. Validate <code>title_ids</code> vs actual fragment <code>id=&quot;Table\d+&quot;</code> attributes. </td></tr><tr><td data-label="Logic / Structure"> <strong><code>data-table</code> generation inside injector</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> Injector builds <code>data-table</code> using <code>book_prefix</code> and path/name. Mismatch arises if fragments already contain their own data-table identifiers. Compare produced vs existing attributes. </td></tr><tr><td data-label="Logic / Structure"> <strong>Fallback splitting on <code>&lt;table class=&quot;tv-table&quot;</code></strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> Fallback only matches exact class equality. If table markup contains extra classes, split fails and captions vanish. Search HTML for class variants to confirm. </td></tr><tr><td data-label="Logic / Structure"> <strong>Sanitization / escaping</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> <code>_get_caption_from_sources</code> escapes text. If caption already HTML-escaped, result double-escaped. Check raw captions vs final output. </td></tr><tr><td data-label="Logic / Structure"> <strong>Skip injection when all captions empty</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> If all resolved captions empty, injector returns original HTML. Log <code>captions</code> array and verify nonempty entries exist. </td></tr><tr><td data-label="Logic / Structure"> <strong><code>frag_paths_ordered</code> vs <code>sources</code> mismatch</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> When lengths differ, some captions unused or missing. Legacy caption path disabled if <code>client_captions_provided</code> true. Compare both counts and build a mapping table for diagnosis. </td></tr><tr><td data-label="Logic / Structure"> <strong><code>need_fallback</code> true path</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> Fallback renders inline captions using <code>labels.json</code>. If <code>client_captions_provided</code> false or server ignored <code>sources</code>, fallback triggers unexpectedly. Verify <code>need_fallback</code> condition and logs. </td></tr><tr><td data-label="Logic / Structure"> <strong>Race conditions & concurrency</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> <code>render_fragments_concurrently</code> may not finish writes before caption injector reads. Confirm all fragment files exist before injection stage. </td></tr><tr><td data-label="Logic / Structure"> <strong>Silent exceptions & suppressed logs</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> Errors often swallowed or logged with <code>logger.exception()</code> but not surfaced. Escalate logging level or insert diagnostic markers into HTML to confirm injection run. </td></tr><tr><td data-label="Logic / Structure"> <strong><code>labels.json</code> fallback behavior</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> Server <code>_labels</code> may differ from client labels index. Missing or mismatched labels cause blank captions. Verify server <code>_labels</code> keys and content. </td></tr><tr><td data-label="Logic / Structure"> <strong>Client → server mapping mismatch (probable)</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> Common causes:<br>1. <code>sources</code> order differs from render order.<br>2. Regex mismatch.<br>3. All captions empty.<br>4. Handler not passing <code>sources</code>.<br>5. <code>title_ids</code> misaligned.<br>6. <code>skip_inject</code> misfires.<br>Check in this order. </td></tr><tr><td data-label="Logic / Structure"> <strong>Non-code debugging checklist</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> 1. Inspect <code>sourcesMeta</code> on client.<br>2. Confirm POST body and server receipt.<br>3. Log <code>sources</code> at server entry.<br>4. Compare <code>len(sources)</code> vs wrapper count.<br>5. Log fragment keys and order.<br>6. Print counts and mappings before injection.<br>7. Verify <code>_labels</code> load.<br>8. Confirm injection produced modified HTML. </td></tr><tr><td data-label="Logic / Structure"> <strong>Conceptual fixes (design only)</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> A. Match fragments to sources by identifier (<code>data-path</code> or <code>data-name</code>), not index.<br>B. Make regex class match tolerant.<br>C. Retain legacy captions until at least one injected.<br>D. Suppress duplicates only after verifying injection success.<br>E. Add diagnostic HTML comments to confirm caption attempt. </td></tr><tr><td data-label="Logic / Structure"> <strong>Edge cases</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> Multiple tables per fragment.<br>Existing captions with variant markup.<br>Unequal counts.<br>HTML in captions.<br>Title collisions.<br>Similar class names. </td></tr><tr><td data-label="Logic / Structure"> <strong>Matching heuristics & labels interplay</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> Align client and server label sources. Prefer client-supplied captions when available to prevent divergence. </td></tr><tr><td data-label="Logic / Structure"> <strong>Minimal safe behavioral change</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> Implement idempotent injection: try <code>data-path</code> or <code>data-name</code> match first, then fallback regex. Preserve legacy captions if no insertion occurred. </td></tr><tr><td data-label="Logic / Structure"> <strong>Mapping table for debugging</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> Log per-row:<br><code>index / source.name / source.path / caption / frag_key / frag_path / table_count / snippet</code>. Reveals alignment failures. </td></tr><tr><td data-label="Logic / Structure"> <strong>Suggested test scenarios</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> 1. One table single file.<br>2. Multi-file with missing caption and label fallback.<br>3. Dedup reducing fragment count.<br>4. Multi-table fragment.<br>5. Wrapper with multiple classes.<br>Verify caption correctness. </td></tr><tr><td data-label="Logic / Structure"> <strong>Quick failure indicators</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> No <code>&lt;div class=&quot;table-caption&quot;&gt;</code> in HTML.<br><code>window.__ptt_server_render_result</code> missing.<br>Server logs “caption injection failed.” </td></tr><tr><td data-label="Logic / Structure"> <strong>Priority to fix root cause</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> 1. Confirm handler forwards <code>sources</code>.<br>2. Compare counts.<br>3. Implement identifier-based matching.<br>4. Make regex flexible.<br>5. Keep legacy captions until injection verified.<br>6. Add temporary diagnostic logging. </td></tr><tr><td data-label="Logic / Structure"> <strong>Next step</strong> </td><td data-label="Conceptual notes, failure modes, and diagnostic checkpoints"> Approve to proceed to targeted conceptual changes, prioritized patch plan, or full code diff. Specify choice. </td></tr></tbody></table></div><div class="row-count">Rows: 33</div></div><div class="table-caption" id="Table2" data-table="Docu_0100_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Step**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Step</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Details**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Details</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Step"> <strong>Objective</strong>                     </td><td data-label="Details"> When user clicks “Load Group” the client must send the active <code>labels.json</code> payload alongside the group file list to the server conversion endpoint so <code>convert.py</code> can inject captions server-side.                                                                                   </td></tr><tr><td data-label="Step"> <strong>Constraints & assumptions</strong>     </td><td data-label="Details"> <code>labels.json</code> is a simple mapping of ID→caption. No frontend parsing beyond loading and forwarding. Backward compatibility with existing convert endpoints must be preserved.                                                                                                          </td></tr><tr><td data-label="Step"> <strong>High-level flow</strong>               </td><td data-label="Details"> User clicks Load Group → client collects group file descriptors → client loads current <code>labels.json</code> → client POSTs a single JSON request containing file list + labels → server <code>convert.py</code> consumes labels and injects captions during conversion → server returns rendered output. </td></tr><tr><td data-label="Step"> <strong>Frontend change (behavior)</strong>    </td><td data-label="Details"> On Load Group, load <code>labels.json</code> (if not cached). Attach contents as a field named <code>labels</code> in the conversion request payload. Do not modify file content client-side.                                                                                                                </td></tr><tr><td data-label="Step"> <strong>Frontend change (efficiency)</strong>  </td><td data-label="Details"> Cache <code>labels.json</code> in memory for the session. Re-fetch only if cache miss or explicit reload. Keep payload small by sending only keys present in selected group when feasible.                                                                                                        </td></tr><tr><td data-label="Step"> <strong>Transport contract</strong>            </td><td data-label="Details"> Single POST JSON object. Include: file descriptors or paths, metadata identifying source, and <code>labels</code> object. Server must accept absent <code>labels</code> (backward compatibility).                                                                                                            </td></tr><tr><td data-label="Step"> <strong>Server change (API handling)</strong>  </td><td data-label="Details"> <code>convert.py</code> must read incoming JSON, extract <code>labels</code> safely, and pass it into caption-injection logic as an authoritative lookup table for file IDs. If <code>labels</code> missing, use existing behavior.                                                                                     </td></tr><tr><td data-label="Step"> <strong>Injection timing & location</strong>   </td><td data-label="Details"> Inject captions at the final content assembly stage, immediately before markdown→HTML or HTML finalization. This avoids disrupting parsing and sanitization steps.                                                                                                                     </td></tr><tr><td data-label="Step"> <strong>Matching strategy</strong>             </td><td data-label="Details"> Use exact ID lookup first. If not found, do not invent captions. No fuzzy matching. Keep injection deterministic and idempotent.                                                                                                                                                       </td></tr><tr><td data-label="Step"> <strong>Formatting policy</strong>             </td><td data-label="Details"> Server chooses safe caption insertion format. For Markdown outputs prefer a stable heading level prefix. For HTML outputs prefer dedicated caption element outside table cells. Do not alter original cell content.                                                                    </td></tr><tr><td data-label="Step"> <strong>Validation</strong>                    </td><td data-label="Details"> Validate <code>labels</code> is an object/dictionary with string keys and string values. Reject or ignore anything else. Log but do not fail conversion on invalid label entries.                                                                                                                 </td></tr><tr><td data-label="Step"> <strong>Security & sanitization</strong>       </td><td data-label="Details"> Treat labels as untrusted input. Escape HTML and sanitize content on server before insertion. Disallow HTML tags or scripts inside captions. Enforce maximum caption length.                                                                                                           </td></tr><tr><td data-label="Step"> <strong>Error handling & fallback</strong>     </td><td data-label="Details"> If label lookup or injection fails for a file, continue conversion without caption for that file. Report per-file failures to the conversion log only when debug is enabled. Return a non-blocking warning in response metadata.                                                       </td></tr><tr><td data-label="Step"> <strong>Performance considerations</strong>    </td><td data-label="Details"> <code>labels.json</code> is small. Network overhead is negligible. If many groups are loaded in a batch, consider sending only relevant label keys to reduce payload.                                                                                                                             </td></tr><tr><td data-label="Step"> <strong>Logging & observability</strong>       </td><td data-label="Details"> Emit structured logs: request id, number of files, labels count, injection success/fail per file. Include metrics for latency added by label processing.                                                                                                                               </td></tr><tr><td data-label="Step"> <strong>Testing matrix</strong>                </td><td data-label="Details"> Unit tests for <code>convert.py</code> injection function. Integration tests: client sends labels; server injects captions in Markdown and HTML outputs; missing labels should be silent. Regression tests to ensure existing endpoints still work without labels.                                </td></tr><tr><td data-label="Step"> <strong>Backward compatibility</strong>        </td><td data-label="Details"> Server must accept requests without <code>labels</code>. Client must tolerate server that ignores labels. Use feature flag if phased rollout is required.                                                                                                                                         </td></tr><tr><td data-label="Step"> <strong>Deployment & rollback</strong>         </td><td data-label="Details"> Deploy server changes behind a feature flag. Canary with small set of users. If injection causes issues, toggle flag and roll back quickly.                                                                                                                                            </td></tr><tr><td data-label="Step"> <strong>Operational checklist</strong>         </td><td data-label="Details"> Add schema validator for <code>labels.json</code>. Add monitoring alert for injection error rate. Add an admin/maintenance path to replace or prune labels if needed.                                                                                                                             </td></tr><tr><td data-label="Step"> <strong>Documentation & user guidance</strong> </td><td data-label="Details"> Document payload contract and caption rules. Provide short write-up: where to edit <code>labels.json</code>, expected ID format, and how captions will appear in outputs.                                                                                                                         </td></tr><tr><td data-label="Step"> <strong>Acceptance criteria</strong>           </td><td data-label="Details"> Clicking Load Group posts files + <code>labels</code>. Server uses provided mapping to inject captions for files with matching IDs. No client-side content alteration. Conversion succeeds and captions appear in final outputs for matching IDs. Logs show injection activity.                   </td></tr></tbody></table></div><div class="row-count">Rows: 21</div></div><div class="table-caption" id="Table3" data-table="Docu_0100_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Area**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Area</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Change**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Change</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Reason**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Reason</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Area"> <strong>1. Function signature</strong>     </td><td data-label="Change"> Add an optional <code>labels: Optional[dict] = None</code> argument to the main rendering function (e.g., <code>render_html</code> or equivalent).                                          </td><td data-label="Reason"> Enables caption mapping without affecting existing callers. </td></tr><tr><td data-label="Area"> <strong>2. Mode detection</strong>         </td><td data-label="Change"> Inside <code>render_html</code>, detect if the current invocation originated from the “list form” context (e.g., a specific flag like <code>from_list=True</code> or presence of <code>labels</code>). </td><td data-label="Reason"> Limits logic to the special workflow only.                  </td></tr><tr><td data-label="Area"> <strong>3. Caption resolution</strong>     </td><td data-label="Change"> Extend <code>_caption_for(book_prefix, idx)</code> to first check <code>labels</code>. Fallback to default <code>title_text</code> or “Table {idx}” when no match.                                     </td><td data-label="Reason"> Keeps deterministic and consistent mapping.                 </td></tr><tr><td data-label="Area"> <strong>4. Injection location</strong>     </td><td data-label="Change"> Keep injection inside the existing <code>writer(f)</code> loop, just before writing each table fragment. Wrap caption text as a <code>&lt;div class=&quot;table-caption&quot;&gt;</code>.                   </td><td data-label="Reason"> Avoids altering parsing or TOC behavior.                    </td></tr><tr><td data-label="Area"> <strong>5. Sanitization</strong>           </td><td data-label="Change"> Escape any caption text from <code>labels</code> using <code>html.escape()</code>. Skip if caption is empty or non-string.                                                                  </td><td data-label="Reason"> Prevents HTML/script injection.                             </td></tr><tr><td data-label="Area"> <strong>6. Logging & diagnostics</strong>  </td><td data-label="Change"> Add <code>logger.info(f&quot;Injected {injected_count}/{total_fragments} captions from labels.json&quot;)</code> at the end.                                                               </td><td data-label="Reason"> Supports traceability in server logs.                       </td></tr><tr><td data-label="Area"> <strong>7. Backward compatibility</strong> </td><td data-label="Change"> If <code>labels</code> is not passed, the renderer should behave identically to the previous stable version.                                                                     </td><td data-label="Reason"> Ensures safety for legacy paths.                            </td></tr><tr><td data-label="Area"> <strong>8. Testing checklist</strong>      </td><td data-label="Change"> Test three modes: (1) normal conversion (no labels), (2) list form with full labels match, (3) list form with partial/missing labels.                                 </td><td data-label="Reason"> Confirms graceful degradation.                              </td></tr></tbody></table></div><div class="row-count">Rows: 8</div></div><div class="table-caption" id="Table4" data-table="Docu_0100_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Area**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Area</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Implementation Plan**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Implementation Plan</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Justification**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Justification</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Area"> <strong>1. Entry Interface</strong>        </td><td data-label="Implementation Plan"> Add two optional parameters at the top of the file’s main entry function (likely <code>render_html()</code> or <code>render_to_html()</code>):<br> <code>labels: Optional[dict] = None, from_list: bool = False</code>.                                                                      </td><td data-label="Justification"> Keeps legacy workflows untouched while allowing targeted activation for the list form.   </td></tr><tr><td data-label="Area"> <strong>2. Activation Condition</strong>   </td><td data-label="Implementation Plan"> Inside the main body, set a flag <code>list_mode_active = bool(from_list and labels)</code> early. This becomes the switch controlling all special behavior.                                                                                                           </td><td data-label="Justification"> Prevents any interference with other render calls (e.g., batch or standard conversions). </td></tr><tr><td data-label="Area"> <strong>3. Caption Resolution</strong>     </td><td data-label="Implementation Plan"> Patch the existing <code>_caption_for(book_prefix, idx)</code> helper: <br>• If <code>list_mode_active</code>, check <code>labels.get(f&quot;{book_prefix}_{idx:02d}&quot;)</code> first.<br>• If found and is string, return it. Otherwise, continue with existing logic.                             </td><td data-label="Justification"> Reuses the existing lookup path and minimizes new code.                                  </td></tr><tr><td data-label="Area"> <strong>4. Writer Integration</strong>     </td><td data-label="Implementation Plan"> Keep the caption injection inside the current <code>writer(f)</code> loop you showed (the same area writing <code>caption_html</code>). Replace the current <code>cap = _caption_for(...)</code> call to rely on the updated <code>_caption_for</code> behavior, which will now use labels when active. </td><td data-label="Justification"> No need for new loops or data structures. All fragments and TOC remain consistent.       </td></tr><tr><td data-label="Area"> <strong>5. Sanitization</strong>           </td><td data-label="Implementation Plan"> Before writing any caption from labels, wrap with <code>html.escape()</code> and truncate extremely long captions (>400 chars). Log truncated captions via <code>logger.debug</code>.                                                                                             </td><td data-label="Justification"> Prevents script injection and layout overflow.                                           </td></tr><tr><td data-label="Area"> <strong>6. Logging</strong>                </td><td data-label="Implementation Plan"> After the loop, if <code>list_mode_active</code> is True, log a structured info entry:  <br><code>logger.info(f&quot;[list-mode] injected {n_injected}/{len(frag_paths_ordered)} captions&quot;)</code>.                                                                                    </td><td data-label="Justification"> Useful for post-conversion diagnostics.                                                  </td></tr><tr><td data-label="Area"> <strong>7. Backward Compatibility</strong> </td><td data-label="Implementation Plan"> If <code>labels</code> is <code>None</code> or <code>from_list</code> is <code>False</code>, <code>_caption_for</code> should behave as before. No new branches should run.                                                                                                                                        </td><td data-label="Justification"> Guarantees existing jobs, HTML/PDF generations remain 100% identical.                    </td></tr><tr><td data-label="Area"> <strong>8. Testing</strong>                </td><td data-label="Implementation Plan"> Test all three cases: <br>• Standard conversion (no labels).<br>• List form with valid labels.json (full caption match).<br>• List form with partial labels (only some chapters labeled).                                                                   </td><td data-label="Justification"> Confirms resilience and compatibility.                                                   </td></tr><tr><td data-label="Area"> <strong>9. Security & Stability</strong>   </td><td data-label="Implementation Plan"> Ensure <code>labels</code> is checked for being a dict and that all keys are plain alphanumeric strings. Any non-compliant entries are skipped with a warning.                                                                                                         </td><td data-label="Justification"> Prevents malicious injection or corrupted JSON from user uploads.                        </td></tr></tbody></table></div><div class="row-count">Rows: 9</div></div><div class="table-caption" id="Table5" data-table="Docu_0100_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Layer"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Layer</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by File"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">File</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Purpose"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Purpose</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Caption Handling"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Caption Handling</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Layer"> <strong>Server</strong> </td><td data-label="File"> <code>core_renderer.py</code> </td><td data-label="Purpose"> Renders HTML (including captions) before sending to browser </td><td data-label="Caption Handling"> Inserts <code>&lt;div class=&quot;table-caption&quot; id=&quot;...&quot;&gt;</code> <strong>immediately before</strong> each table fragment </td></tr><tr><td data-label="Layer"> <strong>Client</strong> </td><td data-label="File"> <code>script.toc.js</code>    </td><td data-label="Purpose"> Builds dynamic TOC from headings or captions                </td><td data-label="Caption Handling"> Looks for elements with <code>.table-heading</code> — but <strong>not</strong> <code>.table-caption</code>                   </td></tr></tbody></table></div><div class="row-count">Rows: 2</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>