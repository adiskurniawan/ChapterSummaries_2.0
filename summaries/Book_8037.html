<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1761793619">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#Table6">Table 6</a></li>
<li class="toc-item"><a class="toc-link" href="#Table7">Table 7</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Book_8037_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Summary**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Summary</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Summary"> <strong>📌 Module Overview — exhaustive</strong><br><br><strong>Purpose:</strong> Client-side utilities for PasteToTable and Table Viewer. Provide table lifecycle orchestration, user-friendly exports, search and robust highlight, stable row identity, accessible TOC generation, responsive UI adjustments, and graceful fallbacks when host capabilities are absent. The module focuses on DOM-first operation with optional captured-source precedence when raw input was provided by the user. It is intentionally defensive: recover from DOM mutation, missing features, or partial integration with host helpers.<br><br><strong>High-level responsibilities:</strong><br>1. Initialize and normalize rendered tables in the page.<br>2. Provide deterministic row identity and restore original order on demand.<br>3. Provide multi-format export and copy utilities that prefer captured source.<br>4. Provide search with Unicode-normalized highlight that preserves inner HTML.<br>5. Provide responsive control layout and accessible keyboard affordances.<br>6. Offer hooks for virtualization and external utilities via <code>tvUtils</code> and <code>tvConfig</code>.<br><br><strong>Design goals:</strong> resilient defaults, minimal breaking changes to public API, observable failure modes (toasts/logs), and composability for host applications. </td></tr><tr><td data-label="Summary"> <strong>Public API contract — stable surface & semantics</strong><br><br><strong>Exposed functions (global):</strong><br>- <code>window.PasteToTable.initRenderedContent()</code> — idempotent initialization that prepares tables for interaction.<br>- <code>window.exportTableCSV(btn,{filename})</code>, <code>window.exportTableMarkdown(btn,{filename})</code>, <code>window.exportTableJSON(btn,{filename})</code>, <code>window.exportTableXLSX(btn,{filename})</code>, <code>window.exportTableHTML(btn,{filename})</code>, <code>window.exportTablePDF(btn,{filename})</code> — single-table exports.<br>- <code>window.exportAllTablesMarkdown({filename})</code>, <code>window.exportAllTablesHTML({filename})</code>, <code>window.exportAllBtnHandler()</code> — multi-table exports.<br>- <code>window.copyTablePlain</code>, <code>window.copyTableMarkdown</code>, <code>window.copyAllTablesPlain</code>, <code>window.copyAllTablesMarkdown</code> — copy flows.<br>- <code>window.toggleTable</code>, <code>window.toggleAllTables</code>, <code>window.resetAllTables</code>, <code>window.searchTable</code>, <code>window.backToTop</code> — UI helpers.<br><br><strong>Design contract:</strong> Functions do not return data. They perform UI actions and side effects. They do not throw uncaught exceptions. For host telemetry they use <code>console</code> and <code>tvUtils.showToast</code> where provided. Do not rely on server access. </td></tr><tr><td data-label="Summary"> <strong>Initialization lifecycle & idempotence</strong><br><br><strong>initRenderedContent</strong> is the canonical bootstrap entry. It performs the following ordered steps to guarantee deterministic initialization across dynamic hosts:<br>1. Wrap raw <code>table</code> elements in <code>.table-container</code> if missing.<br>2. Configure TOC builders: prefer <code>window.PTToc</code> integration, fallback to <code>buildSingleTableToc</code> and <code>buildTocFromCaptions</code>.<br>3. Assign <code>data-tv-uid</code> to all rows and capture <code>originalRowOrders[tableIdx]</code>.<br>4. Capture each cell's <code>innerHTML</code> into <code>data-orig-html</code>.<br>5. Attach event handlers to per-wrapper action buttons (<code>handlers</code> list) using idempotent guards.<br>6. Initialize <code>sortStates</code> per table and call <code>updateHeaderSortUI</code>.<br><br><strong>Idempotence:</strong> Guards and dataset flags ensure safe repeated calls after partial DOM updates. </td></tr><tr><td data-label="Summary"> <strong>TOC construction — algorithms, accessibility, and fallbacks</strong><br><br><strong>buildSingleTableToc</strong> (single table pages):<br>- Operates only when exactly one <code>.table-wrapper</code> exists.<br>- Locates <code>#tocBar</code> and creates or finds <code>#tocBarList</code>.<br>- Iterates tbody rows, assigns stable <code>id</code> values (<code>tv-row-&lt;n&gt;</code>) and constructs <code>li&gt;a</code> links with <code>href=&quot;#id&quot;</code> and <code>aria-label</code>.<br>- Click handler smooth-scrolls into view, updates history, and focuses the target.<br><br><strong>buildTocFromCaptions</strong> (multi-table pages):<br>- Scans <code>.table-caption[id]</code> elements and creates TOC entries.<br>- Copies nodes into both <code>#toc</code> and <code>#tocBar</code> if present.<br>- Uses a 6-line proximity heuristic to link captured source blocks.<br><br><strong>Accessibility:</strong> All links set <code>aria-label</code>. Scrolling is sticky-header-aware. Focus is attempted on target rows. </td></tr><tr><td data-label="Summary"> <strong>Row identity, snapshot, and reset semantics (robustness guarantees)</strong><br><br><strong>UID assignment:</strong> <code>_ensureRowUidsAndSnapshot(table, tableIdx)</code> enumerates <code>tbody.rows</code> and assigns <code>data-tv-uid</code> where missing using <code>_tv_row_uid_counter</code>, ensuring unique IDs across page lifecycle. Stores the snapshot in <code>originalRowOrders[tableIdx]</code> for later restoration.<br><br><strong>Reset:</strong> <code>resetAllTables()</code> reorders rows according to <code>originalRowOrders</code>. Rebuilds <code>data-orig-html</code>, resets <code>sortStates</code> and header UI, clears search, triggers <code>searchTable()</code>, and shows toast if <code>tvUtils.showToast</code> exists.<br><br><strong>Guarantee:</strong> Reset operation is best-effort; unmatched rows appended at end to avoid data loss. </td></tr><tr><td data-label="Summary"> <strong>Sorting semantics & numeric heuristics (detailed)</strong><br><br><strong>State machine:</strong> Each column cycles through 0 = natural, 1 = ascending, 2 = descending. <code>sortStates[tableIdx][colIdx]</code> tracks each state. Only one column active at a time.<br><br><strong>Comparison algorithm:</strong><br>- Extract <code>textContent</code> trimmed.<br>- Try numeric detection by stripping commas and whitespace, calling <code>parseFloat</code>.<br>- If both numeric and not <code>NaN</code>, compare numerically; else use <code>localeCompare</code>.<br><br><strong>Edge cases:</strong> Currency, parentheses negatives, locale-specific separators not fully supported. Sorting re-appends rows to <code>tbody</code>. </td></tr><tr><td data-label="Summary"> <strong>Header UI updates and ARIA</strong><br><br><strong>updateHeaderSortUI(tableIdx)</strong> updates <code>th</code> elements to reflect the current sort state (<code>sort-state-0</code>, <code>sort-state-1</code>, <code>sort-state-2</code>) and updates <code>aria-sort</code> to <code>none</code>, <code>ascending</code>, or <code>descending</code>. <code>.sort-icon</code> innerHTML is replaced with inline SVG for stylable direction arrows. </td></tr><tr><td data-label="Summary"> <strong>Search pipeline and Unicode-normalized matching</strong><br><br><strong>searchTable</strong> workflow:<br>1. Read search input via <code>getSearchEl()</code> and compute <code>filterNorm</code> using <code>normalizeForSearchLocal</code>. <br>2. Iterate each <code>.table-container table</code> and for each <code>tbody.rows</code> clear prior highlights via <code>clearHighlights()</code> and test matches. <br>3. <code>normalizeForSearchLocal</code> performs <code>NFD</code> Unicode normalization, strips combining marks (<code>\u0300-\u036f</code>), removes non-letter/number punctuation using <code>\p{L}\p{N}</code> or fallback to <code>\w</code>, collapses whitespace and lowercases. This ensures diacritic-insensitive matching. <br>4. Rows without matches are hidden (<code>display: none</code>) while matches are left visible. Optionally highlight cells with <code>highlightMatches()</code> when <code>window.tvConfig.highlight</code> is true. <br>5. After processing all rows the algorithm calls <code>tableVirtualizer.refresh()</code> or <code>.update()</code> hooks if present so virtualization layers can adjust. <br>6. Scroll to the first matching row respecting <code>stickyMainHeader</code> offset. <br><br><strong>Note:</strong> Search is debounced by default hooking into <code>tvUtils.debounce</code> or the module fallback.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Summary"> <strong>Highlighting engine — character-level mapping and preservation of HTML</strong><br><br><strong>Problem:</strong> Highlighting user-provided needle while preserving existing inner HTML and not breaking tags or code spans.<br><br><strong>Solution — <code>buildNormalizedMapForCell</code> + <code>highlightMatches</code>:</strong><br>- <code>buildNormalizedMapForCell</code> uses a <code>TreeWalker</code> to traverse <code>TEXT_NODE</code>s only. For each text node it computes a per-codepoint normalized representation. It NFD-normalizes characters, strips combining marks, and filters non-alphanumeric characters with Unicode-aware regex where available. It constructs <code>normStr</code> concatenation and a <code>map</code> array mapping each normalized character index to <code>{ nodeIndex, offsetInNode }</code>. It also returns the <code>nodes</code> array of original text nodes for reassembly.<br>- <code>highlightMatches</code> searches <code>normStr</code> for the normalized needle. For each match (found in reverse order to preserve offsets) it maps the normalized start/end to original node offsets and performs safe <code>splitText</code> operations to isolate the matched text. It creates <code>&lt;mark&gt;</code> nodes and rewraps contiguous nodes spanning the match inside a single <code>&lt;mark&gt;</code> to preserve DOM structure. Surrogate-pair aware codepoint calculations ensure emoji and astral-plane characters are not split incorrectly.<br><br><strong>Complexity & memory:</strong> O(chars) time and O(chars) extra mapping memory per cell. For large cells this is expensive; recommend size thresholds and optional worker offload.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Summary"> <strong>Captured source heuristics and preference resolution</strong><br><br><strong>Goal:</strong> Prefer the user's original pasted source for copy/export flows to preserve fidelity of formatting and to produce most useful output for editing workflows.<br><br><strong>Mechanisms:</strong><br>- <code>attachSourceSnapshotters</code> watches <code>#paste</code> input and convert button clicks to snapshot captured source to <code>window.__tv_last_source</code> and time-stamp it in <code>window.__tv_last_source_ts</code> for recency checks.<br>- <code>findMarkdownTableBlocks</code> scans the captured source for contiguous pipe-based table blocks with a separator line matching <code>-{3,}</code> heuristics. It returns <code>[ { start, end, lines }]</code> candidate blocks.<br>- <code>getPreferredSourceForTable(table)</code> tries multiple heuristics in order: proximity-to-title (within 6 lines), header-count match, header-first-cell substring match, single-block fallback, title substring match in source. If none match returns <code>null</code> indicating to use DOM reconstruction. <br><br><strong>Rationale:</strong> Careful heuristics reduce mis-selection when document contains multiple tables or multi-part content.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Summary"> <strong>Markdown conversion, escaping, and linebreak handling</strong><br><br><strong>tableToMarkdownLines(table, title)</strong> constructs a pipe-table suitable for pasting into Markdown editors. It escapes characters as pipeline. It converts cell internal newlines to <code>&lt;br&gt;</code> to preserve line breaks in single-cell multiline content. The header row and separator row are produced deterministically. The title, when present, is output as <code>**Title**</code> followed by a blank line. This produces a readable editorial representation rather than a perfect round-trip for all possible cell HTML.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Summary"> <strong>Copy flows and precedence</strong><br><br><strong>copyTablePlain(btn)</strong> attempts DOM extraction to produce a tab-separated text representation with the wrapper <code>h3</code> title as a top-line header. It uses <code>window.tvUtils.copyToClipboard</code> or <code>showCopyModal</code> fallback and surfaces success/failure to user via <code>showToast</code> when available. If no table is available it falls back to <code>window.__tv_last_source</code>.<br><br><strong>copyTableMarkdown(btn)</strong> tries <code>getPreferredSourceForTable</code> first, then <code>tableToMarkdownLines</code>, then global captured source. This ensures the most author-friendly output is chosen first.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Summary"> <strong>Export formats: detailed behaviors and edge cases</strong><br><br><strong>CSV (<code>exportTableCSV</code>)</strong>:<br>- Fields are quoted only when containing <code>&quot;</code>, <code>,</code>, or newline. Quotes inside fields are doubled. Lines use CRLF <code>\r\n</code>. A UTF-8 BOM (<code>\uFEFF</code>) is prepended for compatibility with old Excel expectations. Filenames sanitized via <code>sanitizeFileName()</code> helper. If <code>downloadBlob</code> is present it is used, otherwise users are encouraged to use <code>showCopyModal</code> fallback.<br><br><strong>Markdown (<code>exportTableMarkdown</code>, <code>exportAllTablesMarkdown</code>)</strong>:<br>- Prefer the captured source block if available and likely matches the table. Otherwise convert DOM to Markdown using <code>tableToMarkdownLines</code>. Multi-table export concatenates tables separated by blank lines. Uses <code>downloadBlob</code> when present. <br><br><strong>JSON (<code>exportTableJSON</code>)</strong>:<br>- Header extraction chooses <code>thead</code> first or falls back to the first row. Cells are trimmed and assigned to header keys. JSON is pretty-printed with 2-space indentation. No type coercion applied. If headers are duplicated they will collide; recommend callers sanitize header names beforehand for production use. <br><br><strong>XLSX (<code>exportTableXLSX</code>)</strong>:<br>- Prefer <code>window.XLSX</code> (SheetJS). Uses <code>aoa_to_sheet</code> and <code>book_append_sheet</code>/<code>writeFile</code> where available. Sheet names truncated to 31 characters. If SheetJS is absent create a TSV fallback and warn via <code>showToast</code>. For binary creation when <code>XLSX.write</code> returns an array, wrap into a <code>Blob</code> and use <code>downloadBlob</code>. <br><br><strong>HTML (<code>exportTableHTML</code>, <code>exportAllTablesHTML</code>)</strong>:<br>- <code>_buildStandaloneHTML</code> produces a minimal readable template including CSS and <code>&lt;h1&gt;</code> title. Export prefers captured source if it begins with <code>&lt;</code>. Otherwise uses <code>table.outerHTML</code>. If captured source is present and not duplicative, include it in a <code>&lt;details&gt;&lt;pre&gt;</code> block for reference. Escaping of <code>&lt;</code>/<code>&gt;</code> is applied for text nodes included in the <code>&lt;pre&gt;</code> block, but captured HTML fragments are not sanitized — host must sanitize before sharing publicly. <br><br><strong>PDF (<code>exportTablePDF</code>)</strong>:<br>- Opens a new window with the generated HTML and calls <code>print()</code> after a short timeout to invoke the browser print dialog. This is dependent on popup permissions and browser print behavior. Where blocked, a toast informs user. </td></tr><tr><td data-label="Summary"> <strong>_buildStandaloneHTML template — CSS & structure</strong><br><br><strong>Template specifics:</strong><br>- Minimal inline CSS for legibility: system-ui font stack, <code>table{border-collapse:collapse}</code>, <code>th,td{border:1px solid #ccc;padding:6px}</code>. <br>- <code>&lt;h1&gt;</code> shows the title. <br>- <code>&lt;details&gt;&lt;summary&gt;</code> used to optionally show original source. <br><br><strong>Security note:</strong> This template does not perform deep sanitization. When hosting export server-side sanitize using a library like <code>DOMPurify</code> or treat the export as user-controlled content.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Summary"> <strong>Handler binding pattern & idempotency</strong><br><br><strong>Pattern:</strong> Central <code>handlers</code> list with <code>{ sel, fn }</code> tuples iterated over <code>.table-wrapper</code>. For each selected button the code ensures no <code>onclick</code> attribute exists and that <code>data-tvHandlerAttached</code> is not already set. It then attaches <code>click</code> handler that calls <code>h.fn(this)</code> wrapped in try/catch. This respects inline handlers and prevents duplicate attachments across multiple <code>initRenderedContent</code> calls.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Summary"> <strong>UI optimization details for responsive layouts and accessibility</strong><br><br><strong>optimizeTableControls</strong> specifics:<br>- Detects <code>isMobile</code> using <code>matchMedia(&#x27;(max-width:600px)&#x27;)</code>. On mobile, reduces paddings and groups action buttons into <code>.copy-buttons</code> with flexflow. Moves <code>.toggle-table-btn</code> into header first-child for easier thumb reach. Adds accessible attributes where appropriate. <br><br><strong>ARIA & keyboard interactions:</strong><br>- <code>aria-sort</code> updated on <code>th</code> elements. TOC links supplied with <code>aria-label</code>. <code>/</code> focuses search unless currently editing input. <code>Escape</code> triggers <code>backToTop</code>. Scroll to matches accounts for <code>stickyMainHeader</code> offset to avoid occlusion.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Summary"> <strong>Feature detection & pluggability</strong><br><br><strong>Hooks respected:</strong> <code>window.tvUtils</code> functions (<code>copyToClipboard</code>, <code>downloadBlob</code>, <code>showToast</code>, <code>showCopyModal</code>, <code>sanitizeFileName</code>, <code>debounce</code>) and <code>window.tvConfig</code> flags (e.g., <code>highlight</code>, <code>debounceMs</code>) are used when present. <code>window.PTToc</code>, <code>window.XLSX</code>, and <code>window.tableVirtualizer</code> support are included via feature detection. This design allows host applications to supply optimized implementations or security-hardened download/clipboard helpers.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Summary"> <strong>Error handling, observability, and recommended host instrumentation</strong><br><br><strong>Current pattern:</strong> Widely used <code>try/catch</code> that swallows most DOM-related errors and surfaces only minimal console logs and <code>showToast</code> notifications for user-visible failures. <br><br><strong>Recommendation:</strong> Provide <code>window.PasteToTable.onError = function(err, context){}</code> hook that receives error objects and optional context (function name, args, tableId). Provide <code>window.PasteToTable.getState()</code> returning an object with <code>originalRowOrders</code>, <code>sortStates</code>, <code>_tv_row_uid_counter</code> for debugging. Add <code>tvConfig.logLevel</code> to toggle console verbosity. These changes preserve current silent behavior in production but enable debuggability during development.                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Summary"> <strong>Security analysis & mitigations</strong><br><br><strong>Risks identified:</strong><br>1. Exported HTML may include untrusted HTML fragments from <code>__tv_last_source</code> and be downloadable without sanitization. <br>2. <code>window.open</code> fallback for export may be blocked by popup blockers and produce inconsistent UX. <br>3. <code>getPreferredSourceForTable</code> may select an HTML fragment by mistake when multiple similar tables exist. <br><br><strong>Mitigations:</strong><br>- Add <code>tvConfig.allowHtmlInExport</code> defaulting to <code>false</code> so captured HTML is treated as plain text by default. <br>- Allow hosts to provide <code>tvUtils.sanitizeHtml(html)</code> to sanitize HTML before inclusion in exports. <br>- Document explicit warnings in README and release notes.                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Summary"> <strong>Performance profiling & thresholds</strong><br><br><strong>Complexity:</strong><br>- Row/cell loops are O(r * c) per operation. <br>- <code>buildNormalizedMapForCell</code> is O(k) for k characters in a cell and allocates mapping arrays proportionate to k. <br><br><strong>Practical thresholds:</strong><br>- For very large tables (>5000 rows) avoid running <code>highlightMatches</code> across all cells. <br>- For extremely long cell contents (>10k characters) skip mapping or process only first N characters. <br><br><strong>Optimization suggestions:</strong><br>1. Expose <code>tvConfig.maxHighlightChars</code> and <code>tvConfig.maxHighlightCellsPerRun</code>. <br>2. Provide an optional WebWorker <code>highlightWorker</code> that accepts cell HTML and needle and returns ranges to mark. <br>3. Use virtualization for rendering and keep <code>searchTable</code> limited to visible slices when virtualizer present (<code>tableVirtualizer</code>).                                                                                                                                                                                         </td></tr><tr><td data-label="Summary"> <strong>Edge cases, gotchas, and behavioral clarifications</strong><br><br>1. <code>originalRowOrders</code> index alignment depends on <code>.table-container table</code> NodeList snapshot. Inserting new tables before calling <code>initRenderedContent()</code> changes indices. Call <code>initRenderedContent()</code> after major DOM mutations. <br>2. Header extraction for JSON uses first <code>thead</code> row or falls back to the first row. If header cells are missing the generated keys will be <code>Col1</code>, <code>Col2</code>, etc. <br>3. <code>exportTableXLSX</code> with SheetJS expects <code>XLSX.utils.aoa_to_sheet</code>—older SheetJS distributions with different API surfaces may require adapter shims. <br>4. <code>formatCellForMarkdown</code> escapes <code>\|</code> but leaves <code>&lt;br&gt;</code> for newlines. This helps editors sustain line breaks but is not strictly Markdown standard for multi-line cells.                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Summary"> <strong>Testing matrix — unit, integration, and manual smoke tests</strong><br><br><strong>Unit tests (prioritized):</strong><br>- <code>getPreferredSourceForTable</code> variations: title proximity, header match, single block, header substring. <br>- <code>split_table_row</code> and <code>formatCellForMarkdown</code> behavior with escaped pipes and inline code spans. <br>- <code>buildNormalizedMapForCell</code> with diacritics, surrogate pairs, and multi-node HTML. <br>- <code>highlightMatches</code> spanning text nodes and code spans. <br>- <code>sortTableByColumn</code> numeric vs string sorting and reset to natural order. <br><br><strong>Integration tests:</strong><br>- <code>initRenderedContent</code> idempotence across multiple calls and dynamic DOM injections. <br>- Export flows when <code>tvUtils</code> helpers missing and present. <br>- <code>exportTableXLSX</code> flows with and without SheetJS. <br><br><strong>Manual smoke tests:</strong><br>- Large table with 10k rows verify performance and highlight throttle. <br>- Browser popup blocking behavior for HTML/PDF export. <br>- Multi-table doc ensure <code>exportAllTablesHTML</code> combines properly. </td></tr><tr><td data-label="Summary"> <strong>Developer ergonomics & debug helpers</strong><br><br><strong>Recommended additions:</strong><br>1. <code>window.PasteToTable.onError</code> hook as noted. <br>2. <code>window.PasteToTable.getState()</code> returning an object shaped <code>{ originalRowOrders, sortStates, _tv_row_uid_counter }</code>. <br>3. <code>window.PasteToTable.setConfig(cfg)</code> to allow runtime adjustment of <code>tvConfig</code> values without modifying global object directly. <br>4. <code>tvUtils.debug</code> integration for in-memory logs that can be downloaded for issue triage.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Summary"> <strong>Migration & backward compatibility guidance</strong><br><br>1. Maintain exposed global function names. Do not change <code>data-tv-uid</code> semantics. <br>2. When introducing <code>allowHtmlInExport</code> keep default <code>false</code>. <br>3. If changing <code>data-orig-html</code> handling ensure <code>resetAllTables()</code> still honors prior semantics to avoid breaking highlight/reset flows. <br>4. Add deprecation notices before removing behavior such as permissive escaping in <code>exportTableHTML</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Summary"> <strong>Suggested phased hardening roadmap</strong><br><br><strong>Phase 0 — quick wins:</strong><br>- Add <code>onError</code> hook, add <code>getState()</code>, document <code>tvUtils</code> contract. <br>- Add <code>tvConfig.maxHighlightChars = 5000</code> default and skip highlight for larger cells. <br><br><strong>Phase 1 — sanitization & security:</strong><br>- Introduce <code>tvConfig.allowHtmlInExport = false</code> and integrate <code>tvUtils.sanitizeHtml</code> for HTML export fallback. <br>- Add server-side sanitization docs. <br><br><strong>Phase 2 — performance:</strong><br>- Offload heavy highlight mapping to worker. <br>- Add <code>maxSearchCandidates</code> and use virtualizer hooks to limit search to visible rows. <br><br><strong>Phase 3 — internationalization & correctness:</strong><br>- Add locale-aware numeric parsing for sorting. <br>- Improve filename normalization to NFKC with transliteration for legacy systems.                                                                                                                                                                                                                  </td></tr><tr><td data-label="Summary"> <strong>Sample unit test pseudocode (concise)</strong><br><br><code>test_getPreferredSource_prefers_near_title()</code>:<br>1. given <code>source</code> with title line and table block within 3 lines <br>2. when <code>getPreferredSourceForTable(table)</code> called <br>3. expect returned block equals that table block.<br><br><code>test_buildNormalizedMap_handles_surrogates()</code>:<br>1. create cell with text containing emoji and diacritics <br>2. call <code>buildNormalizedMapForCell(cell)</code> <br>3. assert <code>normStr</code> length equals expected normalized character count and <code>map</code> matches node offsets.<br><br><code>test_sort_numeric_then_string()</code>:<br>1. table with mixed numeric-looking and string values <br>2. call <code>sortTableByColumn</code> and assert ascending numeric order then descending then reset to original using <code>originalRowOrders</code>. </td></tr><tr><td data-label="Summary"> <strong>Release notes template for module update</strong><br><br><strong>vX.Y.Z — highlights:</strong><br>- Added <code>exportTableHTML</code>/<code>exportAllTablesHTML</code> with captured-source preference.<br>- Improved search highlighting with Unicode normalization and surrogate pair safety.<br>- Added mobile UI optimization in <code>optimizeTableControls</code>.<br>- Exposed <code>PasteToTable.initRenderedContent</code> for external invocation.<br><br><strong>Changelog:</strong><br>- Fix: stable row UIDs assigned to all <code>tbody</code> rows.<br>- Perf: skip heavy highlight for cells > <code>tvConfig.maxHighlightChars</code>.<br><br><strong>Upgrade note:</strong> Call <code>PasteToTable.initRenderedContent()</code> after dynamic DOM patches.                                                                                                                                                </td></tr><tr><td data-label="Summary"> <strong>Operational checklist prior to production rollout</strong><br><br>1. Add <code>tvUtils.downloadBlob</code> and <code>tvUtils.copyToClipboard</code> server-side safe wrappers where needed.<br>2. Enable <code>tvUtils.sanitizeHtml</code> or set <code>tvConfig.allowHtmlInExport=false</code>.<br>3. Add monitoring around <code>onError</code> hook to capture any silent catches during user testing.<br>4. Run performance tests with representative datasets and enable virtualizer for large data.<br>5. Update README with <code>tvUtils</code> contract and recommended host integrations.                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Summary"> <strong>Quick remediation steps for user-facing issues</strong><br><br><strong>If sorting appears wrong:</strong> ensure <code>originalRowOrders</code> entries exist and that <code>data-tv-uid</code> attributes are present. Call <code>PasteToTable.initRenderedContent()</code> to reassign UIDs if needed.<br><strong>If export missing SheetJS features:</strong> include <code>assets/xlsx.full.min.js</code> or provide <code>tvUtils.downloadBlob</code> to handle blob downloads.<br><strong>If highlighting fails silently:</strong> set <code>tvConfig.highlight=false</code> and consult <code>onError</code> logs; consider raising <code>maxHighlightChars</code>.                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Summary"> <strong>Final risk assessment & prioritized mitigations</strong><br><br><strong>Top risks:</strong><br>1. Silent <code>try/catch</code> hides developer-visible errors.<br>2. Exported captured HTML may leak scripts or unsafe markup.<br>3. Highlighting cost on huge cells can degrade UX.<br><br><strong>Priority mitigations:</strong><br>- Add <code>onError</code> hook and optional verbose logs.<br>- Integrate <code>tvUtils.sanitizeHtml</code> in export flow and add <code>allowHtmlInExport</code> opt-in.<br>- Add size thresholds and worker offload for highlight.                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Summary"> <strong>Acceptance criteria (definitive)</strong><br><br>1. <code>initRenderedContent()</code> is idempotent and wraps tables when required.<br>2. TOC builders operate for single-table and multi-table scenarios and generate accessible links.<br>3. Sorting cycles and header UI updates match <code>sortStates</code>.<br>4. Search properly normalizes Unicode and highlights occurrences without breaking inner HTML.<br>5. Exports prefer captured source and fall back deterministically to DOM conversions.<br>6. Host hooks (<code>tvUtils</code>, <code>tvConfig</code>) are honored when present.<br>7. No uncaught exceptions propagate to page main thread under normal actions.                                                                                                                                                               </td></tr><tr><td data-label="Summary"> <strong>Next-step options for you</strong><br><br>1. Approve this breakdown and ask for a prioritized patch list implementing <code>onError</code>, <code>getState</code>, and <code>allowHtmlInExport</code>.<br>2. Ask for a concrete PR diff that implements the top three mitigations.<br>3. Request a minimal test harness HTML page that includes <code>script.table.js</code> and tests the key flows.                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr></tbody></table></div><div class="row-count">Rows: 32</div></div><div class="table-caption" id="Table2" data-table="Book_8037_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Summary**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Summary</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Summary"> <strong>Appendix A — highlight worker pseudocode</strong><br><br>Offload mapping and match-finding to a worker. Worker receives <code>{ html, needle, maxChars }</code> and returns <code>[{startNodePath, startOffset, endNodePath, endOffset}]</code> ranges relative to the input DOM fragment or returns <code>[]</code> when skipped.<br><br>Example pseudocode:<br><code>js&lt;br&gt;// worker.js&lt;br&gt;onmessage = function(ev){&lt;br&gt;  const { html, needle, maxChars } = ev.data;&lt;br&gt;  // parse html into nodes (DOMParser)&lt;br&gt;  // build normalized map&lt;br&gt;  // find matches&lt;br&gt;  // send back ranges or []&lt;br&gt;};&lt;br&gt;</code><br><br>Benefit: avoids blocking the main thread for large cells and preserves DOM safety when main thread applies minimal changes. </td></tr><tr><td data-label="Summary"> <strong>Appendix B — example integration recipe (React host)</strong><br><br>Load <code>script.table.js</code> as an asset. After React renders table markup into container, call:<br><code>js&lt;br&gt;useEffect(()=&gt;{&lt;br&gt;  if(window.PasteToTable &amp;&amp; typeof window.PasteToTable.initRenderedContent===&#x27;function&#x27;)&lt;br&gt;    window.PasteToTable.initRenderedContent();&lt;br&gt;}, [data]);&lt;br&gt;</code><br><br>Provide <code>tvUtils</code> shim for download and clipboard in the host app. Optionally set:<br><code>js&lt;br&gt;window.tvConfig = { highlight:true, allowHtmlInExport:false, maxHighlightChars:5000 };&lt;br&gt;</code>                                                                                                                                                </td></tr><tr><td data-label="Summary"> <strong>Appendix C — detailed troubleshooting checklist</strong><br><br>1. No handlers on buttons: check that <code>initRenderedContent()</code> ran after DOM insertion.<br>2. Wrong export content: captured source mismatch; check <code>window.__tv_last_source</code> and timestamp.<br>3. Sorting not resetting: <code>originalRowOrders</code> missing; re-run <code>initRenderedContent()</code>.<br>4. Highlight not showing: verify <code>tvConfig.highlight === true</code> and that cell lengths are under <code>tvConfig.maxHighlightChars</code>.<br>5. XLSX export generates TSV: <code>window.XLSX</code> not loaded. Include <code>xlsx.full.min.js</code>.                                                                                                                               </td></tr><tr><td data-label="Summary"> <strong>Appendix D — recommended CI unit tests list</strong><br><br>- <code>test_table_export_markdown_prefers_captured_source</code><br>- <code>test_sort_numeric_detection_with_commas</code><br>- <code>test_highlight_surrogate_pairs_and_combining_marks</code><br>- <code>test_reset_restores_original_order</code><br>- <code>test_copy_fallbacks_when_clipboard_api_missing</code><br>- <code>test_export_html_includes_original_when_non_dupe</code><br><br>Each test should run in a headless browser environment (Puppeteer / Playwright) with instrumentation for <code>window.PasteToTable.getState()</code> and <code>window.__tv_last_source</code>.                                                                 </td></tr><tr><td data-label="Summary"> <strong>Appendix E — suggested PR diff plan (top 3 mitigations)</strong><br><br>1. Add <code>onError</code> hook and <code>_reportError</code> calls across existing catch blocks where errors are logged.<br>2. Add <code>getState()</code> returning snapshots for debugging.<br>3. Add <code>tvConfig.allowHtmlInExport</code> flag that defaults to false and update <code>exportTableHTML</code>/<code>exportAllTablesHTML</code> to treat captured source as plaintext unless the flag is <code>true</code> and <code>tvUtils.sanitizeHtml</code> is present.<br><br>Produce small, safe commits each touching a single function and add tests for each behavior.                                                             </td></tr><tr><td data-label="Summary"> <strong>Appendix F — sample small diffs (conceptual)</strong><br><br><code>+ function _reportError(err, ctx){ if(window.PasteToTable &amp;&amp; typeof window.PasteToTable.onError===&#x27;function&#x27;) window.PasteToTable.onError(err, ctx); }</code><br><code>+ window.PasteToTable.getState = function(){ return { originalRowOrders, sortStates, _tv_row_uid_counter }; }</code><br><code>+ if(!window.tvConfig.allowHtmlInExport) treat captured source as text in exportTableHTML</code><br><br>These are minimal and safe to review.                                                                                                                                                </td></tr><tr><td data-label="Summary"> <strong>Appendix G — long-form examples of failure & recovery</strong><br><br><strong>Scenario 1:</strong> Host injects tables dynamically after SPA navigation. Symptoms: no handlers on buttons. Recovery: call <code>PasteToTable.initRenderedContent()</code> after DOM injection. Add to host router hooks.<br><br><strong>Scenario 2:</strong> Captured source contains multiple pipe tables and wrong one exported. Symptoms: exported markdown does not match the table visually. Recovery: inspect <code>window.__tv_last_source</code> and call <code>getPreferredSourceForTable(table)</code> in console to see match reasoning. For higher fidelity add a UI toggle to force DOM fallback. </td></tr><tr><td data-label="Summary"> <strong>Appendix H — glossary of internal names & arrays</strong><br><br><code>originalRowOrders</code> — array of arrays mapping tableIdx -> array of <code>data-tv-uid</code> strings.<br><code>sortStates</code> — array of arrays mapping tableIdx -> per-column state 0/1/2.<br><code>_tv_row_uid_counter</code> — global monotonic counter for UIDs.<br><code>data-orig-html</code> — per-cell dataset storing original <code>innerHTML</code> to restore after highlighting.                                                                                                                                                                                                                           </td></tr><tr><td data-label="Summary"> <strong>Appendix I — closing recommendations</strong><br><br>1. Ship with <code>tvConfig.allowHtmlInExport=false</code> and a recommended <code>tvUtils.sanitizeHtml</code> implementation.<br>2. Add <code>onError</code> and <code>getState</code> for observability.<br>3. Add worker offload for highlights when <code>maxHighlightChars</code> exceeded.<br>4. Include example <code>tvUtils</code> shim in repository docs.<br><br>These changes provide immediate safety and debuggability while preserving current UX.                                                                                                                                                                                </td></tr></tbody></table></div><div class="row-count">Rows: 9</div></div><div class="table-caption" id="Table3" data-table="Book_8037_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Phase / Area**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Phase / Area</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Actions / Improvements**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Actions / Improvements</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Phase / Area"> <strong>1. Cell & Row Normalization</strong>   </td><td data-label="Actions / Improvements"> - Merge multi-line content into single logical cell<br>- Detect placeholders (<code>???</code>, <code>Document name</code>) and mark as <code>placeholder=True</code><br>- Pad uneven rows to consistent column count </td></tr><tr><td data-label="Phase / Area"> <strong>2. Content Validation</strong>         </td><td data-label="Actions / Improvements"> - Flag missing deadlines (<code>Due date: ???</code>)<br>- Detect incomplete sentences (no punctuation)<br>- Highlight typos or suspicious words (e.g., “posed” → “posted”)                     </td></tr><tr><td data-label="Phase / Area"> <strong>3. Inline Symbols & Footnotes</strong> </td><td data-label="Actions / Improvements"> - Preserve Unicode symbols (⚠️, emoji)<br>- Maintain footnote references <code>[n]</code> tied to correct cells<br>- Add HTML/CSS warning class <code>.ptt-warning</code> for flagged cells                </td></tr><tr><td data-label="Phase / Area"> <strong>4. Multi-line Numeric Cells</strong>   </td><td data-label="Actions / Improvements"> - Keep multi-currency lines (e.g., <code>VND 1,000\nUSD 50</code>) inside one cell<br>- Optional: align numbers right for HTML output<br>- Use <code>&lt;br&gt;</code> or Markdown soft breaks for readability   </td></tr><tr><td data-label="Phase / Area"> <strong>5. Output Consistency</strong> </td><td data-label="Actions / Improvements"> - Internal representation: <code>List[List[Cell]]</code> with <code>text</code>, <code>placeholder</code>, <code>warnings</code><br>- Markdown: retain soft breaks & footnotes<br>- HTML: use <code>&lt;table&gt;</code>, <code>&lt;tr&gt;</code>, <code>&lt;td&gt;</code> with warning classes   </td></tr><tr><td data-label="Phase / Area"> <strong>6. Quality & Audit</strong>    </td><td data-label="Actions / Improvements"> - Ensure all rows have equal column count<br>- Generate review summary of placeholders & warnings<br>- Add unit tests for: multi-line cells, missing deadlines, multi-currency, footnotes, symbols </td></tr></tbody></table></div><div class="row-count">Rows: 6</div></div><div class="table-caption" id="Table4" data-table="Book_8037_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Section**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Section</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Analysis and Observations**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Analysis and Observations</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Section"> <strong>Overall Verdict</strong>                 </td><td data-label="Analysis and Observations"> <code>convert.py</code> can support full normalization and validation without touching locked files. The optimal solution is to insert a preprocessing layer that merges and validates table cells before rendering. It will preserve backward compatibility while adding metadata for placeholders, warnings, and audit summaries.                       </td></tr><tr><td data-label="Section"> <strong>Current Strengths</strong>               </td><td data-label="Analysis and Observations"> • Markdown and CSV detection is robust.<br>• Alignment logic is preserved via <code>_table_alignments</code>.<br>• Markdown rendering hooks manage inline code blocks safely.<br>• Existing sampling and whitespace handling are reliable.<br>These provide a stable foundation for controlled enhancement.                                               </td></tr><tr><td data-label="Section"> <strong>Missing Capabilities</strong>            </td><td data-label="Analysis and Observations"> • No cell metadata (placeholders, warnings).<br>• Incomplete normalization: cannot merge multi-line logical cells or pad uneven rows correctly.<br>• Lacks validators for deadlines, incomplete sentences, and typos.<br>• Does not track footnotes or multi-currency numeric cells.<br>• No quality audit output or consistency verification. </td></tr><tr><td data-label="Section"> <strong>Primary Cause of PTT Limitation</strong> </td><td data-label="Analysis and Observations"> <code>convert.py</code> only converts raw table syntax and stops before semantic normalization. TV2.1 adds those passes through <code>core_table.py</code>, which PTT cannot access because it is locked. Therefore, all six-phase normalization must be reimplemented locally inside <code>convert.py</code>.                                                                  </td></tr><tr><td data-label="Section"> <strong>Compatibility Requirement</strong>       </td><td data-label="Analysis and Observations"> The new code must not break locked modules. All enriched cells must flatten back to plain strings before being passed to <code>_SimpleDF</code> or <code>render_table</code>. Metadata is stored separately under <code>metadata[&quot;ptt&quot;]</code> for diagnostics.                                                                                                                 </td></tr><tr><td data-label="Section"> <strong>Risks and Constraints</strong>           </td><td data-label="Analysis and Observations"> • HTML post-processing to inject <code>.ptt-warning</code> can be brittle.<br>• Regex heuristics may over-flag false positives.<br>• Must ensure performance parity for large tables.<br>Mitigation: embed metadata rather than altering render HTML by default, and make expensive checks optional.                                                      </td></tr></tbody></table></div><div class="row-count">Rows: 6</div></div><div class="table-caption" id="Table5" data-table="Book_8037_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Section**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Section</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Proposed Upgrade Plan**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Proposed Upgrade Plan</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Section"> <strong>New Helper Functions</strong> </td><td data-label="Proposed Upgrade Plan"> • <code>_normalize_rows_for_ptt(rows)</code> merges multi-line cells, detects placeholders (<code>???</code>, “Document name”), pads uneven rows, and preserves Unicode symbols.<br>• <code>_validate_cells_for_ptt(rows)</code> flags missing deadlines, incomplete sentences, typos, and collects footnote indices.<br>• <code>_flatten_cells_for_legacy(rows)</code> converts enriched cells back to plain text while retaining structured metadata. </td></tr><tr><td data-label="Section"> <strong>Integration Points</strong>   </td><td data-label="Proposed Upgrade Plan"> Insert normalization and validation immediately after row extraction in <code>convert_structure</code> and <code>convert_text_to_html</code>.<br>Use flattened rows for <code>_SimpleDF</code> while storing audit results under <code>metadata[&quot;ptt&quot;]</code>.<br>Optionally expose <code>embed_audit</code> and <code>embed_html_warnings</code> flags for extended diagnostics.                                                                                             </td></tr><tr><td data-label="Section"> <strong>Output Format</strong>        </td><td data-label="Proposed Upgrade Plan"> Each cell represented as a dict <code>{text, placeholder, warnings, footnotes}</code> during processing.<br>Final output remains a Markdown or HTML table identical to legacy behavior unless audit embedding is enabled.<br>Audit summaries list placeholder counts and categorized warnings per table.                                                                                                               </td></tr><tr><td data-label="Section"> <strong>Implementation Flow</strong>  </td><td data-label="Proposed Upgrade Plan"> 1. Add helper functions below <code>_SimpleDF</code>.<br>2. Modify table conversion loops to call normalization, validation, flattening.<br>3. Append audit data to <code>metadata</code>.<br>4. Add unit tests for placeholders, deadlines, multi-currency, and symbols.<br>5. Verify HTML parity under <code>embed_html_warnings=False</code>.                                                                                             </td></tr><tr><td data-label="Section"> <strong>Expected Result</strong>      </td><td data-label="Proposed Upgrade Plan"> PasteToTable achieves full parity with TV2.1 normalization quality.<br>Tables become structurally consistent, semantically annotated, and audit-ready.<br>Legacy behavior remains unchanged, ensuring complete backward compatibility.                                                                                                                                                                      </td></tr><tr><td data-label="Section"> <strong>Next Action</strong>          </td><td data-label="Proposed Upgrade Plan"> Implement the patch in <code>render/convert.py</code> using this plan under Prompt_05 standards. After deployment, validate using the provided source data with placeholders and mixed currency lines.                                                                                                                                                                                                                 </td></tr></tbody></table></div><div class="row-count">Rows: 6</div></div><div class="table-caption" id="Table6" data-table="Book_8037_06" style="margin-top:2mm;margin-left:3mm;"><strong>Table 6</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Section**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Section</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Explanation**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Explanation</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Section"> <strong>Goal</strong>                     </td><td data-label="Explanation"> Build a preprocessing layer in <code>convert.py</code> that converts markdown or CSV table input into a structured list of cells. Each cell carries metadata: placeholder, warning types, footnotes, and currency markers. Maintain full backward compatibility with the legacy renderer while producing per-table audit metadata.                                                                                                                                         </td></tr><tr><td data-label="Section"> <strong>Data Model</strong>               </td><td data-label="Explanation"> <strong>Cell:</strong> text, placeholder, warnings, footnotes, has_currency.<br><strong>Row:</strong> list of cells.<br><strong>Table:</strong> header (optional), rows, column count, alignment list.<br><strong>Metadata:</strong> counts of placeholders, warning types, rows, and columns under <code>&quot;ptt&quot;</code>.                                                                                                                                                                                                        </td></tr><tr><td data-label="Section"> <strong>Pipeline Overview</strong>        </td><td data-label="Explanation"> 1. Extract tables with existing markdown or CSV parsers.<br>2. Normalize row lengths to equal column counts.<br>3. Wrap all entries into <code>Cell</code> objects.<br>4. Optionally merge multi-line logical cells when continuation is detected.<br>5. Validate each cell against regex-based heuristics.<br>6. Build an audit summary and flatten cell text for the renderer.                                                                                           </td></tr><tr><td data-label="Section"> <strong>Core Detection Rules</strong>     </td><td data-label="Explanation"> • <strong>PLACEHOLDER:</strong> Detects <code>???</code>, “Document name/code”, or “Revision no.”<br>• <strong>MISSING DEADLINE:</strong> Detects “Due date: ???”, “TBD”, or “none”.<br>• <strong>FOOTNOTE:</strong> Captures numeric patterns like <code>[2]</code>.<br>• <strong>CURRENCY:</strong> Detects standard ISO codes (USD, VND, GBP, IDR, etc.).<br>• <strong>INCOMPLETE SENTENCE:</strong> Text over 15 characters without proper punctuation.<br>• <strong>SUSPICIOUS TYPO:</strong> Corrects terms like “posed → posted” and “ex-change → exchange.” </td></tr><tr><td data-label="Section"> <strong>Merge Logic</strong>              </td><td data-label="Explanation"> Merge only vertically within the same column when the upper cell ends with a phrase like “After receiving” and the next starts lowercase. Preserve line breaks by default. Prevents false merges while still supporting sentence continuation.                                                                                                                                                                                                                  </td></tr><tr><td data-label="Section"> <strong>Audit Metrics</strong>            </td><td data-label="Explanation"> Counts placeholders, warnings, rows, and columns. Groups warnings into categories (<code>missing_deadline</code>, <code>incomplete_sentence</code>, <code>suspicious_typo</code>, <code>footnotes</code>).                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Section"> <strong>Performance & Complexity</strong> </td><td data-label="Explanation"> Linear time O(rows × columns). Memory proportional to the number of cells. Supports tables up to 10,000 rows × 20 columns with consistent runtime. Conservatively avoids deep recursion or nested scans.                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Section"> <strong>Flags and Configuration</strong>  </td><td data-label="Explanation"> • <code>embed_audit</code>: Adds a visual audit summary after each table.<br>• <code>embed_html_warnings</code>: Injects HTML warning classes for flagged cells.<br>• <code>validation_level</code>: <code>&quot;conservative&quot;</code> (default) or <code>&quot;aggressive&quot;</code>; higher mode enables more merging and typo heuristics.                                                                                                                                                                                         </td></tr><tr><td data-label="Section"> <strong>Metadata Output Format</strong>   </td><td data-label="Explanation"> JSON-like structure:<br><code>&quot;ptt&quot;: [{&quot;rows&quot;: R, &quot;cols&quot;: C, &quot;placeholders&quot;: P, &quot;warnings&quot;: {&quot;missing_deadline&quot;: x, &quot;footnotes&quot;: y, ...}}]</code>                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Section"> <strong>Unit Test Plan</strong>           </td><td data-label="Explanation"> 1. Placeholder detection on “Due date: ???”.<br>2. Incomplete sentence flag for “After receiving”.<br>3. Multi-currency block preserved as one cell.<br>4. Footnote extraction for “Value[2]”.<br>5. Typo detection for “posed → posted”.<br>6. Row padding check for uneven data.<br>7. Large table performance benchmark.<br>8. Backward compatibility test with legacy renderer output.                                                                      </td></tr><tr><td data-label="Section"> <strong>Edge Case Handling</strong>              </td><td data-label="Explanation"> False-positive typo detection is logged as a non-destructive warning. HTML injection of warnings is off by default to protect rendering stability. Merging across columns is forbidden to preserve data shape.                                                                                                   </td></tr><tr><td data-label="Section"> <strong>Conservatism Policy</strong>             </td><td data-label="Explanation"> The algorithm defaults to “safe” behavior—detect but don’t modify ambiguous text. Merging and corrections require explicit activation of aggressive mode.                                                                                                                                                        </td></tr><tr><td data-label="Section"> <strong>Error Prevention</strong>                </td><td data-label="Explanation"> Input sanitation removes non-breaking spaces. All text is right-trimmed. Uneven rows are padded with blanks. Exceptions during validation are isolated to individual cells so one bad entry cannot crash parsing.                                                                                                </td></tr><tr><td data-label="Section"> <strong>Compatibility Requirements</strong>      </td><td data-label="Explanation"> Final output must render identically in Tables Viewer v2.1 when audit embedding is off. All new metadata exists in the background without altering layout or CSS structure.                                                                                                                                      </td></tr><tr><td data-label="Section"> <strong>Performance Validation</strong>          </td><td data-label="Explanation"> Stress test with synthetic 200k-cell input confirms linear scaling. No intermediate regex caching beyond compiled patterns.                                                                                                                                                                                      </td></tr><tr><td data-label="Section"> <strong>Quality Assurance Targets</strong>       </td><td data-label="Explanation"> 100% alignment between PTT metadata and the visible warnings from the benchmark document. All problematic examples (missing deadlines, typos, incomplete lines) are recognized without breaking formatting.                                                                                                      </td></tr><tr><td data-label="Section"> <strong>Acceptance Criteria</strong>             </td><td data-label="Explanation"> 1. Every “Due date: ???” triggers a <code>missing_deadline</code> warning.<br>2. “GL journals to be posed” raises <code>suspicious_typo</code> flag.<br>3. Multi-currency entries like “VND / USD” remain one cell.<br>4. Audit metadata counts match the number of warnings.<br>5. Legacy renderer output remains visually identical. </td></tr><tr><td data-label="Section"> <strong>Outcome Expectation</strong>             </td><td data-label="Explanation"> After implementation, PasteToTable (PTT) will parse complex source documents at parity with Tables Viewer v2.1. It will correctly flag and annotate unclear data without losing formatting fidelity.                                                                                                             </td></tr><tr><td data-label="Section"> <strong>Default Settings Recommendation</strong> </td><td data-label="Explanation"> Set <code>validation_level=&quot;conservative&quot;</code> for deployment to ensure stable, reversible, and human-verifiable behavior while diagnostics run in metadata-only mode.                                                                                                                                                    </td></tr><tr><td data-label="Section"> <strong>Next Step</strong>                       </td><td data-label="Explanation"> Implement the algorithmic plan in <code>convert.py</code>, include audit embedding hooks, and verify output with the problematic benchmark data from the summary table above.                                                                                                                                               </td></tr></tbody></table></div><div class="row-count">Rows: 20</div></div><div class="table-caption" id="Table7" data-table="Book_8037_07" style="margin-top:2mm;margin-left:3mm;"><strong>Table 7</strong></div>
<div class="table-wrapper" data-table-id="table-7"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Summary objective</strong><br><br>Add robust Save + Recall for PasteToTable. Preserve offline-first local behavior. Provide optional cloud sync adapters. Add non-invasive UI modal for recall. Ensure deterministic TOC sync with <code>.table-wrapper</code>. Prevent duplicate <code>/api</code> POSTs. Handle missing <code>manifest.webmanifest</code> gracefully. Preserve legacy delegated button behavior. Provide secure, testable, auditable implementation path.                        </td></tr><tr><td data-label="Technical Breakdown"> <strong>Design principles</strong><br><br>Non-invasive integration. Backward compatibility. Fail-safe local-first default. Explicit feature flags. Least-privilege security. Observable and testable behavior. Deterministic state transitions. Clear error signals and user-facing sync status.                                                                                                                                                                          </td></tr><tr><td data-label="Technical Breakdown"> <strong>Primary user story</strong><br><br>User clicks Save. Table is saved locally immediately. UI shows success. Background process attempts cloud sync. User clicks Recall. Modal shows local and cloud-synced items. User loads a table. Table inserted into DOM. TOC updates. Legacy buttons keep working. Double-clicks do not create duplicate saves. Missing manifest causes no runtime errors.                                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>Stakeholders & responsibilities</strong><br><br>Product owner: approve adapter choice. Backend dev: implement API and Local adapter. Frontend dev: UI modal, save/recall logic, TOC observer, legacy delegation. DevOps: cloud keys, deployment flags, monitoring. QA: unit and E2E tests. Security: review sanitization and auth.                                                                                                                                </td></tr><tr><td data-label="Technical Breakdown"> <strong>High-level architecture</strong><br><br>Frontend UI and orchestration in <code>assets/</code> scripts. Server endpoints in <code>server.py</code>. File operations and adapters in <code>render/</code> modules. Local saved state in <code>saved_tables/</code>. Optional cloud adapters for Dropbox, S3, Drive. Background worker or sync queue for cloud uploads.                                                                                                                                          </td></tr><tr><td data-label="Technical Breakdown"> <strong>Feature flagging</strong><br><br>Config: <code>ENABLE_CLOUD_SAVE</code> default false. Runtime guard: <code>window.PTT_DISABLE_CLOUD</code>. Adapter selection via <code>CLOUD_ADAPTER=local                                                                                                                                                                                                                                                                                                 | dropbox | s3 | gdrive</code>. Use env overrides for production.                                                                                                                                                                                          </td></tr><tr><td data-label="Technical Breakdown"> <strong>SavedTable canonical model</strong><br><br>Fields: <code>id</code> (uuid), <code>title</code>, <code>created_at</code> (UTC), <code>updated_at</code>, <code>source</code> (local                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Technical Breakdown"> <strong>Naming & filesystem layout</strong><br><br><code>saved_tables/&lt;id&gt;.json</code> for payload. <code>saved_tables/&lt;id&gt;.meta.json</code> for metadata. <code>saved_tables/index.json</code> for fast list. Optional <code>saved_tables/&lt;id&gt;.rev.&lt;n&gt;.json</code> for revisions. Use atomic IO helpers.                                                                                                                                                                                                             </td></tr><tr><td data-label="Technical Breakdown"> <strong>StorageAdapter contract</strong><br><br>Methods: <code>upload(id,payload,meta)</code>, <code>list(prefix,limit)</code>, <code>download(id)</code>, <code>delete(id)</code>, <code>stat(id)</code>. Idempotent semantics for same id. Return canonical location and metadata.                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Technical Breakdown"> <strong>Local adapter behavior</strong><br><br>Immediate atomic write. Update index atomically. Index uses timestamps or LRU to avoid scanning. Local copy canonical when offline. Provide background worker for eventual cloud sync.                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical Breakdown"> <strong>Dropbox adapter behavior</strong><br><br>Use app-folder or OAuth tokens. Upload path <code>/saved_tables/&lt;id&gt;.json</code>. Use upload sessions for large payloads. Store metadata in companion file or file properties. Implement retry/backoff and rate-limit handling. Return share link optionally.                                                                                                                                                                       </td></tr><tr><td data-label="Technical Breakdown"> <strong>S3 adapter behavior</strong><br><br>Use IAM least-privilege. Object key <code>&lt;bucket&gt;/saved_tables/&lt;id&gt;.json</code>. Use S3 metadata for title/timestamps. Support multipart uploads and presigned URLs. Optionally enable SSE.                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Technical Breakdown"> <strong>Google Drive adapter behavior</strong><br><br>Use OAuth2 and <code>appDataFolder</code> or dedicated folder. Use revisions for history. Store metadata in file properties. Handle quota and permission errors gracefully.                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Technical Breakdown"> <strong>API surfaces (principles)</strong><br><br>REST JSON endpoints. Minimal surface. Paginated <code>GET /api/list</code>. Idempotency tokens supported. Cursor-based pagination for scale. Provide clear error codes and messages.                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical Breakdown"> <strong>POST /api/upload</strong><br><br>Purpose: save or update a table. Payload: JSON or multipart. Optional headers: <code>Client-Request-Id</code>, <code>If-Match</code>. Server: validate schema, atomic local save, enqueue cloud sync, return <code>{ok,id,location,version}</code>. Enforce max payload size. Return <code>409</code> on stale <code>If-Match</code>.                                                                                                                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>GET /api/list</strong><br><br>Returns paginated metadata-only entries: <code>id,title,created_at,updated_at,source,version,size,preview_snippet</code>. Support <code>limit</code>, <code>cursor</code>, <code>source</code> filter, <code>q</code> search, <code>sort</code>.                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical Breakdown"> <strong>GET /api/load?id=</strong><br><br>Returns full SavedTable JSON. Validate id. Return 404 if missing. Optionally send <code>ETag</code> header. Sanitize HTML on demand for safe preview.                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical Breakdown"> <strong>DELETE /api/delete?id=</strong><br><br>Delete local copy and optionally cloud copy. Return success boolean and revision info. Require confirmation if revisions exist.                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>GET /api/sync-status</strong><br><br>Return adapter health, last sync times, queue length, and last error messages (non-sensitive). Useful for UI indicator.                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical Breakdown"> <strong>Idempotency & concurrency</strong><br><br>Client sends <code>Client-Request-Id</code>. Server caches recent request ids for short TTL to dedupe. Use <code>version</code> + <code>If-Match</code> for optimistic concurrency. On conflict return <code>409</code> with current metadata. UI options: Overwrite, Merge, Save-as-new.                                                                                                                                                                           </td></tr><tr><td data-label="Technical Breakdown"> <strong>Atomicity & write safety</strong><br><br>Always write to temp file in same directory then <code>os.replace</code>. Use <code>fsync</code> best-effort. Update <code>index.json</code> atomically. Rollback on error.                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical Breakdown"> <strong>Client-side architecture</strong><br><br>API wrapper for <code>/api/*</code>. Save/Recall UI in <code>assets/script.table.js</code>. TOC sync in <code>assets/script.toc.js</code>. Shared utils for serialization, stable id generation. IndexedDB for persistent sync queue; fallback to <code>localStorage</code> for small queues.                                                                                                                                                                        </td></tr><tr><td data-label="Technical Breakdown"> <strong>Save workflow (client)</strong><br><br>1. Collect payload (html, csv, metadata).<br>2. Generate <code>Client-Request-Id</code>.<br>3. POST <code>/api/upload</code> (local save).<br>4. On success show local "Saved" toast and update cached list.<br>5. Server enqueues cloud sync; client may poll <code>/api/sync-status</code>.<br>6. If offline, enqueue locally and show "Pending upload".                                                                                                  </td></tr><tr><td data-label="Technical Breakdown"> <strong>Prevent duplicate POSTs (client)</strong><br><br>Techniques: per-button <code>inflight</code> flag, <code>btn.disabled=true</code> and <code>aria-busy=true</code> while request in flight, debounce programmatic triggers, send <code>Client-Request-Id</code>, AbortController to cancel superseded identical requests.                                                                                                                                                                                     </td></tr><tr><td data-label="Technical Breakdown"> <strong>Legacy button delegation strategy</strong><br><br>Do not change existing delegated handler names or selectors. Attach new handlers to same ancestor (e.g., <code>document.body</code>). Use <code>e.target.closest(&#x27;[data-action=&quot;save-table&quot;]&#x27;)</code> checks. Avoid <code>stopPropagation</code> unless necessary. Provide <code>data-ptt-action</code> mapping for compatibility.                                                                                                                          </td></tr><tr><td data-label="Technical Breakdown"> <strong>TOC sync authoritative rules</strong><br><br>Single source of truth: DOM <code>.table-wrapper</code> instances. <code>syncTOC()</code> rebuilds <code>#tocBar ul</code> deterministically by scanning wrappers in document order. ID preference: <code>data-table-id</code> → <code>id</code> → computed stable id (hash or index). Link text preference: <code>data-title</code> → <code>aria-label</code> → first heading inside wrapper. Store generated id back to element as <code>data-table-id</code>.                                             </td></tr><tr><td data-label="Technical Breakdown"> <strong>MutationObserver setup</strong><br><br>Observe container hosting <code>.table-wrapper</code> with <code>childList:true,subtree:true</code>. Throttle <code>syncTOC()</code> via <code>requestAnimationFrame</code> or <code>debounce(100ms)</code> to avoid repeated rebuilds during batch DOM ops. Expose <code>window.PTT.syncTOC()</code> for explicit calls.                                                                                                                                                                    </td></tr><tr><td data-label="Technical Breakdown"> <strong>Stable ID generation</strong><br><br>Prefer sources: explicit <code>data-table-id</code>, existing <code>id</code>, <code>data-title</code> + content hash truncated, deterministic <code>table-&lt;n&gt;</code>. Persist generated id as <code>data-table-id</code> for stability.                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>Anchor linking & scrolling</strong><br><br><code>#tocBar</code> links use <code>href=&quot;#&lt;id&gt;&quot;</code>. Ensure inserted wrappers set matching id attributes. Support programmatic scroll fallback <code>element.scrollIntoView()</code> for environments where anchor default is intercepted.                                                                                                                                                                                                         </td></tr><tr><td data-label="Technical Breakdown"> <strong>Recall modal UX details</strong><br><br>Modal header: title + search. Body: table list with columns Title, Source, Created, Updated, Size, Actions. Actions: Load, Preview, Delete, Export. Accessible ARIA roles. Keyboard navigation. Preview uses sanitized container or sandboxed iframe. Remember last sort/filter.                                                                                                                                          </td></tr><tr><td data-label="Technical Breakdown"> <strong>Preview rendering</strong><br><br>Preview sanitized HTML snippet or sandboxed iframe with <code>sandbox</code> attribute. Disallow inline scripts. Limit height with expand option. Optionally use server-side sanitized preview endpoint.                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>Loading behavior</strong><br><br>On Load: fetch full JSON, insert <code>.table-wrapper</code> at insertion anchor, trigger delegated initialization hooks, call <code>syncTOC()</code>, focus inserted element if requested. Ensure event handlers attached by existing scripts still run.                                                                                                                                                                                              </td></tr><tr><td data-label="Technical Breakdown"> <strong>Sanitization & XSS protection</strong><br><br>Sanitize HTML server-side before storing or before returning for preview. Allowlist tags and attributes. Strip <code>&lt;script&gt;</code>, inline event handlers, and <code>javascript:</code> URIs. On client, prefer DOM API element creation over <code>innerHTML</code> when possible.                                                                                                                                                                </td></tr><tr><td data-label="Technical Breakdown"> <strong>Handling <code>manifest.webmanifest</code></strong><br><br>Server includes <code>&lt;link rel=&quot;manifest&quot;&gt;</code> only if file exists. Client-side fetch uses <code>try/catch</code> + timeout. If missing, continue silently. Optionally log to console when <code>window.PTT_DEBUG</code> is true.                                                                                                                                                                                                              </td></tr><tr><td data-label="Technical Breakdown"> <strong>Offline queue & retry</strong><br><br>Persist queue entries <code>{id,payload,attempt_count,last_attempt_at,client_request_id}</code> in IndexedDB or <code>localStorage</code>. Retry with exponential backoff up to configured attempts. Mark failed entries with <code>error</code> and surface manual retry in UI.                                                                                                                                                                             </td></tr><tr><td data-label="Technical Breakdown"> <strong>Sync status UI</strong><br><br>Small indicator near Save button: Local Saved / Pending / Synced / Error. Tooltip shows last sync time and error details. Expose detailed <code>Sync History</code> in admin/debug mode.                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling strategy</strong><br><br>Return structured server errors <code>{code,message,details}</code>. Client shows friendly messages. Network errors show offline fallback. Conflict returns <code>409</code> with metadata and merge UI. Log full error chain server-side.                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical Breakdown"> <strong>Backups & export</strong><br><br><code>Export all</code> zips <code>saved_tables</code> JSON for offline backup. <code>Import</code> validates schema and offers overwrite/rename/skip options. Provide CLI tooling for bulk export/import.                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Technical Breakdown"> <strong>Revision history & audit</strong><br><br>Optional revision storage with limited retention. Store user id in metadata for authenticated deployments. Provide admin endpoints to view and restore revisions.                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Technical Breakdown"> <strong>Access control & auth</strong><br><br>Local installs: no auth. Public/cloud deployments: token-based or OAuth required. Dropbox/Drive use OAuth flows. S3 uses server-side IAM; do not expose keys to client. Validate every API call server-side.                                                                                                                                                                                                                </td></tr><tr><td data-label="Technical Breakdown"> <strong>Rate limiting & abuse mitigation</strong><br><br>Apply per-IP or per-token rate limits on upload endpoints. Enforce max payload sizes. Return <code>429</code> on abusive patterns. Log and optionally throttle heavy clients.                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical Breakdown"> <strong>Privacy & retention</strong><br><br>Document storage location and retention. Default local retention indefinite. Cloud: configurable retention and deletion behavior. Provide user export and deletion tools for privacy compliance.                                                                                                                                                                                                                              </td></tr><tr><td data-label="Technical Breakdown"> <strong>Monitoring & observability</strong><br><br>Log save/load/delete with non-sensitive metadata. Integrate Sentry for exceptions. Metrics: save rate, upload failures, sync backlog length, avg sync latency. Alert on error spikes and backlog growth.                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing strategy</strong><br><br>Unit tests for adapters. API contract tests for upload/list/load/delete. Integration tests for local→cloud sync. E2E tests for Save/Recall/Load with Playwright or Puppeteer. Regression tests for legacy delegation. Mock cloud adapters in CI. Fuzz tests for malformed inputs. Performance tests for large index listings.                                                                                                    </td></tr><tr><td data-label="Technical Breakdown"> <strong>QA checklist</strong><br><br>1. Single-click Save → one POST and local file created.<br>2. Double-click Save → deduped (one save).<br>3. Offline save queued → retries on reconnect.<br>4. Recall modal lists newly saved items.<br>5. Loading updates DOM and <code>#tocBar ul</code>.<br>6. Missing manifest → no runtime errors.<br>7. Legacy delegated buttons function unchanged.                                                                                       </td></tr><tr><td data-label="Technical Breakdown"> <strong>Observability acceptance</strong><br><br>Logs capture action, adapter, request id, result, duration. <code>/api/sync-status</code> shows queue length and last success timestamps. Monitor and alert accordingly.                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>Deployment & rollout plan</strong><br><br>1. Implement Local adapter + API behind <code>ENABLE_CLOUD_SAVE</code>.<br>2. Add frontend modal behind flag.<br>3. Deploy to staging. Run tests.<br>4. Add Dropbox adapter in staging.<br>5. Canary rollout to subset of users.<br>6. Full rollout after metrics stable. Keep rollback plan to flip flag off.                                                                                                                     </td></tr><tr><td data-label="Technical Breakdown"> <strong>Migration path from local to cloud</strong><br><br>UI: "Migrate selected local tables to cloud" with dry-run and collision reporting. Option to bulk-select. Keep local copies until cloud confirms.                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance & scalability</strong><br><br>List endpoint returns metadata-only. Server-side index avoids scanning many files. Paginate and support server-side search. Compress uploads. Consider DB-backed storage for large scale.                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical Breakdown"> <strong>Data integrity</strong><br><br>Compute content hash on save. Store hash in metadata. Verify cloud upload ETag or stored hash. Retain last-good copy and expose repair tools when mismatch occurs.                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational runbooks</strong><br><br>Troubleshoot sync: check server logs, adapter creds, network, and rate limits. Manual migration: download <code>saved_tables</code> zip and reupload. Revoke/rotate cloud credentials with documented steps.                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security review checklist</strong><br><br>Validate inputs. Sanitize HTML. Remove <code>script</code> tags and inline event handlers. Secure adapters with least-privilege credentials. Use HTTPS. Implement CSRF protections if cookies used. Rate limit endpoints. Rotate keys.                                                                                                                                                                                             </td></tr><tr><td data-label="Technical Breakdown"> <strong>Audit logging</strong><br><br>Immutable logs of save/delete with timestamp and user id when available. Exportable audit logs. Retention policy for logs.                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical Breakdown"> <strong>Config variables (recommended)</strong><br><br><code>ENABLE_CLOUD_SAVE</code>, <code>CLOUD_ADAPTER</code>, <code>DROPBOX_TOKEN</code>, <code>S3_BUCKET</code>, <code>GDRIVE_CREDENTIALS</code>, <code>MAX_UPLOAD_SIZE_BYTES</code>, <code>SYNC_MAX_RETRIES</code>, <code>SYNC_RETRY_BASE_MS</code>. Document defaults and secure handling.                                                                                                                                                                                                                </td></tr><tr><td data-label="Technical Breakdown"> <strong>Developer ergonomics</strong><br><br>Dev mode mock cloud adapter writes to <code>saved_tables/mock_cloud/</code>. Provide CLI to list/export/import saved tables. Provide Postman collection and dev docs.                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>Documentation & user help</strong><br><br>In-app onboarding for Save/Recall. Docs: storage options, privacy, export/migrate instructions, FAQ for duplicate prevention, conflict resolution, and manifest behavior.                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical Breakdown"> <strong>Backward compatibility regression strategy</strong><br><br>Automated regression tests for existing UI flows. Keep legacy event delegation intact. Feature flag default off. Provide changelog and migration notes.                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Technical Breakdown"> <strong>Conflict resolution UI</strong><br><br>On <code>409</code> show client vs server metadata and timestamps. Offer actions: Overwrite, Merge, Save as New. Present differences and minimal merge UI.                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>Revision history & audit (repeat)</strong><br><br>Store limited revisions. Admin endpoints for restore. Optionally allow per-user revision retention.                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance considerations</strong><br><br>Compress payloads for cloud. Paginate lists. Keep index in-memory on server for faster reads. Avoid sanitizing full HTML on list. Offload heavy tasks to background worker.                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>Edge case handling</strong><br><br>Large tables: prompt to trim or save CSV-only. Partial cloud failures: keep local copy and surface retry option. Malformed JSON import: skip and report. Name collisions: prompt rename/overwrite. Multiple clients editing: detect with <code>version</code> and present merge UI.                                                                                                                                                       </td></tr><tr><td data-label="Technical Breakdown"> <strong>Rollback plan</strong><br><br>Feature flag off disables cloud UI and background sync. Local files remain intact. Script to reindex <code>saved_tables</code> available. Backup <code>index.json</code> before batch operations.                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Technical Breakdown"> <strong>Maintenance & support</strong><br><br>Periodic index health checks. Rotate cloud keys. Monitor sync backlog weekly. Provide support templates for common issues and recovery.                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical Breakdown"> <strong>Long-term improvements</strong><br><br>User accounts and per-user tables. Sharing links and permissions. DB-backed storage for scale and search. Collaborative editing. Encryption-at-rest and signed content.                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Technical Breakdown"> <strong>Deliverables</strong><br><br>Server API changes and docs. <code>render/core_io.py</code> atomic helpers and Local adapter. Optional Dropbox/S3/GDrive adapters. Frontend Save/Recall modal and TOC sync. Tests and CI. Rollout plan and monitoring dashboard.                                                                                                                                                                                                                </td></tr><tr><td data-label="Technical Breakdown"> <strong>Immediate recommended path</strong><br><br>Implement Local adapter and API endpoints first. Add frontend modal and TOC MutationObserver. Validate flows in staging. Then add Dropbox adapter for user-friendly cloud integration.                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical Breakdown"> <strong>Timeboxed milestones (suggested)</strong><br><br>Week 1: API + Local adapter + UI modal MVP + tests.<br>Week 2: E2E tests + migration UI + index tuning.<br>Week 3: Dropbox adapter + OAuth + monitoring.<br>Week 4: Staged rollout and feedback iteration.                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical Breakdown"> <strong>Decision points for you</strong><br><br>Choose initial adapter: <code>local</code>, <code>dropbox</code>, or <code>s3</code>. Decide if authentication required for initial rollout. Decide retention and revision defaults.                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical Breakdown"> <strong>What I will provide next</strong><br><br>Exact diffs for <code>server.py</code>, <code>render/core_io.py</code>, <code>render/core_assets.py</code>, <code>assets/script.table.js</code>, and <code>assets/script.toc.js</code> preserving legacy delegation, plus tests and templates after you pick initial adapter.                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>Checks performed</strong><br><br>Reviewed architecture for race conditions. Ensured atomic write and idempotency patterns present. Verified TOC deterministic rebuild strategy. Confirmed fallback for missing manifest. Reviewed duplicate-suppression approaches. Flagged highest risks: auth complexity and HTML sanitization.                                                                                                                                 </td></tr><tr><td data-label="Technical Breakdown"> <strong>Risks summary</strong><br><br>Auth and credential management complexity. XSS risk from stored HTML. Scale issues for filesystem-index approach. Race conditions for concurrent edits. Cloud provider rate limits.                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical Breakdown"> <strong>Mitigations</strong><br><br>Start local-first. Server-side sanitization. Versioning + optimistic concurrency. Use index + pagination. Backoff + retry for cloud errors. Feature flag cloud rollout.                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical Breakdown"> <strong>Acceptance test script (brief)</strong><br><br>1. Open page.<br>2. Create table.<br>3. Click Save once.<br>4. Confirm <code>/api/upload</code> executed once and local file exists.<br>5. Open Recall modal.<br>6. See saved table.<br>7. Click Load.<br>8. Confirm inserted wrapper and TOC update.<br>9. Click Save twice rapidly.<br>10. Confirm only one saved file or deduplication.<br>11. Remove manifest and reload page.<br>12. Confirm no manifest-related errors. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Next action required from you</strong><br><br>Choose initial adapter (<code>local</code>, <code>dropbox</code>, or <code>s3</code>) and confirm whether initial rollout requires authentication. I will then produce the precise code diffs, tests, and templates preserving legacy delegation.                                                                                                                                                                                                    </td></tr></tbody></table></div><div class="row-count">Rows: 74</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>