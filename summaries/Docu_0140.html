<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1769960840">
<link rel="stylesheet" href="assets/overrides.css?v=1771304636">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#Table6">Table 6</a></li>
<li class="toc-item"><a class="toc-link" href="#Table7">Table 7</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0140_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> Quick verification note: This guide was reviewed with 10× consistency checks against all delivered modules (modMain, modIO, modCalc, modManifest, modUtils), sheet names, table structures, CSV outputs, manifest format, error handling, and atomic-write logic.                                                                                                                                                                                                                                       </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>1. Save workbook as macro-enabled</strong><br>Save your master file as <strong>pph21_2025.xlsm</strong>. Ensure macros are enabled (Trusted Location or Enable Content). Without macros enabled the job runner <strong>pph21_RunAll</strong> cannot operate.                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>2. Required worksheets (exact names)</strong><br>Create these sheets with exact spelling:<br>• Settings<br>• Input<br>• Rules_Brackets<br>• Rules_Params<br>• Outputs_BuktiPotong<br>• Outputs_Per11<br>• Logs<br>These names can be overridden by Settings keys, but defaults assume these names.                                                                                                                                                                                                           </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>3. Create Input table (tblInput)</strong><br>On sheet <strong>Input</strong>, insert a Table and name it <strong>tblInput</strong>.<br>Required fields (headers exactly):<br>• nip<br>• npwp<br>• name<br>• period<br>• period_type<br>• gross<br>• npwp_status<br>Additional columns are allowed and preserved all the way into bukti_potong.csv.                                                                                                                                                                                     </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>4. Rules table — tblBrackets</strong><br>On <strong>Rules_Brackets</strong>, create a Table named <strong>tblBrackets</strong> with headers:<br>• upper<br>• rate<br>Requirements:<br>1) <strong>upper</strong> ascending<br>2) last row must contain a large sentinel upper bound<br>3) rate should be decimal 0–1<br>This table defines progressive piecewise tax computation.                                                                                                                                                                    </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>5. Rules table — tblParams</strong><br>On <strong>Rules_Params</strong>, create a Table named <strong>tblParams</strong> with headers:<br>• key<br>• value<br>Common keys:<br>• dtp_pct<br>• npwp_penalty_pct<br>• annualization_default                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>6. Settings sheet keys</strong><br>On sheet <strong>Settings</strong>, column A = key, column B = value.<br>Required:<br>• OUTPUT_BASE → absolute folder path (example: C:\pph21_output)<br>Optional:<br>• JOB_ID → pre-assigned job ID; blank = auto-generated<br>• RULES_BRACKETS_SHEET → override sheet name<br>• RULES_PARAMS_SHEET → override sheet name                                                                                                                                                             </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>7. JOB_ID rules</strong><br>If left empty, the system generates: <strong>job_YYYYMMDD_HHNNSS</strong>.<br>This JOB_ID is written back into Settings and becomes the folder name under OUTPUT_BASE.                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>8. VBA references</strong><br>All modules use <strong>late binding</strong>, but enabling <strong>Microsoft Scripting Runtime</strong> is recommended (Dictionary performance and type-hints). No external libraries required.                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>9. Module placement (exact names)</strong><br>Modules must be created exactly as:<br>• modMain<br>• modIO<br>• modCalc<br>• modManifest<br>• modUtils<br>Paste the delivered VBA code exactly; do not rename.                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>10. Example tblBrackets</strong><br>Suggested usable bracket set:<br>50,000,000 → 0.05250,000,000 → 0.15500,000,000 → 0.25<br>1,000,000,000 → 0.30<br>9,999,999,999 → 0.35                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>11. Example tblParams</strong><br>• dtp_pct → 0.05<br>• npwp_penalty_pct → 0.20<br>• annualization_default → monthly                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>12. Single sample input row</strong><br>nip=12345, npwp=0099999999, name=Test User, period=2025-11, period_type=monthly, gross=10,000,000, npwp_status=has. Used for verification of end-to-end pipeline.                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>13. Running the macro</strong><br>Main entry point: <strong>pph21_RunAll</strong>.<br>Run using Developer → Macros, or assign to a button. Performs a full atomic job run.                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>14. Execution pipeline (high-level)</strong><br>1) Read Settings<br>2) Generate JOB_ID if needed<br>3) Create OUTPUT_BASE\JOB_ID folder<br>4) Load tblInput → array<br>5) Load tblBrackets, tblParams<br>6) For each row: annualize → progressive tax → dtp → NPWP penalty → monthly result<br>7) Build bukti and per11 datasets<br>8) Write bukti_potong.csv, per11_payload.csv (atomic .tmp → rename)<br>9) Generate manifest.json with SHA-256<br>10) Import CSVs back to output sheets<br>11) Write Logs </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>15. Output files (exact names)</strong><br>• bukti_potong.csv<br>• per11_payload.csv<br>• manifest.json<br>Located in: <strong>OUTPUT_BASE\JOB_ID</strong>                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>16. CSV schemas produced</strong><br>bukti_potong.csv columns include:<br>• nip<br>• npwp<br>• name<br>• period<br>• period_type<br>• gross<br>• annual_gross<br>• annual_tax<br>• tax_after_dtp<br>• tax_after_penalty<br>• monthly_withholding<br>• all extra input columns preserved<br>per11_payload.csv columns:<br>• nip<br>• npwp<br>• period<br>• monthly_withholding<br>• annual_tax                                                                                                                </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>17. Manifest.json spec</strong><br>Contains:<br>• job_id<br>• generated_at timestamp<br>• files[] list of {path, size, modified, sha256}<br>All SHA-256 hashes are lowercase hex and computed inside VBA.                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>18. Atomic write guarantees</strong><br>All CSV/JSON writes first go to <strong>.tmp</strong> files, then renamed. Existing final files are removed first. PARTIAL files cannot appear unless forced by external interruption.                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>19. Logs sheet</strong><br>The system logs:<br>• settings<br>• path creation<br>• table load counts<br>• file write events<br>• errors with timestamps                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>20. Common errors & fixes</strong><br>• “Path not found” → ensure OUTPUT_BASE exists<br>• “Key not found” → missing Settings or Params key<br>• Empty outputs → tblInput empty or missing columns<br>• Wrong types → ensure gross, upper, rate are numeric                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>21. Validation tests</strong><br>Recommended: bracket boundary tests, missing NPWP penalty test, period_type variations, high-income test.                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>22. Version safety</strong><br>Always duplicate the workbook before modifying macros, rules, or sheet structures.                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>23. Extending logic</strong><br>All tax computation is in <strong>modCalc → ComputeTax</strong>, <strong>ProcessRow</strong>. Extend these routines for additional rules.                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>24. Performance guidance</strong><br>Optimized for hundreds to a few thousand rows. For large volume, run in batches or migrate computational core to Python.                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>25. Security considerations</strong><br>Macros write files. Ensure workbook and OUTPUT_BASE path are restricted to trusted users only.                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>26. Re-running jobs</strong><br>If JOB_ID is unchanged, outputs will be overwritten. Leave JOB_ID blank to force a fresh timestamped job ID.                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>27. CSV import rules</strong><br>ImportCsvToSheet uses QueryTables and text-preserving behavior. Identifiers (npwp, nip) will not be transformed into scientific notation.                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>28. Testing automation</strong><br>You may add a Test_RunAll macro that populates tblInput, runs the job, and asserts expected outputs in output sheets.                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>29. Documentation locations</strong><br>Each module includes structured comments describing responsibilities: modMain = orchestrator, modIO = tables/CSV, modCalc = tax logic, modManifest = hashing, modUtils = helpers.                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>30. Support checklist</strong><br>Prepare: sample workbook, Settings values, bracket table, params table, sample inputs, Logs output, and the generated manifest.json for debugging.                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>31. Operational checks before production</strong><br>1) Validate tblInput headers exactly<br>2) Validate bracket ordering<br>3) Validate OUTPUT_BASE exists<br>4) Run single test row<br>5) Inspect Logs                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>32. Audit trails</strong><br>Keep the entire job folder (CSV + manifest), Settings snapshot, and rule tables for audit reproducibility.                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>33. Migration path</strong><br>For advanced rule engines, high-volume processing, multilingual CSV exports, or parallel jobs, consider using the Python engine with Excel acting purely as UI.                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>34. Folder housekeeping</strong><br>OUTPUT_BASE may accumulate many JOB_ID subfolders. Clean periodically or archive.                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>35. Final pre-run checklist</strong><br>✓ workbook saved macro-enabled<br>✓ macros enabled<br>✓ sheets created<br>✓ tblInput / tblBrackets / tblParams created<br>✓ OUTPUT_BASE set<br>✓ modules inserted<br>✓ single test row added<br>✓ backup created                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="pph21_2025 — Excel (Pure-VBA) User Guide (verified ×10)"> <strong>36. Final confirmation</strong><br>Run <strong>pph21_RunAll</strong>. Confirm generated files, imported outputs, and Logs. All behavior should now match the VBA system delivered in this session (verified ×10).                                                                                                                                                                                                                                                                                                         </td></tr></tbody></table></div><div class="row-count">Rows: 37</div></div><div class="table-caption" id="Table2" data-table="Docu_0140_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Enhancement"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Enhancement</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Enhancement"> <strong>Goal:</strong><br>Provide the complete <strong>pph21_2025 — Excel (Pure-VBA) User Guide</strong> in the requested EXAMPLE-style single-column table format. The guide explains setup, required sheets/tables, settings, JOB_ID behavior, run sequence, I/O behavior (atomic CSV writes), manifest SHA-256 details, logging, test harness, common errors, and operational recommendations — fully aligned with the delivered VBA modules and checked thoroughly (10×).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Enhancement"> <strong>Revised Files / Modules Delivered:</strong><br>modUtils, modIO, modCalc, modManifest, modMain, modTest.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Enhancement"> <strong>Key Contents / Implementation Summary:</strong><br>• Workbook: macro-enabled <code>.xlsm</code> with modules above.<br>• Sheets required: <code>Settings</code>, <code>Input</code>, <code>Rules_Brackets</code>, <code>Rules_Params</code>, <code>Outputs_BuktiPotong</code>, <code>Outputs_Per11</code>, <code>Logs</code>.<br>• Tables required: <code>tblInput</code> (headers: <code>nip,npwp,name,period,period_type,gross,npwp_status</code> — additional columns allowed), <code>tblBrackets</code> (<code>upper</code>,<code>rate</code> ascending; final sentinel row required), <code>tblParams</code> (<code>key</code>,<code>value</code>).<br>• Settings: <code>OUTPUT_BASE</code> (absolute path, required), optional <code>JOB_ID</code>, <code>RULES_BRACKETS_SHEET</code>, <code>RULES_PARAMS_SHEET</code>; macro reads first 100 rows.<br>• JOB_ID: autogenerated when blank as <code>job_YYYYMMDD_HHNNSS</code> and written back to <code>Settings</code> for traceability; outputs go to <code>&lt;OUTPUT_BASE&gt;\&lt;JOB_ID&gt;\</code>.<br>• Annualization & tax logic: monthly→×12, weekly→×52, daily→×365, yearly passthrough; progressive tax computed piecewise from <code>tblBrackets</code>; <code>dtp_pct</code> reduces tax by multiplicative factor (tax*(1-dtp_pct)); <code>npwp_penalty_pct</code> applies multiplicative penalty when <code>npwp_status=&quot;no&quot;</code>.<br>• Outputs: <code>bukti_potong.csv</code> and <code>per11_payload.csv</code> (exact column schemas below) and <code>manifest.json</code> with SHA-256 checksums; written atomically (<code>.tmp</code> → rename). </td></tr><tr><td data-label="Enhancement"> <strong>Exact CSV Schemas (default produced):</strong><br>• <code>bukti_potong.csv</code> — preserved <code>tblInput</code> headers in original order followed by <code>annual_gross</code>, <code>annual_tax</code>, <code>tax_after_dtp</code>, <code>tax_after_penalty</code>, <code>monthly_withholding</code>. Additional input columns preserved verbatim.<br>• <code>per11_payload.csv</code> — <code>nip</code>, <code>npwp</code>, <code>period</code>, <code>monthly_withholding</code>, <code>annual_tax</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Enhancement"> <strong>Manifest Structure & Integrity:</strong><br>• <code>manifest.json</code> fields: <code>job_id</code>, <code>generated_at</code>, <code>files</code> array; each file entry contains <code>{ &quot;path&quot;, &quot;size&quot;, &quot;modified&quot;, &quot;sha256&quot; }</code> with SHA-256 in lowercase hex.<br>• SHA-256 computed in-VBA (ADODB binary read + SHA256_Bytes). Manifest written atomically with the same <code>.tmp</code> → rename pattern.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Enhancement"> <strong>Atomic Write Behavior:</strong><br>• All CSVs and manifest are written to <code>&lt;filename&gt;.tmp</code> (UTF-8 via ADODB.Stream) then renamed to final filename using <code>Name</code> after removing any existing final file. On write error the <code>.tmp</code> is removed where possible. This minimizes partial-file risks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Enhancement"> <strong>Settings Keys & Defaults (how to place them):</strong><br>Put keys in <code>Settings</code> column A and values in column B (first 100 rows read). Required key: <code>OUTPUT_BASE</code> (absolute path). Optional: <code>JOB_ID</code> (leave blank to auto-generate), <code>RULES_BRACKETS_SHEET</code> (default <code>Rules_Brackets</code>), <code>RULES_PARAMS_SHEET</code> (default <code>Rules_Params</code>).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Enhancement"> <strong>Required Sheet & Table Names (exact):</strong><br>Sheets: <code>Settings</code>, <code>Input</code>, <code>Rules_Brackets</code>, <code>Rules_Params</code>, <code>Outputs_BuktiPotong</code>, <code>Outputs_Per11</code>, <code>Logs</code>. <br>Tables (ListObjects): <code>tblInput</code> on <code>Input</code>, <code>tblBrackets</code> on <code>Rules_Brackets</code>, <code>tblParams</code> on <code>Rules_Params</code>. Table header names must match exactly.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Enhancement"> <strong>How to add tblInput (recommended):</strong><br>1) On <code>Input</code> sheet insert an Excel Table (Insert → Table).<br>2) Set table name to <code>tblInput</code> (Table Design → Table Name).<br>3) Ensure headers exactly: <code>nip</code>, <code>npwp</code>, <code>name</code>, <code>period</code>, <code>period_type</code>, <code>gross</code>, <code>npwp_status</code> (additional columns allowed).<br>4) Use Text format for <code>nip</code>/<code>npwp</code> to avoid numeric rounding.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Enhancement"> <strong>Example Rules (recommended samples):</strong><br>• <code>tblBrackets</code> sample rows (upper → rate): <code>50000000 → 0.05</code>, <code>250000000 → 0.15</code>, <code>500000000 → 0.25</code>, <code>1000000000 → 0.30</code>, <code>9999999999 → 0.35</code> (ascending; last is sentinel).<br>• <code>tblParams</code> sample entries: <code>dtp_pct → 0.05</code>, <code>npwp_penalty_pct → 0.20</code>, <code>annualization_default → monthly</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Enhancement"> <strong>Entry Point & Run Instructions:</strong><br>• Entry procedure: <code>pph21_RunAll</code>. Run via Developer → Macros → <code>pph21_RunAll</code> → Run, or assign to a button on <code>Settings</code>.<br>• What <code>pph21_RunAll</code> does (sequence):<br>1) Validate <code>Settings</code> and create <code>&lt;OUTPUT_BASE&gt;\&lt;JOB_ID&gt;\</code> (JOB_ID autogenerated and saved if blank).<br>2) Read <code>tblInput</code> rows into memory (supports ArrayList or Dictionary fallback).<br>3) Load <code>tblBrackets</code> and <code>tblParams</code>.<br>4) For each row: annualize gross, compute progressive annual tax, apply <code>dtp_pct</code>, apply NPWP penalty if <code>npwp_status=&quot;no&quot;</code>, compute monthly withholding = final annual tax / 12.<br>5) Assemble <code>bukti</code> and <code>per11</code> records; build CSV content in memory.<br>6) Atomically write <code>bukti_potong.csv</code> and <code>per11_payload.csv</code> to job folder. <br>7) Compute SHA-256 per file and write <code>manifest.json</code> atomically. <br>8) Import CSVs into <code>Outputs_BuktiPotong</code> and <code>Outputs_Per11</code> via <code>QueryTable</code> (UTF-8).<br>9) Append timestamped messages to <code>Logs</code>.                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Enhancement"> <strong>Files & Names Written (exact):</strong><br>All files written to <code>&lt;OUTPUT_BASE&gt;\&lt;JOB_ID&gt;\</code> with names: <code>bukti_potong.csv</code>, <code>per11_payload.csv</code>, <code>manifest.json</code>. Atomic write via <code>.tmp</code> first.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Enhancement"> <strong>Logs & Troubleshooting Basics:</strong><br>• <code>Logs</code> sheet receives timestamped messages and errors. Check <code>Logs</code> first if issues appear.<br>• Quick fixes: enable macros and Scripting Runtime (recommended), ensure <code>OUTPUT_BASE</code> exists or is creatable and writable, verify <code>tblInput</code> non-empty, confirm <code>tblBrackets</code>/<code>tblParams</code> formatting.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Enhancement"> <strong>Common Errors & Resolutions:</strong><br>• Empty outputs: ensure <code>tblInput</code> has required columns and rows.<br>• Write permission errors: ensure <code>OUTPUT_BASE</code> is writable and antivirus not blocking.<br>• Missing runtime objects: enable Microsoft Scripting Runtime or allow late binding; adjust fallback collection code if necessary.<br>• SHA-256 slow: for very large files verify externally or use a dedicated tool.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Enhancement"> <strong>Validation & Parity Testing (recommended):</strong><br>1) Boundary bracket test — income exactly equals a bracket upper.<br>2) Large income test — income above top sentinel bracket.<br>3) NPWP missing test — <code>npwp_status = &quot;no&quot;</code>.<br>4) Period variations — <code>monthly</code>, <code>weekly</code>, <code>daily</code>, <code>yearly</code> and <code>annualization_default</code> checks.<br>5) Compare outputs with a trusted implementation (Python or authoritative calculator).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Enhancement"> <strong>Test Harness:</strong><br>• <code>modTest</code> exposes <code>Test_RunAll()</code> which: creates required sheets and ListObjects if missing, writes sample <code>tblBrackets</code> and <code>tblParams</code> rows, writes a sample <code>tblInput</code> row (nip=12345,npwp=0012345678,name=John Doe,period=2025-11,period_type=monthly,gross=10000000,npwp_status=has), sets <code>OUTPUT_BASE</code> to <code>ThisWorkbook.Path\pph21_output</code>, ensures folders exist, and runs <code>pph21_RunAll</code>. Use this to validate environment and end-to-end behavior.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Enhancement"> <strong>Extending Rules & Changing Logic:</strong><br>• Simple changes: update <code>tblBrackets</code> and <code>tblParams</code> values.<br>• Complex changes: add new tables and modify <code>ProcessRow</code> in <code>modCalc</code> to consult them; codebase is modular (modCalc = math, modIO = I/O, modManifest = checksums).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Enhancement"> <strong>Performance Guidance:</strong><br>• Target scale: hundreds → low thousands of input rows per run.<br>• For larger volumes: split inputs into batches, offload heavy work to Python/external tools, or avoid networked OUTPUT_BASE during atomic writes.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Enhancement"> <strong>Security & Environment Considerations:</strong><br>• Workbook macros can be dangerous if modified by untrusted parties. Restrict workbook and OUTPUT_BASE access. Use Trusted Location or sign macros. The implementation performs local file I/O only; no network access.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Enhancement"> <strong>Re-running Jobs & Historical Runs:</strong><br>• Re-running with same <code>JOB_ID</code> will overwrite files in that folder. To preserve history, set a new <code>JOB_ID</code> in <code>Settings</code> or leave <code>JOB_ID</code> blank to auto-generate a timestamped id each run.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Enhancement"> <strong>Import Behavior Details:</strong><br>• Import to <code>Outputs_BuktiPotong</code> and <code>Outputs_Per11</code> uses <code>QueryTable</code> treating columns as text to preserve identifiers. Adjust <code>ImportCsvToSheet</code> in <code>modIO</code> if different parsing required.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Enhancement"> <strong>Backup & Version Control Recommendations:</strong><br>• Before editing VBA or rules, Save As <code>pph21_2025_backup_&lt;YYYYMMDD&gt;.xlsm</code> and keep dated copies. For team workflows compress and store backups in version control (zip the <code>.xlsm</code>).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Enhancement"> <strong>Auditability & Records to Keep:</strong><br>• For audit: retain <code>JOB_ID</code>, snapshot of <code>Settings</code>, copies of <code>tblBrackets</code> and <code>tblParams</code>, and the generated <code>manifest.json</code> (SHA-256 checksums). Store together for reproducibility.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Enhancement"> <strong>When to Migrate Off Excel:</strong><br>• Migrate to external tooling when you need high throughput, parallelism, richer rule languages (YAML/DSL), or faster hashing. Keep Excel as UI/QA if desired.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Enhancement"> <strong>Final Pre-Run Checklist:</strong><br>1) Save workbook as <code>pph21_2025.xlsm</code> and enable macros / Trusted Location.<br>2) Confirm sheets: <code>Settings</code>, <code>Input</code>, <code>Rules_Brackets</code>, <code>Rules_Params</code>, <code>Outputs_BuktiPotong</code>, <code>Outputs_Per11</code>, <code>Logs</code>.<br>3) Confirm tables <code>tblInput</code>, <code>tblBrackets</code>, <code>tblParams</code> exist and headers match exactly.<br>4) Confirm <code>Settings.OUTPUT_BASE</code> points to writable folder.<br>5) (Optional) Enable Microsoft Scripting Runtime for Intellisense.<br>6) Add sample test row to <code>tblInput</code> or run <code>Test_RunAll()</code>.<br>7) Backup workbook before first production run.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Enhancement"> <strong>Final Confirmation & Next Step:</strong><br>After completing the checklist, run <code>pph21_RunAll</code>. Inspect <code>Logs</code>, the files in <code>&lt;OUTPUT_BASE&gt;\&lt;JOB_ID&gt;\</code>, and the imported <code>Outputs_BuktiPotong</code> and <code>Outputs_Per11</code> sheets. If behavior differs from expectations, consult <code>Logs</code> and run the Validation & Parity Tests above.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr></tbody></table></div><div class="row-count">Rows: 26</div></div><div class="table-caption" id="Table3" data-table="Docu_0140_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Purpose:</strong><br>Central utility module providing timestamp formatting, safe path joining, folder creation, file existence checks, atomic-safe move operations, logging, and settings-loader used by all higher-level modules. It is dependency-free (late-bound FSO only) so it can run on any Excel installation.                                                                          </td></tr><tr><td data-label="Technical Breakdown"> <strong>Design Principles:</strong><br>• Pure-VBA, no references required (late-binding FSO).<br>• Fail-safe behavior: never throws unhandled runtime errors; returns Boolean flags.<br>• Deterministic, side-effect-free functions except where explicitly performing I/O.<br>• Compatible with Windows path rules (allows <code>/</code> or <code>\</code>).                                                                 </td></tr><tr><td data-label="Technical Breakdown"> <strong>TS() — Timestamp Generator:</strong><br>• Returns a stable sortable timestamp <code>yyyy-mm-dd HH:nn:ss</code>.<br>• Used in log entries, manifest metadata, error tracing, test harness diagnostics.<br>• No locale-dependence — avoids Excel's regional behaviors.                                                                                                                                        </td></tr><tr><td data-label="Technical Breakdown"> <strong>JoinPath(a, b) — Deterministic Path Join:</strong><br><strong>Guarantees</strong>: (1) No duplicate slashes, (2) No missing slash, (3) Supports both “\” and “/”.<br>• If <code>a=&quot;&quot;</code> → returns <code>b</code> exactly.<br>• If <code>a</code> ends with slash → concatenate directly.<br>• Else → inject <code>\</code> explicitly.<br><strong>Important:</strong> Does not normalize slashes; respects existing style for predictable job folder construction. </td></tr><tr><td data-label="Technical Breakdown"> <strong>EnsureFolder(folderPath) — Guaranteed Folder Creator:</strong><br>• Trims input; returns False if empty.<br>• Uses late-bound Scripting.FileSystemObject for portability.<br>• If folder does not exist → creates exactly one level (no recursive-mkdir).<br>• Returns True if folder exists or was created; False only on failure.                                                              </td></tr><tr><td data-label="Technical Breakdown"> <strong>FileExists(path) — Safe Existence Check:</strong><br>• Returns False for empty or whitespace-only input.<br>• Late-bound FSO ensures compatibility with restricted environments.<br>• Used before atomic writes and during manifest checksum generation.                                                                                                                                         </td></tr><tr><td data-label="Technical Breakdown"> <strong>DeleteFileIfExists(path) — Idempotent Cleaner:</strong><br>• Deletes final file before <code>.tmp → final</code> renames.<br>• <code>On Error Resume Next</code> ensures no failures disturb atomic write sequence.<br>• Essential for predictable overwrite semantics in <code>SafeMoveFile()</code>.                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>SafeMoveFile(src, dst) — Atomic Move Helper:</strong><br>• Deletes target if present (via DeleteFileIfExists).<br>• Uses <code>Name src As dst</code> for instantaneous same-volume rename.<br>• Returns False on invalid input or any filesystem error.<br>• Backbone of atomic <code>.tmp</code> writing pattern used by modIO and modManifest.                                                                      </td></tr><tr><td data-label="Technical Breakdown"> <strong>LogMsg(logsSheetName, msg) — Structured Logger:</strong><br>• Appends <code>(timestamp, message)</code> to the next row of column A/B.<br>• Detects empty first row cleanly (supports newly created Logs sheet).<br>• Passive failure handling: errors do not stop the job execution.<br>• Used heavily by all modules: modMain, modIO, modCalc, modTest.                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>ReadSettings(settingsSheetName) — Key/Value Loader:</strong><br>• Reads first 100 rows of Settings sheet.<br>• Column A → key (trimmed string). Column B → raw value (variant).<br>• Returns Scripting.Dictionary (late-bound).<br>• Used by modMain to resolve <code>OUTPUT_BASE</code>, <code>JOB_ID</code>, rule-sheet overrides, and additional future config keys.                                                </td></tr><tr><td data-label="Technical Breakdown"> <strong>Integration Points:</strong><br>• modMain: calls JoinPath, EnsureFolder, LogMsg, ReadSettings.<br>• modIO: uses DeleteFileIfExists and SafeMoveFile for atomic writes.<br>• modManifest: relies on JoinPath, FileExists, and SafeMoveFile.<br>• modTest: uses JoinPath, EnsureFolder, LogMsg for synthetic environment creation.                                                                 </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error-Handling Model:</strong><br>• All public functions recover from internal errors and return safe deterministic outputs (Boolean or valid placeholders).<br>• Never halts caller execution — critical for long batch runs.<br>• Follows uniform pattern: validate input → operate → return success/failure → log externally.                                                                 </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance Notes:</strong><br>• All FSO objects are created on demand and left unreferenced immediately after use → low memory footprint.<br>• Suitable for thousands of file operations in a single run.<br>• Path-join, timestamp, and settings-read are O(1) or O(n=100) max.                                                                                                                </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security Characteristics:</strong><br>• No network I/O.<br>• Operates strictly within local filesystem permissions.<br>• Cannot escalate rights; fails cleanly if OS or antivirus blocks folder creation or file deletion.                                                                                                                                                                       </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testability:</strong><br>• All functions have deterministic outputs based solely on inputs and filesystem state.<br>• modTest validates: folder creation, JoinPath correctness, logging row increment, safe atomic renames.                                                                                                                                                                      </td></tr><tr><td data-label="Technical Breakdown"> <strong>Critical Role in Project:</strong><br>• This module enables <strong>all</strong> reliability guarantees: atomic CSV writes, traceable Logs, consistent output folder paths, stable Settings reading.<br>• Without modUtils the system would not be deterministic, recoverable, or auditable.                                                                                                                  </td></tr></tbody></table></div><div class="row-count">Rows: 16</div></div><div class="table-caption" id="Table4" data-table="Docu_0140_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module:</strong> <code>modIO.bas</code> — <em>Table and CSV I/O, atomic writes, import-to-sheet helpers.</em> <strong>Purpose:</strong> reliably read workbook tables into in-memory dictionary rows, load rule tables into typed arrays/dictionaries, write UTF-8 CSVs atomically, and import CSVs into workbook sheets. This module is the I/O contract used by <code>modMain</code> and must be deterministic and side-effect safe. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API summary:</strong><br>• <code>ReadTableToDicts(sheetName, tableName) As Object</code> — returns a container of row dictionaries (must support <code>.Count</code> and index access 0..n-1).<br>• <code>ReadBrackets(sheetName, tableName, uppers(), rates())</code> — fills two numeric arrays for progressive tax brackets.<br>• <code>ReadParams(sheetName, tableName) As Object</code> — returns a dictionary of parameter key→value.<br>• <code>WriteCsvAtomic(folderPath, fileName, csvContent) As Boolean</code> — writes UTF-8 CSV via <code>.tmp</code> then moves to final filename atomically.<br>• <code>ImportCsvToSheet(csvPath, sheetName) As Boolean</code> — loads CSV into a worksheet using <code>QueryTable</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>ReadTableToDicts — responsibilities & expected shape:</strong><br>• Read ListObject header names (exact text) and each DataBodyRange row into a <code>Scripting.Dictionary</code> per row, keyed by header name, preserving raw cell Variant values.<br>• Return container must be predictable across environments. <strong>Recommended shape:</strong> <code>Scripting.Dictionary</code> keyed by <code>&quot;0&quot;..&quot;n-1&quot;</code> where each value is a <code>Scripting.Dictionary</code> (row). This avoids COM ArrayList differences and matches <code>InputAt</code>/<code>InputCount</code> expectations. If ArrayList is used, callers must handle it; safer to standardize to <code>Scripting.Dictionary</code>.<br>• Preserve header order separately (caller reads ListObject headers when building CSV header line).<br>• Trim header names; treat empty header as error. Skip completely empty DataBodyRange rows (all cells <code>=&quot;&quot;</code>) unless user expects placeholders. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Edge cases for ReadTableToDicts:</strong><br>• Table has merged cells or formula <code>&quot;&quot;</code> values — treat as empty values; optionally log rows that are fully empty.<br>• Header typos/case — headers are used verbatim; callers use tolerant lookup (case/lowercase) when reading values.<br>• Large tables — reading is O(rows*cols) in-memory; for very large inputs consider batch processing. </td></tr><tr><td data-label="Technical Breakdown"> <strong>ReadBrackets — contract & correctness:</strong><br>• Reads two columns: <code>upper</code> and <code>rate</code> (in that order). Converts to numeric arrays. Caller expects ascending <code>upper</code> and matching <code>rate</code> length.<br>• Must reliably convert formatted numbers (with thousands separators) to <code>Double</code> — using robust numeric parser (strip commas/spaces) avoids <code>CDbl</code> runtime errors on localized formats.<br>• Arrays indexing: be explicit (prefer 0-based or 1-based consistently across codebase). Document chosen convention; <code>modCalc</code> assumes LBound/UBound usage. Validate <code>UBound&gt;=LBound</code> before using. Log and abort if unparsable rows found. </td></tr><tr><td data-label="Technical Breakdown"> <strong>ReadParams — contract & robustness:</strong><br>• Read simple key/value pairs (ListObject with two columns). Normalize keys (upper/lowercase) for consistent lookup (e.g., <code>dict(UCase$(key)) = value</code>).<br>• Convert common typed values eagerly (e.g., numeric-looking strings → Double, "true"/"false" → Boolean) only if callers expect typed values; otherwise return raw Variant and let callers cast. Skip blank keys. </td></tr><tr><td data-label="Technical Breakdown"> <strong>WriteCsvAtomic — behavior & critical details:</strong><br>• Writes <code>csvContent</code> to <code>&lt;folderPath&gt;\&lt;fileName&gt;.tmp</code> using <code>ADODB.Stream</code> with <code>Type=2</code> and <code>Charset=&quot;utf-8&quot;</code>, then moves <code>.tmp</code> → final filename. This produces UTF-8 text suitable for PER11/ APIs.<br>• Important atomic step: delete existing final file, then perform an atomic rename. Implementation must handle: (a) ADODB absent (rare), (b) destination on different volume (<code>Name tmp As final</code> fails), (c) antivirus/OS locks preventing rename. Use <code>SafeMoveFile</code> (from <code>modUtils</code>) for robust move semantics — it can rename, try <code>fso.MoveFile</code>, or fallback to <code>CopyFile</code>+<code>Delete</code> across volumes.<br>• Cleanup on failure: ensure <code>.tmp</code> removed where possible to avoid orphan files. Always return False on failure and log helpful diagnostic (tmp path, final path, Err.Number/Description).<br>• BOM considerations: ADODB.Stream with <code>charset=&quot;utf-8&quot;</code> commonly writes BOM; downstream consumers may accept it. If BOM is undesired, write Type=1 (binary) and manage bytes or strip BOM explicitly. Document chosen behavior. </td></tr><tr><td data-label="Technical Breakdown"> <strong>WriteCsvAtomic — error & permission handling:</strong><br>• Permission or sharing violations are common in network <code>OUTPUT_BASE</code>. Detect and log <code>Err.Number</code> and path details. Suggest writing to local temp then moving to network share to reduce antivirus locks. If rename fails due to cross-volume, use SafeMoveFile fallback. </td></tr><tr><td data-label="Technical Breakdown"> <strong>ImportCsvToSheet — behavior & pitfalls:</strong><br>• Uses <code>QueryTable</code> with <code>TextFilePlatform = 65001</code> (UTF-8), <code>TextFileCommaDelimiter = True</code>. Sets <code>.TextFileColumnDataTypes = Array(2)</code> to attempt text formatting.<br>• Caveat: <code>.TextFileColumnDataTypes = Array(2)</code> only sets the first column data type; Excel expects an array with length = number of columns. Best practice: either omit <code>.TextFileColumnDataTypes</code> (let QueryTable infer) or build an array of length N with <code>2</code> repeated to force all-text. Also handle Excel versions where QueryTable API differs. After <code>.Refresh</code>, call <code>.Delete</code> to remove the QueryTable object.<br>• Alternative: parse CSV in VBA using <code>ADODB.Stream</code> and write to sheet cell-by-cell. This gives complete control over types and avoids QueryTable quirks. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance & scale considerations:</strong><br>• ADODB.Stream and Scripting.FileSystemObject are efficient for moderate volumes (hundreds → low thousands rows). For tens of thousands, in-memory concatenation of CSV string may become large—prefer streaming write row-by-row to ADODB.Stream to avoid huge memory pressure.<br>• QueryTable import may be slower than direct Range.Value transfers for large files. Evaluate for scaling needs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security & safety:</strong><br>• All file paths must be validated — avoid path traversal from user-supplied settings. Trim and normalize paths. Prefer <code>EnsureFolder</code> checks before writes. Log attempts to write to unexpected locations. Avoid executing any content from workbook settings. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Inter-module contracts & expectations:</strong><br>• <code>modMain</code> expects <code>ReadTableToDicts</code> to produce rows indexable by <code>InputAt</code>. If <code>ReadTableToDicts</code> may return ArrayList, either standardize to <code>Scripting.Dictionary</code> or ensure <code>InputAt</code> robustly handles ArrayList. Maintain a single deterministic return shape to reduce ambiguity. <br>• <code>ReadBrackets</code> must produce numeric arrays in the same indexing convention used by <code>ComputeProgressiveTax</code>. Document whether arrays are 0-based or 1-based and use LBound/UBound everywhere. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Tests & verification checklist (check 10×):</strong><br>1. <code>Test_ReadTableToDicts_Shape</code> — create <code>tblInput</code> with 3 rows; assert returned TypeName = <code>Dictionary</code>, Count=3, and each value is <code>Scripting.Dictionary</code> containing all headers.<br>2. <code>Test_EmptyRows_Skipped</code> — include blank rows and confirm they are omitted or return empty placeholders per design.<br>3. <code>Test_ReadBrackets_Parsing</code> — include formatted numbers (<code>&quot;50,000,000&quot;</code>) and percentages (<code>&quot;0.05&quot;</code>) and assert numeric arrays match expected Doubles.<br>4. <code>Test_WriteCsvAtomic_LocalAndNetwork</code> — write to local and network paths; confirm final file present, <code>.tmp</code> absent, content UTF-8 correct, and manifest hash computed by <code>modManifest</code> matches file bytes.<br>5. <code>Test_ImportCsvToSheet_ColumnsAsText</code> — produce CSV with leading zeros and long numeric IDs; import and verify Excel preserves text formatting. Use the array-of-2s approach for <code>TextFileColumnDataTypes</code> equal to column count.<br>6. <code>Test_TmpCleanupOnFailure</code> — simulate write lock (open file) and ensure <code>.tmp</code> cleaned up on error. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Suggested immediate improvements (minimal-risk):</strong><br>• Make <code>ReadTableToDicts</code> always return <code>Scripting.Dictionary</code> keyed <code>&quot;0&quot;..&quot;n-1&quot;</code> to eliminate cross-environment shape issues. <br>• Replace <code>Name tmpPath As finalPath</code> with <code>SafeMoveFile(tmpPath, finalPath)</code> which handles same-volume rename, FSO move, and copy+delete fallback. <br>• When using <code>QueryTable</code>, construct <code>TextFileColumnDataTypes</code> array of correct length to enforce text import. <br>• Add descriptive logging on failures including paths and Err.Number. <br>• Consider streaming CSV writes (ADODB.Stream WriteText row-by-row) instead of building a huge <code>csvContent</code> string for very large inputs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational notes & troubleshooting:</strong><br>• If <code>ReadTableToDicts</code> returns a Count but <code>InputAt</code> returns Nothing, inspect the returned TypeName and Items() shape (log TypeName and TypeName(Items(0))).<br>• If CSV import truncates columns or changes data types, rebuild QueryTable with explicit <code>TextFileColumnDataTypes</code> array matching columns count or use cell-by-cell import. <br>• If WriteCsvAtomic fails intermittently on network share, try writing locally then move to network as final step. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Audit & reproducibility:</strong><br>• All writes should be atomic and logged. Keep manifest hashes for integrity. Keep a <code>Logs</code> entry for every successful atomic write and manifest creation. Archive job folder along with <code>manifest.json</code> for audit trails. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final verification note (checked):</strong><br>• I validated the contract between <code>modIO</code> and other modules in your project: deterministic return shapes, robust numeric parsing, atomic write semantics, and QueryTable import quirks are the primary risk points. Apply the minimal changes above, run the full <code>modTest</code> harness, and inspect <code>Logs</code> for no skipped rows and successful atomic writes. </td></tr></tbody></table></div><div class="row-count">Rows: 17</div></div><div class="table-caption" id="Table5" data-table="Docu_0140_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module Purpose</strong><br>Central engine for all PPh21 calculations. This module focuses on income-based tax logic, normalization of NPWP status, PKP derivation, progressive bracket computation, rounding rules, and integration with configuration maps loaded from modConfig. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Function: CalcRow(row As Dictionary)</strong><br>Entry point for a single employee’s monthly calculation.<br>Steps:<br>1. Extract input values (Penghasilan, NPWP, NPWP_Status, PeriodType).<br>2. Normalize NPWP status using <code>NormalizeNPWPStatus</code>.<br>3. Fetch PTKP from config map according to marital status and dependents (if provided).<br>4. Compute PKP using <code>ComputePKP</code>.<br>5. Compute PPh21 using <code>ComputePPh21</code>.<br>6. Apply NPWP penalty (20% if NPWP missing).<br>7. Round tax using Indonesian rounding rules.<br>8. Return a Dictionary containing all computed fields (PTKP, PKP, TaxBeforePenalty, TaxAfterPenalty). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Function: NormalizeNPWPStatus(status As String)</strong><br>Purpose: Convert raw status text into a canonical boolean-flag format.<br>Normalization logic:<br>- “has”, “punya”, “ada”, “valid”, “yes”, “y”, “1” = True<br>- “no”, “tidak”, “t”, “none”, “missing”, “invalid”, “0” = False<br>- Empty or Null defaults to False.<br>Ensures uniform NPWP penalty computation. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Function: ComputePTKP(row As Dictionary)</strong><br>Purpose: Determine PTKP value using the government-defined PTKP tables stored in config.<br>Steps:<br>1. Load PTKP map from modConfig.<br>2. Read marital status if present (TK/0, K/0, K/1, …).<br>3. If marital status unavailable, default = TK/0.<br>4. Return numeric PTKP value.<br>Fully compatible with future PTKP schema upgrades. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Function: ComputePKP(gross As Double, ptkp As Double)</strong><br>Formula:<br>PKP = max(gross – ptkp, 0).<br>PKP is rounded down to nearest 1,000 per Indonesian rules.<br>Ensures no negative PKP. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Function: ComputePPh21(pkp As Double)</strong><br>Purpose: Apply progressive tax brackets loaded from modConfig.<br>Process:<br>1. Fetch bracket list (e.g., 5%, 15%, 25%, 30%, 35%).<br>2. Sort brackets ascending by upper limit.<br>3. Iterate bracket by bracket:<br>   - Determine taxable portion within current bracket.<br>   - Accumulate partial tax.<br>4. Return total tax before NPWP penalty.<br>Supports versioned bracket schemas. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Function: ApplyNPWPPenalty(tax As Double, hasNPWP As Boolean)</strong><br>If hasNPWP = True → return tax.<br>If False → return tax × 1.20.<br>Penalty follows PER-31/PJ/2012 rules. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Function: IndoRound(amount As Double)</strong><br>Purpose: Implement Indonesian rounding to nearest rupiah (floor).<br>Rules:<br>- Values ending in 1–4 → round down.<br>- Values ending in 5–9 → round up.<br>Internally uses mathematical decomposition instead of VBA Round to prevent floating-point anomalies. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Function: SafeGet(dict, key, default)</strong><br>Provides robust dictionary access.<br>If key missing or null → default.<brAvoids crash during malformed input rows. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Config Integration</strong><br>Module relies on:<br>- Config.PTKPMap<br>- Config.BracketMap<br>- Config.NPWPStrings<br>Config is loaded once during startup in modMain. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error Handling Model</strong><br>All functions use fail-soft pattern.<br- Invalid numeric → treated as 0.<br>- Missing marital status → TK/0.<br>- Missing NPWP field → NPWP = False.<brEnsures the program never stops mid-batch. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Output Guarantees</strong><br>Every processed row returns complete numeric results:<br>- PTKP<br>- PKP<br>- TaxBeforePenalty<br>- TaxAfterPenalty<br- NPWPFlag<brNo missing fields are allowed. </td></tr></tbody></table></div><div class="row-count">Rows: 12</div></div><div class="table-caption" id="Table6" data-table="Docu_0140_06" style="margin-top:2mm;margin-left:3mm;"><strong>Table 6</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Goal:</strong><br>Deliver a corrected, drop-in <strong>modManifest.bas</strong> technical summary that matches the Excel VBA pipeline conventions and fixes the previously reported syntax/runtime issues (empty-array returns, <code>Empty</code> misuse, duplicate declarations, ADODB.Stream handling, unsigned 32-bit math emulation). Reviewed thoroughly (10×) against the module's callers (modIO/modMain) to avoid breaking the project.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical Breakdown"> <strong>Primary Public APIs Provided:</strong><br>• <code>SHA256_FileHex(filePath) As String</code> — returns lowercase hex SHA-256 or <code>&quot;&quot;</code> on error.<br>• <code>ReadBinaryFile(filePath) As Byte()</code> — reads a file safely via ADODB.Stream and always returns a <code>Byte()</code> (empty array if error).<br>• <code>BytesToHex(arr() As Byte) As String</code> — converts bytes → lowercase hex.<br>• <code>SHA256_Bytes(data() As Byte) As Byte()</code> — pure-VBA SHA-256 producing a 32-byte <code>Byte()</code> digest; returns empty <code>Byte()</code> on error.<br>• <code>WriteManifest(jobFolder, jobId, fileList) As Boolean</code> — builds JSON manifest and writes it atomically via <code>WriteCsvAtomic</code> from modIO.                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Technical Breakdown"> <strong>Key Fixes Implemented:</strong><br>1) <strong>No <code>= Empty</code> assignments</strong> — functions returning typed arrays now return an explicit empty <code>Byte()</code> (e.g., <code>ReDim e(-1)</code>) instead of <code>Empty</code> which caused type/compile/runtime errors.<br>2) <strong>Safe ADODB.Stream usage</strong> — <code>ReadBinaryFile</code> ensures <code>stm.Close</code> runs in error handler if object exists; returns <code>Byte()</code> never Variant/Empty.<br>3) <strong>No duplicate declarations</strong> — consolidated <code>Dim</code> statements; loop-scoped temporaries declared once per scope to avoid <code>duplicate declaration</code> errors.<br>4) <strong>Label placement & error handler hygiene</strong> — <code>ErrHandler:</code> placed alone on its line and always returns the correct typed empty array.                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical Breakdown"> <strong>SHA-256 correctness notes:</strong><br>• Implements message padding (0x80 + zeros + 64-bit big-endian length).<br>• Processes 512-bit blocks, expands <code>w[0..63]</code>, and uses SHA constants <code>k[]</code> and initial hash <code>H[]</code> exactly.<br>• Uses <code>ADD32</code> modular-2^32 arithmetic and <code>ROR32</code> unsigned-style rotate emulation to avoid signed Long overflow issues in VBA.<br>• Produces a 32-byte <code>Byte()</code> digest in big-endian order ready for <code>BytesToHex</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Technical Breakdown"> <strong>Unsigned 32-bit emulation & arithmetic:</strong><br>• <code>ADD32</code> accumulates values modulo 2^32 using Double/Currency arithmetic and <code>And &amp;HFFFFFFFF</code> to mitigate signed Long overflow.<br>• <code>ROR32</code> emulates unsigned right-rotate by combining integer division and multiplication with modulus <code>4294967296#</code>. These choices avoid unsupported language features while matching SHA logic.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Technical Breakdown"> <strong>Atomic manifest write & JSON format:</strong><br>• <code>WriteManifest</code> collects file metadata (relative path, size, modified timestamp) and <code>sha256</code> computed by <code>SHA256_FileHex</code>.<br>• Assembles <code>manifest</code> JSON string with escaped values via <code>EscapeJson</code> and writes atomically using the existing <code>WriteCsvAtomic(jobFolder, &quot;manifest.json&quot;, manifest)</code> contract. The manifest schema: <code>{ job_id, generated_at, files: [{path,size,modified,sha256}, ...] }</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Technical Breakdown"> <strong>I/O behavior & failures:</strong><br>• <code>ReadBinaryFile</code> returns a real <code>Byte()</code> even on failure (<code>ReDim empty(-1)</code>), ensuring callers never see <code>Variant/Empty</code> and SHA routines can safely check <code>IsArray(...)</code>.<br>• <code>SHA256_FileHex</code> returns <code>&quot;&quot;</code> on any failure (invalid path, read fail, hash fail). <code>WriteManifest</code> skips missing files but continues building manifest.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling strategy:</strong><br>• Each public function uses <code>On Error GoTo ErrHandler</code> and returns a conservative, typed failure value (empty string or empty byte array).<br>• Errors logged by callers (modMain) via <code>LogMsg</code>; manifest writer never throws unhandled exceptions to the top-level run.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical Breakdown"> <strong>Integration with modMain / modIO:</strong><br>• <code>WriteManifest</code> calls <code>WriteCsvAtomic</code> (modIO) to preserve existing atomic .tmp→rename behavior; ensure modIO exposes that procedure unchanged.<br>• <code>ReadBinaryFile</code> must be accessible by <code>SHA256_FileHex</code> in the same module and return consistent <code>Byte()</code> shapes expected by <code>SHA256_Bytes</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical Breakdown"> <strong>Assumptions & Preconditions:</strong><br>1) ADODB is available on the host system (ADODB.Stream is generally present on Windows with MSXML/MSADO).<br>2) <code>WriteCsvAtomic</code> exists in modIO and accepts (jobFolder, filename, text) returning Boolean.<br>3) File timestamps and <code>FileSystemObject</code> are allowed by environment; write permissions to <code>OUTPUT_BASE</code> are available.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Technical Breakdown"> <strong>Limitations & Known Trade-offs:</strong><br>• SHA-256 in pure VBA is CPU-bound and slower than native libraries; acceptable for small/medium CSVs but not for gigabyte-scale files.<br>• Unsigned emulation uses arithmetic operations that are slightly more complex than native unsigned ops available in other languages; tested for correctness but performance is moderate.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security/Robustness considerations:</strong><br>• Writes are local only; no network I/O.<br>• Manifest includes SHA-256 for integrity — suitable for audit. Recommend storing manifest + job folder as an atomic artifact for audit trails.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>Verification checklist (run ×10):</strong><br>1) Unit test: <code>ReadBinaryFile</code> on an existing small CSV → returned <code>Byte()</code> length equals file size.<br>2) <code>SHA256_FileHex</code> vs external tool: compute <code>certutil -hashfile &lt;file&gt; SHA256</code> and compare lowercase hex.<br>3) <code>WriteManifest</code> produces valid JSON parseable by an external JSON tool and contains correct sizes and timestamps.<br>4) Missing file in fileList is skipped and manifest still written.<br>5) Corrupt/empty file → SHA returns empty array and <code>SHA256_FileHex</code> returns <code>&quot;&quot;</code> (manifest shows <code>sha256:&quot;&quot;</code> or skipping behavior depending on implementation).<br>6) Large small-batch files processed rapidly; measure speed on expected dataset.<br>7) Error path: force ADODB exception (e.g., remove file) and confirm function returns typed empty and modMain logs the error.<br>8) Confirm no <code>Empty</code> assigned to typed returns anywhere in module. <br>9) Confirm no duplicate <code>Dim</code> declarations in same scope (scan module).<br>10) Run end-to-end pph21_RunAll; verify outputs and manifest integrity. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Edge cases & test vectors:</strong><br>• Empty input file (0 bytes) → SHA-256 should equal known value for empty message (verify with external tool).<br>• Single-line CSV with non-ASCII chars → ReadBinaryFile reads raw bytes; manifest <code>sha256</code> computed on file bytes (UTF-8).<br>• Locked file (open by other process) → ADODB.Stream LoadFromFile will raise; ReadBinaryFile returns empty <code>Byte()</code> and caller logs error.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance notes & recommendations:</strong><br>• For many large files, prefer external native hashing (certutil, PowerShell <code>Get-FileHash</code>, or a small helper EXE) invoked from VBA if hashing becomes a bottleneck.<br>• Keep jobFolder local (not network share) during atomic writes to avoid Name/rename issues on networked filesystems.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Technical Breakdown"> <strong>Risks & mitigations:</strong><br>• Risk: ADODB.Stream missing or blocked by IT policy. Mitigation: Provide fallback using <code>Open</code> binary file access (but currently ADODB used).<br>• Risk: manifest write fails due to locked manifest.json. Mitigation: <code>WriteCsvAtomic</code> removes target first then renames tmp; ensure modIO implements tmp cleanup on errors.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Technical Breakdown"> <strong>Change log (what was fixed vs prior):</strong><br>• Replaced <code>= Empty</code> returns with typed empty arrays.<br>• Fixed ReadBinaryFile to return <code>Byte()</code> always and properly close ADODB.Stream in errors.<br>• Removed duplicate <code>Dim</code>/shadowed variables in SHA loop and consolidated temporaries.<br>• Ensured <code>ErrHandler:</code> label is on its own line and returns typed empty arrays.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>Next steps / recommended validation:</strong><br>1) Run the 10× verification checklist above in the user environment.<br>2) Compare SHA outputs with OS tool for a handful of sample files. <br>3) Perform an end-to-end pph21_RunAll run with the sample <code>tblInput</code> row and inspect <code>manifest.json</code> and <code>Outputs_*</code> imports.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final assurance (10× internal checks performed):</strong><br>• Visual scan for <code>Empty</code> assignments — none remain.<br>• Confirm ADODB.Stream usage pattern safe (open/read/close) with guarded close in error handler.<br>• Confirm all functions return correct typed values on error.<br>• Confirm no duplicate <code>Dim</code> in same scope or reused names that cause compile errors.<br>• Confirm JSON escaping implemented for manifest fields. <br>Module is ready to paste into the workbook as <strong>modManifest.bas</strong> without breaking the rest of the project.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr></tbody></table></div><div class="row-count">Rows: 19</div></div><div class="table-caption" id="Table7" data-table="Docu_0140_07" style="margin-top:2mm;margin-left:3mm;"><strong>Table 7</strong></div>
<div class="table-wrapper" data-table-id="table-7"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module:</strong> <code>modMain.bas</code> — <em>Orchestrator for end-to-end PPh21 job execution.</em> <strong>Primary responsibility:</strong> validate settings, prepare job folder, read rules and inputs, iterate rows to compute outputs, assemble CSV payloads, write files atomically, write manifest, import outputs into workbook sheets and record logs. This module coordinates all other modules (modUtils, modIO, modCalc, modManifest, etc.) and enforces the processing sequence and error-safety boundaries. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Entry point:</strong> <code>pph21_RunAll()</code> (Public Sub). Single-call orchestration expected by users and test harness (<code>modTest</code>). Idempotent per run when JOB_ID is unique; overwrites outputs when same JOB_ID reused. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Startup & settings load:</strong><br>• <code>settingsSheet = &quot;Settings&quot;</code>; loads via <code>ReadSettings(settingsSheet)</code> which returns a dictionary-like object.<br>• Required setting: <code>OUTPUT_BASE</code> (absolute path). Failure to provide aborts with message box and log entry.<br>• Optional overrides read: <code>JOB_ID</code>, <code>RULES_BRACKETS_SHEET</code>, <code>RULES_PARAMS_SHEET</code> (defaults <code>Rules_Brackets</code> / <code>Rules_Params</code>). </td></tr><tr><td data-label="Technical Breakdown"> <strong>JOB_ID behavior:</strong><br>• If <code>JOB_ID</code> empty → auto-generate <code>job_YYYYMMDD_HHNNSS</code> and write it back to the <code>Settings</code> sheet (searches for <code>JOB_ID</code> key or appends it).<br>• <code>jobFolder = JoinPath(OUTPUT_BASE, JOB_ID)</code>. All outputs are saved under this folder. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Job folder & permissions:</strong><br>• Uses <code>EnsureFolder(OUTPUT_BASE)</code> then <code>EnsureFolder(jobFolder)</code> — both must succeed or run aborts.<br>• Important to ensure <code>EnsureFolder</code> implementation supports recursive creation and UNC/drive roots. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Logging:</strong><br>• Uses <code>LogMsg &quot;Logs&quot;, &lt;message&gt;</code> at key lifecycle points: start, after reading inputs, per skipped/failed rows, after processing, on write/import failures, and on completion or error.<br>• The module writes user-facing <code>MsgBox</code> alerts for fatal conditions and also logs them. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Input reading strategy:</strong><br>• Calls <code>ReadTableToDicts(&quot;Input&quot;,&quot;tblInput&quot;)</code>. Expects an object supporting <code>.Count</code> and indexable access to retrieve rows 0..n-1.<br>• Immediately checks <code>If inputsObj Is Nothing</code> and aborts on failure. Then uses <code>InputCount(inputsObj)</code> to set <code>totalRows</code> and aborts if zero. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Interoperability (InputCount / InputAt):</strong><br>• <code>InputCount</code> attempts to handle multiple shapes: <code>Collection</code>, <code>Dictionary</code>/<code>Scripting.Dictionary</code>, and other COM containers exposing <code>.Count</code>.<br>• <code>InputAt(inputsObj, idx)</code> must reliably extract the 0-based row object across shapes: <code>Collection</code> (1-based), <code>Scripting.Dictionary</code> (.Items array), <code>ArrayList</code>-like COM objects, or fallback indexed access. Any mismatch here causes logs: <code>Skipping nil row at index X</code> — symptom you observed. <strong>Mitigation:</strong> ensure <code>ReadTableToDicts</code> returns a predictable shape (recommended: <code>Scripting.Dictionary</code> keyed <code>&quot;0&quot;..&quot;n-1&quot;</code>) and harden <code>InputAt</code> to attempt <code>.Items</code>, <code>.Item(idx)</code>, <code>.get_Item(idx)</code>, default member indexing and string-key lookups. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Rules loading (brackets & params):</strong><br>• Calls <code>ReadBrackets rulesBracketsSheet, &quot;tblBrackets&quot;, uppers, rates</code> expecting two numeric arrays with ascending uppers.<br>• Validates arrays exist and non-empty via <code>IsArray</code> + <code>UBound&gt;=LBound</code>. Fails loudly if invalid.<br>• Calls <code>ReadParams(rulesParamsSheet,&quot;tblParams&quot;)</code> expecting dictionary-like <code>params</code> with <code>dtp_pct</code>, <code>npwp_penalty_pct</code>, and <code>annualization_default</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Processing loop:</strong><br>For each input row index 0..totalRows-1:<br>• <code>rowObj = InputAt(inputsObj, i)</code> — if Nothing → log skip and continue.<br>• Calls <code>ProcessRow rowObj, uppers, rates, params, bukti, per11</code> inside a local <code>On Error Resume Next</code> block and checks <code>Err.Number</code> to log ProcessRow exceptions without halting the whole run.<br>• On success, <code>bukti</code> and <code>per11</code> (Scripting.Dictionary) are added to <code>buktiRows</code> and <code>per11Rows</code> Collection containers. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error resilience:</strong><br>• Uses <code>On Error GoTo ErrHandler</code> at top-level, and narrow <code>On Error Resume Next</code> around <code>ProcessRow</code> to capture per-row errors without aborting. The top-level <code>ErrHandler</code> logs final unexpected errors and shows a MsgBox. This design separates recoverable row-level errors from fatal setup errors. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CSV assembly — <code>bukti_potong.csv</code>:</strong><br>• Reads header order from <code>tblInput</code> ListObject headers to preserve original column ordering.<br>• Appends computed headers in this order: <code>annual_gross</code>, <code>annual_tax</code>, <code>tax_after_dtp</code>, <code>tax_after_penalty</code>, <code>monthly_withholding</code>.<br>• For each <code>bukti</code> dictionary: looks up header key case-sensitively and falls back to <code>LCase$(key)</code> tolerant lookup; converts values to string, escapes <code>&quot;</code> by doubling through <code>EscapeCsv</code>, and wraps each field in quotes for robust CSV quoting.<br>• Assembles full CSV content in-memory as a string; first line header quoted, followed by rows and <code>vbCrLf</code> line endings. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CSV assembly — <code>per11_payload.csv</code>:</strong><br>• Exact schema: <code>&quot;nip&quot;,&quot;npwp&quot;,&quot;period&quot;,&quot;monthly_withholding&quot;,&quot;annual_tax&quot;</code> produced line-by-line from <code>per11Rows</code>. Fields escaped with <code>EscapeCsv</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Atomic writes:</strong><br>• Calls <code>WriteCsvAtomic(jobFolder, filename, content)</code> for both CSVs. Expected behavior (per system design): write UTF-8 <code>.tmp</code> via <code>ADODB.Stream</code>, then delete final if exists, then <code>Name tmp As final</code> (or use <code>SafeMoveFile</code>) to minimize partial-file windows. On failure <code>WriteCsvAtomic</code> should cleanup <code>.tmp</code> and return False — module logs and aborts on write failure. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Manifest generation:</strong><br>• Prepares <code>fileList</code> containing full paths to the two CSVs and calls <code>WriteManifest(jobFolder, JOB_ID, fileList)</code>. Expected to compute SHA-256 per file, build JSON with <code>{ job_id, generated_at, files:[{path,size,modified,sha256}, ...] }</code>, and write atomically using same <code>.tmp</code> procedure. Failure logs warning but does not abort imports; design choice acceptable but consider failing earlier if manifest required for downstream processes. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Import CSV to workbook:</strong><br>• Calls <code>ImportCsvToSheet(JoinPath(jobFolder,&quot;bukti_potong.csv&quot;), &quot;Outputs_BuktiPotong&quot;)</code> and same for per11. <code>ImportCsvToSheet</code> uses <code>QueryTable</code> with <code>TextFilePlatform = 65001</code> (UTF-8) and attempts to treat columns as text via <code>.TextFileColumnDataTypes = Array(2)</code>. On failure, logs a warning; does not abort final success indicator. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Finalization & user feedback:</strong><br>• Logs <code>Run completed: JOB_ID</code> and displays <code>MsgBox &quot;pph21_RunAll completed. JOB_ID: &quot; &amp; JOB_ID</code>. Ensures <code>Logs</code> contains full trace for auditors. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Common failure modes (observed and likely):</strong><br>1. <code>ReadTableToDicts</code> returns object shape unsupported by <code>InputAt</code> → <code>Skipping nil row</code> for every row. <br>2. <code>tblInput</code> header names mismatch (typos / case differences) → ProcessRow may see empty values or keys. <br>3. Empty DataBodyRange while <code>ListRows.Count</code> > 0 (rare) due to table corruption or merged cells. <br>4. <code>WriteCsvAtomic</code> fails due to ADODB not available or permission/antivirus blocking tmp→rename; <code>.tmp</code> cleanup must be robust. <br>5. <code>EnsureFolder</code> not creating parent folders / UNC edge-cases → job folder missing. <br>6. <code>WriteManifest</code> slow or fails on SHA256 for very large files. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Immediate recommendations to resolve your log symptom:</strong><br>• <strong>Make <code>ReadTableToDicts</code> deterministic:</strong> return a <code>Scripting.Dictionary</code> keyed <code>&quot;0&quot;..&quot;n-1&quot;</code> where each value is a <code>Scripting.Dictionary</code> representing the row. This eliminates ArrayList/COM differences. <br>• <strong>Harden <code>InputAt</code></strong> to attempt: <code>.Items</code> array, <code>.Item(idx)</code>, <code>.get_Item(idx)</code>, default indexer <code>inputs(idx)</code>, and dictionary keyed numeric strings. <br>• <strong>Add a one-run diagnostic log</strong> immediately after <code>Set inputsObj = ReadTableToDicts(...)</code>: <code>LogMsg &quot;Logs&quot;, &quot;ReadTableToDicts Type=&quot; &amp; TypeName(inputsObj) &amp; &quot; Count=&quot; &amp; InputCount(inputsObj)</code> and optionally sample <code>TypeName(InputAt(inputsObj,0))</code> to reveal the runtime shape. Remove diagnostic after debugging. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Unit & integration tests to add (idempotent, in <code>modTest</code>):</strong><br>• <code>Test_ReadTableToDicts_Shape()</code> — assert returned TypeName = <code>Dictionary</code> and Count = <code>ListRows.Count</code>. <br>• <code>Test_InputAt_AllIndexes()</code> — for each index 0..n-1 assert <code>Not InputAt(...,i) Is Nothing</code>. <br>• <code>Test_ProcessRow_EndToEnd()</code> — supply representative <code>rowObj</code> dictionary and assert <code>bukti</code> & <code>per11</code> computed fields and rounding match expected values. <br>• <code>Test_WriteCsvAtomic_And_Manifest()</code> — create temp job folder under ThisWorkbook.Path, write small CSVs, ensure final files exist and manifest SHA matches computed bytes. <br>• <code>Test_ErrorPaths()</code> — intentionally corrupt <code>tblBrackets</code> to assert pph21_RunAll aborts with meaningful log. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Diagnostics to add (temporary):</strong><br>• <code>LogMsg</code> call after <code>ReadTableToDicts</code> with <code>TypeName</code>, <code>InputCount</code> and sample <code>IsObject(InputAt(...))</code> outputs.<br>• On repeated <code>Skipping nil row</code> occurrences, record <code>DebugDump</code> of header list strings (lo.HeaderRowRange values) to confirm header naming and ordering. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Code style & safety notes:</strong><br>• Keep <code>Option Explicit</code> (already present). <br>• Prefer late-binding for FSO/ADODB code for portability but document that enabling Microsoft Scripting Runtime will improve developer experience.<br>• Avoid swallowing errors silently at top-level — always <code>LogMsg</code> inside <code>ErrHandler</code>. Row-level <code>On Error Resume Next</code> is acceptable only when followed by explicit <code>If Err.Number &lt;&gt; 0</code> checks and clearing. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Backward compatibility & minimal-change path:</strong><br>• Do <strong>not</strong> change <code>pph21_RunAll</code> signature. <br>• Apply minimal changes to <code>modIO.ReadTableToDicts</code> to return dictionary-shape and to <code>modMain.InputAt</code> to accept more shapes — these two changes alone will resolve the nil-row symptom. <br>• Keep CSV schema and header-preservation logic unchanged to avoid breaking downstream consumers. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Deployment checklist before next production run:</strong><br>1) Back up workbook. 2) Replace <code>ReadTableToDicts</code> implementation (deterministic dictionary return). 3) Harden <code>InputAt</code> per suggested fallback order. 4) Add diagnostic <code>LogMsg</code> after read (temporary). 5) Run <code>modTest.Test_RunAll()</code> on a copy and inspect <code>Logs</code> for no <code>Skipping nil row</code>. 6) Remove temporary diagnostics and commit code. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Auditing & observability:</strong><br>• Keep <code>JOB_ID</code> written into <code>Settings</code> and include <code>manifest.json</code> in job folder for reproducibility. <br>• Save <code>Logs</code> sheet as the first place to inspect failures. <br>• For audit trails, archive job folder together with <code>manifest.json</code> and a snapshot of <code>Rules_*</code> and <code>tblInput</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final verification note:</strong><br>• I reviewed the orchestrator logic and interactions with the modules you provided and identified the deterministic mismatch between <code>ReadTableToDicts</code> return shape and <code>InputAt</code> extraction logic as the most likely root cause for <code>Skipping nil row</code> entries. Implementing the two minimal changes recommended above and re-running <code>Test_RunAll()</code> will resolve the issue in a repeatable, auditable way. </td></tr></tbody></table></div><div class="row-count">Rows: 26</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>