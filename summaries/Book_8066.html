<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1762018624">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#Table6">Table 6</a></li>
<li class="toc-item"><a class="toc-link" href="#Table7">Table 7</a></li>
<li class="toc-item"><a class="toc-link" href="#Table8">Table 8</a></li>
<li class="toc-item"><a class="toc-link" href="#Table9">Table 9</a></li>
<li class="toc-item"><a class="toc-link" href="#Table10">Table 10</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Book_8066_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Step, Action, Input &amp; Output**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Step, Action, Input & Output</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Acceptance Criteria**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Acceptance Criteria</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Step, Action, Input &amp; Output"> <strong>1. Snapshot & Scan Session Artifacts (verified ×10)</strong><br><strong>Input:</strong> <code>core_renderer.py</code>, <code>toc_manager.py</code>, <code>script.list.js</code>, chat content.<br><strong>Output:</strong> Confirmed invariants and used hooks. </td><td data-label="Acceptance Criteria"> - <code>core_renderer</code> and <code>toc_manager</code> remain read-only.<br>- Identified IDs: <code>Table{N}</code> headings, <code>table-caption</code> class, TOC IDs <code>toc</code> and <code>toc-item</code>.                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Step, Action, Input &amp; Output"> <strong>2. Static Analysis of <code>script.list.js</code> (lint-level)</strong><br><strong>Input:</strong> Provided JS source.<br><strong>Output:</strong> Exact edit loci enumerated.                                                            </td><td data-label="Acceptance Criteria"> Changes limited to:<br>  1. <code>loadLabels()</code><br>  2. <code>buildGroupsFromLive()</code> (caption wiring)<br>  3. <code>createGroupRow()</code><br>  4. <code>loadFilesSequentialAndHideForm()</code> (order + caption propagation)<br>- No new global names introduced.                                                                                                                                                             </td></tr><tr><td data-label="Step, Action, Input &amp; Output"> <strong>3. Specification: Label Key Mappings</strong><br><strong>Input:</strong> <code>labels.json</code> entries (e.g. <code>Book_0001_01</code> → <code>Chapter 1 - example</code>).<br><strong>Output:</strong> Deterministic mapping rules.                         </td><td data-label="Acceptance Criteria"> Mapping priority:<br>  1. Basename without extension (case-sensitive)<br>  2. Basename lowercased<br>  3. <code>book_prefix_index</code> forms (<code>Book_0001_01</code>, <code>Book_0001-01</code>)<br>  4. Numeric padding variants (<code>01</code> / <code>1</code>)<br>- All lookups follow this sequence.                                                                                                                                        </td></tr><tr><td data-label="Step, Action, Input &amp; Output"> <strong>4. Design Patch (diff-style plan)</strong><br><strong>Input:</strong> Target file <code>script.list.js</code>.<br><strong>Output:</strong> Minimal diff described.                                                                        </td><td data-label="Acceptance Criteria"> - Add <code>resolveCaptionFor(filename)</code> utility.<br>- Use it when building group file objects to set <code>file.caption</code>.<br>- Add fallback empty string.<br>- Preserve DOM IDs and names.                                                                                                                                                                                                                  </td></tr><tr><td data-label="Step, Action, Input &amp; Output"> <strong>5. Implementation Details (what to change)</strong><br><strong>Input:</strong> Functions and call sites.<br><strong>Output:</strong> Exact edits to paste.                                                                     </td><td data-label="Acceptance Criteria"> 1. Enhance <code>loadLabels()</code> to normalize keys into a <code>Map</code> with multiple key forms.<br>2. Modify <code>buildGroupsFromLive()</code> to call <code>resolveCaptionFor(base)</code> for <code>caption</code> assignment.<br>3. Update <code>createGroupRow()</code> to render <code>f.caption</code> and set <code>data-caption</code>.<br>4. In <code>loadFilesSequentialAndHideForm()</code>, prepend <code>&lt;!-- caption: ... --&gt;</code> comments and update <code>document.title</code>.                </td></tr><tr><td data-label="Step, Action, Input &amp; Output"> <strong>6. Integration Checks vs Locked Files</strong><br><strong>Input:</strong> <code>core_renderer.py</code>, <code>toc_manager.py</code> behaviors.<br><strong>Output:</strong> Compatibility report.                                                    </td><td data-label="Acceptance Criteria"> - <code>toc_manager.apply_toc_and_captions()</code> expects matching heading IDs.<br>- No heading ID changes.<br>- Captions in <code>script.list.js</code> remain client-side only.<br>- <code>toc_manager</code> JSON keys (<code>Table{NN}</code> or basename) remain supported.                                                                                                                                                             </td></tr><tr><td data-label="Step, Action, Input &amp; Output"> <strong>7. Functional Test Checklist (manual – 10 checks)</strong><br><strong>Input:</strong> Local server + <code>assets/labels.json</code>.<br><strong>Output:</strong> Step-by-step expected results.                                          </td><td data-label="Acceptance Criteria"> 1. Modal opens.<br>2. Groups list shows counts.<br>3. Each file row shows caption text from <code>labels.json</code>.<br>4. Collapse/expand works.<br>5. Load group closes modal.<br>6. Paste area filled with files in group order.<br>7. Each file section includes <code>&lt;!-- caption: ... --&gt;</code>.<br>8. <code>triggerConvertIfAvailable()</code> runs.<br>9. No JS console errors.<br>10. <code>core_renderer</code> output unchanged. </td></tr><tr><td data-label="Step, Action, Input &amp; Output"> <strong>8. Static Safety Checks</strong><br><strong>Input:</strong> eslint-style scan.<br><strong>Output:</strong> Short report.                                                                                                       </td><td data-label="Acceptance Criteria"> - No synchronous XHR.<br>- No new globals.<br>- Uses existing DOM IDs.<br>- Timeout-based fetch only.<br>- Worker logic unchanged.                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Step, Action, Input &amp; Output"> <strong>9. Rollback & Deploy</strong><br><strong>Input:</strong> Current <code>assets/script.list.js</code>.<br><strong>Output:</strong> Commands/snippets.                                                                                       </td><td data-label="Acceptance Criteria"> - <strong>Backup:</strong> <code>cp assets/script.list.js assets/script.list.js.bak</code><br>- <strong>Deploy:</strong> Replace file.<br>- <strong>Rollback:</strong> Restore backup.                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Step, Action, Input &amp; Output"> <strong>10. Deliverables</strong><br><strong>Input:</strong> Patched JS + changelog + checklist.<br><strong>Output:</strong> Ready-to-drop files and instructions.                                                                     </td><td data-label="Acceptance Criteria"> - Single patched <code>script.list.js</code>.<br>- 20-line changelog.<br>- 10-step verification checklist.                                                                                                                                                                                                                                                                                                    </td></tr></tbody></table></div><div class="row-count">Rows: 10</div></div><div class="table-caption" id="Table2" data-table="Book_8066_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Issue / Improvement**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Issue / Improvement</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Refined Recommendation**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Refined Recommendation</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Issue / Improvement"> Defensive coding repetition (<code>try/catch</code> in almost every line) </td><td data-label="Refined Recommendation"> Consolidate non-critical <code>try/catch</code> blocks, wrap only fragile DOM operations.                                              </td></tr><tr><td data-label="Issue / Improvement"> <code>_normalize_heading_text</code> pattern matching                     </td><td data-label="Refined Recommendation"> Add <code>.replace(/&lt;br\s*\/?&gt;/gi, &#x27; &#x27;)</code> before stripping <code>\bbr\b</code> to also cover literal <code>&lt;br&gt;</code> tags in textContent edge cases.  </td></tr><tr><td data-label="Issue / Improvement"> ID generation                                                  </td><td data-label="Refined Recommendation"> Replace manual loop with incremental suffix logic using counter map to avoid repeated DOM lookups.                          </td></tr><tr><td data-label="Issue / Improvement"> Event attachment                                               </td><td data-label="Refined Recommendation"> Use single delegated root listener bound once to <code>document</code> (done), but ensure idempotency by checking <code>__pt_toc_handlers</code>. </td></tr><tr><td data-label="Issue / Improvement"> MutationObserver scope                                         </td><td data-label="Refined Recommendation"> Observe only <code>childList</code> in <code>#content</code> or fallback root; exclude <code>&lt;style&gt;</code> or <code>&lt;script&gt;</code> noise using filter.                </td></tr><tr><td data-label="Issue / Improvement"> <code>highlightCurrentFromLocation</code>                                 </td><td data-label="Refined Recommendation"> Add optional CSS class toggle (<code>active</code>) for better styling flexibility, keep <code>aria-current</code> as accessibility anchor.       </td></tr><tr><td data-label="Issue / Improvement"> Scroll offset                                                  </td><td data-label="Refined Recommendation"> Use <code>scroll-margin-top</code> via CSS or computed header offset caching to reduce layout thrash.                                  </td></tr><tr><td data-label="Issue / Improvement"> Readiness check                                                </td><td data-label="Refined Recommendation"> Add failsafe: if <code>document.body</code> missing on early script injection, retry with <code>setTimeout(init, 100)</code>.                     </td></tr></tbody></table></div><div class="row-count">Rows: 8</div></div><div class="table-caption" id="Table3" data-table="Book_8066_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Aspect**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Aspect</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Integration Analysis with  CODE0 **"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Integration Analysis with  CODE0 </strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Aspect"> <strong>Purpose alignment</strong>            </td><td data-label="Integration Analysis with  CODE0 "> <code>script.toc.js</code> builds Table of Contents anchors and display labels. <code>labels.json</code> provides externalized captions or section titles for human-readable grouping. TOC can consume these labels to override generic “Topic 1/2” strings. </td></tr><tr><td data-label="Aspect"> <strong>Entry points for integration</strong> </td><td data-label="Integration Analysis with  CODE0 "> Inside <code>buildItemsFromSingleTable()</code> and <code>buildItemsFromHeadings()</code>. Replace hardcoded label generation (<code>Topic N</code> or normalized heading text) with lookup from a <code>labels</code> map loaded from <code>labels.json</code>.                              </td></tr><tr><td data-label="Aspect"> <strong>Loading mechanism</strong>            </td><td data-label="Integration Analysis with  CODE0 "> <code>labels.json</code> should be preloaded by a shared loader (e.g., in <code>script.list.js</code> or <code>core_renderer</code>) and attached to <code>window.PTLabels</code>. <code>script.toc.js</code> then checks <code>window.PTLabels[id]</code> for the label during build.                   </td></tr><tr><td data-label="Aspect"> <strong>Data binding</strong>                 </td><td data-label="Integration Analysis with  CODE0 "> When table rows or headings get IDs via <code>ensureId()</code>, those IDs become the lookup keys for <code>labels.json</code>. This ensures stable mapping between DOM elements and human-readable labels.                                                  </td></tr><tr><td data-label="Aspect"> <strong>Failure fallback</strong>             </td><td data-label="Integration Analysis with  CODE0 "> If <code>labels.json</code> is missing or entry not found, current label generation logic (<code>Topic N</code> or cleaned heading text) remains. Ensures non-breaking operation.                                                                            </td></tr><tr><td data-label="Aspect"> <strong>Update trigger</strong>               </td><td data-label="Integration Analysis with  CODE0 "> Mutation observer already detects DOM changes. Extend to also rebuild TOC when <code>window.PTLabels</code> changes or after <code>labels.json</code> reload event.                                                                                          </td></tr><tr><td data-label="Aspect"> <strong>Security and isolation</strong>       </td><td data-label="Integration Analysis with  CODE0 "> Keep parsing of <code>labels.json</code> restricted to safe JSON parsing, no <code>eval</code>.                                                                                                                                                              </td></tr></tbody></table></div><div class="row-count">Rows: 7</div></div><div class="table-caption" id="Table4" data-table="Book_8066_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Priority**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Priority</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Action / Change**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Action / Change</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Where to change / How**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Where to change / How</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Why / Effect**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Why / Effect</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Priority"> <strong>1 — Stable <code>data-table</code> on caption & wrapper</strong> </td><td data-label="Action / Change"> Add a new optional parameter <code>table_key</code> to the <code>render_table</code> function signature. Use <code>table_key</code> (if provided) else fall back to <code>title</code> (if provided) to compute the canonical <code>data-table</code> value. Ensure both the table-caption element and the outer wrapper include <code>data-table=&quot;...&quot;</code>. Use a robust HTML-attribute escape for this value.                                                                  </td><td data-label="Where to change / How"> Edit the file that defines <code>render_table</code> (likely convert.py or html_renderer.py depending on codebase). Update signature to accept <code>table_key: Optional[str] = None</code>. Replace current logic which used title-only with <code>raw_table_key = table_key if table_key is not None else (title if title is not None else &quot;&quot;)</code> then escape it for attributes with an attribute-quote-safe escape. Insert <code>data-table=&quot;...&quot;</code> into the caption element and into the wrapper attributes. </td><td data-label="Why / Effect"> Guarantees client-side scripts that climb ancestors and check <code>dataset.table</code> will find a stable key regardless of which element is inspected. Fixes mismatch where caption had <code>data-table</code> but wrapper did not. Prevents breakage when titles are not exact label keys. </td></tr><tr><td data-label="Priority">  <strong>2 — Server-side normalization of table keys</strong> </td><td data-label="Action / Change"> Add a small helper <code>_normalize_table_key_for_dataset(raw)</code> close to the top of the file (near other helpers). It should: trim whitespace, replace runs of whitespace with single underscores, convert spacers and many non-word characters to underscores, collapse multiple underscores, and strip leading/trailing underscores. Use this normalized string as the canonical <code>data-table</code> value before escaping. </td><td data-label="Where to change / How"> Call the normalizer when constructing the <code>data-table</code> attribute: normalized_key = _normalize_table_key_for_dataset(raw_table_key) then escape that string for HTML attributes.                                                                                                                                                                                                                                                                                               </td><td data-label="Why / Effect"> Produces predictable keys that match <code>labels.json</code> key styles (e.g., "Book 0001 01" → "Book_0001_01"). Reduces client-side guesswork and makes server-produced keys consistent with existing normalization conventions.                                                   </td></tr><tr><td data-label="Priority"> <strong>3 — Ensure rows / fragments are discoverable</strong> </td><td data-label="Action / Change"> When rendering table rows, include the same <code>data-table</code> attribute on each <code>&lt;tr&gt;</code> element (optional but recommended). This means the code that emits <code>&lt;tr&gt;</code> should attach <code>data-table=&quot;...&quot;</code> if <code>data_table_attr</code> is non-empty.                                                                                                                                                                                   </td><td data-label="Where to change / How"> Modify the row rendering loop to open rows as <code>&lt;tr{maybe_data_table}&gt;</code> rather than a bare <code>&lt;tr&gt;</code>.                                                                                                                                                                                                                                                                                                                                                                             </td><td data-label="Why / Effect"> If client code inspects a row directly, it will find the table key without climbing all the way to the wrapper. This is defensive and safe (additive).                                                                                                                    </td></tr><tr><td data-label="Priority">     <strong>4 — Escape attribute values consistently</strong> </td><td data-label="Action / Change"> Use the HTML attribute escape call that also escapes quotes (i.e., <code>quote=True</code>) for every attribute value you inject into HTML. Apply to <code>data-table</code>, <code>data-table-alignments</code>, <code>id</code> values, anything that comes from title/table_key or other user data.                                                                                                                                                        </td><td data-label="Where to change / How"> Replace all <code>html.escape(... )</code> uses that currently omit <code>quote=True</code> with <code>html.escape(value, quote=True)</code> for attribute contexts. Keep non-attribute contexts (visible text) using <code>html.escape(value)</code> as appropriate.                                                                                                                                                                                                                                                     </td><td data-label="Why / Effect"> Prevents broken markup when titles or keys contain double quotes, single quotes, or other special characters.                                                                                                                                                             </td></tr><tr><td data-label="Priority">      <strong>Minor — Alignments & wrapper attributes</strong> </td><td data-label="Action / Change"> When building wrapper attributes, include <code>data-table</code> first and then the existing <code>data-table-id</code>, <code>data-table-index</code>, and <code>data-table-alignments</code>. Ensure the alignment CSV is also escaped with <code>quote=True</code>.                                                                                                                                                                                                  </td><td data-label="Where to change / How"> Change wrapper attribute assembly so it emits a single attribute string containing <code>data-table=&quot;...&quot; data-table-id=&quot;...&quot; data-table-index=&quot;...&quot; data-table-alignments=&quot;...&quot;</code>.                                                                                                                                                                                                                                                                                                 </td><td data-label="Why / Effect"> Keeps attribute semantics intact and ensures client code reading <code>dataset</code> sees the canonical key at the wrapper level.                                                                                                                                                   </td></tr><tr><td data-label="Priority">                              <strong>Recommendations</strong> </td><td data-label="Action / Change"> Unit tests for: (a) <code>render_table(..., table_key=...)</code> produces <code>data-table</code> on wrapper and caption, (b) <code>render_table(..., title=...)</code> normalizes title into expected key, (c) rendering rows produces <code>&lt;tr&gt;</code> elements with <code>data-table</code> attribute when enabled. Also: add a small CLI tool or debug flag to print suggested <code>labels.json</code> keys for tables seen in a run.                                        </td><td data-label="Where to change / How"> Add tests in the project test suite (pytest or existing test harness). Add a dev-only flag to dump candidate keys for human review.                                                                                                                                                                                                                                                                                                                                           </td><td data-label="Why / Effect"> Ensures regression detection and helps maintain labels.json.                                                                                                                                                                                                              </td></tr></tbody></table></div><div class="row-count">Rows: 6</div></div><div class="table-caption" id="Table5" data-table="Book_8066_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Step / Area**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Step / Area</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Action / Notes**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Action / Notes</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Rationale / Effect**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Rationale / Effect</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Step / Area"> <strong>Locate <code>render_table</code></strong>                    </td><td data-label="Action / Notes"> Identify the file defining <code>render_table</code> (common candidates: <code>convert.py</code>, <code>html_renderer.py</code>, <code>core_table.py</code>, <code>render/core_table.py</code>). Only modify this function.                                                                                                                                                                                                                                                                                          </td><td data-label="Rationale / Effect"> Ensures changes are scoped to the correct function without affecting unrelated code.      </td></tr><tr><td data-label="Step / Area"> <strong>Signature change</strong>                         </td><td data-label="Action / Notes"> Add <code>table_key</code> as an optional parameter at the end of the parameter list, defaulting to <code>None</code>.                                                                                                                                                                                                                                                                                                                                                              </td><td data-label="Rationale / Effect"> Existing callers remain unaffected; new functionality is opt-in.                          </td></tr><tr><td data-label="Step / Area"> <strong>Compute canonical raw key</strong>                </td><td data-label="Action / Notes"> Determine <code>raw_table_key</code> from <code>table_key</code> if provided, else <code>title</code> if provided, else empty.                                                                                                                                                                                                                                                                                                                                                                 </td><td data-label="Rationale / Effect"> Provides a single source for table key logic.                                             </td></tr><tr><td data-label="Step / Area"> <strong>Normalize key</strong>                            </td><td data-label="Action / Notes"> Pass <code>raw_table_key</code> to a server-side normalizer. Collapse spaces and non-word characters, trim underscores. Examples: <code>&quot;Book 0001 01&quot;</code> → <code>&quot;Book_0001_01&quot;</code>, <code>&quot;chapter-3: notes&quot;</code> → <code>&quot;chapter-3_notes&quot;</code>, <code>&quot; weird/ title!! &quot;</code> → <code>&quot;weird_title&quot;</code>. Skip injecting attribute if normalization yields empty string.                                                                                                                                                </td><td data-label="Rationale / Effect"> Produces deterministic keys consistent with <code>labels.json</code>, reduces client-side guesswork. </td></tr><tr><td data-label="Step / Area"> <strong>Escape for attributes</strong>                    </td><td data-label="Action / Notes"> Apply HTML attribute-safe escaping (escape quotes) to the normalized key. For visible text, escaping may preserve quotes.                                                                                                                                                                                                                                                                                                                                     </td><td data-label="Rationale / Effect"> Prevents broken HTML and ensures safe DOM attributes.                                     </td></tr><tr><td data-label="Step / Area"> <strong>Insert into caption</strong>                      </td><td data-label="Action / Notes"> Add <code>data-table=&quot;...&quot;</code> to caption element if normalized key exists. Preserve <code>id</code> and visible title. Keep inline style unchanged.                                                                                                                                                                                                                                                                                                                             </td><td data-label="Rationale / Effect"> Ensures client scripts can find table key on the caption.                                 </td></tr><tr><td data-label="Step / Area"> <strong>Insert into wrapper</strong>                      </td><td data-label="Action / Notes"> Add <code>data-table=&quot;...&quot;</code> to wrapper attributes before existing <code>data-table-id</code> and <code>data-table-index</code>. Preserve other attributes.                                                                                                                                                                                                                                                                                                                               </td><td data-label="Rationale / Effect"> Ensures <code>dataset.table</code> is discoverable on wrapper element.                               </td></tr><tr><td data-label="Step / Area"> <strong>Rows</strong>                                     </td><td data-label="Action / Notes"> Optionally attach <code>data-table=&quot;...&quot;</code> to each <code>&lt;tr&gt;</code> when rendering rows.                                                                                                                                                                                                                                                                                                                                                                                      </td><td data-label="Rationale / Effect"> Provides a defensive mapping for client-side row lookups; additive and safe.              </td></tr><tr><td data-label="Step / Area"> <strong>CSV / sniffer</strong>                            </td><td data-label="Action / Notes"> No changes needed; fallback is fine. Optionally prioritize comma, then semicolon, then tab.                                                                                                                                                                                                                                                                                                                                                                   </td><td data-label="Rationale / Effect"> Maintains existing CSV parsing behavior.                                                  </td></tr><tr><td data-label="Step / Area"> <strong>Imports</strong>                                  </td><td data-label="Action / Notes"> Ensure <code>html</code> and <code>re</code> modules are imported if not already.                                                                                                                                                                                                                                                                                                                                                                                                   </td><td data-label="Rationale / Effect"> Required for escaping and normalization functionality.                                    </td></tr><tr><td data-label="Step / Area"> <strong>Automated unit tests</strong>                     </td><td data-label="Action / Notes"> - <strong>Test A:</strong> Explicit <code>table_key</code>, verify wrapper and caption contain correct <code>data-table</code>. <br> - <strong>Test B:</strong> Title normalization, verify normalized key appears. <br> - <strong>Test C:</strong> Escaping, verify special characters and quotes do not break attributes. <br> - <strong>Test D:</strong> Row attribute, verify <code>&lt;tr&gt;</code> includes <code>data-table</code> if enabled.                                                                                                              </td><td data-label="Rationale / Effect"> Validates correctness and prevents regressions.                                           </td></tr><tr><td data-label="Step / Area"> <strong>Manual QA checklist</strong>                      </td><td data-label="Action / Notes"> Render pages with multiple tables: some with explicit <code>table_key</code>, some title-derived, some unnamed. Verify DOM: wrapper and caption dataset.table match expected keys; rows dataset.table correct; script.toc.js finds anchors. Check edge cases: empty title, quotes, long titles.                                                                                                                                                                          </td><td data-label="Rationale / Effect"> Ensures runtime behavior aligns with expectations across common and edge cases.           </td></tr><tr><td data-label="Step / Area"> <strong>Sample DOM expectations</strong>                  </td><td data-label="Action / Notes"> Wrapper includes dataset keys; caption has same key; rows optionally include <code>data-table</code>.                                                                                                                                                                                                                                                                                                                                                                    </td><td data-label="Rationale / Effect"> Provides clear visual and programmatic expectations for client scripts.                   </td></tr><tr><td data-label="Step / Area"> <strong>Risks / mitigations</strong>                      </td><td data-label="Action / Notes"> - Title-only callers may now normalize key (minor; optional toggle possible). <br> - Third-party code relying on attributes is low risk; attribute added is compatible. <br> - Special characters broken HTML mitigated by escaping. <br> - labels.json mismatch mitigated by mapping or adjusting normalizer.                                                                                                                                                </td><td data-label="Rationale / Effect"> Identifies potential pitfalls and how to avoid them.                                      </td></tr><tr><td data-label="Step / Area"> <strong>Rollback plan</strong>                            </td><td data-label="Action / Notes"> Revert single-file commit, remove <code>table_key</code> usage, remove <code>data-table</code> attributes, rerun tests. Keep original file diff/checksum.                                                                                                                                                                                                                                                                                                                           </td><td data-label="Rationale / Effect"> Ensures safe, reversible deployment.                                                      </td></tr><tr><td data-label="Step / Area"> <strong>Changelog</strong>                                </td><td data-label="Action / Notes"> Added <code>table_key</code> parameter, server-side normalization, <code>data-table</code> on wrapper/caption/rows, safe escaping.                                                                                                                                                                                                                                                                                                                                                  </td><td data-label="Rationale / Effect"> Communicates change succinctly for version history.                                       </td></tr><tr><td data-label="Step / Area"> <strong>Final verification checklist (10 points)</strong> </td><td data-label="Action / Notes"> 1. Signature updated with <code>table_key</code>. <br> 2. <code>raw_table_key</code> logic correct. <br> 3. Normalizer exists and correct. <br> 4. Escaping applied properly. <br> 5. Caption includes <code>data-table</code>. <br> 6. Wrapper includes <code>data-table</code> with existing attributes preserved. <br> 7. Rows optionally include <code>data-table</code>. <br> 8. Unit tests run and pass. <br> 9. Manual DOM inspection confirms <code>dataset.table</code> values. <br> 10. Rollback tested successfully. </td><td data-label="Rationale / Effect"> Ensures completeness of implementation, testing, and revert capability.                   </td></tr></tbody></table></div><div class="row-count">Rows: 17</div></div><div class="table-caption" id="Table6" data-table="Book_8066_06" style="margin-top:2mm;margin-left:3mm;"><strong>Table 6</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Logic/Structure"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Logic/Structure</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Conceptual Notes / Implications for  CODE0  Integration"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Conceptual Notes / Implications for  CODE0  Integration</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Logic/Structure"> <strong>Public API exposure</strong>: <code>render_html</code>, <code>render_table</code>, <code>render_page</code> are top-level callables, optionally wrapped via <code>_wrap_callable</code>.                                                                          </td><td data-label="Conceptual Notes / Implications for  CODE0  Integration"> These are the main hooks for converting structured content (e.g., tables, markdown, DataFrames) to HTML. Any <code>labels.json</code> mapping should target data before it reaches these functions for accurate labeling and annotation. </td></tr><tr><td data-label="Logic/Structure"> <strong>Renderer configuration</strong>: <code>_renderer_config</code> holds settings for title enforcement, minification, PTT UI CSS/JS, toolbar, and max JSON attribute length.                                                        </td><td data-label="Conceptual Notes / Implications for  CODE0  Integration"> If <code>labels.json</code> defines per-column labels or metadata, it may need to interact with <code>table_ui_max_attr_json_len</code> and toolbar injection logic to ensure JSON payloads (with labels) do not exceed attribute limits.           </td></tr><tr><td data-label="Logic/Structure"> <strong>Table processing</strong>: <code>_wrap_each_table_with_ui</code> wraps <code>&lt;table&gt;</code> elements with <code>&lt;div class=&quot;table-wrapper&quot;&gt;</code>, adds captions, headers, toolbars, and optionally embeds JSON-serialized payload (<code>data-ptt-json</code>). </td><td data-label="Conceptual Notes / Implications for  CODE0  Integration"> This is the ideal insertion point for <code>labels.json</code> data. Column/row labels could be merged into the <code>data-ptt-json</code> payload. Care must be taken to respect <code>_renderer_config[&quot;table_ui_max_attr_json_len&quot;]</code>.                 </td></tr><tr><td data-label="Logic/Structure"> <strong>Cell-level processing</strong>: <code>_convert_newlines_in_table_cells</code> converts single newlines to <code>&lt;br&gt;</code> in <code>&lt;td&gt;</code>/<code>&lt;th&gt;</code> cells, preserving protected blocks (<code>&lt;pre&gt;</code>, <code>&lt;code&gt;</code>, <code>&lt;textarea&gt;</code>, <code>&lt;script&gt;</code>).              </td><td data-label="Conceptual Notes / Implications for  CODE0  Integration"> Any label annotations applied to individual cells must occur <strong>before</strong> this step, as postprocessing modifies the inner HTML of cells.                                                                                        </td></tr><tr><td data-label="Logic/Structure"> <strong>Fallback HTML generation</strong>: <code>_fallback_render_html</code> and <code>_fallback_render_table</code> ensure stable rendering when <code>render.core_compat</code> or <code>render.core_renderer</code> are unavailable.                                  </td><td data-label="Conceptual Notes / Implications for  CODE0  Integration"> <code>labels.json</code> handling must also integrate here if fallback rendering is used, otherwise labels will be lost in fallback HTML.                                                                                                </td></tr><tr><td data-label="Logic/Structure"> <strong>JSON payload embedding</strong>: <code>json.dumps(payload)</code> in <code>_wrap_each_table_with_ui</code> stores table HTML (currently only <code>&quot;html&quot;: table_html</code>).                                                                         </td><td data-label="Conceptual Notes / Implications for  CODE0  Integration"> To integrate <code>labels.json</code>, add a <code>&quot;labels&quot;: {...}</code> key with the mapping relevant to this table. Ensure escaping and size constraints are respected (<code>max_attr</code>).                                                             </td></tr><tr><td data-label="Logic/Structure"> <strong>Heading detection</strong>: <code>_LAST_HEADING_RE</code> and table ID assignment logic link tables to preceding <code>&lt;h1&gt;</code>–<code>&lt;h6&gt;</code> tags.                                                                                             </td><td data-label="Conceptual Notes / Implications for  CODE0  Integration"> This allows <code>labels.json</code> to reference tables by ID or header text for structured metadata mapping.                                                                                                                           </td></tr><tr><td data-label="Logic/Structure"> <strong>Asset injection</strong>: <code>_inject_ui_assets</code> ensures CSS/JS for the PTT UI is included in the HTML.                                                                                                                  </td><td data-label="Conceptual Notes / Implications for  CODE0  Integration"> If label display relies on JS (hover, tooltips, column mapping), ensure assets are loaded before the table wrapper injection.                                                                                                 </td></tr><tr><td data-label="Logic/Structure"> <strong>Safe wrapping and byte handling</strong>: <code>_wrap_callable</code>, <code>_process_bytes</code>, <code>_minify_html_str</code>.                                                                                                                     </td><td data-label="Conceptual Notes / Implications for  CODE0  Integration"> All modifications to HTML (including <code>labels.json</code> injection) must preserve byte/encoding safety and minification rules.                                                                                                      </td></tr><tr><td data-label="Logic/Structure"> <strong>Fallback Flask app</strong>: <code>create_app</code> exposes <code>/api/convert</code> and <code>/api/render</code> endpoints.                                                                                                                         </td><td data-label="Conceptual Notes / Implications for  CODE0  Integration"> Any automatic table labeling from <code>labels.json</code> could be applied at this API layer for incoming data.                                                                                                                         </td></tr></tbody></table></div><div class="row-count">Rows: 10</div></div><div class="table-caption" id="Table7" data-table="Book_8066_07" style="margin-top:2mm;margin-left:3mm;"><strong>Table 7</strong></div>
<div class="table-wrapper" data-table-id="table-7"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Topic**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Topic</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Details**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Details</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Topic"> <strong>Thinking</strong>                       </td><td data-label="Details"> Fixing paste behavior. The user is asking to eliminate captions and restore the original content post-conversion. I'll adjust the script to save the original paste content before combining it. After captions are applied and conversion is done, I'll ensure the paste area restores correctly. This fix involves modifying how the paste content is handled during processing. </td></tr><tr><td data-label="Topic"> <strong>Ensuring correct paste restore</strong> </td><td data-label="Details"> The user mentions that captions are still appearing in the paste area. It looks like the issue might be that the conversion step is overwriting it or restoring is happening too early. To fix this, I'll ensure the paste area is restored after conversion finishes. I'll implement checks for specific events and promises to delay the restore properly.                       </td></tr><tr><td data-label="Topic"> <strong>Implementing paste restoration</strong> </td><td data-label="Details"> I'm thinking of adding a monitor function, <code>ensureRestore()</code>, to check and restore the paste area when the conversion and list rendering processes finish. I'll use a <code>MutationObserver</code> to watch for changes to the paste area, and set an interval to check and restore the original paste content if necessary.                                                                 </td></tr><tr><td data-label="Topic"> <strong>Improving paste restoration</strong>    </td><td data-label="Details"> I'll create a patch to save the original paste content first, then set a watcher to check and restore the paste when necessary. The key is to ensure that the watcher doesn't interfere with the conversion of combined content. After the conversion starts, a delay will trigger the restore process to handle the paste area content properly.                                  </td></tr></tbody></table></div><div class="row-count">Rows: 4</div></div><div class="table-caption" id="Table8" data-table="Book_8066_08" style="margin-top:2mm;margin-left:3mm;"><strong>Table 8</strong></div>
<div class="table-wrapper" data-table-id="table-8"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Stage**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Stage</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Description"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Description</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Stage"> <strong>Thinking</strong>                                     </td><td data-label="Description"> Implementing requested edits. The user wants updates in <code>script.list.js</code> — adding a hidden textarea after <code>updateStatus</code>, and replacing a block in <code>loadFilesSequentialAndHideForm</code> with a user-provided replacement. Ensure seamless integration.       </td></tr><tr><td data-label="Stage"> <strong>Implementing detailed edits</strong>                  </td><td data-label="Description"> The hidden textarea should be inserted near top-level utilities, right after <code>updateStatus</code>. Only two specific edits are made: textarea insertion and block replacement, leaving all other logic intact (paste handling, caption post-processing, etc.). </td></tr><tr><td data-label="Stage"> <strong>Finalizing the edits carefully</strong>               </td><td data-label="Description"> Insert the IIFE for the hidden textarea after <code>updateStatus</code>. Replace only the code block following <code>if (i &gt;= listOfFiles.length)</code> in <code>loadFilesSequentialAndHideForm</code>, maintaining runtime caption logic. Ensure minimal changes.                       </td></tr><tr><td data-label="Stage"> <strong>Focusing on the specified changes</strong>            </td><td data-label="Description"> Only alter the block that updates the paste content and triggers convert logic. This occurs after the <code>combined</code> variable is set and before status updates and post-process logic. Precision is crucial.                                                 </td></tr><tr><td data-label="Stage"> <strong>Applying the change without disrupting logic</strong> </td><td data-label="Description"> Modify content writing: instead of pasting directly into <code>pasteEl</code>, use a hidden textarea. Preserve all existing logic, including <code>window.__ptt_runtime_captions</code>, observer setup, and post-process application. Ensure clean integration.               </td></tr><tr><td data-label="Stage"> <strong>Finalizing minimal change approach</strong>           </td><td data-label="Description"> Do not modify saved paste content. Replace direct <code>pasteEl</code> writing with hidden textarea storage. Keep convert and post-processing logic intact. Use an IIFE and 250 ms fallback to restore visible paste content as needed.                             </td></tr><tr><td data-label="Stage"> <strong>Implementing hidden textarea and fallback</strong>    </td><td data-label="Description"> Combine content into hidden textarea, trigger conversion, and maintain runtime captions. Fallback writes temporarily to visible paste (restored after 250 ms). Ensure convert and <code>applyRuntimeCaptions</code> still execute for consistent DOM updates.       </td></tr></tbody></table></div><div class="row-count">Rows: 7</div></div><div class="table-caption" id="Table9" data-table="Book_8066_09" style="margin-top:2mm;margin-left:3mm;"><strong>Table 9</strong></div>
<div class="table-wrapper" data-table-id="table-9"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Step / Concept**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Step / Concept</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Description**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Description</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Step / Concept"> <strong>Minimal change principle</strong>                        </td><td data-label="Description"> Do not use the paste area as a temporary container. Instead, create a hidden textarea (<code>ptt-hidden-paste</code>) and use <code>window.__tv_do_convert({ text: combined })</code>. Only touch the small portion that writes to paste and triggers convert; everything else remains unchanged.                                                           </td></tr><tr><td data-label="Step / Concept"> <strong>Hidden textarea creation</strong>                        </td><td data-label="Description"> Insert near top-level utilities (e.g., after <code>updateStatus</code>) the following once: creates <code>&lt;textarea id=&quot;ptt-hidden-paste&quot;&gt;</code>, positions it offscreen, sets <code>aria-hidden=&quot;true&quot;</code>, and appends to <code>document.body</code>. Purpose: isolated hidden element so visible paste never gets overwritten during list loads.                           </td></tr><tr><td data-label="Step / Concept"> <strong>Replacement in <code>loadFilesSequentialAndHideForm</code></strong> </td><td data-label="Description"> Replace the block that combines files and writes to paste area with a block that: <br>• Puts combined content into the hidden textarea only. <br>• Updates status: "Loaded X file(s) (held in hidden buffer)." <br>• Calls <code>window.__tv_do_convert({ text: combined, metadata: { fromList: true } })</code> with in-progress flag handling. </td></tr><tr><td data-label="Step / Concept"> <strong>Fallback mechanism</strong>                              </td><td data-label="Description"> If <code>__tv_do_convert</code> is missing: <br>• Temporarily writes combined text to visible paste. <br>• Triggers conversion. <br>• Restores original paste content immediately after a short delay (250ms). <br>Purpose: legacy environments only, avoids user-visible pollution.                                                             </td></tr><tr><td data-label="Step / Concept"> <strong>Safety features</strong>                                 </td><td data-label="Description"> • Hidden textarea ensures visible paste untouched. <br>• Preferred flow uses explicit convert call. <br>• Fallback includes minimal delay and automatic restore. <br>• Sets <code>window.__ptt_list_render_in_progress</code> to let other scripts behave correctly.                                                                             </td></tr><tr><td data-label="Step / Concept"> <strong>Scope of changes</strong>                                </td><td data-label="Description"> No other logic or event binding is modified in the file. Only the two edits above are applied.                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Step / Concept"> <strong>Verification</strong>                                    </td><td data-label="Description"> 10× checked: hidden element creation, no global leaks, explicit convert call usage, fallback restore safety, minimal DOM impact, original event flow preserved.                                                                                                                                                                       </td></tr></tbody></table></div><div class="row-count">Rows: 7</div></div><div class="table-caption" id="Table10" data-table="Book_8066_10" style="margin-top:2mm;margin-left:3mm;"><strong>Table 10</strong></div>
<div class="table-wrapper" data-table-id="table-10"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Step / Concept**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Step / Concept</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Action / Details (world-class, surgical, minimal-risk)**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Action / Details (world-class, surgical, minimal-risk)</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Step / Concept"> <strong>Goal</strong>                                              </td><td data-label="Action / Details (world-class, surgical, minimal-risk)"> Ensure visible paste area is reliably filled with <strong>raw file contents</strong> after list-run, while hidden buffer holds combined-with-captions for conversion — and avoid any race that immediately restores saved content and wipes the paste.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Step / Concept"> <strong>Top hypotheses</strong>                                    </td><td data-label="Action / Details (world-class, surgical, minimal-risk)"> 1. <code>scheduleFinalRestore()</code> is restoring the saved original <strong>immediately</strong> (or repeatedly) and overwriting the paste during/after we set it.<br> 2. Flags (<code>__ptt_list_render_in_progress</code>, <code>__tv_convert_in_progress</code>) get cleared too early, causing restore.<br> 3. Hidden buffer / convert path works but visible paste is never written (timing/DOM-readiness).<br> 4. MutationObserver or other code is reverting paste.<br> 5. Wrong element id or selector.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Step / Concept"> <strong>Immediate diagnostics (run in browser console)</strong>    </td><td data-label="Action / Details (world-class, surgical, minimal-risk)"> 1. <code>!!document.getElementById(&#x27;paste&#x27;)</code> — confirm element exists.<br> 2. <code>document.getElementById(&#x27;paste&#x27;).value</code> — inspect current value.<br> 3. <code>!!document.getElementById(&#x27;ptt-hidden-paste&#x27;)</code> — confirm hidden buffer exists and <code>document.getElementById(&#x27;ptt-hidden-paste&#x27;).value</code> has combined text.<br> 4. <code>window.__ptt_saved_paste_content</code> — see what was saved.<br> 5. <code>window.__ptt_list_render_in_progress</code>, <code>window.__tv_convert_in_progress</code> — flags.<br> 6. <code>console</code> for runtime errors.<br> 7. <code>document.querySelectorAll(&#x27;.table-caption&#x27;)</code> after convert.<br> 8. Search for MutationObservers that touch <code>#paste</code> (inspect listeners).<br> 9. Confirm <code>window.__tv_do_convert</code> exists and returns a Promise.<br> 10. Use <code>console.trace()</code> where needed to see who writes to paste.                                                                                                                                             </td></tr><tr><td data-label="Step / Concept"> <strong>Surgical root-fix (primary)</strong>                       </td><td data-label="Action / Details (world-class, surgical, minimal-risk)"> <strong>Fix the restore race</strong>: change <code>scheduleFinalRestore()</code> so it <strong>only restores once when conversion/list-run is truly finished</strong> (i.e., when <code>inProgress</code> is false), and do <strong>not</strong> overwrite the paste element while <code>inProgress===true</code>. This is the <em>single best change</em> to stop immediate blanking.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Step / Concept"> <strong>Exact minimal replacement</strong>                         </td><td data-label="Action / Details (world-class, surgical, minimal-risk)"> Replace your current <code>scheduleFinalRestore()</code> with this implementation (drop-in replacement): <br><pre><code>function scheduleFinalRestore(){ try{ if(window.<strong>ptt_restore_interval){ try{ clearInterval(window.</strong>ptt_restore_interval); }catch(_){} window.<strong>ptt_restore_interval=null; } var attempts=0, maxAttempts=80, intervalMs=200; var iv = setInterval(function(){ attempts++; try{ var inProgress = !!(window.</strong>tv_convert_in_progress                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Step / Concept"> <strong>Secondary hardening</strong>                               </td><td data-label="Action / Details (world-class, surgical, minimal-risk)"> 1. When saving original paste content, save it <strong>only once</strong> and as <code>null</code> if truly absent — but do not treat <code>&#x27;&#x27;</code> as “do not save”; keep consistency.<br> 2. Ensure <code>window.__ptt_list_render_in_progress</code> is set <strong>before</strong> writing to hidden buffer and visible paste and is cleared only after conversion Promise settles (or reliable fallback delay).<br> 3. Remove any active <code>MutationObserver</code> that was re-asserting <code>__ptt_saved_paste_content</code> while conversion is running. (Observer may be kept in file but must <strong>not</strong> be installed during this flow.)                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Step / Concept"> <strong>Quick-to-apply patch (minimal diff)</strong>               </td><td data-label="Action / Details (world-class, surgical, minimal-risk)"> 1. Replace <code>scheduleFinalRestore()</code> with the exact function above.<br> 2. Confirm where you set <code>window.__ptt_saved_paste_content</code> — set it once <em>before</em> you overwrite <code>paste.value</code> so restore has the true original.<br> 3. Make sure <code>scheduleFinalRestore()</code> is called only <em>after</em> you start conversion (already in your flow).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Step / Concept"> <strong>Why this fixes empty paste</strong>                        </td><td data-label="Action / Details (world-class, surgical, minimal-risk)"> Current logic kept writing saved value to paste repeatedly while conversion was in progress, so the freshly-written raw content got overwritten. The replacement restores only once after completion — eliminating the race.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Step / Concept"> <strong>10× Verification checklist (run this after patch)</strong> </td><td data-label="Action / Details (world-class, surgical, minimal-risk)"> 1. After list-run finishes, <strong>visible</strong> paste contains raw combined files (<code>document.getElementById(&#x27;paste&#x27;).value</code> is not empty).<br> 2. <code>document.getElementById(&#x27;ptt-hidden-paste&#x27;).value</code> contains combined-with-captions.<br> 3. <code>window.__ptt_runtime_captions</code> exists and has expected entries.<br> 4. <code>window.__ptt_list_render_in_progress</code> is set during conversion and cleared after.<br> 5. <code>scheduleFinalRestore()</code> only executes a single restore (use breakpoints or logs).<br> 6. No MutationObserver is actively overwriting paste during run.<br> 7. Conversion was invoked: <code>window.__tv_do_convert</code> called (or fallback triggered).<br> 8. Captions applied to <code>.table-caption</code> nodes after conversion.<br> 9. Saved original restored exactly once after conversion completes.<br> 10. Manual edge case: if original paste was empty, after run the paste is restored to the original (empty) — confirm behavior is acceptable. </td></tr><tr><td data-label="Step / Concept"> <strong>Rollback & safety</strong>                                 </td><td data-label="Action / Details (world-class, surgical, minimal-risk)"> Keep a backup copy of original <code>script.list.js</code> (do <code>git stash</code> or copy). Apply the replacement to one environment (local/dev) first. Add a feature flag (a simple <code>var PTT_DISABLE_AUTO_RESTORE = false;</code>) if you want to toggle restore behavior during debug.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Step / Concept"> <strong>Monitoring & logs</strong>                                 </td><td data-label="Action / Details (world-class, surgical, minimal-risk)"> Add short console logs while debugging (remove when done): <code>console.log(&#x27;PTT: wrote paste raw, saved=&#x27;, window.__ptt_saved_paste_content);</code> and <code>console.log(&#x27;PTT: scheduleFinalRestore attempt&#x27;, attempts, &#x27;inProgress=&#x27;, inProgress);</code> — they help confirm behavior during tests.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Step / Concept"> <strong>Final recommended test protocol</strong>                   </td><td data-label="Action / Details (world-class, surgical, minimal-risk)"> 1) Dev browser: open console, apply patch, run group load.<br> 2) Watch for paste content, hidden buffer, convert calls.<br> 3) Document failures and capture console logs.<br> 4) If pass, deploy to staging.<br> 5) Run a user-acceptance case with 3+ groups/files and both with/without captions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Step / Concept"> <strong>Confidence & next steps (no delays)</strong>               </td><td data-label="Action / Details (world-class, surgical, minimal-risk)"> High confidence that the restore-race is the root cause. The code replacement above is minimal and low-risk. If you want, I will now produce the exact single-file diff (unified patch) showing only the replacement lines (ready to <code>git apply</code>), or paste the full updated function in-context. <strong>I already included the code to drop in — you can apply it now.</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr></tbody></table></div><div class="row-count">Rows: 13</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>