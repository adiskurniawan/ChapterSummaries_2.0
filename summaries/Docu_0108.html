<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1763049425">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#Table6">Table 6</a></li>
<li class="toc-item"><a class="toc-link" href="#Table7">Table 7</a></li>
<li class="toc-item"><a class="toc-link" href="#Table8">Table 8</a></li>
<li class="toc-item"><a class="toc-link" href="#Table9">Table 9</a></li>
<li class="toc-item"><a class="toc-link" href="#Table10">Table 10</a></li>
<li class="toc-item"><a class="toc-link" href="#Table11">Table 11</a></li>
<li class="toc-item"><a class="toc-link" href="#Table12">Table 12</a></li>
<li class="toc-item"><a class="toc-link" href="#Table13">Table 13</a></li>
<li class="toc-item"><a class="toc-link" href="#Table14">Table 14</a></li>
<li class="toc-item"><a class="toc-link" href="#Table15">Table 15</a></li>
<li class="toc-item"><a class="toc-link" href="#Table16">Table 16</a></li>
<li class="toc-item"><a class="toc-link" href="#Table17">Table 17</a></li>
<li class="toc-item"><a class="toc-link" href="#Table18">Table 18</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0108_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>PasteToTable Caption Injection & Load-Group Flow – Single-Column Table</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>Summary (one line):</strong> Server must build and propagate <code>request_ctx</code> for load_group flows; render_html uses it to decide caption injection. Manual paste (__tv_do_convert) must never trigger injection. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>High-level findings:</strong> render/core_renderer.py correctly reads cfg for request_ctx and emits <code>&lt;script data-caption-payload&gt;</code> only when allowed. Client scripts for manual paste do not send action or client_req_id; table.js handles existing captions defensively. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>Missing / at-risk items:</strong> Server group-load handler must create and forward request_ctx with action="load_group" and optional client_req_id. Offload/worker paths must preserve request_ctx. Fragments must tag meta.source/meta.injected. script.list.js must attach client_req_id. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>Priority checklist:</strong> Server must build request_ctx in group handler with request_id, action="load_group", group_id, client_req_id, start_ts. Pass cfg to render_html. Log group start. Manual convert endpoint builds request_ctx without load_group action; _allow_caption_injection_from_cfg returns False. Ensure meta.source/injected for manual paste. Confirm core_renderer emits caption payload only when allowed. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>Client requirements:</strong> load-group path (script.list.js) must include client_req_id in payload; convert path (script.core.js) remains manual paste with { text } only. Add retries/logging for load_group client. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>Fragment metadata responsibilities:</strong> convert.py parser sets meta.source="group_load" for group captions. CaptionFragment.create() generates stable fragment ids (ptt-<sha256>), sets meta.sanitized, meta.provenance, meta.checksum. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>Table normalization / mapping:</strong> ensure_table_id() deterministically hashes innerHTML when missing. Confirm <code>data-table-id</code> and <code>data-row-index</code> present. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>Injection gating:</strong> inject_captions only for load_group. render/core_renderer.py calls inject_captions only if _allow_caption_injection_from_cfg(cfg) is True. meta.injected must not be set for manual paste. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>Assets emission / ordering:</strong> emit_assets_html(ctx) builds request-scoped ctx.injected_assets. Binder scripts emitted before caption payloads or queue window._PTT_Q safely. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>Large payload / offload path:</strong> if captions.length > threshold, return meta.offloaded=true and meta.payload_url. Client fetches payload and echoes client_req_id. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>Logging / diagnostics:</strong> Add /api/debug?req=<request_id> returning request_ctx.action, injection_success, captions_parsed, captions_sanitized, ring_buffer. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>Tests to run (deterministic):</strong> Unit: render_html with load_group request_ctx → expect data-caption-payload. Manual convert request_ctx → expect none. Integration: curl load_group with client_req_id → check HTML payload script. curl convert → check no injection. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>Grep checks post-render:</strong> <code>rg &#x27;data-caption-payload&#x27; output.html</code>, <code>rg &#x27;data-client-req-id&#x27; output.html</code>, <code>rg &#x27;meta.injected|\&quot;injected\&quot;:true&#x27; path/to/fragments/*.json</code>. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>JSON escaping:</strong> Replace </ with <\/ in payload; ensure ensure_ascii=False. Type application/json script is safe. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>Race conditions:</strong> Binder script must load before payload scripts. ctx.injected_assets must be request-scoped; avoid interleaving. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>Edge cases:</strong> If fragments_map missing meta["captions"] but _caption_for() provides defaults, skip payload unless load_group. meta["injected"] only set by inject_captions mapping step. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>Recommended instrumentation:</strong> In writer(), log <code>allow_inject</code> and rc.client_req_id per fragment. Server group handler logs request_ctx JSON at start/end. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>Code ownership:</strong> Server: server.py/main.py; Render: core_renderer.py; Fragments: core_fragments.py; Table: core_table.py; Assets: core_assets.py; Client: script.list.js (load_group), script.core.js (convert), script.table.js (already good). </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>Acceptance criteria:</strong> Manual convert → no data-caption-payload, only comment-based captions. Load-group → client sends client_req_id, server responds with payload script including client_req_id. Diagnostics endpoint returns request_ctx and injection outcome. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>Safe rollback:</strong> Restore previous core_renderer.py; add <code>FORCE_NO_INJECT</code> flag for emergency. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>Quick concrete patches:</strong> Server group handler snippet to create request_ctx and call render_html with cfg. script.list.js to include client_req_id in fetch payload. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>Final prioritized action plan:</strong> Add logging to server group handler & core_renderer.writer; implement request_ctx in group handler; ensure fragment meta.source/injected; script.list.js includes client_req_id; run unit/integration tests; validate outputs with grep; add debug /api/debug endpoint. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>Verification:</strong> Logical conditions for request_ctx flow, injection gating, client payload patterns, asset emission, and race conditions cross-checked 10+ times. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – Single-Column Table"> <strong>Assistant promises:</strong> I can now produce the exact patch for server.py group handler that creates and propagates request_ctx safely, fully integrated with your existing pipeline, or a small instrumentation patch for core_renderer.py to log allow_inject and client_req_id. </td></tr></tbody></table></div><div class="row-count">Rows: 24</div></div><div class="table-caption" id="Table2" data-table="Docu_0108_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>PasteToTable Caption Injection & Load-Group Flow – World-Class Single-Column Table</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>Summary (one line):</strong> Server must construct and propagate <code>request_ctx</code> for load_group flows so <code>render_html</code> can deterministically decide caption injection. Manual paste (__tv_do_convert) must never trigger injection under any circumstances. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>High-level findings:</strong> render/core_renderer.py correctly reads <code>request_ctx</code> from cfg via <code>_get_request_ctx_from_cfg</code> and <code>_allow_caption_injection_from_cfg</code>. It emits <code>&lt;script type=&quot;application/json&quot; data-caption-payload&quot;&gt;</code> only when allowed. Client scripts for manual paste do not send action or client_req_id; table.js consumes existing payloads defensively. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>Missing / at-risk items:</strong> Server group-load handler must generate and forward <code>request_ctx</code> including action="load_group" and optional client_req_id. Offload/worker paths must preserve <code>request_ctx</code> and echo client_req_id. Fragments must tag meta.source/meta.injected correctly. script.list.js must attach client_req_id in payload. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>Priority checklist:</strong> 1) Build <code>request_ctx</code> in server group handler with fields: request_id (UUID), action="load_group", group_id, client_req_id, start_ts (ms). 2) Pass cfg = {"request_ctx": request_ctx} to render_html. 3) Add logging at start and end: logger.info("GROUP_START action=%s group_id=%s req=%s client_req=%s", ...). 4) Ensure manual convert endpoint builds request_ctx without load_group action; <code>_allow_caption_injection_from_cfg</code> must return False. 5) Confirm meta.source/injected for fragments. 6) Verify core_renderer emits caption payload only when allowed. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>Client requirements:</strong> Load-group path (script.list.js) must include client_req_id in fetch payload and implement retries/backoff with logging. Convert path (script.core.js) remains manual paste: POST { text } only, no load_group action. Client must not request caption injection for convert. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>Fragment metadata responsibilities:</strong> convert.py parser should mark captions with meta.source="group_load" for group-origin captions. CaptionFragment.create() must generate stable IDs (ptt-<sha256>), set meta.sanitized, meta.provenance, meta.checksum. Maintain deterministic IDs even across repeated renders. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>Table normalization / mapping:</strong> ensure_table_id() must deterministically hash innerHTML when missing. All tables must have <code>data-table-id</code> and <code>data-row-index</code> attributes. Validate via grep or automated tests. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>Injection gating:</strong> inject_captions must run only for load_group flows. core_renderer.py calls inject_captions only if <code>_allow_caption_injection_from_cfg(cfg)</code> is True. meta.injected must not be set prematurely or for manual paste. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>Assets emission / ordering:</strong> emit_assets_html(ctx) builds ctx.injected_assets per request_ctx. Binder scripts must load before caption payloads. Queue window._PTT_Q safely to handle asynchronous binder initialization. No global state across requests. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>Large payload / offload path:</strong> For captions > worker_threshold, mark meta.offloaded=true and provide meta.payload_url. Client fetches payload and preserves client_req_id. Ensure correct request_ctx echo in offloaded responses. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>Logging / diagnostics:</strong> Add /api/debug?req=<request_id> returning request_ctx.action, injection_success, captions_parsed, captions_sanitized, ring_buffer snapshot. Use to trace injection failures or payload anomalies. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>Tests to run (deterministic):</strong> Unit: render_html with load_group request_ctx → expect data-caption-payload. Manual convert request_ctx → expect no payload. Integration: curl load_group with client_req_id → verify HTML payload script includes client_req_id. curl convert → verify no injection. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>Grep checks post-render:</strong> <code>rg &#x27;data-caption-payload&#x27; output.html</code>, <code>rg &#x27;data-client-req-id&#x27; output.html</code>, <code>rg &#x27;meta.injected|\&quot;injected\&quot;:true&#x27; path/to/fragments/*.json</code> to validate idempotent injection behavior. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>JSON escaping:</strong> Escape </ as <\/ to prevent script tag break. Payload must use ensure_ascii=False and embed unchanged. Type <code>application/json</code> is sufficient; no further HTML escaping required. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>Race conditions:</strong> Binder scripts must be initialized before payload scripts. ctx.injected_assets must remain request-scoped. Queue window._PTT_Q until binder runs. Confirm PasteToTable.initRenderedContent executes after injection. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>Edge cases:</strong> If fragments_map lacks meta["captions"] but _caption_for() provides defaults, skip payload unless request_ctx.action="load_group". meta.injected must only be set by inject_captions mapping step to prevent premature injection. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>Recommended instrumentation:</strong> In core_renderer.writer(), log <code>allow_inject</code> and rc.client_req_id per fragment. Server group handler logs full request_ctx JSON at start and end. Optional: log fragment_idx for granular trace. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>Code ownership:</strong> Server handlers: server.py / main.py. Render: core_renderer.py. Fragments: core_fragments.py. Table: core_table.py. Assets: core_assets.py. Client: script.list.js (load_group), script.core.js (convert), script.table.js (already robust). </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>Acceptance criteria:</strong> Manual convert → no data-caption-payload scripts; page displays only comment-based or _caption_for defaults. Load-group → client sends client_req_id; server responds with payload scripts including client_req_id. Diagnostics endpoint exposes request_ctx and injection outcomes. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>Safe rollback:</strong> Restore previous core_renderer.py from backup. Optional emergency flag: FORCE_NO_INJECT = os.getenv("PTT_NO_INJECT","0") == "1" to disable injection. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>Quick concrete patches:</strong> Server group handler: create request_ctx and call render_html with cfg. script.list.js: include client_req_id in fetch payload. Validate all fields propagated to fragments and payload scripts. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>Final prioritized action plan:</strong> 1) Add logging to server group handler & core_renderer.writer. 2) Implement request_ctx in group handler. 3) Ensure fragments meta.source/meta.injected correctly set. 4) Make script.list.js include client_req_id. 5) Run unit and integration tests. 6) Validate outputs via grep. 7) Add /api/debug endpoint for request tracing. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>Verification:</strong> All request_ctx flows, injection gating logic, client payload patterns, asset emission, and race conditions cross-checked 10+ times. Confirm deterministic HTML output and stable fragment IDs. </td></tr><tr><td data-label="PasteToTable Caption Injection &amp; Load-Group Flow – World-Class Single-Column Table"> <strong>Assistant promises:</strong> I can now produce the exact patch for server.py group handler that creates and propagates request_ctx safely, fully integrated with your existing pipeline, or a small instrumentation patch for core_renderer.py to log allow_inject and client_req_id. </td></tr></tbody></table></div><div class="row-count">Rows: 24</div></div><div class="table-caption" id="Table3" data-table="Docu_0108_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Logic / Structure"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Logic / Structure</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Conceptual notes"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Conceptual notes</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Logic / Structure"> Live file discovery         </td><td data-label="Conceptual notes"> Probes multiple server endpoints (<code>LIVE_FILES_ENDPOINTS</code>) sequentially to find a directory/list representation. Normalizes results to <code>{name,url,path,description}</code>.                                                                                                                                                     </td></tr><tr><td data-label="Logic / Structure"> Labels and groups           </td><td data-label="Conceptual notes"> Loads <code>labels.json</code> and <code>groups.json</code> candidates. Builds a robust label lookup (<code>buildLabelIndex</code>) and group descriptions for display and caption resolution.                                                                                                                                                            </td></tr><tr><td data-label="Logic / Structure"> Caption resolution          </td><td data-label="Conceptual notes"> <code>resolveCaptionFor(baseName, labelIndex)</code> generates many canonical variants and picks the longest/specific match. Used when building <code>groups</code> from live files.                                                                                                                                                           </td></tr><tr><td data-label="Logic / Structure"> Group building              </td><td data-label="Conceptual notes"> <code>buildGroupsFromLive</code> maps files into groups using <code>groupKeyFromPath</code>. Attaches <code>caption</code> for each file (explicit description → resolved label → empty).                                                                                                                                                                 </td></tr><tr><td data-label="Logic / Structure"> UI: modal + group rows      </td><td data-label="Conceptual notes"> <code>presentGroupsOnly</code> builds modal with persistent DOM rows. Each group row has a Load button and file rows that call <code>loadFilesSequentialAndHideForm(single)</code> when clicked.                                                                                                                                               </td></tr><tr><td data-label="Logic / Structure"> File loading flow           </td><td data-label="Conceptual notes"> <code>loadFilesSequentialAndHideForm</code> fetches each file sequentially, produces <code>accRaw</code> (raw content) and <code>accMarked</code> (with injected HTML comment caption + markdown heading). Sets <code>window.__ptt_runtime_captions</code> and calls client convert hooks (<code>window.__tv_do_convert</code> / <code>window.convert</code>) or fallback hidden textarea. </td></tr><tr><td data-label="Logic / Structure"> Runtime caption application </td><td data-label="Conceptual notes"> After convert, <code>applyRuntimeCaptions</code> repeatedly searches for caption nodes (<code>.table-caption</code> or <code>h1..h6</code>) and applies runtime captions. Uses retries.                                                                                                                                                                   </td></tr><tr><td data-label="Logic / Structure"> Search engine               </td><td data-label="Conceptual notes"> Local file-level inverted index and scoring for searching within groups/files.                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Logic / Structure"> Copy / clipboard helpers    </td><td data-label="Conceptual notes"> Delegates to renderer functions (<code>copyTableMarkdown</code>, <code>copyTablePlain</code>) when available. Fallback to raw paste/markdown extraction otherwise.                                                                                                                                                                             </td></tr><tr><td data-label="Logic / Structure"> Defensive coding            </td><td data-label="Conceptual notes"> Timeout-safe fetch wrappers, BOM stripping, HTML escaping, many try/catch guards.                                                                                                                                                                                                                                        </td></tr></tbody></table></div><div class="row-count">Rows: 10</div></div><div class="table-caption" id="Table4" data-table="Docu_0108_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Item"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Item</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Summary"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Summary</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Impact"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Impact</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Item"> Client vs server trigger semantics </td><td data-label="Summary">                                                              <code>script.list.js</code> resolves files client-side and fetches <code>/saved/&lt;path&gt;</code>; it does <strong>not</strong> send <code>{action:&quot;load_group&quot;, client_req_id}</code>. </td><td data-label="Impact"> Server flow that expects <code>action:&quot;load_group&quot;</code> will not be triggered by this client file. Mismatch prevents server-authoritative load. </td></tr><tr><td data-label="Item"> Caption injection location         </td><td data-label="Summary"> Client inserts <code>&lt;!-- caption: ... --&gt;</code> before conversion and uses runtime caption applicator. Server plan proposed <code>core_renderer.inject_captions()</code> and <code>&lt;script data-caption-payload&gt;</code> emission. </td><td data-label="Impact"> Two different authoritative sources. If both run they may duplicate or conflict.                                                       </td></tr><tr><td data-label="Item"> Possible mismatch                  </td><td data-label="Summary">                                                                                      Server expects to perform caption parsing/injection on <code>action:&quot;load_group&quot;</code>, but client never requests that. </td><td data-label="Impact"> Either client must notify server or server must be optional/idempotent.                                                                </td></tr></tbody></table></div><div class="row-count">Rows: 3</div></div><div class="table-caption" id="Table5" data-table="Docu_0108_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Risk"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Risk</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Notes"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Notes</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Risk"> Duplicate caption sources  </td><td data-label="Notes"> If server injects captions and client still injects <code>&lt;!-- caption: ... --&gt;</code> you may get double injection or ID collisions. </td></tr><tr><td data-label="Risk"> Timing / runtime apply     </td><td data-label="Notes"> If server returns pre-rendered HTML client must skip runtime caption loop.                                                 </td></tr><tr><td data-label="Risk"> CORS / credentials / CSRF  </td><td data-label="Notes"> Ensure same-origin requests and proper CSRF handling for server endpoint.                                                  </td></tr><tr><td data-label="Risk"> Large groups / performance </td><td data-label="Notes"> Sequential client fetch is slower. Server packaging can improve throughput.                                                </td></tr><tr><td data-label="Risk"> ID generation collisions   </td><td data-label="Notes"> Cross-check server fragment IDs vs client runtime assumptions (e.g. <code>Table1</code>, <code>Table2</code>).                                   </td></tr><tr><td data-label="Risk"> labels.json resolution     </td><td data-label="Notes"> Numeric suffix handling must match server/client lookup logic.                                                             </td></tr></tbody></table></div><div class="row-count">Rows: 6</div></div><div class="table-caption" id="Table6" data-table="Docu_0108_06" style="margin-top:2mm;margin-left:3mm;"><strong>Table 6</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Integration point"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Integration point</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Behavior"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Behavior</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Effect"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Effect</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Integration point"> Core assumption        </td><td data-label="Behavior"> <code>core_renderer</code> may emit <code>&lt;script type=&quot;application/json&quot; data-caption-payload&gt;</code> and <code>&lt;div class=&quot;table-caption&quot; id=&quot;Table&lt;N&gt;&quot;&gt;</code> before <code>html_renderer</code> runs. </td><td data-label="Effect"> Enables server-side authoritative caption injection.  </td></tr><tr><td data-label="Integration point"> Idempotence            </td><td data-label="Behavior"> <code>_wrap_each_table_with_ui</code> skips wrapping if <code>.table-wrapper</code> already exists.                                                                                 </td><td data-label="Effect"> Prevents duplicate wrappers for pre-rendered content. </td></tr><tr><td data-label="Integration point"> ID discovery           </td><td data-label="Behavior"> <code>html_renderer</code> reuses existing <code>id</code> or heading-derived ID; if absent, generates <code>Table1</code>, <code>Table2</code>, etc.                                                     </td><td data-label="Effect"> Possible divergence from <code>core_renderer</code> ID scheme.   </td></tr><tr><td data-label="Integration point"> JSON payload placement </td><td data-label="Behavior"> <code>html_renderer</code> emits <code>data-ptt</code> scripts for large JSON; coexists with <code>data-caption-payload</code>.                                                                </td><td data-label="Effect"> Allows heavy data transfer without HTML bloat.        </td></tr><tr><td data-label="Integration point"> UI asset insertion     </td><td data-label="Behavior"> <code>html_renderer</code> injects required JS assets (e.g. <code>script.core.js</code>) if missing.                                                                                </td><td data-label="Effect"> Guarantees client-side caption logic availability.    </td></tr><tr><td data-label="Integration point"> Safe fallback          </td><td data-label="Behavior"> If <code>core_renderer</code> already injected captions, <code>html_renderer</code> preserves them and only wraps missing tables.                                                   </td><td data-label="Effect"> Maintains server-injected metadata integrity.         </td></tr></tbody></table></div><div class="row-count">Rows: 6</div></div><div class="table-caption" id="Table7" data-table="Docu_0108_07" style="margin-top:2mm;margin-left:3mm;"><strong>Table 7</strong></div>
<div class="table-wrapper" data-table-id="table-7"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Risk"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Risk</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Description"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Description</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Risk"> ID mismatch               </td><td data-label="Description"> Divergent schemes (<code>bookprefix_01</code> vs <code>Table1</code>) may break client caption lookup. Align ID strategy.           </td></tr><tr><td data-label="Risk"> Duplicate caption sources </td><td data-label="Description"> Server may emit <code>data-caption-payload</code> while client also injects <code>&lt;!-- caption: ... --&gt;</code>. Avoid double-apply. </td></tr><tr><td data-label="Risk"> Large payload handling    </td><td data-label="Description"> Client must read both <code>data-ptt</code> and <code>data-caption-payload</code> when present.                                     </td></tr><tr><td data-label="Risk"> Order sensitivity         </td><td data-label="Description"> UI script insertion near <code>&lt;/body&gt;</code> may alter timing of client hooks.                                          </td></tr><tr><td data-label="Risk"> Minify side-effects       </td><td data-label="Description"> HTML minification can corrupt JSON or whitespace-sensitive tags. Disable during testing.                      </td></tr></tbody></table></div><div class="row-count">Rows: 5</div></div><div class="table-caption" id="Table8" data-table="Docu_0108_08" style="margin-top:2mm;margin-left:3mm;"><strong>Table 8</strong></div>
<div class="table-wrapper" data-table-id="table-8"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Logic / Structure"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Logic / Structure</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Conceptual Notes"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Conceptual Notes</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Logic / Structure"> HTML composition (head/tail)            </td><td data-label="Conceptual Notes"> Builds <code>&lt;script&gt;</code> and <code>&lt;style&gt;</code> bundles dynamically. Embeds worker export logic and visibility triggers for <code>.table-wrapper</code>. Final HTML assembled via <code>head_parts</code> + <code>tail_parts</code>.                                                                                                                                              </td></tr><tr><td data-label="Logic / Structure"> <code>_remove_heading_from_fragment()</code>       </td><td data-label="Conceptual Notes"> Defensive regex-based scrubber. Removes <code>&lt;h1–h6&gt;</code> tags matching known <code>title_id</code> or <code>title_text</code> from fragment content to prevent duplicate headings after caption injection.                                                                                                                                                    </td></tr><tr><td data-label="Logic / Structure"> <code>_build_caption_payload_for_fragment()</code> </td><td data-label="Conceptual Notes"> Central function to extract and normalize caption metadata per table. Handles multiple schema variants: <code>meta[&quot;captions&quot;]</code>, <code>caption_payload</code>, <code>captions_json</code>, or <code>caption</code>.  Sanitizes text, enforces deterministic IDs (<code>book_prefix_idx</code>), and sorts payload entries lexically. Produces safe, flat list for JSON embedding. </td></tr><tr><td data-label="Logic / Structure"> <code>writer(f)</code> closure                     </td><td data-label="Conceptual Notes"> Main rendering loop. Writes head → TOC → optional banner → tables → tail. Uses <code>allow_inject</code> from <code>_allow_caption_injection_from_cfg(cfg)</code> (derived from request context).                                                                                                                                                      </td></tr><tr><td data-label="Logic / Structure"> <code>logger.debug</code> trace                    </td><td data-label="Conceptual Notes"> Logs injection allowance and current request context (<code>cfg.action</code>, <code>cfg.source</code>, etc.) for debugging injection behavior.                                                                                                                                                                                                        </td></tr><tr><td data-label="Logic / Structure"> Caption + wrapper creation              </td><td data-label="Conceptual Notes"> For each fragment, builds <code>.table-wrapper</code> div with caption div. Generates caption text hierarchy: <code>_caption_for(book_prefix, idx)</code> → <code>title_text</code> → fallback <code>&quot;Table &lt;n&gt;&quot;</code>. Each wrapper receives a unique <code>id</code> and <code>data-table</code> attribute.                                                                                     </td></tr><tr><td data-label="Logic / Structure"> Payload generation & embedding          </td><td data-label="Conceptual Notes"> If <code>allow_inject</code> is true, or <code>_injection_allowed_override</code> exists, builds caption payload via <code>_build_caption_payload_for_fragment</code>. Emits <code>&lt;script type=&quot;application/json&quot; data-caption-payload&gt;</code> immediately below the caption. Adds optional <code>data-client-req-id</code> if <code>request_ctx</code> carries it.                               </td></tr><tr><td data-label="Logic / Structure"> Injection marking                       </td><td data-label="Conceptual Notes"> Marks fragment meta as <code>injected=True</code> and adds <code>&quot;injection_marker&quot;:&quot;core_renderer&quot;</code>. Guarantees idempotency: prevents re-injection on repeated renders.                                                                                                                                                                         </td></tr><tr><td data-label="Logic / Structure"> Fallback writing logic                  </td><td data-label="Conceptual Notes"> If no payload, writes <code>&lt;div class=&quot;table-core&quot;&gt;&lt;/div&gt;</code>. If <code>need_fallback</code> true, dumps inline HTML instead of structured tables.                                                                                                                                                                                                 </td></tr><tr><td data-label="Logic / Structure"> Atomic write safety                     </td><td data-label="Conceptual Notes"> Uses <code>_default_write_atomic</code> if available; else manually writes to <code>.tmp</code> file and replaces atomically. Ensures data integrity under concurrent renders.                                                                                                                                                                         </td></tr><tr><td data-label="Logic / Structure"> Exception isolation                     </td><td data-label="Conceptual Notes"> Wraps every stage in <code>try/except</code> to preserve downstream output even on fragment-level failures.                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Logic / Structure"> Result dictionary                       </td><td data-label="Conceptual Notes"> Returns structured JSON summary: <code>warnings</code>, <code>tables</code>, <code>rows</code>, <code>runtime_ms</code>, <code>output</code>, optional <code>html</code>. Compatible with frontend logging or post-render validation.                                                                                                                                                              </td></tr></tbody></table></div><div class="row-count">Rows: 12</div></div><div class="table-caption" id="Table9" data-table="Docu_0108_09" style="margin-top:2mm;margin-left:3mm;"><strong>Table 9</strong></div>
<div class="table-wrapper" data-table-id="table-9"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Flow Point"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Flow Point</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Effect in this module"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Effect in this module</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Flow Point"> <code>server.py</code> builds <code>request_ctx</code> (<code>action:&quot;load_group&quot;</code>) </td><td data-label="Effect in this module"> Passed in <code>cfg</code>. <code>_allow_caption_injection_from_cfg(cfg)</code> reads it and enables injection only if allowed.                                   </td></tr><tr><td data-label="Flow Point"> <code>core_renderer.inject_captions()</code>                        </td><td data-label="Effect in this module"> Integrated here through <code>allow_inject</code> check. No separate method name; logic embedded in <code>writer</code>.                                          </td></tr><tr><td data-label="Flow Point"> <code>html_renderer.render_html()</code>                            </td><td data-label="Effect in this module"> Receives fragments where <code>meta.injected=True</code>. This module’s injected <code>&lt;script data-caption-payload&gt;</code> tags appear in the final HTML output. </td></tr><tr><td data-label="Flow Point"> <code>script.core.js</code> (<code>window.PTT.injectCaptions()</code>)         </td><td data-label="Effect in this module"> Consumes these payloads on the client to attach runtime captions.                                                                           </td></tr></tbody></table></div><div class="row-count">Rows: 4</div></div><div class="table-caption" id="Table10" data-table="Docu_0108_10" style="margin-top:2mm;margin-left:3mm;"><strong>Table 10</strong></div>
<div class="table-wrapper" data-table-id="table-10"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Focus"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Focus</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Recommended refinement"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Recommended refinement</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Focus"> Logging clarity          </td><td data-label="Recommended refinement"> Include <code>client_req_id</code> in debug log line for easier correlation with frontend.                                          </td></tr><tr><td data-label="Focus"> Payload size             </td><td data-label="Recommended refinement"> For very large caption lists, consider truncation or external file reference to avoid exceeding HTML script size limits. </td></tr><tr><td data-label="Focus"> Injection flag isolation </td><td data-label="Recommended refinement"> Rename <code>_injection_allowed_override</code> to <code>_allow_caption_override</code> for readability (semantic clarity, same behavior).     </td></tr><tr><td data-label="Focus"> Worker export check      </td><td data-label="Recommended refinement"> Current worker script logic under JS block works but can be lazily loaded to reduce blocking time.                       </td></tr></tbody></table></div><div class="row-count">Rows: 4</div></div><div class="table-caption" id="Table11" data-table="Docu_0108_11" style="margin-top:2mm;margin-left:3mm;"><strong>Table 11</strong></div>
<div class="table-wrapper" data-table-id="table-11"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Logic / Structure"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Logic / Structure</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Conceptual notes"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Conceptual notes</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Logic / Structure"> Purpose                                     </td><td data-label="Conceptual notes"> Thin compatibility layer and post-processor for the core render functions. Wraps <code>render_html</code>, <code>render_table</code>, <code>render_page</code> if available; provides fallbacks when render modules missing.                                                                                                                                                                         </td></tr><tr><td data-label="Logic / Structure"> Configuration                               </td><td data-label="Conceptual notes"> <code>_renderer_config</code> driven by env + <code>set_renderer_config</code>. Controls <code>ensure_title</code>, <code>minify_html</code>, <code>table_ui_css/js</code>, <code>table_ui_max_attr_json_len</code>, and path processing.                                                                                                                                                                                             </td></tr><tr><td data-label="Logic / Structure"> Post-processing wrapper (<code>_wrap_callable</code>)  </td><td data-label="Conceptual notes"> If wrapped function returns <code>str</code> or <code>bytes</code> or <code>Path</code>, it applies: ensure-title, minify, UI asset injection, table wrapping. Returns original output type where possible.                                                                                                                                                                                          </td></tr><tr><td data-label="Logic / Structure"> Title enforcement                           </td><td data-label="Conceptual notes"> <code>_ensure_title_in_h1_fragment</code> / <code>_ensure_title_attrs_in_str</code> add <code>class</code> and <code>id</code> to the first <code>&lt;h1&gt;</code> to meet accessibility and anchor expectations.                                                                                                                                                                                                               </td></tr><tr><td data-label="Logic / Structure"> Minification                                </td><td data-label="Conceptual notes"> <code>_minify_html_str</code> tokenizes and collapses whitespace while preserving script/style/pre/code/textarea sections. Enabled by config.                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Logic / Structure"> UI asset injection                          </td><td data-label="Conceptual notes"> <code>_inject_ui_assets</code> ensures <code>table_ui_css</code> and <code>table_ui_js</code> are present. Inserts <code>&lt;link&gt;</code> in <code>&lt;head&gt;</code> or <code>&lt;script defer&gt;</code> before <code>&lt;/body&gt;</code>. Detects by basename to avoid duplicates.                                                                                                                                                                               </td></tr><tr><td data-label="Logic / Structure"> Table wrapping (<code>_wrap_each_table_with_ui</code>) </td><td data-label="Conceptual notes"> Scans for <code>&lt;table&gt;</code> blocks. For each table it: preserves cell newlines, locates a preceding heading or <code>.table-caption</code>, ensures or generates stable <code>table_id</code>, builds <code>table-wrapper</code> HTML with <code>data-ptt-json</code> or emits <code>&lt;script type=&quot;application/json&quot; data-ptt=&quot;TableId&quot;&gt;</code> if JSON too large. Skips wrapping if a <code>table-wrapper</code> already encloses the table. </td></tr><tr><td data-label="Logic / Structure"> JSON-in-attribute threshold                 </td><td data-label="Conceptual notes"> Uses <code>table_ui_max_attr_json_len</code> to decide whether to inline JSON in <code>data-ptt-json</code> attribute or emit a separate <code>&lt;script&gt;</code> payload.                                                                                                                                                                                                                              </td></tr><tr><td data-label="Logic / Structure"> Protected content handling                  </td><td data-label="Conceptual notes"> Preserves code/pre/textarea/script sections during minify and newline conversion.                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Logic / Structure"> Fallback renderers                          </td><td data-label="Conceptual notes"> When <code>render.core_compat</code> not available, provides <code>_fallback_render_html</code>, <code>_fallback_render_table</code>, <code>_fallback_render_page</code> that produce simple HTML and call <code>_wrap_callable</code> for post-processing.                                                                                                                                                                </td></tr><tr><td data-label="Logic / Structure"> Diagnostic helpers                          </td><td data-label="Conceptual notes"> <code>get_import_diagnostics</code>, <code>generate_diagnostic_report</code>, and <code>_record</code> collect import attempts and processing notes for debugging.                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Logic / Structure"> Embedded create_app                         </td><td data-label="Conceptual notes"> Fallback Flask app with <code>/api/convert</code> and <code>/api/render</code>. Uses wrapped <code>render_html</code> if present. Protects request size. Sets minimal security headers.                                                                                                                                                                                                              </td></tr></tbody></table></div><div class="row-count">Rows: 12</div></div><div class="table-caption" id="Table12" data-table="Docu_0108_12" style="margin-top:2mm;margin-left:3mm;"><strong>Table 12</strong></div>
<div class="table-wrapper" data-table-id="table-12"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Section"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Section</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Key Points"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Key Points</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Notes / Implications"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Notes / Implications</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Section"> <strong>Core assumption</strong>                      </td><td data-label="Key Points"> <code>core_renderer</code> may already emit <code>&lt;script type=&quot;application/json&quot; data-caption-payload ...&gt;</code> and <code>&lt;div class=&quot;table-caption&quot; id=&quot;Table&lt;N&gt;&quot;&gt;</code> before <code>html_renderer</code> runs.                                                 </td><td data-label="Notes / Implications"> Server-side authoritative injection may already exist; html_renderer should preserve it.          </td></tr><tr><td data-label="Section"> <strong>Idempotence</strong>                          </td><td data-label="Key Points"> <code>_wrap_each_table_with_ui</code> skips wrapping if <code>.table-wrapper</code> exists.                                                                                                                                                     </td><td data-label="Notes / Implications"> Prevents duplicate wrappers for pre-rendered tables.                                              </td></tr><tr><td data-label="Section"> <strong>ID discovery</strong>                         </td><td data-label="Key Points"> html_renderer computes table_id from existing table id or nearest heading. Reuses <code>Table&lt;N&gt;</code> ids if present; otherwise generates <code>Table1</code>, <code>Table2</code>, ...                                                                  </td><td data-label="Notes / Implications"> Possible divergence from server-generated IDs; must align ID schemes for client caption appliers. </td></tr><tr><td data-label="Section"> <strong>JSON payload placement</strong>               </td><td data-label="Key Points"> html_renderer emits <code>data-ptt</code> script tags for large JSON; coexists with <code>data-caption-payload</code>.                                                                                                                          </td><td data-label="Notes / Implications"> Allows heavy data transfer without bloating table attributes.                                     </td></tr><tr><td data-label="Section"> <strong>UI asset insertion</strong>                   </td><td data-label="Key Points"> html_renderer can inject table UI JS assets (e.g., <code>script.core.js</code>) by basename to avoid duplicates.                                                                                                                     </td><td data-label="Notes / Implications"> Ensures client hooks are available for caption consumption.                                       </td></tr><tr><td data-label="Section"> <strong>Safe fallback</strong>                        </td><td data-label="Key Points"> html_renderer leaves existing <code>data-caption-payload</code> intact.                                                                                                                                                              </td><td data-label="Notes / Implications"> Pre-injected captions are preserved; wrapping is only applied where needed.                       </td></tr><tr><td data-label="Section"> <strong>ID mismatch risk</strong>                     </td><td data-label="Key Points"> Server uses <code>bookprefix_01</code>, html_renderer generates <code>Table1</code>, etc.                                                                                                                                                       </td><td data-label="Notes / Implications"> Client caption appliers may not find table; synchronize ID scheme.                                </td></tr><tr><td data-label="Section"> <strong>Duplicate caption sources</strong>            </td><td data-label="Key Points"> Client may inject <code>&lt;!-- caption: ... --&gt;</code> while server injects <code>data-caption-payload</code>.                                                                                                                                    </td><td data-label="Notes / Implications"> Must detect existing payload to avoid double captions.                                            </td></tr><tr><td data-label="Section"> <strong>Large payload handling</strong>               </td><td data-label="Key Points"> html_renderer moves large JSON to <code>&lt;script data-ptt=&quot;TableId&quot;&gt;</code>.                                                                                                                                                          </td><td data-label="Notes / Implications"> Client must read both <code>data-ptt</code> and <code>data-caption-payload</code>.                                      </td></tr><tr><td data-label="Section"> <strong>Order sensitivity</strong>                    </td><td data-label="Key Points"> html_renderer inserts table UI <code>&lt;script&gt;</code> before <code>&lt;/body&gt;</code>.                                                                                                                                                               </td><td data-label="Notes / Implications"> Event timing may shift; prefer canonical scripts in core_renderer assets.                         </td></tr><tr><td data-label="Section"> <strong>Minify side-effects</strong>                  </td><td data-label="Key Points"> HTML minification can alter whitespace-sensitive fragments or embedded JSON.                                                                                                                                              </td><td data-label="Notes / Implications"> Disable minify_html for debugging.                                                                </td></tr><tr><td data-label="Section"> <strong>10× verification checklist</strong>           </td><td data-label="Key Points"> Confirm core_renderer emits <code>.table-wrapper</code> and table IDs; render server and client flows; test large captions; verify assets; test minify; check accessibility; confirm client_req_id preserved.                        </td><td data-label="Notes / Implications"> Full pre-deploy validation to avoid mismatches or double injection.                               </td></tr><tr><td data-label="Section"> <strong>Minimal non-breaking recommendations</strong> </td><td data-label="Key Points"> Emit stable table IDs (<code>Table&lt;N&gt;</code> or <code>bookprefix_nn</code>); client JS detects existing <code>data-caption-payload</code> and skips runtime injection; add <code>&lt;meta name=&quot;ptt-injection&quot; content=&quot;core_renderer&quot; data-client-req-id=&quot;...&quot;&gt;</code>. </td><td data-label="Notes / Implications"> Ensures ID stability, avoids double captions, and enables tracing/debugging.                      </td></tr></tbody></table></div><div class="row-count">Rows: 13</div></div><div class="table-caption" id="Table13" data-table="Docu_0108_13" style="margin-top:2mm;margin-left:3mm;"><strong>Table 13</strong></div>
<div class="table-wrapper" data-table-id="table-13"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Option"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Option</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by What to do"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">What to do</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Pros &amp; Cons"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Pros & Cons</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Option"> A — Keep client-side behavior (non-invasive)             </td><td data-label="What to do">                                                                                        Make server group handler optional and idempotent. Do not change <code>script.list.js</code>. </td><td data-label="Pros &amp; Cons"> <strong>Pros:</strong> Minimal risk. No client changes. Fast. <strong>Cons:</strong> Server-authoritative features unavailable unless called.                                                                       </td></tr><tr><td data-label="Option"> B — Add explicit server-authoritative call (small patch) </td><td data-label="What to do"> Augment load handlers in <code>script.list.js</code> to call server endpoint with <code>{ group_id, action: &#x27;load_group&#x27;, client_req_id }</code>. Fall back to existing client load on failure. </td><td data-label="Pros &amp; Cons"> <strong>Pros:</strong> Enables server-side injection and correlation. Preserves fallback. <strong>Cons:</strong> Requires small client patch and server endpoint; must handle duplicate caption sources and timing. </td></tr></tbody></table></div><div class="row-count">Rows: 2</div></div><div class="table-caption" id="Table14" data-table="Docu_0108_14" style="margin-top:2mm;margin-left:3mm;"><strong>Table 14</strong></div>
<div class="table-wrapper" data-table-id="table-14"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Integration / Risk"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Integration / Risk</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Next Action"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Next Action</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Implementation Notes / Patch Location"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Implementation Notes / Patch Location</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Integration / Risk"> <strong>Core assumption</strong>                            </td><td data-label="Next Action"> Preserve existing <code>data-caption-payload</code> scripts during HTML rendering </td><td data-label="Implementation Notes / Patch Location"> html_renderer.py: <code>_wrap_each_table_with_ui</code> should skip removing <code>&lt;script data-caption-payload&gt;</code>; leave captions intact.                                                                                       </td></tr><tr><td data-label="Integration / Risk"> <strong>Idempotence</strong>                                </td><td data-label="Next Action"> Ensure wrapper not duplicated                                          </td><td data-label="Implementation Notes / Patch Location"> html_renderer.py: <code>_wrap_each_table_with_ui</code> already checks for <code>.table-wrapper</code>; test with pre-wrapped fragments.                                                                                              </td></tr><tr><td data-label="Integration / Risk"> <strong>ID discovery</strong>                               </td><td data-label="Next Action"> Align table IDs between server and client                              </td><td data-label="Implementation Notes / Patch Location"> core_renderer.py: emit stable IDs (<code>Table&lt;N&gt;</code> or <code>bookprefix_nn</code>); html_renderer.py: reuse existing IDs if present.                                                                                             </td></tr><tr><td data-label="Integration / Risk"> <strong>JSON payload placement</strong>                     </td><td data-label="Next Action"> Ensure client reads both <code>data-ptt</code> and <code>data-caption-payload</code>         </td><td data-label="Implementation Notes / Patch Location"> html_renderer.py emits <code>data-ptt</code>; client JS (script.core.js / script.list.js) reads both fields when applying captions.                                                                                        </td></tr><tr><td data-label="Integration / Risk"> <strong>UI asset insertion</strong>                         </td><td data-label="Next Action"> Guarantee client hooks for caption injection                           </td><td data-label="Implementation Notes / Patch Location"> html_renderer.py: insert table_ui_js assets only if basename not already present; test injection of <code>script.core.js</code>.                                                                                           </td></tr><tr><td data-label="Integration / Risk"> <strong>Safe fallback</strong>                              </td><td data-label="Next Action"> Avoid overwriting server-injected captions                             </td><td data-label="Implementation Notes / Patch Location"> html_renderer.py: skip wrapping for tables with existing <code>data-caption-payload</code>.                                                                                                                                </td></tr><tr><td data-label="Integration / Risk"> <strong>ID mismatch risk</strong>                           </td><td data-label="Next Action"> Synchronize ID schemes                                                 </td><td data-label="Implementation Notes / Patch Location"> core_renderer.py: use predictable table IDs; html_renderer.py: reuse IDs; client caption applier searches by data-table or Table<N>.                                                                            </td></tr><tr><td data-label="Integration / Risk"> <strong>Duplicate caption sources</strong>                  </td><td data-label="Next Action"> Skip client runtime injection if server payload exists                 </td><td data-label="Implementation Notes / Patch Location"> script.core.js / script.list.js: check for <code>data-caption-payload</code> before inserting <code>&lt;!-- caption: ... --&gt;</code>.                                                                                                     </td></tr><tr><td data-label="Integration / Risk"> <strong>Large payload handling</strong>                     </td><td data-label="Next Action"> Test <code>data-ptt</code> fallback                                               </td><td data-label="Implementation Notes / Patch Location"> html_renderer.py: move large JSON into <code>&lt;script data-ptt=&quot;TableId&quot;&gt;</code>; client reads it.                                                                                                                          </td></tr><tr><td data-label="Integration / Risk"> <strong>Order sensitivity</strong>                          </td><td data-label="Next Action"> Ensure scripts loaded before client caption loops                      </td><td data-label="Implementation Notes / Patch Location"> html_renderer.py: prefer core_renderer asset list order; test event timing.                                                                                                                                     </td></tr><tr><td data-label="Integration / Risk"> <strong>Minify side-effects</strong>                        </td><td data-label="Next Action"> Avoid JSON / whitespace corruption                                     </td><td data-label="Implementation Notes / Patch Location"> Keep <code>minify_html=False</code> during debugging; verify <code>&lt;pre&gt;</code>, <code>&lt;code&gt;</code>, and embedded JSON survive.                                                                                                                 </td></tr><tr><td data-label="Integration / Risk"> <strong>10× verification checklist</strong>                 </td><td data-label="Next Action"> Run validations before deploy                                          </td><td data-label="Implementation Notes / Patch Location"> Render server and client flows; confirm wrappers, IDs, payloads, assets, accessibility, client_req_id.                                                                                                          </td></tr><tr><td data-label="Integration / Risk"> <strong>Minimal non-breaking recommendations</strong>       </td><td data-label="Next Action"> Implement stable IDs, client detection, diagnostic meta                </td><td data-label="Implementation Notes / Patch Location"> core_renderer.py: set table_id on table and caption div; client JS: detect <code>data-caption-payload</code>; html_renderer.py: add <code>&lt;meta name=&quot;ptt-injection&quot; ...&gt;</code> for tracing.                                         </td></tr><tr><td data-label="Integration / Risk"> <strong>Server-authoritative group load (optional)</strong> </td><td data-label="Next Action"> Add <code>/api/group_load</code> endpoint & client wrapper                        </td><td data-label="Implementation Notes / Patch Location"> script.list.js: wrap <code>loadFilesSequentialAndHideForm</code> calls with <code>tryServerLoadGroup(groupId, files, clientReqId)</code>; server.py: handle <code>{group_id, action:&quot;load_group&quot;, client_req_id}</code> and return files[] JSON. </td></tr></tbody></table></div><div class="row-count">Rows: 14</div></div><div class="table-caption" id="Table15" data-table="Docu_0108_15" style="margin-top:2mm;margin-left:3mm;"><strong>Table 15</strong></div>
<div class="table-wrapper" data-table-id="table-15"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Step / Flow"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Step / Flow</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Description / Decision"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Description / Decision</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Step / Flow"> 1 — Client triggers group load                   </td><td data-label="Description / Decision"> User clicks “Load Group” in UI.                                                                                                        </td></tr><tr><td data-label="Step / Flow"> 2 — Server-authoritative attempt                 </td><td data-label="Description / Decision"> <code>tryServerLoadGroup(groupId, files, clientReqId)</code> sends <code>{group_id, action:&quot;load_group&quot;, client_req_id}</code> to <code>/api/group_load</code>.         </td></tr><tr><td data-label="Step / Flow"> 3a — Server responds with files[] JSON           </td><td data-label="Description / Decision"> Client receives authoritative file list with optional <code>caption_payload</code>.                                                               </td></tr><tr><td data-label="Step / Flow"> 3b — Server fails / endpoint missing             </td><td data-label="Description / Decision"> Client falls back to local fetch+convert (<code>loadFilesSequentialAndHideForm</code>).                                                           </td></tr><tr><td data-label="Step / Flow"> 4 — Client applies files                         </td><td data-label="Description / Decision"> Load each file sequentially, hide form UI.                                                                                             </td></tr><tr><td data-label="Step / Flow"> 5 — HTML rendering                               </td><td data-label="Description / Decision"> <code>html_renderer</code> wraps tables (<code>_wrap_each_table_with_ui</code>) and inserts <code>&lt;script data-ptt&gt;</code> for large JSON.                              </td></tr><tr><td data-label="Step / Flow"> 6 — Check existing captions                      </td><td data-label="Description / Decision"> If <code>&lt;script data-caption-payload&gt;</code> exists, skip client runtime caption injection for that table.                                       </td></tr><tr><td data-label="Step / Flow"> 7 — ID reconciliation                            </td><td data-label="Description / Decision"> Table IDs reused if present (<code>Table&lt;N&gt;</code> or server prefix); new IDs generated for unwrapped tables.                                     </td></tr><tr><td data-label="Step / Flow"> 8 — UI asset insertion                           </td><td data-label="Description / Decision"> Inject JS/CSS assets (<code>script.core.js</code>, table UI JS) only if missing.                                                                  </td></tr><tr><td data-label="Step / Flow"> 9 — Client runtime caption injection (if needed) </td><td data-label="Description / Decision"> Apply <code>&lt;!-- caption: ... --&gt;</code> markers only for tables without server-injected payloads.                                                </td></tr><tr><td data-label="Step / Flow"> 10 — Safe fallback & diagnostics                 </td><td data-label="Description / Decision"> Add <code>&lt;meta name=&quot;ptt-injection&quot; content=&quot;core_renderer&quot; data-client-req-id=&quot;...&quot;&gt;</code> if server injection occurred; ensures traceability. </td></tr><tr><td data-label="Step / Flow"> 11 — Final DOM ready                             </td><td data-label="Description / Decision"> Tables wrapped, captions applied once, assets loaded, and large JSON accessible to client logic.                                       </td></tr></tbody></table></div><div class="row-count">Rows: 12</div></div><div class="table-caption" id="Table16" data-table="Docu_0108_16" style="margin-top:2mm;margin-left:3mm;"><strong>Table 16</strong></div>
<div class="table-wrapper" data-table-id="table-16"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Integration / Action"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Integration / Action</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Implementation Notes / Patch Location"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Implementation Notes / Patch Location</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Integration / Action"> <strong>Core assumption — Preserve existing <code>data-caption-payload</code></strong>                              </td><td data-label="Implementation Notes / Patch Location"> html_renderer.py: <code>_wrap_each_table_with_ui</code> should skip removing <code>&lt;script data-caption-payload&gt;</code>; leave captions intact.                                                                                       </td></tr><tr><td data-label="Integration / Action"> <strong>Idempotence — Avoid duplicate wrapper</strong>                                                   </td><td data-label="Implementation Notes / Patch Location"> html_renderer.py: <code>_wrap_each_table_with_ui</code> already checks for <code>.table-wrapper</code>; test with pre-wrapped fragments.                                                                                              </td></tr><tr><td data-label="Integration / Action"> <strong>ID discovery — Align table IDs between server and client</strong>                                </td><td data-label="Implementation Notes / Patch Location"> core_renderer.py: emit stable IDs (<code>Table&lt;N&gt;</code> or <code>bookprefix_nn</code>); html_renderer.py: reuse existing IDs if present.                                                                                             </td></tr><tr><td data-label="Integration / Action"> <strong>JSON payload placement — Ensure client reads both <code>data-ptt</code> and <code>data-caption-payload</code></strong> </td><td data-label="Implementation Notes / Patch Location"> html_renderer.py emits <code>data-ptt</code>; client JS (script.core.js / script.list.js) reads both fields when applying captions.                                                                                        </td></tr><tr><td data-label="Integration / Action"> <strong>UI asset insertion — Guarantee client hooks</strong>                                             </td><td data-label="Implementation Notes / Patch Location"> html_renderer.py: insert table_ui_js assets only if basename not already present; test injection of <code>script.core.js</code>.                                                                                           </td></tr><tr><td data-label="Integration / Action"> <strong>Safe fallback — Avoid overwriting server-injected captions</strong>                              </td><td data-label="Implementation Notes / Patch Location"> html_renderer.py: skip wrapping for tables with existing <code>data-caption-payload</code>.                                                                                                                                </td></tr><tr><td data-label="Integration / Action"> <strong>ID mismatch risk — Synchronize ID schemes</strong>                                               </td><td data-label="Implementation Notes / Patch Location"> core_renderer.py: use predictable table IDs; html_renderer.py: reuse IDs; client caption applier searches by data-table or Table<N>.                                                                            </td></tr><tr><td data-label="Integration / Action"> <strong>Duplicate caption sources — Skip client runtime injection if server payload exists</strong>      </td><td data-label="Implementation Notes / Patch Location"> script.core.js / script.list.js: check for <code>data-caption-payload</code> before inserting <code>&lt;!-- caption: ... --&gt;</code>.                                                                                                     </td></tr><tr><td data-label="Integration / Action"> <strong>Large payload handling — Test <code>data-ptt</code> fallback</strong>                                       </td><td data-label="Implementation Notes / Patch Location"> html_renderer.py: move large JSON into <code>&lt;script data-ptt=&quot;TableId&quot;&gt;</code>; client reads it.                                                                                                                          </td></tr><tr><td data-label="Integration / Action"> <strong>Order sensitivity — Ensure scripts load before client loops</strong>                             </td><td data-label="Implementation Notes / Patch Location"> html_renderer.py: prefer core_renderer asset list order; test event timing.                                                                                                                                     </td></tr><tr><td data-label="Integration / Action"> <strong>Minify side-effects — Avoid JSON / whitespace corruption</strong>                                </td><td data-label="Implementation Notes / Patch Location"> Keep <code>minify_html=False</code> during debugging; verify <code>&lt;pre&gt;</code>, <code>&lt;code&gt;</code>, and embedded JSON survive.                                                                                                                 </td></tr><tr><td data-label="Integration / Action"> <strong>10× verification checklist — Run pre-deploy validations</strong>                                 </td><td data-label="Implementation Notes / Patch Location"> Render server and client flows; confirm wrappers, IDs, payloads, assets, accessibility, client_req_id.                                                                                                          </td></tr><tr><td data-label="Integration / Action"> <strong>Minimal non-breaking recommendations — Stable IDs, detection, diagnostics</strong>               </td><td data-label="Implementation Notes / Patch Location"> core_renderer.py: set table_id on table and caption div; client JS: detect <code>data-caption-payload</code>; html_renderer.py: add <code>&lt;meta name=&quot;ptt-injection&quot; ...&gt;</code> for tracing.                                         </td></tr><tr><td data-label="Integration / Action"> <strong>Server-authoritative group load (optional) — Add endpoint & client wrapper</strong>              </td><td data-label="Implementation Notes / Patch Location"> script.list.js: wrap <code>loadFilesSequentialAndHideForm</code> calls with <code>tryServerLoadGroup(groupId, files, clientReqId)</code>; server.py: handle <code>{group_id, action:&quot;load_group&quot;, client_req_id}</code> and return files[] JSON. </td></tr></tbody></table></div><div class="row-count">Rows: 14</div></div><div class="table-caption" id="Table17" data-table="Docu_0108_17" style="margin-top:2mm;margin-left:3mm;"><strong>Table 17</strong></div>
<div class="table-wrapper" data-table-id="table-17"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Step / Flow / Integration"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Step / Flow / Integration</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Description / Decision / Action"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Description / Decision / Action</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Step / Flow / Integration"> <strong>1 — Client triggers group load</strong>                     </td><td data-label="Description / Decision / Action"> User clicks “Load Group” in UI. Ensure client generates <code>client_req_id</code> for traceability. <br>No changes required unless enabling server-authoritative path.                                                                                                                                         </td></tr><tr><td data-label="Step / Flow / Integration"> <strong>2 — Server-authoritative attempt</strong>                   </td><td data-label="Description / Decision / Action"> <code>tryServerLoadGroup(groupId, files, clientReqId)</code> calls <code>/api/group_load</code> with <code>{group_id, action:&quot;load_group&quot;, client_req_id}</code>. <br>Patch <code>script.list.js</code> to wrap existing <code>loadFilesSequentialAndHideForm</code> calls.                                                                                 </td></tr><tr><td data-label="Step / Flow / Integration"> <strong>3a — Server responds with files[] JSON</strong>             </td><td data-label="Description / Decision / Action"> Client receives authoritative file list, may include <code>caption_payload</code>. <br>Client applies files sequentially. Implement in <code>script.list.js</code>: handle JSON response and call <code>loadFilesSequentialAndHideForm(json.files)</code>.                                                                            </td></tr><tr><td data-label="Step / Flow / Integration"> <strong>3b — Server fails / endpoint missing</strong>               </td><td data-label="Description / Decision / Action"> Client falls back to local fetch + convert. <br>Ensure non-breaking behavior; existing code continues.                                                                                                                                                                                               </td></tr><tr><td data-label="Step / Flow / Integration"> <strong>4 — Client applies files</strong>                           </td><td data-label="Description / Decision / Action"> Files loaded sequentially, form hidden. <br>No extra action; ensure fallback works for missing server response.                                                                                                                                                                                      </td></tr><tr><td data-label="Step / Flow / Integration"> <strong>5 — HTML rendering / table wrapping</strong>                </td><td data-label="Description / Decision / Action"> <code>html_renderer.py</code> wraps tables via <code>_wrap_each_table_with_ui</code>. <br>Preserve existing <code>&lt;script data-caption-payload&gt;</code>; skip wrapping if <code>.table-wrapper</code> exists. <br>Test with pre-wrapped fragments.                                                                                                </td></tr><tr><td data-label="Step / Flow / Integration"> <strong>6 — Check existing captions / duplicate prevention</strong> </td><td data-label="Description / Decision / Action"> If <code>&lt;script data-caption-payload&gt;</code> exists, client JS must skip inserting <code>&lt;!-- caption: ... --&gt;</code>. <br>Implement detection in <code>script.core.js</code> or <code>script.list.js</code> to avoid double captions.                                                                                                          </td></tr><tr><td data-label="Step / Flow / Integration"> <strong>7 — ID reconciliation</strong>                              </td><td data-label="Description / Decision / Action"> Table IDs reused if present (<code>Table&lt;N&gt;</code> or server prefix); new IDs generated for unwrapped tables. <br><code>core_renderer.py</code> must emit stable IDs (<code>Table&lt;N&gt;</code> or <code>bookprefix_nn</code>). <br><code>html_renderer.py</code> should reuse existing IDs. <br>Client caption applier searches by <code>data-table</code> or <code>Table&lt;N&gt;</code>. </td></tr><tr><td data-label="Step / Flow / Integration"> <strong>8 — UI asset insertion</strong>                             </td><td data-label="Description / Decision / Action"> Inject required JS/CSS assets (<code>script.core.js</code>, table UI JS) only if missing. <br><code>html_renderer.py</code> should match by basename to avoid duplicates.                                                                                                                                                  </td></tr><tr><td data-label="Step / Flow / Integration"> <strong>9 — Client runtime caption injection (if needed)</strong>   </td><td data-label="Description / Decision / Action"> Only insert <code>&lt;!-- caption: ... --&gt;</code> for tables lacking server-injected payload. <br>Implement in <code>script.core.js</code> / <code>script.list.js</code>.                                                                                                                                                                </td></tr><tr><td data-label="Step / Flow / Integration"> <strong>10 — Large payload handling</strong>                        </td><td data-label="Description / Decision / Action"> <code>html_renderer.py</code> moves large JSON to <code>&lt;script data-ptt=&quot;TableId&quot;&gt;</code>. <br>Client JS must read both <code>data-ptt</code> and <code>data-caption-payload</code>. <br>Test large captions to confirm.                                                                                                                        </td></tr><tr><td data-label="Step / Flow / Integration"> <strong>11 — Order sensitivity / event timing</strong>              </td><td data-label="Description / Decision / Action"> UI scripts inserted near <code>&lt;/body&gt;</code> may shift event timing. <br>Ensure core_renderer asset list preserves canonical order. <br>Test that runtime caption application hooks fire correctly.                                                                                                            </td></tr><tr><td data-label="Step / Flow / Integration"> <strong>12 — Safe fallback & diagnostics</strong>                   </td><td data-label="Description / Decision / Action"> Add <code>&lt;meta name=&quot;ptt-injection&quot; content=&quot;core_renderer&quot; data-client-req-id=&quot;...&quot;&gt;</code> if server injection occurred. <br>Enables tracing of server vs client authoritative injections.                                                                                                                   </td></tr><tr><td data-label="Step / Flow / Integration"> <strong>13 — Minify side-effects</strong>                           </td><td data-label="Description / Decision / Action"> HTML minification can corrupt embedded JSON or whitespace-sensitive tags (<code>&lt;pre&gt;</code>, <code>&lt;code&gt;</code>). <br>Keep <code>minify_html=False</code> during debugging; verify correctness in production if minified.                                                                                                           </td></tr><tr><td data-label="Step / Flow / Integration"> <strong>14 — 10× verification checklist</strong>                    </td><td data-label="Description / Decision / Action"> Pre-deploy: render server flow and client fallback; check wrappers, IDs, payloads, assets; verify accessibility anchors. <br>Confirm <code>data-client-req-id</code> is present in final HTML; test large payloads and minification.                                                                            </td></tr><tr><td data-label="Step / Flow / Integration"> <strong>15 — Minimal non-breaking recommendations</strong>          </td><td data-label="Description / Decision / Action"> - Make sure every <code>&lt;table&gt;</code> and <code>&lt;div class=&quot;table-caption&quot;&gt;</code> has a stable ID. <br>- If <code>data-caption-payload</code> is already present, do <strong>not</strong> add it again. <br>- Add a <code>&lt;meta&gt;</code> tag for tracing server vs client injection.                                                                         </td></tr><tr><td data-label="Step / Flow / Integration"> <strong>16 — Optional server-authoritative group load</strong>      </td><td data-label="Description / Decision / Action"> Implement <code>/api/group_load</code> endpoint in <code>server.py</code>: accept <code>{group_id, action:&quot;load_group&quot;, client_req_id}</code> and return <code>files[]</code> JSON. <br>Client wrapper in <code>script.list.js</code> prefers server load, falls back to local fetch.                                                                       </td></tr></tbody></table></div><div class="row-count">Rows: 17</div></div><div class="table-caption" id="Table18" data-table="Docu_0108_18" style="margin-top:2mm;margin-left:3mm;"><strong>Table 18</strong></div>
<div class="table-wrapper" data-table-id="table-18"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Flow"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Flow</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by HTTP Call"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">HTTP Call</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by allow_inject"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">allow_inject</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Caption Injection"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Caption Injection</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Flow"> Manual Convert      </td><td data-label="HTTP Call"> POST /api/render </td><td data-label="allow_inject"> False        </td><td data-label="Caption Injection"> ❌ No              </td></tr><tr><td data-label="Flow"> Load Group (server) </td><td data-label="HTTP Call"> POST /api/render </td><td data-label="allow_inject"> True         </td><td data-label="Caption Injection"> ✅ Yes             </td></tr></tbody></table></div><div class="row-count">Rows: 2</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>