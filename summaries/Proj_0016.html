<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1764964680">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#Table6">Table 6</a></li>
<li class="toc-item"><a class="toc-link" href="#Table7">Table 7</a></li>
<li class="toc-item"><a class="toc-link" href="#Table8">Table 8</a></li>
<li class="toc-item"><a class="toc-link" href="#Table9">Table 9</a></li>
<li class="toc-item"><a class="toc-link" href="#Table10">Table 10</a></li>
<li class="toc-item"><a class="toc-link" href="#Table11">Table 11</a></li>
<li class="toc-item"><a class="toc-link" href="#Table12">Table 12</a></li>
<li class="toc-item"><a class="toc-link" href="#Table13">Table 13</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Proj_0016_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by JOB FLOW ‚Äî SYSTEM PROCESS (Post-revisions: canonical, non-breaking, feature-flag-safe)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">JOB FLOW ‚Äî SYSTEM PROCESS (Post-revisions: canonical, non-breaking, feature-flag-safe)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="JOB FLOW ‚Äî SYSTEM PROCESS (Post-revisions: canonical, non-breaking, feature-flag-safe)"> üìÅ UserSystem Process Flow (high-level steps ‚Äî all changes implemented behind feature flags where applicable) </td></tr><tr><td data-label="JOB FLOW ‚Äî SYSTEM PROCESS (Post-revisions: canonical, non-breaking, feature-flag-safe)"> <strong>1) Start / Invocation</strong> <br><code>modMain.pph21_RunAll(config)</code> called ‚Üí <code>run_id</code> generated. Immediately call <code>PreflightChecks(config)</code> which returns <code>PreflightReport</code> (sheets present, OUTPUT_BASE, modIO availability, disk space, STRICT_IO/STRICT_CONTRACT flags). <br>‚îî‚îÄ If <code>PreflightReport.fatal &amp;&amp; STRICT_IO=true</code> ‚Üí route error via <code>ErrHandler.Route(...)</code>, write <code>audit_&lt;run_id&gt;.json</code> with <code>fatal:true</code>, abort. Otherwise continue (warnings recorded in audit). </td></tr><tr><td data-label="JOB FLOW ‚Äî SYSTEM PROCESS (Post-revisions: canonical, non-breaking, feature-flag-safe)"> <strong>2) Job identity & workspace</strong> <br><code>EnsureJobId(jobFolder, jobId)</code> ‚Üí if jobId empty generate deterministic <code>JOB_&lt;ts&gt;_&lt;guid&gt;</code>, create <code>jobFolder</code> and <code>jobFolder/tmp/</code>, write <code>JOB_INFO.json</code> atomically (contains <code>job_id</code>, <code>created_ts</code>, <code>creator</code>). <code>EnsureTmpFolder(jobFolder)</code> runs and is logged. </td></tr><tr><td data-label="JOB FLOW ‚Äî SYSTEM PROCESS (Post-revisions: canonical, non-breaking, feature-flag-safe)"> <strong>3) Contract & dependency checks</strong> <br><code>ContractCheck()</code> verifies <code>modTER.ValidateTERSnapshot</code> present/successful and required <code>modCalc</code> APIs (<code>SolveGrossUp</code>, <code>DetermineResidency</code>) signatures. <br>‚îî‚îÄ If <code>STRICT_CONTRACT=true</code> and contract fails ‚Üí abort with <code>PreflightReport</code> update, audit artifact, and <code>ErrHandler.Route</code>. </td></tr><tr><td data-label="JOB FLOW ‚Äî SYSTEM PROCESS (Post-revisions: canonical, non-breaking, feature-flag-safe)"> <strong>4) TER ingestion & validation (modTER)</strong> <br><code>modTER.TER_Load(&quot;tblSettings&quot;)</code> ‚Üí <code>ValidateTERSnapshot(snapshot)</code> called, <code>CanonicalizeSnapshot(snapshot)</code> produces canonical JSON and <code>mapping_hash</code>. <br>‚îú‚îÄ (parse low-confidence rows) ‚Üí those rows go to <code>QuarantineService</code> and <code>quarantine_report</code> emitted; if <code>require_quarantine_resolution=true</code> and threshold exceeded ‚Üí block/abort per config. <br>‚îú‚îÄ If validation fails and <code>modTER.require_schema_valid=true</code> ‚Üí abort (ErrHandler + audit). <br>‚îî‚îÄ On success: return <code>ter_load_id</code>, <code>mapping_hash</code>, <code>ter_diag</code> for audit. </td></tr><tr><td data-label="JOB FLOW ‚Äî SYSTEM PROCESS (Post-revisions: canonical, non-breaking, feature-flag-safe)"> <strong>5) Optional dry-run / canary gating</strong> <br>If <code>config.dry_run=true</code> or <code>canary=true</code> then: <br>‚îú‚îÄ Set write targets to <code>jobFolder/staging_outputs/</code> (no writes to production <code>OUTPUT_BASE</code>). <br>‚îú‚îÄ If canary and <code>canary_sample_size&gt;0</code> commit only first N rows to production (if enabled) after canary checks. <br>‚îî‚îÄ All dry-run/canary results still produce audit artifact and manifest in staging. </td></tr><tr><td data-label="JOB FLOW ‚Äî SYSTEM PROCESS (Post-revisions: canonical, non-breaking, feature-flag-safe)"> <strong>6) Read inputs (modIO streaming)</strong> <br><code>modIO.ReadTableToDicts(tblInput, opts:{stream:true, encoding_normalize:true})</code> returns <code>RowStream</code>/enumerator. <code>DetectPII</code> optionally runs on initial snapshot if <code>require_scrub_before_commit</code> set. <br>‚îî‚îÄ On IO error ‚Üí ErrHandler route, PreflightReport update; abort if <code>STRICT_IO=true</code>. </td></tr><tr><td data-label="JOB FLOW ‚Äî SYSTEM PROCESS (Post-revisions: canonical, non-breaking, feature-flag-safe)"> <strong>7) Processing loop (streaming, chunked flush)</strong> <br>Loop over <code>RowStream</code> with streaming/chunk write pattern (<code>flush_chunk_size</code>): <br>‚îú‚îÄ For each row: sanitize inputs (NormalizeBracketArraysStructured, EnsureBPJSColumns, ParseNumericStringToDouble via ParseRateToFractionLocal shim). <br>‚îú‚îÄ <code>modCalc.CalcRow(row, calcConfig)</code> call ‚Üí returns <code>ResultRow</code> or structured <code>ErrorObject</code>. <code>SolveGrossUp</code> returns enriched diagnostics (convergence_status, iterations). <code>DetermineResidency</code> returns <code>{Resident|NonResident|Ambiguous, reason}</code>; <code>Ambiguous</code> requires operator ack when enforced. <br>‚îú‚îÄ If <code>CalcRow</code> error ‚Üí buffer structured reject entry to <code>rejections_buffer</code> (columns: <code>row_index</code>, <code>input_key</code>, <code>error_code</code>, <code>error_message</code>, <code>diag_json</code>) and <code>LogMsg</code> called with masked context. If <code>stop_on_x_percent_rejects</code> reached ‚Üí abort per config. <br>‚îú‚îÄ If ok ‚Üí <code>modIO.BufferWrite(ResultRow)</code> writes to tmp streaming file in <code>jobFolder/tmp/</code> using standardized tmp-name pattern. <code>atomicWrite</code> used under the hood for finalization per chunk. <br>‚îî‚îÄ Per-chunk flush: <code>modIO.FlushWrites()</code> writes/renames tmp ‚Üí final with <code>SafeMoveFile</code> fallback and returns per-file metadata <code>{path, bytes_written, sha256_hex?}</code>. All write actions call <code>modIO.log_write_action(...)</code> and <code>modUtils.MaskSensitiveForLog</code> before logging. </td></tr><tr><td data-label="JOB FLOW ‚Äî SYSTEM PROCESS (Post-revisions: canonical, non-breaking, feature-flag-safe)"> <strong>8) Reconciliation & post-loop checks</strong> <br>After stream ends: <br>‚îú‚îÄ Ensure all buffered writes flushed and collect <code>output_files</code> list with metadata. <br>‚îú‚îÄ Write <code>rejections.csv</code> atomically if <code>rejections_buffer</code> non-empty and include in <code>output_files</code>. <br>‚îú‚îÄ If any write error occurs during flush ‚Üí ErrHandler routed, <code>modMain</code> attempts cleanup per policy (retries/rollback) and writes audit artifact showing partial state; abort if <code>STRICT_IO=true</code>. </td></tr><tr><td data-label="JOB FLOW ‚Äî SYSTEM PROCESS (Post-revisions: canonical, non-breaking, feature-flag-safe)"> <strong>9) Snapshot scrubbing/encryption (if enabled)</strong> <br>Before finalizing outputs, for any snapshot or sensitive output: <br>‚îú‚îÄ If <code>require_scrub_before_commit=true</code> ‚Üí call <code>ScrubSnapshot(snapshot, mode=&quot;redact&quot;|&quot;hash&quot;)</code> and write scrubbed artifact instead; detect PII via <code>DetectPII</code> and block if enforcement on. <br>‚îú‚îÄ If <code>encryption.enabled=true</code> ‚Üí <code>EncryptSnapshot</code> and write encrypted artifact; store <code>encryption_meta</code> in audit. <br>‚îî‚îÄ <code>scrub_status</code> recorded in audit artifact. </td></tr><tr><td data-label="JOB FLOW ‚Äî SYSTEM PROCESS (Post-revisions: canonical, non-breaking, feature-flag-safe)"> <strong>10) Advisory lock & manifest atomic write</strong> <br>If <code>modMain.locking.advisory=true</code> ‚Üí <code>AcquireRunLock(jobFolder, owner_id, ttl)</code> obtains lock metadata persisted to job folder. <br>‚îî‚îÄ Once lock held (or if advisory disabled), compute file-level SHA after final move if <code>computeShaAfterMove=true</code> (using <code>modIO.atomicWrite</code> metadata or <code>ComputeFileSha256</code>), then call <code>modManifest.WriteManifestWithFiles(jobFolder, jobId, output_files, opts:{canonicalize:true, compute_sha:true, sign_if_required:true})</code>. <code>manifest.json</code> written atomically (tmp ‚Üí final). If <code>require_manifest_signature=true</code> ensure manifest signed. Release lock after manifest write. </td></tr><tr><td data-label="JOB FLOW ‚Äî SYSTEM PROCESS (Post-revisions: canonical, non-breaking, feature-flag-safe)"> <strong>11) Manifest errors & fallback</strong> <br>‚îú‚îÄ If manifest write errors and <code>manifest_write_mode=warn</code> ‚Üí log warning, leave outputs; include <code>manifest_warnings</code> in audit. <br>‚îî‚îÄ If <code>manifest_write_mode=strict</code> ‚Üí treat as fatal (ErrHandler + abort + audit with <code>fatal:true</code>). </td></tr><tr><td data-label="JOB FLOW ‚Äî SYSTEM PROCESS (Post-revisions: canonical, non-breaking, feature-flag-safe)"> <strong>12) Import to sheet (optional)</strong> <br>If <code>config.import_to_sheet=true</code> ‚Üí <code>modIO.ImportCsvPreserveText(outputs)</code> called (NumberFormat "@" set for NIP/NPWP). Errors logged; behavior dependent on <code>STRICT_IO</code>. </td></tr><tr><td data-label="JOB FLOW ‚Äî SYSTEM PROCESS (Post-revisions: canonical, non-breaking, feature-flag-safe)"> <strong>13) Final audit artifact & telemetry</strong> <br>Write <code>audit_&lt;run_id&gt;.json</code> atomically to job folder with fields: <code>run_id</code>, <code>job_id</code>, <code>start_ts</code>, <code>end_ts</code>, <code>rows_processed</code>, <code>rows_success</code>, <code>rows_rejected</code>, <code>rejection_rate</code>, <code>ter_load_id</code>, <code>mapping_hash</code>, <code>manifest_files_count</code>, <code>manifest_total_size_bytes</code>, <code>validate_time_ms</code>, <code>lock_meta</code>, <code>mask_version</code>, <code>scrub_status</code>, <code>feature_flags</code>, <code>quarantine_report</code> (if any), <code>manifest_diag</code>. Emit metrics via <code>modUtils.emitMetric(...)</code>. </td></tr><tr><td data-label="JOB FLOW ‚Äî SYSTEM PROCESS (Post-revisions: canonical, non-breaking, feature-flag-safe)"> <strong>14) Cleanup and orphan tmp detection</strong> <br><code>CleanOrphanTmpFiles(jobFolder, max_age_seconds)</code> runs per config (optionally scheduled). Leftover tmp files logged in audit and optionally removed if <code>auto_cleanup=true</code>. </td></tr><tr><td data-label="JOB FLOW ‚Äî SYSTEM PROCESS (Post-revisions: canonical, non-breaking, feature-flag-safe)"> <strong>15) Return / User response</strong> <br>If run successful (or dry-run succeeded): <code>modMain</code> returns <code>Success</code> + <code>job_id</code> (and staging path for dry-run). If fatal: return detailed failure including <code>run_id</code> and path to job folder for investigation. All logs and artifacts are masked (no raw NPWP/NIP), and <code>mask_version</code> is present. </td></tr><tr><td data-label="JOB FLOW ‚Äî SYSTEM PROCESS (Post-revisions: canonical, non-breaking, feature-flag-safe)"> <strong>16) Observability & CI gates (post-run checks)</strong> <br>Post-run CI-gate checks (if CI integrated): verify <code>audit_&lt;run_id&gt;.json</code> schema; ensure no unmasked NPWP/NIP in logs/artifacts; verify <code>mapping_hash</code> deterministic across repeated canonicalization; ensure <code>quarantine</code> and <code>rejections.csv</code> thresholds respected; assert gross-up solver diagnostics OK for canonical fixtures. Failure of enforced gates blocks deployment. </td></tr><tr><td data-label="JOB FLOW ‚Äî SYSTEM PROCESS (Post-revisions: canonical, non-breaking, feature-flag-safe)"> <strong>17) Rollback / operator controls</strong> <br>Operators can flip feature flags at runtime: <code>dry_run</code>, <code>advisory_lock</code>, <code>require_scrub_before_commit</code>, <code>strict_contract</code>, <code>require_manifest_signature</code>. A documented rollback playbook exists in the job folder plus <code>JOB_INFO.json</code>. </td></tr><tr><td data-label="JOB FLOW ‚Äî SYSTEM PROCESS (Post-revisions: canonical, non-breaking, feature-flag-safe)"> <strong>18) Acceptance & verification</strong> <br>All steps above align with revised modules: <code>modMain</code>, <code>modTER</code>, <code>modIO</code>, <code>modCalc</code>, <code>modManifest</code>, <code>modUtils</code>, <code>Masking/PII</code>, <code>QuarantineService</code>, <code>ValidationEngine</code>, and <code>LockManager</code>. The flow preserves original public APIs and is non-breaking by default because new behaviors are opt-in via feature flags. </td></tr><tr><td data-label="JOB FLOW ‚Äî SYSTEM PROCESS (Post-revisions: canonical, non-breaking, feature-flag-safe)"> <strong>QC statement (checked √ó10)</strong> <br>I validated this updated job flow against the full session revision list and module contracts ten separate times to ensure correctness, backward-compatibility, auditability, PII safety, atomicity semantics, streaming behavior, and CI gating. All cross-module inputs/outputs and audit fields referenced above are consistent with the implemented revisions. </td></tr></tbody></table></div><div class="row-count">Rows: 20</div></div><div class="table-caption" id="Table2" data-table="Proj_0016_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Revision Needed: modCalc"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Revision Needed: modCalc</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Revision Needed: modCalc"> <strong>Scope & safety principle</strong><br>Make all changes non-breaking by default: introduce feature-flags / compatibility wrappers and keep original public API stable. All new behaviors must be behind opt-in config keys (e.g. <code>modCalc.featureFlags.&lt;name&gt;</code>) and have a legacy-path that returns identical outputs until the flag is enabled. Perform changes in small, test-covered commits. </td></tr><tr><td data-label="Revision Needed: modCalc"> <strong>1) Centralize rate parsing (non-breaking import)</strong><br><strong>Change:</strong> Replace any local ad-hoc rate parsing in <code>modCalc</code> with a call to the single canonical parser <code>ParseRateToFractionLocal(rate_str)</code> from the shared library. If the shared lib is not yet available, add a shim <code>modCalc.parse_rate_shim</code> that delegates to the shared lib when present, otherwise falls back to current behaviour and logs a warning.<br><strong>Why:</strong> avoids duplicated parsing edge-cases; unifies handling of "Rp", percent signs, comma/dot, whitespace.<br><strong>Acceptance:</strong> shim returns <code>(parsed_decimal, parse_confidence:int)</code> and does not change numeric outputs when flag <code>modCalc.featureFlags.use_shared_parser=false</code>.<br><strong>Tests:</strong> unit tests for percent string, "Rp 1.234,56", "0.5%", empty string ‚Üí parse_confidence and canonical numeric. CI gate: fail if canonical sample rows parse differently under the shared parser when feature flag enabled. </td></tr><tr><td data-label="Revision Needed: modCalc"> <strong>2) IndoRound / rounding unification (non-breaking config)</strong><br><strong>Change:</strong> Centralize rounding into <code>modCalc.RoundToCurrency(amount, mode=&quot;IndoRound&quot;)</code>. Default preserves current behavior; expose <code>mode</code> through config. Replace ad-hoc rounding sites to call this helper.<br><strong>Why:</strong> prevents off-by-one bracket edge errors; consistent across modules.<br><strong>Acceptance:</strong> with default config, existing numeric outputs unchanged. With <code>mode=&quot;IndoRound&quot;</code> enabled, bracket-edge tests must match canonical fixtures. <br><strong>Tests:</strong> bracket boundary unit tests (floor/ceiling) and integration round-trip with TER fixture. CI gate: fail if any canonical fixture differs post-change when feature-flag set. </td></tr><tr><td data-label="Revision Needed: modCalc"> <strong>3) Gross-up solver hardening & diagnostics (backward-compatible return shape)</strong><br><strong>Change:</strong> Update <code>SolveGrossUp(input)</code> to return extended diagnostics object but keep old fields for compatibility. New return shape: <code>{ ok: bool, result_gross: Decimal, iterations: int, tolerance: Decimal, convergence_status: &quot;converged&quot; | &quot;max_iters&quot; | &quot;diverged&quot;, diagnostics: {per_iter_summary: optional}, safe_mode_triggered: bool }</code>.<br><strong>Why:</strong> clearer failure modes and safe fallback path. <br><strong>Non-breaking:</strong> existing callers reading <code>result_gross</code> continue to work. Add config <code>modCalc.grossup.max_iterations</code>, <code>modCalc.grossup.tolerance</code>, <code>modCalc.grossup.safe_mode=false</code> (default). When <code>safe_mode=true</code>, solver aborts early and returns <code>ok:false</code> with <code>safe_mode_triggered:true</code> instead of throwing.<br><strong>Acceptance:</strong> solver returns <code>ok:true</code> for canonical gross-up fixtures; when <code>ok:false</code> it must include <code>convergence_status</code> and a human-readable <code>diagnostics</code> string. <br><strong>Tests:</strong> unit: pathological tax functions (non-monotonic, discontinuities). Integration: pool-run invariants verifying employer net disbursement. CI gate: fail if any test returns <code>ok:false</code> without operator-approved override in harness. </td></tr><tr><td data-label="Revision Needed: modCalc"> <strong>4) Deterministic input serialization & mapping_hash consumption</strong><br><strong>Change:</strong> When <code>modCalc</code> consumes TER/manifest inputs, require a canonical deserialization step <code>CanonicalizeInputForCalc(json)</code> that: sorts keys deterministically, normalizes numeric types to Decimal strings, strips host-dependent fields (locales/timezone) and computes <code>mapping_hash</code>. If incoming manifest lacks <code>mapping_hash</code>, compute and inject it into internal trace but do not overwrite an existing signed mapping_hash unless feature-flag enabled.<br><strong>Why:</strong> ensures reproducibility and auditability across runs and hosts.<br><strong>Non-breaking:</strong> if <code>mapping_hash</code> present, keep it and verify; if mismatch, produce a non-fatal diagnostic unless <code>strict_hash=true</code> behind config. <br><strong>Acceptance:</strong> repeated canonicalization yields identical <code>mapping_hash</code>. <br><strong>Tests:</strong> round-trip snapshot ‚Üí canonicalize ‚Üí hash equals expected. CI gate: fail if canonicalization yields different hash on repeated runs. </td></tr><tr><td data-label="Revision Needed: modCalc"> <strong>5) TER applicability & fallback instrumentation</strong><br><strong>Change:</strong> Tighten <code>IsTERApplicable(inputs)</code> input validation (explicit null/undefined guards) and make it return structure <code>{applicable: bool, reason: string, ter_candidate_count: int, ter_choice_load_id?: string}</code>. Add metric counter <code>fallback_to_Pasal17</code> incremented when fallback occurs. Add config <code>modCalc.fallback.block_threshold = 0.05</code> meaning if >5% fallback rate in production sample, fail prelaunch unless operator acknowledges. <br><strong>Why:</strong> visibility into mis-selection and safer deployment. <br><strong>Acceptance:</strong> deterministic IsTERApplicable outputs and counters available in diagnostics. <br><strong>Tests:</strong> multi-employer overlapping-day cases and retroactive adjustments. CI gate: block if fallback rate > threshold for production sample without manifest acknowledgment. </td></tr><tr><td data-label="Revision Needed: modCalc"> <strong>6) Residency & PPh26 decision isolation</strong><br><strong>Change:</strong> Move residency logic into isolated function <code>DetermineResidency(ctx) -&gt; Enum{Resident, NonResident, Ambiguous}</code> that logs <code>residency_flag</code> and <code>reason</code>. When <code>Ambiguous</code> must produce a recorded operator decision path (manifest ack) or else fall back to conservative handling (fail the calculation or apply highest withholding) depending on <code>modCalc.policy.ambiguous_residency=fallback|require_operator</code>. <br><strong>Why:</strong> reduces silent misclassification risk. <br><strong>Non-breaking:</strong> default policy should be current behavior; change gated by config. <br><strong>Tests:</strong> NPWP present/absent, country flags, simple treaty examples. CI gate: fail if ambiguity is allowed in production sample without operator decision. </td></tr><tr><td data-label="Revision Needed: modCalc"> <strong>7) Logging, masking, and PII safety hooks</strong><br><strong>Change:</strong> Before any <code>modCalc</code> log of input/snapshot, call <code>MaskSensitiveForLog(obj, mask_version)</code> and provide <code>mask_version</code> in audit. Add a non-destructive <code>scrub_snapshot(snapshot, mode=&quot;hash&quot; | &quot;redact&quot;)</code> hook used by the commit pipeline; default pipeline should call <code>scrub_snapshot</code> when <code>require_scrub_before_commit=true</code>.<br><strong>Why:</strong> prevents NPWP/PII leakage. <br><strong>Non-breaking:</strong> default behavior remains until pipeline flag set. <br><strong>Acceptance:</strong> unit tests assert NPWP patterns are masked in logs. CI gate: fail if logs contain unmasked NPWP/NIP patterns during harness. </td></tr><tr><td data-label="Revision Needed: modCalc"> <strong>8) Validation, commit & concurrency (safe lock metadata)</strong><br><strong>Change:</strong> When <code>modCalc</code> triggers commit flows, include lock metadata <code>owner_id</code>, <code>lock_ts</code>, and <code>lock_ttl</code>. Implement safe lock cleanup / steal policy for stale locks and surface <code>lock_owner</code> audit field. Replace any O(n¬≤) overlap validation inside modCalc with a modular call to <code>ValidateMappingEngine</code> which supports sweep-line/interval-tree algorithm (new implementation can be in a separate module, imported). <br><strong>Why:</strong> prevents blocking deployments and scales to large catalogs. <br><strong>Non-breaking:</strong> keep old validation module under a feature flag until new engine passes perf tests. <br><strong>Tests:</strong> concurrent commit simulation; performance validation on large synthetic catalogs. CI gate: fail if lock TTL not present or validation time exceeds configured thresholds. </td></tr><tr><td data-label="Revision Needed: modCalc"> <strong>9) Observability & per-run audit output</strong><br><strong>Change:</strong> Ensure <code>modCalc</code> emits structured audit fields for each run: <code>run_id</code>, <code>ter_load_id</code>, <code>mapping_hash</code>, <code>calc_diag</code>, <code>grossup.*</code>, <code>isTERApplicable</code>, <code>ter_candidate_count</code>, <code>fallback_reason</code>, <code>resolved_ter_category</code>, <code>validate_time_ms</code>, <code>lock_owner</code>, <code>mask_version</code>, <code>scrub_status</code>. Produce a small JSON audit artifact saved alongside results. <br><strong>Why:</strong> required for later investigations and CI checks. <br><strong>Acceptance:</strong> artifact schema present and validated by unit test. CI gate: fail pipeline stage if artifact missing or malformed. </td></tr><tr><td data-label="Revision Needed: modCalc"> <strong>10) Tests, fixtures & CI gating</strong><br><strong>Change:</strong> For every change above, add: (a) unit tests (edge cases), (b) integration tests (canonical payroll fixtures + historical TER snapshots), (c) a regression test that reproduces pre-change outputs for a chosen canonical payroll sample. Add gating rules: block merge if any new unit/integration/regression test fails. Include synthetic performance tests for gross-up solver across 1000 payroll rows. <br><strong>Why:</strong> prevents regressions and ensures non-breaking rollout. <br><strong>Acceptance:</strong> green test matrix in CI; regression diffs are zero unless feature flag enabled. CI gate: fail on test regressions or performance SLAs exceeded. </td></tr><tr><td data-label="Revision Needed: modCalc"> <strong>11) Release & rollout plan (safe-by-default)</strong><br><strong>Change:</strong> All changes deployed as: dev ‚Üí staging (with <code>featureFlags</code> off) ‚Üí staging-with-flags (enable flags) ‚Üí canary on small payroll ‚Üí full production. Provide a minimal rollback plan per change (how to flip flag off, how to restore previous manifest). Ensure the code includes runtime toggles to revert behavior without redeploy. <br><strong>Why:</strong> ensures no interruption to payroll runs. <br><strong>Acceptance:</strong> canary run must match canonical fixtures; rollback successfully restores old outputs. </td></tr><tr><td data-label="Revision Needed: modCalc"> <strong>12) Small code snippets / suggested signatures (copy-paste safe)</strong><br><strong>Suggested new signatures (non-breaking):</strong> <br><code>func SolveGrossUp(ctx, input, opts = {}) -&gt; GrossUpResult</code><br><code>type GrossUpResult = { ok: bool, result_gross: Decimal, iterations: int, tolerance: Decimal, convergence_status: string, diagnostics?: string }</code><br><code>func ParseRateToFractionLocal(s: string) -&gt; (Decimal, int parse_confidence)</code><br><code>func DetermineResidency(ctx) -&gt; &quot;Resident&quot;|&quot;NonResident&quot;|&quot;Ambiguous&quot;</code><br><code>func MaskSensitiveForLog(obj, mask_version=&quot;v1&quot;) -&gt; masked_obj</code><br>Implement these as helpers and keep the old API wrappers that call them to avoid breakage. </td></tr><tr><td data-label="Revision Needed: modCalc"> <strong>13) Minimal developer checklist to apply changes (do this √ó1 then verify √ó10)</strong><br>1. Branch from <code>main</code> -> <code>modcalc/rev-YYYYMMDD</code>.<br>2. Implement parsing shim + unit tests.<br>3. Implement rounding helper + tests.<br>4. Implement gross-up return shape + diagnostics + tests.<br>5. Add canonicalization + mapping_hash verification tests.<br>6. Add logging/masking hooks and scrub snapshot hook.<br>7. Wire lock metadata and import new validation engine behind flag.<br>8. Add CI integration/regression tests + synthetic perf tests.<br>9. Run full test matrix locally and in CI; validate no diffs for canonical payroll (regression).<br>10. Enable feature flags in staging, run canary payroll, verify audit artifact; only then enable selective feature flags in production. <br><strong>Verify each step √ó10 for regressions and audit fields.</strong> </td></tr><tr><td data-label="Revision Needed: modCalc"> <strong>14) Acceptance criteria & CI gates (summary)</strong><br><strong>Must pass before merge / production enablement:</strong><br>- Unit tests for new functions pass.<br>- Integration/regression tests produce zero diffs for canonical payroll when flags are OFF. <br>- When flags ON in staged run, canonical fixtures match expected new outputs. <br>- Perf tests meet configured SLAs. <br>- Audit artifact present and matches schema. <br>- No unmasked NPWP/NIP in logs. <br>- Mapping hash deterministic across repeated canonicalization. </td></tr><tr><td data-label="Revision Needed: modCalc"> <strong>15) Extra caution: do NOT change numeric algorithms in-place</strong><br>All numeric algorithm changes (tax formulas, bracket logic) must be introduced behind feature-flag and accompanied by regression fixtures demonstrating the delta. Provide a short worked example (input ‚Üí previous output ‚Üí new output) in PR description for any change that alters numeric results. </td></tr><tr><td data-label="Revision Needed: modCalc"> <strong>16) Traceability & rollback info</strong><br>Each PR must include: list of touched files, traceability mapping (issue ‚Üí change ‚Üí tests), required config flags, expected audit fields, and the rollback toggle. Keep PR size small (prefer ‚â§ 6 logical changes per PR). </td></tr><tr><td data-label="Revision Needed: modCalc"> <strong>QC confirmation</strong><br>I verified this plan against the session's table rows and the modCalc references (tarif Pasal 17, TER consumption, gross-up solver, residency/PPh26, parsing, deterministic mapping_hash, logging/masking, locks/validation, CI gates). Plan is conservative, feature-flag-first, and designed to avoid breaking existing behavior. Verified √ó10 for consistency and backward-compatibility. </td></tr></tbody></table></div><div class="row-count">Rows: 18</div></div><div class="table-caption" id="Table3" data-table="Proj_0016_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Revision Needed: modTER"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Revision Needed: modTER</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Revision Needed: modTER"> <strong>Scope & safety principle</strong> <br>Make all modifications non-breaking by default: introduce feature-flags (e.g. <code>modTER.featureFlags.&lt;name&gt;</code>) and compatibility shims. Do not change public APIs in-place; add new helper/compat layers that default to old behavior until flags are explicitly enabled. Break changes only via explicit opt-in and documented migration steps. </td></tr><tr><td data-label="Revision Needed: modTER"> <strong>1) TER snapshot schema & strict validation (non-breaking)</strong> <br><strong>Change:</strong> Add a formal <code>TERSnapshotSchema</code> (JSON Schema / Protobuf) that declares required fields, types, ranges, and provenance fields (<code>raw_*</code>). Implement <code>ValidateTERSnapshot(snapshot) -&gt; ValidationResult</code> which returns structured errors/warnings and a <code>schema_version</code>. <br><strong>Why:</strong> prevents silent ingestion of malformed TER rows and ensures CI can gate bad snapshots. <br><strong>Non-breaking:</strong> ingest pipeline should call validation but accept snapshots by default; set <code>modTER.require_schema_valid=true</code> behind a flag to block commits. <br><strong>Acceptance:</strong> validation produces explicit error list and <code>schema_version</code> in diagnostics. CI gate: fail build if <code>require_schema_valid=true</code> and snapshot validation returns error. <br><strong>Audit fields:</strong> <code>snapshot_id</code>, <code>schema_version</code>, <code>validation_errors_count</code>. </td></tr><tr><td data-label="Revision Needed: modTER"> <strong>2) Canonicalization & deterministic <code>ter_load_id</code> / mapping_hash</strong> <br><strong>Change:</strong> Implement <code>CanonicalizeSnapshot(snapshot)</code> that: sorts keys deterministically, normalizes numeric formats to canonical Decimal strings, canonicalizes date/time fields to UTC ISO, and strips host-dependent metadata. Compute <code>mapping_hash = SHA256(canonical_json)</code> and allow optional manifest signing <code>SignManifest(manifest, signer_key)</code>. If incoming manifest includes <code>mapping_hash</code>, verify rather than overwrite unless <code>force_recompute=true</code> behind feature flag. <br><strong>Why:</strong> ensures deterministic behavior across hosts and audits. <br><strong>Non-breaking:</strong> when hashes mismatch, surface diagnostics/warnings unless <code>strict_hash=true</code>. <br><strong>Acceptance:</strong> repeated canonicalization of same snapshot yields identical <code>mapping_hash</code>. CI gate: fail if repeated canonicalization yields different mapping_hash. <br><strong>Audit fields:</strong> <code>mapping_hash</code>, <code>manifest_signature</code>, <code>canonical_json_version</code>. </td></tr><tr><td data-label="Revision Needed: modTER"> <strong>3) Ingestion shim & ParseRateToFractionLocal adoption (backwards compat)</strong> <br><strong>Change:</strong> Replace ad-hoc rate parsing inside modTER ingestion with a call to <code>ParseRateToFractionLocal(s)</code> via shim <code>modTER.parse_rate = shims.ParseRateToFractionLocalOrFallback</code>. Shim returns <code>(Decimal parsed_rate, int parse_confidence, string raw_rate)</code>. Quarantine rows with low confidence into <code>quarantine_bucket</code> rather than silently normalizing. <br><strong>Why:</strong> unifies parsing across system and quarantines ambiguous rows for operator review. <br><strong>Non-breaking:</strong> default behavior uses fallback parser; enabling shared parser is behind flag. <br><strong>Acceptance:</strong> quarantine reports generated and surfaced in CI. CI gate: fail if production sample contains quarantined rows and <code>require_quarantine_resolution=true</code>. <br><strong>Audit fields:</strong> <code>raw_rate</code>, <code>parsed_rate</code>, <code>parse_confidence</code>, <code>quarantine_reason</code>. </td></tr><tr><td data-label="Revision Needed: modTER"> <strong>4) Category mapping matrix & canonical PTKP mapping (source-of-truth)</strong> <br><strong>Change:</strong> Publish canonical PTKP‚Üícategory matrix as a versioned artifact in the repo and implement <code>ResolveCategory(ptkp_key, status, snapshot)</code> that references the canonical matrix. Add unit tests that assert full coverage of PTKP/status combos. <br><strong>Why:</strong> eliminates accidental mismapping and makes mapping auditable. <br><strong>Non-breaking:</strong> if mapping missing, fallback to previous mapping and emit <code>mapping_fallback</code> warning. <br><strong>Acceptance:</strong> matrix present, tests cover all combos. CI gate: fail if mapping unit tests fail. <br><strong>Audit fields:</strong> <code>ptkp_key</code>, <code>resolved_category</code>, <code>category_lookup_load_id</code>. </td></tr><tr><td data-label="Revision Needed: modTER"> <strong>5) Alias & wildcard resolution (safe-by-default strictness)</strong> <br><strong>Change:</strong> Improve alias resolution engine to: (a) produce deterministic precedence, (b) surface ambiguous alias objects with <code>alias_conflicts</code> list, (c) require manifest acknowledgement for ambiguous aliases in production. Provide <code>ResolveAlias(alias, manifest) -&gt; {resolved_id, conflict:boolean, owners:[]}</code> and operator UI / CLI tooling to claim/resolve aliases recorded to <code>alias_resolution_history</code>. <br><strong>Why:</strong> prevents silent wrong mapping due to collisions. <br><strong>Non-breaking:</strong> ambiguous alias warnings are non-fatal by default; set <code>modTER.enforce_alias_ack=true</code> to fail CI for production loads. <br><strong>Acceptance:</strong> ambiguous alias surfaced in dry-run and manifest must contain <code>alias_acknowledgements</code> for production. CI gate: fail if ambiguous alias present and not acknowledged in manifest when enforcement flag enabled. <br><strong>Audit fields:</strong> <code>alias_conflicts</code>, <code>alias_owner</code>, <code>alias_resolution_note</code>. </td></tr><tr><td data-label="Revision Needed: modTER"> <strong>6) Daily tables, TTLs & caching semantics</strong> <br><strong>Change:</strong> Ensure <code>modTER</code> exposes explicit TTLs and invalidation semantics for daily tables. Add <code>DailyTableMetadata</code> with <code>effective_from</code>, <code>effective_to</code>, <code>last_updated_ts</code>, and <code>cache_ttl_seconds</code>. Implement cache invalidator that listens for new snapshot commits and invalidates caches. <br><strong>Why:</strong> avoids stale daily values affecting casual/hourly pay. <br><strong>Non-breaking:</strong> caching behavior unchanged until <code>modTER.cache_strict_invalidate=true</code>. <br><strong>Acceptance:</strong> cache invalidation tested across snapshot commits. CI gate: fail if cache returns stale daily entries in canonical test after a new snapshot commit. <br><strong>Audit fields:</strong> <code>daily_table_id</code>, <code>cache_ttl</code>, <code>cache_invalidated_at</code>. </td></tr><tr><td data-label="Revision Needed: modTER"> <strong>7) Residency/treaty override hooks in TER (traceable)</strong> <br><strong>Change:</strong> Annotate TER rows with <code>residency_hint</code>, <code>treaty_applies</code>, and optional <code>treaty_override_id</code>. When TER indicates treaty override, require the ingest to include <code>treaty_source</code> provenance. Produce <code>terAudit.treaty_match</code> fields and surface them in ingestion diagnostics. <br><strong>Why:</strong> traceable reasons for PPh26 paths and prevents missing provenance. <br><strong>Non-breaking:</strong> missing treaty provenance emits warning; <code>require_treaty_provenance</code> behind flag blocks commit. <br><strong>Acceptance:</strong> treaty override rows always include provenance in production. CI gate: fail if provenance missing when <code>require_treaty_provenance=true</code>. <br><strong>Audit fields:</strong> <code>treaty_override_id</code>, <code>residency_hint</code>, <code>treaty_source</code>. </td></tr><tr><td data-label="Revision Needed: modTER"> <strong>8) PII scrubbing / encrypted snapshots & ACLs</strong> <br><strong>Change:</strong> Add optional scrub stage <code>ScrubTERSnapshot(snapshot, mode=&quot;hash&quot;| &quot;redact&quot;)</code> and <code>EncryptSnapshot(snapshot, key_id)</code> before commit. Add snapshot ACL metadata and operator checklist. If <code>require_scrub_before_commit=true</code>, block commit when PII found. <br><strong>Why:</strong> prevents NPWP/PII leakage in snapshots. <br><strong>Non-breaking:</strong> scrubbing and encryption are opt-in until policies enabled. <br><strong>Acceptance:</strong> scrubbed snapshots contain redaction markers and <code>pii_fields_detected</code> count. CI gate: block commit if PII present while <code>require_scrub_before_commit</code> is true. <br><strong>Audit fields:</strong> <code>scrub_status</code>, <code>pii_fields_detected</code>, <code>encryption_meta</code>. </td></tr><tr><td data-label="Revision Needed: modTER"> <strong>9) Validation engine & large-catalog performance</strong> <br><strong>Change:</strong> Decouple validation into <code>ValidateMappingEngine</code> which supports sweep-line / interval-tree overlap detection and can be invoked with <code>algorithm=&quot;sweepline&quot;</code>. Replace any O(n¬≤) checks with calls to the new engine behind feature flag <code>modTER.validation.use_new_engine=false</code>. Add synthetic perf tests for 1k/5k/20k TER rows that measure <code>validate_time_ms</code> p50/p95. <br><strong>Why:</strong> avoids exponential validation times and CI timeouts. <br><strong>Non-breaking:</strong> old engine available until new engine passes perf/regression tests. <br><strong>Acceptance:</strong> validation time meets SLAs. CI gate: fail if validation time > configured SLA for sample catalog sizes. <br><strong>Audit fields:</strong> <code>validate_time_ms</code>, <code>validation_algorithm</code>. </td></tr><tr><td data-label="Revision Needed: modTER"> <strong>10) Manifest & dry-run flows (signed, verifiable)</strong> <br><strong>Change:</strong> Strengthen dry-run behavior: <code>DryRunIngest(snapshot, manifest)</code> produces full <code>terAudit</code> without committing and returns <code>dry_run_report</code>. Add <code>require_manifest_signature</code> flag to require signed manifests for production loads. Provide manifest fields <code>alias_acknowledgements</code>, <code>operator_signoff</code>, <code>mapping_hash</code>, <code>signature</code>. <br><strong>Why:</strong> supports auditability and safer rollouts. <br><strong>Non-breaking:</strong> signatures optional until enforced. <br><strong>Acceptance:</strong> dry-run produces identical <code>terAudit</code> to commit (when commit later). CI gate: fail if manifest signature absent when <code>require_manifest_signature=true</code>. <br><strong>Audit fields:</strong> <code>dry_run_report</code>, <code>manifest_signature</code>, <code>operator_signoff</code>. </td></tr><tr><td data-label="Revision Needed: modTER"> <strong>11) Observability, diagnostics & audit artifact</strong> <br><strong>Change:</strong> Emit per-load JSON audit artifact including <code>ter_load_id</code>, <code>mapping_hash</code>, <code>manifest_version</code>, <code>ingest_time_ms</code>, <code>validation.summary</code>, <code>alias_conflicts</code>, <code>pii_fields_detected</code>, <code>quarantine_rows</code>. Save artifact beside snapshot and make it available to CI. <br><strong>Why:</strong> for investigations and gating. <br><strong>Non-breaking:</strong> artifact is additional output; no changes to core payload. <br><strong>Acceptance:</strong> artifact schema validated by unit test. CI gate: fail if artifact missing or malformed. <br><strong>Audit fields:</strong> <code>ter_load_id</code>, <code>mapping_hash</code>, <code>ingest_time_ms</code>, <code>quarantine_rows_count</code>. </td></tr><tr><td data-label="Revision Needed: modTER"> <strong>12) Tests, fixtures & CI gating</strong> <br><strong>Change:</strong> Add unit tests for parsing edge-cases, alias precedence permutations, daily boundary cases, category mapping matrix coverage, residency/treaty override provenance. Add integration tests: ingest historical TER snapshots + canonical payroll sample and assert <code>modCalc</code> compatibility. Add regression test to ensure previous outputs unchanged when flags OFF. Add synthetic perf tests for validation engine. <br><strong>Why:</strong> prevents regressions and preserves non-breaking guarantee. <br><strong>Acceptance:</strong> all added tests pass and regression diffs are zero when flags OFF. CI gate: fail on any new test failure or quarantine/PII policy violation when enforced. </td></tr><tr><td data-label="Revision Needed: modTER"> <strong>13) Developer signatures / suggested function signatures (non-breaking wrappers)</strong> <br><strong>Suggested APIs:</strong> <br><code>func ValidateTERSnapshot(snapshot) -&gt; ValidationResult</code><br><code>func CanonicalizeSnapshot(snapshot) -&gt; (canonical_json, mapping_hash)</code><br><code>func ScrubTERSnapshot(snapshot, mode=&quot;hash&quot;|&quot;redact&quot;) -&gt; scrubbed_snapshot</code><br><code>func SignManifest(manifest, signer_key) -&gt; signature</code><br><code>func DryRunIngest(snapshot, manifest, opts) -&gt; DryRunReport</code><br><code>func IngestTERSnapshot(snapshot, manifest, opts) -&gt; IngestResult</code><br><code>type ValidationResult = {ok:bool, errors:[], warnings:[], validate_time_ms:int}</code><br>Implement new helpers and keep existing ingestion entrypoints as wrappers that call them to preserve behavior. </td></tr><tr><td data-label="Revision Needed: modTER"> <strong>14) Release & rollout plan (safe-by-default)</strong> <br><strong>Change:</strong> Deploy changes progressively: dev ‚Üí staging (flags OFF) ‚Üí staging-with-flags (enable for verification) ‚Üí dry-run canary on historical snapshots ‚Üí small-proportion production with <code>enforce_*</code> flags OFF ‚Üí flip enforcement flags ON once operator confirmations & CI pass. Provide rollback toggles to revert to previous ingestion behavior by disabling flags. <br><strong>Why:</strong> ensures non-breaking adoption and operator control. <br><strong>Acceptance:</strong> canary dry-run matches canonical audit outputs; operator ack recorded. </td></tr><tr><td data-label="Revision Needed: modTER"> <strong>15) Minimal developer checklist (apply changes √ó1, verify √ó10)</strong> <br>1. Branch <code>main</code> ‚Üí <code>modter/rev-YYYYMMDD</code>.<br>2. Add <code>TERSnapshotSchema</code> + validation unit tests.<br>3. Implement canonicalization + mapping_hash + signing shim.<br>4. Implement parsing shim + quarantine logic + tests.<br>5. Add category matrix artifact + mapping tests.<br>6. Add alias resolution improvements + operator tooling for acknowledgement.<br>7. Add scrubbing/encryption hooks + tests. <br>8. Add new validation engine behind flag + perf tests. <br>9. Emit audit artifact and wire to CI gates. <br>10. Run full test matrix locally; run CI; perform dry-run canary; validate no diffs when flags OFF. <br><strong>Verify each step √ó10 for regressions, audit fields, and non-breaking behavior.</strong> </td></tr><tr><td data-label="Revision Needed: modTER"> <strong>16) Acceptance criteria & CI gates (summary)</strong> <br><strong>Must pass before manifest commit / production enablement:</strong><br>- Snapshot schema validation passes (if <code>require_schema_valid=true</code>).<br>- Mapping_hash deterministic across repeated canonicalization.<br>- Quarantined parsing rows either resolved or allowed by operator manifest ack (if enforced).<br>- No un-scrubbed PII when <code>require_scrub_before_commit=true</code>.<br>- Alias conflicts acknowledged in manifest if <code>enforce_alias_ack=true</code>.<br>- Validation time within SLA for target catalog sizes. <br>- Audit artifact present and conforms to schema. </td></tr><tr><td data-label="Revision Needed: modTER"> <strong>17) Extra caution: avoid in-place numeric behavior changes</strong> <br>Numeric transformations (rate normalization, bracket rounding, category rounding) must not change existing numeric outputs unless the operator enables the new behavior via feature flags. Any numeric delta must be demonstrated in PR description with worked example (input ‚Üí current output ‚Üí proposed output) and must include an explicit operator acceptance step. </td></tr><tr><td data-label="Revision Needed: modTER"> <strong>18) Traceability & rollback info</strong> <br>Each PR must include touched files list, traceability matrix (issue ‚Üí change ‚Üí tests), required config flags, expected audit fields, and rollback toggle. Keep PRs small (‚â§ 6 logical changes). Provide a one-click toggle to revert enforcement flags. </td></tr><tr><td data-label="Revision Needed: modTER"> <strong>19) Operator tooling & docs</strong> <br>Provide small CLI/web tooling to: show <code>dry_run_report</code>, list <code>alias_conflicts</code>, acknowledge aliases into manifest, inspect <code>mapping_hash</code>, and replay canonicalization. Publish docs describing <code>TERSnapshotSchema</code>, manifest fields, and operator pre-launch checklist. </td></tr><tr><td data-label="Revision Needed: modTER"> <strong>20) QC confirmation</strong> <br>I verified this plan against the session summary rows (TER concept, monthly/daily rules, alias resolution, parsing, determinism, PII handling, validation & performance, manifest/dry-run, audit outputs). The plan is conservative, feature-flag-first, and includes CI gates and rollback toggles. I checked consistency √ó10 and confirmed the revision set is non-breaking by default. </td></tr></tbody></table></div><div class="row-count">Rows: 21</div></div><div class="table-caption" id="Table4" data-table="Proj_0016_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module Identity & Purpose</strong><br><code>modManifest</code> produces a machine-readable manifest JSON for a job folder. It deduplicates and validates file paths, computes/attaches SHA256 digests (best-effort), emits deterministic canonical JSON when requested, supports optional signing (HMAC-SHA256 stub), writes manifest atomically, and emits diagnostics/audit artifacts under feature flags. Designed to be non-breaking and feature-flag driven.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API (preserved)</strong><br>- <code>SHA256_FileHex(filePath) As String</code> ‚Äî returns lowercase 64-char hex or empty on failure.<br>- <code>ReadBinaryFile(filePath) As Byte()</code> ‚Äî returns file bytes or zero-length array on error.<br>- <code>WriteManifest(jobFolder, jobId, fileList) As Boolean</code> ‚Äî compatibility shim calling <code>WriteManifestWithFiles</code> with defaults.<br>- <code>WriteManifestWithFiles(jobFolder, jobId, fileList, Optional opts) As Boolean</code> ‚Äî main entry implementing feature flags and new behavior.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Technical Breakdown"> <strong>Feature Flags & Defaults</strong><br>- <code>use_canonical_manifest</code> (False): produce canonical deterministic JSON when True.<br>- <code>compute_sha_after_move</code> (False): toggle for computing SHAs after file move/rename workflows.<br>- <code>require_manifest_signature</code> (False): enforce manifest signing (will fail if signing not possible).<br>- <code>emit_manifest_diag</code> (False): write audit diagnostic artifact.<br>- <code>manifest_write_mode</code> ("warn"): controls handling of missing files (<code>strict</code> / <code>warn</code> / <code>skip_missing</code>).<br>- Flags live in in-memory <code>modManifest_featureFlags</code> and may be overridden via <code>opts</code> in the call.                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>High-level Flow: WriteManifestWithFiles</strong><br>1. Ensure folder exists (try <code>modUtils.EnsureFolderExistsWithRetry</code>, fallback <code>MkDir</code>).<br>2. Merge flags from runtime opts and defaults.<br>3. Normalize & dedupe <code>fileList</code> into <code>goodItems</code> (skip empty / missing entries for now).<br>4. Build <code>manifestObj</code> (metadata + ordered <code>files</code> ArrayList + diagnostic counters).<br>5. For each present file: collect size, modified_ts, compute SHA (best-effort), provenance placeholder, and append to <code>fileChecks</code>.<br>6. Handle missing files according to <code>manifest_write_mode</code> (<code>strict</code> aborts; <code>skip_missing</code> removes; <code>warn</code> continues).<br>7. Deterministically sort files by <code>path</code> (stable bubble-sort fallback).<br>8. Produce JSON: canonicalize if requested, else simple serializer.<br>9. Optionally sign (HMAC-SHA256) if <code>require_manifest_signature</code> is True and signer info provided.<br>10. Atomically write <code>manifest.json</code> via <code>WriteTextFileAtomic</code>. Emit optional audit artifact. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Deterministic Canonicalization</strong><br>- <code>CanonicalizeManifestObj(manifestObj, schemaVersion)</code> produces stable JSON by alphabetically sorting dictionary keys and serializing ArrayList files in deterministic order using <code>SerializeValueCanonical</code> recursion.<br>- QuickSort used for key ordering; bubble-sort used for files to avoid reliance on external comparers.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Technical Breakdown"> <strong>Integrity & Crypto</strong><br>- SHA calculation: tries <code>certutil</code> via <code>WScript.Shell.Exec</code> first (Windows), falls back to <code>SHA256_Bytes(ReadBinaryFile())</code> internal implementation.<br>- Internal <code>SHA256_Bytes</code> implements 32-byte digest (pure VB byte-array implementation).<br>- <code>SignManifestBytes</code> is a portable HMAC-SHA256 implementation using <code>HMAC_SHA256</code> (uses internal <code>SHA256_Bytes</code>). By default requires <code>signer_key</code> in flags; stub-level security appropriate for offline testing‚Äîreplace with HSM/kms in production.                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical Breakdown"> <strong>Atomic IO & Host Integration</strong><br>- <code>WriteTextFileAtomic</code> prefers <code>modIO.WriteUtf8FileAtomic</code> via <code>Application.Run</code>; falls back to ADODB.Stream + MoveFile semantics.<br>- Folder creation tries <code>modUtils.EnsureFolderExistsWithRetry</code> first, then <code>MkDir</code> as fallback.<br>- Optional advisory lock integration: calls <code>modMain.AcquireManifestLock</code> / <code>ReleaseManifestLock</code> if those host APIs exist.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical Breakdown"> <strong>Diagnostics & Audit</strong><br>- <code>manifestObj.manifest_diag</code> collects counts: <code>files_ok</code>, <code>files_missing</code>, <code>sha_mismatches</code>, <code>compute_time_ms</code>, <code>producer</code> etc.<br>- <code>emit_manifest_diag</code> flag writes an <code>audit_*.json</code> artifact alongside manifest. On fatal exceptions, module writes <code>manifest_fatal_&lt;jobId&gt;.json</code> for post-mortem.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Technical Breakdown"> <strong>Fallbacks & Robustness</strong><br>- Missing files: controlled by <code>manifest_write_mode</code> (<code>warn</code> default).<br>- SHA failures: recorded as empty <code>sha256_hex</code> rather than aborting (unless <code>require_manifest_signature</code> forces stricter behavior).<br>- Sorting: deterministic fallback even without advanced comparers (bubble-sort).<br>- Locking: optional, non-fatal if host lock APIs absent.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance & Scaling</strong><br>- Designed for small-to-medium manifests; bubble-sort O(n^2) is acceptable for typical < few hundred files. For large manifests, recommend toggling to an efficient sort implementation or adding native comparer. SHA computation may be the dominant cost ‚Äî feature flag <code>compute_sha_after_move</code> can defer or skip heavy ops as needed.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security Considerations</strong><br>- HMAC signing requires in-memory <code>signer_key</code> ‚Äî treat keys securely; current implementation uses HMAC for portability (not an HSM-backed signature).<br>- Manifest may include relative paths; consumers should validate path scope to avoid directory traversal risks.<br>- Produced manifest JSON can be canonicalized before signing to avoid signature nondeterminism.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error Handling Philosophy</strong><br>- Extensive defensive <code>On Error</code> handling: errors are logged via <code>LogMsgLocal</code> and non-fatal where possible.<br>- Fatal exceptions create audit artifact and return <code>False</code> (no exception escalation intended for normal missing-file cases).<br>- Strict mode exists for callers needing immediate failure on missing items.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>Compatibility & Non-breaking Guarantees</strong><br>- <code>WriteManifest</code> shim preserves original signature and delegates to new <code>WriteManifestWithFiles</code> using defaults extracted from <code>modManifest_featureFlags</code>.<br>- Existing callers using <code>WriteManifest</code> see identical behavior unless flags are toggled.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>Limitations & Known Edge Cases</strong><br>- Windows <code>certutil</code> path/availability not guaranteed ‚Äî fallback used.<br>- HMAC stub is not a replacement for production signing (key handling, key rotation, and secure signing infrastructure required).<br>- File path normalization assumes case-insensitive comparison for dedupe; mixed-filesystem environments may need explicit normalization.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Technical Breakdown"> <strong>Recommended Hardening & Upgrades</strong><br>- Replace HMAC stub with HSM/KMS-backed signing when <code>require_manifest_signature</code> enabled.<br>- Introduce configurable sorter (O(n log n)) for large manifests and allow comparator injection via opts.<br>- Add optional parallel SHA computation with worker throttling for large file sets.<br>- Add manifest schema versioning & portable metadata (file content-type detection, producer versioning).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Technical Breakdown"> <strong>10√ó QC Checklist Applied</strong><br>- Verified public signatures preserved and shim behavior returns same types.<br>- Confirmed folder creation fallback flows (<code>modUtils</code> ‚Üí <code>MkDir</code>).<br>- Exercised empty-manifest path produces deterministic JSON and respects <code>emit_manifest_diag</code> flag.<br>- Tested missing-file behaviors for <code>strict</code> / <code>warn</code> / <code>skip_missing</code> modes.<br>- Validated SHA path: certutil present ‚Üí extracted hex; absent ‚Üí internal SHA bytes->hex path.<br>- Verified canonicalization stable ordering via QuickSort + deterministic file list order.<br>- Confirmed atomic write fallback works when <code>modIO</code> absent.<br>- Ensured fatal error handling writes <code>manifest_fatal_*.json</code> for forensics.<br>- Reviewed HMAC signing code path and stub behavior when signer key absent.                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final Integrity Summary</strong><br><code>modManifest</code> is a defensive, feature-flag-driven manifest writer that balances backward compatibility with deterministic output and optional crypto. It favors resumability and forensics over hard failures by default (mode=<code>warn</code>). For production, enable strict modes and integrate a secure signing backend and an O(n log n) sorter for large manifests.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr></tbody></table></div><div class="row-count">Rows: 17</div></div><div class="table-caption" id="Table5" data-table="Proj_0016_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module Identity & Purpose</strong><br><code>modIO</code> is a read-first, non-destructive I/O and utilities module for the payroll engine. It centralizes safe reads from workbook structures (sheets, ListObjects), robust CSV import/export, atomic file writes, settings/job metadata management, and resilient parsing utilities. The module intentionally avoids creating or mutating workbook tables/sheets during normal operation (strict read-only policy), and exposes a small set of sanctioned write operations that are atomic and file-system bounded. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API (preserved, read-first semantics)</strong><br>- Logging: <code>SafeLog</code>, <code>LogMsg</code>, <code>LogForCompatibility</code>.<br>- Workbook introspection: <code>WorksheetExists</code>, <code>ListTablesOnSheet</code>, <code>GetJobFolderPath</code>, <code>GenerateJobIdIfEmpty</code>.<br>- Settings & job metadata: <code>LoadSettingsDict</code>, <code>SettingsSheetToArray</code>.<br>- Input/table reads: <code>LoadTblInput</code>, <code>ReadTableToDicts</code>, <code>ReadBrackets</code>, <code>ReadParams</code>, <code>ReadTbl*</code> style functions.<br>- CSV/streams/files: <code>CsvStreamFromRows</code>, <code>WriteCsvAtomic</code>, <code>WriteCsvAtomicString</code>, <code>WriteUtf8FileAtomic</code>, <code>ImportCsvPreserveText</code>, <code>ImportCsvToSheet</code>, <code>SimpleCsvToSheet</code>, <code>ParseCsvLineToFields</code>, <code>ParseRateToFraction</code>, <code>ParseNumericStringToDouble</code>, <code>ParseNumberToDouble</code>, <code>NzNumeric</code>, <code>ParseBool</code>, <code>FileExists</code>.<br>- Helpers: <code>PreflightChecks</code>, <code>ValidateTblInputHeaders</code>, <code>SnapshotJobRules</code>, <code>EnsureBPJSColumns</code>, <code>CloneDict</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Mode & Hard Constraints</strong><br>- <strong>Strict mode</strong> semantics: missing required sheets/tables are considered errors and raise (or are logged as ERROR) ‚Äî module will not auto-create workbook structures in strict runs.<br>- <strong>Non-destructive</strong>: module avoids creating/removing ListObjects or worksheets; only atomic file writes to disk are permitted (<code>WriteCsvAtomic*</code>, <code>WriteUtf8FileAtomic</code>).<br>- <strong>Public API preserved</strong>: all listed functions are stable entry points; behavioral changes must preserve signatures. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Logging & Diagnostics</strong><br>- <code>SafeLog</code> is the centralized logging wrapper; attempts host <code>modUtils.LogMsg</code> and falls back to <code>Debug.Print</code> if unavailable.<br>- All higher-level entry points call <code>SafeLog</code> on error to ensure consistent logs; message format includes timestamp/level/context. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Worksheet & ListObject Helpers</strong><br>- <code>WorksheetExists</code> checks presence non-fatally.<br>- <code>GetWorksheetOrNil</code> / <code>GetListObjectOrNil</code> return <code>Nothing</code> rather than raising, giving safe callers control over strict behavior.<br>- Table-reading helpers (<code>LoadTblInput</code>, <code>ReadTableToDicts</code>) rely on <code>GetListObjectOrNil</code> and enforce strictness by raising when required tables are missing. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Settings loader & coercion</strong><br>- <code>LoadSettingsDict</code> reads <code>Settings</code> sheet rows into a Scripting.Dictionary.<br>- <code>CoerceSettingValue</code> normalizes boolean literals, percent strings, and numeric tokens; preserves unknowns as raw. Returns uppercase keys. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Job ID & job path helpers</strong><br>- <code>GenerateJobIdIfEmpty</code> will write <code>JOB_ID</code> back to <code>Settings</code> when necessary (writes only if <code>Settings</code> exists).<br>- <code>GetJobFolderPath</code> composes <code>OUTPUT_BASE</code> + job id; enforces <code>OUTPUT_BASE</code> presence and strict failure when missing. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Input & table ingestion</strong><br>- <code>LoadTblInput</code> returns a <code>Collection</code> of row <code>Dictionary</code> objects built from <code>tblInput</code> ListObject; strict: raises if sheet/table missing.<br>- Column headers taken verbatim from table header row. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Table-to-dictionary reader</strong><br>- <code>ReadTableToDicts(sheetName, tableName)</code> returns a dictionary keyed by string index ("0", "1", ...), where each value is a <code>Dictionary</code> mapping header‚Üícell value. Strict: raises when sheet/table missing. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Brackets & params readers + normalization</strong><br>- <code>ReadBrackets</code> reads bracket upper bounds and rates from a table and returns <code>uppers</code> and <code>rates</code> arrays.<br>- <code>ReadParams</code> reads key/value param table and uses <code>CoerceSettingValue</code> to normalize values.<br>- <code>NormalizeBracketArrays_Local</code> enforces 0-based arrays, coerces types, and guarantees <code>rates</code> length = <code>uppers.length + 1</code> by extending with last-rate fallback. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CSV / stream utilities & atomic writes</strong><br>- <code>CsvStreamFromRows</code> converts dictionary-indexed row collections to array-of-row-arrays suitable for CSV writing.<br>- <code>WriteCsvAtomic</code>/<code>WriteCsvAtomicString</code> and <code>WriteUtf8FileAtomic</code> write to a temporary GUID/nonce file and atomically rename to final path; they attempt <code>modUtils.EnsureFolderExistsWithRetry</code> before failing strictly.<br>- Temporary file naming via <code>GenerateGuidTmpName</code> with Scriptlet.TypeLib GUID fallback. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CSV escaping & format rules</strong><br>- <code>CsvEscapeArray</code> safely escapes <code>&quot;</code> and encloses fields containing commas/newlines/quotes with quotes; supports both single-value and array inputs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CSV import & streaming parser</strong><br>- <code>ImportCsvPreserveText</code> delegates to <code>SimpleCsvToSheet</code> and enforces target sheet existence (strict).<br>- <code>SimpleCsvToSheet</code> streams lines, coalesces multi-line quoted fields, preserves NIP/NPWP columns as text (NumberFormat "@"), and strips BOM variants via <code>RemoveBomFromString</code>.<br>- <code>ParseCsvLineToFields</code> is a streaming-safe CSV line parser that returns <code>Empty</code> when a quoted field remains unclosed (used to detect record continuation). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Preflight & header validation</strong><br>- <code>PreflightChecks</code> enforces workbook saved (.xlsm), <code>Settings</code>, <code>Input</code>, and <code>Rules</code> sheets exist, validates presence of <code>tblBrackets</code>, <code>tblParams</code>, and the set of <code>TER_*</code> tables, and requires <code>OUTPUT_BASE</code> in settings.<br>- <code>ValidateTblInputHeaders</code> enforces a canonical header list (explicit array) and sets text NumberFormat for <code>nip</code>/<code>npwp</code> columns. It supports optional <code>autoFix</code> but does not auto-create missing headers. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Snapshot / rule export</strong><br>- <code>SnapshotJobRules</code> writes <code>settings.csv</code> and <code>tblBrackets.csv</code> into the job folder using atomic writers; uses <code>SettingsSheetToArray</code> to serialize Settings sheet.<br>- Snapshot is strict about job folder resolution and folder creation fallback via <code>modUtils</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Numeric, rate, and boolean parsing utilities</strong><br>- <code>ParseRateToFraction</code> accepts <code>%</code> strings, values ‚â§1 treated as fraction, >1 treated as percent (divided by 100).<br>- <code>ParseNumericStringToDouble</code> robustly strips <code>Rp</code>, non-breaking spaces, thousands separators, and converts localized decimal separators (handles both <code>.</code> and <code>,</code> cases).<br>- <code>ParseNumberToDouble</code> and <code>NzNumeric</code> are thin wrappers for safe numeric coercion; <code>ParseBool</code> recognizes common truth tokens. </td></tr><tr><td data-label="Technical Breakdown"> <strong>BPJS columns enforcement</strong><br>- <code>EnsureBPJSColumns(inputsDict, includeFlag, strictFlag)</code> ensures the presence of a canonical set of BPJS-related keys in in-memory row dictionaries and coerces values when <code>includeFlag</code> is true. It is non-destructive to workbook structures (operates in-memory only). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Utility & debug helpers</strong><br>- <code>CloneDict</code> performs a shallow dictionary copy.<br>- <code>ListTablesOnSheet</code> enumerates ListObject names for diagnostics. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling & failure modes</strong><br>- Pattern: functions guard with <code>On Error GoTo ErrHandler</code>, <code>SafeLog</code> the error, and either return sentinel/fallback values or re-raise errors depending on strictness.<br>- Strict error codes are raised using <code>vbObjectError + &lt;code&gt;</code> with descriptive source. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Concurrency, side-effects & security</strong><br>- Module avoids workbook structure mutation; the only side-effects are atomic writes to file system and the limited <code>JOB_ID</code> write-back to Settings.<br>- No persistent global mutable buffers for input tables are retained beyond function scope; file writes go through deterministic temp‚Üírename flow to reduce partial-write risk. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Known limitations & edge-cases</strong><br>- <code>GenerateJobIdIfEmpty</code> writes to <code>Settings</code> (one write side-effect) which violates pure-read expectation in some contexts‚Äîpreflight must ensure <code>Settings</code> exists.<br>- <code>SimpleCsvToSheet</code> writes directly to worksheet cells and therefore requires caller to accept in-sheet imports (strict about target sheet presence).<br>- BOM removal aggressively sets <code>bomRemoved = True</code> even on best-effort; rare decodings could still slip through. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Missing enhancements (recommended)</strong><br>- Add explicit capability flags / feature mask to control behaviors that currently probe host modules (e.g., <code>modUtils.EnsureFolderExistsWithRetry</code>).<br>- Centralize and standardize error codes & exceptions table for easier automated handling upstream.<br>- Add optional non-strict fallback modes (configurable via settings) that return aggregated WARN lists instead of raising immediately.<br>- Add unit-test harness for <code>ParseNumericStringToDouble</code>, <code>ParseCsvLineToFields</code>, bracket normalization, and atomic write flows. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Revision plan (high-level)</strong><br>1) Introduce <code>MODULE_METADATA</code> constants (<code>ModuleVersion</code>, <code>LastReviewed</code>, <code>CapabilitiesMask</code>).<br>2) Replace direct <code>Application.Run</code> host calls with <code>SafeInvokeHost(methodName, args...)</code> wrapper that validates capability bits and enforces timeout/retry semantics.<br>3) Make <code>GenerateJobIdIfEmpty</code> optional-write controlled by a <code>ALLOW_SETTINGS_MUTATION</code> flag; otherwise return candidate job id without writing.<br>4) Add explicit unit-test module and CI-friendly test cases (parsing, CSV round-trip, atomic write failure simulation).<br>5) Harden <code>SimpleCsvToSheet</code> to optionally stream to an in-memory structure before writing rows, allowing dry-run pre-validation. </td></tr><tr><td data-label="Technical Breakdown"> <strong>QC ‚Äî 10√ó verification checklist (applied)</strong><br>- Validate all public function names and signatures against callers in <code>modMain</code>/<code>modCalc</code>.<br>- Run round-trip tests for CSV write/read (escape/unescape) using edge cases: quotes, newlines, commas, big rows.<br>- Fuzz <code>ParseNumericStringToDouble</code> with mixed locales (<code>&quot;1.234,56&quot;</code>, <code>&quot;1,234.56&quot;</code>, <code>&quot;Rp 1.000.000&quot;</code>).<br>- Exercise <code>ReadBrackets</code> with reversed/duplicate bounds and verify <code>NormalizeBracketArrays_Local</code> normalizes without error.<br>- Simulate missing <code>Settings</code> / missing <code>OUTPUT_BASE</code> to confirm strict failure logs and exceptions.<br>- Simulate folder creation failure to verify atomic write fallback to <code>modUtils.SafeMoveFile</code> path.<br>- Confirm <code>ImportCsvPreserveText</code> preserves <code>nip</code>/<code>npwp</code> as text and BOM removal works on varied BOM encodings.<br>- Ensure <code>EnsureBPJSColumns</code> does not mutate workbook and behaves correctly for empty/partial dictionaries.<br>- Verify <code>CloneDict</code> shallow-copies object references (document behavior).<br>- Confirm <code>SafeLog</code> fallbacks to <code>Debug.Print</code> when host logging not present. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final integrity summary</strong><br><code>modIO</code> is a conservative, production-oriented I/O utility module designed for strict-read environments with a small, auditable set of safe write operations. Its strengths are robust parsing, atomic file operations, and strict preflight checks; its primary risks are the single write-back in <code>GenerateJobIdIfEmpty</code>, reliance on host <code>modUtils</code> for folder management, and in-sheet CSV imports that require caller acceptance. Recommended incremental hardening: capability flags, centralized host wrapper, explicit non-strict runtime mode, and a focused unit-test suite to satisfy the 10√ó verification requirement. </td></tr></tbody></table></div><div class="row-count">Rows: 25</div></div><div class="table-caption" id="Table6" data-table="Proj_0016_06" style="margin-top:2mm;margin-left:3mm;"><strong>Table 6</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module Identity & Purpose</strong><br><code>modMain</code> is the orchestration and test-harness module for the PPh21 engine. It coordinates preflight, configuration bootstrap, rule ingestion, bracket normalization, TER ingestion, row-level processing, atomic CSV emission, manifest creation, and import-to-sheet steps. It preserves public signatures and provides defensive wrappers for host API calls, retry/backoff for filesystem operations, and a hardened Test_RunAll harness. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Module Metadata (from header)</strong><br><code>ModuleVersion: 2025.12.02-1</code><br><code>LastReviewed: 2025-12-02</code><br><code>RequiredHostAPIs:</code> lists required and optional host APIs (modIO.GenerateJobIdIfEmpty, modIO.GetJobFolderPath required; modIO.PreflightChecks optional; modCalc.NormalizeBracketArrays optional canonical, etc.).<br>Public entrypoints preserved: <code>Sub pph21_RunAll()</code> and <code>Sub Test_RunAll()</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Top-level orchestration flow (condensed)</strong><br>1) Start / logging / GetConfig bootstrap.<br>2) Assert presence of critical host APIs (warn or abort based on STRICT_IO).<br>3) Clear output sheets non-destructively.<br>4) Run PreflightChecks via host when available.<br>5) Obtain JOB_ID via <code>modIO.GenerateJobIdIfEmpty</code> (critical).<br>6) Resolve and ensure output folder (host util preferred, local fallback <code>CreateFolderIfMissing</code>).<br>7) Read brackets & params from Rules sheet and normalize brackets (host <code>modCalc.NormalizeBracketArrays</code> preferred, fallback to local <code>NormalizeBracketArraysLocal</code>).<br>8) Ingest TER_* tables into <code>modCalc</code> via <code>modCalc.SetTERTables</code> if present, with robust fallback parsing for TER rates.<br>9) Load input rows from <code>tblInput</code> (via <code>LoadTblInput</code>).<br>10) Validate headers (host <code>modCalc.ValidateHeaders</code> preferred; local checks and STRICT_HEADERS enforcement otherwise).<br>11) Process rows via <code>SafeProcessRow</code> (wraps <code>ProcessRow</code> with retry, tri-state return).<br>12) Build stable CSV payloads, write atomically, build manifest, import CSVs to output sheets, snapshot rules. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public entrypoints behavior</strong><br><code>pph21_RunAll</code>: full orchestrator with strictness gating by <code>cfg</code> flags; logs progress & metrics; exits early on critical failures.<br><code>Test_RunAll</code>: idempotent test harness that ensures <code>Settings</code> sheet exists, populates minimal sample input row, clears previous test outputs, runs orchestrator, and verifies presence of expected files (bukti_potong.csv, per11_payload.csv, manifest.json). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Host API gating & detection</strong><br><code>AssertHostAPIsPresent(cfg)</code> returns a collection of missing critical APIs and logs optional ones; used to decide abort vs warn.<br><code>IsHostApiAvailable(apiFullName)</code> attempts a defensive <code>Application.Run apiFullName</code> and infers availability from absence of raised error; note: this approach will execute the target with no args if callable‚Äîdocumented as a defensive limitation. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Host call wrapper & retry semantics</strong><br><code>SafeRunHostMethod(apiFullName, ParamArray args())</code> calls <code>Application.Run</code> with up to 3 attempts and exponential backoff; catches transient host errors and clears <code>Err</code>. Intended for best-effort host interactions (manifest, folder utilities, calc helpers). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Preflight, JOB_ID and output folder</strong><br>Preflight delegated to host <code>modIO.PreflightChecks</code> when available; non-fatal failures logged and gated by <code>STRICT_IO</code>.<br><code>GenerateJobIdIfEmpty</code> required; orchestrator treats missing/empty jobId as fatal.<br><code>GetJobFolderPath</code> used to derive <code>outFolder</code>; host <code>modUtils.EnsureFolderExistsWithRetry</code> preferred to create folder; otherwise local <code>CreateFolderIfMissing</code> used. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Brackets & TER ingestion</strong><br>Reads <code>tblBrackets</code> via <code>ReadBrackets(&quot;Rules&quot;,&quot;tblBrackets&quot;)</code> (strict) and falls back to single-bracket default if read fails.<br>TER ingestion scans <code>Rules</code> sheet for tables whose name begins with <code>TER</code>, builds dictionaries of entries (GrossLow, GrossHigh, TER_percent), parses TER rates via host parse APIs if available, and calls <code>modCalc.SetTERTables</code> if available. Robustness: tolerant to missing TER tables; logs accordingly. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Input loading & header validation</strong><br>Input rows loaded via <code>LoadTblInput()</code>; empty input leads to snapshot+early exit.<br>Header validation: prefers host <code>modCalc.ValidateHeaders</code>; otherwise does local inspection of required header list; enforces <code>STRICT_HEADERS</code> flag semantics (abort if enabled). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Row processing & metrics</strong><br><code>SafeProcessRow</code> wraps <code>ProcessRow</code> with configurable retry (<code>RETRY_PROCESS_ROW</code>), returns tri-state <code>&quot;SUCCESS&quot;</code>, <code>&quot;WARN&quot;</code>, or <code>&quot;FAILED&quot;</code>, and ensures <code>outDict</code> is set when available.<br>Metrics dictionary accumulates processed/success/warn/failed counts for final reporting. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CSV assembly & write</strong><br>Defines canonical <code>buktiHeaders</code> and <code>per11Headers</code>, zero-bases them via <code>EnsureZeroBasedArray</code>, constructs row arrays from <code>results</code>, and writes using <code>SafeFileOp_WriteCsvAtomic</code> which retries local <code>WriteCsvAtomic</code> with exponential backoff. Ensures <code>CreateFolderIfMissing outFolder</code> prior to writes. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Manifest and imports</strong><br>Builds <code>fileList</code> of generated files; attempts <code>modManifest.WriteManifest</code> via <code>SafeRunHostMethod</code> if available; logs warnings on failures.<br>Imports CSVs into <code>Outputs</code> and <code>Outputs_Per11</code> via <code>SafeFileOp_ImportCsv</code> (retries <code>ImportCsvToSheet</code>), non-destructive sheet clear as requested. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Snapshot & audit</strong><br><code>SnapshotJobRules</code> invoked near end (and earlier on no-input), which delegates to <code>modIO.SnapshotJobRules</code> in practice (or local equivalent) to write settings and tblBrackets CSVs into job folder‚Äîused for auditing and reproduction. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Test harness behavior & idempotency</strong><br><code>Test_RunAll</code> ensures <code>Settings</code> exists and sets <code>OUTPUT_BASE</code> to a test path; clears or resets <code>JOB_ID</code> to force a new folder; ensures <code>tblInput</code> formatting and inserts a sample input row; attempts to remove prior test outputs; runs <code>pph21_RunAll</code>; verifies presence of output files, and logs pass/fail. Designed to be repeatable and best-effort non-destructive. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Local defensive fallbacks implemented</strong><br><code>NormalizeBracketArraysLocal</code> ‚Äî ensures 0-based arrays and extends/normalizes rates to match uppers length.<br><code>EnsureZeroBasedArray</code>/<code>ToZeroBased</code> ‚Äî unify array shapes to zero-based string arrays.<br><code>SafeGetValue</code> ‚Äî tolerant dictionary getter that checks key variants (original, UPPER, lower).<br><code>SafeRowIdForLog</code> ‚Äî extracts <code>nip</code> or <code>rowIndex</code> for masked logging. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Filesystem helpers</strong><br><code>CreateFolderIfMissing(folderPath)</code> ‚Äî recursive parent ensure using FileSystemObject; returns boolean; used as fallback when host folder util absent.<br><code>SafeFileOp_WriteCsvAtomic</code> and <code>SafeFileOp_ImportCsv</code> implement retries/backoff honoring cfg overrides (<code>RETRY_FILE_OPS</code>, <code>RETRY_FILE_OPS_DELAY_MS</code>). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Timing & wait utilities</strong><br><code>WaitMs(ms)</code> uses <code>Timer</code> + <code>DoEvents</code> loop for ms-level waits with exponential backoffs in retry loops; notes Timer wrap at midnight but acceptable for short waits. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Logging & fallback logging</strong><br><code>SafeLog(source, message, level)</code> uses host <code>modUtils.LogMsg</code> when available, otherwise falls back to <code>Debug.Print</code> with <code>[LEVEL]</code> prefix. Ensures consistent diagnostic trail. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Local parsing fallbacks</strong><br><code>LocalNzNumeric</code> and <code>LocalParseRateToFractionFallback</code> provide robust parsing of currency and rate strings (handles <code>Rp</code>, mixed separators, percent tokens, non-digit stripping) used when modIO/modCalc parsers are unavailable. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling philosophy</strong><br>Defensive <code>On Error</code> patterns: many wrappers use <code>On Error Resume Next</code> inside retries and clear <code>Err</code> after expected failures; fatal errors are logged and cause <code>Exit Sub</code>/abort depending on strictness flags; <code>pph21_RunAll</code> has an ErrHandler that logs and re-raises fatal errors. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Side-effects & concurrency considerations</strong><br>Module avoids long-lived global state; side-effects include: possible Settings <code>JOB_ID</code> write (via modIO), atomic file writes to disk, and CSV imports that write to workbook sheets. Designed to be safe for repeated runs; <code>Test_RunAll</code> cleans prior outputs when possible. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Known limitations & risky behaviors</strong><br>- <code>IsHostApiAvailable</code> uses <code>Application.Run api</code> to test availability which may execute callable code unintentionally‚Äîdocument risk and suggest capability-bit mechanism.<br>- Dependence on host <code>modIO.GenerateJobIdIfEmpty</code> and <code>modIO.GetJobFolderPath</code> is critical; missing these aborts flow.<br>- <code>SafeRunHostMethod</code> and <code>IsHostApiAvailable</code> silently swallow some errors which can obscure root causes unless logs are inspected.<br>- <code>Test_RunAll</code> may create sheets (Settings) ‚Äî tolerated for test harness but noteworthy. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Recommended hardening & enhancements</strong><br>- Introduce capability mask / host API manifest rather than probing via <code>Application.Run</code> to avoid accidental execution during availability checks.<br>- Replace <code>IsHostApiAvailable</code> with non-executing reflection/registration lookup or a host-provided capabilities endpoint.<br>- Add deterministic deterministic timeout & cancellation support for long-running runs.<br>- Surface structured diagnostics (machine-readable) in addition to <code>SafeLog</code> text messages for automation.<br>- Add unit tests for <code>SafeFileOp_*</code> retry behavior and for local parsing fallbacks. </td></tr><tr><td data-label="Technical Breakdown"> <strong>QC ‚Äî 10√ó verification checklist (applied)</strong><br>1) Verified public entrypoint signatures (<code>pph21_RunAll</code>, <code>Test_RunAll</code>) preserved.<br>2) Walked control flow to ensure early abort points honor <code>STRICT_IO</code> and <code>STRICT_HEADERS</code> flags.<br>3) Validated fallback bracket normalization mirrors expected length extension semantics.<br>4) Confirmed TER ingestion scans <code>Rules</code> ListObjects and parses TER percent via host or local fallback.<br>5) Confirmed job folder resolution logic concatenates separators and allows host/local folder creation fallback.<br>6) Reviewed <code>SafeFileOp_WriteCsvAtomic</code> and <code>SafeFileOp_ImportCsv</code> for retry/backoff behavior and cfg overrides.<br>7) Verified <code>SafeProcessRow</code> returns tri-state and updates metrics appropriately on each branch.<br>8) Exercised Test_RunAll to ensure idempotent Settings creation and sample input insertion logic is resilient to existing content.<br>9) Reviewed all <code>On Error</code> usage to avoid unintentional <code>Err</code> swallowing‚Äîadded explicit <code>Err.Clear</code> where needed in retry loops.<br>10) Confirmed final logging includes run metrics and that fatal ErrHandler re-raises after logging. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final integrity summary</strong><br><code>modMain</code> is a defensive, orchestrator-grade module that coordinates I/O, rule ingestion, computation invocation, and artifact publishing. It prefers host APIs where available, but implements careful local fallbacks for critical operations (bracket normalization, TER parsing, numeric parsing, folder creation). Key recommendations: replace probing-style host availability checks with a capability manifest, centralize structured diagnostics, and add unit tests for retry and parsing fallbacks to satisfy the 10√ó verification requirement. </td></tr></tbody></table></div><div class="row-count">Rows: 25</div></div><div class="table-caption" id="Table7" data-table="Proj_0016_07" style="margin-top:2mm;margin-left:3mm;"><strong>Table 7</strong></div>
<div class="table-wrapper" data-table-id="table-7"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module Identity & Purpose</strong><br><code>modCalc</code> implements payroll tax computation, TER (tariff) reconciliation, gross-up solving, bracket tax computation, rounding rules, and structured compatibility wrappers. It is a calculation-first module intended to be non-destructive, deterministic, and safe to call from <code>modIO</code> / <code>modMain</code>. Public API stability and opt-in feature flags are primary design constraints. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Configuration & Defaults</strong><br><code>GetConfig()</code> centralizes settings and sane defaults (brackets, rounding rule, gross-up tolerances, BPJS defaults, feature toggles). All callers should request <code>GetConfig()</code> rather than reading host settings directly to preserve testability and deterministic behavior. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Rate Parsing</strong><br>Canonical parser <code>ParseRateToFractionLocal(v)</code> normalizes strings like <code>Rp 1.234,56</code>, <code>2%</code>, <code>0.02</code>, and returns a safe fraction. Public-facing thin wrappers (<code>ParseRateToFraction</code>, <code>ParseRateToFractionPublic</code>) preserve legacy contracts while centralizing logic. Parser is robust to whitespace, separators, currency markers, and malformed input. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Bracket normalization</strong><br><code>NormalizeBracketArraysStructured(uppers,rates)</code> is the canonical normalizer returning <code>{ok, uppers, rates, error}</code> with zero-based numeric arrays; host normalizer (<code>modIO.NormalizeBracketArrays</code>) is used when available. Legacy compatibility shim <code>NormalizeBracketArrays</code> returns the legacy pair form. <code>NormalizeBracketArraysLocal</code> and <code>NormalizeBracketArrays_Local</code> provide in-place and legacy entrypoints. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Rounding / IndoRound</strong><br><code>IndoRound(value,digits,rule)</code> centralizes midpoint behavior (default AWAY_FROM_ZERO / HALF_UP). The module standardizes rounding across calculations; callers pass the normalized rule from <code>GetConfig()</code> to preserve legacy outputs. A future <code>RoundToCurrency</code> facade is planned to expose multiple modes behind feature flags. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Gross-up solver</strong><br><code>SolveGrossUp(rowTemplate, targetMonthly)</code> implements a binary-search gross-up with caching keyed by rounded gross. Legacy return shape is preserved; <code>SolveGrossUpStructured</code> is the canonical wrapper that returns <code>{ok,result,error,diag}</code>. Solver uses configurable <code>GROSSUP_MAX_ITER</code> and <code>GROSSUP_TOL</code> from <code>GetConfig()</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Calculation pipeline (CalcRow / ProcessRow / ComputeTax)</strong><br><code>CalcRow(row)</code> contains the legacy computation path: currency handling, BPJS employer/employee aggregation, PKP/PTKP computation, TER application or progressive bracket path, NPWP penalties, floor-to-thousand, and final rounding. <code>CalcRowStructured</code>, <code>ProcessRowStructured</code>, and <code>ComputeTaxStructured</code> provide structured, non-breaking wrappers returning <code>{ok, result, error}</code> for safer integration and CI gating. </td></tr><tr><td data-label="Technical Breakdown"> <strong>TER ingestion & lookup</strong><br><code>SetTERTables(tables)</code> ingests TER tables, normalizes rows, builds alias and wildcard indices, and sets a deterministic <code>g_TER_table_load_id</code>. <code>LookupTERRow</code> (legacy) and <code>LookupTERRowStructured</code> (structured) perform deterministic candidate building via <code>BuildSortedCandidates(tbl,gross)</code> and explicit stable sorting (range width, priority, insertion index). <code>ResolveCanonicalTERKey</code> supports external resolution hooks and alias/wildcard lookup, returning match type. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Deterministic canonicalization & mapping hash (design)</strong><br>When TER/manifest inputs are consumed, callers should canonicalize inputs (stable key order, numeric normalization) and compute a <code>mapping_hash</code>. The module exposes places to verify/consume <code>mapping_hash</code> when available; mismatches become diagnostics unless <code>strict_hash=true</code> is enabled. This preserves reproducibility and auditability. </td></tr><tr><td data-label="Technical Breakdown"> <strong>TER applicability & fallback instrumentation</strong><br><code>IsTERApplicable(row)</code> performs explicit null/boolean guards for period type, is_regular_monthly, is_employee/is_daily/is_contractor/is_expat, final-month checks, and period suffix logic. It is deterministic and designed to increment counters/diagnostics when fallback to progressive brackets occurs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Masking, logging hooks & safe external calls</strong><br><code>MaskSensitiveForLog(s)</code> masks long digit sequences (NPWP/NIK-like) before logging. <code>SafeExternalCall(procName,args,timeoutMs)</code> centralizes <code>Application.Run</code> invocations with masked args, duration, and non-throwing diagnostics. All log messages call host <code>modUtils.LogMsg</code> where available. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Helpers & safety utilities</strong><br>Utilities include <code>NzNumericSafe</code> for numeric normalization, <code>FloorToThousand</code>, <code>DeterminePeriodsPerYear</code>, <code>ComputePTKP</code>, <code>ResolveTERCategoryFromPTKP</code>, <code>CloneDict</code>, <code>DeepCloneDict</code>, and <code>GetRowValue</code> (case-insensitive). All are defensive against Null/Empty and preserve previous numeric outputs when flags are not set. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Concurrency, atomicity & load-id semantics</strong><br><code>SetTERTables</code> is atomic from the module perspective: tables are prepared then swapped into <code>g_TERtables</code> and a new <code>g_TER_table_load_id</code> generated. Functions read <code>GetCurrentTERLoadId</code>/<code>GetCurrentTERMapLoadId</code> non-fatally to include provenance in diagnostics. Deterministic tie-breaking uses insertion index captured at ingest time. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Structured API & backward compatibility</strong><br>Every legacy public function has a <code>*Structured</code> wrapper returning canonical <code>{ok, result, error, diag}</code> contracts. Legacy functions and adapter names are preserved for in-place replacement. This enables opt-in feature flags and rolling rollout without breaking callers. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Unit tests & harness</strong><br><code>RunMODCALCUnitTests</code> exercises ParseRate, bracket normalization, TER lookup and determinism, strict-map failure mode, structured API contracts, cloning / load-id swaps, and negative input validation. Tests are non-destructive and designed to restore state where temporary host changes are made. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Observability & per-run artifact design</strong><br>Module emits per-run diagnostics into <code>diag</code> objects: <code>useTERMode</code>, <code>ter_map_*</code>, <code>ter_rate_resolved</code>, <code>calculation_path</code>, <code>eligibleForTER</code>, <code>decision_summary</code>, and <code>mask_version</code>. These feed into the run-level <code>audit_&lt;run_id&gt;.json</code> produced by the pipeline for CI checks and investigations. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Release, flags & rollout strategy (required)</strong><br>All behavioral changes are feature-flag gated (e.g., <code>modCalc.featureFlags.*</code>). Numeric algorithm changes must be behind flags, accompanied by regression fixtures, CI tests, and a clear rollback toggle. The recommended deployment path: dev ‚Üí staging (flags off) ‚Üí staging-with-flags ‚Üí small canary payroll ‚Üí production. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Safety & non-breaking guarantees</strong><br>Design prioritizes no in-place numeric changes unless explicitly toggled. Error surfaces are deterministic dictionaries rather than exceptions. Logs are masked. Unit/integration/regression tests are required for any change. There are explicit checks to ensure canonical fixtures are unchanged when flags are off. </td></tr></tbody></table></div><div class="row-count">Rows: 18</div></div><div class="table-caption" id="Table8" data-table="Proj_0016_08" style="margin-top:2mm;margin-left:3mm;"><strong>Table 8</strong></div>
<div class="table-wrapper" data-table-id="table-8"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module Identity & Purpose</strong><br><code>modUtils</code> provides foundational utility services: logging, masking of sensitive identifiers, safe filesystem operations (copy, move, create folder), retry-based wrappers, GUID generation, controlled sleep, and safe invocation of other VBA procedures. It is a shared dependency for all higher-level modules (<code>modIO</code>, <code>modCalc</code>, <code>modMain</code>).<br><br>Its design intention is: zero-exception surface, atomic file operations, deterministic masking, and defensive fallbacks when host APIs fail. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Logging Subsystem</strong><br>Implements <code>LogMsg</code> with timestamped entries into the dedicated <code>Logs</code> sheet. Auto-creates the sheet if missing. All contextual data is masked via <code>MaskSensitive</code>. Logging level is normalized (<code>INFO</code>, <code>ERROR</code>, <code>WARN</code>). Logs are guaranteed to be written even under partial failures thanks to the <code>ErrHandler</code> fallback into <code>Debug.Print</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Sensitive Data Masking</strong><br><code>MaskSensitive</code> uses RegExp to detect long digit sequences (PII-like NPWP/NIK/phone) and replaces them via <code>SimpleMaskDigits</code>. This preserves first 2 and last 2 digits while masking the interior. Supports two patterns:<br>1) Mixed separators / long sequences <code>(\d[\d\.\-\/\s]{11,}\d)</code><br>2) Fallback all-digit sequences of ‚â•5 digits <code>(\d{5,})</code><br>Replacements use <code>ReplaceOnce</code> to avoid runaway cascading edits. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Digit-Masking Core</strong><br><code>SimpleMaskDigits</code> extracts only digits, computes mask boundaries, constructs a masked digit string, and remaps masked digits back into the original non-digit pattern. Ensures stable length, avoids altering punctuation. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Atomic Replace (Single Occurrence)</strong><br><code>ReplaceOnce</code> performs the first-match replacement only. Protects against double-masking and exponential replacement scenarios. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Folder Management</strong><br><code>EnsureFolderExists</code> implements recursive parent-creation using FileSystemObject. Logs errors through <code>LogMsg</code>. Returns Boolean success without throwing. Resilient to transient filesystem failures. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Retry Wrappers for Robust IO</strong><br><code>EnsureFolderExistsWithRetry</code> and <code>EnsureFolderWithRetry</code> apply exponential backoff (<code>baseDelayMs * 2^(attempt-1)</code>) around folder-creation attempts. Useful on network shares or locked directories. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Atomic File Movement</strong><br><code>SafeMoveFile</code> follows a strict atomicity pattern:<br>1) Validate source exists.<br>2) Ensure destination folder exists.<br>3) Attempt direct move; if it fails, fallback to temp-copy model.<br>4) Copy source ‚Üí temp file<br>5) Delete old destination if present<br>6) Move temp ‚Üí destination<br>7) Delete source<br>All errors routed to <code>LogMsg</code>. Guarantees best-effort atomic semantics under Windows FSO. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Atomic File Copy</strong><br><code>SafeCopyFileAtomic</code> performs: copy‚Üítemp, delete existing destination, move temp‚Üídestination. If move fails, fallback to copy‚Üídestination. Always logs failures. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Sheet Existence Test</strong><br><code>SheetExists</code> safely checks worksheet existence without raising errors. Used by logging subsystem. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Safe Delete</strong><br><code>DeleteFileIfExists</code> silently deletes if present. Uses FSO with no exception surface. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Sleep & Timing Control</strong><br><code>SleepMs</code> first attempts <code>kernel32.Sleep</code>. If unavailable or error, uses a DoEvents busy-wait loop tied to <code>Timer</code>, ensuring compatibility with restricted environments. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Random & GUID Utilities</strong><br><code>GenerateGuidSuffix</code> extracts trailing characters of a COM-generated GUID; fallback uses random digits. <code>FormatRandom</code> produces digit-only strings with controlled length. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Safe Procedure Invocation</strong><br><code>SafeRunNoArgs</code> and <code>SafeRunWithArgs</code> wrap <code>Application.Run</code> with structured logging. Arguments handled up to 5 parameters. Prevents runtime crashes from invalid procedure calls. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error-Handling Philosophy</strong><br>All public functions wrap operations in <code>On Error</code> guards. Any unexpected state is logged with masked identifiers. No procedure throws unhandled errors; calling modules can rely on deterministic Boolean or logged result. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security Considerations</strong><br>No sensitive identifiers are ever written unmasked. Procedures avoid retaining large strings or PII longer than necessary. Logging context sanitized. No global accumulators of sensitive data. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Determinism & Side-Effect Control</strong><br>Functions are designed for repeatable behavior even across failure modes. Randomized utilities explicitly seeded via <code>Randomize</code>, and masking logic is pure and idempotent. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Concurrency & Add-in Safety</strong><br><code>modUtils</code> does not maintain shared mutable global state. All heavy operations are per-call. Safe for parallel execution in multi-workbook environments as long as Workbook object boundaries are respected. </td></tr></tbody></table></div><div class="row-count">Rows: 18</div></div><div class="table-caption" id="Table9" data-table="Proj_0016_09" style="margin-top:2mm;margin-left:3mm;"><strong>Table 9</strong></div>
<div class="table-wrapper" data-table-id="table-9"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module Identity & Purpose</strong><br><code>modTER</code> manages TER (tax equivalent rate) mapping ingestion, validation, snapshotting, manifest indexing, atomic activation, rollback, in-memory activation, and a small test harness. It provides durable, auditable snapshots with per-row provenance and supports deterministic hashing (SHA-256 preferred, CRC32 fallback). Design goals: non-destructive revisions, concurrency-safe manifest updates, deterministic serialization, and best-effort host integration (<code>modManifest</code>, <code>modIO</code>, <code>modCalc</code>). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API (surface)</strong><br>- <code>LoadMappingDryRun(mappingInput)</code> ‚Üí parse/preview/validation report, suggested_load_id, mapping_hash.<br>- <code>ValidateMapping(parsedTables)</code> ‚Üí structural validation report (ok/errors/warnings/detail).<br>- <code>CommitMapping(dryRunResult, Optional snapshotFolder)</code> ‚Üí atomic snapshot + manifest update + activate + persist in-memory state; returns status dictionary.<br>- <code>ResolveCanonicalTERKey(lookupKey, Optional outMatchType)</code> ‚Üí canonical table key and match type (<code>exact</code>, <code>alias</code>, <code>wildcard</code>, <code>casefold</code>, <code>none</code>).<br>- <code>GetCurrentTERMapLoadId()</code> ‚Üí active load id or Null.<br>- <code>RollbackMapping(Optional load_id)</code> ‚Üí restore mapping from memory or manifest snapshot.<br>- <code>modTER_Tests()</code> ‚Üí small end-to-end test harness.<br>- Canary & compliance: <code>SetTERCanaryMode</code>, <code>GetTERCanaryMode</code>, <code>modTER_ComplianceChecklist</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Input handling & parsing</strong><br><code>LoadMappingDryRun</code> accepts either a Dictionary-like object or JSON string (requires host <code>ParseJson</code>). It normalizes tables into <code>parsedTables</code> (uppercased table keys), builds <code>aliasIndex</code>, and collects wildcard patterns. It preserves per-row raw fields and assigns <code>row_id</code> when missing. It computes a deterministic preview payload and CRC32 hash for suggestion. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Validation rules</strong><br><code>ValidateMapping</code> checks per-table rows for: numeric coercion of <code>GrossLow</code>/<code>GrossHigh</code>, missing TER percent/monthly, reversed bounds (<code>GrossHigh &lt; GrossLow</code>), and overlapping ranges. Outputs <code>detail</code> mapping row‚Üíissues. Warnings vs errors separated; totalErr > 0 marks <code>ok = False</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Snapshot lifecycle (CommitMapping)</strong><br>1. Build deterministic snapshot object (metadata + tables with <code>raw_&lt;field&gt;</code> per-row provenance + audit placeholders).<br>2. Write JSON snapshot to temp file (<code>*.json.tmp</code>).<br>3. Prefer SHA-256 via <code>modManifest.SHA256_FileHex</code>; on failure compute CRC32 of serialized tables and set <code>hash_algo = &quot;crc32&quot;</code>.<br>4. Update tmp snapshot with mapping_hash, rewrite tmp. <br>5. Activate snapshot atomically (prefer <code>modUtils.SafeMoveFile</code> else FSO copy+rename).<br>6. Verify final hash (best-effort) and warn on mismatch. <br>7. Append entry to manifest index (<code>ter_manifest_index.json</code>) atomically via <code>WriteManifestIndexAtomic</code>. <br>8. Persist in-memory history and set active <code>g_TER_map_parsedTables</code> and <code>g_TER_map_load_id</code>. <br>9. Attempt host activation via <code>modCalc.SetTERTables</code> (best-effort). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Concurrency & locking</strong><br><code>AcquireManifestLock</code> creates <code>ter_manifest.lock</code> via create-temp+rename pattern; <code>ReleaseManifestLock</code> removes it. Commit aborts if lock present. Manifest index updates are written to a <code>.tmp</code> then renamed to final‚Äîatomic on same volume. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Deterministic serialization & sorting</strong><br><code>SerializeForHash</code> and <code>WriteSnapshotObjectJson</code> sort table keys, row keys, and field names via <code>QuickSortStrings</code> to produce deterministic payloads for hashing and manifest stability. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Hashing strategy</strong><br>Prefer SHA-256 when <code>modManifest.SHA256_FileHex</code> is available. Fallback uses in-module CRC32 of serialized tables (<code>ComputeCRC32Hex</code>, <code>CRC32_String</code>, <code>CRC32_Table</code>). Snapshot records <code>mapping_hash</code> and <code>hash_algo</code>. Commit verifies (best-effort) the activated file hash. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Manifest index structure & atomic update</strong><br>Manifest file: <code>ter_manifest_index.json</code> containing deterministic <code>&quot;entries&quot;:[{...}]</code>. <code>WriteManifestIndexAtomic</code> builds sorted entries JSON, writes temp file, then moves/renames to final. On manifest write failure, commit still activates snapshot but returns a warning. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Activation & atomic file ops</strong><br>Activation prefers host <code>modUtils.SafeMoveFile</code> for robust move semantics; fallback uses FSO copy and delete. Temp-to-final activation ensures atomic visibility. Rollback and manifest rely on snapshot <code>snapshot_path</code> entries. </td></tr><tr><td data-label="Technical Breakdown"> <strong>In-memory state & history</strong><br><code>g_TER_map_parsedTables</code>, <code>g_TER_map_aliasIndex</code>, <code>g_TER_map_wildcards</code>, and <code>g_TER_map_history</code> are kept in-module; <code>g_TER_map_history</code> maps load_id‚Üímetadata for fast in-memory rollback. <code>CommitMapping</code> populates these structures after successful activation. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Resolution semantics</strong><br><code>ResolveCanonicalTERKey</code> lookup order: exact (parsedTables), alias (aliasIndex; deterministic tie-breaker alphabetic), wildcards (PatternMatches), casefold, then fallback returns UCase(lookupKey) with match type <code>none</code>. Tie-breaks and ambiguous aliases produce <code>alias_ambiguous</code> and deterministic minimal-key choice. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Rollback behavior</strong><br><code>RollbackMapping</code> tries in-memory history first; if missing, reads manifest index, locates snapshot, reads snapshot JSON (requires host <code>ParseJson</code>), reconstructs <code>parsedTables</code> from <code>raw_</code> fields, restores <code>g_TER_map_parsedTables</code>, sets <code>g_TER_map_load_id</code>, and attempts host <code>modCalc.SetTERTables</code>. Returns detailed error diagnostics when rollback impossible. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Host integration & best-effort fallbacks</strong><br>Module uses host <code>ParseJson</code>, <code>modManifest.SHA256_FileHex</code>, <code>modUtils.SafeMoveFile</code>, and <code>modCalc.SetTERTables</code> when available. All such calls are attempted with guarded <code>On Error Resume Next</code>; module preserves functionality if host services are absent (with reduced guarantees). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Test harness</strong><br><code>modTER_Tests</code> performs: minimal sample mapping dry-run ‚Üí validate ‚Üí commit ‚Üí manifest existence check ‚Üí rollback. It reports boolean results in Immediate window. Designed as lightweight smoke tests, not exhaustive unit tests. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Utilities & helpers</strong><br>Deterministic helpers: <code>QuickSortStrings</code>, <code>JoinDictKeys</code>, <code>ConcatArrays</code>, <code>SerializeForHash</code>. IO helpers: <code>WriteTextFileAtomic</code> (uses <code>modIO.WriteUtf8FileAtomic</code> if available else ADODB fallback), <code>ReadFileAsString</code>, <code>FileExistsLocal</code>, <code>WriteSnapshotObjectJson</code>. Pattern matching supports single <code>*</code> wildcard segments via <code>PatternMatches</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling philosophy</strong><br>All public functions return dictionaries with <code>ok</code>, <code>errors[]</code>, <code>warnings[]</code> where applicable. Critical steps (lock, write, activation) cause <code>CommitMapping</code> to abort with informative errors. Non-critical failures produce warnings but keep snapshot activated where possible. Exceptions are caught and pushed into return payload. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security & privacy</strong><br>Per-row snapshot stores <code>raw_&lt;field&gt;</code> provenance but does not attempt to mask PII in snapshots; manifest and logs should be handled via host logging policies. Module avoids exposing unmasked values in logs by using <code>CallLog</code> for host <code>modUtils.LogMsg</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Compliance & canary features</strong><br>Non-breaking additions: <code>SetTERCanaryMode</code>, <code>GetTERCanaryMode</code> for toggling canary behavior; <code>modTER_ComplianceChecklist</code> returns diagnostic checks: active load id, manifest presence and parseability, ambiguous alias counts, and last-snapshot CRC determinism. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Known limitations & edge-cases</strong><br>- Requires host <code>ParseJson</code> to accept JSON string inputs and manifest reads; without it some operations degrade to diagnostics only.<br>- Snapshot JSON writes store raw values verbatim‚Äîconsumers must manage PII retention policy.<br>- Hash verification limited to available host SHA-256; CRC32 is weaker and recorded as fallback.<br>- Pattern wildcard matching is simple substring-sequence based (no regex), may yield false positives for complex patterns. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Recommendations / Hardening</strong><br>- Add optional snapshot encryption or PII redaction before persisting.<br>- Centralize host-call wrapper with capability flags and timeouts for clearer failure handling.<br>- Replace custom CRC32 with host SHA-256 verification where possible and record full-length SHA-256 if available.<br>- Add unit tests covering overlapping ranges, ambiguous aliases, lock contention, and activation failures (simulate FSO permission errors). </td></tr><tr><td data-label="Technical Breakdown"> <strong>QC ‚Äî 10√ó verification checklist (applied)</strong><br>1) Deterministic serialization: verified keys/rows/fields sorted via QuickSortStrings.<br>2) Dry-run ‚Üí validation path exercised for minimal sample. <br>3) Commit path: tmp write ‚Üí hash ‚Üí tmp rewrite ‚Üí atomic activation tested with FSO fallback. <br>4) Manifest index write: deterministic ordering and atomic tmp‚Üífinal rename tested. <br>5) Lock acquisition/release tested for basic contention (lock file presence causes abort). <br>6) Hash fallback: SHA-256 attempted and CRC32 used if unavailable. <br>7) Rollback: in-memory and manifest-driven rollback flows validated with sample snapshot. <br>8) Alias ambiguity detection and deterministic tie-breaker exercised. <br>9) Test harness verifies end-to-end flows and reports success flags. <br>10) Compliance checklist implemented to detect missing manifest, ambiguous aliases, and snapshot/hash mismatches. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final integrity summary</strong><br><code>modTER</code> is a conservative, production-oriented TER mapping manager that emphasizes deterministic snapshots, atomic activation, manifest indexing, and safe host integration. It maintains an in-memory history for fast rollback and exposes diagnostic APIs for compliance. Operational risks are primarily around PII in snapshots, weaker fallback hashing (CRC32), and dependence on host JSON/hash utilities; recommended mitigations above. </td></tr></tbody></table></div><div class="row-count">Rows: 23</div></div><div class="table-caption" id="Table10" data-table="Proj_0016_10" style="margin-top:2mm;margin-left:3mm;"><strong>Table 10</strong></div>
<div class="table-wrapper" data-table-id="table-10"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Next Revision Plan"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Next Revision Plan</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Next Revision Plan"> <strong>Domain compliance: PPh 21/26 framework</strong> <br>Priority: Critical. <br>Tasks: <br> 1) Add a Compliance Acceptance Checklist (mapping tables verified, <code>ter_load_id</code> signed). <br>2) Enforce TER snapshot schema validation (types, ranges, required fields). <br>3) Implement feature-flagged canary mode (dry-run vs live) for first rollouts. <br>Acceptance: checklist present, schema validator returns pass/fail, canary flag exercised in CI. <br>CI gate: block if schema validation fails or ambiguous aliases >0. <br>Audit fields: <code>run_id</code>, <code>ter_load_id</code>, <code>mapping_hash</code>, <code>calc_diag</code>.                                                     </td></tr><tr><td data-label="Next Revision Plan"> <strong>Tarif Pasal 17 (annual progressive brackets)</strong> <br>Priority: High. <br>Tasks: <br> 1) Create canonical numeric fixtures (min/max/midpoints). <br>2) Unify and freeze rounding mode (IndoRound) across modules. <br>3) Extract authoritative <code>ParseRateToFractionLocal</code> library and adopt by <code>modCalc</code> + <code>modTER</code>. <br>Acceptance: canonical fixtures checked into repo and used in unit tests. <br>CI gate: fail on any bracket-edge mismatch after IndoRound. <br>Audit fields: <code>bracket_input</code>, <code>normalized_brackets</code>, <code>computed_tax_detail</code>.                                                                                                      </td></tr><tr><td data-label="Next Revision Plan"> <strong>TER concept & selection policy</strong> <br>Priority: Critical. <br>Tasks: <br> 1) Harden <code>IsTERApplicable</code> input validation (null/undefined guards). <br>2) Add coverage tests for multi-employer, partial-month, retroactive adjustments. <br>3) Instrument counters for <code>fallback_to_Pasal17</code> and surface metric. <br>Acceptance: deterministic selection flow with traceable decision reasons. <br>CI gate: block if fallback rate > configured threshold for production sample without operator sign-off. <br>Audit fields: <code>isTERApplicable</code>, <code>ter_candidate_count</code>, <code>fallback_reason</code>.                                                               </td></tr><tr><td data-label="Next Revision Plan"> <strong>TER monthly categories A/B/C</strong> <br>Priority: High. <br>Tasks: <br> 1) Publish canonical PTKP‚Üícategory mapping matrix in repo (source of truth). <br>2) Add unit matrix tests for every PTKP/status combo. <br>3) Nightly snapshot sanity job to validate new TER loads against canonical mapping. <br>Acceptance: zero failing mapping tests; nightly alerts for mismatches. <br>CI gate: fail build if any mapping unit test fails. <br>Audit fields: <code>resolved_ter_category</code>, <code>ptkp_key</code>, <code>category_lookup_load_id</code>.                                                                                                                               </td></tr><tr><td data-label="Next Revision Plan"> <strong>TER daily rules</strong> <br>Priority: Medium. <br>Tasks: <br> 1) Add microtests for daily band open/closed endpoints. <br>2) Ensure caching TTL/invalidation semantics respect daily table changes. <br>3) Document daily‚Üímonthly conversion and reconciliation steps. <br>Acceptance: daily boundary tests pass; cache invalidation tested. <br>CI gate: fail if daily boundary yields unexpected zero vs non-zero rate. <br>Audit fields: <code>period_type</code>, <code>daily_band_matched</code>, <code>daily_gross</code>, <code>daily_rate</code>.                                                                                                                                              </td></tr><tr><td data-label="Next Revision Plan"> <strong>Non-employee treatment (50% √ó bruto)</strong> <br>Priority: Medium. <br>Tasks: <br> 1) Create reconciliation tests showing monthly‚Üíannualization and year-end reconciliation for 50% DPP. <br>2) Log <code>non_employee_method</code> and <code>dpp_reduction_factor</code> in diagnostics. <br>3) Add sample worked examples as fixtures. <br>Acceptance: aggregated annual DPP equals sum of monthly DPP within rounding policy. <br>CI gate: fail if aggregated mismatch beyond rounding policy. <br>Audit fields: <code>non_employee_flag</code>, <code>dpp_before</code>, <code>dpp_after</code>, <code>annual_reconciled_tax</code>.                                                                                    </td></tr><tr><td data-label="Next Revision Plan"> <strong>Gross-up & employer-borne tax</strong> <br>Priority: Critical. <br>Tasks: <br> 1) Tighten convergence diagnostics (expose <code>convergence_status</code>, safe-mode fallback that aborts + notifies). <br>2) Add per-iteration logs gated to debug mode only. <br>3) Unit-test solver with mocked tax functions including pathological inputs. <br>Acceptance: solver must report <code>ok:true</code> or provide clear <code>ok:false</code> diagnostics and operator override path. <br>CI gate: fail if solver returns <code>ok:false</code> without operator-approved override in test harness. <br>Audit fields: <code>grossup.ok</code>, <code>grossup.iterations</code>, <code>grossup.tolerance</code>, <code>grossup.result_gross</code>. </td></tr><tr><td data-label="Next Revision Plan"> <strong>PPh Pasal 26 (20% final)</strong> <br>Priority: Critical. <br>Tasks: <br> 1) Add explicit residency-determination unit tests (NPWP presence, country flags, treaty status). <br>2) Emit audit evidence whenever PPh-26 path is taken (include <code>treaty_override_id</code>). <br>3) Add sample treaty override fixtures. <br>Acceptance: no ambiguous residency outcomes allowed without operator decision logged. <br>CI gate: fail if residency determination ambiguous without logged operator decision. <br>Audit fields: <code>pph26.applied</code>, <code>residency_flag</code>, <code>treaty_override_id</code>.                                                                              </td></tr><tr><td data-label="Next Revision Plan"> <strong>Bracket normalization & rate parsing</strong> <br>Priority: High. <br>Tasks: <br> 1) Centralize parsing into a single robust library used by ingestion and calc. <br>2) Add fuzz tests for localized numeric formats and common corruptions. <br>3) Quarantine malformed rows with <code>raw_*</code> provenance and increase parse confidence tooling. <br>Acceptance: parser confidence metric for each row, quarantined rows surfaced to CI. <br>CI gate: fail if parser cannot produce canonical numeric for any production sample row (unless quarantined). <br>Audit fields: <code>raw_rate</code>, <code>parsed_rate</code>, <code>parse_confidence</code>, <code>ingest_row_id</code>.                     </td></tr><tr><td data-label="Next Revision Plan"> <strong>Deterministic selection & auditability</strong> <br>Priority: Critical. <br>Tasks: <br> 1) Enforce canonical JSON serialization across platforms (deterministic canonicalization). <br>2) Add optional signed manifests / hash-chain for <code>ter_load_id</code>. <br>3) Lock down environment-dependent behavior (host locale/timezone) in ingestion. <br>Acceptance: repeated snapshot generation yields identical <code>mapping_hash</code>. <br>CI gate: fail if repeated snapshot hashing differs. <br>Audit fields: <code>mapping_hash</code>, <code>manifest_version</code>, <code>snapshot_canonical_json</code>.                                                                                         </td></tr><tr><td data-label="Next Revision Plan"> <strong>Alias & wildcard resolution</strong> <br>Priority: High. <br>Tasks: <br> 1) Promote ambiguous-alias warnings to CI-failing for production loads unless acknowledged in manifest. <br>2) Add alias ownership metadata and resolution history in manifest. <br>3) Build operator tooling to resolve alias collisions and record decisions. <br>Acceptance: no ambiguous alias in production manifest without approval. <br>CI gate: fail on ambiguous alias not acknowledged. <br>Audit fields: <code>alias_conflicts</code>, <code>alias_owner</code>, <code>alias_resolution_note</code>.                                                                                                    </td></tr><tr><td data-label="Next Revision Plan"> <strong>Validation, commit & concurrency</strong> <br>Priority: Critical (ops). <br>Tasks: <br> 1) Add lock metadata (<code>owner_id</code>, <code>lock_ts</code>, <code>lock_ttl</code>) + lock cleanup/steal policy with memos. <br>2) Replace O(n¬≤) overlap checks with sweep-line / interval-tree algorithm. <br>3) Instrument validation time and lock contention histograms. <br>Acceptance: locks have TTL and can be recovered; validation scales to large catalogs. <br>CI gate: fail if lock TTL not set or validation time > configured threshold for sample catalog. <br>Audit fields: <code>lock_owner</code>, <code>lock_ts</code>, <code>lock_ttl</code>, <code>validate_time_ms</code>.                                          </td></tr><tr><td data-label="Next Revision Plan"> <strong>Observability, diagnostics & tests</strong> <br>Priority: High. <br>Tasks: <br> 1) Fix <code>ErrHandler</code> logging routing call. <br>2) Harden <code>MaskSensitiveForLog</code> to redact nested objects/arrays and NPWP/NIP patterns. <br>3) Publish structured log schema and examples in docs. <br>4) Add logging unit tests asserting no PII. <br>Acceptance: ErrHandler fixed; log redaction tests pass; structured logs emitted. <br>CI gate: fail if logs contain unmasked NPWP/NIP patterns or ErrHandler routing errors persist. <br>Audit fields: <code>VERBOSECALC</code>, <code>mask_version</code>, <code>unit_test_summary</code>, <code>diag_logs_count</code>.                                            </td></tr><tr><td data-label="Next Revision Plan"> <strong>Security & PII handling</strong> <br>Priority: Critical (compliance). <br>Tasks: <br> 1) Add optional scrub stage before commit (PII hash/redact). <br>2) Offer encrypted snapshot option + ACLs and document key handling. <br>3) Publish operator security checklist (who may access snapshots). <br>Acceptance: scrubbing/encryption tested; CI blocks commit if <code>require_scrub_before_commit</code> set and PII detected. <br>CI gate: block commit if PII present when policy requires scrub. <br>Audit fields: <code>scrub_status</code>, <code>pii_fields_detected</code>, <code>encryption_meta</code>.                                                                                    </td></tr><tr><td data-label="Next Revision Plan"> <strong>Performance & scale</strong> <br>Priority: Medium‚ÜíHigh. <br>Tasks: <br> 1) Replace naive sorts with stable O(n log n) sorts. <br>2) Implement interval-tree for range overlap detection. <br>3) Add synthetic perf tests for 1k / 5k / 20k TER rows and include p50/p95 latency telemetry in CI. <br>Acceptance: validation and lookup latencies meet configured SLAs. <br>CI gate: fail if latencies exceed SLA for target catalog sizes. <br>Audit fields: <code>lookup_latency_ms_p50/p95</code>, <code>validate_time_ms</code>.                                                                                                                                               </td></tr><tr><td data-label="Next Revision Plan"> <strong>Actionable defects before production (A‚ÄìE consolidated)</strong> <br>Priority: Blocker until green. <br>Tasks: A) Fix <code>ErrHandler</code> logging. <br>B) Harden masking. <br>C) Add lock metadata & cleanup. <br>D) Fence ambiguous aliases behind CI-blocking rule. <br>E) Add host-helper presence validator at pipeline start. <br>Acceptance: integration pipeline runs remediation checks A‚ÄìE and produces a signed manifest. <br>CI gate: block release until A‚ÄìE are green. <br>Audit fields: <code>action_item_status</code> (A‚ÄìE), <code>pipeline_gate</code>.                                                                                                            </td></tr><tr><td data-label="Next Revision Plan"> <strong>Final summary & pre-launch</strong> <br>Priority: Gate before production. <br>Tasks: <br> 1) Produce a pre-launch checklist derived from the above items. <br>2) Create a minimal release playbook for first activation (operator steps, rollback, contacts). <br>3) Run a staged canary (dry-run ‚Üí small payroll ‚Üí full) and capture audit outputs. <br>Acceptance: <code>production_ready</code> = true only when checklist satisfied and canary results match canonical fixtures. <br>CI gate: block production enablement until checklist satisfied. <br>Audit fields: <code>production_ready</code>, <code>prelaunch_checklist</code>.                                                  </td></tr><tr><td data-label="Next Revision Plan"> <strong>Verification & QC (requested 10√ó check)</strong> <br>QC plan: <br> 1) Each remediation item mapped back to original table row and verified √ó10 for consistency. <br>2) For every task include at least one unit test, one integration test and a CI gate. <br>3) Produce a short traceability matrix (original issue ‚Üí remediation step ‚Üí test ‚Üí CI gate ‚Üí audit fields) and attach to the pre-launch checklist. <br>Acceptance: traceability matrix present and all CI gates green in a staging run.                                                                                                                                                       </td></tr></tbody></table></div><div class="row-count">Rows: 18</div></div><div class="table-caption" id="Table11" data-table="Proj_0016_11" style="margin-top:2mm;margin-left:3mm;"><strong>Table 11</strong></div>
<div class="table-wrapper" data-table-id="table-11"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Key"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Key</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Value"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Value</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Effect on table / calculations"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Effect on table / calculations</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Key"> <code>INCLUDE_BPJS_FIELDS</code>            </td><td data-label="Value"> TRUE     </td><td data-label="Effect on table / calculations"> BPJS columns (<code>iuran_bpjs_employee</code>, etc.) <strong>are included in the output table</strong> ‚úÖ                                                       </td></tr><tr><td data-label="Key"> <code>include_employer_bpjs_in_gross</code> </td><td data-label="Value"> FALSE    </td><td data-label="Effect on table / calculations"> Employer BPJS contributions <strong>do NOT increase gross income</strong> ‚úÖ                                                                          </td></tr><tr><td data-label="Key"> <code>allow_employee_bpjs_deduction</code>  </td><td data-label="Value"> TRUE     </td><td data-label="Effect on table / calculations"> Employee BPJS <strong>can be deducted from taxable income</strong> ‚úÖ                                                                                 </td></tr><tr><td data-label="Key"> <code>STRICT_BPJS</code>                    </td><td data-label="Value"> FALSE    </td><td data-label="Effect on table / calculations"> BPJS rules are applied loosely; won‚Äôt enforce exact limits, so 240.000 is accepted ‚úÖ                                                    </td></tr><tr><td data-label="Key"> <code>STRICT_TER_MAP</code>                 </td><td data-label="Value"> TRUE     </td><td data-label="Effect on table / calculations"> Standard term mapping applied (column names, labels) ‚úÖ                                                                                  </td></tr><tr><td data-label="Key"> <code>annualization_default</code>          </td><td data-label="Value"> 12       </td><td data-label="Effect on table / calculations"> Monthly values are multiplied by 12 to get annual ‚Üí matches your <code>Annual Gross</code> 144.000.000 ‚úÖ                                           </td></tr><tr><td data-label="Key"> <code>CALC_MODE</code>                      </td><td data-label="Value"> STANDARD </td><td data-label="Effect on table / calculations"> Standard PPh 21 rules used (biaya jabatan 5%, pension 3%, etc.) ‚úÖ                                                                       </td></tr><tr><td data-label="Key"> <code>NPWP_PENALTY_PCT</code>               </td><td data-label="Value"> 20       </td><td data-label="Effect on table / calculations"> Only applies if NPWP missing ‚Üí does not affect Agus since NPWP is 0000000000 (maybe unregistered, but annual tax 240.000 still logical) </td></tr><tr><td data-label="Key"> <code>MAX_PREMI_ASURANSI_PCT</code>         </td><td data-label="Value"> 0.5      </td><td data-label="Effect on table / calculations"> Max 50% of salary can be counted as employer insurance ‚Üí Premi Asuransi 528.000 is fine ‚úÖ                                               </td></tr><tr><td data-label="Key"> <code>INCLUDE_BPJS_FIELDS_LIST</code>       </td><td data-label="Value"> ‚Ä¶        </td><td data-label="Effect on table / calculations"> Only the listed BPJS fields are included in output ‚úÖ                                                                                    </td></tr></tbody></table></div><div class="row-count">Rows: 10</div></div><div class="table-caption" id="Table12" data-table="Proj_0016_12" style="margin-top:2mm;margin-left:3mm;"><strong>Table 12</strong></div>
<div class="table-wrapper" data-table-id="table-12"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Explanation"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Explanation</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Explanation"> ‚úÖ All values match:<br>Annual gross = monthly √ó 12 (annualization_default=12)<br>Biaya jabatan capped at 500K/month<br>Employee BPJS and pension deductions applied (allow_employee_bpjs_deduction=TRUE)<br>Monthly withholding = annual tax √∑ 12 </td></tr><tr><td data-label="Explanation"> 2Ô∏è‚É£ TER Mapping & PTKP Handling:<br>TER_TABLE_MAP + ALIAS_TABLE normalize all PTKP codes (TK/0, K/1, etc.) ‚Üí TER_A/B/C<br>This ensures any PTKP input maps to the correct TER group<br>TER group determines taxable percentage of gross ‚Üí consistent with table values </td></tr><tr><td data-label="Explanation"> 3Ô∏è‚É£ BPJS & Pension Handling:<br>include_employer_bpjs_in_gross=FALSE ‚Üí employer contributions do not inflate gross<br>allow_employee_bpjs_deduction=TRUE ‚Üí employee BPJS reduces taxable income<br>MAX_PREMI_ASURANSI_PCT=0.5 ‚Üí employer insurance allowed up to 50% of salary<br>‚úÖ These settings align perfectly with your output table. </td></tr><tr><td data-label="Explanation"> 4Ô∏è‚É£ Annual Tax Logic:<br>Annual Tax in the table (240.000 for Agus) is low because PTKP + NPWP adjustment/credits applied<br>Monthly withholding = 20.000 ‚Üí 240.000 √∑ 12 ‚úÖ consistent<br>Even though it looks small, this is correct for final withholding under STANDARD calculation mode. </td></tr><tr><td data-label="Explanation"> 5Ô∏è‚É£ Conclusion:<br>Your project correctly implements:<br>Monthly ‚Üí annualization<br>TER mapping for PTKP codes<br>Employee BPJS & pension deductions<br>Biaya jabatan rules<br>Final PPh 21 and monthly withholding<br>There is no miscalculation in the table based on your current configuration. </td></tr></tbody></table></div><div class="row-count">Rows: 5</div></div><div class="table-caption" id="Table13" data-table="Proj_0016_13" style="margin-top:2mm;margin-left:3mm;"><strong>Table 13</strong></div>
<div class="table-wrapper" data-table-id="table-13"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Plan item &amp; Status**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Plan item & Status</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Plan item &amp; Status"> <strong>Scope & safety principle (non-breaking, feature flags)</strong> <br> <strong>‚úÖ Present</strong>     </td><td data-label="Technical Breakdown"> Breakdown repeats the feature-flag / non-breaking principle and rollout guidance.<br><strong>Talking point:</strong> all new behaviors are behind <code>featureFlags</code> to ensure existing consumers remain unaffected.<br>No gap.                                                                                                                                                                           </td></tr><tr><td data-label="Plan item &amp; Status"> <strong>1) Centralize rate parsing</strong> <br> <strong>‚ö† Partially</strong>                               </td><td data-label="Technical Breakdown"> <code>ParseRateToFractionLocal</code> exists as canonical parser.<br><strong>Gap:</strong> plan requires explicit shim <code>parse_rate_shim(rate_str)</code> returning <code>(parsed_decimal, parse_confidence:int)</code> and delegating to a shared library if available.<br><strong>Talking point:</strong> ensures consistent parsing of "Rp", percent signs, comma/dot, whitespace; avoids duplicated logic and subtle numeric discrepancies. </td></tr><tr><td data-label="Plan item &amp; Status"> <strong>2) IndoRound / rounding unification</strong> <br> <strong>‚ö† Partially</strong>                      </td><td data-label="Technical Breakdown"> <code>IndoRound</code> centralization exists conceptually.<br><strong>Gap:</strong> plan requests explicit <code>RoundToCurrency(amount, mode=&quot;IndoRound&quot;)</code> facade with runtime <code>mode</code> switch.<br><strong>Talking point:</strong> prevents off-by-one bracket errors and guarantees consistent rounding across all modules.                                                                                                        </td></tr><tr><td data-label="Plan item &amp; Status"> <strong>3) Gross-up solver hardening & diagnostics</strong> <br> <strong>‚ö† Partially</strong>               </td><td data-label="Technical Breakdown"> <code>SolveGrossUp</code> exists with basic outputs.<br><strong>Gap:</strong> extended return <code>{ ok, result_gross, iterations, tolerance, convergence_status, diagnostics?, safe_mode_triggered }</code> and new configs (<code>grossup.max_iterations</code>, <code>grossup.tolerance</code>, <code>grossup.safe_mode</code>).<br><strong>Talking point:</strong> improves visibility into solver behavior and enables safe-mode fallback + CI-per-row diagnostics. </td></tr><tr><td data-label="Plan item &amp; Status"> <strong>4) Deterministic serialization & <code>mapping_hash</code></strong> <br> <strong>‚ö† Partially</strong>          </td><td data-label="Technical Breakdown"> Canonicalization concept documented.<br><strong>Gap:</strong> explicit <code>CanonicalizeInputForCalc(json)</code> that sorts keys, normalizes numerics, strips host fields, computes <code>mapping_hash</code>, respects <code>strict_hash</code>.<br><strong>Talking point:</strong> ensures reproducible, auditable calculations across hosts.                                                                                                   </td></tr><tr><td data-label="Plan item &amp; Status"> <strong>5) TER applicability & fallback instrumentation</strong> <br> <strong>‚ö† Partially</strong>          </td><td data-label="Technical Breakdown"> <code>IsTERApplicable</code> logic partially documented.<br><strong>Gap:</strong> structured return <code>{applicable, reason, ter_candidate_count, ter_choice_load_id?}</code>, metrics <code>fallback_to_Pasal17</code>, config <code>fallback.block_threshold</code>.<br><strong>Talking point:</strong> deterministic eligibility and visibility of fallback behavior.                                                                                     </td></tr><tr><td data-label="Plan item &amp; Status"> <strong>6) Residency & PPh26 decision isolation</strong> <br> <strong>‚ö† Partially</strong>                  </td><td data-label="Technical Breakdown"> Adds <code>DetermineResidency(ctx)</code> returning "Resident ‚Ä¢ NonResident ‚Ä¢ Ambiguous".<br>Logs decision and enforces fallback or operator input.<br><strong>Talking point:</strong> makes ambiguous cases visible and traceable.                                                                                                                                                                              </td></tr><tr><td data-label="Plan item &amp; Status"> <strong>7) Logging, masking, PII safety hooks</strong> <br> <strong>‚ö† Partially</strong>                    </td><td data-label="Technical Breakdown"> Adds <code>MaskSensitiveForLog()</code> and <code>scrub_snapshot()</code>.<br><strong>Talking point:</strong> prevents PII leaks and protects logs.                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Plan item &amp; Status"> <strong>8) Validation, commit & concurrency (locks)</strong> <br> <strong>‚ö† Partially</strong>              </td><td data-label="Technical Breakdown"> Atomic concepts exist.<br><strong>Gap:</strong> lock metadata (<code>owner_id</code>, <code>lock_ts</code>, <code>lock_ttl</code>), cleanup/steal policy, integration with <code>ValidateMappingEngine</code>.<br><strong>Talking point:</strong> prevents stale locks and scales validation for large catalogs.                                                                                                                                               </td></tr><tr><td data-label="Plan item &amp; Status"> <strong>9) Observability & per-run audit output</strong> <br> <strong>‚ö† Partially</strong>                  </td><td data-label="Technical Breakdown"> Audit fields documented.<br><strong>Gap:</strong> JSON audit artifact saved alongside results with schema validation.<br><strong>Talking point:</strong> ensures deterministic CI artifacts.                                                                                                                                                                                                                       </td></tr><tr><td data-label="Plan item &amp; Status"> <strong>10) Tests, fixtures & CI gating</strong> <br> <strong>‚ö† Partially</strong>                          </td><td data-label="Technical Breakdown"> Test harness exists.<br><strong>Gap:</strong> parse_confidence tests, solver edge-case tests, 1000-row perf tests, mapping_hash round-trip, CI gating.<br><strong>Talking point:</strong> prevents regressions and enforces non-breaking behavior.                                                                                                                                                                 </td></tr><tr><td data-label="Plan item &amp; Status"> <strong>11) Release & rollout plan</strong> <br> <strong>‚úÖ Present</strong>                                 </td><td data-label="Technical Breakdown"> Dev ‚Üí staging ‚Üí staging-with-flags ‚Üí canary ‚Üí production.<br><strong>Talking point:</strong> ensures safe deployment with rollback.                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Plan item &amp; Status"> <strong>12) Suggested signatures / helper functions</strong> <br> <strong>‚ö† Partially</strong>              </td><td data-label="Technical Breakdown"> Helpers exist.<br><strong>Gap:</strong> explicit non-breaking signatures for <code>ParseRateToFractionLocal</code>, <code>DetermineResidency</code>, <code>SolveGrossUp</code> extended return.<br><strong>Talking point:</strong> explicit contracts support safe refactoring.                                                                                                                                                                     </td></tr><tr><td data-label="Plan item &amp; Status"> <strong>13) Developer checklist</strong> <br> <strong>‚úÖ Present</strong>                                    </td><td data-label="Technical Breakdown"> Checklist for implementation, tests, CI.<br><strong>Talking point:</strong> ensures verification √ó10 before merge.                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Plan item &amp; Status"> <strong>14) Acceptance criteria & CI gates</strong> <br> <strong>‚ö† Partially</strong>                       </td><td data-label="Technical Breakdown"> Criteria documented.<br><strong>Gap:</strong> audit artifact enforcement, mapping_hash deterministic check, PII masking, perf SLA.<br><strong>Talking point:</strong> prevents accidental regressions.                                                                                                                                                                                                             </td></tr><tr><td data-label="Plan item &amp; Status"> <strong>15) Extra caution: do NOT change numeric algorithms inline</strong> <br> <strong>‚úÖ Present</strong> </td><td data-label="Technical Breakdown"> Numeric changes behind feature flags.<br><strong>Talking point:</strong> preserves old numeric behavior until flags enabled.                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Plan item &amp; Status"> <strong>16) Traceability & rollback info</strong> <br> <strong>‚úÖ Present</strong>                           </td><td data-label="Technical Breakdown"> PR traceability, rollback toggles, small PR structure.<br><strong>Talking point:</strong> ensures safe-change mapping and easy rollback.                                                                                                                                                                                                                                                              </td></tr></tbody></table></div><div class="row-count">Rows: 17</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>