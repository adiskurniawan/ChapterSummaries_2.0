<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1767518032">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0165_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **User Guide PPh 21 Yearly (Final Period)**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>User Guide PPh 21 Yearly (Final Period)</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Overview / Purpose</strong><br>Comprehensive technical manual for the Ortax “PPh 21 Yearly (final period)” calculator and companion Excel workbook.<br>Purpose: provide a single authoritative reference that documents every data field, unit convention, required inputs, calculation flow, transformation rules (monthly ↔ annual), validation policy, rounding and precision rules, gross-up algorithm specification (conceptual), integration mapping, QA test cases, performance guidance, security & privacy controls, versioning/change management, and handover deliverables for payroll engineers, accountants, and developers integrating payroll systems with Ortax. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Canonical data model & sheet names</strong><br>Define canonical sheets: <code>employee_information</code>, <code>tax_calculation_method</code>, <code>income_components</code>, <code>deductions</code>, <code>tax_results</code>, <code>tax_rates</code>, <code>ptkp_table</code>, <code>metadata</code>, <code>qa</code>, <code>doc_md</code>, <code>reporting</code>, <code>changelog</code>.<br>Requirement: each sheet must include a header row and be converted to an Excel Table with a <code>tbl_</code> prefix for structured references (e.g., <code>tbl_employee_information</code>). Document sheet purpose and required columns in <code>metadata</code>. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Primary key & identity rules</strong><br><code>employee_id</code> is the single canonical primary key used for joins across sheets.<br>Use Text type for <code>employee_id</code> to preserve formatting and leading zeros. Enforce uniqueness; flag duplicates during import. When exchanging CSV, enforce <code>employee_id</code> as a quoted string or explicit text column to prevent numeric conversion. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Monetary conventions & units</strong><br>Currency: Indonesian Rupiah (IDR). Unit: integer rupiah — no decimals. All monetary fields stored as numeric Excel values and formatted using Accounting/IDR for human readability.<br>Conventions: label each column header with unit annotation (e.g., “(monthly)” or “(annual)” or “(YTD)”) so data consumers and importers observe consistent units. Document chosen annualization behavior in <code>metadata</code>. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>employee_information (sheet) - purpose & columns</strong><br>Sheet name: <code>employee_information</code>.<br>Required columns: <code>employee_id</code>, <code>name</code>, <code>employee_status</code>, <code>employment_status</code>, <code>npwp_status</code>, <code>marital_status</code>, <code>number_of_dependents</code>, <code>income_period_until_month</code>.<br>Optional columns: <code>hire_date</code>, <code>termination_date</code>, <code>business_unit</code>, <code>payroll_id</code>.<br>Notes: <code>employment_status</code> values standardized (Active, Resigned, Terminated, OnLeave). <code>income_period_until_month</code> should be numeric 1–12 (preferred) to avoid locale ambiguity. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>employee_information - constraints & validation</strong><br><code>employee_id</code> required and unique.<br><code>number_of_dependents</code> integer 0–3 (enforce via data validation; values >3 trigger a warning or capping policy).<br><code>npwp_status</code> boolean (TRUE/FALSE).<br><code>marital_status</code> normalized values (Single, Married). Use dropdown lists to reduce entry errors. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>tax_calculation_method (sheet) - purpose & columns</strong><br>Sheet name: <code>tax_calculation_method</code>.<br>Columns: <code>employee_id</code>, <code>tax_allowance</code> (TRUE/FALSE), <code>calculation_method</code> (<code>gross</code> or <code>gross_up</code>), <code>ptkp_rule</code> (reference key), <code>gross_up_target_net</code> (optional numeric), <code>notes</code>.<br>Purpose: control per-employee calculation mode and gross-up behavior. Link via <code>employee_id</code>. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>tax_calculation_method - policy notes</strong><br><code>tax_allowance</code> indicates whether employer bears tax (gross-up) and may alter withholding responsibilities.<br><code>calculation_method = gross_up</code> must have <code>tax_allowance = TRUE</code> by policy; otherwise flag for review. Document company policy for gross-up handling in <code>metadata</code>. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>income_components (sheet) - purpose & columns</strong><br>Sheet name: <code>income_components</code>.<br>Columns (recommended): <code>employee_id</code>, <code>basic_salary</code> (monthly), <code>fixed_allowances</code> (monthly), <code>non_fixed_allowances</code> (monthly or averaged), <code>bonus_thr</code> (annual/one-off), <code>other_income</code> (YTD or annual), <code>benefits_in_kind_natura</code> (monthly unless flagged), <code>benefits_unit</code> (monthly/annual).<br>Headers must indicate unit. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>income_components - data guidance</strong><br>Monthly components must be entered as monthly amounts. Annual one-offs must be placed in clearly labelled annual columns. If only YTD amounts available, include a <code>value_unit</code> field so automation knows whether to multiply by 12 or not. When data is uncertain, prefer explicit YTD columns rather than implicit assumptions. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>deductions (sheet) - purpose & columns</strong><br>Sheet name: <code>deductions</code>.<br>Columns: <code>employee_id</code>, <code>job_expense_deduction</code> (monthly or computed), <code>pension_contribution</code> (monthly deductible portion), <code>old_age_security_jht</code> (monthly), <code>zakat_religious_donation</code> (monthly/annual), <code>deductions_unit</code> (monthly/annual), <code>deduction_notes</code>.<br>Job expense deduction may be statutory (e.g., 5% capped) or user-provided; keep both computed and manual override columns for audit. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>deductions - mapping & caps</strong><br>Document statutory caps (if applied) in <code>metadata</code>. If job expense is computed (e.g., percentage of income with cap), store both raw computed value and applied value post-cap to preserve traceability. Ensure pension vs JHT distinctions are clear for correct deductibility. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>tax_results (sheet) - purpose & columns</strong><br>Sheet name: <code>tax_results</code>.<br>Columns: <code>employee_id</code>, <code>annual_gross_income</code>, <code>annual_deductions</code>, <code>annual_net_income</code>, <code>ptkp_amount</code>, <code>annual_taxable_income_pkp</code>, <code>annual_pph21_payable</code>, <code>pph21_withheld_previous</code>, <code>pph21_payable_current_month</code>, <code>gross_up_converged</code> (TRUE/FALSE), <code>gross_up_iterations</code>, <code>computation_notes</code>.<br>Persist computation metadata (convergence, iterations, warnings) for audit. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>annualization rules</strong><br>Monthly → annual: multiply monthly amounts by 12 unless column flagged YTD or prorated. Annual one-offs add directly. For mid-year hires/resignations use explicit <code>prorate_mode</code> selection: choices are <code>extrapolate</code> (YTD × 12), <code>prorate</code> (scale by months worked), or <code>no_annualize</code> (use YTD). Document chosen method in <code>metadata</code>. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>PTKP policy & table</strong><br>Keep a <code>ptkp_table</code> sheet with columns: <code>ptkp_key</code>, <code>marital_status</code>, <code>dependents</code>, <code>ptkp_amount</code>, <code>effective_from</code>, <code>effective_to</code>, <code>notes</code>.<br>Use the table to derive PTKP amounts; do not hard-code values. Maintain effective dates and versioning to support historical computations and audits. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Tax rates table</strong><br><code>tax_rates</code> sheet holds progressive brackets: <code>rate_id</code>, <code>bracket_from</code>, <code>bracket_to</code>, <code>rate_percent</code>, <code>effective_from</code>, <code>effective_to</code>, <code>notes</code>.<br>Reference the table to compute progressive tax. Keep rates versioned with effective dates and document the source of each update in <code>metadata</code>. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Annual taxable income (PKP) calculation</strong><br><code>annual_taxable_income_pkp</code> computed as: <code>max(0, annual_net_income - ptkp_amount)</code>. Ensure PTKP lookup fallback behavior returns 0 and flags missing mapping. Store PTKP amount per employee in <code>ptkp_amount</code> column for transparency. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Progressive tax application (concept)</strong><br>Apply progressive Article 17 tax by allocating PKP across tax brackets defined in <code>tax_rates</code>. For each bracket compute taxable portion and multiply by bracket rate, then sum across brackets. Keep per-bracket intermediate columns (hidden if needed) for traceability and audit. Document the exact bracket-bounding rules (inclusive/exclusive) in <code>metadata</code>. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Gross-up conceptual algorithm</strong><br>Goal: find Gross G such that net(G) matches target net (or desired post-tax amount). Use robust numeric search approach (e.g., bounded search) outside of volatile formulas. Key requirements: integer arithmetic in IDR, explicit iteration caps, robust bounds expansion to avoid infinite loops, logging of iterations and convergence flag. Store convergence boolean and iteration count in <code>tax_results</code>. For governance, store the final computed gross along with the net reconciliation and a human-readable <code>computation_notes</code>. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Rounding & precision policy</strong><br>Round monetary values to nearest rupiah (round half up) at agreed aggregation points — recommended: round annual gross and annual deductions before computing PKP and before applying brackets. Maintain unrounded intermediate values in hidden columns for debugging. State the rounding policy clearly in <code>metadata</code>. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Validation & data-quality rules</strong><br>Implement automatic checks and flags: required fields present, no negative monetary values, <code>number_of_dependents</code> within allowed range, <code>income_period_until_month</code> within 1–12, <code>calculation_method</code> valid. Use Excel Data Validation lists, conditional formatting for anomalies, and a <code>flag</code> column in <code>tax_results</code> summarizing issues for each row. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Error handling & warnings</strong><br>Define explicit flags and messages for: NoTax (PKP <= 0), Overwithheld (withheld > annual payable), GrossUpFail (non-convergent), ProrateWarning (resigned with inconsistent annualization), MissingData fields. Populate <code>computation_notes</code> with human-readable explanations and create <code>flag</code> column for quick filtering. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>QA test suite & expected cases</strong><br>Create <code>qa</code> sheet with unit tests: zero income → zero tax; income below PTKP → zero tax; sample mid-bracket and multi-bracket computations; withheld > computed liability → overwithheld case; gross-up scenarios with expected convergence and expected final gross; mid-year hire/resignation prorate tests. For each QA case include expected numeric result, actual computed result, difference, and pass/fail indicator (tolerance 1 IDR). </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Import / Export rules (CSV & XLSX)</strong><br>CSV encoding: UTF-8 with BOM optional to support Excel. Required header row and explicit column naming. Preserve <code>employee_id</code> as text. Numeric fields must contain only digits (no currency symbols). For exports include a companion <code>metadata.json</code> or a <code>metadata</code> sheet specifying units and effective dates for PTKP/tax rates. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>API / DB mapping guidance</strong><br>Use a JSON payload schema matching workbook field names for minimal ETL transformation. Use ISO 8601 for dates. Example mapping must be documented in <code>metadata</code>. On ingestion, validate units and coerce month fields to numeric 1–12. Maintain a mapping table for external payroll system field names if necessary. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Performance & recalculation guidance</strong><br>Avoid heavy iterative logic in volatile worksheet formulas. Implement gross-up and similar iterative calculations via macros, a backend service, or batch scripts. Recommend setting workbook calculation to Manual when processing large datasets and providing a single "Recompute" macro to perform batch recalculation and populate <code>tax_results</code>. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Security, privacy & PII handling</strong><br>Payroll and tax data are sensitive. Protect workbook files with strong encryption and access controls. Mask or omit NPWP numbers in exports unless strictly necessary. Use role-based access for editing vs viewing. Log access and changes in <code>metadata.execution_log</code> for accountability. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Reporting & printing guidelines</strong><br>Create a <code>reporting</code> sheet that aggregates per-employee summary rows suitable for printing and submission: include <code>employee_id</code>, <code>name</code>, <code>annual_gross_income</code>, <code>annual_taxable_income_pkp</code>, <code>annual_pph21_payable</code>, <code>pph21_withheld_previous</code>, <code>pph21_payable_current_month</code>, and <code>flag</code> notes. For printing, create a value-only copy to avoid accidental recalculation and to keep an immutable audit snapshot. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Changelog & version control</strong><br>Maintain <code>changelog</code> sheet capturing <code>date</code>, <code>author</code>, <code>change_summary</code>, <code>affected_sheets</code>, and <code>version_tag</code>. Update whenever tax rate tables, PTKP values, formulas, rounding policies, or gross-up algorithm parameters change. Tag workbook versions in <code>metadata</code> and store archival copies for audit retention. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Troubleshooting checklist</strong><br>If computed tax differs from reference (e.g., Ortax website): verify unit conventions (monthly vs annual), confirm PTKP and tax rate effective dates, check whether statutory caps (job expense) are applied, confirm whether gross-up or allowances were double-counted, and re-run QA cases to isolate differences. For gross-up convergence failures, inspect bounds and rate tables. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Automation & scheduled processing</strong><br>For recurring runs implement a server-side batch process that: imports payroll CSV, validates/normalizes fields, applies business rules (prorate/extrapolate), runs non-volatile calculations including gross-up, writes <code>tax_results</code>, exports reporting CSV/XLSX, and archives input/output with execution logs. Record schedule, owner, and error-notification contact in <code>metadata</code>. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Delivery & handover checklist</strong><br>Deliverables: workbook with named tables and protected calculation regions, <code>tax_rates</code> and <code>ptkp_table</code> populated with effective dates, <code>metadata</code> and <code>changelog</code>, <code>qa</code> sheet with failing/passing cases, <code>doc_md</code> with single-column markdown for copy/paste, <code>reporting</code> sheet templates, README with runbook and macro permissions. Provide a short acceptance QA run demonstrating expected outputs for representative payroll samples. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Governance & change approval</strong><br>Establish owners for PTKP updates, tax rate changes, rounding policy, and gross-up parameter changes. Require sign-off and changelog entry for any change affecting calculations. Retain pre- and post-change QA results and archive prior versions for audit. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Auditability & traceability</strong><br>Keep per-employee computation notes, store intermediate rounded and unrounded values for each calculation step, and preserve gross-up iteration metadata. Provide an audit export format that includes all intermediate fields to allow external recalculation and validation. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>User guidance & help text</strong><br>Populate header-row help strings or a <code>README</code> sheet explaining each column (data type, unit, expected value range, and examples). Add tooltips or cell comments in Excel for critical fields (e.g., <code>calculation_method</code>, <code>income_period_until_month</code>). Encourage data-entry teams to follow examples on <code>qa</code> sheet and to validate imports using a validation macro before running calculations. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Appendix: recommended workbook hygiene</strong><br>Protect cells with formulas while leaving input sheets editable. Use named ranges for frequently referenced values (e.g., active <code>tax_rates</code> version or <code>ptkp_effective_date</code>). Keep a read-only distribution copy and separate master editable copy. Backup and archive daily if automating. Ensure macros are signed and documented to comply with corporate security policies. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Contact & ownership</strong><br>Record the calculator owner in <code>metadata</code> with name, role, and contact email. Include escalation paths for tax-rule clarifications and a designated approver for PTKP and tax rate updates. Ensure support contact is reachable during scheduled batch runs. </td></tr></tbody></table></div><div class="row-count">Rows: 37</div></div><div class="table-caption" id="Table2" data-table="Docu_0165_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **User Guide PPh 21 Yearly (Final Period)**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>User Guide PPh 21 Yearly (Final Period)</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Overview / Purpose</strong><br><br> This document is a technical reference that explains how to map payroll data into the Ortax “PPh 21 Yearly (final period)” calculator. It describes the expected inputs, data types, validation rules, and the logical formulae used to compute annual taxable income (PKP) and PPh21 payable. The narrative focuses on implementation and auditability — what each field means, how to prepare inputs from payroll systems, common pitfalls when integrating, and where implementers must make policy decisions (for example, proration vs. annualization for mid-year hires or resignations). </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Data format & currency</strong><br><br> All monetary fields use Indonesian Rupiah (IDR) and must be represented as integers (no decimal fraction). When producing CSVs or JSON payloads, ensure numeric types are preserved (avoid quotes around amounts). The recommended pipeline practice: validate types at ingestion, run a normalization pass (strip symbols, enforce integer rounding), and then write to the sheet/DB with explicit numeric types and an IDR display format for human-facing exports. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>employee_information (sheet)</strong><br><br> The <code>employee_information</code> sheet is the canonical reference for identity and status attributes used across joins. Treat <code>employee_id</code> as the single source of truth for merges; implement pre-flight checks that detect duplicate IDs, unexpected nulls, and inconsistent enums between sources. For organizations with multiple operating units, add <code>org_unit</code> or <code>payroll_company</code> columns and include them in join keys to avoid cross-company mixing of data. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>employee_id</code> — String identifier, unique (e.g., E001).<br><br> Always import and store <code>employee_id</code> as text; when exporting to CSV prefix IDs that might look numeric with a single quote if opening in Excel. Ensure the ingestion logic rejects spaces or control characters and normalizes case if your system is case-insensitive. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>name</code> — Full name string.<br><br> Useful for reports and audits; optional for calculation but required for stakeholder review. Sanitize names for special characters only when necessary for downstream systems — keep raw values in an audit column. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>employee_status</code> — Enum: <code>Permanent</code>, <code>Contract</code>, <code>Intern</code>, etc.<br><br> Use an enumerated type to simplify grouping and reporting. Document mapping rules if upstream HR systems use different labels (for example, <code>FT</code> → <code>Permanent</code>). This field may affect eligibility for certain company-specific allowances. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>employment_status</code> — Enum: <code>Active</code>, <code>Resigned</code>.<br><br> Define and document how <code>Resigned</code> employees are handled operationally: whether you annualize to 12 months, prorate to YTD, or expect YTD input from payroll. Implement automated flags for <code>resigned</code> + <code>income_period_until_month</code> < 12 so reviewers can confirm the chosen policy. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>npwp_status</code> — Boolean or enum: <code>True</code>/<code>False</code> or <code>Has NPWP</code>/<code>No NPWP</code>.<br><br> Keep this field as boolean where possible. Use it to trigger reporting requirements or to mark cases where withholding adjustments/penalties might apply under company policy or regulation. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>marital_status</code> — Enum: <code>Single</code>, <code>Married</code>.<br><br> Normalized values are critical because marital status maps directly to PTKP tiers. If spouses both work, document whether both PTKP allowances are applied or if company policy differs. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>number_of_dependents</code> — Integer 0–3.<br><br> Validate values on import and clamp or reject values above the allowed cap. Record any business-rule decisions (clamping vs error) in the metadata sheet so auditors can trace behavior. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>income_period_until_month</code> — Month shorthand or number (e.g., <code>Dec</code> or <code>12</code>).<br><br> Standardize on numeric months (1–12) in the API layer and convert for display. Log any mismatches (e.g., <code>Dec</code> vs <code>Des</code>) during parsing and normalize before calculations. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>tax_calculation_method (sheet)</strong><br><br> This sheet controls policy-level decisions per-employee: whether the company bears tax (tax allowance) and whether pay elements are gross-up. Keep it small and explicit — a single row per employee with immutable historical records for each payroll period to preserve audit trails. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>tax_allowance</code> — Boolean: <code>true</code>/<code>false</code>.<br><br> Use to indicate if the employer will gross-up tax or pay an allowance. When <code>true</code>, ensure the gross-up algorithm is invoked and that the results are recorded in both <code>tax_results</code> and the payroll liability report. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>calculation_method</code> — Enum: <code>gross</code> or <code>gross_up</code>.<br><br> <code>gross</code> uses the stated gross as the taxable base. <code>gross_up</code> changes the calc: the gross is adjusted so that the employee receives a specified net amount after tax; this requires iterative solving and careful control so payroll records match GL postings. Document the gross-up target and store convergence metadata for each run. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>ptkp_rule</code> — String: e.g., <code>article_17</code> or custom reference.<br><br> Reference a named PTKP rule set rather than hard-coding numbers to allow updates without formula changes. Each rule set should have effective dates and an author in the metadata sheet. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>income_components (sheet)</strong><br><br> Income components must clearly indicate units (monthly vs annual) in the header or as separate flag columns. Provide guidance to data providers on where to place YTD values vs monthly averages and require a <code>unit</code> or <code>is_annual</code> flag if data sources are heterogeneous. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>basic_salary</code> — Monthly base salary amount (integer IDR).<br><br> Required for annualization and often the basis for statutory benefits. Document whether the basic salary includes allowances in any upstream system to avoid duplication. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>fixed_allowances</code> — Monthly fixed allowances.<br><br> Treat as recurring income for annualization. If certain allowances are non-taxable by company policy, mark them with a <code>taxable_flag</code> column and treat accordingly in calculations. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>non_fixed_allowances</code> — Monthly average variable allowances.<br><br> For highly variable components, prefer YTD reporting in <code>other_income</code> and leave <code>non_fixed_allowances</code> empty or zero; this avoids misleading averages when a few large events distort monthly averages. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>bonus_thr</code> — Yearly bonuses / THR value.<br><br> Explicitly document whether this is annual actual or projected; if payroll produces monthly projections, include a projection flag and describe how reconciliations occur after payment. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>other_income</code> — One-off taxable items.<br><br> Require a reason code for audit (e.g., <code>commission</code>, <code>retro_pay</code>) and capture the period in which the income occurred. This helps match tax treatment rules that depend on timing. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>benefits_in_kind_natura</code> — Monetary equivalent of natura/benefits-in-kind.<br><br> Clarify calculation method (company valuation, tax rules for specific benefits) and whether amounts are employer-estimated or appraised by a third party. Keep a <code>valuation_method</code> column if valuations can change. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>deductions (sheet)</strong><br><br> Deductions must be mapped to regulatory categories so the calculator applies statutory caps correctly. Where user-supplied values can be overridden by statutory maxes, record both the input and the capped value for auditability. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>job_expense_deduction</code> — Monthly job expense allowance or calculated value.<br><br> If the calculator applies a statutory cap, include both <code>job_expense_input</code> and <code>job_expense_applied</code> columns so auditors can see the original input and the cap logic. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>pension_contribution</code> — Monthly employee contribution.<br><br> Distinguish deductible vs non-deductible portions and ensure only the deductible portion flows into <code>annual_deductions</code>. If employer-paid contributions are taxable, mark them separately. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>old_age_security_jht</code> — JHT contributions (BPJS).<br><br> Map contribution types to regulatory definitions and store contribution period for matching to payroll records. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>zakat_religious_donation</code> — Monthly zakat amounts claimed as deduction.<br><br> Require supporting documentation metadata or a boolean <code>zakat_verified</code> to prevent accidental claims without justification. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>tax_results (sheet)</strong><br><br> <code>tax_results</code> is the conclusion of the pipeline: it must contain derived amounts, rounding decisions, convergence flags (for gross-up), and any warnings. Preserve all inputs and intermediate values (in hidden columns) for traceability. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>annual_gross_income</code> (formula) — <code>(basic_salary + fixed_allowances + non_fixed_allowances) * 12 + bonus_thr + other_income + (benefits_in_kind_natura * 12_if_monthly)</code>.<br><br> When implementing, assert the unit of each term before multiplying by 12. If <code>income_period_until_month</code> < 12 and policy is <code>prorate</code>, use YTD inputs and document the extrapolation formula. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>annual_deductions</code> (formula) — <code>(job_expense_deduction + pension_contribution + old_age_security_jht + zakat_religious_donation) * 12</code>.<br><br> If deductions are YTD values, bypass multiplication. The pipeline should validate flags like <code>is_ytd</code> to prevent double-multiplication. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>annual_net_income</code> (formula) — <code>annual_gross_income - annual_deductions</code>.<br><br> Keep a <code>pre_ptkp_adjustments</code> column for non-taxable incomes/adjustments so the net flow into PTKP calculation is transparent. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>annual_taxable_income_pkp</code> (PKP) — <code>max(0, annual_net_income - PTKP_amount)</code>.<br><br> Reference PTKP via <code>ptkp_table</code> lookups. Log the <code>ptkp_key</code> used and the effective date for that run to allow future audits to reproduce results. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>annual_pph21_payable</code> (logic) — Apply progressive Article 17 brackets to <code>annual_taxable_income_pkp</code>.<br><br> Implement bracket calculation using a table-driven approach rather than embedded IF chains so rate changes are data updates, not formula edits. Keep <code>tax_rate_version</code> in <code>tax_results</code> metadata. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>pph21_withheld_previous</code> — Sum of monthly withholdings already reported/paid this year (YTD).<br><br> If employer-reported YTD differs from tax authority records, surface a <code>reconciliation_required</code> flag. Provide links or IDs to source payroll runs for tracebacks. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>pph21_payable_current_month</code> — <code>annual_pph21_payable - pph21_withheld_previous</code>.<br><br> If negative, set to 0 and mark <code>overwithheld</code>. For gross-up cases, the calculation is iterative — store each iteration's trial gross and tax so reviewers can see convergence behavior. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Gross-up algorithm (technical)</strong><br><br> The gross-up routine should be implemented outside volatile worksheet formulas — either as a macro, a backend script, or a callable function. Use binary search or Newton-Raphson with integer arithmetic, enforce iteration and time caps, and log: starting bounds, iterations count, final tolerance, and convergence boolean. Store trial values in an append-only log for audit. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Rounding and precision</strong><br><br> Decide and document one consistent rounding policy (recommendation: round half up to nearest IDR after each aggregation). Avoid mixing granular rounding policies across steps; where different rounding is necessary, record the reason in metadata. Keep raw unrounded intermediate values in hidden columns to support variance analysis. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Validation rules</strong><br><br> Implement data validation at import with clear error codes and human-readable error messages. Example rules: required fields present, numeric ranges valid, enums normalized, no negative monetary values, and dependent field logic (e.g., <code>gross_up==true</code> requires <code>tax_allowance==true</code> unless explicitly overridden with an audit reason). </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Error handling & warnings</strong><br><br> Surface errors as row-level flags and summary-level counts. Example behaviors: set <code>NoTax</code> when PKP <= 0, <code>overwithheld</code> when YTD withholdings exceed liability, and <code>prorate_warning</code> when resigned employees are annualized. Provide a diagnostic sheet listing rows with critical flags and recommended remediation steps. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Excel table formatting</strong><br><br> Convert ranges to named tables (e.g., <code>tbl_employee_information</code>) and use structured references to make formulas clearer and more maintainable. Lock formula cells and apply sheet protection (with editable input ranges) to reduce accidental changes. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Column data types (Excel)</strong><br><br> Use <code>Text</code> for IDs/enums, <code>Number</code> (no decimals) for currencies, and <code>Boolean</code> for flags. Document each column's expected type in a <code>README</code> or data dictionary sheet and enforce validation rules using Excel data validation or an ETL pre-check script. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Import/Export tips (CSV/XLSX)</strong><br><br> For CSV: enforce UTF-8, use a header row, and quote fields that may contain commas. Preserve <code>employee_id</code> as text; recommend the pipeline write <code>employee_id</code> with a non-numeric encoding (prefix or dedicated schema field) to avoid Excel auto-formatting. Include a manifest file with exports that contains schema version, tax rate version, PTKP version, and run timestamp. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Localization & month handling</strong><br><br> Standardize month inputs to numeric (1–12) upstream. Maintain a mapping table if multiple locales are supported (e.g., <code>Des</code> → 12). Include parsing logs for any ambiguous month tokens encountered during ingestion. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>PTKP table mapping</strong><br><br> Maintain <code>ptkp_table</code> with <code>effective_from</code>/<code>effective_to</code> fields and a searchable <code>ptkp_key</code>. When running calculations, record the <code>ptkp_key</code> applied and link to the versioned table row so recalculation for audits is straightforward. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Tax rate table mapping</strong><br><br> Keep <code>tax_rates</code> as a separate, versioned table with explicit effective dates. Use table-driven algorithms to compute tax per bracket and store <code>tax_rate_version</code> in <code>tax_results</code>. Create an automated test that validates total tax computed via table logic against a small set of hand-calculated test cases after any rate update. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Audit trail & metadata</strong><br><br> Include a <code>metadata</code> sheet capturing: calculator version, PTKP effective date, tax rate effective date, author, last-updated timestamp, rounding policy, gross-up algorithm description, and support contact. Ensure each run of the calculator writes a <code>run_id</code> and ties <code>tax_results</code> rows to that run_id for reproducibility. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Sample formulas (Excel)</strong><br><br> Provide ready-made formula examples and a short narrative explaining assumptions behind each sample (e.g., which columns assumed monthly). Keep a <code>formula_library</code> sheet with tested formulas, a short description, and notes on potential pitfalls (such as double-multiplying YTD inputs). </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Performance considerations</strong><br><br> Avoid placing heavy iterative logic inside volatile formulas. Prefer macros, scripts, or backend services for gross-up computations and large datasets. If calculations must run in Excel for small datasets, set manual calculation mode during bulk updates and re-calc only when ready. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Security & data privacy</strong><br><br> Treat payroll data as highly sensitive: enforce file encryption at rest, restrict access via role-based permissions, and remove or anonymize NPWP/personal identifiers before sharing externally. Keep full audit logs that capture who accessed or exported data and when. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Accessibility & printing</strong><br><br> Provide a print-optimized sheet summarizing key fields; freeze panes for readability and use clear fonts and contrast. When distributing to non-technical stakeholders, produce a values-only copy (formulas converted to values) in a separate workbook to prevent accidental recalculation. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Edge cases</strong><br><br> Explicitly document handling of: negative other_income (requires audit note), mid-year hires/resignations (prorate vs annualize), multiple income sources (aggregate or consolidate), and extremely large incomes (test bracket overflow). For each edge case, provide recommended remediation steps and sample inputs/outputs in the <code>qa</code> sheet. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Integration mapping (API/DB)</strong><br><br> Provide JSON field mapping identical to workbook column names; prefer ISO month numbers and numeric types for amounts. Example payload: <code>{ &quot;employee_id&quot;: &quot;E001&quot;, &quot;basic_salary&quot;: 12000000, &quot;income_period_until_month&quot;: 12 }</code>. Include <code>schema_version</code> and <code>run_id</code> in payloads for traceability. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Versioning & change log</strong><br><br> Use a <code>changelog</code> sheet to log changes to formulas, PTKP, tax rates, rounding rules, and metadata. Each entry should include date, author, reason for change, and affected sheets or formulas. This enables quick rollbacks and audit trails. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Quality checks & unit tests</strong><br><br> Maintain a <code>qa</code> sheet with deterministic test cases (including boundary cases) and expected outcomes. Automate the comparison between computed and expected results and fail the run if discrepancies exceed a defined tolerance (1 IDR for convergence). Record test results per <code>run_id</code>. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>User prompts & help text</strong><br><br> Provide short inline help in header comments or a <code>README</code> sheet that describes units, required fields, and typical entry errors. Use tooltips or comments on critical columns to give data entry staff immediate guidance. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>CSV single-column export option</strong><br><br> Create a <code>doc_md</code> sheet that contains the markdown table verbatim in a single column so it can be copy-pasted without Excel reflow problems. This makes it trivial to generate documentation or handover notes from the workbook itself. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Example row explanation (E001)</strong><br><br> Provide a worked example row in <code>qa</code> showing step-by-step arithmetic: monthly inputs → annualized components → deductions → PKP → bracketed tax → YTD withheld → current payable. Include intermediate rounded values and the raw unrounded numbers in hidden columns to demonstrate rounding effects. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Troubleshooting checklist</strong><br><br> Implement a checklist for common issues: ID mismatches, month-unit confusion, stale PTKP/tax rate tables, double-counted allowances, and unexpected gross-up behavior. Provide remediation steps and where to look for proof (source payroll run IDs, receipts, or HR system records). </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Export-ready reporting</strong><br><br> Add a <code>reporting</code> sheet with pivot tables and slicers for <code>employment_status</code> and <code>npwp_status</code>. Provide pre-built export queries for finance (GL posting lines) and tax filing (authority format) that derive from <code>tax_results</code>. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Automated notifications & flags</strong><br><br> Add conditional formatting and flag columns for <code>overwithheld</code>, <code>negative_pkp</code>, <code>gross_up_converged_false</code>, <code>prorate_warning</code>, and <code>missing_required_field</code>. Surface a compact <code>flags_summary</code> pivot that teams can monitor daily. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Change management</strong><br><br> When regulations change, update <code>tax_rates</code> and <code>ptkp_table</code> only; run the QA test-suite and record results in the <code>changelog</code>. Avoid manual edits to calculation formulas in production files; instead, version a test copy and promote once validated. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Delivery checklist for handover</strong><br><br> Provide the following deliverables:<br><br>1. Workbook with sheets & table names (tables named and structured).<br>2. <code>tax_rates</code> & <code>ptkp_table</code> with effective dates and versioning. <br>3. <code>metadata</code> and <code>changelog</code> documenting policy and changes. <br>4. <code>qa</code> sheet with test cases and expected values. <br>5. <code>doc_md</code> or documentation sheet containing this markdown table for quick copy/paste. <br><br>Ensure the deliverable package includes <code>run_id</code> examples and at least one reconciliation file showing how payroll entries map to GL lines. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Contact & ownership</strong><br><br> Record the owner and primary contact in <code>metadata</code> including name, role, and preferred method of contact. Include escalation contacts for tax/legal inquiries and the person responsible for <code>tax_rates</code>/<code>ptkp_table</code> updates. </td></tr></tbody></table></div><div class="row-count">Rows: 63</div></div><div class="table-caption" id="Table3" data-table="Docu_0165_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **User Guide PPh 21 Yearly (Final Period)**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>User Guide PPh 21 Yearly (Final Period)</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Overview / Purpose:</strong> Guide for using the Ortax “PPh 21 Yearly (final period)” calculator.<br>Explains every input selector, expected data type, validation rules, intermediate formulas, how results are derived (logical formulae, not legal tax advice).<br>Includes Excel/CSV mappings, edge cases, and integration tips.<br>Intended as a technical reference for payroll teams or developers mapping payroll data to the calculator. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Data format & currency:</strong> All monetary fields use Indonesian Rupiah (IDR).<br>Use integer values (no currency symbol) or numeric cells formatted as currency in Excel.<br>Round all intermediate monetary values to full rupiah (no decimals).<br>When exporting/importing, preserve numeric type (not strings). </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>employee_information (sheet):</strong> Excel sheet name: <code>employee_information</code>.<br>Primary key: <code>employee_id</code>.<br>Columns: <code>employee_id</code>, <code>name</code>, <code>employee_status</code>, <code>employment_status</code>, <code>npwp_status</code>, <code>marital_status</code>, <code>number_of_dependents</code>, <code>income_period_until_month</code>.<br>Use this sheet to join rows with other sheets via <code>employee_id</code>. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>employee_id</code> — String identifier, unique (e.g., E001).<br>Required.<br>Avoid spaces and special characters for robust joins. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>name</code> — Full name string.<br>Optional for calculation but required for reporting. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>employee_status</code> — Enum: <code>Permanent</code>, <code>Contract</code>, <code>Intern</code>, etc.<br>Use consistent values for grouping.<br>Affects presumptive benefits and eligibility for fixed allowances (not calculation logic unless explicitly mapped). </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>employment_status</code> — Enum: <code>Active</code>, <code>Resigned</code>.<br>If <code>Resigned</code> and <code>income_period_until_month</code> < 12, calculations should treat income as year-to-date (no automatic annualization unless specified).<br>Document how you want resignations handled. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>npwp_status</code> — Boolean or enum: <code>True</code>/<code>False</code> or <code>Has NPWP</code>/<code>No NPWP</code>.<br>Important for reporting and may affect withholding or penalties.<br>Store as boolean in Excel (TRUE/FALSE) for easier filters. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>marital_status</code> — Enum: <code>Single</code>, <code>Married</code>.<br>Keep values normalized.<br>Marital status is required to compute PTKP allowance tiers (PKP base). The tool references PTKP categories — map your company policy to the correct tier. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>number_of_dependents</code> — Integer 0–3 (standard Indonesian tax limits typically cap dependents for PTKP).<br>Validate to max allowed (commonly 3).<br>Treat values >3 as 3 or error, depending on policy. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>income_period_until_month</code> — Month shorthand or number (e.g., <code>Dec</code> or <code>12</code>).<br>Use consistent format across all rows.<br>If using numbers, document whether January=1 or 0-indexed. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>tax_calculation_method (sheet):</strong> Excel sheet name: <code>tax_calculation_method</code>.<br>Columns: <code>employee_id</code>, <code>tax_allowance</code>, <code>calculation_method</code>, <code>ptkp_rule</code>.<br>One-row-per-employee; join by <code>employee_id</code>. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>tax_allowance</code> — Boolean: <code>true</code>/<code>false</code> — if true, indicates company pays tax allowance or gross-up is considered.<br>Controls whether gross-up calculations are applied. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>calculation_method</code> — Enum: <code>gross</code> or <code>gross_up</code>.<br><code>gross</code> = tax computed on stated gross.<br><code>gross_up</code> = gross amount adjusted so net after tax equals a target (requires iterative computation).<br>Mark gross-up rows for special handling and document the gross-up algorithm (see gross-up note). </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>ptkp_rule</code> — String: e.g., <code>article_17</code> or a custom PTKP reference.<br>Indicates the PTKP rule set used to reduce annual net income to PKP (taxable income).<br>Keep this explicit for auditability. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>income_components (sheet):</strong> Excel sheet name: <code>income_components</code>.<br>Columns: <code>employee_id</code>, <code>basic_salary</code>, <code>fixed_allowances</code>, <code>non_fixed_allowances</code>, <code>bonus_thr</code>, <code>other_income</code>, <code>benefits_in_kind_natura</code>.<br>All numeric, monthly except where noted.<br>Ensure unit consistency in headers. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>basic_salary</code> — Monthly base salary amount (integer IDR).<br>Required for annualization. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>fixed_allowances</code> — Monthly fixed allowances (transport, position allowance, etc.).<br>Treated as regular income and annualized. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>non_fixed_allowances</code> — Monthly average variable allowances.<br>If fluctuating, record average month-to-date or actual YTD in <code>other_income</code>.<br>If uncertain, use 0 and provide YTD in <code>other_income</code>. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>bonus_thr</code> — Yearly bonuses / THR value.<br>If input is monthly, clearly document whether value is YTD or month.<br>In the example workbook this field is treated as annual one-off amount when computing total year income. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>other_income</code> — One-off taxable items (commissions, reimbursements treated as taxable, retro pay).<br>Enter as YTD or annual depending on column definition — ensure consistent convention. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>benefits_in_kind_natura</code> — Monetary equivalent of natura/benefits-in-kind subject to tax (company car, housing).<br>Record monthly or annual consistently; the example treats as monthly when present. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>deductions (sheet):</strong> Excel sheet name: <code>deductions</code>.<br>Columns: <code>employee_id</code>, <code>job_expense_deduction</code>, <code>pension_contribution</code>, <code>old_age_security_jht</code>, <code>zakat_religious_donation</code>.<br>Monetary numeric. Validate negatives not allowed. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>job_expense_deduction</code> — Monthly job expense allowance or calculated value (e.g., 5% of gross capped at statutory maximum).<br>If calculator auto-applies a cap, document cap logic; otherwise allow user-supplied values. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>pension_contribution</code> — Monthly employee contribution to pension funds (BPJS/JHT/pension) that are deductible.<br>If both employee+employer portions exist, only include the deductible portion per regulation. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>old_age_security_jht</code> — JHT contributions (BPJS Ketenagakerjaan) monthly numeric.<br>Distinguish JHT vs pension in mapping logic. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>zakat_religious_donation</code> — Monthly zakat amounts claimed as deduction (if applicable).<br>If user claims annual zakat, place as annual or convert consistently. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>tax_results (sheet):</strong> Excel sheet name: <code>tax_results</code>.<br>Columns: <code>employee_id</code>, <code>annual_gross_income</code>, <code>annual_net_income</code>, <code>annual_taxable_income_pkp</code>, <code>annual_pph21_payable</code>, <code>pph21_withheld_previous</code>, <code>pph21_payable_current_month</code>.<br>Many fields derived; document formulas and rounding rules. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>annual_gross_income</code> (formula) — Example formula used: <code>(basic_salary + fixed_allowances + non_fixed_allowances) * 12 + bonus_thr + other_income + (benefits_in_kind_natura * 12_if_monthly)</code>.<br>Clarify whether benefits are monthly or annual; if monthly, multiply by 12. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>annual_deductions</code> (formula) — Sum of monthly deductions * 12: <code>(job_expense_deduction + pension_contribution + old_age_security_jht + zakat_religious_donation) * 12</code>.<br>If deductions are entered as YTD, do not multiply. Document chosen convention. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>annual_net_income</code> (formula) — <code>annual_gross_income - annual_deductions</code>.<br>If other pre-tax reductions apply (non-taxable allowances), subtract here before applying PTKP. Keep a separate column for pre-PTKP adjustments for audit trail. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>annual_taxable_income_pkp</code> (PKP) — <code>max(0, annual_net_income - PTKP_amount)</code> where <code>PTKP_amount</code> depends on <code>marital_status</code> and <code>number_of_dependents</code> per selected <code>ptkp_rule</code>.<br>Do not apply PTKP twice.<br>Do not hard-code PTKP values; reference a PTKP table. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>annual_pph21_payable</code> (logic) — Compute tax on <code>annual_taxable_income_pkp</code> using progressive Article 17 brackets.<br>Sum tax per bracket.<br>Document the rate table source and last-updated date in a metadata sheet. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>pph21_withheld_previous</code> — Sum of monthly withholdings already reported/paid this year (YTD).<br>If not provided, default 0. This reduces remaining payable for the final period calculation. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <code>pph21_payable_current_month</code> — <code>annual_pph21_payable - pph21_withheld_previous</code>.<br>If negative, set to 0 (refund/credit).<br>If <code>calculation_method</code> is <code>gross_up</code>, adjust gross until <code>pph21_payable_current_month</code> meets net requirement (see gross-up row). </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Gross-up algorithm (technical):</strong> Gross-up requires iterative solution: find gross G such that <code>net = G - tax(G)</code> equals target net.<br>Implement via Newton-Raphson or binary search within safe bounds.<br>Use integer arithmetic and cap iterations (e.g., 50 iterations) with tolerance = 1 IDR.<br>Record convergence status in <code>tax_results</code> for audit. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Rounding and precision:</strong> Round monetary values to the nearest rupiah after each monetary aggregation step or at the final result — document chosen policy.<br>Standard: round half up to nearest integer.<br>Keep raw intermediate values in hidden columns for debugging if needed. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Validation rules:</strong> - Required fields: <code>employee_id</code>, <code>basic_salary</code> (or YTD equivalents).<br>- No negative monetary values.<br>- <code>number_of_dependents</code> integer 0–3.<br>- <code>calculation_method</code> in allowed set.<br>- <code>income_period_until_month</code> within 1–12 or Jan–Dec.<br>- If <code>gross_up==true</code>, ensure <code>tax_allowance==true</code> or warn that gross-up without allowance is unusual. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Error handling & warnings:</strong> - If <code>annual_taxable_income_pkp</code> <= 0 → Tax = 0; mark as <code>NoTax</code>.<br>- If <code>pph21_withheld_previous</code> > <code>annual_pph21_payable</code> → <code>pph21_payable_current_month</code> = 0 and <code>overwithheld</code> flag set.<br>- If <code>resigned</code> and <code>income_period_until_month</code> < 12 and you still annualize by <em>12</em>, show <code>prorate_warning</code>.<br>Provide a <code>prorate</code> mode that extrapolates YTD income to annual (document assumption). </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Excel table formatting:</strong> Convert each sheet range into an Excel table (Insert → Table) and give a descriptive table name: <code>tbl_employee_information</code>, <code>tbl_tax_calc_method</code>, <code>tbl_income_components</code>, <code>tbl_deductions</code>, <code>tbl_tax_results</code>.<br>This makes structured references and filters easier for formulas. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Column data types (Excel):</strong> Use <code>Text</code> for IDs and enums.<br><code>Number</code> (no decimals) for monetary fields.<br><code>Boolean</code> for flags (<code>npwp_status</code>, <code>tax_allowance</code>).<br>Format numeric columns as Accounting/IDR for readability but keep underlying values as plain numbers for formula reliability. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Import/Export tips (CSV/XLSX):</strong> - For CSV imports, enforce UTF-8 and a header row.<br>- Preserve <code>employee_id</code> as text (prefix with a single quote in Excel if required).<br>- When saving from Excel, export dates/months consistently (use numbers or three-letter month codes). </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Localization & month handling:</strong> <code>income_period_until_month</code> may be local (e.g., <code>Des</code> vs <code>Dec</code>) — standardize to English 3-letter months or numeric months in the data pipeline before calculation.<br>Document the mapping. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>PTKP table mapping:</strong> Maintain a separate sheet <code>ptkp_table</code> with columns: <code>ptkp_key</code>, <code>marital_status</code>, <code>dependents</code>, <code>ptkp_amount</code>, <code>effective_from</code>, <code>effective_to</code>.<br>Reference it in the main calculation so PTKP updates don't require formula edits. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Tax rate table mapping:</strong> Maintain <code>tax_rates</code> sheet with progressive brackets and rates: <code>bracket_from</code>, <code>bracket_to</code>, <code>rate_percent</code>, <code>effective_from</code>, <code>effective_to</code>.<br>Use lookup logic to apply brackets to <code>annual_taxable_income_pkp</code>.<br>Keep versioning metadata. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Audit trail & metadata:</strong> Include a <code>metadata</code> sheet documenting: Calculator version, PTKP effective date, tax rate table effective date, author, last-updated timestamp, rounding policy, gross-up algorithm description, and contact for payroll questions. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Sample formulas (Excel):</strong> - <code>annual_gross_income</code> example: <code>=(basic_salary + fixed_allowances + non_fixed_allowances) * 12 + bonus_thr + other_income + IF(benefits_monthly_flag, benefits_in_kind_natura * 12, benefits_in_kind_natura)</code>.<br>- <code>annual_deductions</code>: <code>=(job_expense_deduction + pension_contribution + old_age_security_jht + zakat_religious_donation) * 12</code>.<br>- <code>annual_net_income</code>: <code>=annual_gross_income - annual_deductions</code>.<br>- <code>annual_taxable_income_pkp</code>: <code>=MAX(0, annual_net_income - PTKP_amount)</code>. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Performance considerations:</strong> Keep heavy iterative gross-up logic out of volatile worksheet recalculation loops.<br>Implement gross-up in a dedicated macro or backend script, or mark gross-up calculations manual-calculation mode to avoid repeated recalculation on each sheet edit. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Security & data privacy:</strong> Payroll and tax data are sensitive.<br>Protect the spreadsheet with file encryption, limit access, and remove personally identifying info if sharing with third parties.<br>Avoid embedding raw NPWP numbers unless strictly required. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Accessibility & printing:</strong> Use clear headers, freeze panes for the main table, and a print-friendly sheet with summarized fields for paper submission.<br>For printing, convert formulas to values in a copy to avoid accidental recalculation. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Edge cases:</strong> - Negative <code>other_income</code> (corrections): require audit note.<br>- Mid-year hires/resignations: provide <code>YTD_income</code> and select <code>prorate</code> or <code>annualize</code> policy.<br>- Multiple income sources: aggregate across sources or create separate rows and consolidate before tax calculation. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Integration mapping (API/DB):</strong> Provide JSON field mapping identical to workbook column names for API payloads.<br>Example: <code>{ &quot;employee_id&quot;: &quot;E001&quot;, &quot;basic_salary&quot;: 12000000, ... }</code>.<br>Use ISO month numbers for <code>income_period_until_month</code> to reduce locale ambiguity. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Versioning & change log:</strong> Keep a <code>changelog</code> sheet that logs changes to formulas, PTKP, tax rates, or rounding rules with date and author.<br>Essential for audits. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Quality checks & unit tests:</strong> Add a <code>qa</code> sheet with test cases (sample employees and expected outcomes) to validate workbook logic after edits (including gross-up scenarios and rounding).<br>Include boundary tests: zero income, cap dependents, very high incomes, and pre-paid taxes greater than computed liability. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>User prompts & help text:</strong> In the Excel header row or a <code>README</code> sheet, include short help strings for each column (data type, units, whether monthly or annual) to reduce data-entry errors. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>CSV single-column export option:</strong> If you need a single-column copyable markdown table for documentation, create a <code>doc_md</code> sheet containing the exact markdown (pipe table) in one column so it can be copy-pasted as a block.<br>This prevents Excel auto-wrapping from breaking markup. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Example row explanation (E001):</strong> Show one worked example row on <code>qa</code> sheet mirroring the provided example workbook.<br>Provide complete traced calculation step-by-step so reviewers can follow arithmetic from monthly components → annual gross → deductions → PKP → tax → withheld → final payable. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Troubleshooting checklist:</strong> - Ensure <code>employee_id</code> matches across sheets.<br>- Confirm monthly vs annual units for <code>bonus_thr</code>, <code>other_income</code>, <code>benefits_in_kind_natura</code>.<br>- Verify PTKP and tax rate tables are current and linked.<br>- If a computed tax appears unexpectedly high, check whether allowances were double-counted or gross-up was applied. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Export-ready reporting:</strong> Add a <code>reporting</code> sheet with pivoted outputs: total annual gross per employee, total tax payable, total tax withheld, and company liability from gross-up.<br>Provide filters for <code>employment_status</code> and <code>npwp_status</code>. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Automated notifications & flags:</strong> Add conditional formatting or formula flags for: <code>overwithheld</code>, <code>negative_pkp</code>, <code>gross_up_converged_false</code>, <code>prorate_warning</code>, <code>missing_required_field</code>.<br>Use a <code>flag</code> column in <code>tax_results</code> for easy filtering. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Change management:</strong> When tax regulation changes, update <code>tax_rates</code> and <code>ptkp_table</code> only; avoid direct edits to calculation formulas.<br>Test against <code>qa</code> cases and update <code>metadata</code> and <code>changelog</code>. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Delivery checklist for handover:</strong> Provide: <br> (1) Workbook with sheets & table names, <br> (2) <code>tax_rates</code> & <code>ptkp_table</code> with effective dates, <br> (3) <code>metadata</code> and <code>changelog</code>, <br> (4) <code>qa</code> sheet with test cases and expected values, <br> (5) documentation sheet containing this markdown table for quick copy/paste. </td></tr><tr><td data-label="User Guide PPh 21 Yearly (Final Period)"> <strong>Contact & ownership:</strong> Include owner/contact in <code>metadata</code> for questions and change approvals.<br>Record name, role, and preferred contact method. </td></tr></tbody></table></div><div class="row-count">Rows: 63</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>