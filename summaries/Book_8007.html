<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759660001">
<link rel="stylesheet" href="assets/overrides.css?v=1759662223">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header"><div><h1>Tables Viewer v2.1</h1></div><div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" type="search" placeholder="Search" aria-label="Search tables" style="min-width:420px; width:44ch;"/>
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllMdBtn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)</button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset all tables">Reset All Tables</button>
</div></div>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#table-1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#table-2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#table-3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#table-4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#table-5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#table-6">Table 6</a></li>
<li class="toc-item"><a class="toc-link" href="#table-7">Table 7</a></li>
<li class="toc-item"><a class="toc-link" href="#table-8">Table 8</a></li>
<li class="toc-item"><a class="toc-link" href="#table-9">Table 9</a></li>
<li class="toc-item"><a class="toc-link" href="#table-10">Table 10</a></li>
<li class="toc-item"><a class="toc-link" href="#table-11">Table 11</a></li>
<li class="toc-item"><a class="toc-link" href="#table-12">Table 12</a></li>
<li class="toc-item"><a class="toc-link" href="#table-13">Table 13</a></li>
<li class="toc-item"><a class="toc-link" href="#table-14">Table 14</a></li>
<li class="toc-item"><a class="toc-link" href="#table-15">Table 15</a></li></ul></div></div>
<div class="table-caption" id="table-1" data-table="Book_8007_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1 — core_renderer.py</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Topic**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Topic</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Explanation**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Explanation</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Topic"><strong>File Purpose and Role</strong> </td><td data-label="Explanation"><code>core_renderer.py</code> functions as the orchestration layer for the entire rendering process. It does not just render HTML; it manages inputs, dispatches concurrent fragment rendering, prepares assets, and performs the final atomic write to disk. This file is the glue that binds together I/O, asset management, fragment handling, and final HTML assembly. Because of this central role, its correctness directly influences output stability, performance, and security. </td></tr><tr><td data-label="Topic"><strong>Input Handling</strong> </td><td data-label="Explanation">Inputs may be structured objects (fragments, table models, metadata) and configuration options. The renderer must normalize all inputs into a predictable format. Errors at this stage often cause cascading failures downstream. Recommendations: enforce strict schema validation, provide defaults for missing options, and explicitly reject unsupported fields. This ensures predictability and reduces hidden bugs. </td></tr><tr><td data-label="Topic"><strong>Fragment Rendering</strong> </td><td data-label="Explanation">Delegates to <code>render_fragments_concurrently</code> from <code>core_fragments.py</code>. This step parallelizes rendering of fragments, often representing tables or subsections of HTML. Important considerations: deterministic ordering of output, consistent fragment metadata (IDs, hashes, timing). Enhancements include: configurable concurrency, explicit timeout policies, structured error capture, and retry logic. The orchestrator should not embed concurrency details but should define clear contracts and behaviors. </td></tr><tr><td data-label="Topic"><strong>Asset Preparation</strong> </td><td data-label="Explanation">Assets such as CSS, JS, and overrides must be copied into the output bundle. This file uses <code>prepare_assets</code> and <code>write_overrides_css</code>. Asset preparation is a critical UX factor: if an asset is missing or corrupted, rendered pages fail to load correctly. Enhancements: implement Subresource Integrity (SRI), atomic copying into a temp asset folder, and safe rollback on failure. From a UX perspective, user-specific overrides should be clearly logged and visible in metadata so users understand what was applied. </td></tr><tr><td data-label="Topic"><strong>HTML Assembly</strong> </td><td data-label="Explanation">After fragments and assets are prepared, the renderer assembles the final HTML template. This involves stitching fragments together in a fixed order, inserting <code>&lt;script&gt;</code> and <code>&lt;link&gt;</code> tags, and embedding metadata. Key requirements: escaping dynamic data, avoiding injection vectors, and ensuring stable template placeholders. Performance-wise, large outputs should be streamed to file rather than built entirely in memory. From a UX angle, HTML should contain embedded metadata (comments or <code>&lt;meta&gt;</code> tags) to assist in debugging and version traceability. </td></tr><tr><td data-label="Topic"><strong>Atomic Write Behavior</strong> </td><td data-label="Explanation">Final HTML and asset files are written using <code>_default_write_atomic</code>, ensuring files are never left in a partially written state. This is crucial for durability and preventing corrupted outputs. Enhancements: enforce UTF-8 encoding consistently, fsync file descriptors before rename, and test cross-platform behavior (Windows file locks, POSIX rename guarantees). Strong recommendation: wrap atomic write operations in test harnesses that simulate crashes during write to verify integrity guarantees. </td></tr><tr><td data-label="Topic"><strong>Temporary Directory Management</strong> </td><td data-label="Explanation">Uses <code>tmp_frag_dir_for</code> to generate temporary directories for intermediate fragments. Robust cleanup is essential: leftover temp dirs can accumulate and fill disks. The orchestrator should enforce cleanup on both success and failure via try/finally or context managers. Enhancement: add logging of temp dir lifecycle, implement disk quota checks, and allow configurable temp dir location for constrained environments (e.g., containers with limited <code>/tmp</code>). </td></tr><tr><td data-label="Topic"><strong>Error Handling Strategy</strong> </td><td data-label="Explanation">Errors can occur at multiple stages: input validation, fragment rendering, asset copying, HTML assembly, or final write. The orchestrator should capture all errors in structured metadata. Fail-fast vs best-effort recovery should be configurable. Example: if a single fragment fails, should the system insert a placeholder and continue, or abort entirely? Enhancement: provide an option to include error details inside the final HTML (for debugging) without crashing the pipeline. </td></tr><tr><td data-label="Topic"><strong>Security Considerations</strong> </td><td data-label="Explanation">1. Escape untrusted values using <code>html.escape</code>. 2. Sanitize fragment HTML when untrusted sources exist. 3. Apply SRI to all scripts and stylesheets. 4. Avoid inline scripts where possible. 5. Enforce strict Content-Security-Policy (CSP) headers if this renderer outputs standalone web apps. 6. Strip or normalize potentially malicious attributes from fragments (e.g., <code>onerror</code>, <code>onclick</code>). </td></tr><tr><td data-label="Topic"><strong>Performance and Scalability</strong> </td><td data-label="Explanation">The orchestrator must scale to millions of rows or hundreds of fragments. Recommended: implement streaming HTML assembly, control concurrency to match CPU cores, impose fragment size limits, and avoid large intermediate memory buffers. Performance metrics (timings, fragment counts, sizes) should be logged and exported in machine-readable formats (JSON). Future enhancement: support incremental rendering where only modified fragments are regenerated. </td></tr><tr><td data-label="Topic"><strong>Portability</strong> </td><td data-label="Explanation">Must work across OSes (Linux, macOS, Windows). Issues to test: path length limits, file locking semantics, case sensitivity, newline normalization. Recommendations: use <code>pathlib</code> consistently, test with long paths on Windows, and ensure atomic rename functions properly in all environments. UX improvement: detect unsupported environments early and provide actionable error messages. </td></tr><tr><td data-label="Topic"><strong>User Experience (UX) Notes</strong> </td><td data-label="Explanation">UX hinges on predictable, fast, and transparent rendering. Users should receive clear logs (e.g., “Rendering 42 fragments, concurrency=8, estimated time=3s”). Metadata outputs (JSON summaries) improve integration with CI/CD pipelines. Failures should be explained clearly, with actionable next steps. Enhancements: progress bars, detailed error pages (HTML placeholders), and optional debug dumps of fragment metadata. </td></tr><tr><td data-label="Topic"><strong>Logging and Observability</strong> </td><td data-label="Explanation">Current logging likely covers major steps. Enhancements: structured logs in JSON format for machine parsing, debug vs production modes, per-fragment timing, and error-level granularity. Logs should integrate with external monitoring (e.g., Prometheus, ELK stack). This improves traceability and reduces mean-time-to-recovery when issues occur. </td></tr><tr><td data-label="Topic"><strong>Testing and Verification</strong> </td><td data-label="Explanation">Must be tested under unit, integration, and system levels. Unit: atomic write, asset prep, error handling. Integration: full pipeline with multiple fragments. System: stress tests with very large inputs. Verification should include simulated crashes during write, network filesystem behavior, and multi-process contention. Cross-platform test matrix is mandatory. </td></tr><tr><td data-label="Topic"><strong>Edge Case Coverage</strong> </td><td data-label="Explanation">Empty inputs, single fragment, extremely large tables, corrupted assets, permission errors, disk full conditions, concurrent invocations writing to same directory. The orchestrator must handle or clearly fail in each case. Failing silently or leaving partial outputs is unacceptable. </td></tr><tr><td data-label="Topic"><strong>Recommended Enhancements</strong> </td><td data-label="Explanation">1. Configurable <code>timeout</code> and <code>failure_mode</code>. 2. Strict context-managed temp dirs. 3. Streaming HTML assembly. 4. Structured logging + JSON metadata. 5. Asset preparation with tmp dir and atomic switch. 6. Metrics hooks for observability. 7. Optional debug HTML embedding of error info. </td></tr><tr><td data-label="Topic"><strong>Actionable Security Improvements</strong> </td><td data-label="Explanation">- Add SRI hashing for all assets. - Strip unsafe HTML attributes. - Enforce CSP headers. - Avoid inline JavaScript unless absolutely necessary. - Provide sanitization mode toggle for untrusted sources. </td></tr><tr><td data-label="Topic"><strong>Actionable Performance Improvements</strong> </td><td data-label="Explanation">- Streaming write for large HTML. - Incremental rendering for changed fragments only. - Memory backpressure control. - Concurrency auto-tuning based on CPU. - Metadata collection for profiling. </td></tr><tr><td data-label="Topic"><strong>Actionable UX Improvements</strong> </td><td data-label="Explanation">- JSON metadata alongside HTML output. - CLI flags for verbosity and debug modes. - Human-readable logs with timings. - Placeholder fragments with visible error messages. - Documented asset overrides for transparency. </td></tr><tr><td data-label="Topic"><strong>Verification Checklist (10 passes)</strong> </td><td data-label="Explanation">1. Input normalization correct. 2. Fragment concurrency deterministic. 3. Asset prep atomic. 4. HTML escape coverage. 5. Atomic write durability. 6. Temp dir cleanup robust. 7. Structured error metadata. 8. Cross-platform portability. 9. Performance scalability with large inputs. 10. Security enforcement (escape, SRI, sanitization). </td></tr><tr><td data-label="Topic"><strong>Overall Assessment</strong> </td><td data-label="Explanation"><code>core_renderer.py</code> is the single most leverageable point for enhancement. Hardening it improves reliability, performance, and security of the entire system. Enhancements here yield disproportionate benefits across the rendering pipeline. Immediate priorities: streaming assembly, atomic asset handling, structured logging, and cross-platform durability testing. </td></tr></tbody></table></div><div class="row-count">Rows: 21</div></div><div class="table-caption" id="table-2" data-table="Book_8007_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2 — core_fragments.py</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Topic**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Topic</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Explanation**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Explanation</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Topic"><strong>Overall Purpose</strong>                     </td><td data-label="Explanation">Central helper that ingests heterogeneous table-like inputs (DataFrames, lists, dicts, Markdown, HTML, files, bytes), normalizes them, extracts tables, and renders them into HTML fragments concurrently. Provides metadata (timings, assets, IDs, warnings) and ensures atomic writes. Acts as the "universal adapter" for all table sources before the final assembly.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Topic"><strong>Input Normalization & Preprocessing</strong> </td><td data-label="Explanation">- Accepts broad shapes: <code>pandas.DataFrame</code>, <code>list-of-dicts</code>, <code>list-of-lists</code>, <code>dict</code>, <code>str</code> (Markdown or HTML), <code>Path</code>/file, <code>bytes</code>. <br>- Bytes auto-decoded (UTF-8 → Latin-1 fallback). <br>- Paths read with tolerant encodings. <br>- Strings normalized with <code>_normalize_table_text</code>: NFKC Unicode normalization, BOM & zero-width stripping, dash harmonization, <code>&lt;br&gt;</code> → newline. <br>- Detects list-of-dicts/lists by structure; dict auto-wrapped. <br>- For strings: tries parser (<code>convert.parse_markdown_tables</code>) → internal Markdown pipe-table extractor → fallback render-to-HTML + extract <code>&lt;table&gt;</code>.                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Topic"><strong>Markdown & HTML Parsing</strong>             </td><td data-label="Explanation">- Markdown tables parsed with escape & inline code awareness (<code>_split_row_keep_code</code>). <br>- Divider line detection robust (<code>_is_divider_line</code>). <br>- HTML parsing: prefers BeautifulSoup; falls back to regex-based <code>&lt;table&gt;</code> extractor. <br>- Rows then converted to DataFrame if possible, else list-of-dicts or list-of-lists. <br>- This layered fallback ensures resilience across malformed Markdown/HTML.                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Topic"><strong>Rendering Strategy</strong>                  </td><td data-label="Explanation">- Primary renderer is <code>core_table.render_table</code> if available. Falls back to <code>_simple_render_table</code>. <br>- <code>_simple_render_table</code> creates <code>&lt;table&gt;</code> HTML manually if DataFrame/list-of-dicts/list-of-lists. <br>- Renderer can be callable or object with <code>.render</code>. If string input → tries <code>renderer.render</code>. <br>- Returns flexible shapes: plain string, <code>(html, assets)</code>, or <code>{&quot;html&quot;:..., &quot;assets&quot;:...}</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Topic"><strong>Concurrency Model</strong>                   </td><td data-label="Explanation">- Default: thread-based concurrency with <code>ThreadPoolExecutor</code>. <br>- Optional: <code>ProcessPoolExecutor</code>, but only if renderer is picklable and safe (checked via <code>pickle.dumps</code>). Process mode restricted to <code>_process_simple_render_job</code> + <code>_simple_render_table</code>. <br>- Each job measures <code>render_time_ms</code> and <code>write_time_ms</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Topic"><strong>Output Structure</strong>                    </td><td data-label="Explanation">- Returns <code>(fragments_map, frag_row_counts, total_rows, warnings)</code>. <br>- <code>fragments_map[idx]</code> includes: file path, HTML content, title_id, title_text, sections, assets, timings, detected_type, source, original_preview. <br>- <code>frag_row_counts[idx]</code> gives row count; <code>total_rows</code> aggregates. <br>- <code>warnings</code> capture errors, fallbacks, write failures.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Topic"><strong>Asset Detection</strong>                     </td><td data-label="Explanation">- Explicit detection from renderer return (tuple or dict). <br>- Heuristics applied on HTML: finds references to <code>xlsx.full.min.js</code>, PrismJS syntax highlighting, virtualization markers, <code>data-requires-*</code>. <br>- Produces <code>assets_required</code> list per fragment.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Topic"><strong>Unique Title Enforcement</strong>            </td><td data-label="Explanation">- Ensures <code>id</code> uniqueness across fragments (<code>Table</code>, <code>Table_2</code>, etc.). Prevents duplicate anchor collisions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Topic"><strong>Error Handling</strong>                      </td><td data-label="Explanation">- Extensive try/except wrapping. <br>- Failures logged but degraded gracefully: fragment still written with <code>&lt;p&gt;(fragment render failed)&lt;/p&gt;</code>. <br>- Warnings bubbled up for caller decision. <br>- Atomic writes with either <code>_atomic_stream_write</code> (preferred) or fallback <code>_atomic_write_text</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Topic"><strong>Performance Notes</strong>                   </td><td data-label="Explanation">- Threading avoids GIL bottlenecks since heavy tasks are mostly I/O-bound (Markdown/HTML parsing, file writes). <br>- Process mode safe only in simple cases; misconfigured picklability falls back with warning. <br>- Per-fragment timings allow profiling & tuning. <br>- Asset detection regex could be optimized, but acceptable cost.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Topic"><strong>Portability</strong>                         </td><td data-label="Explanation">- Unicode normalization ensures cross-platform reproducibility. <br>- Encoding fallbacks (UTF-8, Latin-1) improve robustness across OS locales. <br>- Avoids OS-specific syscalls (pure Python + <code>os.replace</code>). <br>- Uses <code>pathlib.Path</code> consistently.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Topic"><strong>Security Considerations</strong>             </td><td data-label="Explanation">- Unescapes HTML from user sources cautiously, but some regex parsing may mis-handle maliciously crafted HTML (e.g. <code>&lt;script&gt;</code> in table cells). <br>- Asset detection heuristics do not sanitize; relies on later rendering layers. <br>- File writes are confined to provided <code>tmp_frag_dir</code>. <br>- Logging exceptions could leak sensitive content unless log sanitization is applied.                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Topic"><strong>UX/Integration</strong>                      </td><td data-label="Explanation">- Guarantees stable output shape regardless of input weirdness. <br>- Rich metadata (<code>detected_type</code>, <code>original_preview</code>) aids debugging & UI feedback. <br>- Warnings surface user-readable context (e.g. “renderer not picklable”). <br>- Fragment granularity fits well with progressive rendering UIs (streaming tables one by one).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Topic"><strong>Actionable Recommendations</strong>          </td><td data-label="Explanation">1. <strong>Sanitize HTML</strong>: strip dangerous tags (<code>&lt;script&gt;</code>, <code>&lt;iframe&gt;</code>) before embedding. <br>2. <strong>Improve Asset Detection</strong>: maintain a whitelist/registry instead of regex scanning. <br>3. <strong>Structured Logging</strong>: emit JSON logs with table ID, type, row count for traceability. <br>4. <strong>Graceful Renderer API Contract</strong>: enforce standard <code>(html, assets)</code> output from renderer instead of permissive multiple shapes. <br>5. <strong>Parallel Scaling</strong>: allow adaptive worker count based on CPU cores + I/O load. <br>6. <strong>Unit Testing</strong>: add fuzz tests for malformed Markdown/HTML and concurrency stress tests. <br>7. <strong>Security Hardening</strong>: integrate HTML sanitizer (e.g. Bleach) before writing fragments. <br>8. <strong>Metadata Expansion</strong>: include detected column names, column types, and sample values in <code>fragments_map</code> to improve downstream use. </td></tr><tr><td data-label="Topic"><strong>Primary purpose</strong> </td><td data-label="Explanation">Normalize heterogeneous inputs, extract table data, render each table as an independent HTML fragment, write fragments atomically, and return structured metadata for downstream assembly. <br>Designed for robustness and broad input compatibility. </td></tr><tr><td data-label="Topic"><strong>Accepted input shapes</strong> </td><td data-label="Explanation">Pandas DataFrame, objects with <code>columns</code>/<code>itertuples</code>, list-of-dicts, list-of-lists, dicts, Markdown strings (pipe tables), HTML strings with <code>&lt;table&gt;</code> blocks, file paths, bytes/bytearray, and unknown objects forwarded as best-effort. </td></tr><tr><td data-label="Topic"><strong>Normalization goals</strong> </td><td data-label="Explanation">Unicode NFKC normalization. <br>Unify newlines. <br>Convert simple <code>&lt;br&gt;</code> to <code>\n</code>. <br>Remove zero-width chars and BOM. <br>Replace NBSP and en/em dashes with ASCII equivalents. <br>Collapse long hyphen runs. <br>Trim trailing spaces per line. </td></tr><tr><td data-label="Topic"><strong>Markdown pipe-table extraction</strong> </td><td data-label="Explanation">Recognizes GitHub-style pipe tables. <br>Respects escaped pipes <code>|</code> and inline code spans delimited by backticks so pipes inside code are ignored. <br>Identifies divider lines <code>:---:</code> and groups header + body rows. <br>Returns list-of-lists and header flag. </td></tr><tr><td data-label="Topic"><strong>HTML table extraction</strong> </td><td data-label="Explanation">Prefers BeautifulSoup when available for robust parsing. <br>Falls back to best-effort regex that extracts <code>&lt;table&gt;</code>, <code>&lt;tr&gt;</code>, <code>&lt;td&gt;</code> and <code>&lt;th&gt;</code>. <br>Preserves <code>&lt;br&gt;</code> as newline, strips other tags, unescapes HTML entities. <br>Returns rows + header flag. </td></tr><tr><td data-label="Topic"><strong>Conversion to dataframe-like</strong> </td><td data-label="Explanation">Attempts to create a pandas.DataFrame if pandas is importable. <br>If pandas not available or conversion fails, returns list-of-dicts for header tables, otherwise list-of-lists. <br>Padding/truncation applied to make rows uniform when creating dicts. </td></tr><tr><td data-label="Topic"><strong>Rendering delegation</strong> </td><td data-label="Explanation">Primary: calls <code>core_table.render_table</code> with flexible signature attempts. <br>Secondary: if renderer object has <code>.render</code>, uses it for string inputs. <br>Fallback: <code>_simple_render_table</code> that generates safe minimal HTML. <br>Accepts renderer returns as <code>str</code>, <code>(html, assets)</code>, or <code>{&quot;html&quot;:..., &quot;assets&quot;:...}</code>. </td></tr><tr><td data-label="Topic"><strong>Per-fragment asset detection</strong> </td><td data-label="Explanation">Aggregates assets returned by renderer. <br>Applies heuristics scanning fragment HTML for markers: <code>xlsx</code>/<code>sheetjs</code>, <code>class=&quot;language-...&quot;</code> for syntax highlighting, <code>data-virtualize</code>, and <code>data-requires-&lt;name&gt;</code> tags. <br>Deduplicates asset list. </td></tr><tr><td data-label="Topic"><strong>Atomic writes</strong> </td><td data-label="Explanation">Writes fragment files as <code>frag_{idx}.html</code> in <code>tmp_frag_dir</code>. <br>Uses <code>_atomic_stream_write</code> if available; otherwise writes to <code>.tmp</code> then <code>os.replace</code>. <br>Records write time (ms) for each fragment. </td></tr><tr><td data-label="Topic"><strong>Concurrency model</strong> </td><td data-label="Explanation">Default: <code>ThreadPoolExecutor</code>. <br>Optional: <code>ProcessPoolExecutor</code> when <code>use_process=True</code> and renderer is picklable. <br>Process mode restricted to simple picklable render path (<code>_process_simple_render_job</code>) to avoid non-picklable renderer objects. <br><code>max_workers</code> controls parallelism and is bounded by input size. </td></tr><tr><td data-label="Topic"><strong>Job lifecycle</strong> </td><td data-label="Explanation">Each job <code>_render_job</code> performs: render timing, capture HTML, parse assets, atomic write, collect warnings, return metadata. <br>Thread futures are awaited via <code>as_completed</code> to stream results. </td></tr><tr><td data-label="Topic"><strong>Unique title id enforcement</strong> </td><td data-label="Explanation">Extracts <code>&lt;h3 id=&quot;...&quot;&gt;</code> from fragment content. <br>If missing uses <code>Table{idx}</code>. <br>Enforces uniqueness via <code>_ensure_unique_title_id</code> which appends counters to duplicates. </td></tr><tr><td data-label="Topic"><strong>Fragment metadata produced</strong> </td><td data-label="Explanation">For each idx returns: <code>path</code>, <code>content</code>, <code>title_id</code>, <code>title_text</code>, <code>sections</code>, <code>assets_required</code>, <code>render_time_ms</code>, <code>write_time_ms</code>, <code>detected_type</code>, <code>source</code>, <code>original_preview</code>. <br>Also returns <code>frag_row_counts</code>, <code>total_rows</code>, and <code>warnings</code>. </td></tr><tr><td data-label="Topic"><strong>Sections extraction</strong> </td><td data-label="Explanation">Scans for <code>&lt;div class=&quot;section-heading&quot; id=&quot;...&quot;&gt;</code> blocks to populate <code>sections</code> as tuples <code>(id, text)</code>. <br>This is a flexible hook for richer fragment structure. </td></tr><tr><td data-label="Topic"><strong>Row counting heuristic</strong> </td><td data-label="Explanation">Counts <code>&lt;tr</code> inside <code>&lt;tbody&gt;</code> if present; otherwise counts <code>&lt;tr</code> across content. <br>Best-effort; may overcount nested rows in complex HTML. </td></tr><tr><td data-label="Topic"><strong>Error handling & warnings</strong> </td><td data-label="Explanation">Extensive try/except at every stage. <br>Collects structured warnings like <code>{&quot;level&quot;:&quot;error&quot;,&quot;msg&quot;: &quot;...&quot;, &quot;table&quot;: idx}</code>. <br>Logs stack traces with <code>logger.exception</code>. <br>On render failure returns safe placeholder HTML and attempts atomic write. </td></tr><tr><td data-label="Topic"><strong>Process pool picklability check</strong> </td><td data-label="Explanation">Performs <code>pickle.dumps(renderer)</code> to test picklability before enabling process mode. <br>If fails, falls back to threads and appends a warning. </td></tr><tr><td data-label="Topic"><strong>Performance considerations</strong> </td><td data-label="Explanation">Threads work well for I/O and light CPU tasks. <br>Process mode good for CPU heavy simple rendering but restricted. <br>Normalization and BeautifulSoup parsing are CPU-bound for large inputs. <br>Timing metrics per fragment enable hotspots analysis. </td></tr><tr><td data-label="Topic"><strong>Security considerations</strong> </td><td data-label="Explanation">Normalization reduces control chars but does not sanitize HTML fully. <br>Fragment content often includes rendered HTML; caller must sanitize before assembly or trust renderer. <br>Atomic writes mitigate partial-file exposure but do not alter filesystem permissions. <br>Recommend performing HTML sanitization when source is untrusted. </td></tr><tr><td data-label="Topic"><strong>Portability</strong> </td><td data-label="Explanation">Uses only stdlib concurrency and <code>os.replace</code> for atomic swap which is supported cross-platform. <br>Optional dependencies (pandas, bs4) degrade gracefully. <br>Process mode constraints take platform pickling behaviors into account. </td></tr><tr><td data-label="Topic"><strong>Extensibility hooks</strong> </td><td data-label="Explanation">- plug optional <code>convert.parse_markdown_tables</code> for advanced parsing. <br>- accept custom renderer objects with <code>.render</code>. <br>- detect custom <code>data-requires-*</code> assets. <br>- allow external <code>_atomic_stream_write</code> from <code>io_utils</code>. </td></tr><tr><td data-label="Topic"><strong>Limitations & known blind spots</strong> </td><td data-label="Explanation">- Regex-based HTML extraction can miss malformed markup. <br>- Row counting is heuristic and may miscount complex tables. <br>- Process pool cannot use non-picklable renderers. <br>- Asset heuristics are conservative and may need explicit mapping for new tools. </td></tr><tr><td data-label="Topic"><strong>Observability & telemetry</strong> </td><td data-label="Explanation">Per-fragment <code>render_time_ms</code> and <code>write_time_ms</code> available. <br><code>warnings</code> list reported to caller. <br>Recommend exposing aggregate metrics: fragments/sec, avg render ms, write failures. </td></tr><tr><td data-label="Topic"><strong>Testing recommendations</strong> </td><td data-label="Explanation">Unit tests for: normalization edge cases, escaped pipes and inline code, divider detection, bs4 vs regex parity, pandas and non-pandas conversions, atomic write fallback, thread concurrency behavior, process fallback path, asset detection heuristics, unique ID enforcement, and warning propagation. <br>Fuzz tests with malformed HTML/Markdown to ensure resilience. </td></tr><tr><td data-label="Topic"><strong>Actionable improvements</strong> </td><td data-label="Explanation">1) Broaden fragment row detection to accept <code>&lt;table&gt;&lt;tr&gt;</code> without <code>&lt;tbody&gt;</code>. <br>2) Add optional BeautifulSoup-based fallback when regex fails. <br>3) Make HTML sanitization explicit step or require sanitizer injection. <br>4) Expose per-job context logging (input index, source) for easier tracing. <br>5) Provide configurable caps on string lengths to prevent OOM on adversarial inputs. </td></tr><tr><td data-label="Topic"><strong>Deployment & rollout plan</strong> </td><td data-label="Explanation">1) Add unit and integration tests for all extraction paths. <br>2) Ship with threads-only default. <br>3) Introduce process mode behind opt-in flag after canary testing. <br>4) Monitor warnings and temp-frag dir artifacts. <br>5) Iterate on heuristic asset detection based on telemetry. </td></tr><tr><td data-label="Topic"><strong>Compatibility & migration notes</strong> </td><td data-label="Explanation">Backwards compatible: preserves existing renderer signatures via layered fallbacks. <br>When tightening sanitization or adding caps, add opt-in flags to avoid breaking downstream workflows. </td></tr><tr><td data-label="Topic"><strong>Operational guidance</strong> </td><td data-label="Explanation">Ensure <code>tmp_frag_dir</code> is on same filesystem as final output when moving fragments. <br>Watch for leftover <code>.tmp</code> files and <code>.frags_*</code> dirs after crashes and implement cleanup job. <br>Provide adequate disk quotas for large batch renders. </td></tr><tr><td data-label="Topic"><strong>Verification checklist (10 focused checks performed)</strong> </td><td data-label="Explanation">1) Confirm <code>_normalize_table_text</code> handles NFKC, line endings, <code>&lt;br&gt;</code> variants, NBSP, zero-width chars, and dash replacements. <br>2) Validate <code>_split_row_keep_code</code> respects backtick spans and <code>|</code> escapes. <br>3) Test <code>_is_divider_line</code> against valid and invalid divider patterns. <br>4) Compare bs4-based extraction to regex extraction for representative HTML samples. <br>5) Verify <code>_convert_rows_to_df_like</code> returns DataFrame when pandas present and fallbacks otherwise. <br>6) Ensure <code>_simple_render_table</code> handles DataFrame, list-of-dicts, iterators, and error fallbacks. <br>7) Confirm atomic write path uses <code>_atomic_stream_write</code> when available and <code>.tmp</code> fallback otherwise. <br>8) Test thread pool path for correctness and that <code>as_completed</code> collects results reliably. <br>9) Exercise <code>use_process=True</code> with picklable renderer and with non-picklable renderer to confirm safe fallback and warnings. <br>10) Verify produced <code>fragments_map</code> contains required metadata keys and unique <code>title_id</code> enforcement. </td></tr><tr><td data-label="Topic"><strong>Acceptance criteria</strong> </td><td data-label="Explanation">- Robust parsing across Markdown and HTML inputs. <br>- No unhandled exceptions propagate from fragment rendering. <br>- Fragments written atomically and metadata complete. <br>- Process mode used only when safe. </td></tr><tr><td data-label="Topic"><strong>Final summary</strong> </td><td data-label="Explanation"><code>core_fragments.py</code> is a resilient, pragmatic fragment renderer. <br>It balances broad input support with defensive fallbacks. <br>Key next steps: formalize sanitization, tighten row detection, add resource caps, and add observability for production monitoring. </td></tr></tbody></table></div><div class="row-count">Rows: 45</div></div><div class="table-caption" id="table-3" data-table="Book_8007_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3 — core_assets.py</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Topic**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Topic</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Explanation**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Explanation</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Topic"><strong>Overall Role of <code>core_assets.py</code></strong>            </td><td data-label="Explanation">This module is the <strong>asset lifecycle manager</strong> for the rendering subsystem. Its responsibilities: locate source assets (<code>style.css</code>, <code>script.js</code>, <code>worker.js</code>), copy them safely into the output folder, generate optional manifest and integrity metadata, and provide helper functions to embed or reference these assets in final HTML. It is the “bridge” between raw asset files and the rendered product. Conceptually, it ensures resilience (no missing assets), safety (atomic writes), and optional advanced features (fingerprinting, SRI).                                                                                                                </td></tr><tr><td data-label="Topic"><strong>Atomic Safety (Writes & Copies)</strong>             </td><td data-label="Explanation">The file heavily invests in <strong>atomic write strategies</strong> to avoid corruption when writing to disk. It uses <code>NamedTemporaryFile</code> and <code>os.replace</code> semantics to ensure either the old file or the new file is valid, never half-written. It prefers <code>core_io</code> helpers when available, falling back to its own implementations otherwise. This is crucial in multi-threaded or crash-prone environments. Enhancement: add logging when falling back, and metrics on how often fallback path is used.                                                                                                                                                                      </td></tr><tr><td data-label="Topic"><strong>Non-Destructive Copying</strong>                     </td><td data-label="Explanation">Copying policies are conservative. Non-empty existing assets are preserved unless <code>force_copy</code> is explicitly enabled. This avoids overwriting user-customized or previously cached assets. However, it still allows forced replacement for scenarios where updates are required. This policy balances safety (don’t overwrite without consent) with flexibility (override when necessary). Enhancement: track skipped files in manifest for diagnostic transparency.                                                                                                                                                                                                  </td></tr><tr><td data-label="Topic"><strong>Fallback Placeholders</strong>                       </td><td data-label="Explanation">For core assets (<code>style.css</code>, <code>script.js</code>, <code>worker.js</code>, <code>overrides.css</code>), the system guarantees non-empty files. If originals are missing, placeholders are written (≥10 bytes). This avoids runtime errors from missing files and ensures the HTML renderer always has something to reference. Placeholders are minimal but syntactically correct. Enhancement: support environment-variable–based placeholders (e.g., organization-provided standard fallback).                                                                                                                                                                                                     </td></tr><tr><td data-label="Topic"><strong>Hashing & SRI (Subresource Integrity)</strong>       </td><td data-label="Explanation">Provides <code>compute_sri</code> which generates cryptographic hashes (sha384 by default, base64-encoded) for HTML integrity attributes. This bolsters <strong>security</strong> by letting browsers verify assets weren’t tampered with. This feature is optional but aligns with modern best practices. Enhancement: allow multiple algorithms (sha256+sha384+sha512 simultaneously) for maximum browser compatibility. Also add verification mode that cross-checks downloaded assets.                                                                                                                                                                                                    </td></tr><tr><td data-label="Topic"><strong>Fingerprinting Assets</strong>                       </td><td data-label="Explanation">Optional fingerprinting renames assets by embedding a short hash (default length 12) before extension, e.g., <code>script.abcdef123456.js</code>. This is a <strong>cache-busting mechanism</strong>: when the file changes, filename changes, so stale browser caches are avoided. The feature is opt-in, controlled by cfg flags. Enhancement: make fingerprint strategy pluggable (support hash+mtime hybrid, or content hash prefix).                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Topic"><strong>Candidate Asset Discovery</strong>                   </td><td data-label="Explanation"><code>_discover_candidate_asset_dirs</code> checks several standard locations: repo root <code>assets/</code>, cwd <code>assets/</code>, sibling package directories. This allows flexibility in how projects are structured. Enhancement: support environment variables (<code>ASSETS_PATH</code>) and explicit search paths from configuration, increasing portability across unusual project layouts.                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Topic"><strong>Copy Policy: Whitelist, Blacklist, Max Size</strong> </td><td data-label="Explanation">The system ensures large files are not copied unless explicitly whitelisted. Blacklist/whitelist patterns (fnmatch) allow fine-grained control over inclusion. This prevents bloat (e.g., <code>.map</code> files) and provides predictable packaging. Enhancement: provide warnings (not just logs) if critical expected assets are skipped due to blacklist/size rules, to reduce silent misconfiguration.                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Topic"><strong>Manifest Generation</strong>                         </td><td data-label="Explanation"><code>write_assets_manifest</code> creates a JSON manifest recording filenames, size, mtime, and SRI values. If fingerprinting is enabled, it also includes a mapping from logical names → physical names. This is critical for <strong>traceability, reproducibility, and cache control</strong>. Enhancement: manifest could include build metadata (tool version, git commit hash, environment info) for stronger reproducibility guarantees.                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Topic"><strong>Asset Info Diagnostics</strong>                      </td><td data-label="Explanation">Separate lightweight <code>assets-info.json</code> is always written, capturing list of files, sizes, mtimes, and whether assets were written in this run. This diagnostic log aids debugging without breaking the workflow. Enhancement: unify info + manifest into a richer single artifact, while keeping lightweight mode available.                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Topic"><strong>Logical Asset Resolution</strong>                    </td><td data-label="Explanation"><code>resolve_asset_name</code> maps a logical asset (<code>script.js</code>) to actual physical filename (with hash if fingerprinted). It first checks manifest, then falls back to direct presence, then heuristic prefix-suffix matching. This flexibility prevents runtime errors. Enhancement: support regex-based fallback matching for more robust detection.                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Topic"><strong>Overrides CSS</strong>                               </td><td data-label="Explanation">Provides <code>write_overrides_css</code>, generating an <code>overrides.css</code> that adjusts layout (left/right column widths, sticky headers, dark mode). This ensures consistent UX even without project-provided CSS. Enhancements: support theming tokens from cfg (colors, spacing, fonts). Could auto-detect dark mode preference and inject alternative CSS blocks.                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Topic"><strong>Inline Fallback Helpers</strong>                     </td><td data-label="Explanation">Functions like <code>inline_style_fallback</code> and <code>inline_script_fallback</code> allow embedding fallback CSS/JS directly into HTML. This improves resilience (HTML still works even if assets not loaded). Enhancement: automatically minify inline text before embedding to reduce payload.                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Topic"><strong>Security Considerations</strong>                     </td><td data-label="Explanation">Strengths: integrity hashes, non-empty file guarantee, conservative copy policies. Weaknesses: reliance on <code>os.replace</code> (atomic but platform-specific edge cases), no explicit sandboxing of asset content (a malicious local asset could be copied unmodified). Enhancement: validate content types (e.g., refuse to inline binary data in script tag). Add optional signature verification (signed manifests).                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Topic"><strong>Performance Considerations</strong>                  </td><td data-label="Explanation">Strengths: avoids redundant copying (skips existing files), uses streaming for large copies, computes hashes incrementally. Weaknesses: computing SRI and fingerprint hashes for very large assets may be expensive. Enhancement: add caching of computed hashes between runs (based on mtime+size). Parallelize copy operations across multiple files if thread-safety ensured.                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Topic"><strong>Portability Considerations</strong>                  </td><td data-label="Explanation">Module already attempts cross-platform safety by using Python stdlib primitives (<code>os.replace</code>, <code>tempfile</code>, <code>shutil</code>). Enhancement: add Windows-specific long-path handling (<code>\\\\?\\</code> prefix) for >260 char paths. Add macOS extended attribute cleanup when copying files (strip <code>com.apple.quarantine</code> flags).                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Topic"><strong>UX Considerations</strong>                           </td><td data-label="Explanation">The system is defensive: users always end up with assets present, even if placeholders. Logs are info-level and explanatory. Enhancements: provide human-readable HTML error page if required assets are missing (instead of just placeholder CSS/JS). Allow end-users to customize placeholder banners (e.g., watermark if assets missing).                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Topic"><strong>CLI/Test Harness</strong>                            </td><td data-label="Explanation"><code>_demo_run</code> provides a minimal CLI demo that shows asset preparation in a temp dir, with manifest printing. This is useful for debugging. Enhancement: expand CLI to include options like <code>--generate-manifest</code>, <code>--fingerprint</code>, <code>--diagnose</code>, making it usable outside developer workflows.                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Topic"><strong>Failure Mode Analysis</strong>                       </td><td data-label="Explanation">- If asset discovery fails → placeholders ensure continuity. <br>- If atomic copy fails → logs debug, continues, placeholders step in. <br>- If manifest generation fails → silently skipped, non-critical. <br>- If permissions prevent writes → logs debug, continues, may leave missing asset. <br><strong>Enhancement</strong>: escalate failures to warnings or exceptions when in “strict” mode, controlled by cfg flag.                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Topic"><strong>Design Strengths</strong>                            </td><td data-label="Explanation">- Clear layering: low-level atomic ops → higher-level safe write → manifest/fallback logic → public API. <br>- Opt-in advanced features, preserving backward compatibility. <br>- Resilient against missing files or misconfiguration.                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Topic"><strong>Design Weaknesses</strong>                           </td><td data-label="Explanation">- Silent failures: logs only at debug/info, no surfacing to higher layers. <br>- Limited configuration extensibility (no environment variable search paths, no plugin hooks). <br>- Fallbacks are minimalistic, not user-informative.                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Topic"><strong>Actionable Recommendations (Summary)</strong>        </td><td data-label="Explanation">1. <strong>Expose strict mode</strong> (fail on missing assets instead of silently continuing). <br>2. <strong>Hash caching</strong> to accelerate repeated builds. <br>3. <strong>Extended manifest</strong> including build metadata. <br>4. <strong>Pluggable fingerprint strategies</strong>. <br>5. <strong>Configurable placeholder theming</strong> (colors, fonts, warnings). <br>6. <strong>Parallel copy optimization</strong> for large asset sets. <br>7. <strong>Better logging surface</strong> (warn on skipped large/blacklisted assets). <br>8. <strong>Environment variable–based asset paths</strong> for portability. <br>9. <strong>Signature-based verification</strong> for high-trust scenarios. <br>10. <strong>CLI expansion</strong> to serve as standalone asset prep tool. </td></tr></tbody></table></div><div class="row-count">Rows: 22</div></div><div class="table-caption" id="table-4" data-table="Book_8007_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4 — core_table.py</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Topic**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Topic</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Detailed Explanation**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Detailed Explanation</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Topic"><strong>File Purpose</strong> </td><td data-label="Detailed Explanation"><code>core_table.py</code> transforms messy, heterogeneous Python table inputs into safe, interactive HTML table fragments.<br>- Normalizes input shapes (DataFrame, to_pandas, list-of-dicts, list-of-lists, iterables).<br>- Preserves code fences and inline code. <br>- Emits metadata and optional features (lazy load, exports, sticky headers). </td></tr><tr><td data-label="Topic"><strong>Primary responsibilities</strong> </td><td data-label="Detailed Explanation">- Coerce inputs to <code>(rows, header)</code>. <br>- Render header controls, table markup, and metadata scripts. <br>- Provide export helpers for CSV, JSON, XLSX. <br>- Preserve backward-compatibility with <code>pandas.DataFrame.to_html</code> when appropriate. </td></tr><tr><td data-label="Topic"><strong>Accepted inputs & integration points</strong> </td><td data-label="Detailed Explanation">- Pandas DataFrame (if present). <br>- Objects implementing <code>to_pandas()</code>. <br>- <code>list[dict]</code>, <code>list[list]</code>, and generic iterables. <br>- Optional <code>markdown_to_html</code> callable or object with <code>.render()</code>. <br>- Per-table <code>_tv_options</code> metadata is respected and emitted as <code>data-tv-*</code> attributes. </td></tr><tr><td data-label="Topic"><strong>Normalization strategy</strong> </td><td data-label="Detailed Explanation">- <code>to_pandas()</code> attempt first when present. <br>- If pandas DataFrame, convert to rows + header. <br>- list-of-dicts preserves first dict key order as header. <br>- list-of-lists uses first row as header only when first row consists entirely of strings and >1 row. <br>- Final fallback coerces iterable items to lists. </td></tr><tr><td data-label="Topic"><strong>Code fence & inline-code preservation</strong> </td><td data-label="Detailed Explanation">- Stashes fenced code blocks and inline code into stable placeholders prior to markdown processing. <br>- Restores placeholders after rendering so code content remains intact and unescaped. <br>- Prevents accidental table splitting when code contains pipe characters. </td></tr><tr><td data-label="Topic"><strong>Protection of underscores and pipes</strong> </td><td data-label="Detailed Explanation">- Converts underscores and pipe characters outside placeholders into HTML entities before markdown rendering to avoid accidental interpretation. <br>- Restores protection entities after rendering. <br>- Ensures that textual underscores and pipes are not treated as markdown syntax. </td></tr><tr><td data-label="Topic"><strong>Markdown callable handling</strong> </td><td data-label="Detailed Explanation">- <code>_get_md_callable</code> returns a safe callable: uses provided <code>markdown_to_html</code> or <code>.render()</code> when available; defaults to <code>html.escape</code>. <br>- Any failure in markdown rendering falls back to escaping, preventing injection. </td></tr><tr><td data-label="Topic"><strong>Cell rendering pipeline</strong> </td><td data-label="Detailed Explanation">Steps per cell: stash code → protect underscores/pipes → call markdown renderer → restore protection entities → restore code placeholders → sanitize (if available) → cap overly large cell HTML.<br>- Large content is truncated with a suffix. <br>- Sanitization invoked if <code>sanitize_html</code> present, with <code>allow_tables</code> attempted where supported. </td></tr><tr><td data-label="Topic"><strong>Sanitization semantics</strong> </td><td data-label="Detailed Explanation">- If <code>sanitize_html</code> exists, used to clean rendered HTML.<br>- The module inspects the sanitizer signature to call <code>allow_tables=True</code> if supported. <br>- If sanitizer fails, falls back to escaping to preserve safety. </td></tr><tr><td data-label="Topic"><strong>Diagram & RTL detection</strong> </td><td data-label="Detailed Explanation">- <code>_is_diagram_text</code> heuristic detects ASCII/box-drawing diagrams to apply <code>cell-diagram</code> class. <br>- <code>_detect_rtl_chars</code> detects RTL scripts and sets <code>dir=&quot;rtl&quot;</code> on cells for correct rendering. </td></tr><tr><td data-label="Topic"><strong>Column alignment detection</strong> </td><td data-label="Detailed Explanation">- <code>_get_table_alignments</code> reads <code>_table_alignments</code> or <code>alignments</code> attributes from upstream objects when present. <br>- Alignments are emitted as <code>data-align</code> and inline <code>style=&quot;text-align:...&quot;</code> for robust fallback across CSS/JS conditions. </td></tr><tr><td data-label="Topic"><strong>Column type detection (optional)</strong> </td><td data-label="Detailed Explanation">- <code>_detect_column_types</code> samples rows (bounded by <code>_COLUMN_TYPE_SAMPLE</code>) and uses heuristics (<code>_guess_value_type</code>) to classify: numeric, datetime, code, diagram, boolean, text, html, json. <br>- Types normalized so integer/float become <code>numeric</code>. <br>- Emitted as <code>data-col-type</code> and cell classes to enable client behaviors (sorting, formatting). </td></tr><tr><td data-label="Topic"><strong>Uniform-row enforcement</strong> </td><td data-label="Detailed Explanation">- <code>_ensure_uniform_rows</code> pads shorter rows with empty strings and trims rows exceeding max columns. <br>- Prevents jagged tables that break CSS/JS assumptions. <br>- Trimming occurs with warnings when safety caps reached. </td></tr><tr><td data-label="Topic"><strong>Row and column safety caps</strong> </td><td data-label="Detailed Explanation">- <code>_MAX_ROWS_SAFE_RENDER</code>, <code>_MAX_COLS_SAFE</code>, and <code>_MAX_CELL_HTML</code> guard against pathological inputs. <br>- Warnings logged when caps are approached or exceeded. <br>- Design chooses graceful degradation over hard failures. </td></tr><tr><td data-label="Topic"><strong>Wrapper and heading structure</strong> </td><td data-label="Detailed Explanation">- Renders a wrapper <code>&lt;div class=&quot;table-wrapper&quot;&gt;</code> containing: hidden anchor for navigation, visible heading bar, header controls, table container, optional lazy chunk script, footer row count, and table metadata script. <br>- Table has <code>role=&quot;table&quot;</code> and <code>aria-labelledby</code> referencing the visible heading for screen reader support. </td></tr><tr><td data-label="Topic"><strong>Hidden anchors & heading bar</strong> </td><td data-label="Detailed Explanation">- Hidden <code>&lt;a&gt;</code> anchors are emitted per table for navigation. <br>- <code>_heading_init_script</code> builds a top navigation bar of table links client-side in an idempotent manner. <br>- Script avoids duplication when DOM already assembled. </td></tr><tr><td data-label="Topic"><strong>One-time asset emission & client JS/CSS</strong> </td><td data-label="Detailed Explanation">- <code>_one_time_assets</code> returns CSS and JS idempotently emitted once per page (guarded by <code>_ASSETS_EMITTED</code> and <code>emit_assets_once</code> option). <br>- JS implements binding logic: exports, copy, lazy-load, collapse/expand. <br>- Designed to be non-opinionated and defensive (errors logged to console). </td></tr><tr><td data-label="Topic"><strong>Header controls & interactivity</strong> </td><td data-label="Detailed Explanation">- Buttons included: Copy Plain, Copy Markdown, Export CSV, Export JSON, Export XLSX, Collapse Table. <br>- Buttons are annotated with <code>data-action</code> attributes which the client JS binds to. <br>- Export XLSX requires SheetJS on the page; otherwise falls back to CSV. </td></tr><tr><td data-label="Topic"><strong>Accessibility features</strong> </td><td data-label="Detailed Explanation">- <code>aria-label</code> on heading bar and <code>aria-labelledby</code> on table. <br>- Heading links generated with focusable anchors. <br>- Buttons include <code>title</code>/<code>aria-label</code> where appropriate. <br>- Room for improvement: add <code>th scope=&quot;row&quot;</code> for row headers, expose live-region feedback for copy/export success, and provide keyboard-only affordances for all controls. </td></tr><tr><td data-label="Topic"><strong>Body rendering details</strong> </td><td data-label="Detailed Explanation">- Table head built from <code>header_htmls</code> generated by <code>_render_cell_text</code>. <br>- Each header cell includes a sort button with accessible label. <br>- <code>td</code> cells include <code>data-label</code> for responsive layouts, optional classes for type/diagram, <code>dir</code> attribute for directionality, and inline alignment. </td></tr><tr><td data-label="Topic"><strong>Lazy-loading strategy</strong> </td><td data-label="Detailed Explanation">- If <code>lazy_load_threshold</code> is set and rows exceed it, renderer outputs <code>initial_rows</code> and serializes remaining rows into a JSON chunk embedded as <code>&lt;script type=&quot;application/json&quot; class=&quot;table-row-chunk&quot;&gt;</code>. <br>- Client JS appends those rows when user triggers Load More. <br>- <code>_safe_json_for_script</code> escapes <code>&lt;/</code> sequences to avoid closing the script tag prematurely. </td></tr><tr><td data-label="Topic"><strong>Lazy chunk tradeoffs</strong> </td><td data-label="Detailed Explanation">- Pros: reduces initial DOM size, improves first paint. <br>- Cons: embeds possibly large JSON into HTML which increases page weight and memory usage. <br>- Recommendation: for very large datasets replace inline chunk with a deferred fetch endpoint returning JSON. </td></tr><tr><td data-label="Topic"><strong>Export helpers (server-side)</strong> </td><td data-label="Detailed Explanation">- <code>_rows_to_csv_bytes</code> creates CSV bytes with quoted cells and CRLF line endings. <br>- <code>_rows_to_json_bytes</code> serializes rows as list-of-objects when header present else list-of-lists. <br>- <code>_rows_to_xlsx_bytes</code> uses <code>xlsxwriter</code> or falls back to <code>openpyxl</code>. <br>- Functions return bytes ready for HTTP response. </td></tr><tr><td data-label="Topic"><strong>Simple render fallback</strong> </td><td data-label="Detailed Explanation">- <code>simple_render_table</code> returns a minimal <code>&lt;table&gt;</code> or <code>df.to_html</code> fallback. <br>- Useful for process-based simple rendering or when full features not available. </td></tr><tr><td data-label="Topic"><strong>Fragment rendering wrapper</strong> </td><td data-label="Detailed Explanation">- <code>render_fragment</code> sets <code>fragment=True</code> and disables asset injection by default. <br>- Ensures fragments are compact and do not re-emit one-time assets. </td></tr><tr><td data-label="Topic"><strong>Error handling & graceful degradation</strong> </td><td data-label="Detailed Explanation">- Extensive try/except around parsing, rendering, sanitization, and serialization. <br>- Failures produce escaped fallback content and logged debug messages, not crashes. <br>- Metadata embed still attempted even on partial failures to aid debugging. </td></tr><tr><td data-label="Topic"><strong>Security posture</strong> </td><td data-label="Detailed Explanation">- Defaults: escape everything, sanitize when available, safe JSON embedding. <br>- Risks: relies on external sanitizer and markdown callable; improper sanitizer or unsafe markdown renderers can expose XSS. <br>- Mitigations: enforce sanitizer usage in strict mode, cap cell sizes, and always escape as final fallback. </td></tr><tr><td data-label="Topic"><strong>Performance considerations</strong> </td><td data-label="Detailed Explanation">- Uses list append + <code>&#x27;&#x27;.join</code> for efficient string assembly. <br>- Captures rendering time when <code>debug</code> option set. <br>- Heavy operations: markdown rendering, sanitization, XLSX generation, and large JSON embedding. <br>- Recommendations: enable streaming for extremely large tables; offload XLSX generation to background worker for large exports. </td></tr><tr><td data-label="Topic"><strong>Portability & dependencies</strong> </td><td data-label="Detailed Explanation">- Pure-Python core with optional third-party libs: <code>pandas</code>, <code>xlsxwriter</code>, <code>openpyxl</code>. <br>- Works across Linux, macOS, Windows. <br>- Export bytes default to UTF-8 to ensure cross-platform interoperability. </td></tr><tr><td data-label="Topic"><strong>Observability & logging</strong> </td><td data-label="Detailed Explanation">- Logs debug-level details for recoverable errors and warnings for safety cap triggers. <br>- When <code>debug</code> enabled, render time is included in embedded metadata. <br>- Recommendation: emit structured JSON logs (table_id, rows, cols, warnings) to integrate with monitoring. </td></tr><tr><td data-label="Topic"><strong>Testing & verification matrix</strong> </td><td data-label="Detailed Explanation">- Unit tests: <code>_rows_from_iterable</code> (all shapes), <code>_render_cell_text</code> (stash/restore), sanitize present/absent behavior, alignment detection. <br>- Integration tests: render_table with lazy chunks, export generation, fragment mode, header-bar assembly. <br>- Security tests: XSS payloads in headers/cells and chunk blobs. <br>- Performance tests: very wide and deep tables against caps. </td></tr><tr><td data-label="Topic"><strong>Accessibility testing</strong> </td><td data-label="Detailed Explanation">- Automated checks (axe-core) for heading bar, ARIA attributes, tab order. <br>- Manual keyboard-only navigation tests for copy/export/collapse. <br>- Screen reader pass to confirm table heading and row-count announcements. </td></tr><tr><td data-label="Topic"><strong>Extensibility & customization points</strong> </td><td data-label="Detailed Explanation">- Pluggable markdown callable and sanitizer. <br>- <code>tv_options</code> allows per-table metadata and data-* attributes. <br>- Options dict toggles features. <br>- Suggested hooks: per-column formatter functions, custom export backends, deferred chunk URL generator. </td></tr><tr><td data-label="Topic"><strong>UX recommendations</strong> </td><td data-label="Detailed Explanation">- Show inline success/failure toast for copy/export. <br>- Localize button labels and tooltips. <br>- Make collapse state persistent via <code>data-tv-*</code> or localStorage. <br>- Add client-side search/filter inputs in the header bar. </td></tr><tr><td data-label="Topic"><strong>Security hardening recommendations</strong> </td><td data-label="Detailed Explanation">- Offer a strict mode that enforces sanitizer presence and rejects unsafe markdown renderers. <br>- Harden <code>_safe_json_for_script</code> and test with edge-case payloads. <br>- Consider stripping <code>on*</code> attributes post-render as extra safety layer. </td></tr><tr><td data-label="Topic"><strong>Performance hardening recommendations</strong> </td><td data-label="Detailed Explanation">- Replace embedded large JSON with an async fetch endpoint for huge datasets. <br>- Cache column type detection results when inputs are stable. <br>- Offload XLSX generation to async background job for very large exports. </td></tr><tr><td data-label="Topic"><strong>Accessibility hardening recommendations</strong> </td><td data-label="Detailed Explanation">- Add <code>scope=&quot;row&quot;</code> on row header cells when row headers exist. <br>- Add <code>aria-live</code> for dynamic row counts and export completion messages. <br>- Add keyboard shortcuts for export and copy. </td></tr><tr><td data-label="Topic"><strong>Deployment and rollout plan</strong> </td><td data-label="Detailed Explanation">1) Add unit and integration tests covering core behavior and edge cases.<br>2) Introduce runtime-configurable caps (rows, cols, cell size) to allow safe tuning per deployment.<br>3) Release a minor version with new features behind flags so default behavior is unchanged.<br>4) Monitor logs and error telemetry for unexpected warnings or sanitizer failures.<br>5) Implement streaming/deferred chunk patterns in a subsequent release and document migration. </td></tr><tr><td data-label="Topic"><strong>Verification checklist (10 focused passes)</strong> </td><td data-label="Detailed Explanation">1) Validate <code>_rows_from_iterable</code> with all input shapes. <br>2) Confirm code fence stash/restore roundtrip preserves content. <br>3) Verify sanitizer present/absent behavior yields safe output. <br>4) Test lazy chunk JSON embedding and client append. <br>5) Generate CSV/JSON/XLSX outputs and open them in common tools. <br>6) Confirm column type detection on numeric/datetime/text/code samples. <br>7) Run RTL/diagram detection on representative inputs. <br>8) Ensure safety caps log warnings and prevent OOM. <br>9) Run accessibility checks (axe) on rendered markup. <br>10) Stress test with near-capacity datasets for memory/cpu behavior. </td></tr><tr><td data-label="Topic"><strong>Acceptance criteria</strong> </td><td data-label="Detailed Explanation">- Rendered HTML is well-formed and safe for embedding. <br>- No unescaped user-supplied HTML leaks when sanitizer not present. <br>- Lazy chunk JSON is syntactically safe and client-side loader appends rows correctly. <br>- Export helpers produce valid files. <br>- Backward compatibility preserved for existing consumers. </td></tr><tr><td data-label="Topic"><strong>Risks & mitigation</strong> </td><td data-label="Detailed Explanation">- Risk: unsafe markdown/sanitizer combo → mitigate via strict mode. <br>- Risk: embedded large JSON bloat → mitigate with deferred fetch. <br>- Risk: XLSX libs unavailable → fallback to CSV and log. <br>- Risk: exotic iterable shapes not handled → add long-tail test cases and fuzzing. </td></tr><tr><td data-label="Topic"><strong>Actionable next steps</strong> </td><td data-label="Detailed Explanation">1) Expose caps as runtime options. <br>2) Add strict sanitizer mode and validate integration. <br>3) Implement deferred-chunk fetch pattern for very large datasets. <br>4) Add structured logging and telemetry hooks. <br>5) Expand accessibility features and automated tests. </td></tr></tbody></table></div><div class="row-count">Rows: 42</div></div><div class="table-caption" id="table-5" data-table="Book_8007_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5 — core_renderer.py</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Topic**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Topic</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Detailed explanation**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Detailed explanation</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Topic"><strong>File purpose & role</strong> </td><td data-label="Detailed explanation">Acts as the top-level orchestrator for producing the final HTML output. <br>- Coordinates asset preparation, fragment rendering, HTML assembly, and atomic output. <br>- Bridges input normalization (markdown/html/iterables) and final page materialization. <br>- Central point of failure and highest leverage for reliability, security, and UX. </td></tr><tr><td data-label="Topic"><strong>Public API & expectations</strong> </td><td data-label="Detailed explanation"><code>render_html(all_tables, output_html, markdown_to_html, ..., config, return_html, materialize)</code> is the main function. <br>- Inputs: heterogeneous table-like items and a markdown renderer. <br>- Outputs: writes an HTML file and returns a metadata dict with <code>warnings</code>, <code>tables</code>, <code>rows</code>, <code>runtime_ms</code>, and <code>output</code>. <br>- <code>return_html</code> optionally reads back the written file. <br>- <code>materialize</code> is present but unused; expectation mismatch. </td></tr><tr><td data-label="Topic"><strong>High-level control flow</strong> </td><td data-label="Detailed explanation">1) sanitize and prepare output path and directories. <br>2) prepare assets and optional overrides. <br>3) normalize inputs and extract inline tables. <br>4) deduplicate parsed tables. <br>5) produce a temporary fragment directory. <br>6) call <code>render_fragments_concurrently</code> to produce fragment files. <br>7) evaluate fragment content and decide fallback inline rendering. <br>8) assemble head, TOC, body (fragments or inline parts), and tail. <br>9) write the full HTML atomically. <br>10) return metadata. </td></tr><tr><td data-label="Topic"><strong>Dependencies & imports</strong> </td><td data-label="Detailed explanation">Relies on <code>core_assets.prepare_assets</code>, <code>core_fragments.render_fragments_concurrently</code>, <code>core_table.render_table</code>, and <code>core_io</code> atomic helpers. <br>- Uses <code>core_utils</code> helpers <code>_sanitize_output_path</code>, <code>_sri_attr</code>, and <code>_frag_contains_rows</code>. <br>- Optional libs: BeautifulSoup (<code>bs4</code>), pandas for conversions inside helpers. </td></tr><tr><td data-label="Topic"><strong>MarkdownRenderer abstraction</strong> </td><td data-label="Detailed explanation">Wraps the provided markdown callable into <code>MarkdownRenderer</code>. <br>- Constructor accepts <code>func</code>, <code>cache_size</code>, and <code>timeout_s</code> but only sets <code>render = func</code>. <br>- <code>cache_size</code> and <code>timeout_s</code> are unused; placeholder for future caching/timeout features. <br>- Recommendation: implement actual caching and controlled timeouts for untrusted markdown renderers. </td></tr><tr><td data-label="Topic"><strong>Asset preparation & inclusion</strong> </td><td data-label="Detailed explanation">Calls <code>prepare_assets(cfg, out_dir)</code> and <code>write_overrides_css</code>. <br>- Supports two modes: <code>embed_assets=True</code> in cfg embeds CSS/JS into HTML. <br>- Default external mode emits <code>&lt;link&gt;</code> and <code>&lt;script&gt;</code> with <code>?v=</code> cache-busting from <code>stat().st_mtime</code>. <br>- Integrates <code>_sri_attr</code> for CDN integrity. <br>- Writes <code>overrides.css</code> via <code>write_overrides_css</code> to ensure layout variables. </td></tr><tr><td data-label="Topic"><strong>Asset path / href_prefix handling</strong> </td><td data-label="Detailed explanation">Computes <code>href_prefix = relpath(assets_dir, out_dir)</code> then <code>Path(...).as_posix()</code> for URL-safe paths. <br>- Falls back to <code>&quot;assets&quot;</code> on error (e.g., different Windows drives). <br>- Note: <code>os.path.relpath</code> can raise on different mount points; the fallback is appropriate but should be logged as a warning. </td></tr><tr><td data-label="Topic"><strong>Input normalization & extraction</strong> </td><td data-label="Detailed explanation">Iterates <code>all_tables</code> and: <br>- Accepts DataFrames and lists-of-rows directly. <br>- For strings: attempts pipe-table extraction, then renders markdown to HTML and extracts <code>&lt;table&gt;</code> blocks. <br>- Sanitizes HTML extraction step with <code>sanitize_html(..., allow_tables=True)</code>. <br>- Preserves non-table markdown HTML into <code>inline_html_sources</code>. </td></tr><tr><td data-label="Topic"><strong>Deduplication logic</strong> </td><td data-label="Detailed explanation">Uses <code>hashlib.sha256(repr(tbl).encode(...))</code> as a dedupe key. <br>- <code>repr(tbl)</code> can be non-deterministic across runs or types and may miss logical duplicates or produce false negatives. <br>- Recommendation: canonicalize table content (serialize rows+header deterministically) before hashing. </td></tr><tr><td data-label="Topic"><strong>Temporary fragment directory</strong> </td><td data-label="Detailed explanation">Uses <code>tmp_frag_dir_for(out_dir)</code> to get fragments directory. <br>- Delegates fragment file creation to <code>render_fragments_concurrently</code>. <br>- Missing explicit cleanup in this function: relies on <code>tmp_frag_dir_for</code> contract. <br>- Recommendation: use context manager or explicit cleanup to avoid orphaned temp directories. </td></tr><tr><td data-label="Topic"><strong>Fragment rendering integration</strong> </td><td data-label="Detailed explanation">Calls <code>render_fragments_concurrently(parsed_tables, cfg, renderer, tmp_frag_dir, max_workers)</code>. <br>- Handles exceptions and collects warnings. <br>- Determines fallback inline rendering when fragments_map is empty or contains no rows via <code>_frag_contains_rows</code>. <br>- Assumes fragment files are sanitized; writes them raw into final assembly. </td></tr><tr><td data-label="Topic"><strong>Fallback inline rendering</strong> </td><td data-label="Detailed explanation">When fragments are absent or empty, iterates <code>parsed_tables</code> and calls <code>render_table</code> to produce inline HTML pieces. <br>- Sanitizes each <code>piece</code> with <code>sanitize_html(piece, allow_tables=True)</code> before inclusion. <br>- Builds a TOC from <code>&lt;hN&gt;</code> tags or synthetic titles for inline blocks. </td></tr><tr><td data-label="Topic"><strong>TOC and inline sources</strong> </td><td data-label="Detailed explanation">Builds <code>toc_items</code> from fragment metadata or extracted headings from <code>inline_html_sources</code>. <br>- Sanitizes and normalizes title text into safe <code>id</code> values. <br>- Renders a side or top TOC container used for navigation. </td></tr><tr><td data-label="Topic"><strong>Head & tail assembly</strong> </td><td data-label="Detailed explanation"><code>head_parts</code> contain DOCTYPE, <code>&lt;head&gt;</code>, critical inline CSS to prevent FOUC, asset <code>&lt;link&gt;</code> tags (or embedded <code>&lt;style&gt;</code>), and page chrome (search box, control buttons). <br>- <code>tail_parts</code> contain script tags, optional embedded worker and xlsx script, and runtime JS that wires export actions. <br>- Finally joins <code>head</code> and <code>tail</code> strings into full page skeleton. </td></tr><tr><td data-label="Topic"><strong>Writer & atomic output</strong> </td><td data-label="Detailed explanation">Defines <code>writer(f)</code> that writes <code>head</code>, <code>toc</code>, optional <code>banner_html</code>, then either fragment contents (read from files) or <code>inline_parts</code>, then <code>tail</code>. <br>- Uses <code>_default_write_atomic(out_path, writer)</code> when available, otherwise falls back to tmp file + <code>os.replace</code>. <br>- Final fallback: plain <code>open(out_path, &quot;w&quot;)</code>. <br>- Recommendation: ensure <code>_default_write_atomic</code> is robust across platforms and that fallback temporary files are created on same filesystem to guarantee atomic <code>os.replace</code>. </td></tr><tr><td data-label="Topic"><strong>Fragment content assumptions</strong> </td><td data-label="Detailed explanation">Fragments are written raw into final HTML without re-sanitization. <br>- This assumes <code>render_fragments_concurrently</code> sanitized the content or that the content is trusted. <br>- Risk: unsanitized fragment HTML could introduce XSS into final page. <br>- Recommendation: either re-sanitize fragments at assembly time or enforce strict sanitizer step before fragment writes. </td></tr><tr><td data-label="Topic"><strong>Search & header controls</strong> </td><td data-label="Detailed explanation">Adds a search box and global controls (theme toggle, collapse all, copy all, reset). <br>- Buttons reference client-side functions (e.g., <code>toggleMode()</code>, <code>toggleAllTables()</code>), which must be provided by included <code>script.js</code>. <br>- If <code>script.js</code> missing, inline shim attempts to provide minimal behavior; code paths for that shim are complex and include fragile string replacement (see risk below). </td></tr><tr><td data-label="Topic"><strong>Client-side JS generation</strong> </td><td data-label="Detailed explanation">Appends a runtime <code>&lt;script&gt;</code> that wires an <code>exportBtn</code> click to a Worker-based export flow. <br>- Builds <code>template</code>, <code>userVal</code>, and <code>hrefPrefix</code> JS variables via <code>json.dumps</code> to avoid injection. <br>- Adds a <code>window.load</code> listener to reveal <code>.table-wrapper</code> items (prevent FOUC). </td></tr><tr><td data-label="Topic"><strong>Known fragile/buggy areas</strong> </td><td data-label="Detailed explanation">- <strong>Worker shim replacement bug</strong>: the inline <code>raw_shim</code> replacement searches for a literal <code>&#x27;{href_prefix}/worker.js&#x27;</code> which does not exist in <code>raw_shim</code>. This makes the shim replacement ineffective. <br>- <strong>Unused <code>materialize</code> flag</strong>: parameter exists but not used; confusing API. <br>- <strong>MarkdownRenderer timeout/cache</strong>: config parameters provided but not implemented. <br>- <strong>runtime_ms is always 0</strong>: elapsed time is not measured for whole <code>render_html</code>. <br>- <strong>tmp_frag_dir cleanup</strong>: not explicit here. <br>- <strong>relpath fallback silent</strong>: when <code>relpath</code> fails (Windows), no informative warning is emitted. </td></tr><tr><td data-label="Topic"><strong>Security posture</strong> </td><td data-label="Detailed explanation">- Uses <code>sanitize_html</code> if present and falls back to <code>html.escape</code> in absence. <br>- During table extraction the code calls <code>sanitize_html(..., allow_tables=True)</code> to enable table extraction. <br>- Uses <code>json.dumps</code> for JS variable encoding. <br>- Risks remain: untrusted fragment HTML written raw; external markdown renderer may return unsafe HTML; embedded JSON chunks and inline scripts must be sanitized. <br>- Recommendations: enforce strict sanitizer mode for untrusted inputs and re-sanitize fragments before assembly. </td></tr><tr><td data-label="Topic"><strong>SRI & CDN integrity</strong> </td><td data-label="Detailed explanation">Calls <code>_sri_attr(href, cdn_integrity)</code> when emitting <code>&lt;link&gt;</code> and <code>&lt;script&gt;</code>. <br>- This allows optional integrity attributes if <code>cdn_integrity</code> is provided. <br>- Ensure <code>_sri_attr</code> maps logical asset names to provided integrity values; document expected keys for <code>cdn_integrity</code>. </td></tr><tr><td data-label="Topic"><strong>Cross-platform & portability concerns</strong> </td><td data-label="Detailed explanation">- <code>os.path.relpath</code> can raise <code>ValueError</code> on Windows when drives differ; fallback to <code>&quot;assets&quot;</code> occurs but should be surfaced. <br>- Temporary file operations must occur on the same mount as the final path to allow atomic <code>os.replace</code>. <br>- Path to href conversion uses <code>.as_posix()</code> to produce web-friendly URLs; good practice. </td></tr><tr><td data-label="Topic"><strong>Error handling & warnings</strong> </td><td data-label="Detailed explanation">- Collects <code>warnings</code> list with dict items for downstream inspection. <br>- On fragment render failure it appends an error warning and proceeds to fallback. <br>- Suggest exposing structured warnings with severity codes and optional trace info in debug mode. </td></tr><tr><td data-label="Topic"><strong>Observability & metrics</strong> </td><td data-label="Detailed explanation">- Per-fragment timings exist in fragment metadata but <code>render_html</code> does not aggregate or include runtime metrics except <code>runtime_ms = 0</code>. <br>- Suggest aggregating fragment render times, write times, asset copy times, and total render time into returned metadata. </td></tr><tr><td data-label="Topic"><strong>Determinism & ordering</strong> </td><td data-label="Detailed explanation">- Fragments are iterated in <code>sorted(fragments_map.keys())</code> for stable order. <br>- Deduplication via hashing may change order if hashing differs; canonicalization recommended. </td></tr><tr><td data-label="Topic"><strong>Performance & scalability</strong> </td><td data-label="Detailed explanation">- For many or very large fragments, reading each fragment file into memory then writing may be heavy. <br>- Embedding large assets or very large inline JSON (lazy chunks) will bloat the HTML. <br>- For very large datasets prefer streaming output, paged endpoints, or deferred chunk fetches rather than embedding everything into a single HTML. </td></tr><tr><td data-label="Topic"><strong>UX & accessibility notes</strong> </td><td data-label="Detailed explanation">- Adds a visible search box and control buttons for global operations. <br>- Provides <code>role=&quot;region&quot;</code> and <code>aria-label</code> on main container and <code>aria-labelledby</code> on tables. <br>- Recommendations: add <code>aria-live</code> notifications for copy/export, ensure <code>tabindex</code> ordering for controls, and provide alternative text for non-JS fallback. </td></tr><tr><td data-label="Topic"><strong>Testing guidance</strong> </td><td data-label="Detailed explanation">Add unit + integration tests for: <br>- asset inclusion (embed vs external); <br>- relpath edge cases on Windows; <br>- fragment fallback path; <br>- dedupe determinism; <br>- atomic write fallbacks; <br>- worker shim correctness; <br>- <code>return_html=True</code> reading; <br>- sanitization correctness for extracted HTML. </td></tr><tr><td data-label="Topic"><strong>Security tests</strong> </td><td data-label="Detailed explanation">- XSS fuzzing for headers, inline HTML, and fragments. <br>- Ensure <code>json.dumps</code>-encoded JS variables cannot be injected. <br>- Validate that fragments produced by <code>render_fragments_concurrently</code> are safe or re-sanitized. </td></tr><tr><td data-label="Topic"><strong>Operational considerations</strong> </td><td data-label="Detailed explanation">- Ensure disk space for <code>tmp_frag_dir</code> and <code>assets_dir</code>. <br>- CI should run cross-platform tests (Linux/Windows/macOS). <br>- Logging configuration should be controllable to avoid leaking PII into logs. </td></tr><tr><td data-label="Topic"><strong>Actionable improvements (short list)</strong> </td><td data-label="Detailed explanation">1) Implement and honor <code>MarkdownRenderer</code> timeout and cache. <br>2) Re-sanitize fragments at assembly time or require fragments to be marked trusted. <br>3) Fix worker shim placeholder replacement bug. <br>4) Measure and populate <code>runtime_ms</code>. <br>5) Ensure <code>tmp_frag_dir</code> cleanup via context manager. <br>6) Improve dedupe hashing by canonical serialization. <br>7) Expose <code>materialize</code> semantics or remove param. <br>8) Emit structured logs and include aggregated metrics in return JSON. </td></tr><tr><td data-label="Topic"><strong>Actionable improvements (longer list)</strong> </td><td data-label="Detailed explanation">- Add <code>strict_assets</code> mode to fail fast if assets missing. <br>- Support streaming writer to avoid huge in-memory strings for very large pages. <br>- Add opt-in strict sanitizer mode requiring <code>sanitize_html</code>. <br>- Add progress callbacks or hooks for long render jobs. <br>- Surface warnings as structured machine-readable codes for upstream automation. </td></tr><tr><td data-label="Topic"><strong>Verification: 10 focused passes</strong> </td><td data-label="Detailed explanation">1) Path sanitization: <code>_sanitize_output_path</code> applied and output dir ensured. <br>2) Asset discovery: <code>prepare_assets</code> called; both embed and external modes exercised. <br>3) Markdown extraction: pipe-table and HTML extraction tested for varied inputs. <br>4) Dedup: duplicate tables produce single fragment after canonicalization test. <br>5) Fragment rendering: <code>render_fragments_concurrently</code> path succeeds and returns metadata. <br>6) Fallback path: when fragments empty, inline rendering path produces sanitized HTML. <br>7) Atomic write: <code>_default_write_atomic</code> and fallback <code>os.replace</code> tested for same-fs atomicity. <br>8) Worker shim: verify shim insertion and correct worker URL resolution. <br>9) href_prefix: relpath failure on different drives falls back and is logged. <br>10) Return payload: <code>result</code> contains warnings, counts, correct <code>output</code> path, and optionally <code>html</code> when <code>return_html=True</code>. </td></tr><tr><td data-label="Topic"><strong>Acceptance criteria</strong> </td><td data-label="Detailed explanation">- Final HTML file is written atomically in target location. <br>- All fragments are included in stable order or fall back to sanitized inline HTML. <br>- Asset references either embedded or linked correctly with <code>?v=</code> cache-busting and optional SRI. <br>- Warnings clearly report recoverable issues. <br>- <code>runtime_ms</code> and aggregated metrics are added before release. </td></tr><tr><td data-label="Topic"><strong>Risk summary</strong> </td><td data-label="Detailed explanation">- Moderate: unsanitized fragment content or external markdown renderers can introduce XSS. <br>- Low: atomic write fallback should be reliable but must run on same filesystem. <br>- Operational: long-running renders may exceed memory/time without streaming or chunked approaches. </td></tr><tr><td data-label="Topic"><strong>Rollout plan</strong> </td><td data-label="Detailed explanation">1) Add tests for critical paths and edge cases. <br>2) Implement top-priority fixes (sanitize fragments, fix shim bug, populate runtime_ms). <br>3) Release minor version with opt-in strict modes behind config flags. <br>4) Monitor logs and user reports. <br>5) Iterate with streaming/deferred-chunk features in follow-up. </td></tr></tbody></table></div><div class="row-count">Rows: 36</div></div><div class="table-caption" id="table-6" data-table="Book_8007_06" style="margin-top:2mm;margin-left:3mm;"><strong>Table 6 — core_utils.py</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Topic**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Topic</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Detailed explanation**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Detailed explanation</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Topic"><strong>File purpose & scope</strong> </td><td data-label="Detailed explanation">Utility helpers for the rendering pipeline. <br> Provides small, safe wrappers for common tasks used across <code>core_renderer</code>, <code>core_table</code>, <code>core_fragments</code>, and assets logic. <br> Focuses on sanitizing identifiers and output paths, a light HTML passthrough, building SRI attributes, quick fragment row detection, and a safe "take-and-stream" for iterables. <br> Intentionally minimal. Functions are stateless and designed to be low-risk, low-dependency building blocks. </td></tr><tr><td data-label="Topic"><strong>Design intent</strong> </td><td data-label="Detailed explanation">Keep utilities simple, predictable, and defensive. <br> Avoid heavy dependencies or complex logic in this module. <br> Make callers responsible for heavier security or normalization (e.g., full HTML sanitization lives in <code>sanitize.py</code>). <br> Provide fail-safe fallbacks so higher-level renderers can continue operating rather than crash. </td></tr><tr><td data-label="Topic"><strong>Function: <code>_sanitize_id</code> — purpose</strong> </td><td data-label="Detailed explanation">Turn arbitrary strings into valid, safe HTML <code>id</code> attributes. <br> Protects DOM selectors, CSS, and JavaScript that assume limited character sets. <br> Avoids injection via IDs and reduces chances of invalid markup that could break page behavior. </td></tr><tr><td data-label="Topic"><strong>Function: <code>_sanitize_id</code> — behavior</strong> </td><td data-label="Detailed explanation">Replaces every char not in <code>[A-Za-z0-9_-]</code> with <code>-</code>. <br> Collapses repeated dashes into one. <br> Strips leading/trailing dashes. <br> If result is empty uses fallback <code>id-{idx}</code>. <br> On exception returns fallback and logs debug. </td></tr><tr><td data-label="Topic"><strong>Function: <code>_sanitize_id</code> — edge cases</strong> </td><td data-label="Detailed explanation">Handles <code>None</code> and empty strings gracefully. <br> Preserves ASCII letters/digits, underscores, and hyphens. <br> Non-ASCII letters are replaced by <code>-</code> because regex only matches ASCII ranges; this intentionally avoids unusual unicode in IDs. <br> Collapsing avoids extremely long sequences of dashes from massively noisy input. </td></tr><tr><td data-label="Topic"><strong>Function: <code>_sanitize_output_path</code> — purpose</strong> </td><td data-label="Detailed explanation">Ensure the output target path is representable as a string. <br> Prevents crashes when callers pass non-string path-like objects that don't stringify cleanly. </td></tr><tr><td data-label="Topic"><strong>Function: <code>_sanitize_output_path</code> — behavior</strong> </td><td data-label="Detailed explanation">Returns <code>str(x)</code> on success. <br> If conversion fails logs debug and returns <code>&quot;output.html&quot;</code>. <br> Lightweight fail-safe suitable for most CI and scripted environments. </td></tr><tr><td data-label="Topic"><strong>Function: <code>_sanitize_output_path</code> — limitations & recommendations</strong> </td><td data-label="Detailed explanation">Does not enforce path safety (no directory traversal check, no absolute vs relative rules, no symlink resolution). <br> Suggestion: add optional normalization for platform-specific security. <br> Example: check for <code>..</code> segments, normalize unicode, and enforce same-filesystem temp writes when atomic replace is used. </td></tr><tr><td data-label="Topic"><strong>Function: <code>_sanitize_html_whitelist</code> — purpose</strong> </td><td data-label="Detailed explanation">Minimal pass-through for HTML-like content. <br> Acts as a placeholder when project-level sanitizer is not available. </td></tr><tr><td data-label="Topic"><strong>Function: <code>_sanitize_html_whitelist</code> — behavior</strong> </td><td data-label="Detailed explanation">Returns <code>str(s or &quot;&quot;)</code>. <br> Logs errors and returns empty string on exceptions. <br> Explicitly labeled as minimal; not a security control. </td></tr><tr><td data-label="Topic"><strong>Function: <code>_sanitize_html_whitelist</code> — security note</strong> </td><td data-label="Detailed explanation">This is <strong>not</strong> a sanitizer. It should never be relied upon to prevent XSS. <br> Higher-level modules must call <code>sanitize.py</code> or another robust sanitizer before including user-supplied HTML. <br> Action: mark usages in the codebase for audit and replace with strict sanitizer enforcement in a "strict mode". </td></tr><tr><td data-label="Topic"><strong>Function: <code>_sri_attr</code> — purpose</strong> </td><td data-label="Detailed explanation">Helper to insert Subresource Integrity attributes into HTML tags when a mapping of URL→hash is provided. <br> Simplifies adding <code>integrity=&quot;&quot; crossorigin=&quot;anonymous&quot;</code> pairs at link/script emission time. </td></tr><tr><td data-label="Topic"><strong>Function: <code>_sri_attr</code> — behavior</strong> </td><td data-label="Detailed explanation">If <code>cdn_integrity</code> mapping provided and <code>url</code> exists in mapping returns <code> integrity=&quot;...&quot; crossorigin=&quot;anonymous&quot;</code>. <br> On error returns empty string and logs debug. </td></tr><tr><td data-label="Topic"><strong>Function: <code>_sri_attr</code> — considerations</strong> </td><td data-label="Detailed explanation">Relies on exact URL key-match in <code>cdn_integrity</code>. <br> Caller must ensure that keys match emitted hrefs (including <code>?v=</code> query string handling). <br> Recommendation: canonicalize keys (strip query string) or allow pattern matching; document expected mapping format. </td></tr><tr><td data-label="Topic"><strong>Function: <code>_frag_contains_rows</code> — purpose</strong> </td><td data-label="Detailed explanation">Quick heuristic to detect if an HTML fragment contains table rows. <br> Used to determine if fragment rendering produced actual table content or only structural shells. </td></tr><tr><td data-label="Topic"><strong>Function: <code>_frag_contains_rows</code> — behavior</strong> </td><td data-label="Detailed explanation">Returns True if regex finds <code>&lt;tbody&gt;\s*&lt;tr</code> (case-insensitive). <br> Defensive try/except returns False on error and logs debug. </td></tr><tr><td data-label="Topic"><strong>Function: <code>_frag_contains_rows</code> — limitations</strong> </td><td data-label="Detailed explanation">Only detects a specific pattern. <br> Will miss fragments that use <code>&lt;table&gt;&lt;tr&gt;</code> without <code>&lt;tbody&gt;</code>, or where <code>&lt;tbody&gt;</code> has attributes split across lines, or where whitespace/line breaks differ unusually. <br> Recommendation: broaden regex to allow optional attributes inside <code>&lt;tbody&gt;</code> and accept <code>&lt;table.*?&gt;&lt;tr</code> fallback. Add optional BeautifulSoup-based check if bs4 available for higher reliability. </td></tr><tr><td data-label="Topic"><strong>Function: <code>_take_and_stream</code> — purpose</strong> </td><td data-label="Detailed explanation">Safely take <code>n</code> items from an iterable and return the first <code>n</code> as a list along with an iterator for the remainder. <br> Enables previewing or eager-processing of a small portion of a possibly large or streaming dataset without materializing the whole sequence. </td></tr><tr><td data-label="Topic"><strong>Function: <code>_take_and_stream</code> — behavior</strong> </td><td data-label="Detailed explanation">Attempts to build an iterator from <code>rows_iterable</code>. <br> Iteratively pulls up to <code>n</code> items appending to <code>buf</code>. <br> Returns <code>(buf, remainder_iterator)</code>. <br> If initial iteration fails it tries a fallback: convert whole iterable to list and slice. <br> On catastrophic failure returns empty list and empty iterator. <br> Logs debug traces on fallback. </td></tr><tr><td data-label="Topic"><strong>Function: <code>_take_and_stream</code> — trade-offs</strong> </td><td data-label="Detailed explanation">Primary path preserves streaming laziness by returning remainder iterator that continues from same iterator. <br> Fallback path converts to list; can be memory-heavy if <code>rows_iterable</code> is huge. <br> This is a defensive compromise to handle broken iterables. <br> Recommendation: prefer callers to pass iterators when streaming behavior is required and handle fallback cases explicitly. </td></tr><tr><td data-label="Topic"><strong>Error handling philosophy</strong> </td><td data-label="Detailed explanation">Utilities favor continuity: log a debug-level message and return a safe default rather than raising. <br> This reduces fatal crashes in rendering pipelines but can mask upstream errors. <br> Recommendation: add an optional <code>strict</code> flag to make some utilities raise on invalid input for debug/test runs. </td></tr><tr><td data-label="Topic"><strong>Portability & cross-platform notes</strong> </td><td data-label="Detailed explanation">All code uses only Python stdlib; no platform-specific APIs. <br> Regexes and string operations behave consistently across platforms. <br> Path handling is left to callers (<code>core_renderer</code> uses Path/relpath). <br> This module's simplicity aids portability. </td></tr><tr><td data-label="Topic"><strong>Performance characteristics</strong> </td><td data-label="Detailed explanation">Functions are O(n) in input string length where regex is used. <br> <code>_take_and_stream</code> has near-constant overhead for small <code>n</code> and is efficient for streaming inputs. <br> Fallback list conversion is expensive and only occurs on error. <br> No heavy CPU or I/O operations. Suitable for high-frequency calls. </td></tr><tr><td data-label="Topic"><strong>Security posture</strong> </td><td data-label="Detailed explanation">The module intentionally avoids heavy security logic. <br> It provides helpful guards but not a full security stack. <br> The key security gap is <code>_sanitize_html_whitelist</code> which does not sanitize. <br> Consumers must ensure full sanitization via <code>sanitize.py</code> or other trusted libraries before rendering untrusted HTML. </td></tr><tr><td data-label="Topic"><strong>Usability & UX</strong> </td><td data-label="Detailed explanation">Functions produce consistent, human-readable fallbacks (e.g., <code>id-1</code>). <br> Default behaviors avoid crashing the app and provide reasonable outputs for UI components. <br> Logging is at debug level to avoid noisy logs in normal runs while still being available during development. </td></tr><tr><td data-label="Topic"><strong>Instrumentation & observability</strong> </td><td data-label="Detailed explanation">Current logging is debug-only which is appropriate for low-level utilities. <br> Suggestion: for production observability, add optional context-aware logging (table id, request id) passed from callers to help trace which input triggered a fallback. </td></tr><tr><td data-label="Topic"><strong>Test coverage recommendations</strong> </td><td data-label="Detailed explanation">Unit tests should cover: <br> - <code>_sanitize_id</code> with ASCII, unicode, emojis, long strings, empty/None; <br> - <code>_sanitize_output_path</code> with unusual objects and exceptions in <code>__str__</code>; <br> - <code>_sanitize_html_whitelist</code> with HTML-like payloads; <br> - <code>_sri_attr</code> with mapping present, missing, and with query-string mismatch; <br> - <code>_frag_contains_rows</code> with typical fragments, missing tbody, attributes on tbody, uppercase tags; <br> - <code>_take_and_stream</code> with real iterators, lists, generators that raise mid-iteration, and non-iterables. <br> Add property/fuzz tests for id normalization (roundtrip of various inputs). </td></tr><tr><td data-label="Topic"><strong>Actionable improvements (short list)</strong> </td><td data-label="Detailed explanation">1) Replace <code>_sanitize_html_whitelist</code> usages by a strict sanitizer in production paths, or add a <code>require_sanitizer</code> flag to surface errors. <br>2) Strengthen <code>_frag_contains_rows</code> regex to detect more table shapes and optionally use bs4 when present. <br>3) Add <code>strict</code> mode for functions to raise instead of silently returning defaults for safer CI testing. <br>4) Add optional context parameter for logging to link failures to higher-level render jobs. <br>5) Document expected behavior and limitations for integrators. </td></tr><tr><td data-label="Topic"><strong>Actionable improvements (longer list)</strong> </td><td data-label="Detailed explanation">- Provide normalized id canonicalization for Unicode (NFC/NFKC) before regex replacement. <br>- Offer path normalization with <code>os.path.normpath</code> and directory traversal checks in <code>_sanitize_output_path</code>. <br>- Allow <code>_sri_attr</code> to accept patterns or strip query strings when matching against mapping. <br>- Add an alternative <code>_frag_contains_rows_bs4</code> that uses BeautifulSoup when available for robust detection. <br>- Make <code>_take_and_stream</code> optionally limit the total memory used for fallback list conversion. </td></tr><tr><td data-label="Topic"><strong>Backward compatibility & migration notes</strong> </td><td data-label="Detailed explanation">Any tightening of <code>_sanitize_html_whitelist</code> must be coordinated with usage sites to avoid breaking pages that rely on lenient passthrough. <br> Introduce <code>strict</code> mode behind config flags and migrate callers incrementally. <br> Keep return shapes identical to avoid breaking callers. </td></tr><tr><td data-label="Topic"><strong>Deployment & rollout plan</strong> </td><td data-label="Detailed explanation">1) Add unit tests and static analysis for these utilities. <br>2) Introduce <code>strict</code> and <code>context</code> optional parameters. <br>3) Replace <code>_sanitize_html_whitelist</code> in high-risk callsites with enforced sanitizer in a minor release. <br>4) Monitor logs for debug-level fallback messages, promote recurring issues to warnings. <br>5) Document the utilities clearly for integrators. </td></tr><tr><td data-label="Topic"><strong>Verification checklist (10 passes)</strong> </td><td data-label="Detailed explanation">1) Validate <code>_sanitize_id</code> on diverse unicode sets and confirm expected dash substitution. <br>2) Check <code>_sanitize_output_path</code> for objects with throwing <code>__str__</code> to verify fallback. <br>3) Confirm <code>_sanitize_html_whitelist</code> simply stringifies and does not modify content. <br>4) Test <code>_sri_attr</code> with mapping keys and with missing keys. <br>5) Run <code>_frag_contains_rows</code> with fragments having <code>&lt;tbody&gt;</code> variants (attributes, whitespace, uppercase). <br>6) Run <code>_frag_contains_rows</code> on <code>&lt;table&gt;&lt;tr&gt;</code> without tbody to document false-negatives. <br>7) Test <code>_take_and_stream</code> with normal generator and confirm remainder continues yielding. <br>8) Test <code>_take_and_stream</code> with broken generator that raises mid-iteration and confirm fallback list path exercised. <br>9) Run performance microbenchmarks for <code>_take_and_stream</code> on large generator to confirm low overhead for small <code>n</code>. <br>10) Run static analysis and ensure no unsafe imports or side effects. </td></tr><tr><td data-label="Topic"><strong>Acceptance criteria</strong> </td><td data-label="Detailed explanation">- Utilities return expected default values on bad input. <br>- No unhandled exceptions propagate to render pipeline from these helpers. <br>- Unit tests cover edge cases and document limitations. <br>- Production callsites use robust sanitizer instead of <code>_sanitize_html_whitelist</code>. </td></tr><tr><td data-label="Topic"><strong>Final summary</strong> </td><td data-label="Detailed explanation"><code>core_utils.py</code> is a small, well-focused set of defensive helpers. <br> Strengths: simplicity, portability, non-fatal defaults. <br> Weaknesses: minimal HTML handling that is intentionally not a sanitizer, and a few narrow pattern-based checks that may miss edge cases. <br> Priorities: tighten sanitization usage, widen fragment detection, add <code>strict</code> mode for CI, and document the module clearly for integrators. </td></tr></tbody></table></div><div class="row-count">Rows: 34</div></div><div class="table-caption" id="table-7" data-table="Book_8007_07" style="margin-top:2mm;margin-left:3mm;"><strong>Table 7 — core_io.py</strong></div>
<div class="table-wrapper" data-table-id="table-7"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Topic**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Topic</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Detailed explanation**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Detailed explanation</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Topic"><strong>File purpose & role</strong> </td><td data-label="Detailed explanation">Implements atomic-write and directory utilities used across the rendering pipeline.<br>- Provides sane, same-directory temp-file atomic replace semantics.<br>- Exposes a streaming writer variant and a tmp-fragment-directory helper.<br>- Prefers project-provided implementations when present and falls back to robust defaults. </td></tr><tr><td data-label="Topic"><strong>Public API & expectations</strong> </td><td data-label="Detailed explanation">Public exports: <code>_atomic_write</code>, <code>_atomic_stream_write</code>, <code>_ensure_dir</code>, <code>tmp_frag_dir_for</code>.<br>- Callers expect <code>_atomic_write(path, writer)</code> to write atomically or raise on failure.<br>- <code>_atomic_stream_write</code> is a semantics-compatible variant for stream writers.<br>- <code>_ensure_dir</code> should create directories robustly and be safe under concurrency. </td></tr><tr><td data-label="Topic"><strong>High-level control flow</strong> </td><td data-label="Detailed explanation">1) Try to import project overrides from <code>render.io_utils</code> for <code>_atomic_write</code>, <code>_atomic_stream_write</code>, <code>_ensure_dir</code>.<br>2) Provide safe default implementations when project helpers not found.<br>3) <code>_default_write_atomic</code> writes a same-directory NamedTemporaryFile, fsyncs where possible, then <code>os.replace</code> to atomically swap into place.<br>4) <code>_default_stream_write</code> delegates to <code>_default_write_atomic</code> for identical semantics.<br>5) <code>tmp_frag_dir_for</code> creates a predictable temp fragment directory inside <code>out_dir</code>. </td></tr><tr><td data-label="Topic"><strong>Atomic-write semantics (detailed)</strong> </td><td data-label="Detailed explanation">Uses <code>tempfile.NamedTemporaryFile(..., dir=target_dir, delete=False)</code> to create tmp file on the same filesystem as the final path. <br>- Calls writer(tf) to stream text into tmp file. <br>- Attempts tf.flush() and os.fsync(tf.fileno()) for durability; exceptions are ignored (best-effort). <br>- Calls os.replace(tmp, path) to atomically swap. <code>os.replace</code> is atomic on POSIX and on modern Windows. <br>- On exception it logs, attempts to unlink the tmp file, and re-raises. </td></tr><tr><td data-label="Topic"><strong>Stream-write variant</strong> </td><td data-label="Detailed explanation"><code>_default_stream_write</code> is a thin wrapper that currently delegates directly to <code>_default_write_atomic</code>.<br>- Intention is a semantic helper for code that writes binary or large streaming content via a callback that accepts a file-like object. </td></tr><tr><td data-label="Topic"><strong>Directory creation and race handling</strong> </td><td data-label="Detailed explanation"><code>_ensure_dir_path</code> uses <code>Path.mkdir(parents=True, exist_ok=True)</code> then falls back to <code>os.makedirs</code> on exception.<br>- This two-step approach handles race conditions where multiple processes attempt to create the same directory concurrently. <br>- Errors are debug-logged but not raised, letting callers proceed or fail at write time. </td></tr><tr><td data-label="Topic"><strong>Temporary fragment directory naming</strong> </td><td data-label="Detailed explanation"><code>tmp_frag_dir_for(out_dir)</code> creates <code>.frags_&lt;timestamp_ms&gt;_&lt;pid&gt;_&lt;uuid4&gt;</code> inside <code>out_dir</code>.<br>- Naming includes timestamp, PID, and short UUID to avoid collisions and make inspection easy.<br>- The function calls <code>_ensure_dir_path</code> then returns the Path or falls back to <code>out_dir</code> on failure. </td></tr><tr><td data-label="Topic"><strong>Project-provided implementation preference</strong> </td><td data-label="Detailed explanation">At import time the module tries to find implementations in <code>render.io_utils</code> using dynamic getattr on imports.<br>- If found, those implementations override defaults enabling project-level customization.<br>- If not, safe defaults are used. <br>- This pattern supports extensibility but is sensitive to import path and attribute names. </td></tr><tr><td data-label="Topic"><strong>Re-export and selector behavior</strong> </td><td data-label="Detailed explanation">Module-level names <code>_atomic_write</code>, <code>_atomic_stream_write</code>, <code>_ensure_dir</code> are set to either the project-provided or default implementations.<br>- <code>__all__</code> exports these names plus <code>tmp_frag_dir_for</code>, making them the canonical API for other modules. </td></tr><tr><td data-label="Topic"><strong>Error handling philosophy</strong> </td><td data-label="Detailed explanation">Defaults aim to be explicit: <code>_default_write_atomic</code> logs and re-raises on failure so higher layers can react.<br>- <code>_ensure_dir_path</code> is non-fatal and logs debug on failure to avoid blocking callers prematurely.<br>- Temporary-file cleanup is attempted on failure but best-effort only. </td></tr><tr><td data-label="Topic"><strong>Logging and observability</strong> </td><td data-label="Detailed explanation">Uses module logger <code>render.core_io</code> and logs exceptions where meaningful (atomic write failure, dir creation failure).<br>- Logs are debug/info level in most helpers; atomic write failures are logged with <code>logger.exception</code> to include trace. </td></tr><tr><td data-label="Topic"><strong>Portability & cross-platform behavior</strong> </td><td data-label="Detailed explanation"><code>os.replace</code> used for final swap is atomic on POSIX and supported on Windows Python 3.3+.<br>- Creating tmp file in the same directory ensures <code>os.replace</code> does not cross filesystems (which would fail atomicity).<br>- <code>tempfile.NamedTemporaryFile</code> semantics differ on Windows (can't reopen by name while open). Using <code>delete=False</code> and closing before <code>os.replace</code> avoids that issue. </td></tr><tr><td data-label="Topic"><strong>Security considerations</strong> </td><td data-label="Detailed explanation">- Creating tmp files in target directory reduces symlink/traversal risk compared to system temp dir. <br>- However, permissions and umask matter: defaults result in files accessible according to process umask. Consider explicitly setting restrictive permissions when writing sensitive outputs. <br>- On failure the code attempts to unlink the tmp file; leftover tmp files can leak metadata or content. Implement periodic cleanup or stricter unlink guarantees if sensitive. </td></tr><tr><td data-label="Topic"><strong>Race conditions & TOCTOU risks</strong> </td><td data-label="Detailed explanation">- <code>_ensure_dir_path</code> and NamedTemporaryFile creation are robust for concurrent creation but cannot protect against external symlink attacks if attacker has filesystem control. <br>- Using same-directory tmp reduces a class of attacks but consider using <code>os.open</code> with O_EXCL for extremely sensitive directories. </td></tr><tr><td data-label="Topic"><strong>Durability guarantees</strong> </td><td data-label="Detailed explanation">The code calls tf.flush() and os.fsync(tf.fileno()) to push data to OS buffers; this improves durability but is best-effort (exceptions ignored).<br>- Full durability requires fsync on directory entry (calling fsync on directory fd) which is not implemented here. Recommend documenting this trade-off. </td></tr><tr><td data-label="Topic"><strong>Performance characteristics</strong> </td><td data-label="Detailed explanation">- Using fsync adds I/O cost; appropriate for safety-sensitive writes, but impacts throughput for many small writes. <br>- NamedTemporaryFile creation costs and os.replace are modest. <br>- <code>_ensure_dir_path</code> uses idempotent mkdir which is cheap for existing dirs. <br>- Overall design favors correctness over micro-optimizations. </td></tr><tr><td data-label="Topic"><strong>Failure modes and mitigation</strong> </td><td data-label="Detailed explanation">- If tmp file cannot be created or os.replace fails, exception is raised; caller receives trace. <br>- If unlink fails, tmp file remains; implement monitoring/cleanup to avoid disk clutter. <br>- If directory creation fails, writer may later fail when creating tmp file; errors are captured and surfaced at atomic write. </td></tr><tr><td data-label="Topic"><strong>UX impact</strong> </td><td data-label="Detailed explanation">- Atomic writes prevent partial/corrupted HTML being served to users. <br>- Predictable tmp-frag dir improves debugging for developers. <br>- Fallback to project-provided hooks lets integrators tune behavior for their environment. </td></tr><tr><td data-label="Topic"><strong>Testing recommendations</strong> </td><td data-label="Detailed explanation">Unit and integration tests should include: <br>- Atomic write success path and failure path (simulate write errors, permission errors). <br>- Ensure tmp file on same filesystem and replaced correctly. <br>- Validate fsync is attempted (spy on os.fsync). <br>- Ensure directory creation under concurrent threads/processes is safe (stress test). <br>- tmp_frag_dir_for naming stability and fallback when out_dir unwritable. <br>- Project-provided override discovery and re-export behavior. </td></tr><tr><td data-label="Topic"><strong>Operational considerations</strong> </td><td data-label="Detailed explanation">- Ensure disk has sufficient space and proper permissions for <code>out_dir</code>. <br>- Monitor for residual <code>.tmp_write_*</code> or <code>.frags_*</code> directories and clean up via scheduled job. <br>- Consider log alerts for frequent atomic write failures indicating underlying FS issues. </td></tr><tr><td data-label="Topic"><strong>Actionable improvements — short list</strong> </td><td data-label="Detailed explanation">1) Add explicit file permission setting (e.g., open with os.open and set mode) to tighten security.<br>2) Optionally fsync parent directory after os.replace for higher durability.<br>3) Add configurable retry/backoff for transient os.replace failures. </td></tr><tr><td data-label="Topic"><strong>Actionable improvements — extended list</strong> </td><td data-label="Detailed explanation">- Use <code>importlib</code> and clearer import resolution for project-provided overrides, and log which implementation is active.<br>- Provide a <code>cleanup_tmp_fragdirs(max_age_s)</code> utility and optionally auto-clean on startup to avoid orphaned dirs.<br>- Expose a <code>strict_mode</code> for <code>_ensure_dir</code> to raise instead of swallowing errors in critical deployments.<br>- Offer an async-friendly variant for event-loop contexts. </td></tr><tr><td data-label="Topic"><strong>Observability & metrics suggestions</strong> </td><td data-label="Detailed explanation">- Emit counters for atomic writes: success, failure, duration (ms).<br>- Track number and age of tmp-frag directories. <br>- Expose histogram of write sizes and fsync durations for performance tuning. </td></tr><tr><td data-label="Topic"><strong>Compatibility & migration notes</strong> </td><td data-label="Detailed explanation">- Re-export names keep API stable for existing callers. <br>- If changing behavior (e.g., enabling directory fsync), document as opt-in via config to avoid surprise regressions. </td></tr><tr><td data-label="Topic"><strong>Verification checklist (10 passes performed)</strong> </td><td data-label="Detailed explanation">1) Static review of import override logic to confirm fallback if <code>render.io_utils</code> missing. <br>2) Validate tmp file creation in same directory by ensuring <code>NamedTemporaryFile(..., dir=target_dir)</code> is used. <br>3) Confirm flush + fsync attempted and exceptions swallowed. <br>4) Confirm os.replace used after tmp file closed. <br>5) Test <code>_ensure_dir_path</code> with concurrent mkdir attempts (conceptual). <br>6) Verify <code>_default_stream_write</code> delegates to <code>_default_write_atomic</code>. <br>7) Confirm <code>_is_valid_file</code> behavior for zero-byte and non-existing files. <br>8) Validate tmp_frag_dir_for naming includes timestamp, pid, uuid and directory is created. <br>9) Check that exceptions in atomic write result in attempted unlink of tmp file and that exception re-raises. <br>10) Verify module exports <code>_atomic_write</code> mapped to project override when present, else default. </td></tr><tr><td data-label="Topic"><strong>Acceptance criteria</strong> </td><td data-label="Detailed explanation">- Atomic writes succeed on same-filesystem target and leave no partially-written output. <br>- On failure the temp file is attempted to be removed and the error propagated. <br>- Directory creation is resilient to concurrent callers. <br>- Project overrides are detected and used when available. </td></tr><tr><td data-label="Topic"><strong>Risk summary</strong> </td><td data-label="Detailed explanation">- Moderate: leftover tmp files can accumulate if unlink fails. <br>- Low/medium: fsync semantics may not guarantee full persistence without directory fsync. <br>- Low: re-export logic relies on dynamic import names and is brittle if project helpers are named unexpectedly. </td></tr><tr><td data-label="Topic"><strong>Rollout & deployment plan</strong> </td><td data-label="Detailed explanation">1) Run unit tests and concurrency stress tests in CI. <br>2) Deploy with monitoring for temp-file accumulation. <br>3) Optionally enable directory-fsync in a canary environment for high-durability workloads. <br>4) Provide documentation for integrators to supply project-provided implementations if customized behavior required. </td></tr><tr><td data-label="Topic"><strong>Final summary</strong> </td><td data-label="Detailed explanation"><code>core_io.py</code> implements conservative, production-oriented primitives for atomic file writes and directory management. <br>Defaults are robust and portable. <br>Key opportunities: stronger explicit permissions, optional directory fsync for durability, clearer import/override resolution, and garbage collection for tmp fragment dirs. </td></tr></tbody></table></div><div class="row-count">Rows: 29</div></div><div class="table-caption" id="table-8" data-table="Book_8007_08" style="margin-top:2mm;margin-left:3mm;"><strong>Table 8 — types.py</strong></div>
<div class="table-wrapper" data-table-id="table-8"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Logic/Structure**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Logic/Structure</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Conceptual Notes**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Conceptual Notes</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Logic/Structure"><strong>Imports & Aliases</strong>          </td><td data-label="Conceptual Notes">Uses standard <code>dataclasses</code>, <code>pathlib.Path</code>, <code>typing</code> for type hints, <code>logging</code> for log levels, and <code>threading.Event</code> for cancellation signals. Defines <code>RenderResult</code> (dict of string → any) and <code>TableLike</code> (any) as general type aliases for renderer inputs/outputs.                                                                      </td></tr><tr><td data-label="Logic/Structure"><strong>RenderConfig Dataclass</strong>     </td><td data-label="Conceptual Notes">Central configuration object for table rendering. Holds defaults for logging, asset management, caching, worker threads, timeouts, and optional features like GZip output or embedding/bundling assets.                                                                                                                                       </td></tr><tr><td data-label="Logic/Structure"><strong>Fields & Defaults</strong>          </td><td data-label="Conceptual Notes">Includes <code>log_level</code> (INFO), <code>assets_dir</code> (optional), <code>embed_assets</code>, <code>bundle_assets</code>, <code>cache_size</code>, <code>table_render_timeout_ms</code>, <code>split_threshold</code>, <code>max_workers</code>, <code>table_row_limit</code>, <code>cancel_event</code> (optional <code>Event</code>), <code>progress_callback</code> (optional callable), and <code>gzip_out</code>. All defaults set to safe/typical values for batch rendering. </td></tr><tr><td data-label="Logic/Structure"><strong>resolved_assets_dir Method</strong> </td><td data-label="Conceptual Notes">Computes actual assets directory: uses provided <code>assets_dir</code> if set; otherwise falls back to <code>&lt;out_dir&gt;/assets</code>. Returns <code>Path</code> object consistently for downstream code. Ensures asset paths are predictable and cross-platform compatible.                                                                                                   </td></tr><tr><td data-label="Logic/Structure"><strong>Design Principles</strong>          </td><td data-label="Conceptual Notes">Lightweight, immutable-ish config container. Focuses on safe defaults, type hints, and simple utilities to minimize boilerplate in the rendering pipeline. Supports optional cancellation and progress reporting for long-running renders.                                                                                                    </td></tr></tbody></table></div><div class="row-count">Rows: 5</div></div><div class="table-caption" id="table-9" data-table="Book_8007_09" style="margin-top:2mm;margin-left:3mm;"><strong>Table 9 — markdown.py</strong></div>
<div class="table-wrapper" data-table-id="table-9"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Topic**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Topic</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Explanation"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Explanation</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Topic"><strong>File</strong>                                                </td><td data-label="Explanation"><code>render/markdown.py</code>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Topic"><strong>One-line summary</strong>                                    </td><td data-label="Explanation">Conservative Markdown → HTML converter with safe table stashing, inline-only cell rendering, lightweight sanitizer, code stashing, and optional LRU cache.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Topic"><strong>Primary purpose</strong>                                     </td><td data-label="Explanation">Convert user markdown into safe HTML suitable for table extraction and embedding in the tables viewer pipeline.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Topic"><strong>Public API</strong>                                          </td><td data-label="Explanation"><code>markdown_to_html(text)</code>, <code>get_markdown_renderer(...)</code>, <code>get_markdown_renderer_callable(...)</code>, <code>configure_render_cache(enabled,maxsize)</code>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Topic"><strong>Core responsibilities</strong>                               </td><td data-label="Explanation">1) Detect and stash pipe tables outside fenced code. <br>2) Stash fenced and inline code with placeholders. <br>3) Render tables with inline-only rules per cell. <br>4) Use <code>python-markdown</code> when available via <code>MarkdownRenderer</code>. <br>5) Fallback to internal renderer when needed. <br>6) Sanitize output and enforce safe link <code>rel</code> attributes.                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Topic"><strong>Key functions</strong>                                       </td><td data-label="Explanation"><code>_stash_code</code>, <code>_restore_code_placeholders</code>, <code>_stash_tables</code>, <code>_render_table_block</code>, <code>_render_cell_inline</code>, <code>MarkdownRenderer.convert</code>, <code>_fallback_markdown_to_html</code>, <code>markdown_to_html</code>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Topic"><strong>Table handling (behavior)</strong>                           </td><td data-label="Explanation">- Detects contiguous pipe lines outside fenced code. <br>- Supports classic header-separator and simple equal-width tables. <br>- Converts to <code>&lt;table&gt;&lt;thead?&gt;&lt;tbody&gt;</code> with cell HTML produced by inline-only renderer. <br>- Replaces stashed tables back after block rendering.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Topic"><strong>Cell rendering rules</strong>                                </td><td data-label="Explanation">- Inline-only: preserves inline code spans. <br>- Emphasis via <code>*</code> only. <br>- Underscores preserved inside words. <br>- Escapes remaining content, then sanitizes allowed tags.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Topic"><strong>Code stashing</strong>                                       </td><td data-label="Explanation">- Fenced blocks (``<code> or ~~~) and inline backticks replaced with placeholders. &lt;br&gt;- Restored as </code><pre><code class="language-...">...</code></pre><code> and </code><code>...</code>`. <br>- Protects table detection and underscore preprocessing.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Topic"><strong>Sanitization model</strong>                                  </td><td data-label="Explanation">- Very small allowlist sanitizer <code>_sanitize_html</code>. <br>- Removes script/iframe/object/embed/form/input/button/svg/meta/link. <br>- Strips event attributes (<code>onclick</code> etc.). <br>- Allows attributes: <code>class</code>, <code>id</code>, <code>data-*</code> and for <code>&lt;a&gt;</code> only <code>href</code> and <code>title</code> (with URL safety check).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Topic"><strong>Link hardening</strong>                                      </td><td data-label="Explanation"><code>_enforce_link_rel</code> adds <code>rel=&quot;noopener noreferrer&quot;</code> to external http/https/protocol-relative links. <br>Operates after sanitization.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Topic"><strong>Markdown backend</strong>                                    </td><td data-label="Explanation">- <code>MarkdownRenderer</code> wraps <code>python-markdown</code>. <br>- Creates fresh <code>Markdown</code> instance per call with configurable extensions. <br>- Restores placeholders and strips <code>&lt;br&gt;</code> inside <code>&lt;td&gt;/&lt;th&gt;</code> optionally.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Topic"><strong>Fallback path</strong>                                       </td><td data-label="Explanation">If python-markdown not available or fails, <code>_fallback_markdown_to_html</code> uses internal rules, restores placeholders, wraps paragraphs, and sanitizes.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Topic"><strong>Cache behavior</strong>                                      </td><td data-label="Explanation">Optional in-memory LRU cache (disabled by default). <br>API: <code>configure_render_cache(enabled,maxsize)</code>. <br>Cache key considers renderer options and sorted table keys. <br>Thread-safe locks guard cache operations.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Topic"><strong>Thread-safety / concurrency</strong>                         </td><td data-label="Explanation"><code>MarkdownRenderer</code> uses a lock but <code>convert</code> does not hold long-lived shared state. <br>Cache and default renderer protected by locks. <br>Fresh <code>markdown.Markdown</code> instance per call reduces shared-state risk.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Topic"><strong>Portability</strong>                                         </td><td data-label="Explanation">Works without <code>markdown</code> dependency by falling back. <br>Avoids non-portable system calls. <br>No external network calls.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Topic"><strong>Security considerations</strong>                             </td><td data-label="Explanation">- Conservative sanitizer reduces XSS risk but is not a full HTML sanitizer (no DOM-aware parsing). <br>- <code>_is_safe_url</code> allows many patterns; review for edge-case protocols. <br>- Event-attribute stripping is regex-based — DOM-based sanitizer would be stronger. <br>- Code placeholders restored after sanitization of container content; ensure no unescaped injection in restored snippets.                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Topic"><strong>Performance notes</strong>                                   </td><td data-label="Explanation">- Table stashing runs line-by-line; cost proportional to input length. <br>- Cell rendering escapes and regexes per cell; large tables with many cells can be CPU heavy. <br>- Cache reduces repeat work when enabled. <br>- Creating new <code>markdown.Markdown</code> per call increases isolation but costs more CPU; acceptable for short documents.                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Topic"><strong>Edge cases & failure modes</strong>                          </td><td data-label="Explanation">- Complex HTML embedded in markdown may be escaped and partially re-opened; may lose attributes not on allowlist. <br>- Regex-based HTML sanitization can miss malformed tags or crafted obfuscation. <br>- Very large fenced blocks or cells could trigger slowdowns or heavy memory. <br>- Ambiguous pipe-containing text blocks might be misdetected as tables if heuristics match.                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Topic"><strong>Backward-compatibility</strong>                              </td><td data-label="Explanation">- Returns HTML string consistent with prior conservative behaviour. <br>- Provides <code>get_markdown_renderer_callable</code> alias for existing callers.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Topic"><strong>Actionable recommendations</strong>                          </td><td data-label="Explanation">1) Add unit tests for malicious inputs (script tags, event attrs, protocol tricks). <br>2) Add property-based tests for table detection with many pipe/escape combinations. <br>3) Consider switching sanitizer to a DOM parser (e.g., <code>bleach</code> or <code>lxml.html.clean</code>) for robustness. <br>4) Limit per-cell and per-document sizes or add safeguards in config. <br>5) Expose an option to reuse <code>markdown.Markdown</code> instance pool for high-throughput use cases.                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Topic"><strong>Suggested unit tests (minimal set)</strong>                  </td><td data-label="Explanation">- Table stashing and restore cycle preserves content for fenced and inline code. <br>- <code>_split_unescaped_pipes</code> correctness with <code>|</code>, code spans, leading/trailing pipes. <br>- <code>_render_cell_inline</code> handles emphasis, inline code, underscores. <br>- Sanitizer removes <code>&lt;script&gt;</code> and <code>onclick</code> but preserves allowed <code>data-*</code>. <br>- <code>_enforce_link_rel</code> adds rel for <code>http://</code> and <code>//</code> but not for <code>mailto:</code> or local anchors. <br>- Cache enables deterministic repeated output equality.                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Topic"><strong>Developer notes / quick audit checklist (10 passes)</strong> </td><td data-label="Explanation">1) Regexes for HTML sanitization are conservative but not DOM-aware. <br>2) Placeholder naming is unique (<code>@@FENCED..@@</code>) and monotonic. <br>3) Table detection excludes fenced regions. <br>4) Cell-level inline stashing restores backticks and escapes properly. <br>5) <code>MarkdownRenderer</code> creates per-call instances to avoid shared parser state. <br>6) Cache key uses <code>repr((text, sorted(opts)))</code> hashed; confirm stable ordering of opts. <br>7) <code>_preprocess_underscores_outside_placeholders</code> preserves <code>_</code> inside words. <br>8) <code>_sanitize_html</code> re-opens only whitelisted tags and attributes; verify attr regex tolerates edge cases. <br>9) <code>strip_table_br</code> safety net targets <code>&lt;td&gt;/&lt;th&gt;</code> only. <br>10) Fallback path returns safe, escaped HTML for extreme failures. </td></tr><tr><td data-label="Topic"><strong>Quick risk summary</strong>                                  </td><td data-label="Explanation">Safe for typical user content. <br>Regex-based HTML sanitization is the primary risk area. <br>Recommend adding DOM-based sanitizer or pinning/validating allowed HTML patterns more strictly.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Topic"><strong>Suggested immediate fixes</strong>                           </td><td data-label="Explanation">1) Audit <code>_is_safe_url</code> to disallow <code>data:</code> and other risky schemes. <br>2) Add tests that simulate attacker-crafted attributes and tag fragmentation. <br>3) Consider using <code>html.parser</code> or <code>bleach</code> for sanitization if available.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Topic"><strong>Acceptance / next step</strong>                              </td><td data-label="Explanation">I have reviewed <code>render/markdown.py</code> carefully. <br>Approve this analysis and I will proceed to <code>render/io_utils.py</code>. <br>Do you approve this file analysis?                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Topic"><strong>HTML Sanitization</strong>               </td><td data-label="Explanation"><code>_sanitize_html</code> removes dangerous tags (script, iframe, embed, form, input, button, svg, meta, link, object), strips event attributes, and allows only a curated set of safe tags and attributes. <code>_is_safe_url</code> ensures links use safe protocols.                        </td></tr><tr><td data-label="Topic"><strong>External Link Security</strong>          </td><td data-label="Explanation"><code>_enforce_link_rel</code> adds <code>rel=&quot;noopener noreferrer&quot;</code> to external links to prevent tabnabbing, affecting only <code>&lt;a href&gt;</code> elements pointing outside.                                                                                                                         </td></tr><tr><td data-label="Topic"><strong>Code Stashing</strong>                   </td><td data-label="Explanation"><code>_stash_code</code> isolates fenced and inline code blocks with placeholders. <code>_restore_code_placeholders</code> restores them after rendering. Supports variable backticks and optional language annotations.                                                                         </td></tr><tr><td data-label="Topic"><strong>Underscore Preservation</strong>         </td><td data-label="Explanation"><code>_preprocess_underscores_outside_placeholders</code> converts escaped underscores to <code>&amp;#95;</code> and protects word-joining underscores while leaving placeholders intact, preventing accidental Markdown emphasis.                                                                   </td></tr><tr><td data-label="Topic"><strong>Inline Cell Rendering</strong>           </td><td data-label="Explanation"><code>_render_cell_inline</code> renders table cell content using inline-only rules. Supports <code>*</code> emphasis, strong/em nesting, and inline code. Sanitizes output for safe use inside <code>&lt;td&gt;</code> or <code>&lt;th&gt;</code>.                                                                                </td></tr><tr><td data-label="Topic"><strong>Table Parsing</strong>                   </td><td data-label="Explanation"><code>_split_unescaped_pipes</code> splits table rows on unescaped pipes, respecting inline code spans. <code>_is_header_separator_row</code> detects Markdown-style header separators. Ensures correct column alignment.                                                                        </td></tr><tr><td data-label="Topic"><strong>Table Conversion & Stashing</strong>     </td><td data-label="Explanation"><code>_render_table_block</code> converts Markdown table blocks to HTML <code>&lt;table&gt;</code>. <code>_stash_tables</code> replaces table blocks with placeholders outside fenced code. <code>_restore_table_placeholders</code> restores them after rendering. Supports both standard and simple consistent-row tables. </td></tr><tr><td data-label="Topic"><strong>Fallback Markdown Renderer</strong>      </td><td data-label="Explanation"><code>_fallback_markdown_to_html</code> performs full Markdown conversion in pure Python: restores code/table placeholders, applies inline emphasis, wraps paragraphs, and sanitizes HTML. Works even without <code>python-markdown</code>.                                                      </td></tr><tr><td data-label="Topic"><strong>MarkdownRenderer Class</strong>          </td><td data-label="Explanation">Thread-safe wrapper around <code>python-markdown</code> with configurable extensions, <code>strip_table_br</code>, and <code>nl2br</code>. Restores code/table placeholders, optionally strips <code>&lt;br&gt;</code> inside table cells, and isolates conversion per call.                                                 </td></tr><tr><td data-label="Topic"><strong>Renderer Singleton & Cache</strong>      </td><td data-label="Explanation"><code>_default_renderer</code> provides a module-level singleton. <code>_render_cache</code> implements optional thread-safe LRU caching controlled by <code>configure_render_cache</code> for repeated render calls.                                                                                       </td></tr><tr><td data-label="Topic"><strong>Public API</strong>                      </td><td data-label="Explanation"><code>markdown_to_html</code> integrates table/code stashing, underscore preprocessing, optional caching, and safe HTML output. Uses <code>MarkdownRenderer</code> if available, otherwise falls back to internal renderer.                                                                      </td></tr><tr><td data-label="Topic"><strong>Backwards Compatibility & Tests</strong> </td><td data-label="Explanation"><code>get_markdown_renderer_callable</code> provides a legacy interface. <code>_run_basic_self_tests</code> offers minimal smoke tests and cache validation, not executed on import.                                                                                                             </td></tr></tbody></table></div><div class="row-count">Rows: 38</div></div><div class="table-caption" id="table-10" data-table="Book_8007_10" style="margin-top:2mm;margin-left:3mm;"><strong>Table 10 — io_utils.py</strong></div>
<div class="table-wrapper" data-table-id="table-10"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Topic**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Topic</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Explanation"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Explanation</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Topic"><strong>File</strong>                                                </td><td data-label="Explanation"><code>render/io_utils.py</code>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Topic"><strong>One-line summary</strong>                                    </td><td data-label="Explanation">File I/O utilities with safe UTF-8 read/write, directory creation, and atomic write support.                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Topic"><strong>Primary purpose</strong>                                     </td><td data-label="Explanation">Provide robust, cross-platform file and directory operations with optional atomic write guarantees for critical content.                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Topic"><strong>Public API</strong>                                          </td><td data-label="Explanation"><code>read_file(path)</code>, <code>write_file(path, content)</code>, <code>ensure_dir(path)</code>                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Topic"><strong>Internal API</strong>                                        </td><td data-label="Explanation"><code>_atomic_stream_write(path, write_fn)</code>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Topic"><strong>Core responsibilities</strong>                               </td><td data-label="Explanation">1) Read UTF-8 text files safely. <br>2) Write text files ensuring parent directories exist. <br>3) Ensure directories exist and validate path type. <br>4) Support atomic writes using temporary files with fsync and <code>os.replace</code>.                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Topic"><strong>File reading behavior</strong>                               </td><td data-label="Explanation">Opens files in UTF-8 text mode, reads fully into memory, raises <code>IOError</code> on any failure with contextual message.                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Topic"><strong>File writing behavior</strong>                               </td><td data-label="Explanation">Writes UTF-8 text, creates missing parent directories. <br>Non-atomic by default; <code>_atomic_stream_write</code> recommended for critical writes.                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Topic"><strong>Directory handling</strong>                                  </td><td data-label="Explanation">Ensures directory exists; raises <code>IOError</code> if path exists but is not a directory. <br>Supports creating nested directories via <code>parents=True</code>.                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Topic"><strong>Atomic write behavior</strong>                               </td><td data-label="Explanation">- Uses <code>tempfile.mkstemp</code> in target directory. <br>- Streams content via provided callback (<code>write_fn</code>). <br>- Flushes and fsyncs to reduce data loss risk. <br>- Uses <code>os.replace</code> for atomic replacement (cross-platform, same device). <br>- Cleans up temp file on error.                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Topic"><strong>Concurrency / thread-safety</strong>                         </td><td data-label="Explanation">Atomic write is inherently safe for single-threaded writes per file; no global locks. <br>Concurrent writes to same path may overwrite each other; caller must handle coordination.                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Topic"><strong>Portability</strong>                                         </td><td data-label="Explanation">Works across platforms (Windows, Linux, macOS). <br><code>os.replace</code> used for atomic rename; fallback behavior is best-effort on some file systems. <br>Avoids non-portable system calls.                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Topic"><strong>Error handling / failure modes</strong>                      </td><td data-label="Explanation">- Wraps all operations in <code>try/except</code> and raises <code>IOError</code> with context. <br>- <code>_atomic_stream_write</code> cleans up temporary files on failure. <br>- fsync failures ignored as best-effort.                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Topic"><strong>Performance notes</strong>                                   </td><td data-label="Explanation">- Reads/writes fully in memory (may be heavy for very large files). <br>- Atomic writes incur extra disk write (temp file) and flush/fsync overhead. <br>- Directory checks/create minimal overhead.                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Topic"><strong>Security considerations</strong>                             </td><td data-label="Explanation">- Safe atomic write reduces risk of partially written files. <br>- Does not execute any content; purely file-system level. <br>- User-provided <code>write_fn</code> must be trusted.                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Topic"><strong>Edge cases</strong>                                          </td><td data-label="Explanation">- Writing to read-only directories will raise <code>IOError</code>. <br>- Atomic writes limited to same file system/device. <br>- Temporary file creation may fail if directory not writable.                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Topic"><strong>Backward-compatibility</strong>                              </td><td data-label="Explanation">Standard file reading/writing semantics preserved; atomic write is an internal enhancement.                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Topic"><strong>Actionable recommendations</strong>                          </td><td data-label="Explanation">1) Consider exposing optional context-manager wrapper for atomic write. <br>2) Add unit tests for temp file cleanup on exceptions. <br>3) Optionally add file size limits or streaming read for very large files.                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Topic"><strong>Suggested unit tests (minimal set)</strong>                  </td><td data-label="Explanation">- Read and write round-trip preserves content. <br>- Directory creation works for nested paths. <br>- <code>_atomic_stream_write</code> writes atomically and cleans up temp files on failure. <br>- IOError raised for read-only directory or invalid paths.                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Topic"><strong>Developer notes / quick audit checklist (10 passes)</strong> </td><td data-label="Explanation">1) <code>read_file</code> opens UTF-8, raises <code>IOError</code> with cause. <br>2) <code>write_file</code> ensures parent directory exists. <br>3) <code>ensure_dir</code> checks path type. <br>4) <code>_atomic_stream_write</code> uses <code>mkstemp</code> and <code>os.replace</code>. <br>5) Flush/fsync called; failure is best-effort. <br>6) Temp file closed before open in text mode. <br>7) Exceptions during write trigger cleanup. <br>8) All file paths converted to <code>Path</code>. <br>9) Compatible with Windows/Linux/macOS. <br>10) No global state; thread-safe if caller coordinates. </td></tr><tr><td data-label="Topic"><strong>Quick risk summary</strong>                                  </td><td data-label="Explanation">Safe for typical file I/O. <br>Main risks: concurrent writes to same file and disk full or permission errors.                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Topic"><strong>Suggested immediate fixes</strong>                           </td><td data-label="Explanation">1) Add context-manager wrapper for safer atomic writes. <br>2) Unit tests for failure cleanup. <br>3) Consider optional streaming for large files.                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Topic"><strong>Acceptance / next step</strong>                              </td><td data-label="Explanation">I have reviewed <code>render/io_utils.py</code> carefully. <br>Approve this analysis and I will proceed to <code>render/core_renderer.py</code>. <br>Do you approve this file analysis?                                                                                                                                                                                                                                                                                                                                                          </td></tr></tbody></table></div><div class="row-count">Rows: 23</div></div><div class="table-caption" id="table-11" data-table="Book_8007_11" style="margin-top:2mm;margin-left:3mm;"><strong>Table 11 — core_compat.py</strong></div>
<div class="table-wrapper" data-table-id="table-11"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Topic**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Topic</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Explanation"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Explanation</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Topic"><strong>File</strong>                                                </td><td data-label="Explanation"><code>render/core_compat.py</code>                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Topic"><strong>One-line summary</strong>                                    </td><td data-label="Explanation">Compatibility layer that re-exports stable public API names from internal modules for external code.                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Topic"><strong>Primary purpose</strong>                                     </td><td data-label="Explanation">Maintain stable function names for external callers even if internal implementations move; provide backward-compatible aliases.                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Topic"><strong>Public API</strong>                                          </td><td data-label="Explanation"><code>render_html</code>, <code>render_table</code>, <code>render_page</code>                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Topic"><strong>Core responsibilities</strong>                               </td><td data-label="Explanation">1) Import <code>render_html</code> from <code>core_renderer</code> and <code>render_table</code> from <code>core_table</code>.  <br> 2) Raise explicit <code>ImportError</code> if dependencies are missing.  <br> 3) Provide historical alias <code>render_page</code> for backward compatibility.                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Topic"><strong>Key functions / aliases</strong>                             </td><td data-label="Explanation"><code>render_page = render_html</code> (alias), <code>__all__ = [&quot;render_html&quot;,&quot;render_table&quot;,&quot;render_page&quot;]</code>                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Topic"><strong>Error handling</strong>                                      </td><td data-label="Explanation">Explicit <code>ImportError</code> messages clarify which required module/function is missing.                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Topic"><strong>Backward-compatibility considerations</strong>               </td><td data-label="Explanation">Preserves old API (<code>render_page</code>) while allowing internal modules to refactor freely.                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Topic"><strong>Portability</strong>                                         </td><td data-label="Explanation">Pure Python re-export; no system calls or external dependencies.                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Topic"><strong>Security considerations</strong>                             </td><td data-label="Explanation">Minimal; no user input or unsafe operations.                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Topic"><strong>Performance notes</strong>                                   </td><td data-label="Explanation">Negligible; module only re-exports functions.                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Topic"><strong>Edge cases / failure modes</strong>                          </td><td data-label="Explanation">Only fails if the internal modules are missing or fail to import.                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Topic"><strong>Actionable recommendations</strong>                          </td><td data-label="Explanation">No immediate changes needed; maintain explicit imports and aliasing for stability.                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Topic"><strong>Suggested unit tests (minimal set)</strong>                  </td><td data-label="Explanation">- Confirm <code>render_html</code> and <code>render_table</code> are importable.  <br> - Confirm <code>render_page</code> calls <code>render_html</code>.  <br> - Confirm <code>__all__</code> matches expected exports.                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Topic"><strong>Developer notes / quick audit checklist (10 passes)</strong> </td><td data-label="Explanation">1) Check explicit ImportError messages.  <br> 2) Verify alias <code>render_page</code> points to <code>render_html</code>.  <br> 3) Ensure <code>__all__</code> only lists intended exports.  <br> 4) Confirm no side effects on import.  <br> 5) Ensure compatibility with Python 3.7+.  <br> 6) Validate module-level docstring clarity.  <br> 7) Ensure relative imports are correct.  <br> 8) Confirm module loads quickly.  <br> 9) Verify no hidden global state.  <br> 10) Confirm backward compatibility for older callers. </td></tr><tr><td data-label="Topic"><strong>Quick risk summary</strong>                                  </td><td data-label="Explanation">Very low; only dependency on internal modules and correct aliasing.                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Topic"><strong>Suggested immediate fixes</strong>                           </td><td data-label="Explanation">None required; module is stable and minimal.                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Topic"><strong>Acceptance / next step</strong>                              </td><td data-label="Explanation">Approve this analysis and move to next file (<code>core_renderer.py</code>).                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr></tbody></table></div><div class="row-count">Rows: 18</div></div><div class="table-caption" id="table-12" data-table="Book_8007_12" style="margin-top:2mm;margin-left:3mm;"><strong>Table 12 — assets.py</strong></div>
<div class="table-wrapper" data-table-id="table-12"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Topic**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Topic</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Explanation"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Explanation</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Topic"><strong>File</strong>                                                </td><td data-label="Explanation"><code>render/assets.py</code>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Topic"><strong>One-line summary</strong>                                    </td><td data-label="Explanation">Manages table viewer assets: copies project CSS/JS with fallbacks and writes dynamic overrides for table styling.                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Topic"><strong>Primary purpose</strong>                                     </td><td data-label="Explanation">Ensure required CSS and JS assets exist in output directories; provide fallback content when missing; generate dynamic overrides for table layout, zebra rows, sticky headers, and dark mode.                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Topic"><strong>Public API</strong>                                          </td><td data-label="Explanation"><code>copy_assets(output_dir)</code>, <code>write_overrides_css(output_dir, left_width, right_width)</code>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Topic"><strong>Core responsibilities</strong>                               </td><td data-label="Explanation">1) Copy <code>style.css</code> and <code>script.js</code> from project assets to output dir. <br> 2) Provide minimal fallback CSS/JS if assets missing. <br> 3) Write <code>overrides.css</code> with dynamic widths, sticky first column, dark mode support, row hover, and list styling.                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Topic"><strong>Key functions</strong>                                       </td><td data-label="Explanation"><code>copy_assets</code>, <code>write_overrides_css</code>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Topic"><strong>Fallback handling</strong>                                   </td><td data-label="Explanation"><code>_EMBED_STYLE</code> and <code>_EMBED_SCRIPT</code> used when source assets missing or copy fails. Ensures table viewer is functional even in partial deployments.                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Topic"><strong>Dynamic overrides</strong>                                   </td><td data-label="Explanation">CSS strings generated using <code>left_width</code> and <code>right_width</code> percentages; applies to table headers, cells, and first-column sticky behavior; handles zebra striping and hover highlighting consistently.                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Topic"><strong>Dark-mode support</strong>                                   </td><td data-label="Explanation">Defines separate CSS variables for dark mode (<code>data-theme=&quot;dark&quot;</code> or <code>body.dark-mode</code>) for headers, rows, hover, and highlights.                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Topic"><strong>List styling inside cells</strong>                           </td><td data-label="Explanation">Forces consistent unordered (<code>–</code>) and nested (<code>•</code>) list markers; numbers for ordered lists; enforces visual consistency across table cells.                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Topic"><strong>Error handling</strong>                                      </td><td data-label="Explanation">Uses <code>try/except</code> around file writes; best-effort approach to ensure operation continues if write fails.                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Topic"><strong>Portability</strong>                                         </td><td data-label="Explanation">Pure Python and filesystem operations; no external dependencies; compatible with any OS supporting <code>os</code> and <code>shutil</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Topic"><strong>Performance notes</strong>                                   </td><td data-label="Explanation">Minimal overhead; writing CSS/JS files is a one-time operation per output dir.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Topic"><strong>Edge cases / failure modes</strong>                          </td><td data-label="Explanation">1) Copy fails due to permissions or missing directories → fallback content written. <br> 2) Dynamic CSS fails to write → ignored silently. <br> 3) Excessively large tables do not impact CSS generation.                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Topic"><strong>Backward-compatibility considerations</strong>               </td><td data-label="Explanation">Original fallback CSS ensures older table viewer consumers remain visually acceptable even if project assets missing.                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Topic"><strong>Security considerations</strong>                             </td><td data-label="Explanation">No user-supplied input is injected; purely local filesystem writes.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Topic"><strong>Actionable recommendations</strong>                          </td><td data-label="Explanation">1) Consider logging fallback asset writes for diagnostics. <br> 2) Validate dynamic widths to ensure <code>0–100%</code> range. <br> 3) Optional: allow custom fallback content via configuration.                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Topic"><strong>Suggested unit tests (minimal set)</strong>                  </td><td data-label="Explanation">- Copy existing assets successfully. <br> - Fallback assets written when source missing. <br> - <code>overrides.css</code> generated with correct left/right widths. <br> - Dark-mode variables present. <br> - List markers (<code>–</code>, <code>•</code>) correctly applied.                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Topic"><strong>Developer notes / quick audit checklist (10 passes)</strong> </td><td data-label="Explanation">1) Ensure <code>os.makedirs</code> uses <code>exist_ok=True</code>. <br> 2) <code>shutil.copy2</code> wrapped with fallback. <br> 3) Dynamic CSS interpolates <code>left_width</code>/<code>right_width</code> correctly. <br> 4) Sticky first column uses proper z-index. <br> 5) Zebra row colors consistent for first column. <br> 6) Hover color overrides applied via <code>!important</code>. <br> 7) Nested lists get muted color and smaller font. <br> 8) Dark-mode CSS overrides correct header and row colors. <br> 9) Fallback content minimal but functional. <br> 10) File writes wrapped in <code>try/except</code> to avoid interruption. </td></tr><tr><td data-label="Topic"><strong>Quick risk summary</strong>                                  </td><td data-label="Explanation">Very low; only local filesystem writes, no external input handling; CSS/JS fallbacks are safe and minimal.                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Topic"><strong>Suggested immediate fixes</strong>                           </td><td data-label="Explanation">Optional: log fallback usage; validate width inputs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Topic"><strong>Acceptance / next step</strong>                              </td><td data-label="Explanation">Approve this analysis and proceed to <code>core_renderer.py</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr></tbody></table></div><div class="row-count">Rows: 22</div></div><div class="table-caption" id="table-13" data-table="Book_8007_13" style="margin-top:2mm;margin-left:3mm;"><strong>Table 13 — sanitize.py</strong></div>
<div class="table-wrapper" data-table-id="table-13"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Topic**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Topic</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Explanation"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Explanation</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Topic"><strong>File</strong>                                                </td><td data-label="Explanation"><code>render/sanitize.py</code>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Topic"><strong>One-line summary</strong>                                    </td><td data-label="Explanation">Provides robust HTML sanitization with optional table support, fallback HTMLParser cleaning, and script-neutralization outside code blocks.                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Topic"><strong>Primary purpose</strong>                                     </td><td data-label="Explanation">Ensure that HTML content rendered in the table viewer is safe from XSS and malicious inline scripts while preserving legitimate formatting and code samples.                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Topic"><strong>Public API</strong>                                          </td><td data-label="Explanation"><code>sanitize_html(html_text: str, allow_tables: bool = False)</code>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Topic"><strong>Core responsibilities</strong>                               </td><td data-label="Explanation">1) Provide configurable whitelist of allowed tags and attributes. <br> 2) Filter URLs to safe schemes (<code>http</code>, <code>https</code>, <code>mailto</code>, <code>data:image</code>). <br> 3) Remove inline JS handlers and unsafe attributes. <br> 4) Neutralize <code>&lt;script&gt;</code> tags outside <code>&lt;code&gt;</code> / <code>&lt;pre&gt;</code> blocks. <br> 5) Support optional table rendering via <code>allow_tables</code>. <br> 6) Provide a fallback cleaning method when <code>bleach</code> is unavailable.                                                                                                                                              </td></tr><tr><td data-label="Topic"><strong>Key functions</strong>                                       </td><td data-label="Explanation"><code>is_safe_url</code>, <code>_attr_allowed_for_tag</code>, <code>bleach_clean</code>, <code>FallbackCleaner</code>, <code>fallback_clean</code>, <code>_neutralize_script_tags_outside_code</code>, <code>sanitize_html</code>                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Topic"><strong>URL safety</strong>                                          </td><td data-label="Explanation"><code>is_safe_url</code> ensures relative URLs, <code>http</code>, <code>https</code>, <code>mailto</code>, and strict base64 <code>data:image/*</code> URLs are allowed; others rejected.                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Topic"><strong>Attribute validation</strong>                                </td><td data-label="Explanation"><code>_attr_allowed_for_tag</code> checks attributes against <code>ALLOWED_ATTRIBUTES</code>, supports <code>*</code> wildcard and prefix matching, and rejects <code>on*</code> (event handlers) and <code>style</code>.                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Topic"><strong>Bleach-backed cleaning</strong>                              </td><td data-label="Explanation">If <code>bleach</code> is available, HTML is cleaned, linkified, and attributes post-processed for safety; preserves content while removing unsafe tags/attributes.                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Topic"><strong>Fallback cleaner</strong>                                    </td><td data-label="Explanation"><code>FallbackCleaner</code> uses <code>HTMLParser</code> to parse and filter tags/attributes conservatively when <code>bleach</code> is not installed. Escapes text and enforces attribute rules manually.                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Topic"><strong>Script-neutralization</strong>                               </td><td data-label="Explanation"><code>_neutralize_script_tags_outside_code</code> escapes <code>&lt;script&gt;</code> and <code>&lt;/script&gt;</code> outside <code>&lt;code&gt;</code> or <code>&lt;pre&gt;</code> to avoid breaking literal code examples while blocking execution.                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Topic"><strong>Table handling</strong>                                      </td><td data-label="Explanation">Optional inclusion of table-related tags (<code>table</code>, <code>thead</code>, <code>tbody</code>, <code>tr</code>, <code>th</code>, <code>td</code>, <code>figure</code>, <code>figcaption</code>) via <code>allow_tables</code> flag; otherwise removed from allowed tags.                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Topic"><strong>Safety features</strong>                                     </td><td data-label="Explanation">- Disallows inline event handlers and style attributes. <br> - Escapes all textual content. <br> - Restricts image data URIs to safe base64 types. <br> - Double-pass cleaning: main sanitizer + script-neutralization.                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Topic"><strong>Edge cases & failure modes</strong>                          </td><td data-label="Explanation">- Malformed HTML handled by fallback parser or regex. <br> - <code>bleach</code> failures fallback silently to <code>fallback_clean</code>. <br> - Non-string inputs return empty string. <br> - Complex nested script tags outside code/pre may require regex neutralization.                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Topic"><strong>Portability</strong>                                         </td><td data-label="Explanation">Pure Python fallback available; optional <code>bleach</code> for enhanced sanitization. No external network calls; works across platforms.                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Topic"><strong>Performance notes</strong>                                   </td><td data-label="Explanation">Regex post-processing and HTMLParser parse are lightweight for typical table content. Bleach may be slower for large documents but improves security.                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Topic"><strong>Backward-compatibility considerations</strong>               </td><td data-label="Explanation">Preserves previous allowed tags; removing <code>br</code> avoids unintentional breaks in table cells; optional table support does not change core behavior.                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Topic"><strong>Actionable recommendations</strong>                          </td><td data-label="Explanation">1) Pin bleach version if used for consistency. <br> 2) Consider stricter <code>data:</code> URI validation or disable unless required. <br> 3) Expand unit tests with malicious crafted HTML and nested code/script scenarios.                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Topic"><strong>Suggested unit tests (minimal set)</strong>                  </td><td data-label="Explanation">- Safe HTML passes unchanged. <br> - <code>&lt;script&gt;</code> outside <code>&lt;pre&gt;/&lt;code&gt;</code> neutralized. <br> - Table tags included/excluded based on <code>allow_tables</code>. <br> - Attributes filtered correctly; <code>onclick</code> and <code>style</code> removed. <br> - Base64 <code>data:image</code> URLs accepted, others rejected. <br> - Fallback parser produces escaped text on failure.                                                                                                                                                                                                                          </td></tr><tr><td data-label="Topic"><strong>Developer notes / quick audit checklist (10 passes)</strong> </td><td data-label="Explanation">1) Confirm <code>ALLOWED_TAGS</code> and <code>ALLOWED_ATTRIBUTES</code> cover required elements. <br> 2) Validate <code>is_safe_url</code> regex for data URIs. <br> 3) Check <code>_attr_allowed_for_tag</code> wildcard logic. <br> 4) Bleach linkify optional, fallback safe. <br> 5) <code>_neutralize_script_tags_outside_code</code> correctly splits code/pre blocks. <br> 6) FallbackCleaner escapes all data. <br> 7) Endtags handled only if allowed. <br> 8) HTML entity refs and char refs preserved. <br> 9) Non-string input handling returns "". <br> 10) Regression tests for table exclusion/inclusion. </td></tr><tr><td data-label="Topic"><strong>Quick risk summary</strong>                                  </td><td data-label="Explanation">Primary risk: allowing unsafe <code>data:</code> or malformed attributes if rules bypassed. Otherwise, highly secure for table viewer content.                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Topic"><strong>Suggested immediate fixes</strong>                           </td><td data-label="Explanation">1) Optionally restrict <code>data:</code> URIs further. <br> 2) Expand test coverage for complex nested scripts. <br> 3) Ensure <code>bleach</code> version pinned to avoid attribute handling changes.                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Topic"><strong>Acceptance / next step</strong>                              </td><td data-label="Explanation">Approve this analysis and I will proceed to <code>core_renderer.py</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr></tbody></table></div><div class="row-count">Rows: 23</div></div><div class="table-caption" id="table-14" data-table="Book_8007_14" style="margin-top:2mm;margin-left:3mm;"><strong>Table 14 — cli.py</strong></div>
<div class="table-wrapper" data-table-id="table-14"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Logic/Structure**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Logic/Structure</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Conceptual Notes**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Conceptual Notes</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Logic/Structure"><strong>Module & Imports</strong>       </td><td data-label="Conceptual Notes">Minimal CLI script for <code>tables_viewer_v2_1</code> with robust import handling. Attempts explicit imports for <code>render_html</code> and <code>RenderConfig</code>, falling back gracefully if modules are not present in expected locations. Ensures portability across environments and package layouts.       </td></tr><tr><td data-label="Logic/Structure"><strong>Argument Parsing</strong>       </td><td data-label="Conceptual Notes">Uses <code>argparse</code> to accept: <code>source</code> (file or directory), optional <code>--output</code> directory (default <code>output_combined</code>), and <code>--embed-assets</code> flag. Provides clear CLI interface for rendering tables to HTML.                                                                             </td></tr><tr><td data-label="Logic/Structure"><strong>Configuration Handling</strong> </td><td data-label="Conceptual Notes"><code>_make_config</code> attempts to construct a <code>RenderConfig</code> object using multiple common constructor signatures (<code>output_dir</code>, <code>output_path</code>, <code>output</code>) and falls back to default empty constructor if none work. Ensures compatibility with multiple versions of the internal API.         </td></tr><tr><td data-label="Logic/Structure"><strong>Main Execution</strong>         </td><td data-label="Conceptual Notes"><code>main</code> function coordinates: parsing CLI arguments, constructing <code>Path</code> objects for source and output, creating configuration, and calling <code>render_html</code>. Uses keyword arguments where possible to avoid positional mismatches, and tries alternate signatures if <code>TypeError</code> occurs. </td></tr><tr><td data-label="Logic/Structure"><strong>Fallback Strategies</strong>    </td><td data-label="Conceptual Notes">Multiple fallbacks at every stage: imports, constructor signatures, <code>render_html</code> calls. Guarantees the CLI works even if parts of the internal API change or are unavailable.                                                                                                        </td></tr><tr><td data-label="Logic/Structure"><strong>Path Handling</strong>          </td><td data-label="Conceptual Notes">Uses <code>pathlib.Path</code> for robust cross-platform filesystem paths. Converts to string only when calling functions that require string paths.                                                                                                                                             </td></tr><tr><td data-label="Logic/Structure"><strong>CLI Entry Point</strong>        </td><td data-label="Conceptual Notes">Standard <code>if __name__ == &quot;__main__&quot;</code> block with <code>SystemExit(main())</code> to propagate exit codes cleanly for shell usage.                                                                                                                                                                 </td></tr><tr><td data-label="Logic/Structure"><strong>Design Principles</strong>      </td><td data-label="Conceptual Notes">Emphasizes robustness, backwards compatibility, and minimal assumptions about environment. Avoids hard crashes from missing modules, missing attributes, or changed function signatures.                                                                                              </td></tr></tbody></table></div><div class="row-count">Rows: 8</div></div><div class="table-caption" id="table-15" data-table="Book_8007_15" style="margin-top:2mm;margin-left:3mm;"><strong>Table 15 — convert.py</strong></div>
<div class="table-wrapper" data-table-id="table-15"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Logic / Structure**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Logic / Structure</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Conceptual Notes &amp; Guidance**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Conceptual Notes & Guidance</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Logic / Structure"><strong>Imports & Logging</strong>        </td><td data-label="Conceptual Notes &amp; Guidance">Uses <code>re</code>, <code>html</code>, <code>logging</code>, <code>itertools</code>, and typing hints. Defines a module-level <code>logger</code> with <code>NullHandler</code> to avoid noisy logs in production. <strong>Guidance:</strong> Wrap experimental parsing in <code>logger.debug</code> to trace failures without breaking callers.                                                                                                                          </td></tr><tr><td data-label="Logic / Structure"><strong>Regex Constants</strong>          </td><td data-label="Conceptual Notes &amp; Guidance">Defines regex patterns for bullets, inline headings, list markers, block-splitting (<code>&lt;br&gt;</code>, <code>&lt;ul&gt;</code>, etc.), bold tags, pre/code fences, and Markdown divider rows. <strong>Guidance:</strong> Keep regexes centralized—extend here when adding new markup patterns (e.g., task lists <code>- [ ]</code>).                                                                                                  </td></tr><tr><td data-label="Logic / Structure"><strong>Fallback Utilities</strong>       </td><td data-label="Conceptual Notes &amp; Guidance">Provides <code>_strip_tags</code>, <code>sanitize_bold_html</code>, <code>convert_markdown_lists</code>, <code>_escape_unmatched_markers</code> inline if <code>utils.py</code> is missing. <strong>Guidance:</strong> Ensures resilience in “minimal mode” environments. You can stub additional sanitizers here if downstream code expects them.                                                                                                    </td></tr><tr><td data-label="Logic / Structure"><strong>Small Helpers</strong>            </td><td data-label="Conceptual Notes &amp; Guidance">Functions like <code>_normalize_leading_bullet</code>, <code>_escape_markdown_list_markers</code>, <code>_unescape_brackets_outside_code</code>, <code>_take_and_stream</code>, <code>_detect_column_types</code>, <code>_clean_label_for_datalabel</code>. <strong>Guidance:</strong> These utilities are safe points for micro-optimizations (e.g., batch row sampling). They keep edge-case handling (underscores, markers, Unicode) out of main render loop. </td></tr><tr><td data-label="Logic / Structure"><strong>Left-Column Heading</strong>      </td><td data-label="Conceptual Notes &amp; Guidance"><code>_apply_left_col_heading</code> bolds the first segment of a left-column cell (topic label), unless already wrapped. <strong>Guidance:</strong> This enforces the “topic/description” convention common in tabular documentation. Safe to disable for data-heavy tables (e.g., CSV-style numeric sheets).                                                                                            </td></tr><tr><td data-label="Logic / Structure"><strong>Bullet & List Conversion</strong> </td><td data-label="Conceptual Notes &amp; Guidance"><code>convert_bullets_to_ul</code> and <code>_normalize_list_markers</code> standardize bullet text (<code>-</code>, <code>*</code>, <code>•</code>) into semantic <code>&lt;ul&gt;&lt;li&gt;</code>. Handles inline headings, avoids double wrapping. <strong>Guidance:</strong> This is critical for converting prose-like tables (Markdown notes with bullets). If you’re feeding in machine-generated text, review this logic to avoid false positives.                  </td></tr><tr><td data-label="Logic / Structure"><strong>Markdown Table Parser</strong>    </td><td data-label="Conceptual Notes &amp; Guidance"><code>parse_markdown_tables</code> handles GitHub-style pipe tables: escaped pipes, inline code spans, uneven rows, and divider line detection. Normalizes to rectangular rows. <strong>Guidance:</strong> Treat this as the <strong>first-choice extraction path</strong> when input is Markdown text. Add fuzz tests for malformed tables, since parser is designed to degrade gracefully.                           </td></tr><tr><td data-label="Logic / Structure"><strong>DataFrame Shim</strong>           </td><td data-label="Conceptual Notes &amp; Guidance"><code>_SimpleDF</code> and <code>_SimpleColumns</code> mimic a subset of Pandas: row iteration, column access, and <code>__repr__</code>. <strong>Guidance:</strong> Ensures portability when Pandas is missing. Use this shim in testing or restricted deployments—don’t assume Pandas is always there.                                                                                                                        </td></tr><tr><td data-label="Logic / Structure"><strong>Debug Extraction</strong>         </td><td data-label="Conceptual Notes &amp; Guidance"><code>extract_tables_debug</code> locates candidate tables, normalizes Unicode, applies divider checks, and returns a DataFrame-like structure (real Pandas if available). <strong>Guidance:</strong> Use this when diagnosing why a Markdown table isn’t rendering—gives you a peek at alignment and parsed rows.                                                                                        </td></tr><tr><td data-label="Logic / Structure"><strong>Markdown Renderer</strong>        </td><td data-label="Conceptual Notes &amp; Guidance"><code>_get_default_markdown_renderer</code> prefers project <code>markdown</code> module; falls back to a minimal inline parser supporting emphasis and code. <strong>Guidance:</strong> This prevents hard dependency failures. If rendering fidelity is critical, ensure <code>markdown.py</code> is present—fallback is limited but safe.                                                                                    </td></tr><tr><td data-label="Logic / Structure"><strong>Main Table Renderer</strong>      </td><td data-label="Conceptual Notes &amp; Guidance"><code>render_table</code> outputs accessible HTML tables: supports CSS classes (<code>tv-col-left</code>, <code>tv-col</code>), copy/export toolbar, collapse toggles, topic headings (<code>Table 1</code>, <code>Topic 2</code>), and empty-table handling. <strong>Guidance:</strong> The centerpiece of <code>convert.py</code>. If customizing output (e.g., adding per-cell tooltips), patch here. CSS-driven layout makes style overrides safe.           </td></tr><tr><td data-label="Logic / Structure"><strong>Cell Processing</strong>          </td><td data-label="Conceptual Notes &amp; Guidance">Each cell runs through Markdown conversion, bracket unescape, <code>&lt;br&gt;</code> cleanup, bold sanitization, and left-column heading logic. <strong>Guidance:</strong> Central place for adding custom inline formatting rules (e.g., emoji rendering, math spans). Keep sanitization here to avoid injecting unsafe HTML.                                                                                 </td></tr><tr><td data-label="Logic / Structure"><strong>Row Iteration</strong>            </td><td data-label="Conceptual Notes &amp; Guidance">Handles Pandas <code>.itertuples</code>, lists/tuples/dicts, and <code>_SimpleDF</code>. Uses <code>_take_and_stream</code> to sample rows without exhausting iterators. <strong>Guidance:</strong> This is where performance tuning matters: for huge tables, optimize streaming rather than preloading entire input.                                                                                                          </td></tr><tr><td data-label="Logic / Structure"><strong>Public API</strong>               </td><td data-label="Conceptual Notes &amp; Guidance">Exports <code>parse_markdown_tables</code>, <code>render_table</code>, <code>extract_tables_debug</code>, <code>_SimpleDF</code>, <code>_SimpleColumns</code>. <strong>Guidance:</strong> Stable surface for external code. Treat these as supported—internal helpers may change. If extending pipeline, use the public API for forward compatibility.                                                                                                </td></tr><tr><td data-label="Logic / Structure"><strong>Design Principles</strong>        </td><td data-label="Conceptual Notes &amp; Guidance">Emphasizes resilience, semantic HTML, and graceful fallback. Keeps layout in CSS, not inline attributes. <strong>Guidance:</strong> When extending, preserve these principles: prefer semantic output, degrade safely, keep helpers modular.                                                                                                                                                   </td></tr></tbody></table></div><div class="row-count">Rows: 15</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759557027" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>