<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1764743482">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#Table6">Table 6</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Proj_0013_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module Name</strong><br>modIO.bas (read-only / strict mode) </td></tr><tr><td data-label="Technical Breakdown"> <strong>Purpose</strong><br>Read-only utilities and safe atomic file-write helpers for the payroll/PPh21 project. Responsibilities: load Settings/Input/Rules ListObjects into in-memory dictionaries/arrays; generate and resolve job folder paths; read tax brackets and parameters; provide tolerant numeric/boolean parsing; ensure BPJS-related fields exist in in-memory row dictionaries; produce CSV rows and write UTF-8 CSV files atomically via ADODB.Stream; import CSV into existing worksheets using a streaming CSV parser that preserves text columns and strips BOMs. <strong>Does not</strong> create or modify workbook structure (sheets/tables) except writing to Settings when generating JOB_ID under strict, controlled conditions. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Design Principles</strong><br>• <strong>Strict, non-destructive mode:</strong> if required sheet/table missing the module logs ERROR and raises (strict behavior).<br>• <strong>Read-only by default:</strong> module reads worksheets/tables and performs safe file writes only; it will not create ListObjects or worksheets (except controlled write of JOB_ID into Settings when allowed).<br>• <strong>Fail-safe logging:</strong> SafeLog wraps modUtils.LogMsg with Debug.Print fallback so logging survives missing helper implementations.<br>• <strong>Late-bound COM use:</strong> ADODB.Stream and Scripting.FileSystemObject created late-bound to avoid compile-time references.<br>• <strong>Tolerant parsing:</strong> numeric and boolean parsing normalizes currency symbols, thousands/decimal separators, percent forms, and common BOM mis-decodings.<br>• <strong>Atomic file operations:</strong> writes to a GUID/ timestamped .tmp file then moves/renames (Name / SafeMoveFile fallback) to final path. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API (observed & preserved)</strong><br>SafeLog, LogMsg, LogForCompatibility, WorksheetExists, LoadSettingsDict, GenerateJobIdIfEmpty, GetJobFolderPath, LoadTblInput, ReadTableToDicts, ReadBrackets, ReadParams, CsvStreamFromRows, WriteCsvAtomic, WriteCsvAtomicString, WriteUtf8FileAtomic, ImportCsvPreserveText, ImportCsvToSheet, SimpleCsvToSheet, ParseCsvLineToFields, PreflightChecks, ValidateTblInputHeaders, SnapshotJobRules, SettingsSheetToArray, ListTablesOnSheet, ParseRateToFraction, ParseNumericStringToDouble, ParseNumberToDouble, NzNumeric, ParseBool, FileExists, EnsureBPJSColumns, CloneDict. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Logging & error policy</strong><br>• SafeLog attempts Application.Run "modUtils.LogMsg" and falls back to Debug.Print with timestamp and level. <br>• Most routines use <code>On Error GoTo ErrHandler</code>, log with SafeLog on error, and typically <code>Err.Raise</code> for strict failures so callers can abort.<br>• Module intentionally returns safe empty shapes for empty tables/arrays (e.g., returning empty dictionary/array) rather than Nothing where convenient. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Worksheet helpers (non-destructive)</strong><br>• WorksheetExists returns False if sheet not present.<br>• GetWorksheetOrNil and GetListObjectOrNil return Nothing on missing objects; used to enforce strict behavior in higher-level functions. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Settings loader behavior</strong><br>• LoadSettingsDict reads Settings sheet A/B pairs from row 2..last into a Scripting.Dictionary with UCase keys.<br>• Values coerced via CoerceSettingValue which recognizes TRUE/FALSE, percent suffix, numeric strings, otherwise returns raw variant.<br>• If Settings missing, logs ERROR and returns empty dictionary (strict call sites may raise). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Job ID and job folder resolution</strong><br>• GenerateJobIdIfEmpty: if Settings exists but JOB_ID absent or empty, generates "job-yyyymmdd-HHNNSS" and writes it back into Settings (writes only if Settings sheet present; strict). Logs generation.<br>• GetJobFolderPath: requires OUTPUT_BASE in Settings; appends JOB_ID (via GenerateJobIdIfEmpty) and returns folder path. Returns empty string and logs ERROR on failure. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Input loader (tblInput)</strong><br>• LoadTblInput enforces presence of Input sheet and tblInput ListObject (strict → Err.Raise if missing).<br>• Returns a Collection of Scripting.Dictionary row objects keyed by header names as read from the ListObject header row. If table has no DataBodyRange returns empty Collection. </td></tr><tr><td data-label="Technical Breakdown"> <strong>ReadTableToDicts behavior</strong><br>• Strict: validates sheet and table exist; raises on missing.<br>• Returns a Scripting.Dictionary keyed by string indices "0", "1", … where each value is a row Dictionary mapping trimmed header→cell value.<br>• Empty table yields empty dictionary (not Nothing). </td></tr><tr><td data-label="Technical Breakdown"> <strong>ReadBrackets & NormalizeBracketArrays_Local</strong><br>• ReadBrackets strictly requires sheet/table and at least two columns; reads DataBodyRange into two 0-based variant arrays <code>tmpU(0 To n-1)</code> and <code>tmpR(0 To n-1)</code> where uppers use NzNumeric fallback and rates use ParseRateToFraction fallback.<br>• Calls NormalizeBracketArrays_Local to normalize array bases to 0-based and to ensure <code>rates</code> has length = uppers.Count + 1. Normalize function will: convert non-zero lower bounds to 0-based arrays, fill missing rates with default or repeat last rate, produce defensively-sized arrays. <br>• Returns uppers and rates (as variants) and Boolean True on success; raises/logs on fatal errors. </td></tr><tr><td data-label="Technical Breakdown"> <strong>ReadParams behavior</strong><br>• Strict: requires Rules sheet and tblParams; reads A/B pairs into UCase keys and coerces values via CoerceSettingValue. Returns a Dictionary. Empty table → empty dictionary. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CSV row generation (CsvStreamFromRows)</strong><br>• Accepts rows (Dictionary/Collection/Array) and headers (array), produces an array of row arrays ready for CSV escaping. Looks up header names case-sensitively and fallback to lowercase key if present. Non-existent fields become empty strings. Returns Array() on error or empty input. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Atomic CSV write implementations</strong><br>• <strong>WriteCsvAtomic(folderPath, fileName, headers, rows, addBOM)</strong> — ensures folder via <code>Application.Run &quot;modUtils.EnsureFolderExistsWithRetry&quot;</code>, builds ADODB.Stream (Type=Text, Charset="utf-8"), writes CSV header and each row as escaped CSV lines using CsvEscapeArray, saves to tmpFile then moves tmpFile→finalFile using Name; if Name fails calls <code>modUtils.SafeMoveFile</code> fallback. Logs success. Raises on failures and attempts to remove tmp file on error.<br>• <strong>WriteCsvAtomicString(folderPath, fileName, csvContent)</strong> — same atomic .tmp workflow but writes provided csvContent string into ADODB.Stream and moves to final path.<br>• <strong>WriteUtf8FileAtomic(tmpPath, finalPath, content)</strong> — specialized helper writing content to tmpPath via ADODB.Stream then MoveFile via FileSystemObject; returns Boolean success. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Temporary filename generation</strong><br>• GenerateGuidTmpName uses Scriptlet.TypeLib GUID if available, else falls back to timestamp+random suffix. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CSV escaping</strong><br>• CsvEscapeArray accepts single value or array; escapes quotes by doubling, wraps fields containing commas/quotes/newlines in quotes. Returns empty string on error. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CSV import (preserve text) and streaming parser</strong><br>• ImportCsvPreserveText: strict — verifies csvPath exists and target sheet exists, then calls SimpleCsvToSheet.<br>• SimpleCsvToSheet streams file with <code>Open For Input</code> and reads physical lines into a <code>buffer</code> until ParseCsvLineToFields indicates a complete record (returns Empty when still inside quoted field). On successful parse writes fields to the provided worksheet row-by-row and sets NumberFormat "@" for columns 2 and 3 (nip/npwp).<br>• RemoveBomFromString robustly strips UTF-8 BOM bytes (Chr(239)&Chr(187)&Chr(191)), Unicode U+FEFF via AscW, and the mis-decoded literal "ï»¿".<br>• ParseCsvLineToFields: stateful parser handling quotes and doubled quotes; returns an array of fields if record complete; returns Empty when a dangling unclosed quote remains (used to detect multi-line quoted fields). </td></tr><tr><td data-label="Technical Breakdown"> <strong>ImportCsvToSheet wrapper</strong><br>• Verifies target sheet exists (strict), calls ImportCsvPreserveText, returns True on success. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Preflight & ValidateTblInputHeaders</strong><br>• PreflightChecks performs multiple strict validations: workbook saved and .xlsm recommended; presence of Settings, Input, Rules sheets; required ListObjects in Rules: tblBrackets, tblParams, TER_A..TER_D; OUTPUT_BASE must exist in Settings. Fails with Err.Raise when missing.<br>• ValidateTblInputHeaders enforces a specific expected header set for tblInput (a long array of expected names). If any missing logs ERROR and returns False (strict behavior raises in calling flows). Also forces nip/npwp ListColumn ranges to NumberFormat "@". </td></tr><tr><td data-label="Technical Breakdown"> <strong>SnapshotJobRules</strong><br>• Resolves job folder via GetJobFolderPath (strict), ensures folder via modUtils.EnsureFolderExistsWithRetry, writes SettingsSheetToArray as settings.csv and tblBrackets contents as tblBrackets.csv using WriteCsvAtomic. Logs snapshot completion. </td></tr><tr><td data-label="Technical Breakdown"> <strong>SettingsSheetToArray</strong><br>• Returns array of [Key, Value] pairs from Settings rows 2..last; empty array if no settings. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Utility & debug helpers</strong><br>• ListTablesOnSheet returns semicolon-separated ListObject names on a sheet.<br>• CloneDict performs a shallow copy of a Dictionary (copying values by reference). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Numeric & boolean parsing helpers</strong><br>• ParseRateToFraction: accepts percent strings, numeric strings; converts >1 numeric to /100; returns 0 on empty or invalid.<br>• ParseNumericStringToDouble: tolerant normalization — strips "Rp"/spaces/non-breaking space/tab, handles both "." and "," patterns by heuristics (if both exist treat "." as thousands and "," as decimal), filters to digits, dot, and minus; returns CDbl of filtered text or 0 on failure.<br>• ParseNumberToDouble delegates to ParseNumericStringToDouble. NzNumeric returns 0 for Null/Empty and tries numeric or ParseNumericStringToDouble.<br>• ParseBool accepts booleans, numeric, and common textual true forms ("true","1","yes","y","on","t"); default False. </td></tr><tr><td data-label="Technical Breakdown"> <strong>FileExists</strong><br>• Uses Scripting.FileSystemObject.FileExists late-bound; returns False on error. </td></tr><tr><td data-label="Technical Breakdown"> <strong>EnsureBPJSColumns (in-memory, non-destructive)</strong><br>• Iterates each row Dictionary in inputsDict and ensures presence of BPJS-related keys (explicit list). If includeFlag True will add missing numeric fields with 0; when present and non-numeric will coerce via ParseNumberToDouble unless strictFlag True (in which case invalid values are left as-is). Also ensures summary fields premi_asuransi_employer, iuran_bpjs_employee, iuran_pensiun exist when includeFlag True. Returns True on success; logs INFO when includeFlag True. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error & dependency surface</strong><br>• Module relies on external helpers in modUtils: EnsureFolderExistsWithRetry, SafeMoveFile, and optional LogMsg implementation. If modUtils functions missing SafeLog will fall back but atomic file creation/movement may fail and raise.<br>• ADODB.Stream, Scripting.FileSystemObject, and Scriptlet.TypeLib must be available at runtime; code uses late binding but runtime availability required. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Non-destructive guarantees & strictness</strong><br>• Explicit design: will not create worksheets or ListObjects. Exceptions: GenerateJobIdIfEmpty writes JOB_ID back into Settings if Settings sheet exists (controlled). SnapshotJobRules writes CSVs to job folder (file system writes). All worksheet modifications are limited to safe, deliberate operations (e.g., setting NumberFormat on existing columns). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance & memory notes</strong><br>• WriteCsvAtomic builds CSV record-by-record into ADODB.Stream (streaming) — avoids building a single giant VBA string in memory when using the rows path; WriteCsvAtomicString writes entire content in one go (caller beware of memory).<br>• ReadTableToDicts and LoadTblInput read full table into memory dictionaries; acceptable for typical payroll sizes but not for extremely large datasets. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security & data hygiene</strong><br>• ImportCsvPreserveText and SimpleCsvToSheet set text format for nip/npwp to avoid numeric mangling. <br>• Module avoids importing formulas (fields are written as values). Sensitive data written to CSVs — ensure operational policies for NPWP/PII handling before snapshotting. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Immediate recommended fixes & hardening (minimal, high-impact)</strong><br>1) Document and assert bracket-array base contract across modules — NormalizeBracketArrays_Local converts to 0-based arrays; ensure callers expect 0-based. <br>2) Provide a robust modUtils shim implementing EnsureFolderExistsWithRetry, SafeMoveFile and LogMsg (append to Logs sheet + Debug.Print) to remove silent failure modes.<br>3) Add retry/backoff around Name/Kill/FSO.MoveFile operations to handle transient network-share locks. <br>4) In WriteCsvAtomic and WriteCsvAtomicString honor addBOM flag (currently declared but not implemented for BOM insertion) if callers expect BOM behavior. <br>5) Add unit tests for ParseCsvLineToFields multi-line quoted field cases and BOM variations (EF BB BF, U+FEFF, mis-decoded). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing & verification (10× checklist)</strong><br>1) LoadSettingsDict: Settings missing → returns empty dict and logs ERROR where strict callers raise; percent & boolean coercion test vectors.<br>2) GenerateJobIdIfEmpty/GetJobFolderPath: missing Settings or OUTPUT_BASE triggers strict raises; when present JOB_ID written and GetJobFolderPath returns correct path with trailing separator logic.<br>3) LoadTblInput/ReadTableToDicts: missing sheet/table raises strict errors; tables with zero rows return empty collections/dicts; header trimming and exact header names preserved.<br>4) ReadBrackets + NormalizeBracketArrays_Local: input with 1-based arrays and incomplete rates is normalized to 0-based uppers and rates length = uppers.Count + 1; numeric parsing edge cases (commas/dots/strings) covered.<br>5) ReadParams: keys uppercased and CoerceSettingValue applied (percent -> fraction, numeric -> double).<br>6) CsvStreamFromRows & CsvEscapeArray: dictionaries with missing keys produce empty fields; fields with quotes/commas/newlines are quoted and quotes doubled. <br>7) WriteCsvAtomic / WriteCsvAtomicString / WriteUtf8FileAtomic: produce .tmp then final file; on simulated Name failure fallback to modUtils.SafeMoveFile invoked; tmp file cleaned up on error. <br>8) SimpleCsvToSheet & ParseCsvLineToFields: multi-line quoted fields parse correctly (parser returns Empty while inside quote), BOM variants removed, nip/npwp columns set to text format. <br>9) PreflightChecks & ValidateTblInputHeaders: missing required sheets/tables produce strict errors; ValidateTblInputHeaders returns False and logs missing header list when any expected header absent. <br>10) EnsureBPJSColumns: when includeFlag True missing BPJS keys added as 0 and non-numeric coerced to numeric when strictFlag False; strictFlag True leaves invalid values unchanged. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational notes & known risks</strong><br>• Relies on modUtils external helpers (folder creation, safe file move, logging). If absent some operations will raise or silently skip logging. <br>• ADODB.Stream and FSO availability required on target machines; network fileshares may cause intermittent file move/kill failures — add retry/backoff. <br>• Array base differences resolved inside NormalizeBracketArrays_Local, but other modules must not assume different base conventions. <br>• ParseCsvLineToFields returns Empty for an unterminated quoted field which the caller uses as a signal to accumulate physical lines — tests must include large quoted fields with internal CRLF. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Documentation & versioning recommendations</strong><br>• Add module header metadata (MODIO_VERSION) and explicit changelog. <br>• Document external dependencies: modUtils functions required, ADODB/FSO availability, and the contract that this module is strict/read-only for workbook structure. <br>• Explicitly document bracket-array base (0-based) contract for cross-module consistency. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final acceptance criteria before production</strong><br>• Ensure modUtils helpers present and tested.<br>• Run 10× checklist end-to-end with sample datasets (including multi-line quoted CSVs, BOM variants, and bracket edge cases).<br>• Confirm ADODB.Stream writes and file-move semantics on target deployment machines (local and network shares). </td></tr></tbody></table></div><div class="row-count">Rows: 34</div></div><div class="table-caption" id="Table2" data-table="Proj_0013_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module Name</strong><br>modMain.bas (orchestrator + test harness) </td></tr><tr><td data-label="Technical Breakdown"> <strong>Purpose</strong><br>Primary orchestration for the PPh21 pipeline: perform preflight checks, resolve job and output folder, load rules/brackets/params, ingest optional TER tables, load and validate input rows, call per-row processing (ProcessRow), assemble CSV payloads, write CSVs atomically, create manifest, import CSVs into existing output sheets, and snapshot rules/settings. Includes Test_RunAll harness to create minimal Settings/tblInput test data and exercise full pipeline. Designed defensive and strict where upstream modules are strict. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Design Principles</strong><br>• <strong>Defensive orchestration:</strong> pervasive On Error handlers, fallbacks, and checks to avoid crashing workbook; logs via SafeLog.<br>• <strong>Strict-compatibility:</strong> honors modIO strict mode (raises/logs when required sheets/tables missing).<br>• <strong>Layered fallbacks:</strong> attempts Application.Run host helpers (modIO, modUtils, modCalc, modManifest) and falls back to local helpers when host call fails.<br>• <strong>Non-invasive to workbook structure:</strong> clears Outputs sheets at start, but uses host modules for structural changes; Test_RunAll will create Settings if missing and ensure minimal Input table formatting. <br>• <strong>10× checked mindset:</strong> multiple defensive checks, explicit cleanup, and verification points. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API (observed & preserved)</strong><br>Sub pph21_RunAll(), Sub Test_RunAll(). These are the preserved entrypoints; internal helpers are private: NormalizeBracketArraysLocal, EnsureZeroBasedArray, ToZeroBased, SafeGetValue, SafeRowIdForLog, CreateFolderIfMissing, WorksheetExists, SafeName. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Startup & preparatory actions</strong><br>• Clears <code>Outputs</code> and <code>Outputs_Per11</code> sheet contents at run start.<br>• Calls modIO.PreflightChecks via Application.Run with On Error Resume Next to capture and log failure without raising unless critical. If Preflight fails, run aborts early. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Rules / brackets / params ingestion</strong><br>• Calls ReadBrackets("Rules","tblBrackets") producing uppers and rates; if ReadBrackets returns False, emits WARN and supplies fallback (large upper, default rate).<br>• Defensive normalization: first tries Application.Run "modCalc.NormalizeBracketArraysLocal", falls back to local NormalizeBracketArraysLocal if host call fails.<br>• Loads params via ReadParams("Rules","tblParams"). </td></tr><tr><td data-label="Technical Breakdown"> <strong>TER table ingestion</strong><br>• If Rules sheet present, iterates all ListObjects and collects ones whose names begin with "TER" (case-insensitive). For each TER table builds a Dictionary of row-index→entry where each entry contains GrossLow, GrossHigh (NzNumeric) and TER_percent (ParseRateToFraction).<br>• Attempts to pass terTables to modCalc.SetTERTables via Application.Run; logs WARN if host call fails and continues without TER injection. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Input loading and header validation</strong><br>• Calls LoadTblInput (strict) to obtain a Collection of row Dictionaries. If none found, snapshots rules and exits.<br>• Attempts to get a config object via GetConfig() (Application.Run) defensively; uses cfg to decide strictness for header validation.<br>• Header validation: tries Application.Run "modCalc.ValidateHeaders"; if unavailable falls back to a best-effort scan of first row comparing against <code>requiredHeaders</code> array. If missing headers and STRICT_BPJS set True in cfg, run aborts; otherwise logs WARN and continues. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Per-row processing loop</strong><br>• Iterates inputRows collection and calls ProcessRow for each row with On Error Resume Next wrapper; logs contextual errors including masked sensitive identifiers (SafeRowIdForLog + MaskSensitiveForLog usage).<br>• Aggregates successful processed row Dictionaries into <code>results</code> Collection; if results empty after processing, snapshots rules and exits. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CSV assembly</strong><br>• Defines stable <code>buktiHeaders</code> and <code>per11Headers</code> arrays; converts them to 0-based arrays via EnsureZeroBasedArray.<br>• Builds two zero-based Variant arrays <code>buktiRows(0 To results.Count-1)</code> and <code>per11Rows(0 To results.Count-1)</code> by mapping each processed <code>outDict</code> through SafeGetValue for each header. Handles empty header arrays defensively producing minimal single empty-cell rows. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CSV writes & manifest</strong><br>• Ensures outFolder exists (CreateFolderIfMissing) and calls WriteCsvAtomic (from modIO) to write bukti_potong.csv and per11_payload.csv. Uses On Error Resume Next around each WriteCsvAtomic call and logs errors/warnings without throwing fatal exceptions to allow best-effort continuation.<br>• Builds a fileList Collection containing generated CSVs and snapshot CSVs when present; calls Application.Run "modManifest.WriteManifest" with job folder, jobId, fileList; logs manifest creation WARN/INFO accordingly. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CSV import to output sheets</strong><br>• Calls ImportCsvToSheet (modIO) to import bukti_potong.csv into "Outputs" and per11_payload.csv into "Outputs_Per11" with On Error Resume Next and logs WARN on failures; non-destructive strictness: ImportCsvToSheet will raise if target sheet missing, which is caught and converted to WARN log here. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Snapshot rules/settings</strong><br>• Calls SnapshotJobRules at end to write Settings and tblBrackets CSV snapshots to job folder; errors are logged and raised from within SnapshotJobRules if strict failures occur. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Timing & finalization</strong><br>• Logs run duration with SafeLog. Fatal errors bubble to ErrHandler which logs FATAL and re-raises Err.Number. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Test harness (Test_RunAll)</strong><br>• Ensures Settings sheet exists and sets OUTPUT_BASE to <code>ThisWorkbook.Path &amp; &quot;\pph21_test_output&quot;</code>. Clears JOB_ID to force new folder.<br>• Calls EnsureTblInputFormatting (host helper assumed) to prepare Input table, then inserts a sample test row with representative fields (nip, npwp, name, period, period_type, gross, bpjs_* values).<br>• Invokes pph21_RunAll and then verifies existence of bukti_potong.csv, per11_payload.csv, and manifest.json in job folder; logs success or failure. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Local helpers: NormalizeBracketArraysLocal</strong><br>• Converts non-zero-based uppers/rates arrays to zero-based arrays in place. If rates missing, creates rates(0 To UBound(uppers)) filled with 0.05. If rates shorter than uppers extends rates preserving existing values and filling empties with rates(0) if empty. Designed to match modIO Normalize behavior closely but implemented locally for fallback. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Local helpers: EnsureZeroBasedArray / ToZeroBased</strong><br>• EnsureZeroBasedArray always returns a zero-based one-dimensional String Variant array for input that may be Collection, Array, single value, or object. Returns empty (-1 upper bound) array for zero-length inputs; robust against non-array inputs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Local helpers: SafeGetValue, SafeRowIdForLog, SafeName</strong><br>• SafeGetValue: tolerant accessor for Dictionaries (case variants) and generic objects; returns "" when key missing. <br>• SafeRowIdForLog: picks nip or rowIndex for logging, defaults to "unknown". <br>• SafeName: returns lo.name or "" on error; used when scanning ListObjects for TER tables. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Local helper: CreateFolderIfMissing</strong><br>• Recursively creates parent folders using Scripting.FileSystemObject; returns Boolean success. Used as fallback when modUtils folder creation fails. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling & logging policy</strong><br>• Orchestrator prefers best-effort behavior: non-fatal operations are wrapped to log and continue where reasonable; critical missing infrastructure (job folder, required sheets in strict mode) cause early exit. <br>• Uses SafeLog extensively; relies on modUtils or Debug.Print fallback implemented in modIO.SafeLog. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Dependency & contract surface</strong><br>• Critical dependencies: modIO (primary API for IO, parsing, preflight, snapshots), modUtils (EnsureFolderExistsWithRetry, SafeMoveFile possibly used by modIO), modCalc (NormalizeBracketArraysLocal, ValidateHeaders, SetTERTables, ProcessRow likely in modCalc or host), modManifest (WriteManifest).<br>• Assumes presence of EnsureTblInputFormatting and GetConfig host helpers optionally; falls back where possible. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance & memory</strong><br>• Loads entire input table into memory (Collection of Dictionaries) — acceptable for typical payroll sizes but could be heavy for very large inputs.<br>• Constructs CSV arrays in memory (buktiRows/per11Rows) sized to results.Count; WriteCsvAtomic uses ADODB.Stream and streaming writes to disk (modIO responsibility). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security & data hygiene</strong><br>• Masks sensitive identifiers in logs via MaskSensitiveForLog when available; SafeRowIdForLog picks non-sensitive fallback. <br>• Writes sensitive data (NPWP) to CSVs and filesystem — ensure operational safeguards and secure output folder permissions. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Immediate recommended fixes / hardening (minimal, high-impact)</strong><br>1. <strong>Explicit dependency verification</strong>: at start assert presence of key host APIs (modIO, modCalc, modUtils, modManifest) and log a clear dependency error if absent; consider failing fast in CI/test runs.<br>2. <strong>Consistent bracket normalization contract</strong>: centralize NormalizeBracketArrays in modIO or modCalc and remove duplicate local logic to avoid divergence. Add unit tests verifying identical outputs for representative inputs.<br>3. <strong>Retry/backoff for file ops</strong>: wrap file checks (FSO.FileExists, Name, Delete) and WriteCsvAtomic calls with retries and small backoff to handle network share locks. <br>4. <strong>Stronger header validation</strong>: prefer host ValidateHeaders if available; when falling back, treat blank-but-present headers differently from missing headers. Make missing-header behavior configurable (fail vs warn) via Settings. <br>5. <strong>Test_RunAll improvements</strong>: ensure it cleans up artifacts between runs (remove previous test output) to make the harness idempotent. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing & verification (10× checklist)</strong><br>1) Preflight path: run with Settings/Input/Rules present and missing to verify proper strict behavior and logged messages.<br>2) Job folder resolution: confirm GenerateJobIdIfEmpty writes JOB_ID correctly and GetJobFolderPath constructs folder with jobId; test when OUTPUT_BASE missing. <br>3) Brackets and normalization: feed tblBrackets with 1-based arrays and missing rates; verify NormalizeBracketArraysLocal produces 0-based uppers and rates length = uppers.Count + maybe one depending on contract. <br>4) TER ingestion: create TER_* tables with varied rows; confirm terTables dictionary structure and that modCalc.SetTERTables is invoked (or logged fallback).<br>5) Input load & header validation: missing/blank headers behavior when STRICT_BPJS True/False; test both host ValidateHeaders and fallback path. <br>6) ProcessRow error handling: simulate ProcessRow raising for some rows and confirm logs and that other rows continue to process. <br>7) CSV generation: verify buktiRows/per11Rows arrays match expected header mapping and that WriteCsvAtomic produces valid CSVs in job folder; test large row counts. <br>8) Manifest creation: test modManifest.WriteManifest called with correct fileList contents; if modManifest missing, log WARN but do not crash. <br>9) ImportCsvToSheet behavior: confirm imports into Outputs sheets when present; test missing Outputs sheet resulting in WARN from orchestrator (ImportCsvToSheet strictness captured). <br>10) Test_RunAll harness: idempotent creation of Settings and sample input, run pph21_RunAll, verify expected files exist in job folder and harness logs results. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational notes & known risks</strong><br>• Divergent implementations of bracket normalization between modIO and local NormalizeBracketArraysLocal may cause subtle off-by-one or rate-length mismatches — consolidate to single authoritative implementation.<br>• Reliance on host-provided functions (ValidateHeaders, ProcessRow, EnsureTblInputFormatting, GetConfig) means behavior can vary by environment; include integration tests in deployment pipeline.<br>• File-system operations on network shares can fail intermittently; add retries and clear diagnostic logs for post-mortem. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Documentation & versioning</strong><br>• Add module header with version, last-reviewed timestamp, and authoritative list of required host modules/APIs.<br>• Document expected behavior for fallback modes and the strictness semantics (when orchestrator will abort vs continue). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final acceptance criteria before production</strong><br>• All dependencies (modIO, modCalc, modUtils, modManifest) present and smoke-tested.<br>• 10× checklist executed and green on target deployment machines (local and network paths).<br>• Bracket normalization behavior harmonized and verified with unit tests.<br>• Retry/backoff added for file operations and manifest writing, and Test_RunAll made idempotent. </td></tr></tbody></table></div><div class="row-count">Rows: 28</div></div><div class="table-caption" id="Table3" data-table="Proj_0013_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module Name</strong><br>modManifest.bas (manifest writer + SHA-256 utilities) </td></tr><tr><td data-label="Technical Breakdown"> <strong>Purpose</strong><br>Produce a JSON manifest for a job folder containing file metadata (relative path, size, modified timestamp, sha256). Provide robust file hashing: prefer system <code>certutil</code> via shell, otherwise compute SHA-256 internally from file bytes. Provide safe atomic write for the manifest with host fallback. Expose public APIs for file hashing, binary reading, and manifest writing. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Design Principles</strong><br>• <strong>Defensive fallback-first</strong>: prefer system tooling (certutil) for speed/compatibility; fall back to an internal byte-based SHA-256 implementation if unavailable.<br>• <strong>Late-bound COM usage</strong>: ADODB.Stream and Scripting.FileSystemObject used by late binding to avoid compile-time references.<br>• <strong>Minimal external surface</strong>: host helpers (modUtils, modIO) attempted via Application.Run; local fallbacks used when host calls fail.<br>• <strong>Atomic file writes</strong>: attempt host WriteUtf8FileAtomic first; if unavailable, write via ADODB.Stream to a .tmp then move to final path.<br>• <strong>Clear logging</strong>: LogMsgLocal attempts modUtils.LogMsg and falls back to Debug.Print. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API (observed & preserved)</strong><br>Function SHA256_FileHex(ByVal filePath As String) As String — returns 64-char lowercase hex or "" on error.<br>Function ReadBinaryFile(ByVal filePath As String) As Byte() — reads file bytes via ADODB.Stream; returns zero-length array on error.<br>Function WriteManifest(ByVal jobFolder As String, ByVal jobId As String, ByVal fileList As Collection) As Boolean — writes manifest.json to jobFolder; returns True on success. </td></tr><tr><td data-label="Technical Breakdown"> <strong>SHA256_FileHex behavior</strong><br>• Validates input path and file existence (via FileExistsLocal).<br>• Attempts to call <code>certutil -hashfile &lt;file&gt; SHA256</code> through <code>WScript.Shell.Exec</code> and reads StdOut, then extracts the first 64+ hex substring using ExtractFirstHex64. If a valid 64-hex candidate is found returns its lowercase first 64 chars.<br>• If certutil path/exec fails or output can't be parsed, falls back to internal calculation: ReadBinaryFile → SHA256_Bytes → BytesToHex. Returns empty string on any failure and logs error. </td></tr><tr><td data-label="Technical Breakdown"> <strong>ReadBinaryFile behavior</strong><br>• Uses ADODB.Stream with Type=1 (binary) and .LoadFromFile to return a Byte() array containing file bytes.<br>• On error returns zero-length byte array and logs via LogMsgLocal. Ensures stream closed on failure. </td></tr><tr><td data-label="Technical Breakdown"> <strong>BytesToHex</strong><br>• Converts a Byte() to a lowercase hex string by iterating bytes and concatenating two-digit hex. Returns "" on error. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Internal SHA-256 implementation (SHA256_Bytes)</strong><br>• Implements SHA-256 fully in VB using byte-array message padding and chunk processing.<br>• Helpers: ROR32 (rotate-right for 32-bit words), ADD32 (mod 2^32 multi-addition helper).<br>• Constructs message schedule <code>w(0..63)</code>, computes compression loop with constants <code>K</code> and initial <code>Hvals</code>, and finally outputs a 32-byte digest as Byte() array.<br>• Defensive: returns zero-length array on error and logs. Designed to be self-contained when certutil not available. </td></tr><tr><td data-label="Technical Breakdown"> <strong>ExtractFirstHex64</strong><br>• Uses VBScript.RegExp to find candidate hex-like substrings (allows spaces and dashes). Cleans spaces/dashes and returns first 64-hex-character substring if present; otherwise returns empty string. Used to parse <code>certutil</code> output robustly. </td></tr><tr><td data-label="Technical Breakdown"> <strong>WriteManifest behavior</strong><br>• Validates jobFolder and jobId and ensures trailing backslash on jobFolder.<br>• Attempts to ensure folder exists via <code>modUtils.EnsureFolderExistsWithRetry</code>; if host helper fails, falls back to <code>MkDir</code> if needed.<br>• Filters <code>fileList</code> to <code>goodItems</code> that physically exist (Scripting.FileSystemObject).<br>• If no good files found writes minimal manifest (empty files array, total_size_bytes 0) using WriteTextFileAtomic and returns True/False based on that call's result.<br>• For each good file computes SHA256_FileHex (silently uses empty string if hashing fails), determines relative path wrt jobFolder when possible, collects size and modified timestamp. Constructs manifest JSON string with escaped fields and total_size_bytes aggregated. Writes manifest via WriteTextFileAtomic and returns Boolean success. Logs errors. </td></tr><tr><td data-label="Technical Breakdown"> <strong>WriteTextFileAtomic</strong><br>• Attempts host <code>modIO.WriteUtf8FileAtomic</code> via Application.Run first; if successful returns True.<br>• Otherwise uses ADODB.Stream: writes <code>content</code> to tmpPath (folderPath + fileName + ".tmp") with Charset="utf-8", then moves tmp->final via FileSystemObject.MoveFile. Ensures folder exists. Returns True if final file exists. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Local wrappers / fallbacks</strong><br>• FileExistsLocal(path) — FSO.FileExists wrapper.<br>• LogMsgLocal(source, text, level) — attempts Application.Run "modUtils.LogMsg" and falls back to Debug.Print. Used throughout for consistent logging. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling & logging policy</strong><br>• Functions use On Error handlers to log and return safe failure values (empty string, zero-length arrays, False).<br>• WriteManifest logs errors with context and returns False on fatal failure. SHA256_FileHex logs and returns empty string on error. ReadBinaryFile returns [] and logs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Dependencies & runtime requirements</strong><br>• Optional/primary host helpers: modUtils.LogMsg, modUtils.EnsureFolderExistsWithRetry, modIO.WriteUtf8FileAtomic (attempted via Application.Run).<br>• COM dependencies (late bound): ADODB.Stream, Scripting.FileSystemObject, VBScript.RegExp, WScript.Shell (for certutil Exec).<br>• Platform assumption: Windows with certutil available is preferred but not required because of internal fallback. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance & scaling considerations</strong><br>• Using certutil is fast and avoids loading entire files into VBA memory; internal SHA256_Bytes requires loading file bytes into RAM — may be memory-heavy for very large files (>>100MB). ReadBinaryFile uses ADODB.Stream.Read which returns whole file as Byte(), so large files increase memory usage and runtime.<br>• Manifest generation computes SHA-256 per file sequentially; consider parallelization outside VBA if many or very large files. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security & correctness notes</strong><br>• Manifest JSON escapes control characters and quotes via EscapeJson but does not perform Unicode normalization — filenames with unusual Unicode should be validated in the environment.<br>• When computing relative paths the module compares normalized prefix of full path to jobFolder; path normalization is case-insensitive for Windows but relies on simple string prefix comparison; network-mounted UNC path edge-cases should be tested. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Immediate recommended fixes & hardening (minimal, high-impact)</strong><br>1) <strong>Large-file memory safety:</strong> when file > X MB (e.g., 100MB) prefer certutil path or stream incremental digest algorithm to avoid loading whole file into Byte() at once. Implement chunked reading for SHA256_Bytes to operate on 64KB blocks rather than full-buffer. <br>2) <strong>Certutil execution robustness:</strong> capture Exec errors and StdErr separately; apply timeouts and limit output length; validate cmd escaping for special characters in file paths.<br>3) <strong>Path normalization:</strong> canonicalize jobFolder and full paths (remove trailing slashes, resolve <code>\\?\</code> prefixes, normalize case) before computing relative paths to avoid incorrect rel entries. <br>4) <strong>Manifest schema version:</strong> include <code>manifest_version</code> field and module version constant for easier post-processing and backwards compatibility. <br>5) <strong>Atomic write verification:</strong> after write, verify manifest JSON is parseable (quick parse/regex) to avoid writing truncated files from MoveFile races. <br>6) <strong>Permission & concurrency diagnostics:</strong> on write failures log OS-level error codes where possible and add retry/backoff for MoveFile operations (transient lock handling). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing & verification (10× checklist)</strong><br>1) SHA256_FileHex(certutil present): compute hash for sample files (small, medium, large) and compare against known good values; ensure ExtractFirstHex64 parses certutil output in various locales.<br>2) SHA256_FileHex(fallback): temporarily disable certutil path (or mock WScript.Shell.Exec failure) and verify SHA256_Bytes output matches certutil/known-good vectors for test files (including empty file, 1-byte, 1KB, 1MB, and files with non-ASCII bytes).<br>3) ReadBinaryFile: verify returned Byte() length equals file size for binary files and recovery behavior for missing/locked files. <br>4) SHA256_Bytes edge cases: test with zero-length input, lengths not multiple of block size, and very large inputs for correctness and performance. <br>5) WriteManifest: with an empty fileList, confirm manifest.json contains files:[] and total_size_bytes:0 and file created successfully. <br>6) WriteManifest: for mixed absolute paths inside/outside jobFolder verify relative path computation and JSON entries are correct. <br>7) WriteTextFileAtomic: simulate host modIO.WriteUtf8FileAtomic present and missing; confirm fallback ADODB.Stream path writes correct file and cleans up tmp files on failure. <br>8) Concurrent write tests: attempt parallel manifest writes (or write while external process reads) to ensure atomicity and robust MoveFile semantics. <br>9) Error/logging tests: simulate missing FSO, ADODB, or WScript.Shell and confirm LogMsgLocal and failure modes behave without unhandled errors. <br>10) Integration test: end-to-end in target environment (local FS and network share) producing manifest for job folder created by pipeline; verify manifest file parses and SHA256 values verify against certutil. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational notes & known risks</strong><br>• Internal SHA256_Bytes is correct but resource-heavy — for many large files prefer external hashing tool. <br>• Relying on <code>WScript.Shell.Exec</code> may be blocked by policy on some endpoints; fallback is mandatory. <br>• RegExp usage for hex extraction is permissive (accepts spaces/dashes); ensure no false positives from unrelated text in certutil output in localized systems. <br>• MoveFile/MkDir on network shares can fail with transient errors — add retries and better diagnostics. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Documentation & versioning</strong><br>• Module includes <code>MODMANIFEST_VERSION</code> constant; recommended to include manifest schema version in generated JSON and update changelog on changes.<br>• Document required COM components and permissions (ability to run certutil, create files, move files) in deployment notes. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final acceptance criteria before production</strong><br>• Run 10× checklist on representative target machines (local disk, network share, locked-file scenarios).<br>• Add chunked SHA-256 path to avoid full-file memory load for files > threshold. <br>• Add manifest schema version field and ensure manifest.json parseable after write.<br>• Confirm fallback logging and host helper fallbacks are exercised and produce clear diagnostic logs. </td></tr></tbody></table></div><div class="row-count">Rows: 21</div></div><div class="table-caption" id="Table4" data-table="Proj_0013_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module Name</strong><br>modUtils.bas </td></tr><tr><td data-label="Technical Breakdown"> <strong>Purpose</strong><br>Utility and platform/shim helpers used across the payroll pipeline. Responsibilities: resilient logging to a Logs sheet with masking, folder creation with retries, atomic-safe file move/copy semantics, sleep/backoff utilities, GUID/random suffix generation, and safe Application.Run wrappers. Designed to be defensive and tolerant of missing COM/host features. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Design Principles</strong><br>• <strong>Defensive, fallback-first</strong>: tries nominal approach and falls back to safe alternatives (e.g., attempt Application.Run for host logging, fallback to Debug.Print).<br>• <strong>Idempotent helpers</strong>: EnsureFolderExists is recursive and safe to call multiple times; EnsureFolderExistsWithRetry provides exponential backoff.<br>• <strong>Atomic file operations</strong>: SafeMoveFile and SafeCopyFileAtomic use tmp-naming, copy+move fallbacks, and cleanup to reduce race conditions on network shares.<br>• <strong>Non-blocking integration with host</strong>: SafeRunNoArgs and SafeRunWithArgs wrap Application.Run to avoid raising unhandled errors in orchestrator flows. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API (observed & preserved)</strong><br>Sub LogMsg(logsSheetName, msg, Optional level, Optional context), Function MaskSensitive(text) As String, Function EnsureFolderExists(folderPath, Optional createIfMissing), Function EnsureFolderExistsWithRetry(folderPath, Optional maxAttempts, Optional baseDelayMs), Function SafeMoveFile(srcPath, dstPath), Function SafeCopyFileAtomic(srcPath, dstPath), Sub DeleteFileIfExists(fpath), Sub SafeRunNoArgs(procName), Sub SafeRunWithArgs(procName, ParamArray args()). Additional visible helpers: SheetExists (private), SleepMs (private), GenerateGuidSuffix (private), FormatRandom (private). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Logging (LogMsg)</strong><br>• Writes timestamped entries to a Logs sheet (constant LOG_SHEET_NAME = "Logs"). If Logs sheet absent it creates it at the end of workbook and initializes header row ["Timestamp","Level","Message","Context"].<br>• Writes masked message and context via MaskSensitive before storing. Uses Application.ScreenUpdating toggles for performance. On any error, falls back to Debug.Print with formatted timestamp/level. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Sensitive-data masking (MaskSensitive)</strong><br>• Uses VBScript.RegExp to detect long digit sequences (pattern <code>(\d[\d\.\-\/\s]{11,}\d)</code>) and also any run of 5+ digits (<code>(\d{5,})</code>).<br>• Replaces matches with masked variants produced by SimpleMaskDigits which preserves formatting and masks middle digits to "X" while keeping first/last N digits (defaults keepLeft=2, keepRight=2).<br>• ReplaceOnce used to ensure single replacement per matched occurrence to avoid accidental duplicate masking. Falls back to original text on error. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Mask algorithm details (SimpleMaskDigits & ReplaceOnce)</strong><br>• SimpleMaskDigits extracts digits, builds maskedDigits as left/right preserved with X-filled middle, then rebuilds original string preserving non-digit characters in-place.<br>• ReplaceOnce finds first case-insensitive occurrence of <code>find</code> in <code>source</code> and replaces only that occurrence (avoids replacing repeated identical substrings). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Folder creation helpers</strong><br>• EnsureFolderExists(folderPath, createIfMissing=True): uses Scripting.FileSystemObject to test existence and recursively create parent folders as needed. Returns Boolean. Logs error via LogMsg on exceptions.<br>• EnsureFolderExistsWithRetry(folderPath, maxAttempts=3, baseDelayMs=200): attempts EnsureFolderExists with exponential backoff using SleepMs; returns Boolean success. Alias EnsureFolderWithRetry provided. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Atomic-safe file moves & copies</strong><br>• SafeMoveFile(src, dst): attempts direct FSO.MoveFile; on failure copies src→tmp in dst folder and moves tmp→dst; cleans up src; verifies dst presence. Creates dst folder if missing. Logs errors and returns Boolean. Designed to handle cross-volume or permission issues where MoveFile may fail. <br>• SafeCopyFileAtomic(src, dst): copies src→tmp then moves tmp→dst or copies tmp→dst as fallback. Returns Boolean success and logs on error. </td></tr><tr><td data-label="Technical Breakdown"> <strong>File utilities</strong><br>• DeleteFileIfExists(fpath): deletes file if present; tolerates errors silently.<br>• SheetExists(sName): private helper to check worksheet presence; used by LogMsg. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Sleep & timing helpers</strong><br>• SleepAPI declared PtrSafe when VBA7; SleepMs(ms) attempts to call SleepAPI and falls back to busy-check loop with DoEvents and Timer to wait specified milliseconds. This ensures cross-version compatibility and avoids blocking Excel UI indefinitely. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Random / GUID suffix generation</strong><br>• GenerateGuidSuffix(length): primary path uses Scriptlet.TypeLib GUID trimmed and right-sliced; fallback generates random numeric string of requested length with Randomize/Rnd. <br>• FormatRandom(digits): numeric random string generator used by fallback. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Safe Application.Run wrappers</strong><br>• SafeRunNoArgs(procName): calls Application.Run procName and logs error if it fails. <br>• SafeRunWithArgs(procName, ParamArray args): calculates argCount and calls Application.Run with up to 5 arguments explicitly; logs error for >5 args or on failure. This avoids vararg dispatch exceptions bubbling up. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling & logging policy</strong><br>• All public functions/subs include On Error handling: log relevant diagnostic to Logs sheet and return safe default (False, empty, or nothing) instead of raising — consistent with defensive design to avoid crashing orchestrator.<br>• SafeMoveFile/EnsureFolderExists include contextual LogMsg calls identifying source function for easier post-mortem. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Dependencies & runtime assumptions</strong><br>• Requires Scripting.FileSystemObject, Scriptlet.TypeLib (optional), and VBScript.RegExp via CreateObject (late binding).<br>• No compile-time references required; late-bound calls make the module robust across target machines but require those COM objects to be present at runtime. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance & concurrency notes</strong><br>• SafeMoveFile uses copying and deletion which increases I/O and temporarily doubles storage usage for large files — acceptable for small-to-moderate payloads but caution on large network shares.<br>• EnsureFolderExistsWithRetry uses exponential backoff to tolerate intermittent network share unavailability. SleepMs fallback uses DoEvents loop which keeps UI responsive but depends on Timer wrap-around handling. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security & data hygiene</strong><br>• MaskSensitive reduces exposure of long digit sequences (NIP/NPWP) in logs; masking preserves surrounding formatting to aid debugging while minimizing PII leakage. However masking heuristics are heuristic-based and may produce false positives/negatives; review patterns against real data.<br>• GenerateGuidSuffix fallback uses Rnd — not cryptographically secure; adequate for tmp filename uniqueness but not for security-sensitive tokens. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Immediate recommended fixes & hardening (minimal, high-impact)</strong><br>1) <strong>SafeMoveFile atomicity:</strong> add retry/backoff around MoveFile/CopyFile operations and capture OS HRESULT/error codes where possible for diagnostics.<br>2) <strong>Masking improvements:</strong> expand regex patterns to detect NPWP/NIP canonical formats explicitly and add configuration for masking policy (keepLeft/keepRight). Add unit tests to ensure no accidental masking of small numeric IDs. <br>3) <strong>Tmp-name collision resistance:</strong> include timestamp + GUID + process ID (if available) in tmpName to further reduce collision risk on high-concurrency environments. <br>4) <strong>SafeRunWithArgs flexibility:</strong> implement dynamic Application.Run invocation using CallByName-like technique or build argument array dispatch to support >5 args robustly. <br>5) <strong>Logging durability:</strong> when Logs sheet creation fails (protected workbook, readonly), write to an alternate hidden sheet or external text log to guarantee persistence. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing & verification (10× checklist)</strong><br>1) LogMsg: create Logs sheet when absent, append rows correctly, and fallback to Debug.Print on failure.<br>2) MaskSensitive: test masking on representative strings (NIP, NPWP, long numbers with separators, short numbers) ensuring preserved formatting and correct masking length.<br>3) EnsureFolderExists: recursive folder creation for nested paths on local and network share; handle permission-denied gracefully.<br>4) EnsureFolderExistsWithRetry: simulate transient folder creation failure and verify retries and eventual success/failure as expected.<br>5) SafeMoveFile: move local file, move across volumes (simulate rename failure), and verify tmp-copy fallback and cleanup. <br>6) SafeCopyFileAtomic: copy file with target existing and non-existing; verify atomic replacement semantics. <br>7) SleepMs: verify millisecond waits using SleepAPI path and fallback path; ensure no busy CPU spin and correct elapsed timing. <br>8) GenerateGuidSuffix: test primary GUID path and fallback numeric generation for requested lengths; check uniqueness across multiple calls. <br>9) SafeRunNoArgs / SafeRunWithArgs: call existing and non-existing procedures and verify errors are logged (not raised); test with 0..5 args and >5 args behavior. <br>10) Concurrency & cleanup: stress-test multiple simultaneous SafeMoveFile/SafeCopyFileAtomic calls to same dst folder to observe tmp collisions and confirm correctness. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational notes & known risks</strong><br>• Late-bound COM components may be unavailable on locked-down systems (VBScript.RegExp, Scriptlet.TypeLib). Module handles many errors but certain functions (masking, GUID generation) will fall back to weaker paths.<br>• Network shares present the largest operational risk (file locks, partial writes, permission issues). Add verbose logging around failures to aid incident response.<br>• MaskSensitive uses heuristics — ensure legal/operations teams approve masking policy before production logs are retained long-term. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Documentation & versioning</strong><br>• Recommend adding module header with MODUTILS_VERSION and short changelog. Document expected external behaviors (tmp-naming, masking rules, max arg count for SafeRunWithArgs).<br>• Document failure modes (when fallback occurs) so integrators know where to look in logs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final acceptance criteria before production</strong><br>• Execute 10× checklist on target environments (local and network share).<br>• Implement small hardenings: MoveFile retry/backoff, stronger tmp-name suffix, and optional masked patterns config. <br>• Confirm Logs sheet is writable in deployment scenarios or provide alternate durable logging sink. </td></tr></tbody></table></div><div class="row-count">Rows: 22</div></div><div class="table-caption" id="Table5" data-table="Proj_0013_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module Name</strong><br>modCalc.bas (core withholding & tax engine for PPh21 pipeline) </td></tr><tr><td data-label="Technical Breakdown"> <strong>Purpose</strong><br>Primary calculation engine for payroll withholding (PPh21) and related employer/employee contributions. Responsibilities: ingest normalized input rows (employee, gross, period_type, ptkp_status, BPJS fields, NPWP flag), apply configuration (calculation mode, rounding rules, TER tables, BPJS rules), choose calculation path (TER vs progressive), compute withholding amounts (monthly/annual as required), emit resolved numeric fields (withholding amounts, ter_applied flag, matched rule id, debug diag), and provide programmatic hooks for batch processing and per-row diagnostics. Export results into expected output schema for downstream writers. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Design Principles</strong><br>• <strong>Pluggable decision paths</strong>: encapsulate TER lookup, progressive tax, and exceptional rules behind discrete functions so callers can force any path for testing.<br>• <strong>Deterministic matching</strong>: range/bucket matching rules implement explicit precedence (canonical normalization, inclusive lower bound, inclusive upper bound behaviour documented) and deterministic tie-breaking (smallest range width → first-match fallback).<br>• <strong>Defensive parsing & normalization</strong>: all numeric and textual inputs are normalized (trim, case normalize, thousands/delimiter stripping, comma→dot decimal normalization) before logic runs. Invalid inputs are logged and route to safe fallback.<br>• <strong>Config-driven</strong>: behaviour controlled by canonicalized config keys (VERBOSECALC, CALC_MODE, ANNUALIZATION_DEFAULT, ROUNDMIDPOINTRULE, TER tables set via SetTERTables).<br>• <strong>Auditability</strong>: every decision attaches minimal audit metadata (matched_table_row_id, parsed_rate_source, calculation_path, rounding_applied) for traceability. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API (observed & recommended)</strong><br>Function CalcRow(ByVal row As Dictionary) As Dictionary — primary entry: accepts row dictionary, returns dictionary with computed fields (withholding_monthly, withholding_annual, ter_applied, matched_ter_id, debug_log array, error flag).<br>Function CalcBatch(ByVal rows As Collection) As Collection — process collection of rows, returns collection of result dictionaries and aggregated diagnostics.<br>Sub SetTERTables(ByVal terTables As Collection) — inject TER lookup table into engine; normalizes rows and builds internal index. <br>Function ResolveTER(ByVal gross As Double, ByVal ptkp_status As String, ByVal period_type As String) As TERResult — performs lookup, percent parsing, and returns struct: {found As Boolean, terRate As Double, terMonthly As Double, matchedRowId As String, parseWarnings}.<br>Function ComputeProgressive(ByVal taxableAnnual As Double) As ProgressiveResult — computes progressive tax schedule, returns annual tax and breakdown per bracket.<br>Function NormalizeInputRow(ByVal rawRow As Dictionary) As Dictionary — returns normalized canonical input. <br>Function ApplyRounding(ByVal amount As Double) As Double — encapsulates rounding per ROUNDMIDPOINTRULE (Bankers, Half Up, Truncate).<br>Function InitConfig(ByVal configDict As Dictionary) As Boolean — load/validate runtime config into module-level state. </td></tr><tr><td data-label="Technical Breakdown"> <strong>High-level calculation flow (per-row)</strong><br>1. <strong>Normalize</strong> inputs (strings, numbers, period semantics).<br>2. <strong>Sanity checks</strong> (gross ≥ 0, required fields present). If failure: attach error, route to safe fallback (progressive or zero) depending on config.<br>3. <strong>BPJS treatment</strong>: apply IN/OUT rules per config (include employer BPJS in gross, allow employee deductions) and compute deductible BPJS portions as needed; if BPJS data missing and SAFE_FALLBACK_BPJS_ZERO=True, treat as zero with warning.<br>4. <strong>PTKP/status mapping</strong>: normalize ptkp_status and map to TER category keys.<br>5. <strong>TER resolution</strong>: call ResolveTER with gross/annualized values depending on period_type and ANNUALIZATION_DEFAULT. If ResolveTER returns found and numeric terRate > 0, compute withholding = gross × terRate (period-appropriate). Set ter_applied=True and record matchedRowId. If entry exists but rates invalid (zero/parse-failed) → treat as TER invalid and route progressive path (ter_applied=False).<br>6. <strong>Progressive path</strong>: compute taxable annual (apply annualization, subtract PTKP allowances where applicable), call ComputeProgressive, convert annual to period withholding if needed; set ter_applied=False and attach bracket breakdown.<br>7. <strong>Rounding & finalization</strong>: apply ApplyRounding to the computed withholding; enforce MIN/MAX or caps (e.g., MAX_PREMI_ASURANSI_PCT) where config dictates.<br>8. <strong>Diagnostics & audit</strong>: populate debug_log entries (only if VERBOSECALC=True) with step-by-step parse, matched rule, numeric conversions, and final result. </td></tr><tr><td data-label="Technical Breakdown"> <strong>TER logic specifics</strong><br>• <strong>Normalization:</strong> TER table rows normalized on SetTERTables: Category -> uppercase, GrossLow/GrossHigh -> numeric (GrossHigh ≤ 0 treated as open-ended). TER rates parsed from TER_monthly, TER_percent, or string percent fields; comma and space tolerant. <br>• <strong>Lookup precedence:</strong> match by category then by numeric range; inclusive rules: GrossLow ≤ gross ≤ GrossHigh unless GrossHigh is open; on overlap, prefer smallest (GrossHigh−GrossLow) then first-insert fallback.<br>• <strong>Percent handling:</strong> if TER_percent specified as string (e.g., "1.5%") parse to decimal; if TER_monthly present take precedence for monthly period_type; if only percent present convert to monthly if configured (TER_percent could mean annual — module documents expected unit).<br>• <strong>Invalid rate fallback:</strong> if resolved terRate ≤ 0 or parsing failed → mark TER invalid and force progressive path. All parse warnings logged. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Progressive tax specifics</strong><br>• <strong>Taxable base derivation:</strong> taxableAnnual = (annualized gross − PTKP_allowance − deductible employee BPJS where allowed). Module supports standard PTKP table keyed by ptkp_status; ensure PTKP table is provided by caller or loaded from policy module.<br>• <strong>Bracket computation:</strong> ComputeProgressive iterates defined progressive brackets (thresholds & rates), applying each bracket sequentially; returns detailed bracket usage array for auditing. <br>• <strong>Annual↔Periodic conversion:</strong> when period_type is monthly but calculation done annually, divide annual tax by 12 and round per ROUNDMIDPOINTRULE. Annualization governed by ANNUALIZATION_DEFAULT and period_type parameter. </td></tr><tr><td data-label="Technical Breakdown"> <strong>BPJS & contribution handling</strong><br>• <strong>Deductible vs non-deductible:</strong> employee BPJS treated as deductible if EMPLOYEE_BPJS_DEDUCTION/ALLOW_EMPLOYEE_BPJS_DEDUCTION True. Employer BPJS inclusion controlled by TREATEMPLOYERBPJSASGROSS / INCLUDE_EMPLOYER_BPJS_IN_GROSS — resolve conflicts per config loader policy. <br>• <strong>Caps:</strong> MAX_PREMI_ASURANSI_PCT and other caps enforced when computing deductible amounts; if premium exceeds cap, cap applied and warning logged. <br>• <strong>Fallbacks:</strong> absent or malformed BPJS fields trigger SAFE_FALLBACK_BPJS_ZERO True behaviour. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Rounding & numeric hygiene</strong><br>• <strong>Rounding rule encapsulated</strong>: ApplyRounding implements BANKERS (round half to even), HALF_UP, TRUNCATE; rounding applied at final withholding and at any intermediate period conversions where policy requires. <br>• <strong>Precision & types:</strong> calculations use Double but final outputs coerced to Long/Integer cents if downstream requires integer currency units; module documents expected units. <br>• <strong>Overflow/large numbers:</strong> engine validates Gross/annualGross against safe numeric thresholds and logs or errors on absurd values to avoid overflow. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Configuration & external dependencies</strong><br>• <strong>Relies on</strong>: config module (canonical keys), TER tables (SetTERTables), PTKP table, modUtils logging helper, modIO for persistence. <br>• <strong>Behavior toggles</strong>: VERBOSECALC for verbose logs, CALC_MODE to force progressive/TER-only, ANNUALIZATION_DEFAULT for period mapping, ROUNDMIDPOINTRULE for rounding semantics. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Logging & diagnostics</strong><br>• <strong>Log levels</strong>: debug (VERBOSECALC), info (results summary), warn (parsing anomalies), error (fatal computation failures). <br>• <strong>Audit fields emitted per row</strong>: matched_ter_id, calculation_path (TER<code>|</code>PROGRESSIVE<code>|</code>OVERRIDE), parsed_rates (raw→normalized), warnings array, final amount pre-round and post-round. <br>• <strong>Non-sensitive logging</strong>: respect LOG_MASK_SENSITIVE for NPWP and PII; include only synthetic identifiers where masking required. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling & fail-safe policies</strong><br>• <strong>Non-fatal errors</strong> (parse failures, missing optional fields): attach warning, route to safe default (progressive or zero) depending on config, continue processing. <br>• <strong>Fatal errors</strong> (config missing critical item like PTKP table or malformed TER table causing no possible path): return error flag for batch and stop further processing if strict mode enabled. <br>• <strong>Concurrency / snapshotting</strong>: when TER tables can be reloaded at runtime, lookups operate on a snapshot copy to avoid partial-read race conditions. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance considerations</strong><br>• <strong>Batch processing</strong>: CalcBatch precomputes normalized TER index and PTKP lookups to avoid per-row normalization overhead. <br>• <strong>Memory vs CPU</strong>: computations are cheap per-row; heavy cost is logging when VERBOSECALC=True and very large batch sizes; consider streaming results to writer to reduce memory. <br>• <strong>Parallelization</strong>: module is single-threaded by default (VBA); for very large batches, caller should partition and run separate processes/workers. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing & verification (10× checklist — run 10 verification passes)</strong><br>1) <strong>TER hit test</strong>: row with gross matching TER bucket (monthly) — assert ter_applied=True, withholding == gross × terRate, matchedRowId correct. <br>2) <strong>TER open-top test</strong>: very large gross matches open-ended GrossHigh ≤ 0 bucket. <br>3) <strong>TER invalid rate → progressive</strong>: TER row present but TER_monthly/percent zero or malformed → assert progressive path chosen and ter_applied=False. <br>4) <strong>Boundary tests</strong>: gross == GrossLow and gross == GrossHigh for buckets map to correct bucket per inclusive rules. <br>5) <strong>Overlap resolution</strong>: overlapping ranges for same category → assert deterministic tie-breaker (smallest width or configured priority). <br>6) <strong>BPJS inclusion/exclusion permutations</strong>: toggle TREATEMPLOYERBPJSASGROSS and INCLUDE_EMPLOYER_BPJS_IN_GROSS permutations and assert gross and deductions computed per policy; ensure no double-counting. <br>7) <strong>Rounding rules</strong>: test half-values to exercise BANKERS vs HALF_UP vs TRUNCATE. <br>8) <strong>Zero gross & missing fields</strong>: ensure gross=0, missing BPJS, or missing NPWP do not crash and produce expected outputs. <br>9) <strong>Annualization mapping</strong>: monthly→annual and annual→monthly conversions with ANNUALIZATION_DEFAULT on/off produce expected values and rounding behavior. <br>10) <strong>Logging & audit</strong>: with VERBOSECALC=True capture full debug_log entries and assert they contain matched_ter_id, parse steps, and final amounts. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Immediate recommended hardening (high-impact, minimal change)</strong><br>1) <strong>TER table strict parsing</strong>: validate TER table on SetTERTables and fail-fast with a detailed diagnostics collection if malformed rows exist. <br>2) <strong>Unit guarantees for percent fields</strong>: explicitly document and enforce that config and TER_percent accept either percent or decimal but are normalized to decimal internally; add STRICT_PERCENT_FORMAT toggle. <br>3) <strong>Deterministic tie-breaker</strong>: implement and document explicit tie-breaker policy for overlapping TER ranges; include matched_row_priority in audit. <br>4) <strong>Snapshot reads for runtime reloads</strong>: when SetTERTables called at runtime, swap atomically to a new index to avoid partial lookups. <br>5) <strong>Limit verbose logs</strong>: cap stored debug_log length per row to avoid OOM when VERBOSECALC=True on huge batches — stream to file if needed. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational notes & known risks</strong><br>• <strong>Misconfiguration risk</strong>: ambiguous percent units (20 vs 0.20) are common. Enforce schema and log conversions. <br>• <strong>BPJS flag contradictions</strong>: conflicting config keys lead to subtle double-counting; centralize canonical keys and enforce single source of truth. <br>• <strong>Performance vs traceability</strong>: VERBOSECALC useful for testing but expensive in production; prefer toggling per-job. <br>• <strong>Locale parsing</strong>: numeric formats with comma decimals or thousand separators must be normalized carefully; add locale-normalization utility and test with varied inputs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Dependencies & integration points</strong><br>• Requires canonical config loader, TER table provider (SetTERTables), PTKP policy table, modUtils for logging, modIO for persistence, and caller-provided row normalization in ETL stage.<br>• Provides outputs consumed by writers that produce CSV/JSON or integrate into accounting systems; ensure output schema contract is stable and versioned. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final acceptance criteria before production</strong><br>• Pass all 10× verification checklist items on representative data (edge cases included).<br>• TER table and PTKP table validation implemented and executed at startup or load time. <br>• Config schema validation in place to prevent ambiguous percent/unit configs. <br>• Add audit fields to outputs and ensure LOG_MASK_SENSITIVE respected. <br>• Document expected input contracts, canonical keys, and migration notes for legacy field names. </td></tr></tbody></table></div><div class="row-count">Rows: 18</div></div><div class="table-caption" id="Table6" data-table="Proj_0013_06" style="margin-top:2mm;margin-left:3mm;"><strong>Table 6</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module Name</strong><br>modConfig.ini / config loader (configuration parsing, validation, and runtime override utilities) </td></tr><tr><td data-label="Technical Breakdown"> <strong>Purpose</strong><br>Provide structured runtime configuration for the pph21 calculation pipeline. Responsibilities: parse key=value files (or env vars), normalize key names, coerce typed values, validate ranges/enums, expose programmatic getters with defaults, produce diagnostics for unexpected or conflicting values, and support safe runtime overrides for test vs production runs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Design Principles</strong><br>• Fail-fast validation at startup.<br>• Deterministic normalization of key names and numeric formats.<br>• Backward-compatible aliases for legacy pipelines.<br>• Diagnostic-first logging based on <code>VERBOSECALC</code>.<br>• Strict separation of parsing/validation from business logic. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API (observed & recommended)</strong><br>LoadConfig(path) → Boolean.<br>GetConfigString(key, default).<br>GetConfigBool(key, default).<br>GetConfigNumber(key, default).<br>ValidateConfig() → Collection of warnings/errors. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Parsing & normalization behavior</strong><br>• Trim whitespace; remove BOM.<br>• Accept <code>key = value</code> with optional quotes.<br>• Normalize keys to UPPER_SNAKE_CASE; map aliases to canonical keys.<br>• Boolean rules: TRUE/FALSE/1/0/YES/NO.<br>• Percent rules: accept 20, 20%, 0.20; normalize based on schema.<br>• Path rules: expand env vars; resolve relative paths; optional existence checks. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Key canonicalization & semantics</strong><br>• <code>OUTPUT_BASE</code> (required).<br>• <code>JOB_ID</code> (required).<br>• <code>RETRY_ATTEMPTS</code> (int ≥0).<br>• <code>RETRY_DELAY_MS</code> (int ≥0).<br>• <code>MOD_VERSION</code> (string).<br>• BPJS booleans: <code>INCLUDE_BPJS_FIELDS</code>, <code>TREATEMPLOYERBPJSASGROSS</code>, <code>INCLUDE_EMPLOYER_BPJS_IN_GROSS</code>, <code>EMPLOYEE_BPJS_DEDUCTION</code>, <code>ALLOW_EMPLOYEE_BPJS_DEDUCTION</code>, <code>STRICT_BPJS</code>, <code>SAFE_FALLBACK_BPJS_ZERO</code>.<br>• <code>CALC_MODE</code> (enum: STANDARD, PROGRESSIVE, TER_ONLY, DEBUG).<br>• Percent fields: <code>NPWP_PENALTY_PCT</code>, <code>DTP_PCT</code>, <code>MAX_PREMI_ASURANSI_PCT</code>.<br>• Logging toggles: <code>VERBOSECALC</code>, <code>LOG_MASK_SENSITIVE</code>.<br>• Rounding: <code>ROUNDMIDPOINTRULE</code> (BANKERS, HALF_UP, TRUNCATE). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Conflict detection & resolution policy</strong><br>• Canonical > legacy alias > environment variable.<br>• BPJS conflicts resolved deterministically; explicit keys override.<br>• Percent ambiguity (20 without %): treat as percent but log assumption; strict mode available. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Validation rules & schema</strong><br>• Required: OUTPUT_BASE, JOB_ID, CALC_MODE.<br>• Type rules for string/boolean/integer/number/enum.<br>• Range rules: RETRY_ATTEMPTS 0–10; RETRY_DELAY_MS 0–60000; percent fields 0–1 after normalization.<br>• Cross-field: VERBOSECALC=TRUE requires LOG_MASK_SENSITIVE=TRUE; ANNUALIZATION_DEFAULT=TRUE requires CALC_MODE compatible. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Logging & diagnostics</strong><br>• Emit canonical key → raw value → normalized value → source → warning flag.<br>• With VERBOSECALC=TRUE, show parse traces, conflict decisions, percent conversions; mask sensitive values. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Immediate recommended fixes & hardening</strong><br>1) Alias mapping for all BPJS variants.<br>2) Strict percent normalization.<br>3) Deterministic BPJS conflict resolver.<br>4) Output-path writability validator.<br>5) Enforce UPPER_SNAKE_CASE keys.<br>6) Implement schema validator during LoadConfig. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing & verification (10× checklist)</strong><br>1) Basic parse test.<br>2) Alias conflict test.<br>3) Percent variation tests.<br>4) BPJS contradiction tests.<br>5) Invalid enum rejection.<br>6) Range enforcement.<br>7) Path permissions handling.<br>8) VERBOSECALC masking validation.<br>9) Environment-override precedence test.<br>10) Regression tests in CI. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational notes & risks</strong><br>• Percent ambiguity risk.<br>• Key naming drift across pipelines.<br>• Silent defaults can hide misconfigurations.<br>• Runtime override must be logged persistently. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Implementation notes</strong><br>• LoadConfig returns success + diagnostics.<br>• DumpConfigSummary prints masked key table.<br>• EnforceSchema supports STRICT_MODE.<br>• Unit tests needed for percent parser, boolean parser, path resolver. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final acceptance criteria</strong><br>• All schema validation tests pass.<br>• BPJS consistency logic validated.<br>• Percent normalization stable and logged.<br>• VERBOSECALC output complete.<br>• Migration guide for legacy keys exists. </td></tr></tbody></table></div><div class="row-count">Rows: 14</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>