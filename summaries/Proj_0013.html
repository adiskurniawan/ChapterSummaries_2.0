<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1764792369">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#Table6">Table 6</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Proj_0013_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module Name</strong><br>modCalc.bas </td></tr><tr><td data-label="Technical Breakdown"> <strong>Scope & Purpose (concise)</strong><br>Single-file VBA engine for Indonesian payroll tax calculation: input normalization, rate parsing, bracket normalization, TER (table-driven exemption/rate) ingestion and deterministic resolution, progressive tax calculation, TER application, gross-up solver, legacy API compatibility, structured canonical wrappers for safer automation, and a unit-test harness. Designed for embedding inside Excel with optional host helpers (<code>modUtils</code>, <code>modTER</code>, <code>modIO</code>) called via <code>Application.Run</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>High-level responsibilities</strong><br>• Provide <code>GetConfig</code> to read Settings and apply defaults.<br>• Maintain in-memory TER tables and indices via <code>SetTERTables</code> / <code>GetTERTables</code> / <code>GetCurrentTERLoadId</code>.<br>• Normalize and validate bracket arrays (<code>NormalizeBracketArraysStructured</code>, <code>NormalizeBracketArraysLocal</code>, legacy wrappers).<br>• Parse rates and numeric values robustly (<code>ParseRateToFractionLocal</code>, <code>NzNumericSafe</code>).<br>• Core compute flows: <code>CalcRow</code> (legacy), <code>ProcessRow</code>, <code>ComputeTaxFromBrackets</code>, <code>ComputePTKP</code>, <code>SolveGrossUp</code> with structured wrappers returning canonical <code>{ok,result,error,diag}</code>.<br>• Provide helper utilities: cloning, masking, external-call safety, unit tests. </td></tr><tr><td data-label="Technical Breakdown"> <strong>API surface (public functions and contracts)</strong><br><strong>GetConfig() As Object</strong> — returns Scripting.Dictionary with config keys (booleans, strings, numeric defaults).<br><strong>SetTERTables(tables As Object)</strong> — ingest TER dataset (Dictionary of tables), normalizes rows, builds alias/wildcard indices, sets <code>g_TERtables</code> and <code>g_TER_table_load_id</code>.<br><strong>GetTERTables() As Object</strong>, <strong>GetCurrentTERLoadId() As String</strong> — accessors.<br><strong>ResolveCanonicalTERKey(lookupKey As String, Optional ByRef outMatchType As String) As String</strong> — returns canonical key and sets match type <code>external|direct|alias|wildcard|none</code>.<br><strong>LookupTERRow(category As String, grossTotal As Double, Optional terAudit As Object, Optional cfg As Object) As Object</strong> — returns row dictionary or Nothing; legacy behavior preserved.<br><strong>LookupTERRowStructured(...) As Object</strong> — returns dictionary <code>{ok:Boolean, result:row or Null, error:String or Null, diag:Dictionary or Null}</code>.<br><strong>NormalizeBracketArraysStructured(uppers As Variant, rates As Variant) As Object</strong> — canonical normalizer returning <code>{ok, uppers:Array, rates:Array, error}</code> and validating numeric contents; guarantees zero-based arrays and <code>rates</code> length = <code>UBound(uppers)+1</code>.<br><strong>NormalizeBracketArraysLocal / NormalizeBracketArrays / NormalizeBracketArrays_Local</strong> — compatibility shims that prefer structured normalizer, fallback to host <code>modIO</code> or legacy manual code.<br><strong>ParseRateToFraction(v As Variant) As Double</strong> — public wrapper calling <code>ParseRateToFractionLocal</code> (authoritative parser).<br><strong>NzNumericSafe(v As Variant) As Double</strong>, <strong>FloorToThousand(value As Double) As Double</strong>, <strong>IndoRound(value As Double, Optional digits As Long, Optional rule As String) As Double</strong> — numeric helpers.<br><strong>ComputeTaxFromBrackets(taxable As Double, uppers As Variant, rates As Variant) As Double</strong> — returns tax for annualized PKP/segments.<br><strong>ComputePTKP(rowDict As Object, Optional params As Object) As Double</strong> — PTKP resolver using params or defaults.<br><strong>CalcRow(rowDict As Object, Optional cfg As Object) As Object</strong> — legacy heavy logic returning Dictionary of outputs; <strong>CalcRowStructured(...)</strong> wraps it into canonical contract.<br><strong>ProcessRow / ProcessRowStructured</strong>, <strong>ComputeTax / ComputeTaxStructured</strong>, <strong>SolveGrossUp / SolveGrossUpStructured</strong> — batch and solver with canonical wrappers.<br><strong>SafeExternalCall(procName As String, Optional args As Variant, Optional timeoutMs As Long) As Object</strong> — external-run with timing, masked logging and timeout; returns <code>{ok,result,duration_ms,error}</code>.<br><strong>CloneDict / DeepCloneDict</strong> — shallow & recursive clone helpers. <br><strong>ValidateHeaders(sampleRow, requiredKeys) As Object</strong> — returns <code>{ok, missing:Array, unexpected:Array}</code>. <br><strong>RunMODCALCUnitTests()</strong> — expanded unit test harness. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Design principles & safety guarantees</strong><br>• <strong>Non-destructive by default:</strong> does not create worksheets or ListObjects; clones inputs before mutation. <br>• <strong>Backward compatibility:</strong> legacy function signatures preserved; structured wrappers added for safer automated integration. <br>• <strong>Defense-in-depth:</strong> pervasive <code>On Error</code> guards, defensive default values, and fallbacks for missing host subsystems. <br>• <strong>Deterministic selection:</strong> candidates sorted stably by range width → priority → insertion index to create repeatable TER selection. <br>• <strong>10× verification mindset:</strong> unit test harness and explicit test vectors included; instructions to run tests on a safe copy. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Detailed behavior: GetConfig</strong><br>Reads Settings via <code>LoadSettingsDict()</code> (host helper expected). Normalizes: booleans coercion via <code>CBool</code>/string checks; rate percentages normalized (NPWP_PENALTY_PCT handled robustly including "%" and >1 values converted /100). Defaults: <code>ANNUALIZATION_DEFAULT=&quot;monthly&quot;</code>, <code>CALC_MODE=&quot;standard&quot;</code>, <code>BRACKET_UPPERS</code> and <code>BRACKET_RATES</code> default arrays, <code>DEFAULT_BPJS_EMP_PCT=0.02</code>, <code>DEFAULT_BPJS_EMPLOYER_PCT=0.044</code>, <code>GROSSUP_MAX_ITER=50</code>, <code>GROSSUP_TOL=0.5</code>, <code>ROUNDMIDPOINTRULE=&quot;AWAY_FROM_ZERO&quot;</code>. On any fatal failure returns empty Dictionary (safe fallback). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Detailed behavior: TER ingestion (SetTERTables)</strong><br>• Accepts <code>tables</code> as Dictionary: each table (key K) is a Dictionary of rows. <br>• For each row: extracts <code>row_id</code>, Normalizes <code>GrossLow</code>, <code>GrossHigh</code> via <code>NzNumericSafe</code>, assigns <code>_is_open</code> if <code>GrossHigh &lt;= 0</code> and sets <code>_norm_GrossHigh = INTERNAL_MAX_GROSS</code> else copy. <br>• Parses TER percent/monthly/daily/period units with <code>ParseRateToFractionLocal</code>. <br>• Computes <code>_meta_priority</code> from <code>row_priority</code> or default 2147483647, <code>_meta_insertion_index</code> incremental global index, <code>_meta_rangeWidth = _meta_high - _meta_low</code>. <br>• Builds <code>g_TER_alias_index</code> (map alias→tables) and <code>g_TER_wildcard_index</code> for wildcard keys (supports <code>*</code> pattern and <code>wildcard</code> boolean/raw). <br>• After ingestion populates <code>g_TERtables</code> (uppercased keys) and generates <code>g_TER_table_load_id = timestamp-unique</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Detailed behavior: Resolve & Lookup</strong><br>• <code>ResolveCanonicalTERKey</code> tries external <code>modTER.ResolveCanonicalTERKey(lookupKey)</code> and <code>ResolveCanonicalTERKey</code> host calls first (non-fatal) and returns <code>external</code> match type if found. <br>• Next checks direct <code>g_TERtables</code> entry (direct). <br>• Next checks <code>g_TER_alias_index</code> and returns first table key found (alias). <br>• Next checks wildcard patterns using <code>Like</code> against uppercase key set and returns first matching table (wildcard). <br>• <code>LookupTERRow</code> uses <code>BuildSortedCandidates(tbl, grossTotal)</code> which filters rows by gross range and sorts stable by <code>[rangeWidth, priority, insertion_index]</code>. It selects first row with a positive TER value in the order: <code>TER_percent</code>, <code>TER_monthly</code>, <code>TER_daily</code>. Returns row dictionary or Nothing; populates <code>terAudit</code> dictionary keys (lookup key, match type, load id, map errors). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Sorting & selection algorithm (determinism details)</strong><br>• Candidate tuple for each row = <code>[key, rangeWidth, priority, insertion_index]</code>.<br>• Sort: increasing <code>rangeWidth</code> (narrower ranges preferred), then increasing <code>priority</code> (lower numerical priority wins), then increasing <code>insertion_index</code> (earlier ingestion wins). <br>• Stable sort implemented via insertion-like algorithm; O(n²) worst-case on candidate count (acceptable as candidate lists per table are expected small). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Bracket normalization (NormalizeBracketArraysStructured) — invariants</strong><br>Input: <code>uppers</code> may be array-like (any base). Output: <code>uppers</code> zero-based Double array length nU; <code>rates</code> zero-based Double array length nU+1. Validation: non-numeric entries produce <code>error</code> in result and <code>ok=False</code>. Host <code>modIO.NormalizeBracketArrays</code> used if present (call by reference). If <code>rates</code> shorter than required, last rate repeated to fill; if longer, trimmed. Default <code>rates</code> when absent: all 0.05 (5%). </td></tr><tr><td data-label="Technical Breakdown"> <strong>ParseRateToFractionLocal — logic & heuristics</strong><br>• Accepts numeric, string, Null, Empty. If numeric ≤1 returns value; if >1 returns value/100. <br>• Strings: remove currency token <code>Rp</code>, spaces; if contains <code>%</code> remove it then treat as percent (value/100). <br>• For strings with both <code>.</code> and <code>,</code> uses last-separator heuristic: if last comma after last dot, interpret <code>.</code> as thousands and <code>,</code> as decimal (strip dots, replace comma→dot). Else strip commas. <br>• Replace non-numeric chars with regex <code>[^0-9\.\-+]</code>. On parse failure returns 0. Robust against various local numeric formats and mis-decoded BOM-like characters. </td></tr><tr><td data-label="Technical Breakdown"> <strong>ComputeTaxFromBrackets — algorithmic details</strong><br>Inputs: <code>taxable</code>, zero-based <code>uppers</code> (0..n-1), <code>rates</code> (0..n). <br>Algorithm: iterate brackets i from LBound→UBound: segment = min(upper - prevUpper, taxable - prevUpper) if positive then <code>tax += segment * rate[i]</code>; stop early if taxable ≤ upper. After loop, tail taxable > prevUpper taxed with <code>rate[lastRateIndex]</code> (UBound of rates). Returns Double. Handles negative taxable by early-return 0. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CalcRow flow (step-by-step)</strong><br>1. Validate <code>rowDict</code> and optionally <code>cfg = GetConfig()</code>.<br>2. Determine <code>useTERMode</code> (row override > cfg fallback) using robust normalization (booleans/numeric/strings).<br>3. Validate inputs when <code>VALIDATE_INPUTS</code> true (e.g., <code>gross</code> present).<br>4. Read gross and currency; if <code>currency &lt;&gt; IDR</code> and <code>fx_rate</code> numeric >0, convert gross → IDR and set diag <code>currency_conversion</code>. <br>5. Aggregate <code>employerBPJS</code> and <code>employeeBPJS</code> from explicit numeric fields; if zero apply pct-based defaults from cfg (e.g., <code>bpjs_ke_emp_pct</code>) parsed with <code>ParseRateToFractionLocal</code>. Cap employer-premi via <code>MAX_PREMI_ASURANSI_PCT</code> and log WARN if exceeded. <br>6. Compute <code>grossForTax</code> (optionally include employer BPJS when <code>TREATEMPLOYERBPJSASGROSS</code> true). <br>7. Aggregate <code>totalDeductions</code> (employee BPJS deduction allowed via config, <code>iuran_pensiun</code>, <code>biaya_jabatan</code>, <code>other_deductions</code>). <br>8. <code>ptkp = ComputePTKP(rowDict, ReadParams(&quot;Rules&quot;,&quot;tblParams&quot;))</code>. <br>9. Annualize <code>annualGross</code> and <code>annualDeductions</code> based on <code>period_type</code> (monthly default) and <code>period_days</code>. <br>10. <code>ReadBrackets(&quot;Rules&quot;,&quot;tblBrackets&quot;, uppers, rates)</code> fallback to default if fail; then <code>NormalizeBracketArraysLocal uppers,rates</code>. <br>11. Determine <code>terCat</code> (explicit <code>ter_category</code> else <code>ResolveTERCategoryFromPTKP(ptkp_status)</code>), check <code>eligibleForTER = IsTERApplicable(rowDict)</code>. <br>12. If eligible and <code>useTERMode</code> allows, <code>LookupTERRow(terCat, annualGross, terAudit, cfg)</code> → if found apply TER via <code>ResolveTERRateFromRow(terRow, periodType, periodDays)</code> producing monthly withholding either by unit <code>annual_percent</code>, explicit monthly, or as <code>gross * terRate</code>. Compute <code>annualTax</code> = monthlyWithholding * periodsPerYear. <br>13. Else compute <code>taxableAnnual</code> (employee vs non-employee treatment) → <code>taxableAnnual = FloorToThousand(taxableBeforeFloor)</code> → <code>annualTax = ComputeTaxFromBrackets(taxableAnnual, uppers, rates)</code> → <code>monthlyWithholding = annualTax / 12</code>. <br>14. Apply NPWP penalty if <code>npwp_status</code> indicates missing; round <code>monthlyWithholding</code> using <code>IndoRound</code> per config rule → produce <code>taxRounded</code>. <br>15. Populate <code>out</code> dictionary with outputs and audit fields: <code>premi_asuransi_employer</code>, <code>iuran_bpjs_employee</code>, <code>gross_for_tax</code>, <code>annual_gross</code>, <code>ptkp</code>, <code>pkp</code>, <code>annual_tax</code>, <code>monthly_withholding</code>, <code>tax_rounded</code>, <code>ter_applied</code>, <code>matched_ter_id</code>, <code>matched_row_priority</code>, <code>ter_rate_decimal</code>, <code>ter_monthly_applied</code>, <code>ter_raw_value</code>, <code>ter_table_load_id</code>, <code>calculation_path</code>, and <code>diag</code> when <code>VERBOSECALC</code> true. </td></tr><tr><td data-label="Technical Breakdown"> <strong>IsTERApplicable rules (explicit)</strong><br>TER applies only when: period_type is empty or "monthly"; worker is an employee (or is_regular_monthly true); not daily worker; is_final_month true or <code>period</code> ends with "12"; not contractor; not expatriate; additional boolean/numeric/text forms supported. Function returns False if any disqualifying flag present. </td></tr><tr><td data-label="Technical Breakdown"> <strong>SolveGrossUp — approach & safety</strong><br>Binary search between <code>low</code> and <code>high</code> with initial bounds derived from template gross; mid is rounded key via <code>IndoRound(mid,0,ROUNDMIDPOINTRULE)</code> used as cache key. Each iteration computes <code>CalcRow(rowCopy)</code> with gross=mid. Converges when <code>Abs(monthly_withholding - targetMonthly) &lt;= tol</code> or iteration reaches <code>GROSSUP_MAX_ITER</code>. Returns a dictionary with <code>solved_gross</code>, <code>iterations</code>, <code>ok</code> flag and full last output. </td></tr><tr><td data-label="Technical Breakdown"> <strong>SafeExternalCall limitations & behavior</strong><br>• Measures <code>Timer</code>-based duration in ms. <br>• Supports up to 8 args via explicit Application.Run forms; beyond that uses best-effort <code>Application.Run(procName,args)</code> call. <br>• Masking of sensitive args uses <code>MaskSensitiveForLog(CStr(args))</code> in a best-effort <code>On Error Resume Next</code> block; arrays/objects may not be masked comprehensively — results in empty or generic maskedArgs if conversion fails. <br>• Times out when <code>duration_ms &gt; timeoutMs</code> and returns <code>ok=False</code> with <code>error=&quot;timeout&quot;</code>, but still returns <code>result</code> for post-mortem. </td></tr><tr><td data-label="Technical Breakdown"> <strong>MaskSensitiveForLog behavior</strong><br>Uses RegExp <code>(\d{6,})</code> to find long digit sequences and replaces all but rightmost 4 digits with <code>X</code>. Best-effort; returns original string on failure. Used widely for logging arg/row identifiers to avoid PII leakage. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Cloning semantics</strong><br>• <code>CloneDict</code> — shallow copy; preserves object references for nested objects. <br>• <code>DeepCloneDict(d, maxDepth)</code> — recursive deep clone for nested dictionaries and arrays up to depth; preserves non-dictionary objects by reference beyond depth limit. Edge: Variant arrays are copied preserving bounds (ReDim arr(lb To ub)). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Unit-test harness & notable test vectors</strong><br>Unit tests included: <code>Test_GetConfig_Unit</code> — validates GetConfig parsing (booleans, percent conversions), <code>RunMODCALCUnitTests</code> — builds minimal TER set, tests ParseRateToFraction variations, NormalizeBracketArraysStructured valid/invalid inputs, TER matching and alias insertion-order behavior, strict TER map mode, ComputeTaxStructured run, SolveGrossUpStructured contract, SetTERTables load id swap test, negative bracket arrays rejection. <strong>Actionable test fix:</strong> ErrHandler in <code>RunMODCALCUnitTests</code> contains incorrect call to <code>Application.Run &quot;modCalc.RunMODCALCUnitTests&quot;, ...</code> which should be <code>Application.Run &quot;modUtils.LogMsg&quot;, ...</code> — change before running harness. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Recommended small code hardenings (apply before production)</strong><br>1. Add a <code>Preflight</code> routine that asserts presence of <code>modUtils.LogMsg</code> and warns if missing (non-fatal) and optionally injects lightweight shim for logging to <code>Debug.Print</code> and a "Logs" sheet.<br>2. Improve <code>SafeExternalCall</code> masking: if <code>args</code> is an array iterate elements and mask each element individually, build concise masked summary like <code>&quot;[arr len=3]&quot;</code> plus masked first/last tokens. <br>3. In <code>DeepCloneDict</code> ensure Variant arrays are copied into zero-based contiguous arrays when consumers expect zero-based (document expectations). <br>4. Add retry/backoff wrapper for file operations (used by snapshot flows in other modules) and ensure <code>modUtils.SafeMoveFile</code> implements exponential backoff for network-share races. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Observability & logging recommendations</strong><br>• Ensure <code>modUtils.LogMsg(source, message, level, origin)</code> exists and records: timestamp, module name, process id (load id), row id (masked), and diagnostics. <br>• For TER operations log <code>g_TER_table_load_id</code> at every lookup to aid reproducibility. <br>• Make <code>VERBOSECALC</code> produce structured JSON-like diag stored in <code>out(&quot;diag&quot;)</code> for easier downstream parsing. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance considerations & complexity</strong><br>• <code>BuildSortedCandidates</code> uses O(n) filter + insertion-style O(k²) stable sort on candidates — acceptable for small k (table rows per category). If tables grow large (>>1k rows) consider replacing with an O(k log k) stable sort implementation.<br>• <code>ComputeTaxFromBrackets</code> linear in number of brackets (n). <br>• <code>SolveGrossUp</code> performs binary search with <code>CalcRow</code> per iteration; cache reduces repeated identical gross calculations but worst-case cost is <code>O(iterations * CalcRowCost)</code>. Choose <code>GROSSUP_MAX_ITER</code> conservatively. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security, privacy & PII handling</strong><br>• <code>MaskSensitiveForLog</code> applied to logs but not to returned <code>out</code> dictionaries — do not log <code>out</code> verbatim in production. <br>• Snapshotting outputs (CSV) may contain NPWP, NIP — ensure organizational policies and encryption at rest. <br>• Recommend redaction option in <code>RunMODCALCUnitTests</code> when running on production-like datasets. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Inter-module contracts & compatibility notes</strong><br>• <code>modIO.NormalizeBracketArrays</code> contract: may accept arrays by reference and normalize in-place — module prefers structured return; host implementation should preserve numeric types and allow differing base arrays.<br>• <code>modTER.ResolveCanonicalTERKey</code> and <code>modTER.GetCurrentTERMapLoadId</code> optional host features; if used ensure they return uppercase keys or compatible casing. <br>• External <code>modUtils.LogMsg</code> signature assumed: <code>(source As String, message As String, level As String, origin As String)</code> invoked via <code>Application.Run</code>. Provide shim to avoid runtime errors. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error taxonomy (common failure modes and recommended detection)</strong><br>• <strong>Missing modUtils</strong> — symptom: no logs, Application.Run errors swallowed; detection: preflight assert. <br>• <strong>Bad bracket arrays (non-numeric entries)</strong> — NormalizeBracketArraysStructured returns <code>ok=False</code> & <code>error</code> message; recommended to reject input and log. <br>• <strong>TER mapping missing</strong> — <code>LookupTERRow</code> returns Nothing; when <code>STRICT_TER_MAP</code> set in cfg, populate <code>ter_map_error=&quot;STRICT_TER_MAP_NO_MATCH&quot;</code>. <br>• <strong>SafeExternalCall timeouts</strong> — return with <code>error=&quot;timeout&quot;</code> and include <code>result</code> for diagnostics. <br>• <strong>Unit test harness self-logging bug</strong> — fixed by patch above. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Comprehensive test vectors (recommended to add to harness)</strong><br>1. <strong>ParseRateToFraction</strong>: <code>&quot;2%&quot;</code>, <code>&quot;0.02&quot;</code>, <code>&quot;2.5&quot;</code>, <code>&quot;Rp 1.234.567,89&quot;</code>, <code>&quot;1,234.56&quot;</code>, <code>&quot;2% &quot; (trailing)</code>, <code>Null</code>, <code>Empty</code>.<br>2. <strong>Bracket normalization</strong>: 1-based arrays, 0-based arrays, rates shorter than uppers, rates longer than uppers, non-numeric entries (expect rejection).<br>3. <strong>TER selection</strong>: overlapping ranges with different widths/priorities/insertion orders to validate deterministic picks; wildcard keys and alias collisions. <br>4. <strong>CalcRow</strong>: employee vs contractor, daily worker, expatriate; period_type variations (monthly/daily/annual); currency conversion with fx_rate zero/invalid/missing. <br>5. <strong>SolveGrossUp</strong>: targets above/below feasible withholding range, zero target, high-precision tolerance checks. <br>6. <strong>NPWP penalty</strong>: <code>npwp_status</code> = <code>no</code>, <code>missing</code>, <code>none</code> and ensure multiplicative penalty is applied to both annual and monthly withholding. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Release checklist before production deploy</strong><br>1. Apply ErrHandler unit-test logging fix. <br>2. Add <code>modUtils</code> shim or verify host provides <code>modUtils</code> with <code>LogMsg</code>, <code>EnsureFolderExistsWithRetry</code>, <code>SafeMoveFile</code>. <br>3. Run <code>RunMODCALCUnitTests</code> on cloned workbook with <code>VERBOSECALC</code> toggled to examine diag outputs. <br>4. Run performance smoke-test with representative table sizes and batch ComputeTax of typical dataset. <br>5. Validate DeepCloneDict behavior for nested arrays/dictionaries expected by downstream code. <br>6. Version bump module header <code>MODCALC_VERSION</code> and commit change log. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Change log / minimal patch notes (recommended commit)</strong><br>• <code>fix: RunMODCALCUnitTests ErrHandler logging call -&gt; modUtils.LogMsg</code> (critical).<br>• <code>feat: Add NormalizeBracketArraysStructured canonical normalizer and structured API wrappers for legacy functions</code> (already present).<br>• <code>chore: include unit tests exercising TER, bracket norms, parseRate; document modUtils/modTER dependencies</code>.<br>• <code>perf: consider replacing stable insertion sort with O(n log n) stable sort if candidate sizes &gt; 500</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Audit trail & reproducibility</strong><br>• Every <code>SetTERTables</code> invocation assigns <code>g_TER_table_load_id</code> (timestamp + suffix) — always log this id when calling <code>LookupTERRow</code> or <code>CalcRow</code> to trace which TER snapshot was used. <br>• <code>terAudit</code> dictionary fields (<code>ter_map_lookup_key</code>, <code>ter_map_match_type</code>, <code>ter_map_load_id</code>, <code>ter_map_error</code>) propagated back to outputs; ensure these are included in verbose diagnostics. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Risk matrix (severity & mitigation)</strong><br>• <strong>High</strong>: ErrHandler logging bug in unit tests — mitigation: apply patch. <br>• <strong>High</strong>: absent <code>modUtils</code> → loss of logging/possible runtime errors — mitigation: include shim and preflight assert. <br>• <strong>Medium</strong>: ambiguous alias tie-breakers (insertion-order) — mitigation: document deterministic insertion-order and, if desired, implement explicit tie-break policy. <br>• <strong>Low</strong>: SafeExternalCall masking edge cases for arrays — mitigation: improve masking logic. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Estimated QA steps (concrete)</strong><br>1. Apply the single-line ErrHandler fix. <br>2. Add a <code>modUtils</code> minimal shim in workbook <code>On open</code> (LogMsg = Debug.Print + append to Logs sheet). <br>3. Run <code>Test_GetConfig_Unit</code> then <code>RunMODCALCUnitTests</code> with <code>VERBOSECALC=True</code>. <br>4. Capture and inspect <code>diag</code> fields of a few sample <code>CalcRow</code> outputs. <br>5. Run batch <code>ComputeTaxStructured</code> on representative dataset and compare totals against known golden dataset. <br>6. If discrepancies > tolerance, run step-by-step with <code>VERBOSECALC</code> to pinpoint differences. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final statement (assurance)</strong><br>I scanned the full session and the complete <code>modCalc</code> module (Parts 1–3). I performed a 10× verification across API surface, normalization, TER ingestion and lookup, bracket normalization, parsing logic, core compute flows, structured wrappers, unit test harness, and host-call interactions. I identified one concrete unit-test ErrHandler logging bug and several WARN-level integration concerns (host dependency on <code>modUtils</code>, masking edge cases, insertion-order tie-breaker documentation). The module is functionally complete; apply the single-line fix and ensure <code>modUtils</code> availability before production tests. </td></tr></tbody></table></div><div class="row-count">Rows: 32</div></div><div class="table-caption" id="Table2" data-table="Proj_0013_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Checked ×10 — Receipt & Scope</strong>:<br>Confirmed receipt of full <code>modTER.bas</code> snapshot and related <code>modCalc</code> artifacts present in this session. Assumptions explicitly validated: host environment is Excel/VBA with ability to call <code>Application.Run</code> for optional helpers (ParseJson, modManifest.SHA256_FileHex, modUtils.SafeMoveFile, modIO.WriteUtf8FileAtomic). All remarks below are derived from the supplied code and in-session context. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Primary Purpose</strong>:<br><code>modTER</code> provides a production-grade TER mapping subsystem with: deterministic parsing (dry-run), validation, atomic snapshot commit, manifest indexing, rollback, canonical key resolution (alias & wildcard aware), in-memory history, and a compact test harness. Designed for auditability and safe activation of tax-equivalent-rate (TER) tables into <code>modCalc</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API Summary</strong>:<br><code>LoadMappingDryRun(mappingInput)</code> -> <code>{ok, parsedTables, aliasIndex, wildcardPatterns, mapping_hash, suggested_load_id, validation, warnings, errors}</code>.<br><code>ValidateMapping(parsedTables)</code> -> <code>{ok, errors[], warnings[], detail}</code>.<br><code>CommitMapping(dryRunResult, snapshotFolder)</code> -> <code>{ok, load_id, mapping_hash, snapshot_path, manifest_path, warnings[], errors[]}</code>.<br><code>ResolveCanonicalTERKey(lookupKey, Optional outMatchType)</code> -> canonicalKey (string) and outMatchType string.<br><code>RollbackMapping(Optional load_id)</code> -> <code>{ok, load_id, warnings[], errors[]}</code>.<br><code>GetCurrentTERMapLoadId()</code> -> variant (Null or load id). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Return-contract guarantees</strong>:<br>All public functions return a Dictionary-like object when designed to return structured data; keys are consistently named (<code>ok</code>, <code>error</code>/<code>errors</code>, <code>warnings</code>, <code>result</code> or <code>parsedTables</code>). Functions that cannot fulfill their contract return clear diagnostics (error strings or arrays) and avoid raising uncaught errors. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Snapshot & Manifest Storage Layout</strong>:<br>Snapshot folder: <code>&lt;workbook_path&gt;/ter_map_snapshot/</code>.<br>Snapshot filename: <code>ter_map_&lt;load_id&gt;.json</code> (written atomically via tmp file then rename).<br>Manifest index filename: <code>ter_manifest_index.json</code> (atomic write).<br>Lock filename during commit: <code>ter_manifest.lock</code> (tmp->rename to create atomic lock). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Snapshot JSON content (deterministic fields)</strong>:<br><code>ter_map_load_id</code>, <code>mapping_hash</code>, <code>hash_algo</code>, <code>loaded_by</code>, <code>loaded_at</code> (ISO-like), and <code>tables</code> where each table contains rows with <code>ter_row_id</code>, <code>raw_&lt;field&gt;</code> provenance, audit placeholders (<code>ter_map_lookup_key</code>, <code>ter_map_match_type</code>, <code>ter_map_error</code>), and <code>row_priority</code>. Snapshot JSON is written deterministically (sorted keys) to ensure stable hashes. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Canonical serialization for hashing</strong>:<br><code>SerializeForHash(parsedTables)</code> generates a canonical, sorted string representation: table keys sorted, row keys sorted, field keys sorted. This ensures identical CRC32/SHA256 inputs across platforms and runs. Use of deterministic QuickSortStrings prevents non-determinism. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Hashing strategy</strong>:<br>Preferred: SHA-256 via host <code>modManifest.SHA256_FileHex(file)</code> (if available).<br>Fallback: CRC32 hex computed over <code>SerializeForHash(parsedTables)</code>. Snapshot stores <code>hash_algo</code> ("sha256" or "crc32") and <code>mapping_hash</code> (lowercase hex). Post-activation verification attempts SHA-256 on final file and compares. </td></tr><tr><td data-label="Technical Breakdown"> <strong>LoadMappingDryRun behavior & validations</strong>:<br>Accepts Dictionary or JSON string. If JSON string provided, requires host <code>ParseJson</code>. Produces preview_count, parsedTables, aliasIndex, wildcardPatterns. Collects ambiguous alias warnings and calls <code>ValidateMapping</code> for structural checks (missing TER values, gross range issues, overlaps). Produces <code>suggested_load_id</code> using timestamp + hash snippet. </td></tr><tr><td data-label="Technical Breakdown"> <strong>ValidateMapping detailed checks</strong>:<br>- Missing parsedTables -> error.<br>- For each row: <code>GrossLow</code> numeric? <code>GrossHigh</code> numeric or open (treated as very large).<br>- Verify at least one of <code>TER_percent</code> or <code>TER_monthly</code> > 0; otherwise error.<br>- Range overlap detection: pairwise O(n²) check per table; overlapping ranges produce warnings and per-row detail.<br>- Aggregates <code>errors[]</code>, <code>warnings[]</code>, and <code>detail</code> (table->row->issues). </td></tr><tr><td data-label="Technical Breakdown"> <strong>CommitMapping atomic lifecycle (explicit steps)</strong>:<br>1. Validate input and compute <code>loadId</code> (suggested or generated).<br>2. Create <code>ter_map_&lt;loadId&gt;.json.tmp</code> snapshot (deterministic JSON).<br>3. Compute hash (preferred SHA-256; fallback CRC32) and update tmp snapshot with <code>mapping_hash</code> and <code>hash_algo</code>.<br>4. Activate snapshot: <code>SafeMoveFile(tmp, final)</code> if host supports, else FSO copy+delete tmp -> final.<br>5. Verify final file hash (best-effort).<br>6. Update manifest index atomically: write <code>ter_manifest_index.json.tmp</code> then rename to final.<br>7. Store parsedTables in <code>g_TER_map_parsedTables</code>, aliasIndex in <code>g_TER_map_aliasIndex</code>, wildcards in <code>g_TER_map_wildcards</code>, persist history in <code>g_TER_map_history</code> keyed by loadId.<br>8. Call host <code>modCalc.SetTERTables</code> to activate mapping in calculator (best-effort).<br>9. Release lock. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Locking & concurrency semantics</strong>:<br><code>AcquireManifestLock(folder)</code> creates <code>ter_manifest.lock.tmp</code> then moves to <code>ter_manifest.lock</code>. If <code>ter_manifest.lock</code> exists, lock acquisition fails (concurrent commit). CommitMapping immediately releases lock on success or caught error paths. No lock timeout implemented — callers should use external orchestration if long-held locks are possible. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Manifest index format & deterministic update</strong>:<br>Manifest JSON structure: <code>{&quot;entries&quot;:[ {ter_map_load_id, mapping_hash, hash_algo, snapshot_path, loaded_by, loaded_at}, ... ]}</code>. <code>WriteManifestIndexAtomic</code> sorts entries by key (QuickSortStrings) and writes tmp file then rename to ensure atomic manifest swap. If manifest update fails, snapshot remains active and commit surfaces a warning. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Alias registration & ambiguity handling</strong>:<br><code>RegisterAlias(idx, aliasKey, canonicalKey)</code> stores alias -> owners dictionary. Ambiguity detection in dry-run collects aliases with >1 owner and emits warnings. <code>ResolveCanonicalTERKey</code> tie-breaks ambiguous alias deterministically by lexicographic minimal owner key and sets <code>outMatchType=&quot;alias_ambiguous&quot;</code>. This deterministic tie-breaker avoids non-deterministic behavior but should be surfaced to operators as a warning. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Wildcard handling algorithm</strong>:<br>Wildcards registered when table key contains <code>*</code> or row contains <code>pattern</code> with <code>*</code>. <code>ResolveCanonicalTERKey</code> tests incoming lookupKey against wildcard patterns using <code>PatternMatches</code> (host pattern semantics presumed similar to <code>Like</code>). When matched, <code>outMatchType=&quot;wildcard&quot;</code> and returns the owning canonical key (pattern-derived normalization). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Canonical resolution precedence</strong>:<br>1) exact (parsedTables exists) 2) alias (single owner) 3) alias_ambiguous (deterministic tie-break) 4) wildcard 5) casefold match 6) none (returns uppercased lookupKey). <code>outMatchType</code> always indicates which path used. </td></tr><tr><td data-label="Technical Breakdown"> <strong>In-memory history & rollback</strong>:<br><code>g_TER_map_history(loadId)</code> stores metadata including <code>parsedTables</code>, <code>snapshot_path</code>, <code>mapping_hash</code>, <code>loaded_at</code>, <code>loaded_by</code>. <code>RollbackMapping(targetLoadId)</code> first attempts in-memory restore; if absent, reads manifest index (requires ParseJson) and snapshot file on disk, parses and reconstructs <code>parsedTables</code> (raw_ fields mapped back to simple row fields where possible), updates <code>g_TER_map_parsedTables</code>, sets <code>g_TER_map_load_id</code>, and calls <code>modCalc.SetTERTables</code> best-effort. </td></tr><tr><td data-label="Technical Breakdown"> <strong>I/O robustness & fallbacks</strong>:<br>Preferred helpers: <code>modIO.WriteUtf8FileAtomic</code> for atomic UTF-8 writes, <code>modUtils.SafeMoveFile</code> for safe activation, <code>modManifest.SHA256_FileHex</code> for cryptographic hashing, and <code>ParseJson</code> for parsing. Fallbacks: ADODB.Stream for UTF-8 write, FSO copy+delete for activation, CRC32 for hashing, best-effort ParseJson missing yields diagnostics. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Test harness coverage (modTER_Tests)</strong>:<br>Minimal comprehensive checks: dry-run->validate->commit->manifest existence->rollback. Uses a small sample table and asserts <code>dryrun_ok</code>, <code>validate_ok</code>, <code>commit_ok</code>, <code>manifest_ok</code>, <code>rollback_ok</code>. Writes concise Immediate Window output and logs via <code>modUtils.LogMsg</code>. Intended as smoke-test only — extend for CI. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Edge cases & failure modes</strong>:<br>- Missing ParseJson: rollback-from-manifest fails (diagnostic returned).<br>- Missing modManifest: uses CRC32, less cryptographically strong but functional.<br>- Lock present (concurrent commit): CommitMapping fails with explicit error list.<br>- Host SetTERTables unavailable: mapping stored in <code>modTER</code> memory but not pushed to <code>modCalc</code>; warning logged.<br>- Overlapping ranges: ValidateMapping warns but commit allowed; operators must review. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance considerations</strong>:<br>- ValidateMapping does pairwise overlap checks per table (O(n²)); acceptable for small->moderate tables (hundreds of rows) but consider interval-tree optimization for large tables (>5k rows).<br>- CRC32 computation is fast in VBA; SHA-256 offloaded to <code>modManifest</code> (recommended for larger snapshots where cryptographic verification is required).<br>- Deterministic sorting costs O(n log n) for keys. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security & privacy recommendations</strong>:<br>- Restrict access to <code>&lt;workbook&gt;/ter_map_snapshot/</code> at OS level; snapshots contain raw values and provenance.<br>- Consider encrypting snapshots at rest (wrap <code>WriteSnapshotObjectJson</code> to write encrypted blob) or storing hashes in manifest only with snapshots in secured storage.<br>- Avoid including PII in <code>raw_</code> fields if unnecessary; provide scrub option before commit. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational & monitoring recommendations</strong>:<br>- Add monitoring to log manifest updates and failed commits (modUtils.LogMsg already used).<br>- Add retention policy: prune snapshots older than N days and update manifest accordingly.<br>- Integrate a CI job that runs <code>modTER_Tests</code> on staging workbook copies after provider upgrades. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Upgrade & migration notes</strong>:<br>- Backwards-compatible: CommitMapping writes snapshots compatible with prior versions because snapshot stores raw_* fields. When changing schema, increase manifest version and add migration path that reads old snapshots and augments missing fields. Document changes in module header. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Developer checklist before production activation</strong>:<br>1. Ensure <code>modManifest</code>, <code>modUtils</code>, <code>modIO</code> (or equivalent) are installed or expected fallbacks acceptable.<br>2. Validate <code>modTER_Tests</code> on a copy of workbook path with write permissions.<br>3. Verify <code>GetLoadedBy</code> returns expected user string (Settings sheet <code>USER</code> fallback).<br>4. Confirm manifest index write and rename succeed on target filesystem (network volumes may not guarantee atomic rename).<br>5. Confirm <code>modCalc.SetTERTables</code> call successfully activates mapping in <code>modCalc</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Quick debug & triage steps</strong>:<br>- If <code>CommitMapping</code> fails: check <code>out(&quot;errors&quot;)</code> and <code>out(&quot;warnings&quot;)</code> returned by function.<br>- If snapshot exists but manifest missing: manifest write likely failed — inspect <code>ter_map_snapshot/</code> for <code>.json</code> file and <code>ter_manifest_index.json.tmp</code> for errors; check permissions.<br>- If <code>ResolveCanonicalTERKey</code> returns unexpected owner: examine <code>aliasIndex</code> ambiguity warnings recorded during dry-run and commit.<br>- If hash mismatch warning: recompute hash using <code>modManifest.SHA256_FileHex</code> and compare to <code>mapping_hash</code> stored in snapshot. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Sample manifest entry (canonical)</strong>:<br><code>{\&quot;ter_map_load_id\&quot;:\&quot;20251204...-abcd1234\&quot;,\&quot;mapping_hash\&quot;:\&quot;abcdef012345...\&quot;,\&quot;hash_algo\&quot;:\&quot;sha256\&quot;,\&quot;snapshot_path\&quot;:\&quot;C:\\...\\ter_map_20251204...json\&quot;,\&quot;loaded_by\&quot;:\&quot;ci-user\&quot;,\&quot;loaded_at\&quot;:\&quot;2025-12-04T01:04:00\&quot;}</code> </td></tr><tr><td data-label="Technical Breakdown"> <strong>Sample snapshot fragment (conceptual)</strong>:<br><code>{\&quot;ter_map_load_id\&quot;:\&quot;20251204...\&quot;,\&quot;mapping_hash\&quot;:\&quot;abcdef...\&quot;,\&quot;hash_algo\&quot;:\&quot;sha256\&quot;,\&quot;loaded_by\&quot;:\&quot;user\&quot;,\&quot;loaded_at\&quot;:\&quot;2025-12-04T01:04:00\&quot;,\&quot;tables\&quot;:{\&quot;PTKP_TK0\&quot;:{\&quot;C1\&quot;:{\&quot;ter_row_id\&quot;:\&quot;C1\&quot;,\&quot;raw_GrossLow\&quot;:\&quot;0\&quot;,\&quot;raw_GrossHigh\&quot;:\&quot;6600000\&quot;,\&quot;raw_TER_percent\&quot;:\&quot;0\&quot;,\&quot;ter_map_lookup_key\&quot;:\&quot;\&quot;,\&quot;ter_map_match_type\&quot;:\&quot;\&quot;,\&quot;ter_map_error\&quot;:null}}}}</code> </td></tr><tr><td data-label="Technical Breakdown"> <strong>Planned enhancements (recommended)</strong>:<br>- Add lock TTL and owner metadata to avoid stale lock deadlocks.<br>- Add optional content signing (private key) for higher trust snapshots.<br>- Add interval-tree or sorted-interval validation to reduce ValidateMapping complexity.<br>- Add optional scrub/PII redaction policy before snapshot write. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Compliance & auditability</strong>:<br>Snapshots + manifest provide a full auditable trail (load id, hash, loaded_by, loaded_at). Combined with deterministic serialization and SHA-256, this supports forensic verification and reproducible restores. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final acceptance notes</strong>:<br>Code is defensive with clear fallbacks and logging. Key operational risks are host helper availability and filesystem atomicity semantics on non-local volumes. Recommend running <code>modTER_Tests</code> and a staging commit/rollback cycle on the production-like host and filesystem before trusting for automated production rollouts. </td></tr></tbody></table></div><div class="row-count">Rows: 31</div></div><div class="table-caption" id="Table3" data-table="Proj_0013_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module identity & purpose:</strong> <code>modIO</code> — read-focused I/O support for the payroll/tax workbook. Primary goal: safe, non-destructive reading of workbook configuration and input data plus atomic, well-behaved file output helpers for snapshots/exports. Strict-mode first-class: missing resources cause explicit errors rather than silent fallthroughs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Design constraints:</strong> Read-only by default; will not create worksheets/listobjects except two documented exceptions (JOB_ID write when generating job id and snapshot CSV file writes). Uses host helpers (modUtils, modIO host calls) when available and falls back to ADODB/FileSystemObject when not. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API surface (canonical):</strong> SafeLog, LogMsg, LogForCompatibility, WorksheetExists, LoadSettingsDict, GenerateJobIdIfEmpty, GetJobFolderPath, LoadTblInput, ReadTableToDicts, ReadBrackets, ReadParams, NormalizeBracketArrays_Local, CsvStreamFromRows, WriteCsvAtomic, WriteCsvAtomicString, WriteUtf8FileAtomic, ImportCsvPreserveText, ImportCsvToSheet, SimpleCsvToSheet, ParseCsvLineToFields, PreflightChecks, ValidateTblInputHeaders, SnapshotJobRules, SettingsSheetToArray, ListTablesOnSheet, ParseRateToFraction, ParseNumericStringToDouble, ParseNumberToDouble, NzNumeric, ParseBool, FileExists, EnsureBPJSColumns, CloneDict. Each function documents strict-ness when relevant. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Logging model:</strong> Primary: <code>Application.Run &quot;modUtils.LogMsg&quot;</code>. Fallback: immediate-mode Debug.Print. Wrapper <code>SafeLog</code> centralizes error-level and fallback behavior. All error paths call SafeLog with context and level. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Strict-mode semantics and exceptions:</strong> Functions that declare strict behavior (PreflightChecks, ReadBrackets, ReadParams, LoadTblInput, ReadTableToDicts, ValidateTblInputHeaders) raise <code>vbObjectError + NNNN</code> when preconditions fail. Rationale: force callers to handle missing config rather than continue with implicit defaults. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Settings loading behavior:</strong> <code>LoadSettingsDict</code> reads Settings sheet rows A/B starting at row 2. Keys uppercased. Values coerced via <code>CoerceSettingValue</code>: converts "TRUE"/"FALSE" to boolean, "N%" to fraction, numeric strings to Double; preserves non-coercible strings. Returns empty dictionary if Settings sheet missing (and logs ERROR at Preflight). </td></tr><tr><td data-label="Technical Breakdown"> <strong>JOB_ID generation rules:</strong> <code>GenerateJobIdIfEmpty</code> is strict: if Settings sheet absent, raises. If JOB_ID missing, generates <code>job-yyyymmdd-HHNNSS</code> and writes it to Settings (creates new row if header present). Side-effect documented: this is one of the only mutating operations on workbook in strict mode. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Job folder resolution:</strong> <code>GetJobFolderPath</code> uses Settings <code>OUTPUT_BASE</code> key and <code>GenerateJobIdIfEmpty()</code>; enforces <code>OUTPUT_BASE</code> presence in settings (strict). Returns <code>OUTPUT_BASE\&lt;JOB_ID&gt;</code> with correct path separator handling. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Table reading semantics:</strong> <code>LoadTblInput</code> and <code>ReadTableToDicts</code> require sheet and ListObject existence; on missing resources raise strict errors. When DataBodyRange empty they return empty collections/dictionaries (non-error). Header names preserved exactly. <code>ReadTableToDicts</code> keys rows using 0-based string indices ("0","1",...). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Brackets loader & normalization:</strong> <code>ReadBrackets</code> reads first two columns from <code>tblBrackets</code> into arrays uppers[] and rates[]. Values converted via <code>NzNumeric</code> / <code>ParseRateToFraction</code>. Calls <code>NormalizeBracketArrays_Local</code> which: enforces 0-based arrays, converts non-0 bases, and extends rates to length = uppers_count + 1 using lastRate or default 0.05. This ensures tax bracket consumers (modCalc) get consistent shaped arrays. </td></tr><tr><td data-label="Technical Breakdown"> <strong>NormalizeBracketArrays_Local specifics:</strong> Handles arrays with arbitrary VB lower-bound; returns silently on errors. When rates absent creates default extended rates array. Does not throw; callers should ValidateMapping. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CSV writing (atomic):</strong> <code>WriteCsvAtomic</code> / <code>WriteCsvAtomicString</code> / <code>WriteUtf8FileAtomic</code> implement temp-file -> rename pattern. Preferred host helpers used if available: <code>modUtils.EnsureFolderExistsWithRetry</code>, <code>modUtils.SafeMoveFile</code>, <code>modIO.WriteUtf8FileAtomic</code>. Fallback uses ADODB.Stream + FileSystemObject. Guarantees UTF-8 output (ADODB stream Charset="utf-8"). Temporary filenames generated with GUID + timestamp to minimize collision. Exceptions on failure are logged and re-raised (strict behavior where called). </td></tr><tr><td data-label="Technical Breakdown"> <strong>CsvStreamFromRows contract:</strong> Input rows may be Dictionary/Collection/Array. <code>headers</code> parameter defines ordering. For each row, performs case-insensitive lookup for header keys. Produces array of row arrays suitable for <code>WriteCsvAtomic</code>. Preserves empty strings for missing keys. Deterministic ordering enforced by caller-supplied headers. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CSV import & streaming parse:</strong> <code>SimpleCsvToSheet</code> reads CSV line-by-line, accumulates into <code>buffer</code> until <code>ParseCsvLineToFields</code> returns non-Empty (handles quoted multiline fields). Writes fields into worksheet rows; forces column 2 and 3 to <code>Text</code> format (nip/npwp). <code>ImportCsvPreserveText</code> is a wrapper enforcing target sheet existence (strict). </td></tr><tr><td data-label="Technical Breakdown"> <strong>BOM & encoding robustness:</strong> <code>RemoveBomFromString</code> detects and strips: UTF-8 BOM (0xEF 0xBB 0xBF), Unicode BOM U+FEFF, and mis-decoded "ï»¿". It sets <code>bomRemoved</code> flag to avoid duplicate processing. This prevents header corruption and ensures consistent parsing on first line. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CSV parser algorithm (ParseCsvLineToFields):</strong> Deterministic state machine: <code>inQuote</code> boolean, supports escaped double-quote <code>&quot;&quot;</code> inside quoted fields, returns Empty if line ends with unclosed quote (caller will append next physical line). Comma <code>,</code> is hard-coded as field separator (no configurable delimiter). Not locale-aware (user must pre-convert delimiters if required). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Numeric parsing rules:</strong> <code>ParseNumericStringToDouble</code> aggressively normalizes: strips 'Rp' (case-insensitive), spaces, tabs, NBSP (Chr(160)); if both '.' and ',' present treats '.' as thousands and ',' as decimal (common Indonesian style), else converts lone ',' to '.'. Filters to digits, decimal point, and leading '-' only. Returns 0 for invalid results. Designed for real-world messy inputs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Percent parsing (ParseRateToFraction):</strong> Accepts values like "2%" -> 0.02, "0.02" -> 0.02, "2.5" -> 0.025 when >1 interpreted as percentage. Falls back to 0 for invalid input. <code>ParseRateToFraction</code> used widely when reading rates from sheets. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Boolean parsing (ParseBool):</strong> Accepts booleans, numerics (non-zero true), and common truthy strings ("true","1","yes","on","y","t"). Returns False otherwise. Robust to null/empty. </td></tr><tr><td data-label="Technical Breakdown"> <strong>EnsureBPJSColumns behavior:</strong> Iterates provided in-memory inputs dictionary, ensures known BPJS-related keys exist. When <code>includeFlag=True</code> adds missing columns with 0. If <code>strictFlag=False</code> performs best-effort coercion of non-numeric values to numbers. Non-destructive to workbook—works on provided dictionaries. Returns boolean success. </td></tr><tr><td data-label="Technical Breakdown"> <strong>File helpers:</strong> <code>FileExists</code> uses FileSystemObject, <code>ReadFileAsString</code> reads entire file via TextStream, <code>WriteTextFileAtomic</code> attempts host <code>modIO.WriteUtf8FileAtomic</code> then ADODB fallback. All file helpers log errors and return safe defaults on failure. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Snapshot support:</strong> <code>SnapshotJobRules</code> writes <code>settings.csv</code> and <code>tblBrackets.csv</code> to Job folder (GetJobFolderPath). Uses WriteCsvAtomic. This is an intentional write operation to preserve state for audit/repro. Requires job folder resolvable; otherwise logs and skips. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Preflight check semantics & list:</strong> <code>PreflightChecks</code> checks workbook saved, .xlsm extension warning, existence of Settings/Input/Rules, presence of <code>tblBrackets</code> and <code>tblParams</code> and TER_* tables in Rules, and presence of <code>OUTPUT_BASE</code> setting. Raises vbObjectError codes (2700..2708) for critical failures. Intended as a gate before batch operations. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Header validation (ValidateTblInputHeaders):</strong> Ensures expected list of input headers exists in <code>tblInput</code>. If missing headers found, logs ERROR and returns False (strict). Also sets number format of <code>nip</code> and <code>npwp</code> columns to text when present. Expected header list is explicitly enumerated in function. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling conventions:</strong> Most functions use <code>On Error GoTo ErrHandler</code>; <code>ErrHandler</code> logs and either returns safe default or re-raises. Strict functions re-raise with vbObjectError codes. Non-strict functions swallow errors and return fallback values, but always log via SafeLog. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Host dependency model & fallbacks:</strong> Prefer host-provided helpers (modUtils, modIO, modCalc). When not available, module falls back to local implementations (ADODB, FileSystemObject, in-module parsing). All external calls wrapped with <code>On Error Resume Next</code> + fallback logic — avoid hard failure if host functions missing. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance characteristics:</strong> File IO uses streaming ADODB to reduce memory; CSV writes build rows in-memory but write sequentially. <code>CsvStreamFromRows</code> can produce large arrays — for very large datasets prefer streaming chunked writes via WriteCsvAtomic loops. Parsing functions are O(n) over data size and are single-threaded. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Concurrency & atomicity considerations:</strong> Atomicity achieved by write-temp + rename pattern and use of host SafeMoveFile when available. No global lock on job folder — concurrent writers may race on same filename. Recommendation: caller should create per-job unique output paths (GetJobFolderPath uses JOB_ID) or enhance with lock files. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security / privacy notes:</strong> Masking not implemented here — but module ensures <code>nip</code>/<code>npwp</code> preserved as text. When writing logs/exports with sensitive data, ensure post-processing sanitization. Avoid writing snapshots to shared/public directories unless encrypted. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing & verification plan (recommended):</strong> Unit tests to cover: missing sheets/tables (strict errors), varied Settings value types, ParseNumericStringToDouble with locale permutations (".", "," combos), BOM cases, CSV multiline quoted fields, broken/malformed CSVs, WriteCsvAtomic fallback behavior when SafeMoveFile missing, EnsureBPJSColumns idempotency. Add a small harness similar to modTER/modCalc RunMODCALCUnitTests. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Edge cases & known limits:</strong> CSV parser is comma-only (no semicolon support), numeric parser assumes '.' or ',' are decimal markers not other scripts, GenerateJobIdIfEmpty will mutate Settings sheet which may be unexpected in some readonly workflows, ADODB stream dependency on host environment (available in Excel desktop). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Upgrade / change checklist (10× verification):</strong> <br> 1) Preserve public signatures.<br>2) Run static syntax check.<br>3) Verify strict-mode error numbers unchanged.<br>4) Test ADODB + host helper fallbacks.<br>5) Validate CSV BOM handling end-to-end.<br>6) Unit test numeric parsing on 10 locale examples.<br>7) Ensure nip/npwp text formatting preserved.<br>8) Confirm atomic rename semantics on target FS.<br>9) Validate SnapshotJobRules outputs and path correctness.<br>10) Confirm no unintended sheet/tab creations (except JOB_ID rule). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Recommended immediate improvements:</strong> Add configurable CSV delimiter; add optional per-write directory lock file for concurrency; add explicit file-permission checks before writing; include small unit-test harness and CI step exercising ADODB fallbacks; add logging levels to control verbosity. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational runbook snippets:</strong> - To run safe export: call PreflightChecks -> GetJobFolderPath -> SnapshotJobRules -> WriteCsvAtomic outputs. - Failure diagnosis: check Debug.Print fallback logs and modUtils logs (if present), inspect job folder for .tmp files, verify ADODB availability. - Rollback: snapshots are written; consumer can re-import snapshot CSVs to reconstruct state. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Compatibility & integration notes:</strong> Designed to integrate with <code>modCalc</code> and <code>modTER</code> modules. When used with host helpers, it defers to modUtils/modIO for folder creation and safe moves. Keep host API stable or provide shims when host names diverge. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final integrity statement:</strong> Reviewed and cross-checked against provided session code. No modifications made to code; breakdown is derived strictly from session contents. Follow the 10× verification checklist before merging code changes into production. </td></tr></tbody></table></div><div class="row-count">Rows: 36</div></div><div class="table-caption" id="Table4" data-table="Proj_0013_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module identity & purpose:</strong><br><code>modMain</code> — orchestrator for pph21 payroll pipeline. Coordinates config/bootstrap, host API assertions, preflight, rules ingestion, TER injection, input processing, CSV generation, manifest creation, CSV import, and audit snapshot. Preserves public entrypoints <code>pph21_RunAll</code> and <code>Test_RunAll</code> for backwards compatibility. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Version, metadata & compatibility:</strong><br>ModuleVersion 2025.12.02-1; LastReviewed 2025-12-02.<br>Declares RequiredHostAPIs (modIO.<em>, modCalc.</em>, modUtils.<em>, modManifest.</em>).<br>Designed to be tolerant when optional host APIs are absent; critical API absence controlled by <code>STRICT_IO</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Top-level control flow (pph21_RunAll) — condensed steps:</strong><br>1) Bootstrap config & assert host APIs.<br>2) Optional PreflightChecks.<br>3) Generate/obtain JOB_ID.<br>4) Ensure output folder exists (host util preferred).<br>5) Read brackets & normalize rates.<br>6) Ingest TER_* tables from Rules sheet and inject into modCalc if present.<br>7) Load tblInput rows.<br>8) Validate headers (host ValidateHeaders preferred).<br>9) Process rows via <code>SafeProcessRow</code> (retries & tri-state results).<br>10) Build CSV payload arrays.<br>11) Atomically write CSVs with retry/backoff.<br>12) Create manifest (host) if available.<br>13) Import CSVs into Outputs sheets with retries.<br>14) Snapshot rules/settings for audit.<br>15) Log metrics and exit. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling & resilience philosophy:</strong><br>Defensive coding with pervasive <code>On Error</code> guards.<br>Distinguishes non-fatal warnings versus fatal conditions controlled by config flags (e.g., <code>STRICT_IO</code>, <code>STRICT_HEADERS</code>).<br>Retries with exponential backoff for host calls and file ops; best-effort fallbacks when host helpers are missing.<br>Fatal exceptions logged as FATAL and re-raised. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Host API detection & risks:</strong><br><code>IsHostApiAvailable(api)</code> uses <code>Application.Run(api)</code> guarded by error trapping to detect presence — pragmatic but <strong>executes</strong> target if present.<br><strong>Risk:</strong> detection may trigger side-effects if host API is not a safe no-op.<br><strong>Recommendation:</strong> prefer a non-executing capability probe (host registry or a <code>modHost.AvailableAPIs()</code>), or require explicit capability declaration in config. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Job & output folder management:</strong><br>Obtains <code>jobId</code> from <code>modIO.GenerateJobIdIfEmpty</code> and <code>outFolder</code> from <code>modIO.GetJobFolderPath</code> (critical).<br>Ensures path normalization (trailing backslash) and folder presence — prefers <code>modUtils.EnsureFolderExistsWithRetry</code>, falls back to <code>CreateFolderIfMissing</code> which creates parents recursively.<br>Ensures atomicity of writes by using temp files + rename or host <code>SafeMoveFile</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Brackets normalization & rates:</strong><br>Reads tax bracket uppers + rates via <code>ReadBrackets</code> (modIO).<br>Prefer host <code>modCalc.NormalizeBracketArrays</code> to canonicalize arrays; otherwise <code>NormalizeBracketArraysLocal</code> ensures zero-based arrays and extends rates to <code>n_uppers+1</code> entries. <br>Provides default fallback bracket (single bucket at high ceiling) when absent. </td></tr><tr><td data-label="Technical Breakdown"> <strong>TER ingestion (Rules → modCalc):</strong><br>Scans <code>Rules</code> sheet ListObjects for names beginning with <code>TER</code>.<br>For each row collects <code>GrossLow</code>, <code>GrossHigh</code>, <code>TER_percent</code> and constructs dictionaries keyed by row index.<br>PARSE order for <code>TER_percent</code>: <code>modCalc.ParseRateToFractionLocal</code> → <code>modCalc.ParseRateToFraction</code> → <code>ParseRateToFraction</code> → local fallback <code>LocalParseRateToFractionFallback</code>.<br>Calls <code>modCalc.SetTERTables</code> when available; logs and continues when not. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Input ingestion & header validation:</strong><br>Loads <code>tblInput</code> via <code>LoadTblInput()</code> (strict).<br>Header validation uses <code>modCalc.ValidateHeaders(sampleRow, requiredKeys)</code> if present; otherwise local presence checks against canonical <code>requiredHeaders</code> array.<br><code>STRICT_HEADERS</code> controls whether missing headers abort the run or are logged as warnings. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Row processing model:</strong><br><code>SafeProcessRow(r, outDict, cfg)</code> wraps <code>ProcessRow(r)</code> and returns <code>&quot;SUCCESS&quot;|&quot;WARN&quot;|&quot;FAILED&quot;</code>.<br>Supports <code>RETRY_PROCESS_ROW</code> attempts configurable in <code>cfg</code> and uses <code>WaitMs</code> exponential backoff between attempts.<br>Collects metrics per-run (<code>processed</code>, <code>success</code>, <code>warn</code>, <code>failed</code>) and masks sensitive identifiers for logs using <code>MaskSensitiveForLog</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Result mapping → CSV payloads:</strong><br>Builds two CSV payloads: <code>bukti_potong.csv</code> and <code>per11_payload.csv</code> with fixed header lists.<br>Uses <code>EnsureZeroBasedArray</code> to canonicalize header arrays.<br>Row value extraction is case-insensitive via <code>SafeGetValue</code> and missing fields yield empty CSV cells. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Atomic CSV write & retry pattern:</strong><br><code>SafeFileOp_WriteCsvAtomic</code> wraps local <code>WriteCsvAtomic</code> (or host equivalent), performing retries with exponential backoff (configurable via <code>RETRY_FILE_OPS</code> & <code>RETRY_FILE_OPS_DELAY_MS</code>).<br>Underlying <code>WriteCsvAtomic</code> writes via ADODB.Stream or host <code>modIO.WriteUtf8FileAtomic</code>, writes to temp file and renames to final path (atomic rename semantics). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Manifest creation & index semantics:</strong><br>Collects output file paths and snapshot artifacts into <code>fileList</code> and calls <code>modManifest.WriteManifest</code> if available via <code>SafeRunHostMethod</code> (retries).<br>Manifest creation is non-fatal; absence of <code>modManifest</code> is logged as WARN. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Import to Excel sheets:</strong><br>Uses <code>SafeFileOp_ImportCsv</code> to call <code>ImportCsvToSheet</code> (retry/backoff).<br>Target sheets: <code>Outputs</code> and <code>Outputs_Per11</code>.<br>Operation is non-destructive (overwrites content optionally) and failures are logged but not fatal. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Snapshot & audit trail:</strong><br>Calls <code>SnapshotJobRules</code> to write <code>settings.csv</code> and <code>tblBrackets.csv</code> into job folder (audit snapshot).<br>Snapshot is best-effort and executed even on partial failures to preserve provenance. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Test harness (Test_RunAll) design:</strong><br>Idempotent preparation: ensure <code>Settings</code> sheet exists, set <code>OUTPUT_BASE</code> to test path, clear <code>JOB_ID</code> to force new job folder, ensure <code>tblInput</code> and add sample row.<br>Clears previous test outputs in job folder (best-effort), invokes <code>pph21_RunAll</code>, then verifies expected output files & manifest presence. Designed for repeated execution without manual cleanup. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Helpers, fallbacks & utilities:</strong><br>Key wrappers: <code>SafeRunHostMethod</code> (retries host calls), <code>SafeFileOp_WriteCsvAtomic</code>, <code>SafeFileOp_ImportCsv</code>, <code>WaitMs</code>, <code>EnsureZeroBasedArray</code>, <code>LocalNzNumeric</code>, <code>LocalParseRateToFractionFallback</code>, <code>CreateFolderIfMissing</code>, <code>SafeLog</code>, <code>SafeGetValue</code>, <code>SafeRowIdForLog</code>.<br>These centralize error handling, logging, numeric parsing and locale resilience. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Parsing & locale resilience:</strong><br>Local numeric parsing (<code>LocalNzNumeric</code>, <code>LocalParseRateToFractionFallback</code>) strips currency markers (e.g., <code>Rp</code>), normalizes <code>.</code> vs <code>,</code> grouping/decimal separators, removes non-digit characters, and supports mixed-format inputs common in Indonesian datasets. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Concurrency, atomicity & locking considerations:</strong><br>Atomic file operations rely on atomic rename semantics and host <code>SafeMoveFile</code> where available.<br>No global inter-process lock for the overall job folder — if concurrent runs target same folder, races possible (recommend unique job folders per run).<br>Suggestion: implement per-job lockfile to prevent concurrent writers. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance & scaling notes:</strong><br>Single-threaded; memory consumption grows with <code>results</code> collection and in-memory CSV arrays. For large input sets streaming writes and chunked processing recommended.<br>Retry/backoff on transient failures can add latency; parameters tuned via config. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security & privacy:</strong><br>Logs mask simple identifiers but CSV snapshots include PII (nip, npwp, name).<br>Recommendation: apply access controls to job folders and optionally redact or encrypt sensitive fields before persisting snapshots or CSV outputs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testability & 10× verification checklist (execute before production):</strong><br>1) Validate host API detection method does not execute side-effects.<br>2) Run Preflight with and without <code>STRICT_IO</code> to confirm abort behavior.<br>3) Confirm JOB_ID uniqueness and output folder created per run.<br>4) Exercise ReadBrackets + NormalizeBracketArrays (host + local) with mixed-format numbers.<br>5) Inject TER_* tables and verify <code>modCalc.SetTERTables</code> call and TER lookup behavior.<br>6) Force ProcessRow failures to validate retry/backoff and <code>SafeProcessRow</code> tri-state handling.<br>7) Simulate WriteCsvAtomic failures (rename/permission errors) and confirm retry/backoff and temp-file cleanup.<br>8) Verify manifest creation fallback when <code>modManifest</code> missing and when present (entry entry correctness).<br>9) Test <code>Test_RunAll</code> idempotency by repeated runs and verify outputs and snapshots.<br>10) Run memory/large-input stress test to confirm chunked processing recommendation. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Known limitations & recommended improvements (prioritized):</strong><br>1) Replace <code>IsHostApiAvailable</code> <code>Application.Run</code> probe with a non-executing capability registry or explicit host API registrar.<br>2) Add per-job lockfile (atomic creation) to prevent concurrent jobs writing same outputs.<br>3) Stream CSV rows directly to ADODB/host write to avoid large in-memory arrays for large datasets.<br>4) Add configurable CSV delimiter/encoding options and ability to redact PII before snapshot.<br>5) Add unit tests with injected host mocks to validate retry/backoff semantics deterministically. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final integrity statement:</strong><br>Session scan and cross-checks performed (10× review on control flow, host interactions, file IO, fallback paths, parsing logic, and test harness behavior).<br>No code modifications made here — this document is a detailed technical breakdown and action checklist derived from the provided <code>modMain</code> source and session context. </td></tr></tbody></table></div><div class="row-count">Rows: 24</div></div><div class="table-caption" id="Table5" data-table="Proj_0013_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module Purpose & Scope</strong>:<br>- Purpose: reliable manifest writer and SHA-256 hashing utility for job artifacts.<br>- Scope: compute stable SHA-256, read binary files, build atomic <code>manifest.json</code>, provide backwards-compatible wrappers.<br>- Non-goals: not a general-purpose checksum daemon; does not stream-hash very large files efficiently (current design reads file into memory unless <code>certutil</code> used). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public Surface & Contracts</strong>:<br>- <code>SHA256_FileHex(filePath) As String</code> — returns 64-char lowercase hex, <code>&quot;&quot;</code> on error.<br>- <code>ReadBinaryFile(filePath) As Byte()</code> — returns byte array or zero-length array on error.<br>- <code>WriteManifest(jobFolder, jobId, fileList) As Boolean</code> — writes <code>manifest.json</code> with <code>files[]</code> entries and totals; returns True on success.<br>- <code>WriteManifest_Sub(jobFolder, jobId, fileList)</code> — Sub wrapper for hosts expecting a Sub signature.<br>- Contract expectations:<br>  • <code>jobFolder</code> must be writable by process.<br>  • <code>fileList</code> items are full paths (non-recursive).<br>  • Caller may rely on <code>manifest.json</code> present when function returns True. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Top-level design decisions</strong>:<br>- Prefer native OS tool (<code>certutil</code>) for hashing when available to avoid memory pressure and use optimized native implementation.<br>- Provide fully self-contained internal SHA-256 as fallback so module remains portable and deterministic across hosts.<br>- Produce deterministic JSON ordering and atomic write semantics to reduce risk of partial/invalid manifests.<br>- Favor best-effort, defensive error handling: log and return safe values rather than throwing uncaught errors. </td></tr><tr><td data-label="Technical Breakdown"> <strong>SHA-256 strategy (detailed)</strong>:<br>- Step A: Attempt <code>certutil</code> via <code>WScript.Shell.exec</code>:<br>  • Command: <code>cmd /c certutil -hashfile &quot;&lt;filePath&gt;&quot; SHA256 2&gt;&amp;1</code> to capture output including stderr.<br>  • Read <code>StdOut</code> fully (loop <code>Not AtEndOfStream</code>) to assemble <code>outText</code>.<br>  • Extract first hex candidate with <code>ExtractFirstHex64</code> (regex tolerant to spaces/dashes).<br>  • If a 64+ hex is found, return first 64 lowercased chars.<br>- Step B: Fallback internal hash:<br>  • <code>ReadBinaryFile</code> => ADODB.Stream binary read into <code>Byte()</code> array.<br>  • <code>SHA256_Bytes</code> computes digest per RFC-6234: padding, big-endian 64-bit length, message schedule W[0..63], 64 rounds, state update.<br>  • <code>BytesToHex</code> converts digest to hex and returns lowercase first 64 chars.<br>- Rationale: <code>certutil</code> preferred for large files and speed; internal fallback ensures checksum correctness when external tools absent. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Internal SHA-256 implementation details</strong>:<br>- Word operations built on 32-bit arithmetic emulation:<br>  • <code>ROR32(x,n)</code> implements rotate-right using double/integer math to handle unsigned wrap correctly.<br>  • <code>ADD32</code> performs mod 2^32 accumulation over arguments using Double to avoid signed overflow.<br>- Message processing:<br>  • Uses explicit K constants and initial H values matching SHA-256 specification.<br>  • Converts groups of 4 bytes to 32-bit big-endian words for W[0..15].<br>  • Computes W[16..63] using sigma0/sigma1 implemented with <code>ROR32</code> and shifts.<br>  • Performs compression loop with ch/maj, S0/S1, t1/t2, and accumulates back into Hvals.<br>- Output: 32-byte digest assembled as big-endian bytes. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Binary I/O specifics</strong>:<br>- <code>ReadBinaryFile</code>:<br>  • Uses ADODB.Stream (Type=1) to load file into <code>Byte()</code>; returns zero-length array on error.<br>  • Ensures stream closed on error and logs problems via <code>LogMsgLocal</code>.<br>- <code>WriteTextFileAtomic</code> (used by manifest writer):<br>  • First tries host <code>modIO.WriteUtf8FileAtomic</code> to centralize encoding/atomic semantics.<br>  • Fallback: ADODB.Stream writes <code>tmpPath</code> (UTF-8), then <code>FileSystemObject.MoveFile tmpPath -&gt; finalPath</code> ensuring atomic replace on same volume.<br>  • Uses tmp extension <code>.tmp</code> and cleans existing final prior to move. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Manifest format & serialization</strong>:<br>- JSON shape:<br>  <code>{&quot;job_id&quot;:&quot;...&quot;,&quot;generated_at&quot;:&quot;YYYY-MM-DDTHH:MM:SS&quot;,&quot;files&quot;:[{ &quot;path&quot;:&quot;...&quot;, &quot;size&quot;:N, &quot;modified&quot;:&quot;YYYY-MM-DDTHH:MM:SS&quot;, &quot;sha256&quot;:&quot;...&quot; }, ... ], &quot;total_size_bytes&quot;:N, &quot;import_error&quot;:null}</code>.<br>- Deterministic ordering of properties: <code>path</code>, <code>size</code>, <code>modified</code>, <code>sha256</code> per entry.<br>- <code>path</code> is relative to <code>jobFolder</code> when possible; else absolute path retained.<br>- <code>generated_at</code> uses local system time formatted <code>yyyy-mm-dd\THH:nn:ss</code> (ISO-like). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Concurrency, atomicity & file-safety</strong>:<br>- Atomic snapshot semantics rely on tmp -> rename (OS atomic rename on same volume).<br>- Potential race: if another writer creates same tmp name concurrently — mitigated by immediate move and unique tmp name per file (<code>fileName.tmp</code>).<br>- Manifest update is atomic: write <code>manifest.json.tmp</code> then move to <code>manifest.json</code>.<br>- No explicit dir-level locking used here; recommend external coordination if multi-proc writes expected. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling & diagnostics</strong>:<br>- Functions return safe sentinel values rather than raising: <code>SHA256_FileHex = &quot;&quot;</code>, <code>ReadBinaryFile = empty byte array</code>, <code>WriteManifest = False</code>.<br>- All host calls are wrapped with <code>On Error Resume Next</code> and errors logged via <code>LogMsgLocal</code> or <code>Debug.Print</code> fallback.<br>- <code>ExtractFirstHex64</code> resilient to localized or formatted <code>certutil</code> outputs by stripping spaces/dashes. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Memory & performance considerations</strong>:<br>- Internal fallback reads entire file into memory -> memory usage = file size + overhead. Not suitable for very large files (> available memory).<br>- <code>certutil</code> path recommended for large files to avoid memory pressure and use OS-optimized hashing.<br>- For large-scale use, implement streaming chunk-hash or use external tool invocation exclusively. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Platform specifics</strong>:<br>- <code>certutil</code> usage assumes Windows environment and presence of <code>certutil</code> in PATH.<br>- <code>WScript.Shell</code> COM is used for command execution; may be restricted by host policies (macro security).<br>- ADODB.Stream works on Windows with MDAC/ADO available; ensure VBA host permits COM creation. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security considerations</strong>:<br>- Manifest contains SHA-256 hashes in plain text; protect manifest folder from tampering using appropriate OS permissions.<br>- Using <code>certutil</code> command via shell introduces command-injection risk if <code>filePath</code> is not sanitized — module wraps path in quotes and escapes double-quotes. Avoid passing attacker-controlled paths. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Edge cases & pitfalls</strong>:<br>- <code>certutil</code> output in non-English locales can include extra lines — <code>ExtractFirstHex64</code> handles it but test with localized <code>certutil</code> output.<br>- Files with locked read access: <code>ReadBinaryFile</code> will fail; manifest will exclude file silently (logged). Consider returning diagnostic list of skipped files.<br>- File timestamps: <code>DateLastModified</code> formatting uses local system time; timezones are not encoded — consider adding timezone or using UTC if needed. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing matrix & vectors (recommended)</strong>:<br>- Unit tests for: <code>BytesToHex</code> (0x00..0xFF), <code>ExtractFirstHex64</code> (certutil variations), <code>EscapeJson</code> (control chars).<br>- SHA-256 correctness tests:<br>  • Empty file => <code>e3b0c44298fc1c14...</code> expected digest.<br>  • Known content strings (e.g., "abc") vs reference implementations.<br>  • Large files (1MB, 100MB) comparing <code>certutil</code> vs <code>SHA256_Bytes</code> output when feasible.<br>- Integration tests for <code>WriteManifest</code>:<br>  • Mixed fileList with missing files, verify manifest contains only existing files and sizes/sha256 accurate.<br>  • Simulate absence of <code>modIO.WriteUtf8FileAtomic</code> to exercise ADODB fallback. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational improvements & roadmap (practical)</strong>:<br>- Add streaming SHA-256 variant: compute digest in chunks to support arbitrarily large files without full in-memory read.<br>- Add optional <code>prefer_external_hasher</code> flag to force <code>certutil</code> and fail otherwise (useful for consistent environment hashing policies).<br>- Extend manifest schema to include <code>sha256_algo_version</code> and <code>sha256_source</code> (<code>certutil</code> vs <code>internal</code>) for traceability.<br>- Add <code>manifest.verification</code> routine that re-hashes files and compares stored checksum to detect drift/corruption. </td></tr><tr><td data-label="Technical Breakdown"> <strong>CI / deployment suggestions</strong>:<br>- Add test CI step to compute and assert SHA-256 for a set of fixtures across OS images (Windows Server, Windows 10) to validate <code>certutil</code> extraction and internal fallback parity.<br>- Lint internal SHA-256 implementation against test vectors from NIST to ensure conformance.<br>- Run static analysis for potential integer overflow or floating arithmetic edge-cases in <code>ROR32</code>/<code>ADD32</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>10× checks performed (explicit)</strong>:<br>1) Verified public function names & signatures in source.<br>2) Confirmed <code>certutil</code> shell path is attempted and output parsed via <code>ExtractFirstHex64</code>.<br>3) Confirmed ADODB.Stream used for ReadBinaryFile and WriteTextFileAtomic fallback.<br>4) Confirmed SHA256_Bytes implements message padding and big-endian length encoding.<br>5) Confirmed BytesToHex produces two hex chars per byte and lowercasing.<br>6) Confirmed WriteManifest constructs deterministic JSON and writes atomically via tmp->move.<br>7) Confirmed manifest entry fields: path, size, modified, sha256, and total size aggregation.<br>8) Confirmed error handling converts exceptions to safe returns and logs via <code>LogMsgLocal</code>.<br>9) Confirmed compatibility wrapper <code>WriteManifest_Sub</code> accepts arrays and Collections and coerces where needed.<br>10) Confirmed fallback paths for missing host helpers (<code>modIO</code>, <code>modUtils</code>) are present and safe. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Developer checklist before merging</strong>:<br>- Add unit tests for empty file and small fixtures verifying internal SHA256 matches known vectors.<br>- Add test mocking <code>WScript.Shell.exec</code> to simulate <code>certutil</code> output and failure modes.<br>- Consider adding a streaming SHA-256 function to avoid memory-bound failures.<br>- Ensure host policy allows <code>WScript.Shell</code> and <code>ADODB.Stream</code> in deployment environment; otherwise remove <code>certutil</code> path or gate behind config. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Quick usage examples (call sites)</strong>:<br>- Compute hash: <code>Dim sha As String: sha = modManifest.SHA256_FileHex(&quot;C:\job\file.txt&quot;)</code>.<br>- Create manifest: <code>Dim ok As Boolean: ok = modManifest.WriteManifest(&quot;C:\job\&quot;, &quot;job-20251204-001&quot;, fileCollection)</code>.<br>- Host wrapper compatibility: call <code>modManifest.WriteManifest_Sub</code> if calling host expects a Sub. </td></tr></tbody></table></div><div class="row-count">Rows: 19</div></div><div class="table-caption" id="Table6" data-table="Proj_0013_06" style="margin-top:2mm;margin-left:3mm;"><strong>Table 6</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Module Purpose & Scope</strong><br>Provides robust filesystem and host-integration utilities used by the project: logging to workbook sheet, safe atomic file ops (move/copy/write), folder creation with retry, sleep/timing helpers, GUID/nonce generation, masking for logs, and safe <code>Application.Run</code> wrappers. Intentionally defensive: strong fallbacks, minimal throwing, boolean success indicators. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Compatibility / Declarations</strong><br><code>Option Explicit</code> enforced. Conditional <code>Declare PtrSafe</code> for <code>SleepAPI</code> (supports VBA7 32/64-bit and legacy). Relies on common COM components: <code>Scripting.FileSystemObject</code>, <code>Scriptlet.TypeLib</code>, and optionally <code>WScript.Shell</code> (used in other modules). Designed to run inside <code>ThisWorkbook</code> context. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API (surface area)</strong><br><code>LogMsg(logsSheetName, msg, level, context)</code> — write log rows.<br><code>MaskSensitive(text)</code> — heuristic masking.<br><code>EnsureFolderExists(folderPath, createIfMissing)</code> — create/check folder.<br><code>EnsureFolderExistsWithRetry(folderPath, maxAttempts, baseDelayMs)</code> — retry wrapper.<br><code>SafeMoveFile(src,dst)</code> and <code>SafeCopyFileAtomic(src,dst)</code> — atomic file moves/copies.<br><code>DeleteFileIfExists(fpath)</code> — safe deletion.<br><code>SafeRunNoArgs(procName)</code> / <code>SafeRunWithArgs(procName, ParamArray)</code> — safe host call wrappers.<br><code>EnsureFolderWithRetry</code> (alias) and other small helpers. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Logging behavior (LogMsg)</strong><br>Creates <code>Logs</code> sheet if missing and inserts rows: <code>Timestamp</code>, <code>Level</code>, <code>Message</code>, <code>Context</code>.<br>Applies <code>MaskSensitive</code> to message/context before writing.<br>Disables <code>ScreenUpdating</code> while writing to avoid flicker. Falls back to <code>Debug.Print</code> on error. Creates sheet header row when new. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Masking approach (MaskSensitive & SimpleMaskDigits)</strong><br>Heuristic regex-based masking for digit sequences:<br>1) pattern <code>\d[\d\.\-\/\s]{11,}\d</code> (complex formatted numbers) and<br>2) pattern <code>\d{5,}</code> (long digit runs).<br><code>SimpleMaskDigits</code> retains non-digit separators and masks middle digits leaving left/right context (default keepLeft=2 keepRight=2). Non-fatal (returns original on exception). </td></tr><tr><td data-label="Technical Breakdown"> <strong>File/folder atomicity model</strong><br>Primary strategy: copy-to-temp inside destination folder and then rename/move to final path to minimize window where target absent/partial.<br><code>SafeMoveFile</code> first attempts <code>fso.MoveFile</code> (fast/atomic same-volume). If that fails, copy to destination tmp file then move/rename or copy into place, then delete source. Temp names use timestamp + GUID suffix. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Concurrency and race considerations</strong><br>No cross-process lock primitive in this module. Atomic rename reduces TOCTOU but does not guarantee exclusivity when multiple processes operate on same file names. Recommendation: callers implement manifest/lock files (other modules like modTER use <code>ter_manifest.lock</code>). Module provides idempotent temp-naming to minimize collisions. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Retry / backoff design</strong><br><code>EnsureFolderExistsWithRetry</code> uses exponential backoff: <code>baseDelayMs * (2 ^ (attempt-1))</code> up to given attempts. <code>SafeMoveFile</code> does not retry internally beyond fallback attempts; callers should wrap if extra resiliency required. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Temporary filename strategy</strong><br>Temp names created in destination folder: <code>tmp_YYYYMMDD_HHNNSS_&lt;guidsuffix&gt;.tmp</code> where <code>GenerateGuidSuffix(8)</code> produces rightmost chars of <code>Scriptlet.TypeLib</code> GUID or numeric fallback. Choosing destination folder for tmp ensures rename (move) is atomic when same volume. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Sleep & timing (SleepMs)</strong><br>Uses <code>SleepAPI</code> when available (VBA7) for precise sleeps. Fallback to <code>Timer</code> + DoEvents loop with midnight wrap handling. Implementation yields via <code>DoEvents</code> to remain responsive. </td></tr><tr><td data-label="Technical Breakdown"> <strong>GUID / nonce generation</strong><br>Primary: <code>Scriptlet.TypeLib.GUID</code> cleaned and truncated to requested length. Fallback numeric random string using <code>Rnd</code>. Not cryptographically secure but sufficient for tmp naming and low-collision probability. </td></tr><tr><td data-label="Technical Breakdown"> <strong>SafeRun wrappers</strong><br><code>SafeRunNoArgs</code> and <code>SafeRunWithArgs</code> call <code>Application.Run</code> with error trapping and logs on failure. <code>SafeRunWithArgs</code> explicitly supports 0–5 args, logs error on >5 args. Use these wrappers to call host macros without bubbling exceptions. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling philosophy</strong><br>Prefer returning boolean or safe default instead of raising exceptions. Use <code>On Error GoTo ErrHandler</code> and <code>On Error Resume Next</code> selectively, always logging failures via <code>LogMsg</code>. Avoids breaking orchestrator code that expects robust behavior. </td></tr><tr><td data-label="Technical Breakdown"> <strong>ADDITIONAL SAFETY: Deletion & cleanup</strong><br><code>DeleteFileIfExists</code> silently removes specified file if present. <code>SafeMoveFile</code> attempts to delete source after copy-to-destination, but may leave tmp files if unexpected crash occurs — periodic cleanup recommended. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Dependencies & cross-module contracts</strong><br>Used by: modTER (manifest lock and safe move), modManifest (WriteTextFileAtomic via modIO fallback), modIO (WriteUtf8FileAtomic), modMain (EnsureFolderExistsWithRetry), modCalc (calls to modUtils.LogMsg). Contract: callers should check boolean returns and not assume exceptions are thrown. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance characteristics</strong><br>File operations are synchronous and can block when copying large files. Masking uses regex (O(n)) per message. Sleep fallback uses CPU-light DoEvents loop. For high-volume file ops consider streaming or chunked copy in a dedicated helper. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security & privacy considerations</strong><br><code>MaskSensitive</code> prevents obvious numeric leakages in logs but is heuristic; it may not catch non-digit secrets. Logging to sheet means logs persist in workbook — avoid logging raw secrets. Consider encryption or log rotation for sensitive environments. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Edge cases & failure modes</strong><br>- Antivirus/EDR can block <code>Scriptlet.TypeLib</code> or file move/rename operations.<br>- Cross-volume <code>MoveFile</code> fails — handled via copy fallback.<br>- Destination folder missing — <code>EnsureFolderExists</code> will attempt creation; race conditions may require retries.<br>- Long file paths (>260) may fail depending on host settings. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Deterministic outputs & file path normalization</strong><br>Module does not normalize path case; when producing relative paths other modules normalize deterministically. Temp file generation keeps operations inside destination folder to preserve atomic rename semantics. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Observability / logging levels</strong><br>Log levels used: <code>INFO</code>, <code>WARN</code>, <code>ERROR</code>. <code>LogMsg</code> writes level uppercase. Caller modules should log contextual messages (source, error number). Log messages are masked before storage. </td></tr><tr><td data-label="Technical Breakdown"> <strong>10× Verification Checklist (recommended automated/manual tests)</strong><br>1) <code>LogMsg</code> creates <code>Logs</code> sheet when missing and writes header.<br>2) <code>MaskSensitive</code> masks representative NIP/NPWP/gakk sequences and preserves separators.<br>3) <code>EnsureFolderExistsWithRetry</code> creates nested folder tree even when parent missing.<br>4) <code>SafeMoveFile</code> moves file across same volume (direct rename path) and returns True.<br>5) <code>SafeMoveFile</code> copies and moves across different volumes and returns True.<br>6) <code>SafeCopyFileAtomic</code> guarantees existence of destination file and no partially-written file observed (rename semantics).<br>7) <code>SleepMs</code> uses API when available and fallback path when not (simulate non-VBA7).<br>8) <code>GenerateGuidSuffix</code> uniqueness check (1k iterations — low collision rate).<br>9) <code>SafeRunWithArgs</code> logs and returns gracefully when target procedure missing or raises; supports up to 5 args.<br>10) Crash-recovery test: simulate mid-copy crash and ensure system can cleanup or tolerate leftover tmp files. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Integration test scenarios</strong><br>- Orchestrator run (modMain.Test_RunAll): ensure folder creation, CSV writes, manifest interactions succeed with modUtils in place.<br>- Concurrent commit simulation: two processes attempt SafeMoveFile into same dst — observe transient failures and ensure no corruption.<br>- Host macro missing simulation: <code>SafeRunWithArgs</code> should log and not interrupt orchestration. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational recommendations</strong><br>- Add periodic tmp-file cleanup routine in job folder (e.g., older than N hours).<br>- Add optional config for mask rules (patterns to include/exclude).<br>- Provide an explicit <code>TryAcquireLock(folder, lockName, ttl)</code> in modUtils to centralize locking patterns used by manifest/ter modules.<br>- Add unit tests around regex masks for multiple locales. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Documentation & maintainability notes</strong><br>- Keep regex patterns and temp-name templates documented and centralized.<br>- Avoid adding destructive operations without explicit <code>force</code> opt-in.<br>- When adding new <code>SafeRun</code> overloads expand the supported arg count or accept <code>Variant</code> array to avoid >5 arg logging. </td></tr></tbody></table></div><div class="row-count">Rows: 24</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>