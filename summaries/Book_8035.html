<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1761023495">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Book_8035_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Role / Purpose</strong><br><br><code>main.py</code> is the unified PasteToTable entrypoint. Supports:  <br>• Web app mode (<code>html_renderer.create_app</code>)  <br>• Optional batch export mode (<code>--batch</code> CLI or <code>P2T_BATCH=1</code>).  <br>Ensures table parsing, sanitization, and fallback rendering without modifying locked files. Provides defensive handling for missing dependencies, paths, and environment configurations.                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>Boot / Config Flow</strong><br><br>1. Import standard modules (<code>os</code>, <code>sys</code>, <code>glob</code>, <code>re</code>, <code>pathlib</code>, <code>traceback</code>, <code>importlib.util</code>, <code>shutil</code>, <code>html</code>, <code>uuid</code>, <code>StringIO</code>, typing).  <br>2. Load project utilities: <code>load_env</code>, <code>make_logger</code>, <code>ensure_dir</code>.  <br>3. Attempt to import <code>html_renderer.create_app</code>. If missing, web mode fails safely later.  <br>4. Initialize logger (<code>paste-to-table</code>).  <br>5. Determine operational mode based on CLI args and environment variables.                                                                                 </td></tr><tr><td data-label="Technical Breakdown"> <strong>Renderer Loader</strong><br><br><strong>_load_renderer_callable()</strong>: Load <code>render_html</code> for batch export. <br>• Prefer local <code>html_renderer.py</code>; fallback to installed module. <br>• Logs warnings if missing or function absent. <br>• Provides clear failure path while keeping web mode intact.                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Technical Breakdown"> <strong>Safe CSV Reader</strong><br><br><strong>_safe_read_csv()</strong>: Robustly parses CSV content with multiple pandas version fallbacks. <br>• Handles strings and file-like objects. <br>• Skips malformed lines, blank rows, and unnamed columns. <br>• Returns a clean DataFrame, ensuring no crash on edge cases.                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>Markdown / CSV Parser</strong><br><br><strong>parse_markdown_tables(content)</strong>: Conservative extraction of tables from Markdown or CSV text. <br>• Detects code blocks to skip content. <br>• Identifies pipe-based Markdown tables via <code>_is_md_sep_line</code>. <br>• Preserves inline formatting, escapes pipes, and normalizes headers. <br>• <code>_flush_pipe_block</code> & <code>_flush_csv_block</code> handle conversion to DataFrame. <br>• Drops empty or all-blank columns and rows. <br>• Returns list of parsed DataFrames.                                                                  </td></tr><tr><td data-label="Technical Breakdown"> <strong>Markdown-to-HTML (inline)</strong><br><br><strong>markdown_to_html(text)</strong>: Minimal conversion, preserves code and inline formatting. <br>• Handles bold, italics, inline code. <br>• Escapes underscores and special characters. <br>• Returns HTML string without <code>&lt;br&gt;</code> injection.                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical Breakdown"> <strong>Dropbox Path Sanitizer</strong><br><br><strong>_sanitize_cell_text_for_dropbox / _sanitize_dropbox_paths_df</strong>: <br>• Detect Windows & POSIX Dropbox paths in cell content. <br>• Replace sensitive paths with <code>&lt;redacted&gt;</code>. <br>• Applies per-column and per-cell. <br>• Keeps batch export safe for shared output.                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>DataFrame HTML Renderer</strong><br><br><strong>render_df_to_html_preserve_code(df)</strong>: Converts a DataFrame to HTML while preserving inline <code>code</code> segments. <br>• Maps each inline code string to a placeholder, replaces after <code>to_html</code>. <br>• Fallback to default <code>to_html</code> on errors.  <br><strong>render_df_to_html(df)</strong>: Wraps above HTML in <code>&lt;div class=&quot;table-container inline-mode&quot;&gt;</code>.                                                                                                                                                                                    </td></tr><tr><td data-label="Technical Breakdown"> <strong>Fragment Cleanup</strong><br><br><strong>_cleanup_fragments_safe(target_dirs)</strong>: Remove temporary fragment directories (e.g., <code>.frags_*</code>, <code>.fragments</code>). <br>• Iterates target dirs safely, logs removal, ignores errors.                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical Breakdown"> <strong>Batch Processing (_run_batch)</strong><br><br><strong>Purpose</strong>: Process multiple Markdown files into HTML. <br>• Ensures <code>pandas</code> availability. <br>• Loads renderer callable. <br>• Scans MD folder for files; groups by filename prefix. <br>• Maintains numeric map for book ordering; handles extras. <br>• Parses tables using <code>parse_markdown_tables</code> and CSV fallbacks. <br>• Sanitizes Dropbox paths. <br>• Writes HTML: uses <code>render_html</code> if available, else fallback writer. <br>• Calls <code>_cleanup_fragments_safe</code> on output folder and current working directory. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Entry Point (main)</strong><br><br><strong>Flow:</strong><br>1. Load environment config (<code>load_env</code>) and ensure storage folder exists. <br>2. Detect batch mode via environment or CLI. <br>3. If batch mode → call <code>_run_batch</code> with MD folder and output folder. <br>4. Else → web mode: require <code>create_app</code>. <br>5. Create Flask app, determine port and host. <br>6. Run <code>app.run(host, port)</code>; wrap with try/except to catch runtime errors. <br>7. Handles <code>multiprocessing.freeze_support()</code> for Windows executables.                                                         </td></tr><tr><td data-label="Technical Breakdown"> <strong>Logging & Defensive Practices</strong><br><br>• All major operations wrapped in try/except with logger. <br>• Fallbacks at every stage: renderer missing, missing files, parse errors. <br>• Warnings for invalid configs or empty datasets. <br>• Ensures no crash breaks web mode if batch dependencies are missing.                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance & Resource Notes</strong><br><br>• Batch mode uses incremental parsing, only loading needed files into memory. <br>• Drop redundant empty columns/rows early to reduce DataFrame size. <br>• HTML fallback avoids heavy JS rendering; minimal inline CSS for safe display. <br>• Fragment cleanup prevents stale temp files from bloating disk.                                                                                                                                                                                                              </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational Recommendations</strong><br><br>• Validate MD_FOLDER and OUTPUT_FOLDER before batch run. <br>• Ensure <code>pandas</code> installed in batch environments. <br>• Avoid using <code>&lt;br&gt;</code> or inline transforms outside renderer — preserves PasteToTable semantics. <br>• Enable logging at <code>INFO</code> for general operation; <code>DEBUG</code> for troubleshooting parse issues.                                                                                                                                                                                                           </td></tr><tr><td data-label="Technical Breakdown"> <strong>Risks & Hardening Notes</strong><br><br>• Renderer import failure → web mode fails; handled via logging and exit. <br>• Malformed Markdown/CSV → skipped rows; no crash. <br>• Unsanitized Dropbox paths could leak sensitive info; sanitizer must run before HTML write. <br>• Long Markdown tables may impact memory; monitor <code>pandas</code> usage.                                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final Summary</strong><br><br><code>main.py</code> is a robust, dual-mode entrypoint. Ensures safe table parsing, batch export, web app launch, and sensitive-path sanitization. Highly defensive coding prevents crashes due to environment, missing modules, or malformed files. Built-in logging, cleanup, and fallback mechanisms guarantee operational reliability.                                                                                                                                                                                                            </td></tr></tbody></table></div><div class="row-count">Rows: 16</div></div><div class="table-caption" id="Table2" data-table="Book_8035_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Topic**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Topic</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Details**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Details</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Topic"> <strong>Role / Purpose (executive)</strong>                   </td><td data-label="Details"> <code>html_renderer.py</code> orchestrates robust, conservative HTML generation for PasteToTable. Exposes <code>render_html</code>, <code>render_table</code>, and <code>render_page</code> (falling back when core renderer modules are unavailable). Responsibilities: preserve protected HTML blocks, enforce configured <code>&lt;h1&gt;</code> attributes, inject PTT table UI assets and wrappers, convert safe single-newlines to <code>&lt;br&gt;</code> only inside table cells, provide conservative minification, and export diagnostics. The module must be safe for batch and web use and tolerate missing optional dependencies.                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Topic"> <strong>Primary inputs & outputs</strong>                     </td><td data-label="Details"> Inputs: raw HTML fragments or tables (DataFrames or Python structures), configuration via environment variables or <code>set_renderer_config</code>, optional helper modules under <code>render.*</code>, and asset files on disk. Outputs: processed HTML string, bytes, or written files; wrapped table fragments with UI; optional diagnostics metadata; and path strings for written files. The wrapper contract is: accept diverse return types (str, bytes, pathlib.Path) and post-process safely.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Topic"> <strong>Operational configuration & environment</strong>      </td><td data-label="Details"> Config defaults provided in <code>_DEFAULTS</code>. Key env/config knobs: <code>RENDER_ENSURE_TITLE</code> (ensure <code>&lt;h1&gt;</code> attributes), <code>RENDER_MINIFY_HTML</code> (conservative minifier), <code>RENDER_PROCESS_PATH_OUTPUTS</code> (apply postprocessing to returned file paths), <code>RENDER_TITLE_CLASS</code> and <code>RENDER_TITLE_ID</code> (class/id injected into first <code>&lt;h1&gt;</code>), <code>TABLE_UI_CSS</code> and <code>TABLE_UI_JS</code> (asset locations), <code>TABLE_UI_MAX_ATTR_JSON_LEN</code> (max JSON length to embed as attribute), and <code>RENDER_DEBUG</code> (verbose import traces). Use <code>set_renderer_config</code> to override runtime without env changes.                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Topic"> <strong>Import / bootstrap behavior</strong>                  </td><td data-label="Details"> On import, module ensures project root on <code>sys.path</code>, initializes diagnostics <code>deque</code>, sets up logger, precompiles regexes, and attempts to import core renderer implementations from <code>render.core_compat</code> then <code>render.core_renderer</code>. Optional helpers (<code>convert_bullets_to_ul</code>, <code>_normalize_list_markers</code>, <code>_unescape_brackets_outside_code</code>) and asset utilities (<code>prepare_assets</code>, <code>write_overrides_css</code>) are imported non-fatally. Each import attempt is recorded in <code>_try_msgs</code> for diagnostics.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Topic"> <strong>Diagnostics & introspection</strong>                  </td><td data-label="Details"> <code>get_import_diagnostics()</code> returns the record of import attempts, presence flags for exported functions, and current configuration snapshot. <code>generate_diagnostic_report(html_sample)</code> runs a sample through postprocessing (ensuring title, optional minify, UI injection, and table wrapping) and returns short <code>sample_before</code> / <code>sample_after</code> strings plus wrapped-function flags. <code>_record()</code> safely appends messages to <code>_try_msgs</code>. Diagnostics are safe for logging and remote debugging.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Topic"> <strong>Regex strategy & tokenization</strong>                </td><td data-label="Details"> Precompiled regexes provide reliable boundaries: <code>_H1_RE</code> finds first <code>&lt;h1&gt;</code> start tag fragment; <code>_CLASS_ATTR_RE</code> extracts a class attribute pair; <code>_MINIFY_TOKEN_RE</code> tokenizes "protected" tokens (script/style/pre/textarea/code/comment/other tags) to allow whitespace minification only outside them; <code>_TABLE_RE</code> finds <code>&lt;table&gt;</code> blocks; <code>_CAPTION_RE</code> extracts captions; head/body/link/script regexes help asset injection. RegExes are DOTALL and IGNORECASE to avoid edge-case misses but remain conservative to avoid accidental HTML transformation.                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Topic"> <strong>Title enforcement algorithm</strong>                  </td><td data-label="Details"> <code>_ensure_title_attrs_in_str</code> finds the first <code>&lt;h1&gt;</code> and passes it to <code>_ensure_title_in_h1_fragment</code>. The fragment logic: detect existing class attribute and append configured <code>page_title_class</code> if missing, inject <code>page_title_id</code> as <code>id</code> when absent, preserve existing attributes order/spacing, handle malformed attributes defensively. The function avoids modifying content when <code>ensure_title</code> is disabled. Errors log but return original HTML intact.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Topic"> <strong>Conservative minifier behavior</strong>               </td><td data-label="Details"> <code>_minify_html_str</code> splits the HTML by <code>_MINIFY_TOKEN_RE</code>. Tokens starting with <code>&lt;</code> are emitted unchanged. Text tokens are whitespace-normalized by converting runs of whitespace to a single space and trimming. This minifier intentionally does not remove line-significant whitespace inside protected tags and reduces only extraneous whitespace outside them. The operation is safe but may change spacing around text nodes; it is optional and controlled by config.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Topic"> <strong>Byte processing & encodings</strong>                  </td><td data-label="Details"> <code>_process_bytes</code> attempts UTF-8 decode then falls back to latin1. After optional title ensure and optional minify it re-encodes to UTF-8. This handles binary inputs, files, and avoids raising on non-UTF-8 content. Use-case: when <code>render_*</code> returns bytes or a file path; <code>_wrap_callable</code> funnels results through <code>_process_bytes</code> when appropriate.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Topic"> <strong>Table UI injection & wrapping (concept)</strong>      </td><td data-label="Details"> The module adds PTT-specific UI to tables to provide toolbar controls and metadata for clients. Workflow: locate <code>&lt;table&gt;</code> blocks with <code>_TABLE_RE</code>, convert safe newlines inside cells, extract and remove <code>&lt;caption&gt;</code> (stored separately), produce a standardized wrapper containing <code>&lt;h3 class=&quot;table-title&quot;&gt;</code>, toolbar HTML, <code>&lt;div class=&quot;table-core&quot;&gt;</code> with table HTML, and <code>&lt;div class=&quot;table-caption&quot;&gt;</code>. Each wrapper includes a <code>data-title</code> attribute and attempts to inline a compact JSON payload as <code>data-ptt-json</code> when below <code>table_ui_max_attr_json_len</code>; otherwise attach the JSON via a <code>&lt;script type=&quot;application/json&quot; data-ptt=&quot;TableN&quot;&gt;</code> after the wrapper. This provides client-side indexing and quick ToC/metadata without requiring server-side APIs.                                                                                                                                                                                                                    </td></tr><tr><td data-label="Topic"> <strong>Toolbar & UI elements</strong>                        </td><td data-label="Details"> <code>_default_toolbar_html</code> yields compact, accessible toolbar buttons: collapse toggle, copy, export CSV/JSON/MD. Buttons use <code>data-action</code> attributes for client JS to hook. Toolbar injection can be overridden via <code>_renderer_config[&quot;table_ui_toolbar_html&quot;]</code>. The toolbar is inserted inside each <code>.table-wrapper</code> for per-table controls.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Topic"> <strong>Newline→<br> policy inside table cells</strong>       </td><td data-label="Details"> <code>_convert_newlines_in_table_cells</code> uses <code>_CELL_TAG_RE</code> to capture <code>&lt;td&gt;</code>/<code>&lt;th&gt;</code> innerHTML. For each match: check for presence of protected substrings (<code>&lt;pre</code>, <code>&lt;code</code>, <code>&lt;textarea</code>, <code>&lt;script</code>); if present, skip conversion. Normalize CRLF to LF and single <code>\r</code> to LF. If <code>&lt;br</code> already present, skip to avoid double insertion. Replace <code>\n</code> with <code>&lt;br&gt;</code> conservatively. This approach ensures that formatted blocks stay untouched while plain cell text retains intended single-line breaks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Topic"> <strong>JSON payload strategy & size handling</strong>        </td><td data-label="Details"> When assembling <code>payload = {&quot;html&quot;: table_html}</code>, the code tries compact JSON serialization with <code>ensure_ascii=False</code> and tight separators. If JSON length <= configured max, it inlines it as <code>data-ptt-json</code> (escaped). If it exceeds max, it escapes JSON and emits as a separate <code>&lt;script type=&quot;application/json&quot; data-ptt=&quot;TableN&quot;&gt;...</code> to avoid overlong attributes and broken HTML. This design balances immediate availability to client-side scripts against HTML size limits.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Topic"> <strong>Wrapper id/title conventions</strong>                 </td><td data-label="Details"> Each wrapper gets deterministic ids: <code>table-wrapper-TableN</code> and <code>Table{N}</code> for anchors. The <code>&lt;h3&gt;</code> uses <code>data-idx</code> attr equal to table index. The <code>data-title</code> attribute is populated with caption or fallback title text, escaped for safety. Consistency ensures client-side linking and predictable anchors across renderer versions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Topic"> <strong>_wrap_callable responsibilities</strong>              </td><td data-label="Details"> <code>_wrap_callable</code> decorates any existing rendering callable so post-processing (title ensure, minify, UI injection, table wrapping) is applied uniformly. It handles return types: str, bytes/bytearray, and pathlib.Path. For bytes it decodes via <code>_process_bytes</code>; for pathlib.Path, when <code>process_path_outputs</code> is true, it can load and postprocess string content, otherwise leave unchanged. Decorator preserves original function metadata and marks the function as wrapped to avoid double-wrapping. Errors during post-processing are caught and logged; original output returned when post-processing fails.                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Topic"> <strong>Import fallback policy</strong>                       </td><td data-label="Details"> Primary attempt is to import <code>render.core_compat</code> which may provide rich rendering features. Fallback is <code>render.core_renderer</code>. All import attempts are recorded. Optional helpers are imported non-fatally. When none of the core modules exist, a fallback pure-Python renderer (dependent only on pandas optionally) is created and wrapped. This guarantees exported <code>render_html</code> etc are always available unless the environment is hostile.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Topic"> <strong>Fallback renderer behavior (detailed)</strong>        </td><td data-label="Details"> Fallback implementations: <code>_df_to_html_preserve_code</code> preserves inline backtick code by mapping occurrences to UUID tokens before calling DataFrame <code>to_html(escape=True)</code>. <code>_fallback_render_html</code> builds a minimal HTML shell: meta tags, title configured via <code>_renderer_config</code>, a first <code>&lt;h1&gt;</code> with page-title class/id, iterates tables and renders each as either preserved-dataframe HTML or escaped pre blocks for strings. It applies conservative newline→<code>&lt;br&gt;</code> inside table cells via <code>_convert_newlines_in_table_cells</code>. It attempts to write to <code>output_path</code> if provided with binary mode and returns the path string. All I/O is wrapped in defensive directory creation and exception handling; binary result gets post-processed with <code>_process_bytes</code>. Fallback functions are wrapped by <code>_wrap_callable</code> before assignment.                                                                                                                                                 </td></tr><tr><td data-label="Topic"> <strong>Create_app shim & fallback web server</strong>        </td><td data-label="Details"> <code>create_app(cfg)</code> first delegates to <code>server.create_app</code> when available. If delegation fails, it falls back to a Flask-based minimal app. Flask fallback routes: <code>/</code> (index), <code>/api/health</code> (uptime), <code>/api/convert</code> and <code>/api/render</code> (POST endpoints that call <code>render_html</code> when available or echo escaped input), with a minimal content-length pre-request guard based on <code>MAX_PASTE_SIZE</code>. It also sets minimal security headers on responses and returns helpful HTTP error codes for large inputs. This ensures web usability when a full server module is absent.                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Topic"> <strong>Security posture & XSS mitigation</strong>            </td><td data-label="Details"> Inline code tokens are escaped before being reinserted as <code>&lt;code&gt;</code> to prevent executable HTML. Default content security headers set by <code>_set_minimal_security_headers</code> include <code>X-Content-Type-Options: nosniff</code>, <code>X-Frame-Options: DENY</code>, <code>Referrer-Policy: no-referrer-when-downgrade</code>, and <code>Permissions-Policy</code>. Recommend adding a CSP meta tag to fallback HTML outputs and verifying <code>render_html</code> output sanitization when used with untrusted inputs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Topic"> <strong>Performance & complexity analysis</strong>            </td><td data-label="Details"> Heavy operations: regex scanning of large HTML, JSON serialization of large table payloads, and DataFrame <code>to_html</code> for big tables. <code>_wrap_each_table_with_ui</code> iterates over all <code>&lt;table&gt;</code> matches and may perform large string concatenations; <code>table_ui_max_attr_json_len</code> prevents embedding huge JSON in attributes. <code>_minify_html_str</code> reduces output size but costs CPU for tokenization. Overall complexity is linear in input size plus overhead for heavy DataFrame serialization. For very large datasets run batch processing in processes and set <code>RENDER_MINIFY_HTML</code> off for speed.                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Topic"> <strong>Caching & optimization suggestions</strong>           </td><td data-label="Details"> Cache detection results for existing CSS/JS links in repeated render runs by computing a fingerprint of input HTML or by maintaining a short-term LRU cache keyed by input hash. For table JSON payloads, cache compact JSON of identical table HTML to avoid repeated JSON serialization. If used in a long-running service, consider streaming processing of very large HTML and incremental table wrapping to reduce peak memory.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Topic"> <strong>Diagnostics & observability</strong>                  </td><td data-label="Details"> Maintain <code>_try_msgs</code> as a rolling log of import/attempt messages. Export <code>get_import_diagnostics()</code> and <code>generate_diagnostic_report()</code> for automated health checks. Suggested additional metrics: per-render time (ms), number of tables wrapped, total bytes processed, whether fallback path used, and any write failures. Emit these in a small JSON sidecar when writing files in batch mode.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Topic"> <strong>Error handling & fail-safes</strong>                  </td><td data-label="Details"> All post-processing steps are try/except guarded. If injection/wrapping fails, original HTML is returned. If writing to disk fails, fallback function records via <code>_record</code> and returns in-memory bytes. Never raise from decorated functions during post-processing to avoid breaking callers that expect resilient behavior.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Topic"> <strong>Edge cases & pitfalls</strong>                        </td><td data-label="Details"> 1) Malformed HTML with nested unmatched tags may break regex matches; functions attempt to be conservative and return original content on failure.  <br>2) Extremely large table HTML may exceed attribute-safe lengths; this is handled with script payload fallback but could still cause page slowness.  <br>3) Minifier can alter whitespace-sensitive content outside protected tags; use with caution.  <br>4) If <code>render_html</code> returns a <code>pathlib.Path</code> and <code>process_path_outputs</code> is disabled, post-processing will not be applied to the file content.                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Topic"> <strong>Testing checklist (recommended)</strong>              </td><td data-label="Details"> 1) Import scenarios: with and without <code>render.core_compat</code> and <code>render.core_renderer</code>.  <br>2) Fallback behavior: <code>render_html</code> output types: str, bytes, pathlib.Path, and confirm <code>_wrap_callable</code> behavior.  <br>3) Title enforcement: HTML with no <code>&lt;h1&gt;</code>, with <code>&lt;h1&gt;</code> lacking class/id, and with existing class/id combinations.  <br>4) UI injection: HTML with/without <code>&lt;head&gt;</code> and with pre-existing CSS/JS tags referencing configured assets.  <br>5) Newline conversion: <code>&lt;td&gt;</code>/<code>&lt;th&gt;</code> with plain text newlines, and with <code>&lt;pre&gt;</code>/<code>&lt;code&gt;</code> present to ensure skip.  <br>6) JSON payload sizing: small vs over-limit payload producing inline attribute vs <code>&lt;script&gt;</code> fallback.  <br>7) Fallback render_html writing to disk and returning path string.  <br>8) Flask fallback API behaviors: <code>/api/convert</code> with valid/invalid input, and large input rejection via <code>MAX_PASTE_SIZE</code>.  <br>9) Encoding resilience: inputs in UTF-8 and latin1 and binary to confirm <code>_process_bytes</code>. </td></tr><tr><td data-label="Topic"> <strong>Operational recommendations</strong>                  </td><td data-label="Details"> 1) Set <code>RENDER_DEBUG=1</code> in staging to capture import traces.  <br>2) Keep <code>RENDER_MINIFY_HTML</code> off in development to avoid confusing diffs.  <br>3) Place PTT CSS/JS assets at stable URLs and configure <code>TABLE_UI_CSS</code>/<code>TABLE_UI_JS</code>.  <br>4) If using heavy batch rendering, run as worker processes with bounded memory and use diagnostics JSON to instrument throughput and failures.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Topic"> <strong>Hardening & security additions (recommended)</strong> </td><td data-label="Details"> 1) Add a strict Content-Security-Policy meta tag in fallback HTML: <code>default-src &#x27;none&#x27;; style-src &#x27;self&#x27; &#x27;unsafe-inline&#x27;; script-src &#x27;self&#x27;</code>.  <br>2) Sanitize <code>table_html</code> and caption content using a whitelist sanitizer if rendering untrusted markdown.  <br>3) Validate and limit JSON payload sizes server-side and truncate very large captions with an indicator.  <br>4) Consider signing or hashing <code>data-ptt-json</code> payloads when sensitive.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Topic"> <strong>Planned incremental improvements (roadmap)</strong>   </td><td data-label="Details"> P0: Expose per-render diagnostics, add CSP to fallback, and ensure atomic file writes in fallback render.  <br>P1: Add an LRU cache for repeated render inputs, stream processing for extremely large HTML, and a config-driven cap on tables per page.  <br>P2: Add server-side precomputed match descriptor support to integrate with client virtualizers and move heavy normalization to worker processes.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Topic"> <strong>Backward compatibility & integration notes</strong>   </td><td data-label="Details"> The module retains backward compatibility by preserving function names and wrapping behavior. <code>render_html</code> remains callable with both legacy and new signatures. <code>create_app</code> will prefer <code>server.create_app</code> when available. If code relies on pre-wrapping behavior, the <code>__tv_wrapped__</code> flag allows detection and avoids double-wrap.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Topic"> <strong>Final summary (actionable)</strong>                   </td><td data-label="Details"> <code>html_renderer.py</code> is a defensive, production-ready renderer shim with conservative transformations: title enforcement, protected-block-preserving minification, selective newline conversion inside table cells, and robust per-table wrapping with UI and metadata. It provides diagnostic hooks, safe fallbacks when dependencies are absent, and a consistent post-processing wrapper that ensures downstream consumers (web UI, batch export) receive predictable HTML. Apply recommended hardening (CSP, sanitizer) and add diagnostics JSON and atomic writes for batch output to increase reliability and auditability.                                                                                                                                                                                                                                                                                                                                                                  </td></tr></tbody></table></div><div class="row-count">Rows: 30</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>