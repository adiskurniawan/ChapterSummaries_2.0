<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1761541224">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#Table6">Table 6</a></li>
<li class="toc-item"><a class="toc-link" href="#Table7">Table 7</a></li>
<li class="toc-item"><a class="toc-link" href="#Table8">Table 8</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Book_8035_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Role / Purpose</strong><br><br><code>main.py</code> is the unified PasteToTable entrypoint. Supports:  <br>• Web app mode (<code>html_renderer.create_app</code>)  <br>• Optional batch export mode (<code>--batch</code> CLI or <code>P2T_BATCH=1</code>).  <br>Ensures table parsing, sanitization, and fallback rendering without modifying locked files. Provides defensive handling for missing dependencies, paths, and environment configurations.                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>Boot / Config Flow</strong><br><br>1. Import standard modules (<code>os</code>, <code>sys</code>, <code>glob</code>, <code>re</code>, <code>pathlib</code>, <code>traceback</code>, <code>importlib.util</code>, <code>shutil</code>, <code>html</code>, <code>uuid</code>, <code>StringIO</code>, typing).  <br>2. Load project utilities: <code>load_env</code>, <code>make_logger</code>, <code>ensure_dir</code>.  <br>3. Attempt to import <code>html_renderer.create_app</code>. If missing, web mode fails safely later.  <br>4. Initialize logger (<code>paste-to-table</code>).  <br>5. Determine operational mode based on CLI args and environment variables.                                                                                 </td></tr><tr><td data-label="Technical Breakdown"> <strong>Renderer Loader</strong><br><br><strong>_load_renderer_callable()</strong>: Load <code>render_html</code> for batch export. <br>• Prefer local <code>html_renderer.py</code>; fallback to installed module. <br>• Logs warnings if missing or function absent. <br>• Provides clear failure path while keeping web mode intact.                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Technical Breakdown"> <strong>Safe CSV Reader</strong><br><br><strong>_safe_read_csv()</strong>: Robustly parses CSV content with multiple pandas version fallbacks. <br>• Handles strings and file-like objects. <br>• Skips malformed lines, blank rows, and unnamed columns. <br>• Returns a clean DataFrame, ensuring no crash on edge cases.                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>Markdown / CSV Parser</strong><br><br><strong>parse_markdown_tables(content)</strong>: Conservative extraction of tables from Markdown or CSV text. <br>• Detects code blocks to skip content. <br>• Identifies pipe-based Markdown tables via <code>_is_md_sep_line</code>. <br>• Preserves inline formatting, escapes pipes, and normalizes headers. <br>• <code>_flush_pipe_block</code> & <code>_flush_csv_block</code> handle conversion to DataFrame. <br>• Drops empty or all-blank columns and rows. <br>• Returns list of parsed DataFrames.                                                                  </td></tr><tr><td data-label="Technical Breakdown"> <strong>Markdown-to-HTML (inline)</strong><br><br><strong>markdown_to_html(text)</strong>: Minimal conversion, preserves code and inline formatting. <br>• Handles bold, italics, inline code. <br>• Escapes underscores and special characters. <br>• Returns HTML string without <code>&lt;br&gt;</code> injection.                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical Breakdown"> <strong>Dropbox Path Sanitizer</strong><br><br><strong>_sanitize_cell_text_for_dropbox / _sanitize_dropbox_paths_df</strong>: <br>• Detect Windows & POSIX Dropbox paths in cell content. <br>• Replace sensitive paths with <code>&lt;redacted&gt;</code>. <br>• Applies per-column and per-cell. <br>• Keeps batch export safe for shared output.                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>DataFrame HTML Renderer</strong><br><br><strong>render_df_to_html_preserve_code(df)</strong>: Converts a DataFrame to HTML while preserving inline <code>code</code> segments. <br>• Maps each inline code string to a placeholder, replaces after <code>to_html</code>. <br>• Fallback to default <code>to_html</code> on errors.  <br><strong>render_df_to_html(df)</strong>: Wraps above HTML in <code>&lt;div class=&quot;table-container inline-mode&quot;&gt;</code>.                                                                                                                                                                                    </td></tr><tr><td data-label="Technical Breakdown"> <strong>Fragment Cleanup</strong><br><br><strong>_cleanup_fragments_safe(target_dirs)</strong>: Remove temporary fragment directories (e.g., <code>.frags_*</code>, <code>.fragments</code>). <br>• Iterates target dirs safely, logs removal, ignores errors.                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical Breakdown"> <strong>Batch Processing (_run_batch)</strong><br><br><strong>Purpose</strong>: Process multiple Markdown files into HTML. <br>• Ensures <code>pandas</code> availability. <br>• Loads renderer callable. <br>• Scans MD folder for files; groups by filename prefix. <br>• Maintains numeric map for book ordering; handles extras. <br>• Parses tables using <code>parse_markdown_tables</code> and CSV fallbacks. <br>• Sanitizes Dropbox paths. <br>• Writes HTML: uses <code>render_html</code> if available, else fallback writer. <br>• Calls <code>_cleanup_fragments_safe</code> on output folder and current working directory. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Entry Point (main)</strong><br><br><strong>Flow:</strong><br>1. Load environment config (<code>load_env</code>) and ensure storage folder exists. <br>2. Detect batch mode via environment or CLI. <br>3. If batch mode → call <code>_run_batch</code> with MD folder and output folder. <br>4. Else → web mode: require <code>create_app</code>. <br>5. Create Flask app, determine port and host. <br>6. Run <code>app.run(host, port)</code>; wrap with try/except to catch runtime errors. <br>7. Handles <code>multiprocessing.freeze_support()</code> for Windows executables.                                                         </td></tr><tr><td data-label="Technical Breakdown"> <strong>Logging & Defensive Practices</strong><br><br>• All major operations wrapped in try/except with logger. <br>• Fallbacks at every stage: renderer missing, missing files, parse errors. <br>• Warnings for invalid configs or empty datasets. <br>• Ensures no crash breaks web mode if batch dependencies are missing.                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance & Resource Notes</strong><br><br>• Batch mode uses incremental parsing, only loading needed files into memory. <br>• Drop redundant empty columns/rows early to reduce DataFrame size. <br>• HTML fallback avoids heavy JS rendering; minimal inline CSS for safe display. <br>• Fragment cleanup prevents stale temp files from bloating disk.                                                                                                                                                                                                              </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational Recommendations</strong><br><br>• Validate MD_FOLDER and OUTPUT_FOLDER before batch run. <br>• Ensure <code>pandas</code> installed in batch environments. <br>• Avoid using <code>&lt;br&gt;</code> or inline transforms outside renderer — preserves PasteToTable semantics. <br>• Enable logging at <code>INFO</code> for general operation; <code>DEBUG</code> for troubleshooting parse issues.                                                                                                                                                                                                           </td></tr><tr><td data-label="Technical Breakdown"> <strong>Risks & Hardening Notes</strong><br><br>• Renderer import failure → web mode fails; handled via logging and exit. <br>• Malformed Markdown/CSV → skipped rows; no crash. <br>• Unsanitized Dropbox paths could leak sensitive info; sanitizer must run before HTML write. <br>• Long Markdown tables may impact memory; monitor <code>pandas</code> usage.                                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final Summary</strong><br><br><code>main.py</code> is a robust, dual-mode entrypoint. Ensures safe table parsing, batch export, web app launch, and sensitive-path sanitization. Highly defensive coding prevents crashes due to environment, missing modules, or malformed files. Built-in logging, cleanup, and fallback mechanisms guarantee operational reliability.                                                                                                                                                                                                            </td></tr></tbody></table></div><div class="row-count">Rows: 16</div></div><div class="table-caption" id="Table2" data-table="Book_8035_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Role / Purpose (executive)</strong><br><code>html_renderer.py</code> orchestrates robust, conservative HTML generation for PasteToTable. Exposes <code>render_html</code>, <code>render_table</code>, and <code>render_page</code> (falling back when core renderer modules are unavailable). Responsibilities: preserve protected HTML blocks, enforce configured <code>&lt;h1&gt;</code> attributes, inject PTT table UI assets and wrappers, convert safe single-newlines to <code>&lt;br&gt;</code> only inside table cells, provide conservative minification, and export diagnostics. The module must be safe for batch and web use and tolerate missing optional dependencies.                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical Breakdown"> <strong>Primary inputs & outputs</strong><br>Inputs: raw HTML fragments or tables (DataFrames or Python structures), configuration via environment variables or <code>set_renderer_config</code>, optional helper modules under <code>render.*</code>, and asset files on disk. Outputs: processed HTML string, bytes, or written files; wrapped table fragments with UI; optional diagnostics metadata; and path strings for written files. The wrapper contract is: accept diverse return types (str, bytes, pathlib.Path) and post-process safely.                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational configuration & environment</strong><br>Config defaults provided in <code>_DEFAULTS</code>. Key env/config knobs: <code>RENDER_ENSURE_TITLE</code>, <code>RENDER_MINIFY_HTML</code>, <code>RENDER_PROCESS_PATH_OUTPUTS</code>, <code>RENDER_TITLE_CLASS</code>, <code>RENDER_TITLE_ID</code>, <code>TABLE_UI_CSS</code>, <code>TABLE_UI_JS</code>, <code>TABLE_UI_MAX_ATTR_JSON_LEN</code>, and <code>RENDER_DEBUG</code>. Use <code>set_renderer_config</code> to override runtime without env changes.                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical Breakdown"> <strong>Import / bootstrap behavior</strong><br>On import, module ensures project root on <code>sys.path</code>, initializes diagnostics <code>deque</code>, sets up logger, precompiles regexes, and attempts to import core renderer implementations from <code>render.core_compat</code> then <code>render.core_renderer</code>. Optional helpers and asset utilities are imported non-fatally. Each import attempt is recorded in <code>_try_msgs</code> for diagnostics.                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>Diagnostics & introspection</strong><br><code>get_import_diagnostics()</code> returns import attempt records, presence flags for exported functions, and current configuration snapshot. <code>generate_diagnostic_report(html_sample)</code> runs a sample through postprocessing and returns <code>sample_before</code> / <code>sample_after</code> plus wrapped-function flags. <code>_record()</code> safely appends messages to <code>_try_msgs</code>.                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical Breakdown"> <strong>Regex strategy & tokenization</strong><br>Precompiled regexes provide reliable boundaries: <code>_H1_RE</code>, <code>_CLASS_ATTR_RE</code>, <code>_MINIFY_TOKEN_RE</code>, <code>_TABLE_RE</code>, <code>_CAPTION_RE</code> and head/body/script helpers. Regexes are DOTALL and IGNORECASE and conservative to avoid accidental HTML transformation.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Technical Breakdown"> <strong>Title enforcement algorithm</strong><br><code>_ensure_title_attrs_in_str</code> finds first <code>&lt;h1&gt;</code> and uses <code>_ensure_title_in_h1_fragment</code> to append <code>page_title_class</code> and <code>page_title_id</code> when missing. Preserves attribute order/spacing and handles malformed attributes defensively. No-op when <code>ensure_title</code> disabled. Errors log but return original HTML.                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical Breakdown"> <strong>Conservative minifier behavior</strong><br><code>_minify_html_str</code> tokenizes by <code>_MINIFY_TOKEN_RE</code>. Protected tokens (tags) are emitted unchanged. Text tokens have runs of whitespace collapsed to single spaces and trimmed. Minifier avoids modifying whitespace inside protected tags. Controlled by config.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical Breakdown"> <strong>Byte processing & encodings</strong><br><code>_process_bytes</code> attempts UTF-8 decode then falls back to latin1. After title ensure and optional minify it re-encodes to UTF-8. Used when <code>render_*</code> returns bytes or a file path; <code>_wrap_callable</code> funnels results through it.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Technical Breakdown"> <strong>Table UI injection & wrapping (concept)</strong><br>Locate <code>&lt;table&gt;</code> blocks with <code>_TABLE_RE</code>. Convert safe newlines inside cells. Extract and remove <code>&lt;caption&gt;</code> (stored separately). Produce a standardized wrapper with <code>&lt;h3 class=&quot;table-title&quot;&gt;</code>, toolbar HTML, <code>&lt;div class=&quot;table-core&quot;&gt;</code> with table HTML, and <code>&lt;div class=&quot;table-caption&quot;&gt;</code>. Include <code>data-title</code> and inline <code>data-ptt-json</code> when below <code>table_ui_max_attr_json_len</code>; otherwise attach JSON via a <code>&lt;script type=&quot;application/json&quot; data-ptt=&quot;TableN&quot;&gt;</code>.                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Technical Breakdown"> <strong>Toolbar & UI elements</strong><br><code>_default_toolbar_html</code> yields compact toolbar buttons: collapse toggle, copy, export CSV/JSON/MD. Buttons use <code>data-action</code> attributes for client JS to hook. Toolbar injection is overridable via <code>_renderer_config[&quot;table_ui_toolbar_html&quot;]</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical Breakdown"> <strong>Newline→<br> policy inside table cells</strong><br><code>_convert_newlines_in_table_cells</code> captures <code>&lt;td&gt;</code>/<code>&lt;th&gt;</code> innerHTML. If protected substrings (<code>&lt;pre</code>, <code>&lt;code</code>, <code>&lt;textarea</code>, <code>&lt;script</code>) present, skip conversion. Normalize CRLF to LF. If <code>&lt;br</code> present, skip. Replace <code>\n</code> with <code>&lt;br&gt;</code> conservatively.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical Breakdown"> <strong>JSON payload strategy & size handling</strong><br>Assemble <code>payload = {&quot;html&quot;: table_html}</code> and compact-serialize it. If JSON length ≤ configured max, inline as <code>data-ptt-json</code> escaped. If over limit, emit as separate <code>&lt;script type=&quot;application/json&quot; data-ptt=&quot;TableN&quot;&gt;...</code>. Balances immediate client availability vs attribute size limits.                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Technical Breakdown"> <strong>Wrapper id/title conventions</strong><br>Deterministic ids: <code>table-wrapper-TableN</code> and <code>Table{N}</code> for anchors. <code>&lt;h3&gt;</code> uses <code>data-idx</code> equal to table index. <code>data-title</code> populated with caption or fallback text, escaped for safety.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>_wrap_callable responsibilities</strong><br>Decorator applies post-processing (title ensure, minify, UI injection, table wrapping) uniformly. Handles str, bytes/bytearray, and pathlib.Path. For bytes uses <code>_process_bytes</code>. For pathlib.Path, honors <code>process_path_outputs</code>. Preserves function metadata and marks as wrapped to avoid double-wrapping. Errors during post-processing are caught and original output returned.                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Technical Breakdown"> <strong>Import fallback policy</strong><br>Try import <code>render.core_compat</code> first, fallback to <code>render.core_renderer</code>. Optional helpers imported non-fatally. If none exist, create a pure-Python fallback renderer (pandas optional) so <code>render_html</code> etc are always available.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical Breakdown"> <strong>Fallback renderer behavior (detailed)</strong><br>Fallback <code>_df_to_html_preserve_code</code> maps inline backtick code to UUID tokens before <code>DataFrame.to_html(escape=True)</code>. <code>_fallback_render_html</code> builds minimal HTML shell with meta tags and configured <code>&lt;h1&gt;</code>, iterates tables, renders preserved DataFrame HTML or escaped pre blocks for strings, applies newline→<code>&lt;br&gt;</code> in cells, writes to <code>output_path</code> if provided, and returns path string. I/O is defensive. Fallbacks are wrapped by <code>_wrap_callable</code>.                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Technical Breakdown"> <strong>Create_app shim & fallback web server</strong><br><code>create_app(cfg)</code> delegates to <code>server.create_app</code> when available. If not, falls back to Flask-based minimal app with routes <code>/</code>, <code>/api/health</code>, <code>/api/convert</code>, <code>/api/render</code> calling <code>render_html</code> or echoing escaped input. Includes <code>MAX_PASTE_SIZE</code> guard, minimal security headers, and helpful HTTP error codes for large inputs.                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security posture & XSS mitigation</strong><br>Inline code tokens are escaped before reinsertion as <code>&lt;code&gt;</code>. Default response headers include <code>X-Content-Type-Options: nosniff</code>, <code>X-Frame-Options: DENY</code>, <code>Referrer-Policy: no-referrer-when-downgrade</code>, and <code>Permissions-Policy</code>. Recommend adding CSP meta tag and a whitelist sanitizer for untrusted inputs.                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance & complexity analysis</strong><br>Heavy ops: regex scanning of large HTML, JSON serialization of large table payloads, and DataFrame <code>to_html</code> for big tables. <code>_wrap_each_table_with_ui</code> iterates all <code>&lt;table&gt;</code> matches and may do large string concatenations. Complexity linear in input size plus DataFrame serialization overhead. For large datasets run batch processes and disable minify for speed.                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Technical Breakdown"> <strong>Caching & optimization suggestions</strong><br>Cache detection results for existing CSS/JS links via input fingerprint or LRU cache keyed by input hash. Cache compact JSON of identical table HTML. For long-running services, stream processing and incremental table wrapping reduce peak memory.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Technical Breakdown"> <strong>Diagnostics & observability</strong><br>Maintain <code>_try_msgs</code> rolling log. Export <code>get_import_diagnostics()</code> and <code>generate_diagnostic_report()</code> for health checks. Suggested metrics: per-render time, number of tables wrapped, bytes processed, whether fallback used, and write failures. Emit metrics in JSON sidecar when writing files in batch.                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>Error handling & fail-safes</strong><br>All post-processing steps are try/except guarded. If injection/wrapping fails original HTML is returned. If disk write fails record via <code>_record</code> and return in-memory bytes. Decorated functions never raise from post-processing to avoid breaking callers.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>Edge cases & pitfalls</strong><br>1) Malformed HTML with unmatched tags may break regex matches; functions return original content on failure.  <br>2) Extremely large table HTML may exceed attribute-safe lengths; use script payload fallback.  <br>3) Minifier can alter whitespace-sensitive content outside protected tags; use with caution.  <br>4) If <code>render_html</code> returns pathlib.Path and <code>process_path_outputs</code> is disabled, post-processing will not be applied to file content.                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>Testing checklist (recommended)</strong><br>1) Import scenarios with/without <code>render.core_compat</code> and <code>render.core_renderer</code>.  <br>2) Fallback behavior for return types: str, bytes, pathlib.Path and <code>_wrap_callable</code> behavior.  <br>3) Title enforcement: HTML with no <code>&lt;h1&gt;</code>, with <code>&lt;h1&gt;</code> lacking class/id, and with existing class/id combos.  <br>4) UI injection: HTML with/without <code>&lt;head&gt;</code> and with pre-existing CSS/JS tags.  <br>5) Newline conversion: <code>&lt;td&gt;</code>/<code>&lt;th&gt;</code> with plain text newlines and with <code>&lt;pre&gt;</code>/<code>&lt;code&gt;</code> present.  <br>6) JSON payload sizing: inline attribute vs <code>&lt;script&gt;</code> fallback.  <br>7) Fallback <code>render_html</code> writing to disk returning path.  <br>8) Flask fallback API behaviors and large input rejection.  <br>9) Encoding resilience: UTF-8, latin1, and binary inputs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Operational recommendations</strong><br>1) Set <code>RENDER_DEBUG=1</code> in staging to capture import traces.  <br>2) Keep <code>RENDER_MINIFY_HTML</code> off in development to avoid confusing diffs.  <br>3) Place PTT CSS/JS assets at stable URLs and configure <code>TABLE_UI_CSS</code>/<code>TABLE_UI_JS</code>.  <br>4) For heavy batch rendering run worker processes with bounded memory and use diagnostics JSON for instrumentation.                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical Breakdown"> <strong>Hardening & security additions (recommended)</strong><br>1) Add strict CSP meta tag: <code>default-src &#x27;none&#x27;; style-src &#x27;self&#x27; &#x27;unsafe-inline&#x27;; script-src &#x27;self&#x27;</code>.  <br>2) Sanitize <code>table_html</code> and caption content using whitelist sanitizer for untrusted markdown.  <br>3) Validate and limit JSON payload sizes server-side and truncate very large captions with an indicator.  <br>4) Consider signing or hashing <code>data-ptt-json</code> payloads when sensitive.                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>Planned incremental improvements (roadmap)</strong><br>P0: Expose per-render diagnostics, add CSP to fallback, ensure atomic file writes.  <br>P1: Add LRU cache for repeated inputs, stream processing for huge HTML, and config cap on tables per page.  <br>P2: Add server-side precomputed match descriptor support and move heavy normalization to workers.                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical Breakdown"> <strong>Backward compatibility & integration notes</strong><br>Retains backward compatibility by preserving function names and wrapping behavior. <code>render_html</code> callable with legacy and new signatures. <code>create_app</code> prefers <code>server.create_app</code> when available. <code>__tv_wrapped__</code> flag avoids double-wrap for callers relying on pre-wrapping.                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final summary (actionable)</strong><br><code>html_renderer.py</code> is a defensive, production-ready renderer shim with conservative transformations: title enforcement, protected-block-preserving minification, selective newline conversion inside table cells, and robust per-table wrapping with UI and metadata. Provide CSP and sanitizer, add diagnostics JSON and atomic writes for batch output to improve reliability and auditability.                                                                                                                                                                                                                                                                                                                                                                         </td></tr></tbody></table></div><div class="row-count">Rows: 30</div></div><div class="table-caption" id="Table3" data-table="Book_8035_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Summary**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Summary</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Summary"> <strong>📌 Section: Overview</strong><br><br><strong>File:</strong> <code>server.py</code> — PasteToTable web app. <strong>Purpose:</strong> lightweight Flask app exposing conversion, save, and retrieval endpoints for HTML/table fragments. Design goals: robust fallbacks (optional renderers/helpers), safe file writes, configurable limits (MAX_PASTE_SIZE), minimal security headers, optional CORS and rate limiting. Defensive pattern: prefer optional project helpers when available, fallback to safe local implementations. Ten careful passes completed.                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Summary"> <strong>App factory (<code>create_app</code>)</strong><br><br><strong>Purpose:</strong> Centralize configuration, static assets mapping, feature flags, and route registration. <strong>Key behaviors:</strong><br>1. Accepts optional <code>cfg</code> dict and sets defaults for <code>MAX_PASTE_SIZE</code>, <code>STORAGE_PATH</code>, <code>ENABLE_CORS</code>, <code>RATE_LIMIT</code>.<br>2. Normalizes <code>STORAGE_PATH</code> to an absolute path and stores in <code>app.config</code>.<br>3. Logs availability of optional components (CORS, Limiter, render helper, save/read helpers).<br>4. Optionally enables CORS and (if available) Flask-Limiter. <strong>Design note:</strong> routes close over <code>app</code> and use <code>app.config</code>/locals; consistent usage of config is recommended (see suggestions).                                                                                                                                                                                                       </td></tr><tr><td data-label="Summary"> <strong>Request-size enforcement (<code>@before_request</code>)</strong><br><br><strong>Purpose:</strong> Early reject too-large requests for methods likely to carry payloads. <strong>Behavior:</strong><br>1. Runs for POST/PUT/PATCH only. <br>2. Reads <code>request.content_length</code>. If present and > <code>MAX_PASTE_SIZE</code> → returns 413 JSON error <code>input_too_large</code>.<br>3. Defensive: if the check raises, it logs debug and allows request through to avoid accidental denial-of-service by internal error. <br><br><strong>Edge cases & notes:</strong> chunked requests may have <code>content_length=None</code> and are currently not rejected here; endpoints (e.g. <code>/convert</code>) re-check payload length after parsing body. Add debug logging for missing <code>Content-Length</code> for operators.                                                                                                                                                            </td></tr><tr><td data-label="Summary"> <strong>Renderer selection & fallback (<code>_render_text_with_fallbacks</code>)</strong><br><br><strong>Purpose:</strong> Provide uniform render API across projects with multiple possible renderers. <strong>Strategy:</strong><br>1. Prefer <code>render_from_text</code> if imported.<br>2. Try a prioritized list of candidate modules/functions (<code>render.convert.convert_text_to_html</code>, <code>render.core.render_from_text</code>, etc.).<br>3. Handle multiple return shapes: tuple, dict, plain string.<br>4. Fall back to escaped <code>&lt;pre&gt;</code> when all renderers fail. <br><br><strong>Behavioral guarantees:</strong> never throws to caller; returns <code>(html_str, metadata_dict)</code>. <strong>Suggestion:</strong> log which module supplied renderer for debug visibility.                                                                                                                                                                                                   </td></tr><tr><td data-label="Summary"> <strong><code>/convert</code> endpoint</strong><br><br><strong>Purpose:</strong> Accept user input (JSON or form), render to HTML fragment, return JSON <code>{ok, html, meta}</code> with guard for no-table results. <strong>Detailed flow:</strong><br>1. Parse JSON body (<code>get_json(silent=True)</code>) or form/values fallback. <br>2. Ensure <code>text</code> is a non-empty string. <br>3. Enforce length against <code>MAX_PASTE_SIZE</code> (server-side: <code>len(text)</code>).<br>4. Call <code>_render_text_with_fallbacks</code> with <code>inline_assets=False</code> option to avoid injecting assets. <br>5. Post-render guard: if output lacks <code>&lt;table</code>, replace with neutral error placeholder and add <code>meta.render_warning = &quot;no_table_detected&quot;</code>. <br>6. Return 200 JSON on success, 400/413/500 for various error cases. <br><br><strong>Notes:</strong> good validation and final guard prevents surprising outputs. Consider trimming extremely long <code>text</code> earlier to avoid memory spikes. </td></tr><tr><td data-label="Summary"> <strong><code>/save</code> endpoint</strong><br><br><strong>Purpose:</strong> Persist a provided HTML fragment into <code>STORAGE_PATH</code>. <strong>Detailed flow:</strong><br>1. Accepts JSON or form <code>html</code> and optional <code>filename</code>.<br>2. Validate non-empty HTML. <br>3. Ensure storage dir exists (<code>os.makedirs</code>). <br>4. Compute safe filename via <code>_safe_filename</code> (uses <code>werkzeug.utils.secure_filename</code>).<br>5. Prefer project helper <code>save_html_atomic</code> if callable; otherwise fallback to atomic write via <code>tempfile.mkstemp</code> + <code>os.replace</code>. <br>6. On success, return <code>{&quot;path&quot;: out_path, &quot;id&quot;: file_id}</code>. On failure return 500 with <code>save_failed</code>. <br><br><strong>Safety:</strong> fallback write uses atomic replace and attempts <code>chmod</code> to 0644. Temp-file cleanup attempted on exceptions. <strong>Suggestion:</strong> prefer <code>app.config[&quot;STORAGE_PATH&quot;]</code> for clarity and ensure write perms when running under different users.              </td></tr><tr><td data-label="Summary"> <strong><code>/saved/&lt;file_id&gt;</code> endpoint (get_saved)</strong><br><br><strong>Purpose:</strong> Safely send a saved file as an attachment. <strong>Flow & checks:</strong><br>1. If <code>read_saved</code> helper exists, call it to resolve path; otherwise assume <code>storage/file_id</code> as path.<br>2. Resolve <code>path_abs</code> and <code>storage_abs</code> and enforce containment using <code>os.path.commonpath</code> (abort 404 if mismatch).<br>3. Verify existence and filename presence; then <code>send_from_directory(directory, filename, as_attachment=True)</code>. <br><br><strong>Security notes:</strong> Common-path check prevents path traversal; prefer <code>Path.resolve()</code> + <code>is_relative_to()</code> (Py3.9+) to handle symlinks robustly. Keep returning 404 on any failure (no internal details leaked).                                                                                                                                                                     </td></tr><tr><td data-label="Summary"> <strong>Static & manifest handling</strong><br><br><strong><code>/assets/&lt;path&gt;</code></strong> serves static assets from <code>app.static_folder</code> via <code>send_from_directory</code> with abort fallback. <br><strong><code>/manifest.json</code></strong> tries <code>app.static_folder/manifest.json</code> then <code>app.root_path/manifest.json</code>; logs a debug message before returning 404. <br><br><strong>Robustness suggestion:</strong> derive absolute <code>static_path</code> from <code>app.root_path</code> when <code>app.static_folder</code> is relative; log which path was checked for easier diagnostics.                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Summary"> <strong>CORS and Rate limiting</strong><br><br><strong>Behavior:</strong> optional <code>ENABLE_CORS</code> enables Flask-CORS if installed. If <code>RATE_LIMIT</code> configured and <code>flask_limiter</code> present, a <code>Limiter</code> is created with <code>default_limits</code> — but routes are not decorated; default limits apply globally if <code>Limiter(app, default_limits=[...])</code> used (current code does that). <br><br><strong>Note:</strong> If per-route limits are required, add <code>@limiter.limit(...)</code> decorators. Warn if configured but libs missing (already present).                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Summary"> <strong>Logging & diagnostics</strong><br><br><strong>What it logs:</strong> Features availability, component initialization, and exceptions via <code>logger.exception</code> in handlers. <strong>Suggestion:</strong> also log which module provided <code>render_from_text</code> and when <code>save_html_atomic</code>/<code>read_saved</code> are used for easier debugging in multi-repo environments.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Summary"> <strong>Security headers (<code>@after_request</code>)</strong><br><br><strong>Purpose:</strong> Add minimal, non-invasive headers: <code>X-Content-Type-Options: nosniff</code>, <code>X-Frame-Options: DENY</code>, <code>Referrer-Policy: no-referrer-when-downgrade</code>, <code>Permissions-Policy: interest-cohort=()</code>. <br><br><strong>Design comment:</strong> Uses <code>response.headers.setdefault</code> to avoid overriding upstream values. Consider optional <code>Content-Security-Policy</code> if you can test it across integrations (might break embedded content).                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Summary"> <strong>Error handling & leakage</strong><br><br><strong>Principle:</strong> On exceptions, handlers log with <code>logger.exception</code> but return opaque errors (500 or 404) — good practice. Avoids leaking stack traces to clients. Consider a small JSON error body for 404/413 consistency (but be cautious not to reveal internals).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Summary"> <strong>Edge cases noticed</strong><br><br>1. <code>request.content_length</code> can be <code>None</code> for chunked requests — the pre-request check quietly allows chunked bodies; downstream endpoints re-check <code>len(text)</code> after parsing, but extremely large chunked uploads could bypass the early quick-reject. Add a debug log for <code>content_length is None</code>.<br>2. <code>render_from_text</code> import search quietly binds first found — add a debug/info log showing which provider was selected for operations tracing.<br>3. <code>get_saved</code> uses <code>os.path.commonpath</code> which may be fooled by symlinks or different drives; prefer <code>Path.resolve()</code> + <code>is_relative_to</code> for stronger containment. <br>4. <code>save()</code> uses <code>storage_path</code> closed-over variable; switching to <code>app.config[&quot;STORAGE_PATH&quot;]</code> inside handlers is clearer and avoids stale closure surprises.                                                </td></tr><tr><td data-label="Summary"> <strong>Performance considerations</strong><br><br>• <code>convert</code> renders user-supplied text server-side — consider large inputs memory/cpu cost (already limited by <code>MAX_PASTE_SIZE</code>).<br>• <code>get_json(silent=True)</code> can parse large JSON; you already enforce size before heavy rendering but early <code>Content-Length</code> absence (chunked) might allow pathological uploads; consider optional upload stream limits at the WSGI/proxy layer.<br>• <code>save()</code> atomic write uses <code>mkstemp</code> and <code>os.replace</code> — good atomicity, minimal blocking.                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Summary"> <strong>Operational & deploy notes</strong><br><br>• The <code>if __name__ == &quot;__main__&quot;: app.run(...)</code> block is explicitly for dev; use production WSGI server for deployment. <br>• Ensure <code>STORAGE_PATH</code> directory is writable by the process user and secure (not world-writable). <br>• Consider rotating old saved files or exposing limited listing API with auth if required.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Summary"> <strong>Tests to add (recommended)</strong><br><br>1. <code>manifest.json</code> discovery test: when static folder is relative vs absolute, ensure path found. <br>2. <code>convert</code> length enforcement: requests with <code>Content-Length</code> > limit, and chunked request (no <code>Content-Length</code>) behavior logged. <br>3. <code>save</code> atomic fallback: simulate partial write failure and assert no zero-byte file left and tmp file removed. <br>4. <code>get_saved</code> path traversal: ensure <code>..</code> or absolute path attempts return 404. <br>5. Renderer fallback: simulate missing renderers and ensure fallback <code>&lt;pre&gt;</code> returned.                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Summary"> <strong>High-impact, prioritized fixes (apply early)</strong><br><br>1. <strong>Manifest path resolution</strong> (high): resolve <code>app.static_folder</code> against <code>app.root_path</code> if not absolute; log checked paths. (See code snippet in analysis.)<br>2. <strong>Content-Length logging</strong> (medium): log when <code>content_length is None</code> in <code>_enforce_content_length</code> so operators can detect chunked uploads. Optionally reject chunked requests by policy. <br>3. <strong>Use <code>app.config[&quot;STORAGE_PATH&quot;]</code></strong> in routes (low): replace closure usage of <code>storage_path</code> for clarity.<br>4. <strong><code>get_saved</code> containment</strong> (medium): prefer <code>Path.resolve()</code> and <code>is_relative_to</code> for robust path containment, handle symlinks. <br>5. <strong>Renderer provenance logging</strong> (low): log which module supplied <code>render_from_text</code>.                                                                                                   </td></tr><tr><td data-label="Summary"> <strong>Small code hygiene suggestions</strong><br><br>• Prefer <code>app.logger</code> for Flask-integrated logging. <br>• Consider making <code>MAX_PASTE_SIZE</code> configurable per-route or via environment for blue/green testing. <br>• Add a small health metric counter for rejected oversized requests to assist ops.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Summary"> <strong>Security checklist (passed/notes)</strong><br><br>• Path traversal protected for saved files — PASS (commonpath used). Recommend stronger <code>resolve()</code> check. <br>• No template injection risk from <code>save()</code> — saved HTML is user-provided and served as attachment, not rendered inline — PASS. <br>• Minimal security headers added — PASS. <br>• Avoid revealing internal exception details to clients — PASS.                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Summary"> <strong>One-line summary recommendation</strong><br><br>Apply the manifest absolute-path patch and add a <code>Content-Length</code> missing debug log; optionally harden <code>get_saved</code> containment with <code>Path.resolve()</code>/<code>is_relative_to()</code> and prefer <code>app.config</code> access for <code>STORAGE_PATH</code>. After that, add the small tests listed above.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr></tbody></table></div><div class="row-count">Rows: 20</div></div><div class="table-caption" id="Table4" data-table="Book_8035_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Summary**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Summary</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Summary"> <strong>📌 Module Overview</strong><br><br><strong>Purpose:</strong> Provide a compact, battle-tested set of utilities used by PasteToTable and Table Viewer: environment loaders, logging helpers, filesystem & atomic IO helpers, small checksum/validation helpers, and lightweight markdown/table parsing utilities.<br><br><strong>Design goals:</strong> backward-compatible names; safe defaults; minimal external dependency surface; clear failure-mode logging; small, well-documented functions suitable for CLI, web, and renderer code. </td></tr><tr><td data-label="Summary"> <strong>load_env</strong><br><br><strong>Purpose:</strong> Read a <code>.env</code>-style file into a dict without mutating <code>os.environ</code>, allowing optional override of existing environment values.<br><br><strong>Behavior:</strong><br>1. Seed returned mapping with <code>dict(os.environ)</code>.<br>2. If <code>env_path</code> exists and is a file, iterate lines, skip blank/comments, split on first <code>=</code> into key/value.<br>3. Strip surrounding quotes from values; if <code>override</code> is True replace existing keys, otherwise keep existing env values.<br><br><strong>Failure modes & notes:</strong> If reading/parsing fails the function logs a debug message and returns the base mapping unchanged. It never raises on malformed lines—conservative, fail-safe behavior. </td></tr><tr><td data-label="Summary"> <strong>init_logger / make_logger</strong><br><br><strong>Purpose:</strong> Provide consistent console logging setup for CLI and library use. <code>init_logger</code> configures the root logger; <code>make_logger</code> returns a named logger with a StreamHandler and consistent formatting.<br><br><strong>Behavior:</strong><br>1. <code>init_logger(level, fmt, datefmt, force)</code> — optionally clears handlers when <code>force=True</code>, installs a stdout StreamHandler, sets level, and returns the root logger.<br>2. <code>make_logger(name, level)</code> — creates/returns logger; if it has no handlers it attaches a StreamHandler with the module default format; applies optional level.<br><br><strong>Design notes:</strong> Idempotent by default (doesn't duplicate handlers), safe for repeated calls in apps and libraries; written to avoid surprising console spam. </td></tr><tr><td data-label="Summary"> <strong>ensure_dir</strong><br><br><strong>Purpose:</strong> Make a directory (recursively) and return a canonical path; attempt an optional <code>chmod</code> while ignoring permission failures.<br><br><strong>Behavior:</strong><br>1. Create directory via <code>Path.mkdir(parents=True, exist_ok=True)</code>.<br>2. Attempt <code>chmod(mode)</code> but swallow exceptions (non-fatal).<br>3. Prefer <code>Path.resolve()</code> return value; fallback to <code>Path.absolute()</code> on failure.<br><br><strong>Subtleties:</strong> Avoids raising for common race conditions; callers rely on returned absolute/resolved path for subsequent safety checks. </td></tr><tr><td data-label="Summary"> <strong>safe_join</strong><br><br><strong>Purpose:</strong> Resolve a target path under a base directory and prevent path traversal attacks (raises <code>ValueError</code> if traversal detected).<br><br><strong>Behavior:</strong><br>1. Resolve both <code>base</code> and the <code>target</code> (<code>base.joinpath(*paths).resolve()</code>).<br>2. Use <code>os.path.commonpath</code> to confirm <code>target</code> is inside <code>base</code>.<br>3. Fall back to string prefix checks for edge-case platforms where <code>commonpath</code> may fail.<br><br><strong>Security notes:</strong> Designed to be defensive; raises quickly on suspicious inputs rather than attempting risky normalization. </td></tr><tr><td data-label="Summary"> <strong>safe_remove</strong><br><br><strong>Purpose:</strong> Best-effort file removal that returns success/failure without raising (useful for cleanup in finally blocks).<br><br><strong>Behavior:</strong><br>1. If path exists attempt <code>Path.unlink()</code>.<br>2. Return True when deletion succeeded or file was absent; return False on exception and emit debug log.<br><br><strong>Why:</strong> Keeps cleanup logic simple and non-throwing in higher-level workflows (e.g., atomic-write fallbacks). </td></tr><tr><td data-label="Summary"> <strong>atomic_write / atomic_write_bytes</strong><br><br><strong>Purpose:</strong> Atomically write text or bytes to a path using a same-directory temporary file + <code>os.replace</code> to avoid partial writes and tearing. <code>atomic_write_bytes</code> is a convenience wrapper for binary data.<br><br><strong>Behavior:</strong><br>1. Ensure parent directory exists.<br>2. Create a <code>NamedTemporaryFile</code> in target directory (delete=False).<br>3. Write data (text or binary), flush, attempt <code>os.fsync</code> (best-effort), close temp, then <code>os.replace(tmp, target)</code>.<br>4. Attempt cleanup of leftover temp file on unexpected exceptions.<br><br><strong>Edge cases & notes:</strong> Supports either <code>mode=&#x27;w&#x27;</code> or <code>&#x27;wb&#x27;</code>; treats bytes robustly; attempts to avoid leaving temporary artifacts; swallow low-level fs errors but bubble critical exceptions out of function in controlled manner only where necessary. </td></tr><tr><td data-label="Summary"> <strong>try_int</strong><br><br><strong>Purpose:</strong> Safe conversion to <code>int</code>—return a provided default (often <code>None</code>) on failure instead of raising.<br><br><strong>Behavior:</strong><br>1. Wrap <code>int(v)</code> in try/except and return <code>default</code> on any Exception.<br><br><strong>Use:</strong> Lightweight input coercion utility used across config parsing and environment handling. </td></tr><tr><td data-label="Summary"> <strong>checksum_file</strong><br><br><strong>Purpose:</strong> Compute a file digest (default <code>sha256</code>) in streaming fashion; return hex digest or <code>None</code> on failure.<br><br><strong>Behavior:</strong><br>1. Construct hashing object via <code>hashlib.new(algo)</code>.<br>2. Read file in chunks (configurable chunk size) and update hash.<br>3. Return <code>hexdigest()</code> or <code>None</code> if algo/file open fails.<br><br><strong>Notes:</strong> Streaming read prevents memory blow-up on large files; logs debug on failure. </td></tr><tr><td data-label="Summary"> <strong>validate_env_keys</strong><br><br><strong>Purpose:</strong> Verify required env keys exist and optionally raise on missing keys.<br><br><strong>Behavior:</strong><br>1. Build <code>missing = [k for k in required if not env.get(k)]</code>.<br>2. Log a warning with missing list.<br>3. If <code>raise_on_missing</code> True raise <code>ValueError</code> with a friendly message.<br><br><strong>Why:</strong> Useful for early validation of configuration in CLI/WSGI startup code; non-fatal by default for testability. </td></tr><tr><td data-label="Summary"> <strong>normalize_whitespace</strong><br><br><strong>Purpose:</strong> Normalize arbitrary whitespace (spaces, tabs, newlines) into a single space and trim the result—useful for canonicalizing headings or slug inputs.<br><br><strong>Behavior:</strong><br>1. Use <code>re.sub(r&#x27;\s+&#x27;, &#x27; &#x27;, text)</code> then <code>strip()</code>.<br><br><strong>Performance:</strong> Linear-time on input length; tiny and safe to call frequently. </td></tr><tr><td data-label="Summary"> <strong>is_table_separator</strong><br><br><strong>Purpose:</strong> Detect Markdown table divider lines (<code>---</code>, <code>:---:</code>, <code>---:</code>) including forms both with and without outer pipes.<br><br><strong>Behavior:</strong><br>1. Early-return False if no <code>-</code> present.<br>2. Use <code>split_table_row</code> to break into parts, verify each part matches <code>:?-{1,}\:?</code> via <code>re.fullmatch</code>.<br><br><strong>Why:</strong> Strict but tolerant detection prevents false positives on text that merely contains dashes. </td></tr><tr><td data-label="Summary"> <strong>parse_table</strong><br><br><strong>Purpose:</strong> Turn a block of lines containing a Markdown table into a 2D list of cell strings while skipping separator lines.<br><br><strong>Behavior:</strong><br>1. Iterate lines; skip blank lines.<br>2. Skip lines detected as separators by <code>is_table_separator</code>.<br>3. For other lines append <code>split_table_row(line)</code> to results.<br><br><strong>Notes:</strong> Minimal transformation—keeps underscores and inline formatting intact for downstream renderers. </td></tr><tr><td data-label="Summary"> <strong>is_list_item / extract_list</strong><br><br><strong>Purpose:</strong> Simple helpers to recognize Markdown list items and extract them from a list of lines.<br><br><strong>Behavior:</strong><br>1. <code>is_list_item</code> uses regex <code>^\s*(?:[-*+]|\d+\.)\s+</code> to detect list lines.<br>2. <code>extract_list</code> returns <code>line.strip()</code> for every line matching <code>is_list_item</code>.<br><br><strong>Why:</strong> Lightweight, avoids depending on a full Markdown parser when only list extraction is needed. </td></tr><tr><td data-label="Summary"> <strong>safe_slug</strong><br><br><strong>Purpose:</strong> Produce a filesystem/ID-safe slug while preserving underscores (useful for HTML IDs and filenames).<br><br><strong>Behavior:</strong><br>1. Normalize whitespace.<br>2. Replace runs of non-alphanumeric/underscore characters with <code>-</code>.<br>3. Trim leading/trailing <code>-</code> and lower-case.<br><br><strong>Tradeoffs:</strong> Keeps underscores intentionally; avoids aggressive Unicode folding to remain predictable. </td></tr><tr><td data-label="Summary"> <strong>chunk_lines</strong><br><br><strong>Purpose:</strong> Split an array of lines into chunks separated by lines that contain a given <code>marker</code> substring (marker line itself is not included).<br><br><strong>Behavior:</strong><br>1. Iterate lines; when <code>marker in line</code> flush current chunk and start a new one.<br>2. Return list of chunks; trailing non-empty chunk included.<br><br><strong>Use-case:</strong> Useful for splitting multi-table documents or handling multi-part inputs. </td></tr><tr><td data-label="Summary"> <strong>strip_comments</strong><br><br><strong>Purpose:</strong> Remove inline comment markers (<code>#</code>, <code>//</code> by default) while being careful not to chop URLs (e.g., avoid treating <code>http://</code> or <code>...#anchor</code> as comment start).<br><br><strong>Behavior:</strong><br>1. For each <code>marker</code> find its first occurrence.<br>2. If marker is <code>//</code> and the substring before the marker contains <code>://</code>, skip it.<br>3. If marker is <code>#</code> and the substring before the marker contains <code>://</code>, skip it.<br>4. Otherwise return the prefix up to the marker (rstrip); fall back to original stripped line when no marker applies.<br><br><strong>Why:</strong> Conservative rules reduce false-positive comment stripping when parsing config-like lines or URLs. </td></tr><tr><td data-label="Summary"> <strong>API & Backwards-Compatible Exports</strong><br><br><strong>Purpose:</strong> Keep historic function names available to callers and offer a minimal <code>__all__</code> for clear public API.<br><br><strong>Behavior:</strong><br>1. Export functions across env/logging/fs/parsing categories.<br>2. Designed so external code can <code>from utils import ...</code> without surprises.<br><br><strong>Maintenance note:</strong> Additions should keep backward names and avoid breaking changes; prefer additive changes and deprecations when necessary. </td></tr><tr><td data-label="Summary"> <strong>Performance, Complexity & Safety Summary</strong><br><br><strong>1. Complexity:</strong> Most parsing helpers operate in O(n) time where n = line or character length (e.g., <code>split_table_row</code>, <code>atomic_write</code> streaming, <code>checksum_file</code>).<br><strong>2. Memory:</strong> Functions are stream-friendly (atomic writes use temp files; checksum reads in chunks).<br><strong>3. Failure model:</strong> Functions favor safe, non-throwing behavior where reasonable (return defaults, <code>None</code>, or booleans) and log debug/warn messages; deliberate exceptions are used for programmer errors (e.g., <code>safe_join</code> raises on traversal).<br><strong>4. Security:</strong> <code>safe_join</code> blocks path traversal; <code>atomic_write</code> uses same-directory tmp files + <code>os.replace</code> to avoid TOCTOU on most POSIX filesystems.<br><br><strong>Recommendations:</strong> Cache normalized strings / regex results when parsing many cells; prefer streaming helpers for large files; keep <code>tv</code> highlight work off main thread where possible. </td></tr><tr><td data-label="Summary"> <strong>Extensibility & Integration Notes</strong><br><br><strong>1. Interop:</strong> Functions are intentionally small and composable so they can be replaced by project-specific implementations (e.g., <code>io_utils</code>) without changing callers.<br><strong>2. Testing:</strong> Each helper is straightforward to unit-test—supply edge cases (empty inputs, unusual unicode, escaped delimiters, nonexistent files).<br><strong>3. Hardening:</strong> Consider exposing optional <code>fsync</code> toggles and pluggable hash algorithms for environments with specific safety/performance tradeoffs.<br><br><strong>Final design ethos:</strong> Keep helpers minimal, well-documented, and defensive—prefer predictable, auditable behavior over clever shortcuts. </td></tr></tbody></table></div><div class="row-count">Rows: 20</div></div><div class="table-caption" id="Table5" data-table="Book_8035_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Assets module — world-class technical breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Assets module — world-class technical breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Assets module — world-class technical breakdown"> <strong>📌 Section: Overview & purpose</strong><br><br><strong>Purpose:</strong> Provide a tiny, resilient asset-copying fallback so rendered output always has <code>style.css</code> and <code>script.js</code>, and to emit a generated <code>overrides.css</code> tuned by <code>left_width</code>/<code>right_width</code> parameters.  <br><br><strong>High level behaviour:</strong> If project <code>assets/</code> exists (one level up in repo), copy <code>style.css</code> and <code>script.js</code> into <code>output_dir/assets</code>; otherwise write embedded fallback payloads. <code>write_overrides_css</code> writes a deterministic CSS file into the same <code>assets/</code> folder and returns the string.  <br><br><strong>Guarantees (current):</strong> Best-effort — never raises to caller on I/O errors, writes a non-empty fallback when source missing or errors occur.                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Assets module — world-class technical breakdown"> <strong>Constants: <code>_EMBED_STYLE</code> and <code>_EMBED_SCRIPT</code></strong><br><br><strong>Role:</strong> Minimal, self-contained fallback assets used when project assets are absent or copy fails.  <br><br><strong>Design notes:</strong><br>1. Small but valid CSS/JS reduces the chance of blank pages or JS runtime errors.  <br>2. Because they are embedded strings, they avoid encoding/disk-read failures.  <br><br><strong>Limitations:</strong> Not fingerprinted, not SRI’d, and intentionally minimal — suitable as emergency fallbacks, not production theme content.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Assets module — world-class technical breakdown"> <strong><code>copy_assets(output_dir)</code> — Purpose & contract</strong><br><br><strong>Purpose:</strong> Ensure <code>output_dir/assets</code> contains <code>style.css</code> and <code>script.js</code> by copying project assets if present; otherwise create safe fallbacks.  <br><br><strong>Public contract:</strong><br>1. Creates <code>output_dir/assets</code> if missing.  <br>2. If <code>../assets/{style.css,script.js}</code> exist relative to this module, attempt to copy them preserving metadata (<code>shutil.copy2</code>).  <br>3. On copy failure or missing source, write the embedded fallback file for that name.  <br>4. Never throws; errors are swallowed to keep rendering flow robust.  <br><br><strong>Important invariants:</strong> After return, both <code>style.css</code> and <code>script.js</code> should exist in <code>output_dir/assets</code> and be non-empty (barring disk errors).                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Assets module — world-class technical breakdown"> <strong><code>copy_assets</code> — Detailed behaviour / stepwise logic</strong><br><br>1. Compute <code>out_assets = os.path.join(output_dir, &quot;assets&quot;)</code> and <code>os.makedirs(..., exist_ok=True)</code>.  <br>2. Resolve <code>project_assets_dir = os.path.join(os.path.dirname(__file__), &quot;..&quot;, &quot;assets&quot;)</code> and <code>normpath</code> it.  <br>3. If <code>project_assets_dir</code> is a directory: iterate <code>(&quot;style.css&quot;,&quot;script.js&quot;)</code> and for each:<br>   • If <code>src</code> exists: call <code>shutil.copy2(src,dst)</code>.  <br>   • Else: open <code>dst</code> for text write and write the corresponding <code>_EMBED_*</code> fallback.  <br>   • All per-file ops are wrapped in <code>try/except</code>; on any exception write fallback to <code>dst</code>.  <br>4. If <code>project_assets_dir</code> is not present: write both fallback assets unconditionally.<br>5. Return <code>None</code> (side-effecting).                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Assets module — world-class technical breakdown"> <strong><code>copy_assets</code> — Failure modes & diagnostics</strong><br><br><strong>Failures handled:</strong> missing source files, permission denied, partial writes, <code>shutil.copy2</code> raising, path normalization oddities.  <br><br><strong>What the code does on failure:</strong> Swallows exceptions and writes embedded fallback content; no logging is present so failures are silent to callers.  <br><br><strong>Risks / observations:</strong><br>1. Silent failures can hide filesystem issues in deployments; calling code cannot distinguish “copied project asset” vs “fallback used”.  <br>2. Concurrent writers may race when two processes call <code>copy_assets</code> simultaneously — there is no atomic replace or tmp→move semantics.  <br>3. On partial write (process killed mid-write) a zero-byte or truncated file could persist because <code>open(dst, &quot;w&quot;)</code> writes directly.  <br><br><strong>Recommendation:</strong> Add logging and prefer atomic writes (write to a tmp file then <code>os.replace</code>) and optionally verify file sizes.                                                                                                                                         </td></tr><tr><td data-label="Assets module — world-class technical breakdown"> <strong><code>copy_assets</code> — Security & path safety</strong><br><br><strong>Path assumptions:</strong> Uses <code>os.path.dirname(__file__)</code> + <code>..</code> to find project assets — reasonable for standard layouts.  <br><br><strong>Potential hardening:</strong><br>1. Validate <code>output_dir</code> is inside an expected prefix or not a symlink to unexpected locations if running in multi-tenant environments.  <br>2. Sanitize names if inputs become dynamic (currently fixed filenames).  <br>3. Use explicit file permissions after write (<code>os.chmod(dst, 0o644)</code>) if desired.  <br><br><strong>Cross-platform notes:</strong> <code>shutil.copy2</code> preserves metadata where supported; Windows semantics differ for permissions and locking — atomicity needs special care on Windows (use <code>os.replace</code>, available on modern Python).                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Assets module — world-class technical breakdown"> <strong><code>copy_assets</code> — Idempotence & concurrency</strong><br><br><strong>Idempotence:</strong> Re-running is safe in the sense files exist after each run; but behaviour differs when file already present:<br>1. If <code>dst</code> already exists and <code>src</code> exists, <code>shutil.copy2</code> will overwrite <code>dst</code> atomically? (it writes to <code>dst</code> directly) — not atomic.  <br>2. If multiple processes run simultaneously, race conditions can leave partial writes.  <br><br><strong>Hardening:</strong> Use temporary file + <code>os.replace(tmp, dst)</code> to make each file update atomic and avoid visible half-written content. Optionally skip overwriting existing non-empty files unless <code>force</code> flag is passed.                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Assets module — world-class technical breakdown"> <strong><code>write_overrides_css(output_dir, left_width, right_width)</code> — Purpose & contract</strong><br><br><strong>Purpose:</strong> Generate <code>overrides.css</code> tailored to the left/right column width percentages and write it into <code>output_dir/assets/overrides.css</code>; return the CSS string for callers that want to inline or log it.  <br><br><strong>Contract:</strong><br>1. Ensure <code>assets</code> dir exists.  <br>2. Produce CSS that sets theme variables, dark overrides, sticky header/first-column behavior, row zebraing, list marker normalization, and width rules using <code>{left_width:.2f}</code> / <code>{right_width:.2f}</code>.  <br>3. Write file with text <code>encoding=&quot;utf-8&quot;</code>.  <br>4. On write error, swallow exception (best-effort).  <br><br><strong>Return value:</strong> The final <code>overrides_css</code> string (useful for embedding into HTML).                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Assets module — world-class technical breakdown"> <strong><code>write_overrides_css</code> — Detailed behaviour & important subtleties</strong><br><br>1. Creates <code>assets_dir = os.path.join(output_dir, &quot;assets&quot;)</code> and <code>os.makedirs(..., exist_ok=True)</code>.  <br>2. Builds a large formatted multi-line string containing layout variables and rules, substituting <code>left_width</code> and <code>right_width</code> as <code>%</code> values formatted to two decimal places.  <br>3. Writes the string to <code>overrides.css</code> with <code>encoding=&quot;utf-8&quot;</code>.  <br>4. Wraps write in <code>try/except</code> and silently ignores failures.  <br><br><strong>Subtleties:</strong><br>• If <code>left_width</code>/<code>right_width</code> are nonsensical (e.g., negative, >100, or <code>None</code>), the formatted string may contain invalid CSS values; caller should sanitize/normalize widths before calling.  <br>• The code always returns the CSS string even if the write failed — caller cannot infer success from the return value.  <br>• Because the CSS contains <code>!important</code> and wide selectors, it’s intentionally high-specificity to act as an overrides file; that is by design but can conflict with theming in consumer apps.                                          </td></tr><tr><td data-label="Assets module — world-class technical breakdown"> <strong>I/O safety & recommended improvements (practical engineering)</strong><br><br>1. <strong>Atomic writes:</strong> Replace simple <code>open(dst, &quot;w&quot;)</code> with write→tmp→<code>os.replace(tmp,dst)</code> to avoid partial files on crashes.  <br>2. <strong>Return success/metadata:</strong> Make <code>copy_assets</code> return a small report <code>{ written: [names], used_fallback: [names], errors: [...] }</code> so callers can log or surface diagnostics.  <br>3. <strong>Logging:</strong> Emit <code>logger.debug/info/warn</code> for copy attempts, fallbacks, and exceptions (current file has none).  <br>4. <strong>Permission handling:</strong> After writing, set <code>0o644</code> and catch <code>OSError</code>.  <br>5. <strong>Optional manifest & SRI:</strong> Emit an <code>assets-manifest.json</code> with filenames, sizes and <code>sha384</code> SRI — simplifies <code>core_assets</code> style resolution and enables integrity attributes in produced HTML.  <br>6. <strong>Fingerprinting:</strong> If the project supports fingerprinting, copy → compute hash → write fingerprinted name and return mapping.  <br>7. <strong>Configurable sources:</strong> Allow caller to pass <code>source_assets_dir</code> instead of computing relative path; eases embedding in unusual package layouts. </td></tr><tr><td data-label="Assets module — world-class technical breakdown"> <strong>Testing guidance (unit & integration tests)</strong><br><br><strong>Unit tests:</strong><br>1. Test when project <code>assets/</code> exists and both files present — expect copied files to match content and be non-empty.  <br>2. Test when one or both source files are missing — expect fallback content written.  <br>3. Simulate <code>shutil.copy2</code> raising and verify fallback is used and no exception escapes.  <br><br><strong>Integration tests:</strong><br>1. Run <code>copy_assets</code> concurrently from multiple processes and assert no corrupt or partial files produced (requires atomic write refactor).  <br>2. Validate <code>write_overrides_css</code> produced CSS parses (smoke test) and that substituted widths are sane.  <br><br><strong>Edge cases to assert:</strong> write permission denied, disk full, long path names, Windows ACL differences.                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Assets module — world-class technical breakdown"> <strong>Performance & complexity</strong><br><br><strong>Cost:</strong> Minimal — two file copies or two small text writes.  <br><br><strong>Worst case I/O cost:</strong> If <code>style.css</code>/<code>script.js</code> are large, <code>shutil.copy2</code> will stream entire files; use size limits if copying untrusted/very large assets.  <br><br><strong>Optimization if necessary:</strong> Skip copy for unchanged files by comparing <code>stat().st_mtime</code>/size or checksum before copying.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Assets module — world-class technical breakdown"> <strong>Cross-platform & packaging notes</strong><br><br>1. Relative <code>project_assets_dir</code> using <code>__file__</code> works for many deployments but may fail when module is packaged as a zipped egg or installed as a wheel — consider <code>pkg_resources</code> / <code>importlib.resources</code> for package data.  <br>2. On Windows, file locking can interfere with overwrites; atomic <code>os.replace</code> is preferred for safe swaps.  <br>3. Containerized runtimes (Docker) with read-only filesystems will surface write errors — surface those via return payload/logging.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Assets module — world-class technical breakdown"> <strong>Security & supply-chain considerations</strong><br><br>1. <strong>Untrusted assets:</strong> If project assets are user-provided, validate/scan them before copying to avoid shipping malicious JS/CSS.  <br>2. <strong>Integrity:</strong> Consider generating SRI hashes and including them in HTML link/script tags.  <br>3. <strong>Least privilege:</strong> Write files with conservative permissions; do not run as root in production.  <br>4. <strong>Content sniffing:</strong> Ensure <code>Content-Type</code> served by static server is correct (server side).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Assets module — world-class technical breakdown"> <strong>Backward compatibility & API suggestions</strong><br><br>1. Keep the existing function names for compatibility but change semantics only in non-breaking ways (e.g., additional return metadata).  <br>2. Add optional params: <code>force=False</code>, <code>atomic=True</code>, <code>source_dir=None</code>, <code>manifest=False</code>, <code>logger=None</code>.  <br>3. Maintain current “best-effort, non-raising” behaviour by default — opt into stricter erroring via <code>raise_on_error=True</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Assets module — world-class technical breakdown"> <strong>Minimal actionable checklist to harden module (prioritized)</strong><br><br>1. Replace direct writes with atomic write pattern (write tmp → <code>os.replace</code>).  <br>2. Add <code>logger</code> calls for success/failure and include which fallback was used.  <br>3. Return a small report from <code>copy_assets</code> so callers can surface diagnostics.  <br>4. Validate/sanitize <code>left_width</code>/<code>right_width</code> in <code>write_overrides_css</code> (clamp 5–95%).  <br>5. Optionally write an <code>assets-manifest.json</code> with SRI hashes.  <br><br><strong>Why prioritized:</strong> atomic writes and visibility (logging/report) remove the largest production footguns (partial files + silent failures).                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Assets module — world-class technical breakdown"> <strong>Short summary / recommended defaults</strong><br><br>• Keep the simple fallback behavior for reliability, but make writes atomic and observable.  <br>• Emit a machine-readable manifest (with SRI) when possible.  <br>• Return status so callers know whether a fallback was used.  <br>• Validate CSS width inputs and clamp them to sane ranges before writing.  <br><br><strong>Outcome:</strong> Small change set (atomic write wrapper + logging + return report + optional manifest) yields production-grade asset handling while preserving the module’s intent: never leave the output without usable CSS/JS.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr></tbody></table></div><div class="row-count">Rows: 17</div></div><div class="table-caption" id="Table6" data-table="Book_8035_06" style="margin-top:2mm;margin-left:3mm;"><strong>Table 6</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Summary**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Summary</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Summary"> <strong>📌 Section: Overview & Purpose</strong><br><br><strong>Purpose:</strong> Provide a minimal, robust CLI wrapper around the <code>render</code> package that accepts a source (file or directory), an output path, and an <code>--embed-assets</code> flag.  <br><br><strong>Design goals:</strong>  <br> • Be forgiving about missing optional types (<code>RenderConfig</code>) and adapt to multiple common <code>render_html</code> signatures.  <br> • Prefer explicit imports to avoid package re-export surprises.  <br> • Fail fast with clear exit codes when appropriate but otherwise return values from <code>render_html</code> to preserve upstream semantics.  <br><br><strong>Non-goals:</strong> not a full-featured renderer CLI — intentionally minimal and resilient.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Summary"> <strong>parse_args</strong><br><br><strong>Purpose:</strong> Centralize command-line parsing so <code>main()</code> can be exercised in tests by providing <code>argv</code>.  <br><br><strong>Behavior & details:</strong>  <br> 1. Create <code>ArgumentParser(description=&quot;Render tables to HTML.&quot;)</code>.  <br> 2. Positional <code>source</code> — required path (file or directory).  <br> 3. Optional <code>-o/--output</code> defaulting to <code>&quot;output_combined&quot;</code>.  <br> 4. <code>--embed-assets</code> boolean flag (store_true).  <br> 5. Return parsed args (no side effects).  <br><br><strong>Edge-cases handled:</strong> Argparse will produce user-friendly errors for missing positional arg or invalid flags; tests should call <code>parse_args([...])</code> to avoid sys.argv dependency.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Summary"> <strong>_make_config</strong><br><br><strong>Purpose:</strong> Construct a <code>RenderConfig</code>-like object when available, tolerating multiple constructor parameter names across versions.  <br><br><strong>Behavior (stepwise):</strong>  <br> 1. If <code>RenderConfig</code> is <code>None</code>, immediately return <code>None</code> (no config).  <br> 2. Attempt to call <code>RenderConfig(output_dir=str(output_path), embed_assets=embed_assets)</code>.  <br> 3. If <code>TypeError</code>, try <code>RenderConfig(output_path=...)</code>.  <br> 4. If still <code>TypeError</code>, try <code>RenderConfig(output=...)</code>.  <br> 5. If all parameterized attempts fail, attempt <code>RenderConfig()</code> (no-arg).  <br> 6. If that fails, return <code>None</code>.  <br><br><strong>Design notes:</strong> Uses increasingly permissive fallbacks to maximize compatibility with older/newer <code>RenderConfig</code> shapes.  <br><br><strong>Subtleties:</strong> A <code>TypeError</code> is assumed to indicate signature mismatch; other exceptions bubble into the outer try block and cause <code>None</code> to be returned gracefully.  <br><br><strong>Testing:</strong> Mock <code>RenderConfig</code> constructors with differing signatures to validate each branch.                                                                                                                                                         </td></tr><tr><td data-label="Summary"> <strong>main (high-level flow)</strong><br><br><strong>Purpose:</strong> Orchestrate CLI flow: parse args, compute <code>src</code> and <code>out</code> paths, obtain a config if possible, and call <code>render_html</code> using the safest signature available.  <br><br><strong>Behavior (detailed):</strong>  <br> 1. <code>args = parse_args(argv or sys.argv[1:])</code> — supports direct <code>argv</code> injection for tests.  <br> 2. <code>src = Path(args.source)</code> and <code>out = Path(args.output)</code>.  <br> 3. <code>cfg = _make_config(out, args.embed_assets)</code>.  <br> 4. If <code>cfg is not None</code>:  <br>     a. First attempt: <code>render_html(str(src), config=cfg)</code> — preferred keyword-call to avoid positional mismatch.  <br>     b. On <code>TypeError</code> (common when <code>render_html</code> expects different args): try <code>render_html(str(src), str(out), config=cfg)</code>.  <br> 5. Else (<code>cfg is None</code>):  <br>     a. Try <code>render_html(str(src), str(out))</code>.  <br>     b. On <code>TypeError</code>, try <code>render_html(str(src))</code>.  <br> 6. Return whatever <code>render_html</code> returns (so caller / tests can inspect value) or allow exceptions to surface for truly unexpected errors.  <br><br><strong>Rationale:</strong> Favor keyword <code>config=</code> to avoid reliance on positional semantics across versions; fallbacks cover common historical signatures. </td></tr><tr><td data-label="Summary"> <strong>Import strategy & compatibility</strong><br><br><strong>Purpose:</strong> Avoid brittle imports and support multiple package layouts.  <br><br><strong>Behavior & details:</strong>  <br> 1. Try <code>from render.core_compat import render_html</code> as preferred (stable compatibility wrapper).  <br> 2. Fallback to <code>from render import render_html</code> if previous import fails.  <br> 3. For <code>RenderConfig</code> attempt: check <code>render.types.RenderConfig</code>, then <code>render.RenderConfig</code>.  <br><br><strong>Why:</strong> Projects may rearrange modules; defensive multi-path imports maximize chance the CLI works without edits.  <br><br><strong>Side-effect handling:</strong> No side effects at import time besides module import — acceptable given CLI context.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Summary"> <strong>Error handling & signals</strong><br><br><strong>Purpose:</strong> Fail clearly but minimally; preserve exit behavior compatible with shell scripts.  <br><br><strong>Behavior & expectations:</strong>  <br> 1. The CLI returns the value returned by <code>render_html</code>.  <br> 2. Unexpected exceptions will bubble up (the <code>if __name__ == &quot;__main__&quot;: raise SystemExit(main())</code> wrapper converts returned integers into exit codes and raises on exceptions).  <br> 3. <code>TypeError</code> on attempted calls is treated as a signature mismatch and is handled with fallbacks rather than considered fatal.  <br><br><strong>Recommendation:</strong> If you need stricter exit codes, wrap <code>main()</code> calls and return numeric codes (<code>0</code> success, non-zero error codes).  <br><br><strong>Testing:</strong> Simulate <code>render_html</code> raising <code>RuntimeError</code>/<code>SystemExit</code> and assert CLI behavior.                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Summary"> <strong>Path handling and validation</strong><br><br><strong>Current behavior:</strong> Uses <code>Path</code> wrappers only; no pre-flight existence checks for <code>src</code> or <code>out</code>.  <br><br><strong>Tradeoffs:</strong>  <br> • Pro: keeps CLI permissive — lets <code>render_html</code> decide how to interpret <code>src</code> (it may accept globs or create <code>out</code>).  <br> • Con: user-friendly early validation (helpful error messages) is absent.  <br><br><strong>Recommendation (optional improvement):</strong> Add an explicit check <code>if not src.exists(): raise SystemExit(f&quot;source not found: {src}&quot;)</code> or print a helpful message and exit with non-zero code.  <br><br><strong>Backward compatibility:</strong> Avoid adding strict checks by default to preserve current minimal behavior.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Summary"> <strong>Testing strategy</strong><br><br><strong>Unit tests (fast, deterministic):</strong>  <br> 1. Test <code>parse_args()</code> with multiple argv permutations.  <br> 2. Mock <code>RenderConfig</code> with varied signatures to validate <code>_make_config</code> fallback paths.  <br> 3. Mock <code>render_html</code> to assert correct call signatures are attempted (use <code>unittest.mock</code> to raise <code>TypeError</code> on first call, then assert fallback invoked).  <br><br><strong>Integration tests (sanity):</strong>  <br> 1. Use a temporary directory for <code>out</code> and a small example <code>src</code> (file & directory variants).  <br> 2. Verify <code>render_html</code> behavior end-to-end using a test <code>render</code> shim returning a known exit code or object.  <br><br><strong>Edge-case tests:</strong> non-existent <code>RenderConfig</code>, <code>render_html</code> that accepts only one arg, and <code>render_html</code> that returns None vs int.                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Summary"> <strong>Security & robustness notes</strong><br><br><strong>Inputs & path safety:</strong>  <br> • <code>src</code> is accepted as-is; if this CLI is used in higher-privilege contexts, consider canonicalizing and validating to avoid surprises.  <br><br><strong>Injection surface:</strong>  <br> • No shell invocation is used; all arguments are passed as strings to Python functions — lower risk of shell injection.  <br><br><strong>Privilege:</strong>  <br> • This CLI performs no privileged writes beyond what <code>render_html</code>/render pipeline does. If embedding into automated tooling, run with least privilege and use isolated output directories.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Summary"> <strong>Usability & UX improvements (practical)</strong><br><br><strong>Short-term:</strong>  <br> 1. Add <code>--verbose</code> or <code>--log-level</code> to control logging from <code>render</code>.  <br> 2. Print a one-line summary on success (e.g., <code>Wrote output to {out}</code>) when invoked as script (but avoid in library <code>main()</code> returns to keep tests clean).  <br><br><strong>Medium-term:</strong>  <br> 1. Add <code>--dry-run</code> to validate inputs & show planned actions without invoking heavy render work.  <br> 2. Add <code>--format json</code> to return machine-readable output (path, status, tables count) when used in pipelines.  <br><br><strong>Backward-compatibility note:</strong> Keep current defaults unchanged; add flags as opt-in.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Summary"> <strong>Instrumentation & diagnostics</strong><br><br><strong>What to add:</strong>  <br> 1. Timing wrapper around <code>render_html</code> to log duration.  <br> 2. Optional <code>--traceback</code> to print full exception trace for debugging (otherwise keep minimal message).  <br> 3. Exit-code normalization: return <code>0</code> on success, <code>&gt;0</code> on error (map exceptions to codes).  <br><br><strong>Why:</strong> Makes CI debugging and observability simpler without changing core behavior.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Summary"> <strong>Developer notes & maintenance</strong><br><br><strong>Key principles to preserve:</strong>  <br> 1. Keep <code>main()</code> idempotent and testable by allowing <code>argv</code> injection.  <br> 2. Prefer keyword <code>config=</code> when possible to avoid brittle positional coupling.  <br> 3. Keep the import fallbacks tolerant — fewer surprises across <code>render</code> package refactors.  <br><br><strong>When to refactor:</strong> If <code>render</code> gains a stable public CLI or a single, documented <code>RenderConfig</code> signature, simplify <code>_make_config</code> and remove legacy fallbacks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Summary"> <strong>Example invocation & expected behavior</strong><br><br><strong>Shell:</strong> <code>./cli.py data/ -o site_out --embed-assets</code>  <br><br><strong>In-process (test):</strong> <code>main([&quot;data/&quot;, &quot;-o&quot;, &quot;tmp_out&quot;])</code> returns whatever <code>render_html</code> returns.  <br><br><strong>Notes:</strong> With a <code>RenderConfig</code> available, the preferred call path uses <code>config=</code> and <code>render_html</code> may ignore <code>out</code>; if no <code>RenderConfig</code>, the <code>str(out)</code> fallback is attempted.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Summary"> <strong>Minimal checklist before merging changes</strong><br><br>1. Add unit tests for all <code>_make_config</code> code paths.  <br>2. Add mocks to assert fallback call order to <code>render_html</code>.  <br>3. Decide whether to add explicit <code>src.exists()</code> validation; if so, add tests that assert non-zero exit on missing input.  <br>4. Add docs to <code>README</code> showing example CLI usage and intended behavior for different <code>render</code> versions.  <br><br><strong>Why checklist:</strong> Ensures compatibility with diverse downstream projects and prevents regressions when <code>render</code> evolves.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr></tbody></table></div><div class="row-count">Rows: 14</div></div><div class="table-caption" id="Table7" data-table="Book_8035_07" style="margin-top:2mm;margin-left:3mm;"><strong>Table 7</strong></div>
<div class="table-wrapper" data-table-id="table-7"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Technical Breakdown**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Technical Breakdown</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>1 — Module purpose & invariants</strong><br> This module is a production-ready converter: it parses pipe-markdown and CSV tables and renders HTML matching Table Viewer v2.1 DOM/CSS expectations.<br> It intentionally emits per-wrapper and per-column alignment metadata for downstream UI behavior.<br> It prefers non-destructive operations (peeking iterables, read-only inspection) so callers using generators/streams are not consumed.<br> The implementation is defensive: pervasive <code>try/except</code> allows graceful fallback when optional project helpers or pandas are absent.                                                                                                     </td></tr><tr><td data-label="Technical Breakdown"> <strong>2 — Regex & test hooks</strong><br> <code>_PRE_RE</code>, <code>_CODE_RE</code>, and <code>_DIVIDER_PART_RE</code> centralize the small-but-critical pattern matching used by multiple helpers.<br> <code>__TEST_MODE</code> lets tests request additional attributes without changing rendering logic.<br> Centralized regex constants reduce duplication and make the module easier to reason about and audit.                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Technical Breakdown"> <strong>3 — Fallback utilities (utils bridge)</strong><br> The module prefers to import project helpers (<code>_strip_tags</code>, <code>sanitize_bold_html</code>, etc.) but provides robust fallbacks when those are missing.<br> Fallbacks preserve important behaviors like preserving inline code, escaping unmatched pipe markers, and conservative bold-preservation logic.<br> This design keeps the converter embedded-friendly: it works stand-alone or integrated with a larger codebase.                                                                                                                                                                                                                         </td></tr><tr><td data-label="Technical Breakdown"> <strong>4 — _unescape_brackets_outside_code</strong><br> Receives HTML-like strings and only unescapes <code>\[</code>/<code>\]</code> occurrences outside <code>&lt;pre&gt;</code>/<code>&lt;code&gt;</code> fragments.<br> It splits by those code blocks and resumes safe replacement on the non-code fragments to avoid corrupting literal code.<br> Errors are logged and the original string is returned on failure, preserving caller safety.                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Technical Breakdown"> <strong>5 — Non-destructive peek & stream helpers</strong><br> <code>_peek_rows_non_destructive</code> uses <code>itertools.tee</code> when possible to peek <code>n</code> rows without consuming the original iterator.<br> <code>_take_and_stream</code> chooses an optimized path for sequence-like inputs (list-like with <code>__len__</code>/<code>__getitem__</code>) and falls back to peek for general iterables.<br> Both functions return a small sample buffer plus an iterator usable for full-stream rendering, enabling heuristics (alignment detection, type detection) without losing data.                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>6 — Column type detection</strong><br> <code>_detect_column_types</code> inspects a sample of rows and labels each column as <code>&quot;numeric&quot;</code> or <code>&quot;text&quot;</code>.<br> Logic tolerates <code>None</code>, empty strings, percent signs, thousand separators and parentheses (treated as negatives).<br> If a column contains no non-empty values, it defaults to <code>&quot;text&quot;</code>, avoiding false numeric alignment.                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical Breakdown"> <strong>7 — Data-label cleaning</strong><br> <code>_clean_label_for_datalabel</code> strips HTML and noisy markdown markers from column labels and condenses whitespace.<br> The returned string is safe for use in <code>data-label</code> attributes and screen-reader contexts.                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Technical Breakdown"> <strong>8 — CSV heuristics & parsing</strong><br> <code>_looks_like_csv</code> uses conservative heuristics (line counts, absence of pipes, delimiter-consistency scoring) to avoid misclassifying pipe tables as CSV.<br> <code>parse_csv_tables</code> performs robust pre-processing: normalizes newlines, strips BOM, unescapes HTML entities, preserves NBSP as space, and samples input for <code>csv.Sniffer</code>.<br> It contains layered fallbacks: <code>csv.Sniffer</code> → delimiter-count voting → naive split, which guarantees a result even for messy inputs.<br> Header inference attempts <code>sniffer.has_header</code> first, then falls back to simple numeric/non-numeric heuristics across the first few rows.                     </td></tr><tr><td data-label="Technical Breakdown"> <strong>9 — Markdown pipe-table parser</strong><br> <code>parse_markdown_tables</code> normalizes line endings and preserves zero-width characters to maintain user intent.<br> <code>_split_row_keep_code</code> is code-point-aware for inline backticks and honors escaped pipes <code>\|</code>, so code spans and escaped delimiters do not split cells.<br> <code>_is_divider_line</code> strictly validates divider rows using <code>_DIVIDER_PART_RE</code> so only genuine Markdown tables are accepted.<br> The parser produces normalized rectangular rows (padding shorter rows with empty strings) and marks results with <code>&quot;pipe_markdown&quot;</code> source.                                                                                              </td></tr><tr><td data-label="Technical Breakdown"> <strong>10 — Simple DataFrame shim (<code>_SimpleDF</code>, <code>_SimpleColumns</code>)</strong><br> Lightweight shim provides the minimal DataFrame interface the renderer expects (<code>columns</code>, <code>itertuples</code>, iteration, <code>__len__</code>).<br> This keeps the renderer usable when pandas is not available and simplifies testing.<br> The shim is intentionally minimal — it does not attempt to fully emulate pandas semantics, but it exposes just enough for rendering.                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical Breakdown"> <strong>11 — Debug extraction pipeline (<code>extract_tables_debug</code>)</strong><br> A forensic helper that extracts candidate pipe tables and HTML <code>&lt;table&gt;</code> blocks for diagnostics and tooling.<br> It performs typographic normalizations (curly quotes → straight, dashes → hyphen, ellipses → <code>...</code>) to improve robust detection on pasted content.<br> The function attempts to return <code>pandas.DataFrame</code> objects when pandas is available, otherwise <code>_SimpleDF</code> instances; it also preserves detected column alignments when present.<br> It includes a CSV fallback: if no pipe tables are found and the text looks like CSV, parsed CSV tables are returned — useful for debugging ambiguous inputs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>12 — Markdown renderer selection</strong><br> <code>_get_default_markdown_renderer</code> prefers a project-provided markdown bridge, but falls back to a safe inline renderer.<br> The fallback focuses on preserving inline code and basic emphasis while escaping dangerous input and avoiding heavy block-level markdown processing unless explicitly present.<br> This keeps cell rendering predictable in minimal environments.                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical Breakdown"> <strong>13 — render_table overview (purpose & API)</strong><br> <code>render_table</code> is the central alignment-aware renderer that produces the TV2.1-compatible HTML wrapper and table DOM.<br> It accepts dataframe-like inputs or iterables and allows callers to pass a <code>markdown_to_html_func</code> to control inline rendering.<br> It emits wrapper-level attributes (<code>data-table-id</code>, <code>data-table-alignments</code>) and, in test mode, <code>data-test-alignments</code> for easier testing and parity validation.                                                                                                                                                                                                         </td></tr><tr><td data-label="Technical Breakdown"> <strong>14 — Column discovery & iterator handling</strong><br> The renderer first attempts to extract <code>cols</code> from <code>df.columns</code>; if that fails it peeks the first row of an iterator to infer columns from dict keys or list length.<br> If the input is truly empty or unrecognizable, the renderer emits a diagnostic HTML block that explains the likely cause to the end user instead of failing.<br> This multi-tier discovery makes the function resilient to a wide variety of input shapes (pandas, list-of-dicts, list-of-lists, generator).                                                                                                                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>15 — Sampling and alignment inference</strong><br> The renderer uses <code>_take_and_stream(..., 5)</code> to obtain a small sample for type detection without consuming the full iterator.<br> Alignments are resolved from multiple places in order of trust: <code>df._table_alignments</code> → <code>df.alignments</code> → <code>tbl</code> debug metadata → <code>_detect_column_types</code> on the sample.<br> If detection yields fewer alignments than columns, left alignment is appended as a conservative default.                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical Breakdown"> <strong>16 — Header rendering and <code>data-label</code> generation</strong><br> Column header HTML is produced via the markdown renderer when available and then lightly normalized: outer <code>&lt;p&gt;</code> are stripped and repeated whitespace collapsed while preserving zero-width characters and inline tags.<br> <code>td_labels</code> are produced by <code>_clean_label_for_datalabel</code> and HTML-escaped for safe use in <code>data-label</code> attributes, enabling mobile-friendly label display.                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical Breakdown"> <strong>17 — Layout defaults & accessibility</strong><br> Left/right widths default to the 2:5 unit split used historically (calculated to percentages).<br> The produced markup includes ARIA hints on headers (e.g., <code>aria-sort</code>) and descriptive <code>aria-label</code> on the heading bar for screen readers.<br> The header includes interactive controls (copy/export toggles) with semantic <code>aria-label</code>s for assistive tech.                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Technical Breakdown"> <strong>18 — Row rendering & per-cell pipeline</strong><br> Rows are iterated safely with support for namedtuple <code>_asdict</code>, dicts (mapping cols→values), sequences, and scalar rows.<br> Each cell goes through a meticulous pipeline: preserve single-line markdown line-break semantics (convert single <code>\n</code> → two spaces + <code>\n</code> unless inside code/fenced blocks), render markdown, unescape brackets outside code, strip undesirable leading <code>&lt;br&gt;</code>, sanitize bold HTML, optionally apply left-column heading transform, and escape unmatched markers.<br> The pipeline is defensive: every transformation is <code>try/except</code> wrapped so a single failing cell does not abort table rendering.        </td></tr><tr><td data-label="Technical Breakdown"> <strong>19 — Cell newline preservation (TV2.1 parity)</strong><br> The renderer preserves single newlines by converting them to markdown soft-breaks (two spaces + newline) only when not inside fenced code/pre blocks.<br> This behavior matches Table Viewer v2.1 expectations where single-line breaks render as <code>&lt;br&gt;</code> without collapsing paragraphs.<br> The conversion is guarded by a regex to avoid touching code fences, minimizing accidental mutations.                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Technical Breakdown"> <strong>20 — Alignment attributes & CSS hooks</strong><br> Each <code>&lt;th&gt;</code> gets <code>data-align</code> and a <code>th-align-{ali}</code> class; each <code>&lt;td&gt;</code> gets <code>data-align</code> and an <code>align-{ali}</code> class.<br> The wrapper carries <code>data-table-alignments</code> as a comma-separated CSV for runtime scripts to read alignment metadata at once.<br> Test-mode exposes the same CSV on a <code>data-test-alignments</code> attribute for deterministic tests.                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Technical Breakdown"> <strong>21 — Row-counting, empty-state & diagnostics</strong><br> The renderer counts rows while writing the body and emits an accessible <code>row-count</code> indicator after the table.<br> If zero rows are produced, a clear diagnostic hint is injected explaining likely causes and providing quick checks for the user (e.g., missing header/divider in markdown).<br> This improves UX for pasted content that looks like tables but fails the strict parser.                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Technical Breakdown"> <strong>22 — convert_structure (single-table conversion helper)</strong><br> <code>convert_structure</code> is a convenience function that returns HTML for the first detected markdown pipe table and metadata describing conversion success.<br> It uses <code>parse_markdown_tables</code> then builds a <code>_SimpleDF</code> (or equivalent) and calls <code>render_table</code> with the given markdown renderer helper.<br> Return metadata includes the number of columns and tables found and records conversion warnings when exceptions occur.                                                                                                                                                                                         </td></tr><tr><td data-label="Technical Breakdown"> <strong>23 — convert_text_to_html (multi-table rendering)</strong><br> <code>convert_text_to_html</code> detects all markdown pipe tables and renders each in sequence, returning concatenated HTML and metadata about how many tables were converted.<br> It carries debug alignment arrays from parsed table dicts into the <code>_SimpleDF</code> objects so column alignment hints travel from detection to rendering.<br> When no tables are found the function falls back to rendering the full text as markdown (or as escaped <code>&lt;pre&gt;</code> on failure).                                                                                                                                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>24 — extract_tables_debug vs runtime parsing</strong><br> <code>extract_tables_debug</code> is more permissive and diagnostic, collecting candidate blocks and returning DataFrame or shim objects for tooling.<br> <code>parse_markdown_tables</code> is conservative and used by runtime conversion functions to avoid false positives.<br> The separation keeps production behavior deterministic while enabling richer developer diagnostics when needed.                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Technical Breakdown"> <strong>25 — Error handling and logging strategy</strong><br> The module uses <code>logger.exception</code> liberally to record stack traces while returning safe defaults to callers.<br> Most API surfaces swallow exceptions and return raw input or minimal metadata so the hosting application can continue.<br> This makes the converter resilient in server contexts where a single bad paste must not crash the service.                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Technical Breakdown"> <strong>26 — Pandas integration & graceful degradation</strong><br> Where pandas is available the module will build <code>pd.DataFrame</code> objects and attempt to attach <code>_table_alignments</code>.<br> When pandas is missing or DataFrame construction fails, <code>_SimpleDF</code> ensures functionality remains intact.<br> This design lets heavier deployments benefit from pandas ergonomics while small or sandboxed deployments keep working.                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Technical Breakdown"> <strong>27 — Public API and exports</strong><br> The module explicitly exports the core helpers and renderers (<code>parse_markdown_tables</code>, <code>parse_csv_tables</code>, <code>render_table</code>, <code>extract_tables_debug</code>, <code>_SimpleDF</code>, <code>_SimpleColumns</code>, <code>convert_structure</code>, <code>convert_text_to_html</code>) to support both programmatic and CLI usage.<br> The stable <code>__all__</code> makes it safe for other modules to import these names with predictable semantics.                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical Breakdown"> <strong>28 — Performance & operational notes</strong><br> The module minimizes full materialization of large iterables by peeking small samples and then streaming the iterator for output.<br> Heavy operations (markdown rendering per-cell, HTML unescape, regexes) are applied only when necessary and are guarded so failure on a single cell doesn't cascade.<br> For very large tables callers should supply an optimized <code>markdown_to_html_func</code> and consider precomputing alignments to avoid repeated heuristics.                                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>29 — Security & sanitization considerations</strong><br> The code uses <code>html.escape</code> where fallback rendering is needed and sanitizes bold/inline HTML with <code>sanitize_bold_html</code> where available.<br> It does not attempt full sanitization of arbitrary HTML in cells — callers should sanitize untrusted content earlier in the pipeline if XSS risk exists.<br> The module’s objective is faithful table rendering and parity; hardening for hostile input is intentionally left to embedding applications or centralized sanitizer utilities.                                                                                                                                              </td></tr><tr><td data-label="Technical Breakdown"> <strong>30 — Testing hooks & determinism</strong><br> <code>__TEST_MODE</code> and <code>test_mode</code> parameters enable emitting additional attributes useful for unit tests and snapshot comparisons.<br> The render output is designed to be stable across runs for the same inputs (given the same markdown renderer), which aids golden-file tests.                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Technical Breakdown"> <strong>31 — Extensibility & integration points</strong><br> The module is written to accept a pluggable markdown renderer, custom column alignment metadata on inputs, and optional pandas usage, enabling deep integration with richer pipelines.<br> Developers can override behavior by supplying <code>markdown_to_html_func</code>, setting <code>df._table_alignments</code>, or pre-normalizing inputs with their own preprocessors.                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical Breakdown"> <strong>32 — Summary of developer experience</strong><br> The code balances strict parsing (avoids false-positive table detection) with pragmatic fallbacks (CSV sniffing, shim DF) so it runs reliably in varied environments.<br> It favors predictable, testable HTML output that preserves TV2.1 contract details (alignment metadata, ARIA, header controls).<br> Observability and diagnostics are first-class: logging, <code>extract_tables_debug</code>, and test-mode hooks simplify debugging real-world pasted content.                                                                                                                                                                               </td></tr></tbody></table></div><div class="row-count">Rows: 32</div></div><div class="table-caption" id="Table8" data-table="Book_8035_08" style="margin-top:2mm;margin-left:3mm;"><strong>Table 8</strong></div>
<div class="table-wrapper" data-table-id="table-8"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Section / Topic**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Section / Topic</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Details / Explanation**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Details / Explanation</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Section / Topic"> <strong>Summary / Purpose</strong>              </td><td data-label="Details / Explanation"> Provide a complete, safe, production-ready pipeline for <code>main.py</code>. Handles project initialization, configuration parsing, CLI arguments, logging setup, temporary directories, and orchestrates rendering workflows. Ensures deterministic, recoverable behavior with minimal side effects. </td></tr><tr><td data-label="Section / Topic"> <strong>High-Level Guarantees</strong>          </td><td data-label="Details / Explanation"> • Deterministic order of execution.<br>• Non-destructive to source files.<br>• CLI errors reported without crashing.<br>• Logging is centralized and configurable.<br>• Temporary and output directories managed safely.                                                                    </td></tr><tr><td data-label="Section / Topic"> <strong>Entry Point</strong>                    </td><td data-label="Details / Explanation"> <code>if __name__ == &quot;__main__&quot;:</code> ensures script is executable as standalone or importable module. Centralized orchestration occurs here.                                                                                                                                                        </td></tr><tr><td data-label="Section / Topic"> <strong>Argument Parsing</strong>               </td><td data-label="Details / Explanation"> Uses <code>argparse</code> for CLI arguments: <code>--config</code>, <code>--output</code>, <code>--verbose</code>, <code>--dry-run</code>, <code>--log-level</code>. Provides type checking, defaults, and help text.                                                                                                                                        </td></tr><tr><td data-label="Section / Topic"> <strong>Configuration Loader</strong>           </td><td data-label="Details / Explanation"> Reads configuration file (<code>YAML</code>/<code>JSON</code>), validates keys, applies defaults. Merges CLI overrides into configuration object. Ensures required keys exist: <code>assets_dir</code>, <code>out_dir</code>, <code>fingerprint_assets</code>, <code>generate_manifest</code>.                                                                </td></tr><tr><td data-label="Section / Topic"> <strong>Logging Setup</strong>                  </td><td data-label="Details / Explanation"> Configures Python <code>logging</code> module:<br>• Console handler with <code>INFO</code>/<code>DEBUG</code> based on CLI.<br>• Optional file handler.<br>• Timestamped format, module name, level.<br>• Ensures log propagation controlled for clarity.                                                                    </td></tr><tr><td data-label="Section / Topic"> <strong>Temporary Directory Management</strong> </td><td data-label="Details / Explanation"> Creates temp working directories using <code>tempfile.TemporaryDirectory()</code> for ephemeral processing. Ensures cleanup even on exceptions using context managers.                                                                                                                                 </td></tr><tr><td data-label="Section / Topic"> <strong>Assets Preparation</strong>             </td><td data-label="Details / Explanation"> Invokes <code>prepare_assets(cfg, out_dir)</code>:<br>• Resolves candidate <code>assets/</code> dirs.<br>• Applies fingerprinting, manifest, placeholders.<br>• Ensures atomic writes.<br>• Returns tuple <code>(assets_dir, style_fallback, script_fallback, assets_written)</code>.                                        </td></tr><tr><td data-label="Section / Topic"> <strong>Renderer Initialization</strong>        </td><td data-label="Details / Explanation"> Initializes renderers (<code>HTMLRenderer</code>, <code>MarkdownRenderer</code>) with:<br>• Safe CSS/JS paths.<br>• Inline fallbacks if assets missing.<br>• Sanitization flags.<br>• Optional KaTeX/math support.                                                                                                </td></tr><tr><td data-label="Section / Topic"> <strong>Input Data Handling</strong>            </td><td data-label="Details / Explanation"> Accepts input file paths (Markdown, CSV, HTML). Validates existence, encoding (UTF-8), and type.<br>Supports multi-file batch mode.                                                                                                                                                         </td></tr><tr><td data-label="Section / Topic"> <strong>Table Extraction / Conversion</strong>  </td><td data-label="Details / Explanation"> For each input:<br>• Detect tables or blocks.<br>• Apply <code>convert.render_table</code> or project-specific <code>core_table.render_table</code>.<br>• Normalizes multi-line cells, preserves code/math diagrams, escapes unsafe HTML after processing lists.                                                  </td></tr><tr><td data-label="Section / Topic"> <strong>List & Markdown Handling</strong>       </td><td data-label="Details / Explanation"> Detects ordered lists (<code>^\s*\d+\.</code>) and converts to <code>&lt;ol&gt;&lt;li&gt;</code> blocks.<br>Preserves nested <code>&lt;ul&gt;/&lt;ol&gt;</code>.<br>Escapes content after list detection to avoid sanitizer conflicts.                                                                                                               </td></tr><tr><td data-label="Section / Topic"> <strong>Sanitization</strong>                   </td><td data-label="Details / Explanation"> Runs post-render sanitizer:<br>• Strips scripts, event handlers (<code>on*</code>).<br>• Keeps <code>&lt;pre&gt;</code>, <code>&lt;code&gt;</code>, <code>&lt;ol&gt;</code>, <code>&lt;ul&gt;</code>, <code>&lt;li&gt;</code>, <code>&lt;strong&gt;</code>, <code>&lt;em&gt;</code>.<br>• Optional <code>allow_rich_media</code> gate.                                                                                                   </td></tr><tr><td data-label="Section / Topic"> <strong>HTML Assembly</strong>                  </td><td data-label="Details / Explanation"> Combines <code>&lt;head&gt;</code>, <code>&lt;style&gt;</code>, <code>&lt;body&gt;</code>, <code>&lt;script&gt;</code> into final HTML page.<br>• Embeds placeholders if assets missing.<br>• Ensures <code>&lt;link&gt;</code> and <code>&lt;script&gt;</code> tags include SRI when fingerprinted.                                                                                              </td></tr><tr><td data-label="Section / Topic"> <strong>Export / Save</strong>                  </td><td data-label="Details / Explanation"> Writes output to <code>cfg.out_dir</code>:<br>• HTML files named consistently.<br>• Atomic writes using dispatcher (<code>_atomic_write_dispatch</code>).<br>• Generates diagnostic <code>assets-info.json</code>.<br>• Logs summary of files written.                                                                       </td></tr><tr><td data-label="Section / Topic"> <strong>Dry-Run Mode</strong>                   </td><td data-label="Details / Explanation"> If <code>--dry-run</code> enabled:<br>• No disk writes occur.<br>• Prints planned operations.<br>• Validates configuration and asset resolution.                                                                                                                                                       </td></tr><tr><td data-label="Section / Topic"> <strong>Error Handling</strong>                 </td><td data-label="Details / Explanation"> All steps wrapped in try/except:<br>• Non-fatal errors logged at <code>DEBUG</code> or <code>INFO</code>.<br>• Critical failures fallback to safe defaults.<br>• Ensures temp directories and placeholders are always left in consistent state.                                                                   </td></tr><tr><td data-label="Section / Topic"> <strong>Exit Codes</strong>                     </td><td data-label="Details / Explanation"> Standardized exit codes:<br>• <code>0</code> = success.<br>• <code>1</code> = CLI/config errors.<br>• <code>2</code> = file processing errors.<br>• Ensures deterministic scripting behavior.                                                                                                                                </td></tr><tr><td data-label="Section / Topic"> <strong>Unit Test Hooks</strong>                </td><td data-label="Details / Explanation"> Exposes testable functions:<br>• <code>parse_config</code>, <code>prepare_assets</code>, <code>render_table</code>, <code>resolve_asset_name</code>.<br>• Facilitates CI pipeline integration.                                                                                                                                          </td></tr><tr><td data-label="Section / Topic"> <strong>Performance Considerations</strong>     </td><td data-label="Details / Explanation"> • Stream large files to avoid memory spikes.<br>• Avoid redundant asset copying using fingerprint checks.<br>• Skip unnecessary render passes if output unchanged.<br>• Batch processing optimized for multiple tables or chapters.                                                         </td></tr><tr><td data-label="Section / Topic"> <strong>Security / Integrity</strong>           </td><td data-label="Details / Explanation"> • Sanitizes input to prevent XSS.<br>• Uses SRI for fingerprinted assets.<br>• Inline fallbacks maintain integrity when assets unavailable.<br>• Avoids absolute paths in manifest.                                                                                                         </td></tr><tr><td data-label="Section / Topic"> <strong>Operational Notes</strong>              </td><td data-label="Details / Explanation"> • Supports project-provided hooks for <code>copy_assets</code> and <code>write_overrides_css</code>.<br>• Configurable fingerprinting, manifest generation, max asset size.<br>• Safe defaults ensure reproducibility across environments.                                                                        </td></tr><tr><td data-label="Section / Topic"> <strong>Demo / CLI Safety</strong>              </td><td data-label="Details / Explanation"> <code>_demo_run(temp_out)</code> provides reproducible test harness:<br>• Runs main workflow in isolated temp dir.<br>• Prints diagnostics without touching repo assets.<br>• Safe for CI/CD validation.                                                                                               </td></tr><tr><td data-label="Section / Topic"> <strong>Fallback & Recovery Matrix</strong>     </td><td data-label="Details / Explanation"> • Missing project <code>.assets</code> → copies from candidates.<br>• Missing tables or input files → logs and continues.<br>• Atomic write/copy errors → fallback ensures placeholders remain.<br>• Manifest generation failure → logs only, does not block output.                                   </td></tr><tr><td data-label="Section / Topic"> <strong>Reviewer Checklist (pre-merge)</strong> </td><td data-label="Details / Explanation"> 1. Confirm logging propagation and levels.<br>2. Validate atomic write/copy dispatchers.<br>3. Ensure temp directories cleaned up reliably.<br>4. Verify asset fingerprinting and SRI integrity.<br>5. Test dry-run mode.<br>6. Ensure large file streaming works.                          </td></tr><tr><td data-label="Section / Topic"> <strong>Minimal Unit Tests</strong>             </td><td data-label="Details / Explanation"> • Config parsing with valid and invalid inputs.<br>• Asset preparation with/without project hooks.<br>• Table rendering preserves code/math blocks.<br>• Sanitization strips unsafe HTML but keeps allowed tags.<br>• Fingerprinted assets correctly resolved by <code>resolve_asset_name</code>.      </td></tr><tr><td data-label="Section / Topic"> <strong>Advanced Error Handling</strong>      </td><td data-label="Details / Explanation"> • Wraps each processing stage in fine-grained try/except.<br>• Logs traceback on <code>DEBUG</code> level, user-friendly summary on <code>INFO</code>.<br>• Ensures temp directories and placeholders remain consistent even on exceptions.<br>• Uses context managers to enforce cleanup.                                           </td></tr><tr><td data-label="Section / Topic"> <strong>Input Validation</strong>             </td><td data-label="Details / Explanation"> • Checks file paths exist and readable.<br>• Verifies file types (Markdown, CSV, HTML).<br>• Validates configuration keys and types.<br>• Applies default values for missing optional keys.                                                                                                                    </td></tr><tr><td data-label="Section / Topic"> <strong>Configuration Merging</strong>        </td><td data-label="Details / Explanation"> • Merges CLI arguments into config file values.<br>• Overrides defaults only when explicitly passed.<br>• Preserves backward compatibility with legacy config formats.                                                                                                                                         </td></tr><tr><td data-label="Section / Topic"> <strong>Asset Fallback Policy</strong>        </td><td data-label="Details / Explanation"> • Uses embedded CSS/JS fallbacks if physical assets missing.<br>• Ensures <code>style.css</code>, <code>script.js</code>, <code>worker.js</code>, <code>overrides.css</code> always ≥10 bytes.<br>• Supports fingerprinting when enabled.                                                                                                                  </td></tr><tr><td data-label="Section / Topic"> <strong>Logging Best Practices</strong>       </td><td data-label="Details / Explanation"> • Central logger avoids duplicate entries.<br>• Configurable log levels per CLI or config.<br>• Consistent format for timestamps, module names, levels.<br>• Debug logs include resolved paths, asset fingerprints, and temporary directories.                                                                 </td></tr><tr><td data-label="Section / Topic"> <strong>Atomic File Operations</strong>       </td><td data-label="Details / Explanation"> • Uses <code>_atomic_write_dispatch</code> and <code>_atomic_copy_dispatch</code>.<br>• Fallbacks with <code>NamedTemporaryFile</code> and <code>os.replace</code> ensure atomicity.<br>• Prevents zero-byte or partially written files.<br>• Handles permission errors gracefully.                                                                        </td></tr><tr><td data-label="Section / Topic"> <strong>Renderer Configuration</strong>       </td><td data-label="Details / Explanation"> • HTML renderer initialized with asset paths and fallbacks.<br>• Markdown renderer handles fenced code blocks, math, diagrams.<br>• Sanitizers configured post-render, preserves <code>&lt;ol&gt;</code>, <code>&lt;ul&gt;</code>, <code>&lt;li&gt;</code>, <code>&lt;pre&gt;</code>, <code>&lt;code&gt;</code>.<br>• Optional rich media gate via <code>allow_rich_media</code>.                              </td></tr><tr><td data-label="Section / Topic"> <strong>Table Normalization</strong>          </td><td data-label="Details / Explanation"> • <code>_coalesce_multiline_rows(df)</code> merges rows with single non-empty cells.<br>• Ordered lists detected via <code>^\s*\d+\.</code> regex.<br>• Escaping applied after list detection.<br>• Preserves inline code, fenced code, diagrams, LaTeX/KaTeX.                                                                       </td></tr><tr><td data-label="Section / Topic"> <strong>Sanitization Rules</strong>           </td><td data-label="Details / Explanation"> • Strips <code>&lt;script&gt;</code> and all <code>on*</code> attributes.<br>• Preserves safe tags: <code>&lt;pre&gt;</code>, <code>&lt;code&gt;</code>, <code>&lt;strong&gt;</code>, <code>&lt;em&gt;</code>, <code>&lt;ol&gt;</code>, <code>&lt;ul&gt;</code>, <code>&lt;li&gt;</code>.<br>• Optional allowlist for rich media or SVGs.                                                                                                                         </td></tr><tr><td data-label="Section / Topic"> <strong>HTML Assembly Workflow</strong>       </td><td data-label="Details / Explanation"> • Head section includes <code>&lt;meta&gt;</code> and optional CSS <code>&lt;link&gt;</code> tags.<br>• Inline fallbacks included if assets missing.<br>• Body section constructed with sanitized tables and blocks.<br>• Script tags appended at end with optional SRI attributes.                                                              </td></tr><tr><td data-label="Section / Topic"> <strong>Dry-Run Behavior</strong>             </td><td data-label="Details / Explanation"> • Logs intended file writes without performing them.<br>• Checks asset existence, fingerprint computation, and manifest creation.<br>• Helps validate CI/CD pipelines safely.                                                                                                                                  </td></tr><tr><td data-label="Section / Topic"> <strong>Temporary File Management</strong>    </td><td data-label="Details / Explanation"> • Uses context managers for automatic deletion.<br>• Temp dirs isolated per run to avoid conflicts.<br>• Ensures cross-platform compatibility (Windows, Linux, macOS).                                                                                                                                         </td></tr><tr><td data-label="Section / Topic"> <strong>Fingerprinting & SRI</strong>         </td><td data-label="Details / Explanation"> • Computes SHA256 or SHA384 as configured.<br>• Inserts hash into filename before extension: <code>file.&lt;hash&gt;.js</code>.<br>• Updates manifest mapping logical → fingerprinted name.<br>• Optional, enabled via <code>cfg.fingerprint_assets</code>.                                                                                </td></tr><tr><td data-label="Section / Topic"> <strong>Manifest Generation</strong>          </td><td data-label="Details / Explanation"> • Produces <code>assets-manifest.json</code> with <code>{generated, files, mapping}</code>.<br>• Stores size, mtime, and SRI per file.<br>• Optional logical mapping for fingerprinted assets.<br>• Errors logged; generation failure does not block main workflow.                                                                  </td></tr><tr><td data-label="Section / Topic"> <strong>Assets Diagnostic</strong>            </td><td data-label="Details / Explanation"> • <code>assets-info.json</code> written always.<br>• Contains file names, sizes, mtimes, <code>assets_written</code> flag.<br>• Lightweight, intended for debugging.                                                                                                                                                                 </td></tr><tr><td data-label="Section / Topic"> <strong>File Output Policy</strong>           </td><td data-label="Details / Explanation"> • Ensures all required files ≥10 bytes.<br>• Avoid overwriting existing ≥10-byte files unless forced.<br>• Atomic writes for safety.<br>• Supports multi-file output with consistent naming.                                                                                                                   </td></tr><tr><td data-label="Section / Topic"> <strong>Performance Optimization</strong>     </td><td data-label="Details / Explanation"> • Streams large files to avoid memory spikes.<br>• Avoids redundant asset copying via fingerprint checks.<br>• Batches input processing to minimize repeated renderer initialization.<br>• Supports multi-threaded reading if needed.                                                                          </td></tr><tr><td data-label="Section / Topic"> <strong>Security & Integrity</strong>         </td><td data-label="Details / Explanation"> • Sanitization prevents XSS.<br>• SRI ensures fingerprinted assets integrity.<br>• Inline fallbacks maintain safety if assets unavailable.<br>• Manifest paths relative, no absolute exposure.                                                                                                                 </td></tr><tr><td data-label="Section / Topic"> <strong>Operational Recommendations</strong>  </td><td data-label="Details / Explanation"> 1. Enable <code>generate_manifest</code> in production.<br>2. Use fingerprinting for cache-busting.<br>3. Keep <code>max_asset_copy_size</code> reasonable.<br>4. CI validation with <code>_demo_run</code> to prevent side effects.<br>5. Validate logs for anomalies.                                                                         </td></tr><tr><td data-label="Section / Topic"> <strong>Demo & CI Integration</strong>        </td><td data-label="Details / Explanation"> • <code>_demo_run(temp_out)</code> tests workflow in isolated temp dir.<br>• Prints assets written, manifest contents, HTML preview info.<br>• Ensures safe evaluation in automated pipelines.                                                                                                                            </td></tr><tr><td data-label="Section / Topic"> <strong>Edge Cases & Recovery Matrix</strong> </td><td data-label="Details / Explanation"> • Missing project assets → fallback copy from candidates.<br>• Missing input files → logs error, continues.<br>• Partial writes → temp file cleanup ensures no corrupted outputs.<br>• Manifest failure → logged only, does not stop output generation.<br>• Invalid configuration → exits with proper code.   </td></tr><tr><td data-label="Section / Topic"> <strong>Reviewer Checklist</strong>           </td><td data-label="Details / Explanation"> 1. Validate logging setup and propagation.<br>2. Ensure temp directories reliably cleaned.<br>3. Confirm asset fingerprinting & SRI correctness.<br>4. Test dry-run mode functionality.<br>5. Review atomic write/copy dispatchers.<br>6. Confirm sanitization preserves allowed tags.                         </td></tr><tr><td data-label="Section / Topic"> <strong>Unit Tests Recommendations</strong>   </td><td data-label="Details / Explanation"> • Config parsing (valid/invalid).<br>• Asset preparation with/without project hooks.<br>• Table rendering preserves code/math.<br>• Sanitization strips unsafe content.<br>• Fingerprinted assets resolved via manifest.<br>• Dry-run verifies intended operations without file writes.                        </td></tr><tr><td data-label="Section / Topic"> <strong>Performance Notes</strong>            </td><td data-label="Details / Explanation"> • Streaming large tables avoids memory spikes.<br>• Skip asset copying if fingerprint unchanged.<br>• Batch renderer initialization reduces overhead.<br>• Temp directory reuse per run reduces overhead.                                                                                                      </td></tr><tr><td data-label="Section / Topic"> <strong>Fallback & Recovery Logic</strong>    </td><td data-label="Details / Explanation"> • Uses embedded CSS/JS placeholders if assets missing.<br>• Atomic write fallbacks prevent partial outputs.<br>• Logs non-fatal errors and continues pipeline.<br>• Ensures deterministic exit codes per scenario.                                                                                             </td></tr><tr><td data-label="Section / Topic"> <strong>Security Observations</strong>        </td><td data-label="Details / Explanation"> • XSS prevention via sanitization.<br>• SRI provides integrity verification.<br>• Inline fallbacks allow safe rendering even when assets missing.<br>• No absolute paths in manifest; relative only.                                                                                                           </td></tr><tr><td data-label="Section / Topic"> <strong>Decision Points</strong>              </td><td data-label="Details / Explanation"> • Prefer project hooks (<code>copy_assets</code>, <code>write_overrides_css</code>) for custom behavior.<br>• Enable fingerprinting for cache control.<br>• Enable manifest generation for asset mapping.<br>• Validate <code>max_asset_copy_size</code> for large bundles.<br>• Use <code>_demo_run</code> in CI for reproducible testing.                </td></tr><tr><td data-label="Section / Topic"> <strong>Short Summary</strong>                </td><td data-label="Details / Explanation"> <code>main.py</code> orchestrates project asset preparation, configuration, rendering, sanitization, and output generation. It ensures atomic writes, fingerprinting, SRI, safe defaults, fallback mechanisms, logging, and robust error handling. Designed for safe production execution and repeatable CI/CD workflows. </td></tr></tbody></table></div><div class="row-count">Rows: 54</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>