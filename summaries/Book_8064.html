<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1762008375">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Book_8064_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Issue**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Issue</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Description**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Description</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Recommendation/Fix**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Recommendation/Fix</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Issue"> <strong>Double-convert risk (high)</strong>                                           </td><td data-label="Description"> Core installs a document-level delegation that calls <code>__tv_convert_click_ev</code>, which can trigger the same handler twice due to another direct click handler in <code>script.table</code>. </td><td data-label="Recommendation/Fix"> <strong>Fix</strong>: Use one attach method. Remove the direct <code>convertBtn</code> handler in <code>script.table</code> and let <code>script.core</code> handle delegation.<br><strong>Quick Guard</strong>: Add a check at the start of <code>__tv_convert_click_ev</code> to prevent re-entry: <code>if (ev &amp;&amp; ev.__tv_convert_handled) return; if (ev) ev.__tv_convert_handled = true;</code><br><strong>Alternative Guard</strong>: Check <code>btn.dataset.__tv_convert_attached</code> to avoid calling <code>existingHandler</code> when true. </td></tr><tr><td data-label="Issue"> <strong>exportAllBtnHandler overlap (medium)</strong>                                 </td><td data-label="Description"> <code>script.core</code> defines a placeholder for <code>exportAllBtnHandler</code>, while <code>script.table</code> provides a full implementation, leading to ordering ambiguity.                            </td><td data-label="Recommendation/Fix"> <strong>Recommendation</strong>: Explicitly set <code>window.exportAllBtnHandler = exportAllBtnHandler;</code> in the table script or let core not define a placeholder.                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Issue"> <strong>convert attachment flags and dataset keys (medium)</strong>                   </td><td data-label="Description"> Both scripts try to set <code>dataset.__tv_convert_attached</code>, causing potential issues when load order varies.                                                                     </td><td data-label="Recommendation/Fix"> <strong>Recommendation</strong>: Coordinate which script is authoritative for attaching, keeping dataset checks but resolving which script handles the attachment.                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Issue"> <strong>Duplicate helpers in separate IIFEs (low / informational)</strong>            </td><td data-label="Description"> Functions like <code>safe</code>, <code>isString</code>, <code>debounce</code>, etc., are defined in both <code>script.core</code> and <code>script.table</code> inside local IIFEs.                                                 </td><td data-label="Recommendation/Fix"> <strong>Recommendation</strong>: Centralize common helpers in <code>script.core</code> and have <code>script.table</code> call <code>window.__tv_utils</code> versions to ensure consistency.                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Issue"> <strong>Two normalizeForSearchLocal implementations (low)</strong>                    </td><td data-label="Description"> Slight implementation differences may cause search/highlight mismatches.                                                                                                      </td><td data-label="Recommendation/Fix"> <strong>Recommendation</strong>: Use the core/global implementation (<code>window.__tv_utils.normalizeForSearchLocal</code>) everywhere for consistency.                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Issue"> <strong>showToast / clipboard / utils exposure (low)</strong>                         </td><td data-label="Description"> <code>script.core</code> exposes <code>showToast</code>, <code>copyToClipboard</code>, <code>downloadBlob</code> via <code>window.tvUtils</code> and <code>window.showToast</code>, while <code>script.table</code> reads from both.                       </td><td data-label="Recommendation/Fix"> <strong>Recommendation</strong>: Prefer one canonical usage of either <code>window.tvUtils.showToast</code> or <code>window.showToast</code> for clarity.                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Issue"> <strong>PTToc / TOC init duplication (low)</strong>                                   </td><td data-label="Description"> Both scripts attempt to initialize/build <code>PTToc</code>, causing unnecessary multiple builds.                                                                                        </td><td data-label="Recommendation/Fix"> <strong>Recommendation</strong>: Keep one initialization path or ensure <code>PTToc.build()</code> is idempotent. Prefer calling <code>__tv_init_pttoc_from_core</code> from <code>core</code>.                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Issue"> <strong>Event listeners duplicated for DOMContentLoaded / click (low→medium)</strong> </td><td data-label="Description"> Both scripts add similar <code>DOMContentLoaded</code> actions, causing redundant calls.                                                                                                 </td><td data-label="Recommendation/Fix"> <strong>Recommendation</strong>: Load <code>script.core</code> first, then <code>script.table</code>, and keep guards to avoid duplicate event listeners.                                                                                                                                                                                                                                                                                                                </td></tr></tbody></table></div><div class="row-count">Rows: 8</div></div><div class="table-caption" id="Table2" data-table="Book_8064_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Category**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Category</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Revisions / Notes**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Revisions / Notes</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Category"> <strong>script.core.js</strong>           </td><td data-label="Revisions / Notes"> - Unified all DOM event entry under one <code>DOMContentLoaded</code> listener.<br>- Added re-entry guard for <code>__tv_convert_click_ev</code>.<br>- Consolidated TOC build via <code>__tv_init_pttoc_from_core</code> with <code>_built</code> flag.<br>- Added verification logger to check duplicates.<br>- Centralized global helper exposure under <code>window.__tv_utils</code>. </td></tr><tr><td data-label="Category"> <strong>script.table.js</strong>          </td><td data-label="Revisions / Notes"> - Removed its own <code>DOMContentLoaded</code> listener.<br>- Attached only table-specific header/sorting logic through <code>__tv_init_table</code>.<br>- Linked TOC call to core’s unified builder.<br>- Removed redundant convert button handler.                                                                                                    </td></tr><tr><td data-label="Category"> <strong>Global structure changes</strong> </td><td data-label="Revisions / Notes"> - Planned new <code>utils.js</code> for shared helpers (<code>safe</code>, <code>debounce</code>, <code>normalizeForSearchLocal</code>, <code>copyToClipboard</code>).<br>- Established load order: <code>utils.js</code> → <code>script.core.js</code> → <code>script.table.js</code>.<br>- Cleaned event duplication for click, <code>exportAllBtnHandler</code>, and TOC build.                                                    </td></tr><tr><td data-label="Category"> <strong>Verification layer</strong>       </td><td data-label="Revisions / Notes"> - Console self-check reports duplicates or missing hooks at runtime.<br>- Outcome: one event per function, one TOC build, single conversion trigger, consistent helper usage.                                                                                                                                                      </td></tr></tbody></table></div><div class="row-count">Rows: 4</div></div><div class="table-caption" id="Table3" data-table="Book_8064_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Goal</strong>  Make PasteToTable (PTT) behave like Tables Viewer (TV) v2.1 for captions and TOC: inject captions and TOC client-side (read-only <code>labels.json</code>), keep groups modal, preserve legacy button delegation, and ensure stable anchors for script binding. Maintain server compatibility without writing to <code>labels.json</code>.                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical Breakdown"> <strong>Revised Files</strong>  <code>assets/script.list.js</code> and <code>assets/script.toc.js</code> fully replaced. <code>server.py</code> reviewed for endpoint consistency and manifest handling.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Technical Breakdown"> <strong>Key Changes (client)</strong>  <br>1. Added <code>injectCaptionsAndTocIntoHtml()</code> and <code>LAST_LOADED_LABELS</code> in <code>script.list.js</code>.  <br>2. Wrapped each <code>&lt;table&gt;</code> in <code>.table-wrapper</code>, inserted <code>.table-heading</code> and <code>.table-controls</code>.  <br>3. Inserted or replaced <code>&lt;caption class=&quot;table-caption&quot;&gt;</code> using <code>labels.json</code> lookup (idempotent).  <br>4. Rebuilt <code>&lt;ul id=&quot;toc&quot;&gt;</code> from <code>labels.json</code> when available, otherwise from DOM order.  <br>5. <code>loadLabels()</code> reads from candidates but never writes.  <br>6. <code>loadFilesSequentialAndHideForm()</code> injects processed HTML when <code>LAST_LOADED_LABELS</code> exists.  <br>7. Preserved legacy behaviors (<code>listBtn</code>, <code>triggerConvertIfAvailable()</code>, modal, and advanced group search). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Key Changes (toc)</strong>  <br>1. Deterministic ID generation for headings and rows: <code>table-&lt;base&gt;-heading</code>, <code>table-&lt;base&gt;-row-&lt;n&gt;</code>.  <br>2. Normalizes heading text by removing <code>&lt;br&gt;</code> and collapsing whitespace.  <br>3. MutationObserver rebuilds TOC only when relevant changes occur.  <br>4. Delegated click handler attached once with <code>aria-current</code> highlighting.                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Technical Breakdown"> <strong>Server-related Notes</strong>  <code>/groups_index.json</code>, <code>/groups/index</code>, and <code>/saved/index</code> endpoints verified. <code>/manifest.json</code> returns 404 cleanly handled. No server writes to <code>labels.json</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>Unchanged Behavior</strong>  <code>labels.json</code> remains read-only. Legacy UI wiring, modal logic, and convert triggers unchanged. Server endpoints maintain same API shape.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>User Requirements Captured</strong>  <br>1. Inject captions and TOC matching TV benchmark.  <br>2. Keep <code>labels.json</code> read-only.  <br>3. Preserve legacy delegation and triggers.  <br>4. Ensure idempotent injection with no duplicate elements.  <br>5. Use labels order for TOC if available; fallback to DOM order.                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Technical Breakdown"> <strong>Assumptions</strong>  <br>1. <code>labels.json</code> keys match table IDs or basenames (case-insensitive).  <br>2. Fetched files are full HTML documents (<code>&lt;!doctype&gt;</code> or <code>&lt;html&gt;</code> detected).  <br>3. Viewer expects <code>.table-wrapper</code>, <code>.table-heading</code>, <code>.table-controls</code>.  <br>4. Browser supports <code>DOMParser</code>, <code>closest</code>, <code>classList</code>, and <code>AbortController</code>.                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Technical Breakdown"> <strong>Remaining Risks / Edge Cases</strong>  <br>1. Label mismatches prevent caption injection.  <br>2. “HTML-like” files may cause false positives in injection.  <br>3. MutationObserver may miss async renders outside observed root.  <br>4. Sticky header offset may vary per layout.  <br>5. Older browsers degrade gracefully.  <br>6. Late label loads may miss first injection but cached for later use.  <br>7. TOC normalization slightly alters spacing (intentional).                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Technical Breakdown"> <strong>Verification Steps</strong>  <br>1. Click <strong>listBtn</strong> → verify modal loads from <code>/saved/index</code> or <code>/groups/index</code>.  <br>2. Load group with one or more saved HTML files.  <br>3. Confirm <code>&lt;ul id=&quot;toc&quot;&gt;</code> appears and links target <code>.table-heading</code> IDs.  <br>4. Inspect <code>.table-wrapper</code> structure: heading, controls, caption, table.  <br>5. Reload or re-run load — no duplicate wrappers or TOC entries.  <br>6. Test single-table pages: TOC anchors match row headings.  <br>7. Confirm no server-side modification of <code>labels.json</code>.  <br>8. Validate <code>/manifest.json</code> 404 handled without breaking UI.                                                                                                           </td></tr><tr><td data-label="Technical Breakdown"> <strong>Unit / Manual Test Ideas</strong>  <br>1. Run injection on plain HTML without wrappers; compare to TV output.  <br>2. Test label matching with varied cases (uppercase/lowercase).  <br>3. Test existing TOC/captions for replacement behavior.  <br>4. Verify smooth scrolling with and without sticky header.  <br>5. Simulate fetch timeout and check recovery.                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical Breakdown"> <strong>Integration with TV Benchmark</strong>  Mirrors TV v2.1 DOM: <code>.table-wrapper</code>, table headings as anchors, and top-level TOC links. <code>.table-controls</code> placeholders remain for copy/export compatibility.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance Considerations</strong>  Parsing runs only on true HTML. <code>fetchWithTimeout</code> avoids hangs. MutationObserver uses 150 ms debounce for stable rebuilds.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security / Stability Review</strong>  Client reads but never writes labels. Server uses secure headers. Path segments safely encoded. Server atomic writes verified.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical Breakdown"> <strong>Remaining Action Items</strong>  <br>1. Add integration test harness (sample HTML + labels).  <br>2. Make TOC insertion point configurable.  <br>3. Retry injection when <code>LAST_LOADED_LABELS</code> loads late.  <br>4. Add <code>data-*</code> attributes to <code>.table-controls</code> for stable selectors.  <br>5. Log failed HTML injection attempts.                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Technical Breakdown"> <strong>Future Upgrade Options</strong>  <br>1. Server-side pre-render for static export.  <br>2. Add undo or versioned save for injected HTML.  <br>3. Enhance label matching for tables missing IDs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Technical Breakdown"> <strong>Cross-check Validation (3×)</strong>  <br>1. <code>script.list.js</code> handles read-only <code>labels.json</code>. ✅  <br>2. <code>script.toc.js</code> creates deterministic anchors. ✅  <br>3. <code>server.py</code> endpoints fully compatible. ✅                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Technical Breakdown"> <strong>Maintenance Notes</strong>  Keep label and group candidate paths in sync. Update <code>headingSelector</code> if wrapper structure changes. Document key naming conventions for labels.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final Assessment</strong>  Achieved robust, idempotent, and TV-aligned client injection for captions and TOC. Server compatibility and legacy features preserved. Optional refinements identified.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical Breakdown"> <strong>Memory State</strong>  Full PasteToTable project context retained: folder structure, updated <code>server.py</code>, and revised client scripts available for further testing or patching.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr></tbody></table></div><div class="row-count">Rows: 20</div></div><div class="table-caption" id="Table4" data-table="Book_8064_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>Goal</strong><br>Provide a robust Flask app for PasteToTable. Serve assets, saved files, index endpoints, convert/render pipeline, and safe single-file saves. Maintain backward compatibility with old <code>/api/*</code> aliases. Keep <code>groups_index.json</code> read-only. Avoid writing to <code>labels.json</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Technical Breakdown"> <strong>Files Reviewed</strong><br><code>server.py</code> (full file).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>Primary Endpoints</strong><br><code>/</code>, <code>/health</code>, <code>/manifest.json</code>, <code>/manifest.webmanifest</code> (recommended alias), <code>/assets/&lt;path&gt;</code>, <code>/saved/index</code>, <code>/groups_index.json</code>, <code>/groups/index</code>, <code>/convert</code> (<code>/api/convert</code>, <code>/api/render</code>), <code>/save</code>, <code>/save-md</code>, <code>/saved/&lt;file_id&gt;</code>, <code>/api/health</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Technical Breakdown"> <strong>Key Behaviors Observed</strong><br>- Imports optional helpers (<code>render_from_text</code>, <code>save_html_atomic</code>, <code>read_saved</code>).<br>- <code>STORAGE_PATH</code> default points to Windows Dropbox-like path but can be overridden.<br>- <code>/groups_index.json</code> serves static file or dynamic fallback.<br>- <code>/saved/index</code> lists files under <code>STORAGE_PATH</code>.<br>- <code>/convert</code> attempts multiple renderer imports; returns HTML + meta.<br>- <code>/save</code> writes HTML atomically; returns file info.<br>- <code>/save-md</code> writes multiple markdown files.<br>- <code>/saved/&lt;file_id&gt;</code> safely serves files after containment check.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Technical Breakdown"> <strong>Correct / Good Practices</strong><br>- Defensive imports and fallbacks.<br>- Atomic writes via <code>tempfile</code> + <code>os.replace</code>.<br>- Request content-length enforcement.<br>- Jinja cache flush helper.<br>- Careful UTF-8-SIG parsing for <code>groups_index.json</code>.<br>- Filename sanitization for group listing.<br>- Security headers set post-response.<br>- Extensive try/except coverage to prevent crashes.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Technical Breakdown"> <strong>Issues / Improvements (priority)</strong><br>1. Windows <code>commonpath</code> raises <code>ValueError</code> if drives differ — catch and log more clearly.<br>2. Default <code>STORAGE_PATH</code> is hard-coded to Windows path — replace with relative <code>saved_tables</code>.<br>3. Manifest name mismatch — accept both <code>/manifest.json</code> and <code>/manifest.webmanifest</code>.<br>4. Prefer returning JSON via <code>jsonify</code> over raw <code>send_from_directory</code> for <code>/groups_index.json</code>.<br>5. <code>_safe_filename</code> may yield empty string for some Unicode cases — review fallback policy.<br>6. <code>_normalize_and_group_name_from_filename</code> could strip trailing <code>-</code> or spaces more aggressively.<br>7. <code>/saved/index</code> should optionally filter by extension (e.g. <code>.html</code>, <code>.md</code>).<br>8. <code>/save</code> returns full filesystem path — leak risk; return relative path or id.<br>9. No rate-limiter by default — add one for production.<br>10. <code>_atomic_write_bytes_to_path</code> ignores chmod errors — safe but noisy.<br>11. <code>groups_index.json</code> parsing failures log redundant noise.<br>12. <code>/save-md</code> lacks download URLs — minor usability improvement. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security Concerns</strong><br>- Absolute path exposure in <code>/save</code> leaks server structure.<br>- <code>/save</code> and <code>/save-md</code> unauthenticated — add rate-limit or token.<br>- <code>commonpath</code> containment check prevents traversal; keep Windows-specific handling.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance Notes</strong><br>- <code>/saved/index</code> scales O(n); fine for small sets but cache for >10k files.<br>- <code>groups_index</code> generation cached for 10s; increase for stability.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical Breakdown"> <strong>Edge-case Bugs Found</strong><br>- Some fallback inner functions lack typing — review for static checks.<br>- <code>request.get_json(silent=True)</code> called twice in <code>/save-md</code> — redundant.<br>- <code>storage</code> naming duplication between function and outer scope — minor readability issue.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>Suggested Small Fixes (apply immediately)</strong><br>1. Remove absolute path from <code>/save</code> response:<br>  <code>return jsonify({&quot;ok&quot;:True,&quot;status&quot;:&quot;ok&quot;,&quot;id&quot;:file_id,&quot;filename&quot;:file_id})</code>.<br>2. Add <code>/manifest.webmanifest</code> route alias delegating to <code>/manifest.json</code>.<br>3. Catch <code>ValueError</code> in <code>commonpath</code> and log drives before <code>abort(404)</code>. Example:<br>  <code>except ValueError: logger.warning(&quot;Path containment check failed (different drives)&quot;); abort(404)</code>.<br>4. Return relative download URL (<code>/saved/&lt;id&gt;</code>) in <code>/save</code> response.<br>5. Ensure exceptions never log full tmp paths.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Technical Breakdown"> <strong>Verification Steps</strong><br>1. Start app; <code>GET /health</code> → expect <code>{&quot;ok&quot;:true}</code>.<br>2. <code>GET /saved/index</code> → returns filename list.<br>3. <code>GET /groups/index</code> → returns groups JSON or static index.<br>4. <code>POST /convert</code> with markdown table → returns HTML <code>&lt;table&gt;</code>.<br>5. <code>POST /save-md</code> with multi-table markdown → returns filenames; check files exist.<br>6. <code>GET /saved/&lt;filename&gt;</code> → file downloaded.<br>7. <code>GET /saved/../server.py</code> → returns 404.<br>8. On Windows, simulate saving to another drive; ensure no crash from <code>commonpath</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical Breakdown"> <strong>Tests to Add / Automate</strong><br>- Unit: <code>_split_markdown_tables()</code> with pipes/fenced code.<br>- Integration: <code>/save-md</code> atomic writes and interruptions.<br>- Corrupt <code>groups_index.json</code> with BOM/large file.<br>- Missing/unreadable <code>STORAGE_PATH</code> case.<br>- Path traversal test for <code>/saved/&lt;file_id&gt;</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical Breakdown"> <strong>Future Enhancements</strong><br>- Add token auth for save endpoints.<br>- Paginate and cache <code>/saved/index</code>.<br>- Include <code>url</code> field in save responses.<br>- Add <code>MAX_INDEX_ITEMS</code> query parameter.<br>- Log structured JSON for saves.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Technical Breakdown"> <strong>Cross-check Validation</strong><br>- <code>labels.json</code> untouched. ✅<br>- <code>groups_index.json</code> read-only. ✅<br>- <code>/save-md</code> atomic write confirmed. ✅<br>- Security headers applied. ✅                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Technical Breakdown"> <strong>Final Recommendation</strong><br>Server is stable and defensive. Key fixes: remove absolute paths from responses, add manifest alias, handle Windows <code>commonpath</code> errors explicitly. Add rate-limit or auth for public deployments.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Technical Breakdown"> <strong>Patch Snippet (example)</strong><br><code>py&lt;br&gt;# In /save route&lt;br&gt;return jsonify({&quot;ok&quot;: True, &quot;status&quot;: &quot;ok&quot;, &quot;id&quot;: file_id, &quot;filename&quot;: file_id, &quot;url&quot;: f&quot;/saved/{file_id}&quot;})&lt;br&gt;</code>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr></tbody></table></div><div class="row-count">Rows: 16</div></div><div class="table-caption" id="Table5" data-table="Book_8064_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Step, Action, Input &amp; Output**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Step, Action, Input & Output</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Acceptance Criteria**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Acceptance Criteria</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Step, Action, Input &amp; Output"> <strong>1. Snapshot & Scan Session Artifacts (verified ×10)</strong><br><strong>Input:</strong> <code>core_renderer.py</code>, <code>toc_manager.py</code>, <code>script.list.js</code>, chat content.<br><strong>Output:</strong> Confirmed invariants and used hooks. </td><td data-label="Acceptance Criteria"> - <code>core_renderer</code> and <code>toc_manager</code> remain read-only.<br>- Identified IDs: <code>Table{N}</code> headings, <code>table-caption</code> class, TOC IDs <code>toc</code> and <code>toc-item</code>.                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Step, Action, Input &amp; Output"> <strong>2. Static Analysis of <code>script.list.js</code> (lint-level)</strong><br><strong>Input:</strong> Provided JS source.<br><strong>Output:</strong> Exact edit loci enumerated.                                                            </td><td data-label="Acceptance Criteria"> Changes limited to:<br>  1. <code>loadLabels()</code><br>  2. <code>buildGroupsFromLive()</code> (caption wiring)<br>  3. <code>createGroupRow()</code><br>  4. <code>loadFilesSequentialAndHideForm()</code> (order + caption propagation)<br>- No new global names introduced.                                                                                                                                                             </td></tr><tr><td data-label="Step, Action, Input &amp; Output"> <strong>3. Specification: Label Key Mappings</strong><br><strong>Input:</strong> <code>labels.json</code> entries (e.g. <code>Book_0001_01</code> → <code>Chapter 1 - example</code>).<br><strong>Output:</strong> Deterministic mapping rules.                         </td><td data-label="Acceptance Criteria"> Mapping priority:<br>  1. Basename without extension (case-sensitive)<br>  2. Basename lowercased<br>  3. <code>book_prefix_index</code> forms (<code>Book_0001_01</code>, <code>Book_0001-01</code>)<br>  4. Numeric padding variants (<code>01</code> / <code>1</code>)<br>- All lookups follow this sequence.                                                                                                                                        </td></tr><tr><td data-label="Step, Action, Input &amp; Output"> <strong>4. Design Patch (diff-style plan)</strong><br><strong>Input:</strong> Target file <code>script.list.js</code>.<br><strong>Output:</strong> Minimal diff described.                                                                        </td><td data-label="Acceptance Criteria"> - Add <code>resolveCaptionFor(filename)</code> utility.<br>- Use it when building group file objects to set <code>file.caption</code>.<br>- Add fallback empty string.<br>- Preserve DOM IDs and names.                                                                                                                                                                                                                  </td></tr><tr><td data-label="Step, Action, Input &amp; Output"> <strong>5. Implementation Details (what to change)</strong><br><strong>Input:</strong> Functions and call sites.<br><strong>Output:</strong> Exact edits to paste.                                                                     </td><td data-label="Acceptance Criteria"> 1. Enhance <code>loadLabels()</code> to normalize keys into a <code>Map</code> with multiple key forms.<br>2. Modify <code>buildGroupsFromLive()</code> to call <code>resolveCaptionFor(base)</code> for <code>caption</code> assignment.<br>3. Update <code>createGroupRow()</code> to render <code>f.caption</code> and set <code>data-caption</code>.<br>4. In <code>loadFilesSequentialAndHideForm()</code>, prepend <code>&lt;!-- caption: ... --&gt;</code> comments and update <code>document.title</code>.                </td></tr><tr><td data-label="Step, Action, Input &amp; Output"> <strong>6. Integration Checks vs Locked Files</strong><br><strong>Input:</strong> <code>core_renderer.py</code>, <code>toc_manager.py</code> behaviors.<br><strong>Output:</strong> Compatibility report.                                                    </td><td data-label="Acceptance Criteria"> - <code>toc_manager.apply_toc_and_captions()</code> expects matching heading IDs.<br>- No heading ID changes.<br>- Captions in <code>script.list.js</code> remain client-side only.<br>- <code>toc_manager</code> JSON keys (<code>Table{NN}</code> or basename) remain supported.                                                                                                                                                             </td></tr><tr><td data-label="Step, Action, Input &amp; Output"> <strong>7. Functional Test Checklist (manual – 10 checks)</strong><br><strong>Input:</strong> Local server + <code>assets/labels.json</code>.<br><strong>Output:</strong> Step-by-step expected results.                                          </td><td data-label="Acceptance Criteria"> 1. Modal opens.<br>2. Groups list shows counts.<br>3. Each file row shows caption text from <code>labels.json</code>.<br>4. Collapse/expand works.<br>5. Load group closes modal.<br>6. Paste area filled with files in group order.<br>7. Each file section includes <code>&lt;!-- caption: ... --&gt;</code>.<br>8. <code>triggerConvertIfAvailable()</code> runs.<br>9. No JS console errors.<br>10. <code>core_renderer</code> output unchanged. </td></tr><tr><td data-label="Step, Action, Input &amp; Output"> <strong>8. Static Safety Checks</strong><br><strong>Input:</strong> eslint-style scan.<br><strong>Output:</strong> Short report.                                                                                                       </td><td data-label="Acceptance Criteria"> - No synchronous XHR.<br>- No new globals.<br>- Uses existing DOM IDs.<br>- Timeout-based fetch only.<br>- Worker logic unchanged.                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Step, Action, Input &amp; Output"> <strong>9. Rollback & Deploy</strong><br><strong>Input:</strong> Current <code>assets/script.list.js</code>.<br><strong>Output:</strong> Commands/snippets.                                                                                       </td><td data-label="Acceptance Criteria"> - <strong>Backup:</strong> <code>cp assets/script.list.js assets/script.list.js.bak</code><br>- <strong>Deploy:</strong> Replace file.<br>- <strong>Rollback:</strong> Restore backup.                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Step, Action, Input &amp; Output"> <strong>10. Deliverables</strong><br><strong>Input:</strong> Patched JS + changelog + checklist.<br><strong>Output:</strong> Ready-to-drop files and instructions.                                                                     </td><td data-label="Acceptance Criteria"> - Single patched <code>script.list.js</code>.<br>- 20-line changelog.<br>- 10-step verification checklist.                                                                                                                                                                                                                                                                                                    </td></tr></tbody></table></div><div class="row-count">Rows: 10</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>