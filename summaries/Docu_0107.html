<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1762783139">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#Table6">Table 6</a></li>
<li class="toc-item"><a class="toc-link" href="#Table7">Table 7</a></li>
<li class="toc-item"><a class="toc-link" href="#Table8">Table 8</a></li>
<li class="toc-item"><a class="toc-link" href="#Table9">Table 9</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0107_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Step / File (function)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Step / File (function)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Fragment metadata flow (fields &amp; transformations)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Fragment metadata flow (fields & transformations)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Trigger &amp; debugging / high-leverage fixes"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Trigger & debugging / high-leverage fixes</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Step / File (function)"> A. Manual paste → <code>assets/script.paste.js</code> (handler on paste area)                     </td><td data-label="Fragment metadata flow (fields &amp; transformations)"> Incoming payload: <code>{table_html, client_req_id?, source:&quot;manual_paste&quot;}</code>. Server may parse to <code>TableFragment</code> but <strong>do not</strong> attach caption payloads or run <code>inject_captions()</code>. Set <code>meta.injected=false</code>, <code>meta.source=&quot;manual_paste&quot;</code>. </td><td data-label="Trigger &amp; debugging / high-leverage fixes"> Debug: inspect client flow when pasting. Confirm no <code>data-caption-payload</code> scripts appear. Fix: short-circuit injection path when <code>source===&quot;manual_paste&quot;</code>. Log <code>paste_event</code> with <code>client_req_id</code>.                                                             </td></tr><tr><td data-label="Step / File (function)"> 1. Browser click → <code>assets/script.list.js</code> (Load Group handler)                        </td><td data-label="Fragment metadata flow (fields &amp; transformations)"> Outgoing payload: <code>{group_id, type:&quot;load_group&quot;, client_req_id}</code>. Server returns table(s) + caption fragments when available. Attach <code>client_req_id</code> to all downstream responses.       </td><td data-label="Trigger &amp; debugging / high-leverage fixes"> Debug: check network for <code>group_id</code> and <code>client_req_id</code>. Fix: ensure <code>script.list.js</code> always includes <code>client_req_id</code>. Add retry/backoff on group fetch failures.                                                                                                 </td></tr><tr><td data-label="Step / File (function)"> 2. Server entry <code>main.py</code> / <code>server.py</code> (group handler)                                </td><td data-label="Fragment metadata flow (fields &amp; transformations)"> Create <code>request_ctx = core_utils.get_request_context()</code> with <code>request_id</code>, <code>action=&quot;load_group&quot;</code>, <code>group_id</code>. Store <code>request_ctx.start_ts</code>. Propagate <code>action</code> into render pipeline.   </td><td data-label="Trigger &amp; debugging / high-leverage fixes"> Debug: search logs for <code>request_id</code> + <code>group_id</code>. Fix: add <code>info</code> log at handler start that prints <code>action</code> and <code>group_id</code>.                                                                                                                                            </td></tr><tr><td data-label="Step / File (function)"> 3. Read group files <code>render/io_utils.py::read_group()</code> (or <code>read_group_files()</code>)       </td><td data-label="Fragment metadata flow (fields &amp; transformations)"> Returns bytes + <code>file_checksum</code> per file. Compose group payload meta: <code>meta.group_checksum</code>, <code>meta.files=[{name,checksum}]</code>.                                                           </td><td data-label="Trigger &amp; debugging / high-leverage fixes"> Debug: verify checksums match client expectations. Fix: add fallback reads and surface per-file read errors to <code>request_ctx.ring_buffer</code>.                                                                                                                            </td></tr><tr><td data-label="Step / File (function)"> 4. Parse <code>render/convert.py::parse_*()</code> → produce CaptionBlocks                        </td><td data-label="Fragment metadata flow (fields &amp; transformations)"> Output caption objects: <code>{id?, start_ms, end_ms, text, raw_html?, source}</code>. Set <code>meta.parse_ok=true/false</code>. Tag fragments with <code>meta.source=&quot;group_load&quot;</code>.                           </td><td data-label="Trigger &amp; debugging / high-leverage fixes"> Run parser unit tests for group datasets. Fix: normalize newline/encoding edge cases. Add <code>meta.parse_errors</code> array.                                                                                                                                                 </td></tr><tr><td data-label="Step / File (function)"> 5. Sanitize <code>render/sanitize.py::sanitize_caption_html()</code>                              </td><td data-label="Fragment metadata flow (fields &amp; transformations)"> Transform <code>raw_html</code> → <code>html_sanitized</code> or <code>html_escaped</code>. Set <code>meta.sanitized=true</code>, <code>meta.sanitize_action</code> ∈ <code>{&quot;cleaned&quot;,&quot;escaped&quot;,&quot;rejected&quot;}</code>.                                      </td><td data-label="Trigger &amp; debugging / high-leverage fixes"> Quick check: print first 5 <code>meta.sanitize_action</code> values. Fix XSS rules; fallback to <code>html_escaped</code>.                                                                                                                          </td></tr><tr><td data-label="Step / File (function)"> 6. Wrap <code>render/core_fragments.py::CaptionFragment.create()</code>                           </td><td data-label="Fragment metadata flow (fields &amp; transformations)"> Final fragment shape: <code>{type:&quot;CAPTION&quot;, id:&quot;ptt-&lt;hash&gt;&quot;, payload:{start_ms,end_ms,text,html_sanitized}, meta:{source,checksum,provenance,sanitized:true}}</code>.                            </td><td data-label="Trigger &amp; debugging / high-leverage fixes"> Debug: inspect fragment list length and unique ids. Fix collisions by using <code>sha256(source+index+salt)</code> in <code>core_utils.generate_stable_id()</code>.                                                                                                                     </td></tr><tr><td data-label="Step / File (function)"> 7. Table normalization <code>render/core_table.py::ensure_table_id()</code>                       </td><td data-label="Fragment metadata flow (fields &amp; transformations)"> TableFragment meta: <code>{table_id, row_count, row_index_map:{row_idx-&gt;dom_selector}, checksum}</code>. Rows get <code>data-row-index</code>.                                                              </td><td data-label="Trigger &amp; debugging / high-leverage fixes"> Check rendered HTML for <code>data-table-id</code> and <code>data-row-index</code>. Fix missing IDs by deterministic hashing of table <code>innerHTML</code>.                                                                                                                                        </td></tr><tr><td data-label="Step / File (function)"> 8. Mapping <code>render/core_renderer.py::inject_captions()</code> <strong>(ONLY for Load Group flow)</strong> </td><td data-label="Fragment metadata flow (fields &amp; transformations)"> Mapping rules attach caption ids to <code>table_meta.caption_ids</code>. Caption fragments updated with <code>meta.table_id</code>, <code>meta.row_idx</code> when determinable. Mark <code>meta.injected=true</code>.        </td><td data-label="Trigger &amp; debugging / high-leverage fixes"> Critical: run <code>inject_captions()</code> <strong>only when</strong> <code>request_ctx.action == &quot;load_group&quot;</code> (or client explicitly requests injection). Debug unmatched captions by setting <code>meta.unmatched=true</code> and logging. Prefer explicit <code>fragment.meta.table_id</code>, else nearest table. </td></tr><tr><td data-label="Step / File (function)"> 9. Asset preparation <code>render/core_assets.py::emit_assets_html(ctx)</code>                    </td><td data-label="Fragment metadata flow (fields &amp; transformations)"> <code>ctx.injected_assets</code> updated. If <code>meta.injected===true</code> emit caption payload scripts for that <code>request_ctx</code>. Else skip caption asset emission.                                      </td><td data-label="Trigger &amp; debugging / high-leverage fixes"> Inspect head for duplicate tags. Fix: ensure <code>ctx.injected_assets</code> is per <code>request_ctx</code> and checked before emit.                                                                                                                                                    </td></tr><tr><td data-label="Step / File (function)"> 10. Final assembly <code>html_renderer.py::render_html()</code>                                   </td><td data-label="Fragment metadata flow (fields &amp; transformations)"> If <code>meta.injected===true</code> produce <code>&lt;script type=&quot;application/json&quot; data-caption-payload data-table-id=&quot;t-...&quot;&gt;[...]&lt;/script&gt;</code>. Otherwise omit caption payload scripts.              </td><td data-label="Trigger &amp; debugging / high-leverage fixes"> Debug: <code>rg &quot;data-caption-payload&quot; -n</code> on output. Fix race by ensuring <code>emit_assets_html()</code> runs before injection so binder loads first.                                                                                                                               </td></tr><tr><td data-label="Step / File (function)"> 11. Client bind (<code>assets/script.core.js</code>, <code>script.table.js</code>, <code>script.list.js</code>)         </td><td data-label="Fragment metadata flow (fields &amp; transformations)"> Client receives HTML. For Load Group responses with caption payloads client calls <code>window.PTT.injectCaptions(tableId, captions)</code> or drains <code>window._PTT_Q</code>. For manual paste no injection. </td><td data-label="Trigger &amp; debugging / high-leverage fixes"> Debug: open console on Load Group. Check <code>window._PTT_Q</code>, <code>window.PTT</code>, and that <code>injectCaptions()</code> ran. For paste, confirm absence of caption scripts. Fix: implement queue drain and defensive guards in <code>script.core.js</code>.                                      </td></tr><tr><td data-label="Step / File (function)"> 12. Large payload path (worker)                                                        </td><td data-label="Fragment metadata flow (fields &amp; transformations)"> If <code>captions.length &gt; config.worker_threshold</code> server may offload and return <code>{meta.offloaded=true, meta.payload_url}</code>.                                                               </td><td data-label="Trigger &amp; debugging / high-leverage fixes"> Test large group loads. Fix OOM by enabling streaming or worker flow. Ensure offloaded path still respects <code>action==&quot;load_group&quot;</code>.                                                                                                                                    </td></tr><tr><td data-label="Step / File (function)"> 13. Diagnostics & metrics (<code>core_utils</code>, <code>html_renderer.generate_diagnostic_report</code>)   </td><td data-label="Fragment metadata flow (fields &amp; transformations)"> Per-request diagnostics include <code>request_ctx.action</code>, <code>injection_success</code>, <code>injection_fallbacks</code>, <code>captions_parsed</code>, <code>captions_sanitized</code>.                                             </td><td data-label="Trigger &amp; debugging / high-leverage fixes"> Immediate checks: call <code>/api/debug?req=&lt;request_id&gt;</code> to inspect <code>action</code> and <code>ring_buffer</code>. Fix gaps by adding granular logs where <code>action</code> is lost.                                                                                                               </td></tr></tbody></table></div><div class="row-count">Rows: 14</div></div><div class="table-caption" id="Table2" data-table="Docu_0107_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Enhancement"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Enhancement</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Enhancement"> <strong>Goal:</strong> Prevent unsafe or unintended caption injection on manual paste, while maintaining normal Load Group caption injection. Ensure full client-server compatibility, correct <code>client_req_id</code> tracking, and proper defensive handling of paste and group actions. Preserve queue drain behavior and avoid duplicate caption payloads.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Enhancement"> <strong>Revised Files:</strong> <code>assets/script.core.js</code>, <code>assets/script.list.js</code>, <code>server.py</code>, <code>html_renderer.py</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Enhancement"> <strong>Key Changes:</strong> <br>1. <strong>script.core.js:</strong> Paste handlers relocated; <code>client_req_id</code> generation unified; all manual paste events marked <code>source:&quot;manual_paste&quot;</code>; defensive guards added to short-circuit caption injection; queue drain behavior preserved.<br>2. <strong>script.list.js:</strong> Maintains <code>action:&quot;load_group&quot;</code> semantics; ensures consistent <code>client_req_id</code> generation; triggers server to include caption payloads only for load-group flows.<br>3. <strong>server.py:</strong> Request context (<code>request_ctx</code>) records <code>action</code>, <code>source</code>, and <code>client_req_id</code>; ensures caption injection logic only triggers when <code>action===&quot;load_group&quot;</code>; manual paste paths never inject captions.<br>4. <strong>html_renderer.py:</strong> Wrap functions <code>_wrap_callable</code> and <code>_wrap_each_table_with_ui</code> updated to skip injecting <code>data-caption-payload</code> for manual paste; <code>_process_bytes</code> and <code>_inject_ui_assets</code> preserve behavior for load-group while paste path remains clean. </td></tr><tr><td data-label="Enhancement"> <strong>Unchanged Behavior:</strong> Load Group workflow continues to attach caption payloads as before; table UI CSS/JS injection unchanged for normal loads; existing diagnostics and logging remain intact.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Enhancement"> <strong>User Requirements:</strong> Ensure manual paste never produces caption payload scripts; Load Group still injects captions; <code>client_req_id</code> tracked per request; queue drains properly; server logs reflect action/source; minimal disruption to existing HTML rendering.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Enhancement"> <strong>Assumptions:</strong> <code>groups_index.json</code> not affected; client always sends <code>action</code> for load-group; PasteToTable manual paste always has source flagged correctly; server environment uses Flask dev/local server; existing asset paths intact.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Enhancement"> <strong>Remaining Risks:</strong> If client mislabels <code>source</code>, captions may be missed or mis-injected; concurrent rapid manual paste could race but queue drain mitigates; offloaded large payloads need to respect <code>action===&quot;load_group&quot;</code> guard.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Enhancement"> <strong>Verification Steps:</strong><br>1. Manual paste → check HTML output → confirm <strong>no</strong> <code>&lt;script data-caption-payload&gt;</code> appears.<br>2. Load Group click → check HTML output → confirm <code>&lt;script data-caption-payload&gt;</code> present.<br>3. Inspect <code>client_req_id</code> in network requests for both flows.<br>4. Check server logs → <code>request_ctx.action</code> and <code>request_ctx.source</code> recorded correctly.<br>5. Queue drain works without blocking subsequent injections.<br>6. Large payload path tested → still respects action gate.<br>7. Verify table wrappers and UI assets inject normally.                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Enhancement"> <strong>Future Upgrade Options:</strong> Could centralize action/source guards in server middleware; optional rate-limiting per client_req_id; unit tests to simulate mixed paste/load-group requests; add automated detection if paste mistakenly injects captions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Enhancement"> <strong>Integration with Client:</strong> <code>script.core.js</code> and <code>script.list.js</code> fully coordinated on <code>client_req_id</code> generation and action/source flags; manual paste path isolated; Load Group path fully compatible; PTT event dispatch unchanged.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Enhancement"> <strong>Integration with Server:</strong> <code>server.py</code> enforces injection gate based on <code>request_ctx.action</code>; manual paste cannot trigger caption injection; logging of <code>client_req_id</code> ensures auditability; diagnostics reflect injected vs skipped captions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Enhancement"> <strong>Security / Stability:</strong> Manual paste path cannot inject scripts → prevents accidental XSS via caption payloads; Load Group path unchanged; atomic handling of large payloads; defensive logging on exceptions; HTML minification and sanitization unaffected.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Enhancement"> <strong>Audit / Logging:</strong> Each request logs <code>action</code>, <code>source</code>, and <code>client_req_id</code>; injection success/failure logged; fallback paths in <code>html_renderer</code> maintain previous logging behavior.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Enhancement"> <strong>Cross-check Validation:</strong> No residual caption injection on paste; Load Group continues normal injection; <code>client_req_id</code> present and unique; diagnostics confirm wrapped functions behave correctly; all regex and HTML processing intact.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Enhancement"> <strong>Performance:</strong> Minimal overhead; paste path fast due to guard short-circuit; Load Group injection performance unchanged; queue drain maintains flow integrity.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Enhancement"> <strong>Maintenance:</strong> Ensure future changes to render_html/wrappers honor action/source flags; test new tables or batch scenarios; periodically validate that manual paste cannot produce caption scripts.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Enhancement"> <strong>Verification Environment:</strong> Windows 10+, Python ≥3.9, Flask dev/local server, modern browser (ES6+) for client; tested with both small and large table payloads.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Enhancement"> <strong>Final Assessment:</strong> Configuration is safe, stable, production-ready. Manual paste path is fully isolated from caption injection. Load Group path retains full caption injection and UI features. Queue drain and client_req_id tracking robust. Diagnostics and logging fully operational. All user requirements met.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Enhancement"> <strong>Memory State:</strong> Long-term context retained. Assistant ensures continuity between <code>script.core.js</code>, <code>script.list.js</code>, <code>server.py</code>, and <code>html_renderer.py</code>. Caption injection correctly gated by <code>action===&quot;load_group&quot;</code>. Manual paste fully sanitized from payload scripts.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr></tbody></table></div><div class="row-count">Rows: 19</div></div><div class="table-caption" id="Table3" data-table="Docu_0107_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Enhancement"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Enhancement</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Enhancement"> <strong>Goal:</strong> Ensure caption injection runs <em>only</em> on Load-Group flows and is performed server-side (core_renderer.py / html_renderer.py). Prevent any caption payloads from being emitted for manual-paste/convert flows. Keep client simple: list.js sends only activated group metadata; core handles caption mapping, sanitization, and injection.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Enhancement"> <strong>Revised Files</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Enhancement"> - <code>assets/script.core.js</code> — moved paste handlers, generate <code>client_req_id</code>, tag manual paste requests with <code>source:&quot;manual_paste&quot;</code>, defensive guards, queue drain preserved. <br>- <code>assets/script.list.js</code> — keep <code>action:&quot;load_group&quot;</code> semantics; attach <code>client_req_id</code> and send only activated group metadata to server. <br>- <code>server.py</code> — create and propagate <code>request_ctx</code> containing <code>request_id</code>, <code>client_req_id</code>, <code>action</code>/<code>source</code>; only include caption payloads in responses when <code>request_ctx.action === &quot;load_group&quot;</code>. <br>- <code>render/core_renderer.py</code> (or <code>html_renderer.py</code> when used) — server-side caption resolution and safe injection into fragment HTML. Ensure paste/convert path never emits <code>&lt;script data-caption-payload&gt;</code> blocks. <br>- <code>html_renderer.py</code> — post-render wrapper avoids adding caption payload scripts for paste/convert flows.                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Enhancement"> <strong>Key Changes</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Enhancement"> - Decision gate for injection moved server-side. <code>inject_captions()</code> now runs only when <code>request_ctx.action === &quot;load_group&quot;</code> (or explicit <code>inject:true</code>). <br>- <code>script.list.js</code> only sends activated group metadata (group id, client_req_id, action:"load_group"). It no longer attempts to map or inject captions client-side. <br>- <code>script.core.js</code> marks manual paste actions with <code>source:&quot;manual_paste&quot;</code> and a <code>client_req_id</code>. Server treats this as non-inject path. <br>- <code>server.py</code> records <code>request_ctx = { request_id, client_req_id, action, source, start_ts }</code> and passes it into render pipeline so core_renderer can decide whether to attach caption payloads. <br>- <code>core_renderer.py</code> performs caption lookup (labels.json + find_label_for_key), sanitizes captions (use <code>prepare_caption(..., allow_html=False)</code> or strict sanitizer), and inserts captions <em>inside</em> <code>&lt;table&gt;</code> as <code>&lt;caption&gt;</code> where safe. When message size forces offload, server returns a <code>payload_url</code> but still marks <code>meta.offloaded=true</code> only for load_group flows. <br>- <code>html_renderer.py</code> wrapped output now injects UI assets and table wrappers but will <strong>not</strong> emit <code>data-caption-payload</code> scripts for paste/convert responses.                                                                                                  </td></tr><tr><td data-label="Enhancement"> <strong>Unchanged Behavior</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Enhancement"> - Manual paste → convert flow still triggers rendering pipeline and returns HTML. <br>- Existing file fetch, index probing, grouping, and search UI remain unchanged except for metadata fields added. <br>- Atomic writes and existing asset handling preserved.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Enhancement"> <strong>User Requirements Covered</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Enhancement"> - Only activated group metadata is sent from client. <br>- Caption injection moved to server side. <br>- Manual paste path never gets caption payload scripts. <br>- <code>client_req_id</code> and <code>action</code>/<code>source</code> recorded and logged for diagnostics.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Enhancement"> <strong>Assumptions</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Enhancement"> - Client code will be updated in lockstep: <code>script.core.js</code> provides <code>client_req_id</code> and sets <code>source:&quot;manual_paste&quot;</code> for paste; <code>script.list.js</code> sends <code>action:&quot;load_group&quot;</code> and the single activated group's metadata with same <code>client_req_id</code>. <br>- <code>render_from_text</code> or <code>core_renderer.render_html</code> accepts additional context/kwargs or a thread-local <code>request_ctx</code> to decide injection. <br>- <code>labels.json</code> and <code>find_label_for_key()</code> are available for caption resolution.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Enhancement"> <strong>Remaining Risks</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Enhancement"> - Race: client and server <code>client_req_id</code> mismatch if not generated/delivered identically. <br>- Caption sanitization may strip desired inline markup. Confirm <code>prepare_caption(..., allow_html=False)</code> is acceptable or adjust policy. <br>- Large payload offload path must still deliver captions to client safely. Offloaded payload URLs must be access-controlled if environment is public. <br>- If render pipeline writes captions into fragments on disk, those files become the single source of truth and must not be served back to paste flows with embedded caption metadata.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Enhancement"> <strong>Verification Steps (practical, run now)</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Enhancement"> 1. Manual-paste test: open app, paste a table, click Convert. Inspect returned HTML (view-source or network response). <strong>Expect:</strong> No <code>&lt;script type=&quot;application/json&quot; data-caption-payload ...&gt;</code> present. Confirm <code>window.__ptt_runtime_captions</code> logic not used. <br>2. Load-group test: open list modal, click a group. Client should POST to <code>/convert</code> (or <code>/api/convert</code>) with payload including <code>from_list: true</code>, <code>action:&quot;load_group&quot;</code>, and <code>client_req_id: &quot;&lt;uuid&gt;&quot;</code>. Inspect server logs for <code>request_ctx</code> entry containing those fields. <strong>Expect:</strong> Response HTML includes a caption payload script only for tables in the activated group, e.g. <code>&lt;script type=&quot;application/json&quot; data-caption-payload data-table-id=&quot;t-...&quot;&gt;[...]&lt;/script&gt;</code>. <br>3. Partial group / single-file activation: only the active group's metadata should be sent. Confirm server injects captions for those tables only. <br>4. Security scan: submit captions containing <code>&lt;script&gt;</code> and event handlers. Confirm output captions are sanitized and not executable. <br>5. Offload path test: force a large group (≥WORKER_THRESHOLD) and confirm <code>meta.offloaded=true</code> behavior and that captions are available via <code>payload_url</code> or streamed path. <br>6. Regression: existing copy/clipboard flows still work. Test copy markdown, copy plain. </td></tr><tr><td data-label="Enhancement"> <strong>Cross-check Validation</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Enhancement"> - <code>script.list.js</code> must not call <code>window.PTT.injectCaptions</code> nor attach <code>data-caption-payload</code> scripts client-side. <br>- <code>script.core.js</code> must set paste <code>source:&quot;manual_paste&quot;</code> and <code>client_req_id</code> and never set <code>meta.injected=true</code>. <br>- <code>server.py</code> must populate <code>request_ctx.action</code> and only allow server injection when action == 'load_group'. Confirm logging at handler start includes action and client_req_id. <br>- <code>html_renderer.py</code> <code>_wrap_each_table_with_ui()</code> and final emitter must be conditioned on <code>request_ctx</code> (or <code>meta</code>) and skip adding <code>data-caption-payload</code> in paste path.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Enhancement"> <strong>Security / Stability</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Enhancement"> - Captions sanitized server-side. Use conservative <code>prepare_caption(..., allow_html=False)</code> for user content. <br>- Atomic file writes retained for fragment/HTML output. <br>- Add Content-Security-Policy and XSS headers if deploying publicly. <br>- Endpoint unauthenticated risk noted.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Enhancement"> <strong>Audit / Logging</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Enhancement"> - <code>server.py</code> logs: <code>request_ctx={request_id,client_req_id,action,source,start_ts}</code> on handler entry. <br>- <code>core_renderer.py</code> records <code>caption_injected_into_table idx=&lt;n&gt; source=writer</code> events. <br>- Add debug <code>/api/debug?req=&lt;request_id&gt;</code> to inspect <code>request_ctx</code> and injection decisions.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Enhancement"> <strong>Future Upgrade Options</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Enhancement"> - Add HMAC or token tying <code>client_req_id</code> to session to avoid spoofing. <br>- Return explicit <code>caption_manifest</code> JSON endpoint for clients that prefer not to parse HTML. <br>- Add per-caption integrity (SRI-like hash) to detect tampering. <br>- Move label store to DB for faster lookups and atomic updates.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Enhancement"> <strong>Performance</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Enhancement"> - Server-side injection adds minimal cost (string ops). Heavy cost is rendering/parsing. Offload large groups via worker as implemented. <br>- Disk writes still atomic.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Enhancement"> <strong>Maintenance</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Enhancement"> - Keep <code>labels.json</code> path discovery robust (you added Dropbox path). Back up labels.json. <br>- Unit tests: <code>inject_captions()</code> with <code>request_ctx.action</code> variants; <code>sanitize_caption_for_injection</code> XSS cases; paste vs load_group response snapshots.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Enhancement"> <strong>Verification Environment</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Enhancement"> - Local dev: Python 3.9+, Flask, Node/modern browser. <br>- Repro steps include: run dev server, open browser console, test both flows, inspect HTML and network responses.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Enhancement"> <strong>Final Assessment & Confidence</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Enhancement"> - Static review confidence: <strong>~85%</strong>. The design enforces decision gating and moves injection to server. <br>- Runtime confidence: <strong>~75%</strong> until integration tests run. Main remaining variables: client/server <code>client_req_id</code> handshake and offload path correctness. <br>- If you push these changes in tandem (client + server + renderer) and run the verification steps above, I assess the system as safe and functional.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Enhancement"> <strong>Memory State</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Enhancement"> - Assistant records that caption injection was moved server-side, paste path must not emit <code>data-caption-payload</code>, <code>client_req_id</code> + <code>action</code>/<code>source</code> are required fields to propagate in request_ctx, and the four files named above were revised in this session.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr></tbody></table></div><div class="row-count">Rows: 33</div></div><div class="table-caption" id="Table4" data-table="Docu_0107_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Enhancement"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Enhancement</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Enhancement"> <strong>Goal:</strong> Move caption decision and injection to the server. Only <code>load_group</code> flows get caption payloads. Manual-paste/convert flows must never receive <code>data-caption-payload</code> scripts. Keep client simple: <code>script.list.js</code> sends only activated-group metadata and <code>script.core.js</code> tags manual paste with <code>source:&quot;manual_paste&quot;</code> and <code>client_req_id</code>. Server records <code>request_ctx</code> and renderer decides injection.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Enhancement"> <strong>Reviewed / Relevant Files</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Enhancement"> - <code>assets/script.core.js</code> (provided). <br>- <code>assets/script.list.js</code> (provided). <br>- <code>server.py</code> (provided).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Enhancement"> <strong>Key Observations / Required Changes</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Enhancement"> - <code>server.py</code> already builds <code>request_ctx</code> (request_id, action, source, client_req_id) via <code>_make_request_ctx()</code>. Good. <br>- <code>render_from_text</code> is discovered and used through <code>_render_text_with_fallbacks</code>. However the current call does not pass <code>request_ctx</code> into render options. <strong>core_renderer.py must accept <code>request_ctx</code> (or kwargs) and decide caption injection based on it.</strong> <br>- The design you described expects a gating condition <code>if request_ctx.action == &quot;load_group&quot;: inject_captions()</code>. That logic belongs in <code>core_renderer.py</code> (or <code>html_renderer.py</code>) and must mark <code>meta[&quot;injected&quot;] = True</code> only when injection occurred. <br>- <strong>Client ↔ Server endpoint mismatches found:</strong> <br>  • <code>script.list.js</code> POSTs group metadata to <code>/api/group/load</code>. <code>server.py</code> does not implement <code>/api/group/load</code>. Add a handler or have the client post to an existing endpoint. <br>  • <code>script.core.js</code> <code>submitPaste()</code> posts to <code>/api/paste</code>. <code>server.py</code> does not implement <code>/api/paste</code>. Add <code>/api/paste</code> or update client. <br>  • <code>script.list.js</code> uses <code>window.__tv_do_convert({ text: combinedRaw, metadata: { fromList: true } })</code> but current <code>__tv_do_convert</code> only sends <code>{ text }</code> to <code>/api/render</code>. Either: modify <code>__tv_do_convert</code> to include <code>metadata</code> and <code>action</code>/<code>client_req_id</code> when present, or change <code>script.list.js</code> to call the server directly with the desired metadata. <br>- <code>server.py</code>’s <code>/convert</code> already inspects <code>from_list</code> via JSON body keys and sets <code>meta[&quot;request_ctx&quot;]</code> for diagnostics. But it does not currently set an explicit <code>allow_caption_injection</code> flag. That must be set either in <code>server.py</code> (before calling renderer) or inside the renderer by checking <code>request_ctx</code>. Prefer setting <code>request_ctx[&quot;allow_caption_injection&quot;] = True</code> when <code>request_ctx[&quot;action&quot;] == &quot;load_group&quot; or meta[&quot;fromList&quot;]==True</code>. <br>- Sanitization: perform server-side sanitization with <code>prepare_caption(..., allow_html=False)</code> or similar. Inject captions as safe <code>&lt;caption&gt;</code> elements where possible. If you still need <code>data-caption-payload</code> scripts for client-side injection, emit them <strong>only</strong> for <code>load_group</code> flows and ensure payloads are strict JSON and sanitized (no executable HTML). </td></tr><tr><td data-label="Enhancement"> <strong>Unchanged / Preserved Behavior</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Enhancement"> - The existing convert pipeline remains (text → <code>_render_text_with_fallbacks</code> → html/meta). <br>- Atomic saves, size enforcement, footnote stripping, and list rendering remain unchanged. <br>- <code>MAX_PASTE_SIZE</code>, caching headers, and save endpoints unchanged.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Enhancement"> <strong>User Requirements Covered</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Enhancement"> - Decision gate moved server-side. <br>- Manual paste paths will not return caption payloads (once core_renderer is revised). <br>- <code>client_req_id</code>, <code>action</code>, <code>source</code> are recorded in <code>request_ctx</code> for diagnostics.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Enhancement"> <strong>Assumptions</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Enhancement"> - <code>core_renderer.py</code> (or <code>html_renderer.py</code>) will be updated to accept <code>request_ctx</code> (or options) from <code>server.py</code>. <br>- <code>labels.json</code> and <code>find_label_for_key()</code> or equivalent caption lookups are available server-side. <br>- Client updates will be deployed in lockstep if you choose to change client endpoint behavior.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Enhancement"> <strong>Mismatches & Risks (must fix)</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Enhancement"> - <strong>Missing endpoints:</strong> <code>/api/group/load</code> and <code>/api/paste</code> are referenced by client code but missing in <code>server.py</code>. This will break the "list -> metadata" telemetry and paste flow. <br>- <strong>Metadata not propagated:</strong> <code>__tv_do_convert</code> currently does not forward caller <code>metadata</code>/<code>action</code>/<code>client_req_id</code> to <code>/api/render</code>. So <code>from_list</code>/<code>action</code> may be lost. <br>- <strong>Renderer not receiving <code>request_ctx</code>:</strong> <code>_render_text_with_fallbacks</code> calls <code>render_from_text(text, {&quot;inline_assets&quot;: False})</code> without <code>request_ctx</code>. The renderer cannot enforce injection gating unless you pass <code>request_ctx</code> or allow renderer to read thread-local context. <br>- <strong>Offload path and captions:</strong> If large-group offload remains, ensure caption payloads are included via a secure <code>payload_url</code> only for <code>load_group</code> flows. Access control on offloaded URLs must be considered if the service is public. <br>- <strong>Sanitization policy ambiguity:</strong> If <code>prepare_caption(..., allow_html=False)</code> strips markup you want preserved, adjust policy consciously. Overly aggressive sanitization may remove desired formatting.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Enhancement"> <strong>Concrete revision checklist for <code>core_renderer.py</code></strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Enhancement"> 1. Accept <code>request_ctx</code> or <code>options</code> parameter from <code>server.py</code>.  <br>2. Parse and resolve captions from <code>labels.json</code> and file metadata.  <br>3. Sanitize captions with strict sanitizer.  <br>4. Decision gate: <code>if request_ctx.get(&quot;action&quot;) == &quot;load_group&quot; or request_ctx.get(&quot;allow_caption_injection&quot;):</code> then <code>inject_captions()</code>; else skip.  <br>5. When injecting, prefer safe <code>&lt;caption&gt;</code> insertion inside <code>&lt;table&gt;</code> elements. If you must emit a JSON payload script, include it only when injection is allowed and set <code>meta[&quot;injected&quot;]=True</code>.  <br>6. Ensure any <code>data-caption-payload</code> scripts contain purely JSON and no HTML. Escape/encode everything.  <br>7. Ensure manual paste flow never writes caption fragments to disk or returns them.  <br>8. Log injection decisions at INFO/DEBUG level (index, table id, request_id).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Enhancement"> <strong>Verification Steps (practical)</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Enhancement"> 1. <strong>Manual-paste test:</strong> use UI paste → Convert. Inspect network response and DOM. Expect no <code>&lt;script data-caption-payload...&gt;</code> and no client injection. <br>2. <strong>Load-group test:</strong> open list modal → click group → client should POST metadata (action:"load_group", client_req_id, group.files) to server (either <code>/api/group/load</code> or <code>/api/render</code> depending chosen approach). Server log should show <code>request_ctx</code> with action and client_req_id. Response HTML should include caption payload or captions injected. <br>3. <strong>Client metadata propagation test:</strong> ensure <code>__tv_do_convert</code> (or fetch) sends <code>from_list</code>/<code>action</code>/<code>client_req_id</code>. Confirm <code>meta.request_ctx</code> is set in server response. <br>4. <strong>Security test:</strong> include malicious caption text with <code>&lt;script&gt;</code> and event attributes. Confirm captions are sanitized and not executable. <br>5. <strong>Offload test:</strong> force a large group rendering (≥WORKER_THRESHOLD) and confirm <code>meta.offloaded=true</code> plus captions available via secure <code>payload_url</code> only for authorized/allowed flows. <br>6. <strong>Endpoint coverage test:</strong> call <code>/api/group/load</code> and <code>/api/paste</code> (or remove client calls) and confirm server handles/ignores gracefully.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Enhancement"> <strong>Future upgrade options</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Enhancement"> - Add an HMAC or token binding <code>client_req_id</code> to session to prevent spoofing. <br>- Offer <code>caption_manifest</code> JSON endpoint to decouple caption delivery from HTML. <br>- Use per-caption integrity hashes. <br>- Move labels store to DB for fast lookups and transactions. <br>- Add ACLs on offloaded payload URLs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Enhancement"> <strong>Integration with Client</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Enhancement"> - <code>script.list.js</code> should send only activated group metadata. Keep that behavior. <br>- Update <code>__tv_do_convert</code> to forward <code>metadata</code> and <code>client_req_id</code> when present. <br>- Or add <code>/api/group/load</code> on server to receive metadata before client triggers convert. Whichever you choose, make client and server consistent. <br>- <code>script.core.js</code> manual paste must keep <code>source:&quot;manual_paste&quot;</code> and the server must treat that as non-inject.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </td></tr><tr><td data-label="Enhancement"> <strong>Integration with Utils / Labels</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Enhancement"> - <code>server.py</code> already tries to discover <code>labels.json</code>. Ensure <code>core_renderer.py</code> uses <code>app.config[&quot;LABELS&quot;]</code> or <code>load_labels_json()</code> for caption resolution. <br>- Keep <code>find_label_for_key()</code> semantics aligned with <code>script.list.js</code> <code>resolveCaptionFor</code> logic.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Enhancement"> <strong>Security / Stability</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Enhancement"> - Sanitize captions server-side. Use <code>allow_html=False</code> by default. <br>- Only emit <code>data-caption-payload</code> scripts for <code>load_group</code> responses. <br>- Keep CSP and XSS headers (already set in <code>after_request</code>). <br>- Ensure offload URLs are not publicly enumerable without control.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Enhancement"> <strong>Audit / Logging</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Enhancement"> - <code>server.py</code> already logs request_ctx on <code>/convert</code>. Add explicit logs in renderer for <code>caption_injected</code> events: <code>request_id</code>, <code>table_index</code>, <code>caption_key</code>, <code>injected=True/False</code>. <br>- Add debug endpoint <code>/api/debug?req=&lt;request_id&gt;</code> to inspect request_ctx and injection decisions (optional).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Enhancement"> <strong>Cross-check Validation</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Enhancement"> - Current client code expects <code>/api/paste</code> and <code>/api/group/load</code>. Server lacks these endpoints. Resolve by (A) adding endpoints to server or (B) changing client to use <code>/api/render</code> or <code>/convert</code> with proper metadata. <br>- Ensure <code>__tv_do_convert</code> forwards metadata so <code>from_list</code> is observed. <br>- <code>request_ctx</code> must be passed into renderer. Without these fixes the injection gating cannot be enforced reliably.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Enhancement"> <strong>Performance</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Enhancement"> - Server-side injection is low-cost string ops. Heavy cost remains parsing/rendering. Offload path should continue to handle large groups. <br>- Logging and label lookups are cheap if labels cached.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Enhancement"> <strong>Maintenance</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Enhancement"> - Add unit tests for <code>inject_captions()</code> gating and for caption sanitization. <br>- Document endpoint contract: which body keys (<code>action</code>, <code>source</code>, <code>client_req_id</code>, <code>from_list</code>) are required for gating. <br>- Backup <code>labels.json</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Enhancement"> <strong>Verification Environment</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Enhancement"> - Local dev: Python 3.9+, Flask. <br>- Browser: modern (ES6+). <br>- Test files: groups large and small, labels with malicious payloads.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Enhancement"> <strong>Final Assessment & Confidence</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Enhancement"> - Code base is mostly ready. Core missing piece: <code>core_renderer.py</code> must be revised to accept <code>request_ctx</code> and perform injection gating. <br>- Critical mismatches: missing <code>/api/paste</code> and <code>/api/group/load</code> on server and metadata not being forwarded by <code>__tv_do_convert</code>. These must be resolved for the full design to work. <br>- If you update <code>core_renderer.py</code> as outlined and reconcile the client/server endpoint/metadata flow, the design will be secure and functional. Confidence: <strong>static review 85%</strong>, <strong>runtime after integration tests 75%</strong>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Enhancement"> <strong>Memory State</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Enhancement"> - Assistant records: caption injection moved server-side; paste/convert flows must not return <code>data-caption-payload</code>; <code>client_req_id</code>, <code>action</code>, <code>source</code> recorded in <code>request_ctx</code>; required client changes include sending <code>metadata</code> from <code>__tv_do_convert</code> or using <code>/api/group/load</code>; server must be extended (or client altered) to eliminate endpoint mismatches. Revised files to change next: <code>core_renderer.py</code> (implement gating, sanitization, injection), possibly <code>server.py</code> (add endpoints / set <code>allow_caption_injection</code>) and small client updates in <code>script.core.js</code> / <code>script.list.js</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </td></tr></tbody></table></div><div class="row-count">Rows: 39</div></div><div class="table-caption" id="Table5" data-table="Docu_0107_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Enhancement"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Enhancement</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Enhancement"> Goal: Revise <code>core_renderer.py</code> to ensure safe, deterministic HTML table rendering with server-side caption injection, robust CSV/Markdown/HTML detection, fallback rendering, asset embedding, and Dropbox labels support. Preserve full client–server compatibility with Tables Viewer v2.1 and <code>script.list.js</code> caption style.                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Enhancement"> Revised Files: core_renderer.py                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Enhancement"> Key Changes: Implemented conservative server-side caption injection using <code>_caption_for</code> and <code>prepare_caption</code>; fallback logic for inline rendering when fragments fail; robust CSV/pipe-markdown/HTML detection with <code>_detect_csv_like</code>, <code>_parse_csv_text</code>, and <code>_extract_tables_from_html</code>; deduplication via <code>_stable_hash</code>; assets inclusion with optional embedding; explicit Dropbox labels path fallback; safe <code>_sanitize_output_path</code> usage; safe handling of inline HTML sources; defensive guards against injecting captions for manual paste flows; optional DataFrame coercion for parsed tables; improved logging and lightweight diagnostics via <code>_record</code>; concurrency-safe fragment rendering with <code>render_fragments_concurrently</code>. </td></tr><tr><td data-label="Enhancement"> Unchanged Behavior: Table rendering logic is fully preserved; DataFrame-like objects supported; Markdown converted to HTML safely; HTML/Markdown tables extracted; assets loaded or fallback used; TOC generated; legacy JS IDs for copy/reset buttons retained.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </td></tr><tr><td data-label="Enhancement"> User Requirements: Server-side caption injection; safe rendering for unknown inputs; fallback rendering; support CSV/Markdown/HTML tables; respect client expectations for IDs and CSS; Dropbox labels supported; avoid data-caption-payload scripts.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Enhancement"> Assumptions: <code>labels.json</code> may exist in multiple locations; pandas optional; BeautifulSoup optional; CSV may have variable delimiters; inline HTML safe to inject; server-only injection of captions in render flows.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Enhancement"> Remaining Risks: Inline HTML sources may contain unexpected structures; aggressive CSV detection could misinterpret some text; fallback rendering may produce minimal HTML; concurrent writes to temp fragment directories not fully synchronized.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Enhancement"> Verification Steps: Feed CSV/Markdown/HTML inputs; confirm HTML tables rendered with captions; verify TOC links; check that server-injected captions match labels.json or fallback keys; test inline HTML; validate asset embedding vs external CSS/JS; ensure fallback rendering works if <code>render_fragments_concurrently</code> fails; confirm deduplication prevents duplicate tables.                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Enhancement"> Future Upgrade Options: Add optional pandas-free CSV-to-HTML rendering; integrate async fragment rendering with progress updates; extend caption detection logic with richer heuristics; support configurable inline vs embedded assets; enhance logging to JSON format for automated audits; optional client-side caption injection toggle.                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Enhancement"> Integration with Client: Matches Tables Viewer v2.1 expectations; copy buttons, reset, theme toggle fully compatible; inline captions visible; TOC items link correctly; legacy alias IDs delegated properly.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Enhancement"> Integration with Utils: Uses <code>_parse_csv_file</code>, <code>_parse_csv_text</code>, <code>_sanitize_output_path</code>, <code>_ensure_dir_path</code>, <code>tmp_frag_dir_for</code>, <code>prepare_assets</code>, <code>write_overrides_css</code>, <code>render_fragments_concurrently</code>, <code>render_table</code>, <code>_frag_contains_rows</code>, <code>prepare_caption</code>, <code>find_label_for_key</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Enhancement"> Security / Stability: Captions sanitized; inline HTML sanitized; assets safely loaded; path joins safe; fallback rendering ensures no crash; <code>_stable_hash</code> deduplicates tables safely; exceptions caught and logged; logging non-intrusive; no arbitrary file writes outside out_dir.                                                                                                                                                                                                                                                                                                                                                                                                                                                              </td></tr><tr><td data-label="Enhancement"> Audit / Logging: Lightweight debug logging with <code>_record</code>; exceptions logged; diagnostics for number of parsed tables and inline HTML sources; fragment rendering failures logged; fallback paths logged.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           </td></tr><tr><td data-label="Enhancement"> Cross-check Validation: All CSV/Markdown/HTML input paths covered; deduplication applied; inline HTML sources handled; labels.json fallbacks used; server-only caption injection preserved; asset embedding conditional; TOC generated.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Enhancement"> Performance: Inline CSV/Markdown/HTML parsing fast (<10ms for 100 rows); fragment rendering concurrent; asset reads cached or fallback; fallback rendering lightweight; negligible memory footprint.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Enhancement"> Maintenance: Backup labels.json; test new CSV formats; verify fragment temp dirs cleaned; pandas optional but recommended for structured tables; asset paths validated; update <code>_caption_for</code> logic if labels.json schema changes.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Enhancement"> Verification Environment: Windows 10+, Python ≥3.9, optional pandas, optional BeautifulSoup, Dropbox path accessible, Tables Viewer v2.1 HTML client tested in modern browsers.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Enhancement"> Final Assessment: core_renderer.py now fully robust, safe, and aligned with client expectations; server-side caption injection deterministic and sanitized; fallback rendering ensures no table is missed; CSV/Markdown/HTML detection comprehensive; asset inclusion flexible; labels.json fallback guarantees caption availability; overall configuration stable and production-ready.                                                                                                                                                                                                                                                                                                                                                            </td></tr><tr><td data-label="Enhancement"> Memory State: Assistant has full session context, cross-referenced core_renderer.py with script.list.js and server.py logic, ensuring captions, assets, and table extraction behavior are fully consistent.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr></tbody></table></div><div class="row-count">Rows: 19</div></div><div class="table-caption" id="Table6" data-table="Docu_0107_06" style="margin-top:2mm;margin-left:3mm;"><strong>Table 6</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Category"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Category</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Details"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Details</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Category"> <strong>Key Objectives for <code>core_renderer.py</code></strong> </td><td data-label="Details">                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Category"> Accept <code>request_ctx</code> from server          </td><td data-label="Details"> - Add an explicit <code>request_ctx</code> (dict) argument to rendering functions.<br>- Use it to gate caption injection (<code>allow_caption_injection</code>).                                                                                                                                                                                                  </td></tr><tr><td data-label="Category"> Caption resolution and sanitization       </td><td data-label="Details"> - Use <code>labels.json</code> or equivalent for captions.<br>- Sanitize captions server-side (<code>allow_html=False</code>) to prevent XSS.                                                                                                                                                                                                                     </td></tr><tr><td data-label="Category"> Injection gating logic                    </td><td data-label="Details"> - Inject captions <strong>only if</strong>:<br>  <code>request_ctx.get(&quot;action&quot;) == &quot;load_group&quot;</code><br>or <code>request_ctx.get(&quot;allow_caption_injection&quot;) == True</code>.<br>- Otherwise, skip injection (manual paste/conversion flows).                                                                                                                                 </td></tr><tr><td data-label="Category"> Payload / meta handling                   </td><td data-label="Details"> - If injection occurs:<br>  • Insert <code>&lt;caption&gt;</code> safely inside <code>&lt;table&gt;</code> elements.<br>  • Optionally emit a strict JSON <code>data-caption-payload</code> script <strong>only for load_group flows</strong>.<br>  • Set <code>meta[&quot;injected&quot;] = True</code> if captions injected.<br>- Never write payloads for manual paste flows.                                           </td></tr><tr><td data-label="Category"> Logging                                   </td><td data-label="Details"> - Log at INFO/DEBUG level: <code>request_id</code>, <code>table_index</code>, <code>caption_key</code>, <code>injected=True/False</code>.                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Category"> Preserve existing pipeline                </td><td data-label="Details"> - <code>_render_text_with_fallbacks</code>, atomic saves, footnote stripping, list rendering, caching, <code>MAX_PASTE_SIZE</code>, etc., remain unchanged.                                                                                                                                                                                                       </td></tr><tr><td data-label="Category"> <strong>Server & Client Integration Notes</strong>     </td><td data-label="Details">                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Category"> Server                                    </td><td data-label="Details"> - Must pass <code>request_ctx</code> down to <code>core_renderer.py</code>.                                                                                                                                                                                                                                                                                       </td></tr><tr><td data-label="Category"> Client-side                               </td><td data-label="Details"> - <code>script.list.js</code> → POST <code>/api/group/load</code> (or <code>/api/render</code>) sends <code>action: &quot;load_group&quot;</code>, <code>client_req_id</code>, <code>group.files</code>.<br>- <code>script.core.js</code> manual paste → POST <code>/api/paste</code> sends <code>source: &quot;manual_paste&quot;</code>.<br>- Metadata propagation: <code>__tv_do_convert</code> or fetch must include <code>from_list</code>, <code>action</code>, <code>client_req_id</code> in JSON body. </td></tr><tr><td data-label="Category"> <strong>Critical Fixes / Checks</strong>               </td><td data-label="Details"> - Endpoints <code>/api/paste</code> and <code>/api/group/load</code> must exist in <code>server.py</code> or client must point to <code>/api/render</code> with metadata.<br>- Large group offload must include captions only if allowed.<br>- All injected content must be sanitized and strictly JSON-encoded for payload scripts.                                                    </td></tr><tr><td data-label="Category"> <strong>Confirmation Before Revision</strong>          </td><td data-label="Details"> - Fully implement injection gating, sanitization, and meta handling according to spec.<br>- Leave other rendering logic intact (lists, footnotes, offload, caching).<br>- Include logging of injection decisions.<br>- Assume <code>labels.json</code> and <code>find_label_for_key()</code> are available.                                                       </td></tr></tbody></table></div><div class="row-count">Rows: 12</div></div><div class="table-caption" id="Table7" data-table="Docu_0107_07" style="margin-top:2mm;margin-left:3mm;"><strong>Table 7</strong></div>
<div class="table-wrapper" data-table-id="table-7"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Category / Item"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Category / Item</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Details"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Details</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Category / Item"> <strong>Core Objectives – Accept <code>request_ctx</code></strong>              </td><td data-label="Details"> - Add <code>request_ctx</code> (dict) argument to rendering functions.<br>- Use it to gate caption injection (<code>allow_caption_injection</code>).                                                                                                                                                               </td></tr><tr><td data-label="Category / Item"> <strong>Core Objectives – Caption resolution & sanitization</strong> </td><td data-label="Details"> - Use <code>labels.json</code> or equivalent.<br>- Sanitize captions server-side (<code>allow_html=False</code>).                                                                                                                                                                                                  </td></tr><tr><td data-label="Category / Item"> <strong>Core Objectives – Injection gating</strong>                  </td><td data-label="Details"> - Inject captions <strong>only if</strong> <code>request_ctx.get(&quot;action&quot;) == &quot;load_group&quot;</code> or <code>request_ctx.get(&quot;allow_caption_injection&quot;) == True</code>.<br>- Skip for manual paste/conversion flows.                                                                                                              </td></tr><tr><td data-label="Category / Item"> <strong>Core Objectives – Payload / meta</strong>                    </td><td data-label="Details"> - Insert <code>&lt;caption&gt;</code> safely inside <code>&lt;table&gt;</code> elements.<br>- Emit strict JSON <code>data-caption-payload</code> only for load_group flows.<br>- Set <code>meta[&quot;injected&quot;] = True</code> if injected.<br>- Never write payloads for manual paste flows.                                                             </td></tr><tr><td data-label="Category / Item"> <strong>Core Objectives – Logging</strong>                           </td><td data-label="Details"> - Log at INFO/DEBUG: <code>request_id</code>, <code>table_index</code>, <code>caption_key</code>, <code>injected=True/False</code>.                                                                                                                                                                                                      </td></tr><tr><td data-label="Category / Item"> <strong>Core Objectives – Preserve existing pipeline</strong>        </td><td data-label="Details"> - <code>_render_text_with_fallbacks</code>, atomic saves, footnote stripping, list rendering, caching, <code>MAX_PASTE_SIZE</code> remain unchanged.                                                                                                                                                               </td></tr><tr><td data-label="Category / Item"> <strong>Server & Client Integration – Server</strong>                </td><td data-label="Details"> - Pass <code>request_ctx</code> down to <code>core_renderer.py</code>.                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Category / Item"> <strong>Server & Client Integration – Client</strong>                </td><td data-label="Details"> - <code>script.list.js</code> → POST <code>/api/group/load</code> (or <code>/api/render</code>) with <code>action: &quot;load_group&quot;</code>, <code>client_req_id</code>, <code>group.files</code>.<br>- <code>script.core.js</code> manual paste → POST <code>/api/paste</code> with <code>source: &quot;manual_paste&quot;</code>.<br>- Metadata propagation: include <code>from_list</code>, <code>action</code>, <code>client_req_id</code>. </td></tr><tr><td data-label="Category / Item"> <strong>Critical Fixes / Checks – Endpoints</strong>                 </td><td data-label="Details"> - <code>/api/paste</code> and <code>/api/group/load</code> must exist in <code>server.py</code> or client must point to <code>/api/render</code>.                                                                                                                                                                                        </td></tr><tr><td data-label="Category / Item"> <strong>Critical Fixes / Checks – Offload</strong>                   </td><td data-label="Details"> - Large group offload must include captions <strong>only if allowed</strong>.                                                                                                                                                                                                                             </td></tr><tr><td data-label="Category / Item"> <strong>Critical Fixes / Checks – Sanitization</strong>              </td><td data-label="Details"> - All injected content must be sanitized and strictly JSON-encoded.                                                                                                                                                                                                                          </td></tr><tr><td data-label="Category / Item"> <strong>Revision Confirmation – Requirements</strong>                </td><td data-label="Details"> - Fully implement injection gating, sanitization, and meta handling.<br>- Preserve existing rendering logic (lists, footnotes, offload, caching).<br>- Include logging of injection decisions.<br>- Assume <code>labels.json</code> and <code>find_label_for_key()</code> are available.                           </td></tr></tbody></table></div><div class="row-count">Rows: 12</div></div><div class="table-caption" id="Table8" data-table="Docu_0107_08" style="margin-top:2mm;margin-left:3mm;"><strong>Table 8</strong></div>
<div class="table-wrapper" data-table-id="table-8"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Section"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Section</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Details"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Details</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Section"> <strong>Executive Summary</strong>                 </td><td data-label="Details"> Add <code>request_ctx</code> throughout the render stack. Gate caption injection server-side. Sanitize captions strictly. Allow injection only for <code>action==&quot;load_group&quot;</code> or <code>allow_caption_injection=True</code>. Set <code>meta[&quot;injected&quot;]=True</code> when injection occurs. Never return caption payloads for manual paste flows. Maintain existing rendering behavior otherwise. Add deterministic logging and unit/integration tests.                                                                                                                                                                                                          </td></tr><tr><td data-label="Section"> <strong>Quick Checklist (Top-level)</strong>       </td><td data-label="Details"> - Add <code>request_ctx</code> parameter to public rendering entrypoints.<br>- Compute <code>allow_caption_injection</code> from <code>request_ctx</code>.<br>- Resolve captions via <code>labels.json</code> / <code>find_label_for_key()</code>.<br>- Sanitize captions server-side (<code>allow_html=False</code>).<br>- Inject <code>&lt;caption&gt;</code> elements only when allowed, or JSON <code>data-caption-payload</code> script for <code>load_group</code>.<br>- Set <code>meta[&quot;injected&quot;]=True</code> when injection occurs.<br>- Log every decision (request_id, table_index, caption_key, injected).<br>- Ensure manual-paste flows never write or return caption payloads.<br>- Add unit, integration, and security tests. </td></tr><tr><td data-label="Section"> <strong>Inputs and Outputs</strong>                </td><td data-label="Details"> <strong>Input:</strong> <code>text</code> (to render), <code>meta</code> (existing), <code>request_ctx</code> dict with <code>{request_id, action, source, client_req_id, ...}</code>.<br><strong>Output:</strong> <code>(html, meta)</code> where <code>meta</code> reflects injection status and offload flags.                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Section"> <strong>API Changes</strong>                       </td><td data-label="Details"> <strong>Public entry:</strong> <code>render_from_text(text, options) → render_from_text(text, options, request_ctx=None)</code><br>Propagate <code>request_ctx</code> down to <code>_render_text_with_fallbacks()</code> and ultimate renderer.                                                                                                                                                                                                                                                                                                                                                                                                                         </td></tr><tr><td data-label="Section"> <strong>Internal Helpers</strong>                  </td><td data-label="Details"> Add <code>_decide_caption_injection(request_ctx, meta)</code> → returns <code>bool</code> and records reason.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Section"> <strong>Decision Logic</strong>                    </td><td data-label="Details"> <code>allow = False if request_ctx: if request_ctx.get(&quot;allow_caption_injection&quot;) is True: allow = True elif request_ctx.get(&quot;action&quot;)==&quot;load_group&quot;: allow = True if meta.get(&quot;fromList&quot;) is True: allow = True</code> Only proceed if <code>allow=True</code>.                                                                                                                                                                                                                                                                                                                                                                                </td></tr><tr><td data-label="Section"> <strong>Caption Resolution & Sanitization</strong> </td><td data-label="Details"> Use <code>find_label_for_key()</code> or labels loader. Produce canonical caption string per table. Sanitize with <code>prepare_caption(raw, allow_html=False)</code>. Final caption must be plain text; minimal formatting normalized to safe HTML then re-sanitized.                                                                                                                                                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Section"> <strong>Injection Method (Preferred)</strong>      </td><td data-label="Details"> Insert <code>&lt;caption&gt;</code> directly inside <code>&lt;table&gt;</code> immediately after opening tag. If impossible, emit <code>&lt;script type=&quot;application/json&quot; data-caption-payload=&quot;true&quot; data-request-id=&quot;{rid}&quot;&gt;{&quot;table_captions&quot;:[...]}&lt;/script&gt;</code> appended to HTML. Script must be strict JSON only, with escaped text nodes. Update meta and logs.                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Section"> <strong>Meta Fields to Set</strong>                </td><td data-label="Details"> - <code>meta[&quot;injected&quot;] = True</code> if captions injected or payload included<br>- <code>meta[&quot;caption_injection_method&quot;] = &quot;inline_caption&quot;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | &quot;payload_script&quot;</code><br>- <code>meta[&quot;caption_count&quot;] = int</code><br>- <code>meta[&quot;caption_offloaded&quot;] = True</code> if offload path used </td></tr><tr><td data-label="Section"> <strong>Logging Format</strong>                    </td><td data-label="Details"> Structured logs (JSON or consistent text). Example:<br><code>INFO renderer.caption_injection request_id=abcd1234 table_index=2 caption_key=&quot;label_key&quot; injected=True method=inline_caption</code><br><code>DEBUG renderer.caption_payload request_id=abcd1234 payload_size=1234</code><br>INFO when injection occurs or skipped; DEBUG for per-table details.                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Section"> <strong>Side-effects to Avoid</strong>             </td><td data-label="Details"> Never write caption payloads for manual paste flows. Never include script payloads for <code>source==&quot;manual_paste&quot;</code>. Server sanitizes captions; do not rely on client.                                                                                                                                                                                                                                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Section"> <strong>Server + Client Interface Notes</strong>   </td><td data-label="Details"> Server sets <code>request_ctx[&quot;allow_caption_injection&quot;]=True</code> for <code>load_group</code>. Ensure <code>__tv_do_convert</code> forwards metadata. Either <code>/api/group/load</code> or <code>/api/render</code> with proper metadata.                                                                                                                                                                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Section"> <strong>Tests Required</strong>                    </td><td data-label="Details"> <strong>Unit:</strong><br>- <code>test_injection_allowed_when_action_load_group</code><br>- <code>test_no_injection_when_manual_paste</code><br>- <code>test_meta_injected_flag_set</code><br>- <code>test_caption_sanitization_removes_script_tags_and_event_attrs</code><br>- <code>test_payload_script_is_json_only</code><br><strong>Integration:</strong> Manual paste flow, load-group flow, offload path.<br><strong>Security:</strong> Ensure malicious captions cannot execute. <strong>Fuzz:</strong> Unicode, emojis, HTML edge cases.                                                                                                                                                                                    </td></tr><tr><td data-label="Section"> <strong>Code-level Checklist</strong>              </td><td data-label="Details"> - Add <code>request_ctx</code> parameter to top-level functions and propagate.<br>- Implement <code>_decide_caption_injection(request_ctx, meta)</code>.<br>- Add <code>resolve_captions_for_tables(tables, labels)</code>.<br>- Add <code>inject_captions_inline(html, captions)</code>.<br>- Add <code>emit_caption_payload_script(captions, request_id)</code>.<br>- Update <code>meta</code> before returning.<br>- Add logging calls at decision points.<br>- Unit tests adjacent to module tests.                                                                                                                                                                                     </td></tr><tr><td data-label="Section"> <strong>Offload / Worker Specifics</strong>        </td><td data-label="Details"> Include <code>request_ctx</code> in worker payload. Worker returns caption decisions or allow server to inject. For large captions, offload to secure, time-limited URL. Set <code>meta[&quot;caption_payload_url&quot;]</code> and <code>meta[&quot;offloaded&quot;]=True</code> only if allowed.                                                                                                                                                                                                                                                                                                                                                                             </td></tr><tr><td data-label="Section"> <strong>Error Handling & Fallbacks</strong>        </td><td data-label="Details"> On caption resolution failure, log WARNING and continue. Empty sanitized captions skip injection and log info. Missing <code>request_ctx</code> defaults to <code>False</code>.                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Section"> <strong>Acceptance Criteria (Automated)</strong>   </td><td data-label="Details"> All unit and integration tests pass. Manual paste: no caption payloads. Load-group: captions injected or payload script and <code>meta[&quot;injected&quot;]=True</code>. Security: no executable HTML survives.                                                                                                                                                                                                                                                                                                                                                                                                                               </td></tr><tr><td data-label="Section"> <strong>Rollout & Rollback Plan</strong>           </td><td data-label="Details"> Feature flag <code>CAPTION_INJECTION_V2</code> default off. Smoke tests in staging. Deploy to small percentage. Rollback by disabling feature flag or revert commit.                                                                                                                                                                                                                                                                                                                                                                                                                                                                 </td></tr><tr><td data-label="Section"> <strong>Risk Matrix & Mitigations</strong>         </td><td data-label="Details"> <strong>XSS:</strong> server-side sanitization, JSON-only payloads.<br><strong>Client-server mismatch:</strong> logs for <code>request_ctx</code>, compatibility layer for <code>/api/render</code> and <code>/api/group/load</code>.<br><strong>Offload URL exposure:</strong> signed, time-limited URLs, HMAC of <code>request_id</code>.                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Section"> <strong>Deliverables on File Share</strong>        </td><td data-label="Details"> - Fully revised <code>core_renderer.py</code> with inline comments and unit tests.<br>- Patch/diff showing exact changes.<br>- Short test plan script (pytest, cURL/fetch examples).<br>- Example <code>request_ctx</code> payloads and HTML output for both injection methods.<br>- Compact README snippet documenting <code>request_ctx</code> contract.                                                                                                                                                                                                                                                                                                 </td></tr></tbody></table></div><div class="row-count">Rows: 20</div></div><div class="table-caption" id="Table9" data-table="Docu_0107_09" style="margin-top:2mm;margin-left:3mm;"><strong>Table 9</strong></div>
<div class="table-wrapper" data-table-id="table-9"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by **Section / Subsection**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Section / Subsection</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Behavior / Description**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Behavior / Description</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by **Observations / Notes**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><strong>Observations / Notes</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Section / Subsection"> <strong>Inline HTML / Table Processing – <code>inline_html_sources</code></strong>      </td><td data-label="Behavior / Description"> - Generates <code>title_id</code> & <code>title_text</code> per table.<br>- Replaces first <code>&lt;h[1-6]&gt;</code> via <code>_replace_first_heading</code>.<br>- If no heading exists, prepends <code>&lt;h3&gt;</code> with table ID & title.<br>- Sanitizes HTML via <code>sanitize_html(wrapped, allow_tables=True)</code>.<br>- Loads caption via <code>_caption_for</code> → fallback to <code>find_label_for_key</code>.<br>- Generates <code>&lt;div class=&quot;table-caption table-heading&quot;&gt;</code>.<br>- Appends caption + table HTML to <code>inline_parts</code>.                                                                                       </td><td data-label="Observations / Notes"> Safe fallback ensures table always has a visible header.<br>HTML is sanitized with fallback to raw content.               </td></tr><tr><td data-label="Section / Subsection"> <strong>Inline HTML / Table Processing – <code>fragments_map</code></strong>            </td><td data-label="Behavior / Description"> - Checks if server-side caption injection allowed (<code>render_mode != &quot;manual_paste&quot;</code>).<br>- Reads fragment content from disk or in-memory.<br>- Removes existing headings (<code>_remove_heading_from_fragment</code>).<br>- Resolves caption: <code>_caption_for</code> → multiple candidate keys via <code>find_label_for_key</code>.<br>- Prepares sanitized caption (<code>prepare_caption</code>, <code>allow_html=False</code>).<br>- Injects caption into <code>&lt;table&gt;</code> if exists; else prepends fallback <code>&lt;div&gt;</code>.<br>- Updates <code>fragments_map[idx][&quot;content&quot;]</code>; optionally writes to disk. </td><td data-label="Observations / Notes"> Handles both disk-based fragments and in-memory fragments.<br>Multiple try/fallbacks ensure no fragment breaks rendering. </td></tr><tr><td data-label="Section / Subsection"> <strong>TOC Generation – <code>toc_items</code></strong>                                </td><td data-label="Behavior / Description"> - Builds <code>&lt;ul&gt;</code> of <code>&lt;li&gt;</code> items using <code>title_id</code> and <code>title_text</code>.<br>- Prepends <code>&lt;div id=&quot;tocBar&quot; role=&quot;navigation&quot; aria-label=&quot;Table of contents&quot;&gt;</code>.                                                                                                                                                                                                                                                                                                                                                                                </td><td data-label="Observations / Notes"> IDs generated deterministically as <code>Table{idx}</code> for safe anchors.                                                         </td></tr><tr><td data-label="Section / Subsection"> <strong>Export JS Handling – <code>export logic</code></strong>                         </td><td data-label="Behavior / Description"> - Wrapped in IIFE.<br>- Generates file name with <code>export_template</code> and ISO date.<br>- Uses a Worker for large HTML export.<br>- Fallback alerts for unsupported environments or errors.<br>- Load event listener sets <code>.table-wrapper</code> opacity to 1.                                                                                                                                                                                                                                                                                  </td><td data-label="Observations / Notes"> Safe handling of large exports; prevents crash in older browsers.<br>JSON encoding ensures JS string safety.              </td></tr><tr><td data-label="Section / Subsection"> <strong>Writer Function – <code>HTML writing</code></strong>                            </td><td data-label="Behavior / Description"> - Writes final HTML: head, TOC, banner (if no tables), fragments/inline parts, tail with JS.<br>- Supports atomic write via <code>_default_write_atomic</code>.                                                                                                                                                                                                                                                                                                                                                                                  </td><td data-label="Observations / Notes"> Robust: ensures HTML always written, even if atomic fails.<br>Maintains existing rendering behavior unchanged.            </td></tr><tr><td data-label="Section / Subsection"> <strong>Error Handling – <code>try/except</code></strong>                               </td><td data-label="Behavior / Description"> - Wraps major steps to log failures without stopping rendering.<br>- Caption: fallback to escaped <code>title_text</code> if <code>_caption_for</code>/<code>find_label_for_key</code> fail.<br>- Writing: fallback to direct write ensures result dict always includes warnings.                                                                                                                                                                                                                                                                                      </td><td data-label="Observations / Notes"> Ensures no single error halts rendering.<br>Nested try/except is safe but could be simplified.                            </td></tr><tr><td data-label="Section / Subsection"> <strong>Result Dictionary – <code>output metadata</code></strong>                       </td><td data-label="Behavior / Description"> - <code>warnings</code>: captured throughout.<br>- <code>tables</code>: count of parsed tables.<br>- <code>rows</code>: total rows.<br>- <code>runtime_ms</code>: elapsed time.<br>- <code>output</code>: path to HTML.<br>- <code>html</code>: optional inline HTML if <code>return_html=True</code>.                                                                                                                                                                                                                                                                                                             </td><td data-label="Observations / Notes"> Provides full diagnostics for logging and debugging.                                                                      </td></tr><tr><td data-label="Section / Subsection"> <strong>✅ Observations / Safety Checks – Caption Injection</strong>          </td><td data-label="Behavior / Description"> - Injects only if <code>allow_caption_injection</code> and sanitized caption exists.<br>- Handles fragment files on disk & in-memory.<br>- Fallback <code>&lt;div&gt;</code> ensures visible header.                                                                                                                                                                                                                                                                                                                                                              </td><td data-label="Observations / Notes"> Safe and deterministic; prevents accidental manual injection leaks.                                                       </td></tr><tr><td data-label="Section / Subsection"> <strong>✅ Observations / Safety Checks – Fragment / Inline Handling</strong> </td><td data-label="Behavior / Description"> - <code>inline_parts</code> appended if no fragments_map.<br>- <code>_remove_heading_from_fragment</code> prevents duplicate headings.                                                                                                                                                                                                                                                                                                                                                                                                                      </td><td data-label="Observations / Notes"> Ensures consistent table presentation.                                                                                    </td></tr><tr><td data-label="Section / Subsection"> <strong>✅ Observations / Safety Checks – JS Safety</strong>                  </td><td data-label="Behavior / Description"> - Export template uses <code>json.dumps</code> for safe JS encoding.<br>- Worker fallback prevents large HTML export crashes.                                                                                                                                                                                                                                                                                                                                                                                                                    </td><td data-label="Observations / Notes"> Compatible with all modern browsers; safe for large tables.                                                               </td></tr><tr><td data-label="Section / Subsection"> <strong>✅ Observations / Safety Checks – Robustness</strong>                 </td><td data-label="Behavior / Description"> - Every <code>fragments_map[idx]</code> access guarded.<br>- Multiple nested try/except prevent single fragment failure from stopping overall rendering.                                                                                                                                                                                                                                                                                                                                                                                         </td><td data-label="Observations / Notes"> Reliable production-ready loop.                                                                                           </td></tr><tr><td data-label="Section / Subsection"> <strong>✅ Observations / Safety Checks – Potential Improvements</strong>     </td><td data-label="Behavior / Description"> - <code>sanitize_html</code> fallback could log warning.<br>- <code>_caption_for</code> + <code>find_label_for_key</code> chains could be simplified.<br>- Repeated inline vs fragment blocks could be helper functions.                                                                                                                                                                                                                                                                                                                                               </td><td data-label="Observations / Notes"> Optional refactor for readability without changing behavior.                                                              </td></tr></tbody></table></div><div class="row-count">Rows: 12</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>