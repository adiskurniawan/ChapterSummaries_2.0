<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1767517997">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#Table6">Table 6</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0096_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>File-level summary (expanded)</strong><br><br>This module manages a persistent, interactive “Saved groups / file list” modal for PasteToTable. It builds grouped rows of saved files, presents search results, supports progressive scoring via an <code>engine</code> abstraction, fetches file contents with timeout-safe logic, loads files sequentially into the paste area, and triggers conversion. It is defensive, written to survive partial environments (missing DOM nodes, missing fetch features) and exposes lifecycle hooks (modal <code>close</code> override, <code>presentGroupsOnly</code>) so host pages may integrate. Focus is reliability and UX polish (toasts, focus management, retries) rather than raw performance. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Primary responsibilities</strong><br><br>• Resolve live files from configured endpoints and labels.<br>• Build and present a modal with grouped file rows and per-file click handlers.<br>• Provide search with async scoring, highlight and fallback search.<br>• Fetch file text with abort + timeout and robust error handling.<br>• Load selected files sequentially into the paste textarea or page area and invoke renderer hooks.<br>• Apply runtime captions to headings after injection and retry until DOM stabilizes. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Key exported/attached functions & handles</strong><br><br>• <code>presentGroupsOnly(groups, descriptions)</code> — builds modal with given groups and immediately presents it. Designed to accept pre-built normalized groups.<br>• <code>buildAndPresent()</code> — fetches live files, labels and descriptions, converts to groups and calls <code>presentGroupsOnly</code>.<br>• <code>attachListHandler()</code> — finds the configured list button and attaches click handler that calls <code>buildAndPresent()</code>.<br>• <code>fetchFileWithTimeout(url, timeoutMs)</code> — fetch wrapper with optional AbortController and timeout promise handling.<br>• <code>loadFilesSequentialAndHideForm(listOfFiles)</code> — fetches files sequentially, constructs the combined raw/marked payloads, writes them into the paste area and triggers conversion. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Control flow overview</strong><br><br>1. <code>attachListHandler()</code> attaches a click listener to the element with id <code>LIST_BTN_ID</code>.<br>2. User clicks, <code>buildAndPresent()</code> runs: fetches live files, descriptions, and labels via <code>fetchLiveFilesSequential</code>, <code>loadGroupDescriptions</code>, <code>loadLabels</code> and then normalizes into <code>groups</code>.<br>3. <code>presentGroupsOnly</code> creates a modal, lays out groups into <code>groupControls</code> and wires search handlers.<br>4. Search uses <code>engine.candidatesForQuery()</code> then <code>engine.scoreFiles()</code> returning promises. If scoring fails a local simple fallback (haystack <code>indexOf</code>) runs.<br>5. Clicking a file row calls <code>loadFilesSequentialAndHideForm(single)</code> which uses <code>fetchFileWithTimeout</code> for each file and appends results to the paste textarea, then invokes converter hooks. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Data structures: groups and groupControls</strong><br><br>• <code>groupMap</code> — array of group descriptors <code>{ title, id, files: [...] }</code> normalized for rendering.<br>• <code>groupControls</code> — runtime UI control objects created by <code>createGroupRowForRender(index, files, q)</code> that contain <code>rowWrap</code>, <code>fileList</code>, <code>toggleBtn</code>, <code>visible</code>, <code>expanded</code>, and <code>rowWrap</code> DOM nodes; used to maintain state and to drive UI updates efficiently instead of re-building everything on each search update. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Modal UI construction details</strong><br><br><code>presentGroupsOnly</code> constructs a container with header (search input, expand/collapse button, close button), and a scrollable <code>resultsWrap</code> holding <code>rowWrap</code> entries per group. Each group row contains heading, toggle control, and <code>fileList</code> which is a flex container of file rows. Accessibility: <code>aria-expanded</code>, <code>aria-pressed</code>, <code>aria-label</code> used on toggle/expand controls when possible. Focus management: <code>search.focus()</code> called after modal creation to maximize keyboard usability. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Search flow and versioning pattern</strong><br><br>Search is debounced and versioned. <code>searchVersion</code> increments on each search invocation. When asynchronous scoring resolves it compares <code>thisVersion</code> against the current <code>searchVersion</code> so stale promises bail out. This prevents race conditions where slow scoring results override more recent queries. Debounce default is 120ms but configurable via <code>debounce()</code> wrapper usage in the host shared utilities. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Scoring and fallback search</strong><br><br>Preferred path: call <code>engine.candidatesForQuery(q)</code> to get candidate indices then <code>engine.scoreFiles(q, cand)</code> returning a promise with <code>{ idx, score }[]</code>. Fallback path: perform a naive substring match across <code>engine.lite</code> entries combining <code>name</code>, <code>caption</code>, <code>path</code>, <code>full</code>. This keeps the UI usable even if search worker fails. The code restricts rendering to top N (800) results to keep UI responsive. </td></tr><tr><td data-label="Technical Breakdown"> <strong>File fetch semantics & timeout handling</strong><br><br><code>fetchFileWithTimeout(url, timeoutMs)</code> uses <code>AbortController</code> when available and a <code>setTimeout</code> to abort after <code>timeoutMs</code> (configurable via <code>FILE_FETCH_TIMEOUT_MS</code>). It sets fetch options <code>{ cache: &#x27;no-store&#x27;, credentials: &#x27;same-origin&#x27; }</code> to avoid caching surprises. Errors propagate as rejected promises with <code>Error(&#x27;HTTP &#x27; + status)</code> for non-ok responses. All branches clear the timer. If <code>AbortController</code> is missing, the function still works but without abort. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Sequential load logic (robustness)</strong><br><br<code>loadFilesSequentialAndHideForm(listOfFiles)</code>:<code>&lt;br&gt;• Processes </code>listOfFiles<code> in order using a </code>next()<code> loop and short </code>setTimeout<code> delays between items (60ms) to keep UI thread responsive.&lt;br&gt;• Builds </code>accRaw<code> (plain text) and </code>accMarked<code> (with </code><!-- caption: --><code> and </code>### Title<code> headings for marked conversions).&lt;br&gt;• If caption supplied uses </code>sanitizeCaptionForInjection<code> and </code>safeMarkdownHeading<code> to prevent injection and produce a markdown heading.&lt;br&gt;• After all files loaded writes combinedRaw to </code>#paste<code> or </code>#page-area<code>, sets </code>window.<strong>tv_last_source<code> and timestamp, then calls conversion hooks (</code></strong>tv_do_convert<code>, </code>convert<code>, or fallback hidden convert </code><strong>ptt_hidden_convert<code>).&lt;br&gt;• After injection tries to apply runtime captions to actual DOM nodes using </code>applyRuntimeCaptions<code> which retries until success or maxRetries to allow downstream renderers to hydrate.   **Caption application logic**&lt;br&gt;&lt;br&gt;</code>applyRuntimeCaptions<code> finds </code>.table-caption<code> or header nodes and pairs them to </code>runtimeCaptions<code>. Matching logic uses an id scheme </code>TableN<code> fallback and tries to detect headings like </code>Table 1<code>. It uses repeated </code>setTimeout<code> ticks (intervalMs default 160, maxRetries default 120) to wait for consumer renderers to add heading nodes. When a caption is applied it sets node innerHTML to </code><strong>${escaped}</strong><code> and sets id for heading nodes if missing. This approach tolerates slow third-party renderers that work asynchronously.   **Safety &amp; sanitization responsibilities**&lt;br&gt;&lt;br&gt;Sanitization is conservative: </code>sanitizeCaptionForInjection<code> removes HTML comments and </code><script><code> tags, strips all tags, and then uses </code>escapeHtml<code> before placing caption into HTML comment or markdown. This prevents accidental script injection in the caption fields. The module avoids inserting raw fetched file contents into the DOM without passing through existing conversion hooks (the conversion step is required to generate HTML from markdown safely).   **User feedback &amp; toast integration**&lt;br&gt;&lt;br&gt;UI status updates use </code>updateStatus<code> and </code>showToast<code> (when available) to notify success/failure: examples &#x27;Fetching X file(s)...&#x27;, &#x27;Loaded N file(s) into paste area.&#x27;, and &#x27;Caption application timed out&#x27;. The code attempts to call </code>window.showToast<code> if present in the host page. Toasts are non-blocking.   **Performance guards**&lt;br&gt;&lt;br&gt;• Limits top results to 800 to avoid DOM bloat. &lt;br&gt;• Introduces small delays (40–120ms) between sequential fetch operations to avoid saturating network/CPU. &lt;br&gt;• Uses </code>resultsWrap.innerHTML = ''<code> and per-group </code>fileList.innerHTML = ''<code> to clear and reuse nodes rather than rebuilding entire modal. &lt;br&gt;• </code>presentGroupsOnly<code> caches </code>groupControls<code> to avoid re-allocating DOM nodes repeatedly while still re-rendering file lists on search.   **Error handling and debugging**&lt;br&gt;&lt;br&gt;Most catch blocks call </code>dbg('message', e)<code> where </code>dbg<code> is a host-level debug function if present (non-fatal). Critical errors update status text and sometimes call </code>console.warn<code>. The code never throws to the caller for UI-level failures; instead it falls back or shows user-facing messages. This keeps the host page resilient.   **Accessibility considerations**&lt;br&gt;&lt;br&gt;• Uses </code>aria-expanded<code> and </code>aria-pressed<code> on expand/collapse controls. &lt;br&gt;• Sets focus to search input on modal open. &lt;br&gt;• Uses </code>role="link"<code> on generated anchor-like elements inside TOC and file rows for assistive tech. &lt;br&gt;• Adds </code>aria-hidden<code> for hidden textarea fallback. &lt;br&gt;Improvements: add keyboard-only navigation between file rows and better </code>aria-live<code> announcements for search result counts.   **Integration points for host apps**&lt;br&gt;&lt;br&gt;Host can override/extend behavior by providing these globals or functions:&lt;br&gt;• </code>engine<code> object with </code>candidatesForQuery<code>, </code>scoreFiles<code> (promise), </code>lite<code> array for fallback. &lt;br&gt;• </code>fetchLiveFilesSequential<code>, </code>loadGroupDescriptions<code>, </code>loadLabels<code> — the buildAndPresent calls them and expects </code>{ ok, data }<code> shapes. &lt;br&gt;• </code>window.</strong>tv_do_convert<code> or </code>window.convert<code> — conversion hooks called after paste injection. &lt;br&gt;• </code>window.showToast<code> and </code>dbg<code> for messaging and debugging. &lt;br&gt;• Modal creation helper </code>createModal(container, title)<code> returning handle with </code>close<code> method.   **Edge cases handled**&lt;br&gt;&lt;br&gt;• Missing </code>AbortController<code> gracefully falls back to non-abortible fetch. &lt;br&gt;• Slow or failing scoring resolves to fallback substring search. &lt;br&gt;• Missing paste area writes to </code>#page-area<code> instead. &lt;br&gt;• Duplicate default captions de-duplicated in </code>runtimeCaptions<code>. &lt;br&gt;• Large number of files truncated by </code>MAX_LIST_ITEMS<code> or </code>MAX_LIST_ITEMS<code> used upstream.   **Potential failure modes &amp; mitigations**&lt;br&gt;&lt;br&gt;• If </code>engine.scoreFiles<code> never resolves UI remains waiting; mitigation: versioning prevents stale updates, but consider adding a scoring timeout fallback. &lt;br&gt;• Fetch aborts could leave partially loaded content in </code>accMarked<code> — but sequential loading uses note comments (</code><!-- failed to fetch: ... --><code>) to surface failures to user. &lt;br&gt;• If conversion hooks are missing the code will still place content into hidden textarea and set </code>window.<strong>ptt_hidden_convert<code> so manual conversion or host scripts can pick it up.   **Testing checklist**&lt;br&gt;&lt;br&gt;1. Click flow: attachListHandler -&gt; buildAndPresent -&gt; modal shows and search input focused. &lt;br&gt;2. Search cancellation: issue 3 rapid queries. Ensure only latest result rendered. &lt;br&gt;3. Fetch timeout: simulate slow server and verify abort occurs and error comment appended. &lt;br&gt;4. Sequential load: pick 3 files and verify </code>paste<code> receives combined text and </code>window.</strong>tv_last_source<code> set. &lt;br&gt;5. Caption application: ensure runtime captions are applied to </code>h1/h2<code> or </code>.table-caption<code> nodes and that retry mechanism halts on success.   **Observability &amp; metrics to add**&lt;br&gt;&lt;br&gt;• </code>modal.open.count<code> and </code>modal.open.duration.ms<code> &lt;br&gt;• </code>search.query.latency.ms<code> (time from input -&gt; final render) &lt;br&gt;• </code>fetchFile.duration.ms<code> per URL and </code>fetchFile.aborts<code> count &lt;br&gt;• </code>loadFilesSequential.items<code> and </code>loadFilesSequential.failures<code> &lt;br&gt;Collect these for performance regression detection.   **Refactor opportunities**&lt;br&gt;&lt;br&gt;• Extract search rendering into smaller pure functions for easier unit testing. &lt;br&gt;• Replace </code>innerHTML<code> mass DOM operations with </code>DocumentFragment<code> builds to reduce layout thrash for huge groups. &lt;br&gt;• Add a scoring timeout wrapper so </code>engine.scoreFiles<code> failure mode is always bounded. &lt;br&gt;• Centralize DOM utilities (</code>createRow<code>, </code>createFileRow<code>) to reduce repeated style-setting code.   **Security considerations**&lt;br&gt;&lt;br&gt;• Never trust fetched text. The module writes raw fetched text only into textarea or hidden element and relies on downstream conversion to produce DOM HTML. Host must ensure conversion sanitizes HTML before insertion into </code>tables-viewer<code> via </code><strong>tv_do_convert<code> hook. &lt;br&gt;• Captions are sanitized before injection. &lt;br&gt;• Avoid storing sensitive content in attributes; use hidden script areas or server-side storage for large or sensitive payloads.   **Backward compatibility notes**&lt;br&gt;&lt;br&gt;• Designed to tolerate missing features: </code>AbortController<code>, </code>window.convert<code>, </code>engine<code>. &lt;br&gt;• Adds non-invasive </code>dataset<code> flags on elements to avoid re-binding handlers (</code></strong>ptt_list_attached<code>, </code>__tv_convert_attached<code>, etc.). &lt;br&gt;• Modal </code>close<code> override ensures engine </code>dispose<code> will be called if present which prevents leaked workers or event listeners.   **Actionable hardening changes before prod**&lt;br&gt;&lt;br&gt;1. Add bounded timeout to </code>engine.scoreFiles<code> calls. &lt;br&gt;2. Use </code>DocumentFragment<code> when appending many </code>ctrl.rowWrap<code> elements. &lt;br&gt;3. Implement keyboard navigation and announce result counts in </code>aria-live<code>. &lt;br&gt;4. Improve fetch retry/backoff policy for flaky endpoints.   **Short-term roadmap (next 2 weeks)**&lt;br&gt;&lt;br&gt;• Add unit tests for </code>fetchFileWithTimeout` using fake timers. <br>• Introduce scoring timeout wrapper. <br>• Convert append-heavy DOM writes to fragment-based batching. <br>• Add telemetry hooks and counters. </td></tr></tbody></table></div><div class="row-count">Rows: 10</div></div><div class="table-caption" id="Table2" data-table="Docu_0096_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>File-level summary (expanded)</strong><br><br><code>script.table.js</code> is a resilient, client-side toolkit that enriches HTML tables with search, highlight, copy, export, TOC, and UI controls. It is built for progressive enhancement and maximum compatibility. It detects existing helper utilities on <code>window</code> (e.g., <code>tvUtils</code>, <code>PTToc</code>, <code>PasteToTable</code>) and uses them when present. It has conservative fallbacks for clipboard, file download, and SheetJS usage. The code favors DOM-safe string handling and incremental DOM mutation rather than wholesale DOM replacement. It is defensive: every public feature is wrapped in try/catch and guarded by feature detection. The file targets web apps that render Markdown → HTML tables and need lightweight client interactivity without heavy frameworks. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Runtime configuration and entrypoints</strong><br><br>Key runtime config objects and entry points:<br><br>• <code>window.tvConfig</code> — default <code>{ highlight: true, debounceMs: 150, chunkSize: 300 }</code>. Controls highlight toggle and debounce delays. Can be extended by <code>setTvSearchConfig()</code>.<br>• <code>window.__tv_base</code>, <code>window.tvIndexUrl</code>, <code>window.tvWorkerUrl</code> — base paths for extra assets, index and worker URLs. Determined by <code>detectScriptBase()</code> and <code>ensureIndexAndWorkerAttrs()</code>.<br>• Public methods exposed: <code>window.copyTableMarkdown</code>, <code>window.copyTablePlain</code>, <code>window.exportTableCSV</code>, <code>window.exportTableJSON</code>, <code>window.exportTableXLSX</code>, <code>window.exportTablePDF</code>, <code>window.exportAllBtnHandler</code>, <code>window.searchTable</code>, <code>window.toggleTable</code>, <code>window.toggleAllTables</code>, <code>window.backToTop</code>, <code>window.__tv_do_convert</code> and <code>window.PasteToTable.processRenderedHtml</code> (process hook). These are the API surface for integration. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Feature-detection & progressive enhancement</strong><br><br>The script uses feature detection widely: <code>navigator.clipboard</code>, <code>MutationObserver</code>, <code>URL</code>, <code>AbortController</code>, <code>XLSX</code> availability (SheetJS), and existing helper <code>window.tvUtils</code>. If a capability is missing, it falls back to conservative alternatives (execCommand copy fallback, TSV for XLSX fallback, open-print for PDF). This ensures UX continuity on older browsers or restricted environments. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Utility functions and shared helpers (concise)</strong><br><br>Important helpers:<br>• <code>safe(fn)</code> — executes function and returns <code>undefined</code> on exception. Used to avoid bubbling errors.<br>• <code>isString(x)</code> — string type check.<br>• <code>joinUrl(base, rel)</code> — URL joining robust to missing slashes.<br>• <code>debounce(fn, wait)</code> — local fallback that defers calls; prefers <code>Shared.debounce</code> when available.<br>• <code>copyToClipboard</code>, <code>downloadBlob</code>, <code>showToast</code> — delegated to <code>window.tvUtils</code> when present, otherwise local fallbacks (execCommand and link-click).<br>• <code>sanitizeFileName(name)</code> — removes filesystem-invalid characters. Delegates to <code>tvUtils.sanitizeFileName</code> when present. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Search & highlight pipeline (core algorithm)</strong><br><br><code>searchTable()</code> performs table search and optional highlighting with these stages:<br>1. Read raw input <code>filterRaw</code> from configured search element (IDs <code>searchBox</code>, <code>searchInput</code>, or <code>search</code>).<br>2. Normalize query via <code>normalizeForSearchLocal()</code> which: lowercases, NFD-normalizes, strips diacritics, removes non-letter/number chars, collapses whitespace. This makes search accent-insensitive and robust across locales.<br>3. Iterate <code>.table-container table</code> rows. For each cell:<br>&nbsp;&nbsp;• clear previous highlights using <code>clearHighlights(cell)</code> which restores <code>data-origHtml</code> or replaces <code>&lt;mark&gt;</code> nodes with text.<br>&nbsp;&nbsp;• decide row match by checking normalized cell text for inclusion of normalized query.<br>4. Toggle <code>row.style.display = &#x27;none&#x27;</code> for non-matching rows. Track <code>firstMatch</code> and scroll that into view.<br>5. If <code>window.tvConfig.highlight</code> is truthy call <code>highlightMatches(cell, filterNorm)</code> which performs a Unicode-aware indexed mapping from normalized characters back to text nodes and wraps matched substrings with <code>&lt;mark&gt;</code> elements. This preserves original markup as much as possible by splitting text nodes and handling multi-node matches.<br><br>Design notes: The highlight routine performs a character-to-node map to preserve complex inline markup and handle surrogate pairs correctly. It is conservative: it early-returns on empty norm strings and wraps matches right-to-left to avoid offset invalidation. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Normalization details and Unicode correctness</strong><br><br><code>normalizeForSearchLocal</code> does NFD decomposition and strips combining diacritics, then uses Unicode property classes when available (<code>\p{L}</code>/<code>\p{N}</code>) in a safe try/catch. The fallback removes <code>\W</code>-style characters. This design maximizes correctness across multi-language datasets and preserves searching behavior for accented content. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Highlight mapping algorithm (detailed)</strong><br><br>Highlights are implemented by:<br>• Walking text nodes inside a cell using <code>TreeWalker</code> and collecting nodes with non-whitespace content.<br>• Building <code>normStr</code> by decomposing each character and filtering out non-alphanum per locale rules. For each normalized character, append an entry into <code>map</code> linking back to the source node and offset.<br>• Searching <code>normStr.indexOf(needle)</code> repeatedly to locate match start positions.<br>• For each match, translating <code>map</code> indices back to node/offset spans. Then splitting text nodes and wrapping matched text in <code>&lt;mark&gt;</code> or assembling a <code>&lt;mark&gt;</code> containing multiple adjacent text nodes.<br><br>This approach correctly handles matches spanning element boundaries. It is more expensive than naive <code>innerText</code> substring matching but avoids destroying markup and preserves links/inline tags. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Row UID snapshot & sort state management</strong><br><br>Functions: <code>_ensureRowUidsAndSnapshot</code>, <code>originalRowOrders[]</code>, <code>_tv_row_uid_counter</code>. On init the script ensures each row has <code>data-tv-uid</code> for stable reordering. <code>originalRowOrders[tableIdx]</code> stores the original uid order. <code>sortStates[tableIdx]</code> stores per-column sort state (0 unsorted, 1 ascending, 2 descending). These are used to implement a 3-state sort cycle: unsorted → asc → desc → restore original order. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Sorting mechanics</strong><br><br><code>sortTableByColumn(tableIdx, colIdx)</code> performs a stable sort using these rules:<br>• Extract cell text with whitespace trimmed.<br>• Attempt numeric parse (stripping commas/whitespace). If both values parse to numbers, compare numerically. Else use <code>localeCompare</code> string compare.<br>• For descending toggle different comparator or reverse the sort.<br>• For reset (state 2 → 0) it reconstructs original order using <code>originalRowOrders</code> and <code>data-tv-uid</code> mapping.<br><br>After reordering it appends rows back into the <code>tbody</code> preserving unique DOM nodes. It also updates <code>data-origHtml</code> for cells if missing and calls <code>updateHeaderSortUI()</code> to update <code>aria-sort</code> and icon states. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Header sort UI & accessibility</strong><br><br><code>updateHeaderSortUI(tableIdx)</code> sets <code>aria-sort</code> on header cells and cycles CSS classes <code>sort-state-0/1/2</code>. Icons are inline SVG swapped based on state. This function ensures keyboard & screen reader support by setting <code>aria-sort</code> to <code>ascending</code>, <code>descending</code>, or <code>none</code>. The file also attaches a global click delegator that recognizes <code>.sort-btn</code>, <code>.th-with-sort</code>, and <code>th[role=button]</code> to trigger <code>headerSortButtonClicked</code>. The code calls <code>e.preventDefault()</code> to avoid unwanted navigation and focuses the button after sort. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Copy & export features (functionality & fallbacks)</strong><br><br>Copy & export routines are made robust and multi-path:<br>• <code>copyTablePlain(btn)</code> — copies as TSV-like plain text (title + rows joined by <code>\t</code>). Prefers <code>showCopyModal</code> if present. Uses <code>copyToClipboard</code> fallback and shows <code>showToast</code> success/fail.<br>• <code>copyTableMarkdown(btn)</code> — prefers to return the original Markdown source block if <code>getPreferredSourceForTable(table)</code> finds a likely source. Otherwise, builds Markdown from DOM via <code>tableToMarkdownLines(table, title)</code> and copies it. This preserves header row and uses <code>|</code> escaping for pipes inside cells. It again uses <code>showCopyModal</code> fallback for environments without clipboard API.<br>• <code>exportTableCSV(btn, {filename})</code> — serializes rows to CSV with RFC4180 escaping (<code>&quot;</code> doubled). Prepends a BOM (<code>\uFEFF</code>) for Excel compatibility. Uses <code>downloadBlob</code> helper to trigger downloads.<br>• <code>exportTableJSON(btn, {filename})</code> — builds header names from <code>thead</code> or first row; then builds array-of-objects mapping column header to cell text. Writes JSON with indentation and triggers <code>downloadBlob</code>.<br>• <code>exportTableXLSX(btn, {filename})</code> — attempts to use global <code>window.XLSX</code> (SheetJS). If available it builds a workbook with one sheet per table (or one sheet for single), and calls <code>XLSX.writeFile</code>. If not present it falls back to TSV-in-<code>.xlsx</code> file with a warning toast. The fallback uses tab-separated values and Blob with <code>application/vnd.openxmlformats...</code> content-type. Document warns user to install <code>assets/xlsx.full.min.js</code> for full support.<br>• <code>exportTablePDF(btn, {filename})</code> — opens a new window with a printable HTML doc containing the table and calls <code>print()</code>. This allows saving as PDF via Print-to-PDF flows but depends on user agent print capabilities. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Download/Blob & clipboard robust patterns</strong><br><br><code>downloadBlob(blob, filename)</code> performs object-URL creation and anchor click pattern. It revokes the URL after a short timeout. Copy uses <code>navigator.clipboard.writeText</code> when present and a textarea+<code>document.execCommand(&#x27;copy&#x27;)</code> fallback when not. Both flows are wrapped in promises with show/dismiss toasts. </td></tr><tr><td data-label="Technical Breakdown"> <strong>TOC building and integration</strong><br><br>The file integrates with <code>PTToc</code> when available and supplies <code>buildSingleTableToc</code> and <code>buildTocFromCaptions</code> functions as local complements. Behavior:<br>• If exactly one table exists it builds Topic links to rows (<code>tv-row-&lt;n&gt;</code>) and places them in <code>#tocBar</code> list. It preserves id collisions by suffixing unique integers.<br>• Otherwise, it builds TOC from elements matching <code>.table-caption</code>, <code>.table-title</code>, or <code>.table-heading</code>. It normalizes label text to remove <code>\n</code> and <code>br</code> artifacts.<br>• Click handlers scroll to targets with header-height offset (<code>stickyMainHeader</code>) and set <code>history.replaceState</code> with the target id. </td></tr><tr><td data-label="Technical Breakdown"> <strong>UI optimization & responsive behavior</strong><br><br><code>optimizeTableControls()</code> adjusts control layout for mobile: detects <code>(max-width:600px)</code> and makes copy button groups wrap, shrink paddings, and convert icon-only buttons to fixed sizes. It moves toggle buttons and groups controls for compact headers. It runs on resize and via <code>matchMedia</code> listeners. This is client-side progressive styling rather than heavy CSS dependency. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Rendered-content lifecycle (<code>initRenderedContent</code>)</strong><br><br>This is the central initialization hook called after server render injection (<code>processRenderedHtml</code>) or on DOMContentLoaded. Responsibilities:<br>• Wrap standalone <code>table</code> elements into <code>.table-container</code> if not already present.<br>• Ensure per-table row UIDs and sort state arrays are prepared.<br>• Populate <code>data-origHtml</code> for all cells so highlight/reset is safe.<br>• Initialize TOC via <code>PTToc.init()</code> with conservative selector set. If <code>PTToc</code> is absent it calls local <code>buildSingleTableToc()</code> and <code>buildTocFromCaptions()</code> as fallback.<br>• Attach per-wrapper handlers for toggles, copy, exports, and set <code>data-tv-table-index</code> on buttons for fast lookup.<br>• Attach search input debounce to <code>searchTable</code> and key binding for <code>&#x27;/&#x27;</code> to focus search. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Event delegation & robust selectors</strong><br><br>The file favors delegated listeners over per-element event binding where appropriate. Examples:<br>• Global <code>document</code> click handler for <code>#tocBar</code> anchors and for sort buttons. Delegation reduces memory use and supports dynamic DOM injection.<br>• Delegated <code>click</code> for convert and action dispatcher based on <code>[data-action]</code> attributes. This standardizes button wiring for third-party integrations.<br>• Per-wrapper button wiring done only for first attach and guarded by <code>btn.dataset.tvHandlerAttached</code> to prevent duplicate handlers when <code>initRenderedContent</code> runs multiple times. </td></tr><tr><td data-label="Technical Breakdown"> <strong>State flags and re-entrancy guards</strong><br><br>Key global guards: <code>window.__tv_convert_in_progress</code>, <code>window.__tv_skip_scroll</code>, <code>window._tv_extra_loader_attached</code>, <code>window.__tv_convert_delegation_attached</code>. These prevent concurrent conversion runs, conflicting scrolls during injection, and multiple loader attachments. The script carefully sets and clears these flags, and wraps operations in try/catch to ensure flags are not left stale on error. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Accessibility & keyboard shortcuts</strong><br><br>Accessibility considerations implemented:<br>• <code>aria-sort</code> and <code>aria-label</code> on interactive elements.<br>• <code>role=&quot;status&quot;</code> and <code>aria-live=&quot;polite&quot;</code> on toast container for screen reader announcements.<br>• Search focusing via <code>&#x27;/&#x27;</code> keyboard shortcut. This prevents accidental focus when typing in inputs. Escape bound to <code>backToTop()</code> as a lightweight global keyboard affordance. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Failure modes handled explicitly</strong><br><br>Common errors gracefully fall back:<br>• Missing <code>XLSX</code> → TSV fallback and warning to user.<br>• Clipboard denial → show copy modal fallback with raw text for manual copy.<br>• Unable to open print window → toast warning. <br>• Missing <code>PTToc</code> → local TOC builders used. <br>• HTML injection errors during <code>processRenderedHtml</code> — the script attempts multiple injection strategies and sets <code>__tv_skip_scroll</code> appropriately to avoid scroll fights. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Security considerations</strong><br><br>The file treats HTML content as potentially untrusted in places. It prefers copying text derived from DOM textContent (safe) over innerHTML insertion. For downloads the file uses user-initiated anchor click which browsers constrain. However exported HTML/CSV may contain user content; consuming code should sanitize if the output will be served to other users. When using <code>innerHTML</code> for injection the hosting app must ensure sanitization (e.g., DOMPurify) before calling <code>processRenderedHtml</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Performance profile and hotspots</strong><br><br>Potential hotspots:<br>• <code>highlightMatches</code> builds a full <code>normStr</code> and per-character <code>map</code>. For very large cells this is O(N) char cost and may be expensive — mitigate by limiting highlight length or chunking processing.<br>• <code>tableToMarkdownLines</code> and exports iterate every row/cell; cost is O(cells). For very large tables consider streaming export or offloading to a worker (<code>tvWorkerUrl</code>).<br>• <code>initRenderedContent</code> may run multiple times — guards avoid reattaching handlers but DOM querying cost remains. Use <code>documentFragment</code> insertion on server side to reduce reflows. </td></tr></tbody></table></div><div class="row-count">Rows: 21</div></div><div class="table-caption" id="Table3" data-table="Docu_0096_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown (continued)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown (continued)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown (continued)"> <strong>Unit tests & edge-case matrix (concrete)</strong><br><br>Suggested unit and integration tests to cover behavior thoroughly. Use a headless browser test harness (Puppeteer/Playwright) and small fixtures for DOM states.<br><br><strong>Search & Highlight</strong><br>• Input: empty search → no rows hidden, no marks present.<br>• Input: ASCII-only query matching a single cell → only matching rows visible and marks around exact substrings, multi-node matches preserved.<br>• Input: diacritic query vs accented text → match succeeds (NFD normalization).<br>• Input: extremely long cell (50k chars) → ensure highlight routine completes within threshold or is bounded (consider test that times out).<br><br><strong>Sorting</strong><br>• Numeric columns with commas (<code>&quot;1,234&quot;</code>) sort numerically.<br>• Mixed numeric/non-numeric: fallback to localeCompare without throwing.<br>• Reset restores original DOM order exactly (via <code>data-tv-uid</code>).<br><br><strong>Copy & Export</strong><br>• <code>copyTableMarkdown</code> returns preferred source when available (simulate <code>window.__tv_last_source</code>).<br>• CSV quoting ensures <code>&quot;</code> doubled and commas inside cells preserved.<br>• XLSX with <code>window.XLSX</code> present calls <code>writeFile</code>; with <code>XLSX</code> absent produces TSV blob with warning toast.<br><br><strong>TOC</strong><br>• Single table: builds row-level Topic links with <code>tv-row-N</code> ids, click scrolls to row with header offset.<br>• Multiple tables: builds links from <code>.table-caption</code> elements. Ensure id collisions resolved by suffixing.<br><br><strong>Lifecycle</strong><br>• Repeated <code>initRenderedContent()</code> calls should not attach duplicate handlers or corrupt <code>data-*</code> attributes.<br>• <code>processRenderedHtml()</code> injection race conditions: ensure <code>__tv_skip_scroll</code> toggles are cleared on failure and success. </td></tr><tr><td data-label="Technical Breakdown (continued)"> <strong>QA checklist (pre-release)</strong><br><br>1. Run <code>initRenderedContent()</code> on minimal, medium, and large fixture pages and inspect event listeners count (no leaks).<br>2. Verify keyboard shortcuts (<code>/</code> focus, Esc back-to-top) only trigger in expected contexts. <br>3. Test clipboard flows in browsers without <code>navigator.clipboard</code> (simulate permissions).<br>4. Confirm <code>downloadBlob</code> works on major browsers and revokes object URLs. <br>5. Test <code>exportTablePDF</code> in Chrome/Firefox/Edge and fallback messaging where <code>window.open</code> blocked.<br>6. Validate TOC anchors update <code>history.replaceState</code> and do not create excessive history stack entries.<br>7. Validate <code>optimizeTableControls()</code> for multiple viewport widths and sign off on responsive CSS alignment. </td></tr><tr><td data-label="Technical Breakdown (continued)"> <strong>Code review checklist</strong><br><br>1. All public APIs attached to <code>window</code> must be idempotent and guarded with existence checks. <br>2. No unbounded recursion or synchronous heavy loops on main thread without chunking (for very large tables). <br>3. All event handlers added dynamically must set dataset flags (e.g., <code>tvHandlerAttached</code>). <br>4. All <code>innerHTML</code> writes must have a clear comment and be limited to trusted contexts. <br>5. Error swallowing is deliberate; critical failures should also <code>console.error</code> at DEBUG level for diagnostics. <br>6. Prefer <code>textContent</code> or <code>createTextNode</code> for user content copied into DOM. </td></tr><tr><td data-label="Technical Breakdown (continued)"> <strong>Instrumentation & telemetry (practical)</strong><br><br>Implement lightweight metrics hooks (no vendor lock-in). Expose a <code>window.__tv_metrics</code> shim that consumer apps can implement. Emit events at these points:<br>• <code>convert.request</code> (start/finish/duration). <br>• <code>highlight.match_count</code> (per search). <br>• <code>export.format</code> (csv/json/xlsx/pdf) with success/failure.<br>• <code>tables.count</code> (on render). <br>• <code>table.size_max</code> (largest table cell count).<br><br>Payload shape example: <code>{ name: &quot;export.format&quot;, tags: { format:&quot;csv&quot; }, value: 1, duration_ms: 120 }</code>. Consumer may implement <code>window.__tv_metrics = (event) =&gt; { /* send to telemetry */ }</code>. Keep events small and anonymous by default. </td></tr><tr><td data-label="Technical Breakdown (continued)"> <strong>Performance & throttling strategies</strong><br><br>For very large tables apply these mitigations:<br>1. Chunked highlight: if <code>normStr.length &gt; 20000</code>, perform highlight in slices and yield to event loop via <code>setTimeout(,…0)</code> or <code>requestIdleCallback</code>. <br>2. Progressive export: stream CSV rows into a <code>BlobBuilder</code> like pattern (via <code>new Blob([...chunks])</code>) to avoid building a giant string. <br>3. Use a Web Worker (<code>tvWorkerUrl</code>) to run heavy diffing or markdown-to-HTML mapping for exports. The main thread should only handle DOM writes. <br>4. Debounce search input heavily (<code>debounceMs &gt;= 150</code>) on slower devices; expose <code>setTvSearchConfig</code> to increase debounce in low-power contexts. </td></tr><tr><td data-label="Technical Breakdown (continued)"> <strong>Migration & integration guides (practical steps)</strong><br><br>To add <code>script.table.js</code> into an existing site:<br>1. Place <code>script.table.js</code> in <code>assets/</code> and add <code>&lt;script src=&quot;assets/script.table.js&quot; defer&gt;&lt;/script&gt;</code> near the end of body. Ensure <code>tvUtils</code> is loaded first if you rely on its helpers. <br>2. If your server injects rendered HTML, call <code>window.PasteToTable.processRenderedHtml(payload)</code> after insertion. This uses <code>processRenderedHtml</code> to coordinate scroll and TOC. <br>3. To opt out of TOC injection call <code>window.PTToc = null</code> before <code>script.table.js</code> runs or adjust config in <code>window.PTToc</code> to your selectors. <br>4. If you want different toast colors or styling, override <code>.tv-toast</code> CSS or provide <code>window.tvUtils.showToast</code>. <br>5. For XLSX support, include <code>assets/xlsx.full.min.js</code> from SheetJS before this script. </td></tr><tr><td data-label="Technical Breakdown (continued)"> <strong>Security hardening checklist (operational)</strong><br><br>1. Sanitize server-side any HTML strings that will be injected via <code>processRenderedHtml</code> unless calling contexts are trusted. Use DOMPurify or equivalent. <br>2. When copying raw markdown to clipboard, consider scrubbing or truncating extremely long user inputs if exposing sensitive content is a concern. <br>3. Rate-limit server-side <code>/api/render</code> endpoints and protect with CSRF/auth when exposed. <br>4. For multi-tenant sites ensure exported filenames are sanitized using <code>sanitizeFileName</code> to avoid path traversal in legacy download handlers. <br>5. Do not call <code>innerHTML</code> with user content unless sanitized, especially in <code>processRenderedHtml</code> fallback. </td></tr><tr><td data-label="Technical Breakdown (continued)"> <strong>Backwards compatibility & graceful degradation</strong><br><br>Design choices for compatibility:<br>• Avoid <code>classList.toggle</code> with boolean when browser lacks support; use fallback <code>add</code>/<code>remove</code>. <br>• Use <code>document.querySelectorAll</code> and <code>forEach</code> shims where necessary by coding defensively. <br>• Rely on <code>dataset</code> only when available. In absence of <code>dataset</code> code tolerates manual <code>setAttribute</code>/<code>getAttribute</code>. <br>• Feature-detect <code>navigator.clipboard</code> and only use it when available. <br><br>Because of this conservative approach the script works across older WebViews and modern browsers alike, failing gracefully to modals or simple download flows when richer APIs are missing. </td></tr><tr><td data-label="Technical Breakdown (continued)"> <strong>Developer ergonomics & extension points</strong><br><br>Expose or override these hooks for advanced integrations:<br>• <code>window.__tv_init_pttoc_from_core(opts)</code> — entry for TOC init with custom selectors. <br>• <code>window.__tv_action_handlers</code> — map of <code>{ actionName: fn(ev, el) }</code> to attach custom action handlers. <br>• <code>window.PasteToTable.routeHtmlToAreas(html, metadata)</code> — optional hook to customize how server HTML is routed to page areas. <br>• <code>window.tvUtils</code> — optional namespace where host can provide <code>copyToClipboard</code>, <code>downloadBlob</code>, <code>showToast</code>, <code>debounce</code>, <code>normalizeForSearchLocal</code>. If provided the script uses these implementations. <br><br>These extension points avoid monkeypatching internals and keep customization explicit. </td></tr><tr><td data-label="Technical Breakdown (continued)"> <strong>Docs & README checklist (what to include)</strong><br><br>README should contain:<br>1. Quickstart snippet showing <code>&lt;script&gt;</code> placement and basic DOM structure expected (<code>#tables-viewer</code>, <code>.table-wrapper</code>, <code>.table-container</code>).<br>2. How to wire server <code>POST /api/render</code> to call <code>processRenderedHtml</code> on the client after fetch. <br>3. Exposed API list with method signatures and expected argument shapes. <br>4. Integration notes for SheetJS and worker-based heavy-lift flows. <br>5. Migrating from earlier versions: list of removed globals or changed dataset keys (if any). </td></tr><tr><td data-label="Technical Breakdown (continued)"> <strong>Troubleshooting common issues</strong><br><br>Problem: Search finds nothing on accented text.<br>→ Confirm <code>normalizeForSearchLocal</code> available. If not, ensure <code>window.__tv_utils.normalizeForSearchLocal</code> or fallback is present. <br><br>Problem: Copy fails silently on mobile Safari.<br>→ Safari may block <code>navigator.clipboard</code> on cross-origin frames or without user gesture. Script falls back to textarea+execCommand; if still blocked show copy modal. <br><br>Problem: Clicking TOC does not scroll correctly.<br>→ Check <code>stickyMainHeader</code> id presence and offset calculation. If header height is dynamic, consider setting CSS <code>scroll-margin-top</code> on targets instead of JS offset. </td></tr><tr><td data-label="Technical Breakdown (continued)"> <strong>Concrete next-steps / prioritized roadmap</strong><br><br>Immediate (0-2 weeks):<br>• Add automated test suite covering search, highlight, sorting, and export. <br>• Implement chunked highlight for very large cells and add a config toggle <code>maxHighlightLength</code>. <br>• Add basic telemetry hooks and example <code>__tv_metrics</code> implementation. <br><br>Short (1-2 months):<br>• Add Web Worker implementation for heavy export and markdown extraction. <br>• Add optional DOMPurify integration example in README. <br><br>Long (3-6 months):<br>• Add streaming CSV export and a server-side companion library for large tables. <br>• Provide an official <code>tv-utils</code> micro-lib that exposes <code>copyToClipboard/downloadBlob/showToast</code> for reuse across projects. </td></tr><tr><td data-label="Technical Breakdown (continued)"> <strong>Acceptance criteria for shipping</strong><br><br>1. All unit tests pass on CI with a headless browser run. <br>2. No console errors in Firefox/Chrome/Edge on sample pages. <br>3. XLSX export via SheetJS works when SheetJS included. <br>4. Copy and export succeed in at least two major mobile browsers. <br>5. <code>initRenderedContent()</code> idempotency validated under repeated injection scenario. </td></tr><tr><td data-label="Technical Breakdown (continued)"> <strong>Final notes (honest constraints)</strong><br><br>The script intentionally favors robustness over absolute performance for extreme inputs. For pages routinely rendering hundreds of thousands of DOM cells, move heavy transforms off-main-thread and use streaming exporters. This file is designed to be a resilient, pragmatic client-side enhancement layer that integrates cleanly with server-side renderers such as PasteToTable. </td></tr></tbody></table></div><div class="row-count">Rows: 14</div></div><div class="table-caption" id="Table4" data-table="Docu_0096_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>File-level summary (expanded)</strong><br><br><code>script.core.js</code> is the central client-side runtime for PasteToTable. It provides robust UI utilities, search and copy helpers, lightweight asset discovery/loader logic, toast notifications, clipboard/file-download helpers, conversion orchestration (convert button wiring and <code>__tv_do_convert</code>), passive DOM plumbing (attach handlers, debounce + mutation observers), and cross-module shims that let optional submodules integrate cleanly. The code prioritizes progressive enhancement, graceful degradation, and minimal global side-effects. Defensive coding patterns, <code>try/catch</code> guards, and feature-detection are used extensively to survive a broad set of host pages and missing assets. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Primary responsibilities</strong><br><br>• Establish runtime defaults and allow runtime overrides (<code>window.tvConfig</code>).<br>• Detect and set <code>TV_BASE</code> script base and ensure <code>data-index-url</code> / <code>data-worker-url</code> attributes on <code>&lt;body&gt;</code> for downstream modules.<br>• Load optional <code>extra.js</code> candidates sequentially if present.<br>• Provide utility functions exposed via <code>window.tvUtils</code> and <code>window.__tv_utils</code> (copy, download, debounce, normalize, table->markdown conversion helpers).<br>• Implement a toast notification queue with dismissal, cooldowns, and accessible roles.<br>• Provide a top-level <code>processRenderedHtml</code> hook used by server responses to inject/route rendered content into page areas safely, with coordinated scroll handling.<br>• Implement the <code>__tv_do_convert</code> flow for POSTing <code>/api/render</code> and injecting payloads.<br>• Attach delegated event handlers for convert button, action dispatcher, and header buttons (save/clear/export). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Runtime configuration and override model</strong><br><br>Defaults are defined in <code>defaultConfig = { highlight: true, debounceMs: 150, chunkSize: 300 }</code>. The global <code>window.tvConfig</code> merges defaults with any pre-existing user config via <code>Object.assign</code>. <code>window.setTvSearchConfig(cfg)</code> is a public function to update specific keys (<code>highlight</code>, <code>debounceMs</code>, <code>chunkSize</code>) at runtime with type checks. This model keeps mutation limited to well-known keys and prevents unexpected config injection. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Bootstrapping and base path detection</strong><br><br><code>detectScriptBase()</code> attempts multiple strategies to determine the base path for assets:<br>1. <code>document.currentScript.src</code> when available.<br>2. Scans <code>&lt;script&gt;</code> tags backward for a <code>script.js</code> pattern.<br>3. Falls back to <code>location.origin + pathname</code> parent folder.<br><br>This function is defensive: it catches exceptions and ensures a safe default of <code>&#x27;/&#x27;</code>. The resolved base is assigned to <code>TV_BASE</code> and to <code>window.__tv_base</code>. This drives subsequent candidate URL construction for index/worker and extra assets. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Index and worker attribute bootstrapping</strong><br><br><code>ensureIndexAndWorkerAttrs(base)</code> ensures <code>&lt;body&gt;</code> has <code>data-index-url</code> and <code>data-worker-url</code> attributes. It computes defaults by joining base + <code>tables_index.json</code> / <code>worker.js</code>. It sets <code>window.tvIndexUrl</code> and <code>window.tvWorkerUrl</code>. If DOM is not ready, it registers a <code>DOMContentLoaded</code> callback to retry. This guarantees minimal configuration for the client to find its runtime artifacts even when server rendering omitted attributes. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Optional extra loader</strong><br><br><code>startExtraLoader()</code> uses <code>extraCandidates</code> and <code>loadExtraSequentially</code> to try loadable <code>extra.js</code> files synchronously (append <code>&lt;script&gt;</code> tags with async=false). Behavior:<br>• Stops if a script is found loaded or if another loader is attached.<br>• Calls <code>onDone(path)</code> for success. <br>• On failure of all candidates logs a warning.<br><br>Rationale: include site-specific optional extensions without hard-coding locations. Sequential loading ensures deterministic side-effects and avoids racing. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Utility suite (copy, download, sanitize)</strong><br><br>Utilities are surfaced via <code>window.tvUtils</code> and <code>window.__tv_utils</code> with a consistent API. Key details:<br>• <code>normalizeForSearchLocal(s)</code> performs Unicode NFD normalization, diacritic stripping, non-letter/number removal, and whitespace collapse. It uses <code>\p{L}\p{N}</code> unicode classes when available and falls back to ASCII-safe regex on engines lacking <code>u</code> support.<br>• <code>copyToClipboard(text)</code> prefers <code>navigator.clipboard.writeText</code>, falls back to legacy <code>execCommand</code> via a hidden textarea. Returns a Promise.<br>• <code>downloadBlob(blob, filename)</code> creates object URL and triggers an <code>&lt;a download&gt;</code> click. It delegates to <code>Shared</code> helpers when present.<br>• <code>sanitizeFileName(name)</code> used by export functions to produce safe file names by replacing illegal characters and trimming length. Delegates to <code>Shared.sanitizeFileName</code> when available. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Toast subsystem</strong><br><br>Designed for accessibility and single-instance sequencing. Features:<br>• <code>_ensureToastContainer()</code> lazily creates <code>#tv-toast-container</code> with <code>role=&quot;status&quot;</code> and <code>aria-live=&quot;polite&quot;</code> for accessibility.<br>• <code>_processToastQueue()</code> displays one toast at a time. Each toast is created with semantic attributes, close button, and transition animations. Toast styles adapt to theme variables via <code>getComputedStyle(document.documentElement)</code> to align to page tokens when present.<br>• <code>_computeToastDuration()</code> sets a variable timeout based on message length and type (info/success/warn/error).<br>• <code>showToast(msg, {duration, type})</code> enqueues and returns a handle with <code>dismiss()</code> to allow programmatic dismissal.<br>• <code>showToastOnce(key, msg, opts, cooldownMs)</code> prevents repeated toasts within a cooldown period using a Map-based cooldown registry.<br><br>Design notes: toasts intentionally do not block page flow and rely on <code>pointerEvents</code> rules. They attempt minimal reflow and restore focus to prior element when shown. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Debounce & small-shared helpers</strong><br><br><code>debounce(fn, wait)</code> uses <code>Shared.debounce</code> if present otherwise provides a straightforward timer-based debounce. This keeps consistent behavior when an upstream <code>tvUtils</code> implementation exists. <code>once(fn)</code> helper returns a guard that runs a callback only once. <code>joinUrl(base, rel)</code> uses the <code>URL</code> constructor when available, falling back to naive string joining. All helpers are small and defensive. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Table markdown helpers</strong><br><br><code>tableToMarkdownLines(table, title)</code> and <code>formatCellForMarkdown(cell)</code> convert DOM tables into Markdown-safe lines. They escape pipe characters and convert multiline cells into <code>&lt;br&gt;</code>. This is used for export fallbacks and <code>exportAllBtnHandler</code>. Implementation details: walk rows and cells, build header row, set separator row of <code>---</code>, then each data row. <code>formatCellForMarkdown</code> escapes <code>|</code> and replaces newline sequences with <code>&lt;br&gt;</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Process-rendered-HTML orchestration</strong><br><br><code>processRenderedHtml(responseData)</code> is the client-side injection contract expected by the server render endpoint. Responsibilities and flow:<br>1. Accept <code>responseData</code> which may be <code>string</code> or <code>object</code> with <code>html</code>, <code>result</code>, or <code>body</code> or <code>metadata</code> keys.<br>2. Set <code>window.__tv_skip_scroll = true</code> to coordinate with other scripts (prevents them from forcing scroll into view while we manage top scroll).<br>3. Attempt to route via <code>window.PasteToTable.routeHtmlToAreas(html, metadata)</code> if present. If not routed, inject into <code>#tables-viewer</code> or fallback to writing innerHTML.<br>4. Trigger <code>PasteToTable.initRenderedContent()</code> twice on short delays to allow nested scripts to initialize. Then trigger PTToc via <code>__tv_init_pttoc_from_core</code> or <code>PTToc.build()</code>.<br>5. Perform coordinated sequential <code>scrollTo({top:0})</code> calls at several timeouts (immediate, 60ms, 250ms, final 600ms) to achieve top-of-page after layout stabilizes, then clear <code>__tv_skip_scroll</code>.<br><br>Rationale: many table renderers and table scripts call <code>scrollIntoView</code> or attempt to highlight top result. Coordinated skip flag avoids visual fights. Multiple retries handle different browser reflow timings. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Convert pipeline (<code>__tv_do_convert</code>)</strong><br><br>Main flow for client-triggered server rendering:<br>• Guard: prevents reentrancy with <code>window.__tv_convert_in_progress</code>.<br>• Gather text from <code>opts.text</code> or <code>#paste</code> textarea. Warn and return if empty.<br>• POST to <code>/api/render</code> with JSON body fallback to x-www-form-urlencoded on failure. Multiple fetch attempts for compatibility with some hosting stacks.<br>• On non-OK response show toast and set status element text. Capture response content-type. Parse JSON if <code>application/json</code>, else treat as HTML text and wrap as <code>{html: txt}</code> payload.<br>• Preference for a user-provided hook <code>window.PasteToTable.processRenderedHtml</code> to accept payloads. If absent, inject into <code>#tables-viewer</code> with <code>payload.html || payload.result || payload.body</code>.<br>• Mark success via <code>showToastOnce(&#x27;converted&#x27;,&#x27;Converted&#x27;)</code> and set <code>#status</code> text to include metadata tables count if present.<br>• Robust error handling with informative toasts. Always ensure the convert button is re-enabled and clear <code>__tv_convert_in_progress</code> in <code>finally</code> block.<br><br>Notes: Two POST attempts differ only in Content-Type. This addresses some servers that reject <code>application/json</code> POSTs. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Convert click delegation and direct attach</strong><br><br>Two complementary wiring approaches are used to ensure the convert button works in various DOMs:<br>1. Delegated capture: a document-level <code>click</code> listener listens for any click of an element matching <code>#convertBtn</code> or <code>[data-action=&quot;convert&quot;]</code>. This allows dynamically injected controls to work. It prevents default and calls <code>__tv_convert_click_ev</code> which marks the event handled and calls <code>__tv_do_convert</code>.<br>2. Direct attach: <code>tryDirectAttach()</code> finds <code>#convertBtn</code> and adds a direct click listener if not already attached and tags the dataset to avoid duplicate attaches.<br><br>Design: delegation catches many hosting scenarios while direct attach gives slightly faster reaction for static pages. Both are guarded. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Action dispatcher</strong><br><br><code>attachActionDispatcher()</code> installs a delegated document-level handler that listens for <code>[data-action]</code> on clicked elements and maps names to functions registered on <code>window.__tv_action_handlers</code>. By default it registers a <code>&#x27;convert&#x27;</code> action to call convert. This provides a compact declarative wiring pattern for buttons in templates. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Header control handlers</strong><br><br><code>attachHeaderHandlersOnce()</code> idempotently wires header buttons by id: convert, clear, save, exportAll, render. It respects dataset flags to avoid double-binding. Each handler performs lightweight responsibilities:<br>• <code>clearButtonHandler</code> resets <code>#paste</code>, clears <code>#tables-viewer</code> and <code>#page-area</code> and sets <code>#status</code> text. Shows toast.<br>• <code>saveHtmlHandler</code> gathers the currently visible area (page-area if visible else tables-viewer), constructs a minimal HTML doc and either calls <code>PasteToTable.save</code> server hook if available or triggers a local download via <code>downloadBlob</code>. Provides user feedback via toasts. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Passive copy & export handlers</strong><br><br><code>copyToClipboard</code>/<code>showCopyModal</code> are used by other modules (script.table.js). The exports include CSV/JSON/XLSX/PDF export functions implemented later in <code>script.table.js</code>. In <code>script.core.js</code> the basic download and copy primitives are exposed and shared. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Finalization and debug logging</strong><br><br>On load the script logs <code>tv:core loaded</code> with base/index/worker details if possible. It wraps many diagnostic operations in <code>try/catch</code> and uses <code>dbgInfo</code>, <code>dbgWarn</code>, <code>dbgDebug</code>, <code>dbgError</code> helpers tied to global <code>tvDebug</code> flag so operators can enable more verbose output in development. </td></tr></tbody></table></div><div class="row-count">Rows: 17</div></div><div class="table-caption" id="Table5" data-table="Docu_0096_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown (Batch 2)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown (Batch 2)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown (Batch 2)"> <strong>Security posture & XSS considerations (concrete)</strong><br><br><code>script.core.js</code> is defensive but not a sanitizer. Key risks and mitigations:<br>• <strong>Injection via processRenderedHtml</strong>: <code>processRenderedHtml</code> writes server HTML into <code>innerHTML</code>. Assume server output is trusted or sanitized. If not, add DOMPurify or similar before insertion.<br>• <strong>data passed to toasts and filenames</strong>: <code>showToast</code> and <code>sanitizeFileName</code> attempt safe handling. Do not log raw HTML payloads at INFO. Truncate or hash large payloads in logs.<br>• <strong>Clipboard & file export</strong>: <code>copyToClipboard</code> and <code>downloadBlob</code> operate on client-provided strings/blobs. Avoid automatic re-insertion of blob content into DOM without sanitization. When exporting user content to files, treat file names as untrusted and sanitize via <code>sanitizeFileName</code> before use.<br>• <strong>Open window for PDF printing</strong>: <code>exportTablePDF</code> opens a new window and writes HTML that may execute remote scripts if not sanitized. Use safe CSS-only templates and avoid script tags in exported HTML.<br>• <strong>Worker/index resources</strong>: <code>data-index-url</code> and <code>data-worker-url</code> are used to fetch resources. Validate these on server or provide allow-listing to prevent cross-origin resource substitution. </td></tr><tr><td data-label="Technical Breakdown (Batch 2)"> <strong>Edge-case behaviors observed and recommendations</strong><br><br>1. <strong>Missing DOM elements</strong>: Most functions detect elements by id and degrade gracefully. Recommendation: document required IDs (<code>paste</code>, <code>tables-viewer</code>, <code>page-area</code>, <code>convertBtn</code>, <code>status</code>) and fail early with a console warning if missing in debug mode.<br>2. <strong>Multiple converts in-flight</strong>: guarded by <code>__tv_convert_in_progress</code>. Good. Ensure server-side idempotency on <code>/api/render</code> because frontend retries are attempted.<br>3. <strong>Large payloads</strong>: <code>processRenderedHtml</code> may inject multi-MB HTML. This can cause reflow and multiple <code>scrollTo</code> attempts. Recommendation: if payload > N bytes, show a "Large render" toast and consider chunked rendering or showing spinner until stable.<br>4. <strong>Browsers without <code>URL</code> or <code>navigator.clipboard</code></strong>: fallback code exists. Test on legacy IE11-like environments if supported. Provide progressive enhancement warnings in README.<br>5. <strong>Race between scripts</strong>: <code>startExtraLoader</code> and other modules may load the same extras. <code>window._tv_extra_loader_attached</code> prevents duplicate loads. Keep this pattern for other shared loads. </td></tr><tr><td data-label="Technical Breakdown (Batch 2)"> <strong>Function-by-function deep dive (selected important functions)</strong><br><br><strong>detectScriptBase()</strong><br>• Purpose: compute base URL for asset discovery.<br>• Behavior: uses <code>document.currentScript.src</code> then scans <code>&lt;script&gt;</code> tags for <code>script.js</code> pattern then falls back to <code>location.origin + pathname parent</code>.<br>• Failure modes: <code>document.currentScript</code> may be null in some injection scenarios; script scanning may pick wrong script when multiple script.js present. Consider reading a server-provided <code>&lt;meta name=&quot;tv-base&quot; content=&quot;...&quot;&gt;</code> as an explicit override.<br><br><strong>ensureIndexAndWorkerAttrs(base)</strong><br>• Purpose: ensure body has <code>data-index-url</code> and <code>data-worker-url</code> attributes and set global variables.<br>• Behavior: if body missing or not ready, binds to <code>DOMContentLoaded</code> and retries. Keeps values in <code>window.tvIndexUrl</code> and <code>window.tvWorkerUrl</code>.<br>• Failure modes: if server sets attributes later via XHR, this function will not re-run. Consider exposing a public <code>tv.setIndexUrl(url)</code> method for dynamic hosts.<br><br><strong>loadExtraSequentially(paths, onDone, onAllFailed)</strong><br>• Purpose: sequentially append script tags for optional extras. Stops on success. Uses <code>async=false</code> for deterministic execution order.<br>• Failure modes: network blocked or CSP denies inline loads. Add CSP-compatible fallback (server-proxy) if required.<br><br><strong>_ensureToastContainer()/_processToastQueue()</strong><br>• Purpose: manage single visible toast and queue. Creates accessible container with <code>aria-live</code>.<br>• Implementation details: creates DOM nodes with inline styles that read CSS variables for theme colors. Dismiss and timeout logic careful to avoid focus loss. Use <code>showToastOnce</code> to prevent spammy notifications.<br><br><strong>processRenderedHtml(responseData)</strong><br>• Purpose: canonical client-side injection for server render responses.<br>• Flow: extract HTML string -> set <code>__tv_skip_scroll = true</code> -> try <code>PasteToTable.routeHtmlToAreas()</code> -> fallback inject to <code>#tables-viewer</code> -> call <code>PasteToTable.initRenderedContent()</code> -> attempt TOC builds -> coordinated scroll-to-top with multiple timeouts -> clear <code>__tv_skip_scroll</code>.<br>• Notes: This is the most critical integration point with server. Keep the contract stable: server returns <code>{ html, metadata }</code> or raw HTML string. If you extend this contract, increment a <code>X-Tv-Version</code> header for clients to adapt.<br><br><strong>__tv_do_convert(opts)</strong><br>• Purpose: orchestrates POST <code>/api/render</code> and injects response via <code>processRenderedHtml</code> or <code>PasteToTable.processRenderedHtml</code>.<br>• Robustness: tries JSON POST then x-www-form-urlencoded fallback. Uses <code>showToast</code> to report progress, handles non-OK statuses with body logged to console at debug level.<br>• Recommendation: treat <code>/api/render</code> as potentially slow. Consider an async endpoint variant that returns 202 + job id to poll for huge conversions. Frontend should support both synchronous and job-based responses. </td></tr><tr><td data-label="Technical Breakdown (Batch 2)"> <strong>Concrete unit + integration test matrix (prioritized)</strong><br><br>Implement tests in two categories: unit (Jest, mocha, or simple headless DOM) and integration (headful Chrome, Playwright). Priorities high->low:<br><strong>Unit tests</strong>:<br>1. <code>detectScriptBase()</code>:<br> - currentScript present -> returns dirname of src.<br> - currentScript null and script tags contain <code>/assets/script.js</code> -> resolves to correct base.<br> - fallback uses location pathname parent.<br>2. <code>ensureIndexAndWorkerAttrs()</code>:<br> - body lacks attributes -> attributes added with expected URL.<br> - preserves existing non-empty attributes.<br>3. <code>startExtraLoader()</code>:<br> - when a <code>&lt;script src=&quot;extra.js&quot;&gt;</code> exists do not append another.<br> - on success <code>onDone</code> called with loaded path.<br>4. <code>copyToClipboard()</code> fallback path (simulate no navigator.clipboard) -> uses execCommand path and resolves promise.<br>5. Toast queue ordering and <code>showToastOnce</code> cooldown map resets.<br><br><strong>Integration tests</strong>:<br>1. <code>__tv_do_convert()</code> happy path:<br> - mock <code>/api/render</code> to return JSON with <code>html</code>, verify <code>#tables-viewer</code> updated and <code>Converted</code> toast shown.<br>2. <code>processRenderedHtml()</code> with routeHtmlToAreas present:<br> - stub <code>PasteToTable.routeHtmlToAreas</code> to capture <code>html</code> and <code>metadata</code>. Ensure we do not replace <code>#tables-viewer</code> if routed.<br>3. Large HTML injection test: ensure <code>__tv_skip_scroll</code> prevents other table scripts from jumping and that final scrollTo top happens after timeouts.<br>4. CSP restrictions: simulate CSP blocking extra.js load and verify <code>startExtraLoader</code> gracefully fails without throwing. </td></tr><tr><td data-label="Technical Breakdown (Batch 2)"> <strong>Telemetry and observability recommendations</strong><br><br>Key metrics to emit (client and server):<br>• <code>tv.client.convert.request.count</code> per-status code.<br>• <code>tv.client.convert.latency.ms</code> histogram.<br>• <code>tv.client.process_html.size.bytes</code> distribution.<br>• <code>tv.client.toasts.shown</code> by type.<br>• <code>tv.client.extra_loader.success</code> boolean with path label.<br><br>Logging suggestions:<br>• At DEBUG include <code>tv_base</code>, <code>index_url</code>, <code>worker_url</code>, sizes (in bytes) of injected html, and time taken by <code>processRenderedHtml</code> steps.<br>• At INFO include <code>convert</code> start/finish and <code>extra.js</code> load success/failure events.<br><br>Privacy: strip user data/payload from logs; emit only lengths and hashes. </td></tr><tr><td data-label="Technical Breakdown (Batch 2)"> <strong>Performance tuning & resource advice</strong><br><br>• For pages with heavy tables prefer server-side pre-rendering and smaller inlined HTML fragments. Keep <code>processRenderedHtml</code> injection as short as possible.<br>• If <code>processRenderedHtml</code> frequently injects large payloads, consider streaming DOM injection: create a fragment and append in chunks to reduce layout thrash.<br>• Defer non-critical asset loads to <code>requestIdleCallback</code> or after first user interaction. <code>startExtraLoader</code> currently runs on DOMContentLoaded and could be moved to idle time for speed-sensitive UIs. </td></tr><tr><td data-label="Technical Breakdown (Batch 2)"> <strong>Operational failure modes & recovery steps (step-by-step)</strong><br><br>1. <strong>Convert fails with non-OK status</strong>:<br> - Symptom: toast "Convert failed" and status shows code. <br> - Recovery: check server <code>/api/render</code> logs, verify Content-Type handling for JSON vs form body. Add server logging for request size and authentication rejections.<br>2. <strong>No tables appear after convert</strong>:<br> - Symptom: <code>#tables-viewer</code> unchanged. <br> - Recovery: open console; check <code>PasteToTable.routeHtmlToAreas</code> presence. If present, your server may be returning <code>metadata</code> the route expects. Fallback: ensure <code>PasteToTable.processRenderedHtml</code> or <code>PasteToTable.routeHtmlToAreas</code> is implemented properly, or remove it to allow core to inject into <code>#tables-viewer</code>.<br>3. <strong>Extra loader crashes page</strong>:<br> - Symptom: script load error due to CSP or missing file causing console noise. <br> - Recovery: host <code>extra.js</code> within same origin or configure CSP to allow its path. Add try/catch around loaded script global init in <code>extra.js</code> to fail fast without breaking core.\br>4. <strong>Unexpected scroll behavior</strong>:<br> - Symptom: content not scrolled to top after convert or other scripts fight scroll. <br> - Recovery: ensure <code>__tv_skip_scroll</code> is respected by other local scripts. If not, use a stronger coordination mechanism (custom event <code>tv:skip-scroll</code> + listen/ack) rather than global flag. </td></tr><tr><td data-label="Technical Breakdown (Batch 2)"> <strong>Backward compatibility & extension points</strong><br><br>• <code>window.tvConfig</code> is the public config; add keys here for future flags.<br>• <code>window.__tv_utils</code> and <code>window.tvUtils</code> are extension points for site-level overrides. If a host provides richer implementations of copy/download/sanitize, <code>script.core.js</code> delegates automatically.<br>• <code>PasteToTable</code> namespace is the main integration point for renderer clients to override routing/injection behavior: implement <code>PasteToTable.routeHtmlToAreas</code>, <code>PasteToTable.processRenderedHtml</code>, or <code>PasteToTable.save</code> to use server-side storage. </td></tr><tr><td data-label="Technical Breakdown (Batch 2)"> <strong>Concrete hardening checklist before production deploy</strong><br><br>1. Add DOMPurify or comparable DOM sanitizer to any injection paths when server output originates from untrusted sources.<br>2. Add size gating for <code>processRenderedHtml</code> and show a spinner/progress bar for large payloads. <br>3. Ensure <code>X-Content-Type-Options: nosniff</code> and other security headers returned by server. <br>4. Add unit and integration tests described above to CI. <br>5. Add basic telemetry (convert counts, failure rates, payload sizes) to monitoring. </td></tr><tr><td data-label="Technical Breakdown (Batch 2)"> <strong>Suggested README snippet (quick-start)</strong><br><br><strong>Required elements</strong>: <code>&lt;textarea id=&quot;paste&quot;&gt;</code>, <code>&lt;button id=&quot;convertBtn&quot;&gt;</code>, <code>&lt;div id=&quot;tables-viewer&quot;&gt;&lt;/div&gt;</code>, <code>&lt;div id=&quot;status&quot;&gt;&lt;/div&gt;</code>.<br><strong>Optional</strong>: Implement <code>window.PasteToTable.processRenderedHtml(payload)</code> to fully control injection. Provide <code>data-index-url</code> on <code>&lt;body&gt;</code> to override default asset discovery path. <br><strong>Usage</strong>: call <code>window.setTvSearchConfig({ debounceMs: 200 })</code> early if you want different debounce. </td></tr><tr><td data-label="Technical Breakdown (Batch 2)"> <strong>Next-steps roadmap (practical)</strong><br><br>Short-term (days): add unit tests for <code>processRenderedHtml</code>, <code>__tv_do_convert</code>, and toast queue. Add optional sanitizer hook and size gating.<br>Medium (weeks): add job-based convert workflow for very large source payloads. Add telemetry hooks and an example implementation for <code>PasteToTable.routeHtmlToAreas</code> in the repo.<br>Long term: add streaming DOM injection for multi-MB renders and an optional server handshake for asset allow-listing. </td></tr></tbody></table></div><div class="row-count">Rows: 11</div></div><div class="table-caption" id="Table6" data-table="Docu_0096_06" style="margin-top:2mm;margin-left:3mm;"><strong>Table 6</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical Breakdown"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical Breakdown</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical Breakdown"> <strong>File-level summary (expanded)</strong><br><br><code>script.toc.js</code> is a compact, resilient Table-of-Contents (TOC) builder tailored for the PasteToTable UI. It auto-detects tables and headings in the document and populates two TOC targets (<code>#toc</code> and <code>#tocBar</code> / <code>#tocBarList</code>). It supports two primary modes: row-level Topic links when exactly one table exists and heading-based links otherwise. The implementation emphasizes low side-effects, accessibility, and mutation-awareness so it updates when page content changes. The script prefers string-safe DOM operations and avoids CSS injection besides minimal inline expectations handled elsewhere. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Top-level goals and constraints</strong><br><br>• Minimal runtime footprint. <br>• Non-destructive edits: never rewrite original content except to add stable <code>id</code>s.<br>• Robust in presence/absence of helper elements (<code>#toc</code>, <code>#tocBar</code>, etc.).<br>• Works with dynamically injected content via <code>MutationObserver</code> and delegated click handlers. <br>• Accessible by setting <code>aria-label</code> and <code>role</code> attributes on generated links. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Config object & defaults</strong><br><br><code>PTToc.config</code> holds selectors and small behavior knobs:<br>• <code>tocSelector</code> — container for full TOC (<code>#toc</code>).<br>• <code>tocListSelector</code> — list inside full TOC (<code>#tocList</code>).<br>• <code>tocBarListSelector</code> — compact bar list (<code>#tocBarList</code>).<br>• <code>headingSelector</code> — selector used to find headings when not single-table mode.<br>• <code>contentSelector</code> — root for mutation observation; default <code>#content</code>.<br>• <code>stickyHeaderId</code> — used to offset scrolling for fixed headers. <br>• <code>tableSelector</code> — what counts as table nodes; default <code>table</code>.<br>• <code>rowLabelPrefix</code> — label prefix for single-table row anchors (default <code>Topic</code>).<br><br>These defaults are conservative and overrideable via <code>PTToc.init(options)</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Normalization & sanitization functions</strong><br><br><code>sanitizeText(s)</code> — trivial safe <code>String(s).trim()</code> wrapper.<br><code>_normalize_heading_text(raw)</code> — key text normalization: removes CR/LF, collapses whitespace, strips isolated <code>br</code> tokens, and trims. Rationale: many table heading sources include messy <code>\n</code> or literal "br" words after earlier processing pipelines; normalization reduces noisy anchor ids and labels. </td></tr><tr><td data-label="Technical Breakdown"> <strong>ID generation: <code>ensureId(el, prefix)</code></strong><br><br>Purpose: guarantee a stable, DOM-unique <code>id</code> for an element. Behavior details:<br>• If the element already has a non-empty <code>id</code>, return it unchanged.<br>• Otherwise compute <code>rawText = el.textContent || el.innerText</code> and normalize it via <code>_normalize_heading_text</code> then to lower-case.<br>• Build <code>base = prefix + normalized</code> (fallback to random suffix when normalized is empty). Strip non-word/dash characters and limit to 60 chars.<br>• If collision with existing id occurs, append numeric suffixes (<code>-1</code>, <code>-2</code>, ...) until unique.<br>• Assign <code>el.id = id</code> and return it. <br><br>Edge-case handling: robust to missing textContent, unusual characters, and existing collisions. Avoids global state except checking <code>document.getElementById</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Link creation & DOM insertion</strong><br><br><code>makeLink(id, text, extraClass)</code> constructs <code>&lt;li&gt;&lt;a&gt;</code> with:<br>• <code>href=&quot;#&lt;id&gt;&quot;</code> and <code>data-pt-target</code> equal to the id.<br>• <code>role=&quot;link&quot;</code> and <code>aria-label</code> set to the text for accessibility.<br>• <code>textContent</code> sanitized via <code>sanitizeText</code>. <br><br><code>clearChildren(el)</code> is a small utility used to reset TOC lists safely. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Single-table row-mode logic</strong><br><br><code>buildItemsFromSingleTable(table)</code> returns item objects for each visible row when exactly one table is present. Implementation details:<br>• Prefer <code>table.tBodies</code> rows to respect author semantics.<br>• If no <code>tbody</code> found, fallback to selecting all <code>tr</code> not inside <code>thead</code>.<br>• For each row compute <code>id = ensureId(row, &#x27;row-&#x27;)</code> and <code>label = rowLabelPrefix + &#x27; &#x27; + (index+1)</code> — ensures canonical "Topic N" labeling required by TV2.1 behavior.<br>• Return <code>[{id,label}]</code>. <br><br>Design note: labeling is forced to the predictable "Topic N" form to meet consumer expectations and client-side navigation logic. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Heading-mode logic</strong><br><br><code>buildItemsFromHeadings()</code> finds any elements matching <code>headingSelector</code> and for each:<br>• Ensures an id via <code>ensureId(h, &#x27;table-&#x27;)</code>.<br>• Normalizes heading text using <code>_normalize_heading_text</code> and uses it as label. <br>• Adds to <code>items</code>. <br><br>Choice of selectors can be customized at init; the default covers <code>.table-heading</code> and similar semantic containers. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Primary build pipeline: <code>buildOnce()</code></strong><br><br>This is the central routine that:<br>1. Obtains <code>tocList</code> and <code>tocBarList</code> references (if absent it returns early).<br>2. Locates content root via <code>getContentRoot()</code> which prefers <code>#content</code> then <code>#tables-viewer</code> and finally <code>document.body</code>.<br>3. Collects tables under <code>contentRoot</code> and branches:<br> • If exactly one table then use <code>buildItemsFromSingleTable</code>.<br> • Otherwise fallback to <code>buildItemsFromHeadings</code>.<br>4. Clears existing TOC lists and appends generated links using <code>makeLink</code>. <br>5. Calls <code>highlightCurrentFromLocation()</code> to mark the current anchor if <code>location.hash</code> present. <br><br>Resilience: tolerates lack of any TOC containers and avoids throwing. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Debounce & rebuild scheduling</strong><br><br><code>debounceBuild()</code> uses <code>PTToc._debounceMs</code> (default 150ms) to avoid frequent rebuilds. The module-level <code>PTToc._rebuildTimer</code> tracks the timeout. Debounce prevents thrashing when many DOM mutations happen quickly (e.g., bulk table injection). </td></tr><tr><td data-label="Technical Breakdown"> <strong>Current anchor highlighting</strong><br><br<code>highlightCurrentFromLocation()</code>:<br>• Reads <code>location.hash</code> and then locates generated TOC link anchors across <code>tocSelector</code> and <code>#tocBar</code>.<br>• Removes <code>aria-current</code> from all links then sets <code>aria-current=&quot;page&quot;</code> on the matching anchor. <br>• Matching performed using either <code>href</code> comparison or <code>data-pt-target</code>. <br><br>Accessibility note: using <code>aria-current</code> improves screen-reader semantics for the active section. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Click handling & smooth-scroll</strong><br><br><code>onTocClick(ev)</code> intercepts clicks delegated from the document. Important behaviors:<br>• Prevent default navigation and compute id from <code>data-pt-target</code> or <code>href</code>.<br>• If target element exists, compute offset using sticky header height (<code>stickyHeaderId</code>) and scroll using <code>window.scrollTo({top, behavior:&#x27;smooth&#x27;})</code>. On older browsers fallback to <code>window.scrollTo(0, top)</code>.<br>• Update history via <code>history.replaceState</code> to avoid stacking back-button entries. <br>• Delay call to <code>highlightCurrentFromLocation()</code> to ensure the DOM's focus state updates. <br><br>Design tradeoff: <code>replaceState</code> used to keep navigation lighter; apps that want full back history should change this. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Event delegation & attachment</strong><br><br><code>attachDelegatedHandlers()</code> ensures a single delegated click listener on <code>document</code> and a <code>hashchange</code> listener. This avoids per-link listeners and supports dynamically created links. The delegated click uses <code>ev.preventDefault()</code> and <code>passive:false</code> so it can call <code>preventDefault</code>. </td></tr><tr><td data-label="Technical Breakdown"> <strong>MutationObserver integration</strong><br><br><code>observeMutations()</code> sets up a <code>MutationObserver</code> on <code>getContentRoot()</code> observing <code>childList:true</code> and <code>subtree:true</code>. On mutation it triggers <code>debounceBuild</code>. This supports dynamic updates from client-side renderers and keeps the TOC in sync. It quietly disconnects/recovers if observation fails. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Public API</strong><br><br<code>PTToc.build()</code> — debounced build trigger.<br><code>PTToc.init(options)</code> — attaches handlers, applies options, calls <code>buildOnce()</code>, and starts observing. <code>init</code> is guarded to avoid duplicate initialization. <code>window.PTToc</code> exported for external control. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Load-time auto-init</strong><br><br>If <code>document.readyState === &#x27;loading&#x27;</code>, <code>DOMContentLoaded</code> callback calls <code>PTToc.init()</code> once. Otherwise it calls <code>PTToc.init()</code> immediately. This ensures predictable initialization whether script is inline or loaded async. </td></tr><tr><td data-label="Technical Breakdown"> <strong>Failure modes and graceful degradation</strong><br><br>• Missing <code>#toc</code> and <code>#tocBar</code> — script becomes no-op. <br>• <code>MutationObserver</code> absent — only initial build runs; dynamic changes won't update TOC. <br>• Rare errors inside specific row processing skip that row but continue building. <br>• ID generation falls back to random suffix to avoid exceptions on pathological inputs. </td></tr></tbody></table></div><div class="row-count">Rows: 17</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>