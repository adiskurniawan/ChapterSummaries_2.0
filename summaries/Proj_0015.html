<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1764756450">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      // Delegate addEventListener/removeEventListener to visible button
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      // Delegate onclick assignments
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      // Delegate focus/blur
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
      // If legacy code used direct addEventListener earlier than this script, listeners would already exist
      // on alias element; attempt to re-dispatch those by cloning them to visible button is non-trivial.
      // This approach covers the common case where legacy scripts query the alias and bind after DOM ready.
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#Table6">Table 6</a></li>
<li class="toc-item"><a class="toc-link" href="#Table7">Table 7</a></li>
<li class="toc-item"><a class="toc-link" href="#Table8">Table 8</a></li>
<li class="toc-item"><a class="toc-link" href="#Table9">Table 9</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Proj_0015_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Confirmation"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Confirmation</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Confirmation"> Module separation: <strong>PASS</strong> — <code>modTER</code> implemented as a separate module; it does not mutate <code>modCalc</code> internals and calls <code>modCalc.SetTERTables</code> on commit. </td></tr><tr><td data-label="Confirmation"> Mapping resolution hookup: <strong>PASS</strong> — <code>modCalc</code> calls <code>ResolveCanonicalTERKey</code> / <code>GetCurrentTERMapLoadId</code> when available; <code>modTER</code> implements <code>ResolveCanonicalTERKey</code> and <code>GetCurrentTERMapLoadId</code>. </td></tr><tr><td data-label="Confirmation"> Preserve public APIs: <strong>PASS</strong> — <code>modCalc.SetTERTables</code> preserved; <code>modTER</code> exposes <code>LoadMappingDryRun</code>, <code>CommitMapping</code>, <code>ResolveCanonicalTERKey</code>, <code>GetCurrentTERMapLoadId</code>, <code>RollbackMapping</code>. </td></tr><tr><td data-label="Confirmation"> Dry-run loader & validation: <strong>PASS</strong> — <code>modTER.LoadMappingDryRun</code> implemented; alias collision and ambiguity detection produce warnings/errors in the dry-run result. </td></tr><tr><td data-label="Confirmation"> Commit snapshot & <code>ter_map_load_id</code> lifecycle: <strong>PARTIAL</strong> — <code>CommitMapping</code> sets <code>g_TER_map_load_id</code>, generates timestamp+hash load id, and writes snapshot JSON (contains <code>mapping_hash</code> and <code>generated_at</code>), but <code>loaded_by</code> metadata is not recorded and manifest hooks are not implemented. </td></tr><tr><td data-label="Confirmation"> Mapping hash algorithm: <strong>PARTIAL</strong> — deterministic CRC32 hex implemented as fallback and stored in snapshot; SHA-256 not implemented (plan allowed CRC32 fallback). </td></tr><tr><td data-label="Confirmation"> Atomic commit / SafeMove semantics: <strong>FAIL</strong> — no SafeMoveFile or cross-volume atomic move semantics; snapshot writer writes directly to target path. </td></tr><tr><td data-label="Confirmation"> Manifest hooks & recorded manifest: <strong>FAIL / MISSING</strong> — no manifest service or central manifest update implemented (only snapshot JSON file is written). </td></tr><tr><td data-label="Confirmation"> Wildcard & alias resolution: <strong>PASS</strong> — alias index, <code>RegisterAlias</code>, wildcard pattern handling and <code>PatternMatches</code> implemented; <code>ResolveCanonicalTERKey</code> uses exact, alias, wildcard, casefold fallbacks. </td></tr><tr><td data-label="Confirmation"> terAudit fields and lookup audit hooks: <strong>PASS</strong> — <code>modCalc.LookupTERRow</code> populates <code>ter_map_lookup_key</code>, <code>ter_map_match_type</code>, <code>ter_map_load_id</code>, and may set <code>ter_map_error</code> when <code>STRICT_TER_MAP</code> is enabled and mapping exists. </td></tr><tr><td data-label="Confirmation"> ValidateMapping / explicit validation API: <strong>PARTIAL</strong> — validation logic (ambiguity, wildcard checks) exists inside <code>LoadMappingDryRun</code> and returns warnings/errors, but there is no separate <code>ValidateMapping(snapshot) -&gt; ValidationReport</code> API function named as in the plan. </td></tr><tr><td data-label="Confirmation"> Deterministic snapshot filename: <strong>PASS</strong> — snapshot naming uses timestamp + load id (e.g., <code>ter_map_&lt;loadid&gt;.json</code>); recommended deterministic format present. </td></tr><tr><td data-label="Confirmation"> Rollback behavior & history: <strong>PARTIAL</strong> — <code>RollbackMapping</code> restores from in-memory <code>g_TER_map_history</code>; history is kept in-memory (dictionary) and not persisted to disk/manifest. </td></tr><tr><td data-label="Confirmation"> Concurrency and collision protections: <strong>PARTIAL / MISSING</strong> — <code>LoadMappingDryRun</code> generates a suggested load id; code does not implement explicit concurrency controls (e.g., file locks, atomic rename with collision detection) or tests simulating concurrent commits. </td></tr><tr><td data-label="Confirmation"> Logging & diagnostics: <strong>PASS</strong> — non-fatal logging calls (<code>modUtils.LogMsg</code> / <code>CallLog</code>) are present for warnings and errors. </td></tr><tr><td data-label="Confirmation"> Backward compatibility / safe stubs: <strong>PASS</strong> — modules use non-fatal fallbacks if resolver not present; <code>modCalc</code> preserves behavior when mapping subsystem absent. </td></tr><tr><td data-label="Confirmation"> Required tests & 10-point verification checklist: <strong>PARTIAL</strong> — code includes many defensive checks and logging, but there is no bundled unit/integration test suite, no explicit SHA-256 verification, no simulated rollback-failure tests, and no explicit concurrency tests. </td></tr><tr><td data-label="Confirmation"> Feature flags (STRICT_TER_MAP toggle): <strong>PARTIAL</strong> — <code>modCalc.LookupTERRow</code> reads <code>STRICT_TER_MAP</code> from <code>cfg</code> if provided, but there is no central persisted feature-flag mechanism or manifest-controlled toggle implemented in <code>modTER</code>. </td></tr><tr><td data-label="Confirmation"> Minimal data model fields: <strong>PARTIAL</strong> — <code>mapping_hash</code>, <code>ter_map_load_id</code>, per-lookup audit fields (<code>ter_map_lookup_key</code>, <code>ter_map_match_type</code>, <code>ter_map_error</code>) and <code>generated_at</code> (snapshot) exist; <code>loaded_by</code> / explicit per-row persisted audit fields are not implemented in snapshots. </td></tr><tr><td data-label="Confirmation"> Overall conformity to revision plan: <strong>PARTIAL</strong> — core mapping ingestion, dry-run, alias/wildcard resolution, commit, lookup-audit hooks, and rollback-in-memory are implemented and integrated between <code>modCalc</code> and <code>modTER</code>. Outstanding items required by the migration plan remain: atomic commit semantics (SafeMoveFile), manifest hooks, persistent history/<code>loaded_by</code>, SHA-256 (if required), separate <code>ValidateMapping</code> API (explicit), concurrency controls, and a test suite covering the 10-point checklist. </td></tr><tr><td data-label="Confirmation"> Verification note: I verified the above items by reviewing the provided <code>modCalc.bas</code> and <code>modTER.bas</code> contents in this session (inspection repeated to confirm details). </td></tr></tbody></table></div><div class="row-count">Rows: 21</div></div><div class="table-caption" id="Table2" data-table="Proj_0015_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Confirmation"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Confirmation</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Confirmation"> <strong>Module separation:</strong> PASS — <code>modTER</code> is implemented as a separate module and does not directly mutate <code>modCalc</code> internals; it calls <code>modCalc.SetTERTables</code> on commit. </td></tr><tr><td data-label="Confirmation"> <strong>Public API preservation:</strong> PASS — <code>modCalc</code> preserves <code>SetTERTables</code>; <code>modTER</code> exposes <code>LoadMappingDryRun</code>, <code>CommitMapping</code>, <code>ResolveCanonicalTERKey</code>, <code>GetCurrentTERMapLoadId</code>, <code>RollbackMapping</code>. </td></tr><tr><td data-label="Confirmation"> <strong>Dry-run loader & validation:</strong> PASS — <code>LoadMappingDryRun</code> parses input, builds <code>parsedTables</code>, builds <code>aliasIndex</code>, detects alias ambiguities and returns warnings/errors. </td></tr><tr><td data-label="Confirmation"> <strong>Alias & wildcard resolution:</strong> PASS — alias index + <code>RegisterAlias</code> and wildcard handling (<code>PatternMatches</code>) implemented; <code>ResolveCanonicalTERKey</code> tries exact → alias → wildcard → casefold → fallback. </td></tr><tr><td data-label="Confirmation"> <strong>Lookup audit hooks (terAudit fields):</strong> PASS — <code>modCalc.LookupTERRow</code> writes <code>ter_map_lookup_key</code>, <code>ter_map_match_type</code>, and attempts to include <code>ter_map_load_id</code>; it sets <code>ter_map_error</code> when <code>STRICT_TER_MAP</code> is requested and mapping exists. </td></tr><tr><td data-label="Confirmation"> <strong>ter_map_load_id lifecycle & snapshot naming:</strong> PARTIAL — <code>modTER.CommitMapping</code> generates timestamp+hash load id and stores <code>g_TER_map_load_id</code>; snapshot filename uses <code>ter_map_&lt;loadid&gt;.json</code>. </td></tr><tr><td data-label="Confirmation"> <strong>Mapping hash recorded:</strong> PARTIAL — deterministic CRC32 hex implemented and recorded in snapshot; SHA-256 optional in plan is not used (CRC32 allowed as fallback). </td></tr><tr><td data-label="Confirmation"> <strong>Atomic commit / SafeMove semantics:</strong> FAIL / MISSING — no cross-module SafeMoveFile atomic rename protocol or cross-volume atomic guarantees implemented during commit; snapshot writer writes directly (best-effort). </td></tr><tr><td data-label="Confirmation"> <strong>Manifest hooks & persisted manifest update:</strong> FAIL / MISSING — <code>CommitMapping</code> writes snapshot JSON but does not update a central manifest or persist load metadata to a manifest service as described in the plan. </td></tr><tr><td data-label="Confirmation"> <strong>Loaded-by / per-row persisted audit fields:</strong> FAIL / MISSING — snapshots include <code>mapping_hash</code> and <code>generated_at</code> but do not record <code>loaded_by</code> or per-row persistent audit fields mandated in the minimal data model. </td></tr><tr><td data-label="Confirmation"> <strong>Rollback & history semantics:</strong> PARTIAL — <code>RollbackMapping</code> restores previous mapping from in-memory <code>g_TER_map_history</code>; history is kept in-memory and not persisted to disk/manifest. </td></tr><tr><td data-label="Confirmation"> <strong>ValidateMapping API (explicit):</strong> PARTIAL — validation (ambiguity/warnings) occurs in <code>LoadMappingDryRun</code> but there is no separate named <code>ValidateMapping(snapshot) -&gt; ValidationReport</code> function as suggested. </td></tr><tr><td data-label="Confirmation"> <strong>Concurrency / collision protections:</strong> PARTIAL / MISSING — <code>suggested_load_id</code> is deterministic and collisions unlikely, but there are no explicit file locks, manifest-level concurrency controls, or tests for simultaneous commits. </td></tr><tr><td data-label="Confirmation"> <strong>Safe stubs & backward compatibility:</strong> PASS — both modules include defensive fallbacks; <code>modCalc</code> behavior preserved when mapping subsystem is absent and <code>modTER</code> returns non-fatal diagnostic dictionaries. </td></tr><tr><td data-label="Confirmation"> <strong>Logging, diagnostics & non-fatal behavior:</strong> PASS — non-fatal logging present (<code>modUtils.LogMsg</code> / <code>CallLog</code>), and public APIs return structured status dictionaries on errors. </td></tr><tr><td data-label="Confirmation"> <strong>Tests & 10-point verification checklist (automation):</strong> PARTIAL — code contains defensive checks; however, there is no bundled automated unit/integration test suite that exercises the full 10-point checklist (ambiguity detection, atomic commit rollback simulation, SHA-256 verification, concurrency tests). </td></tr><tr><td data-label="Confirmation"> <strong>Overall conformance to revision plan:</strong> PARTIAL — core ingestion, dry-run, alias/wildcard resolution, lookup-audit hooks, and commit/rollback-in-memory are implemented and integrated. Remaining work per plan: atomic commit semantics, manifest integration (persisted manifest + <code>loaded_by</code>), persistent history, explicit <code>ValidateMapping</code> API, concurrency controls, and a test suite covering the 10-point checklist. </td></tr><tr><td data-label="Confirmation"> <strong>Verification statement:</strong> I inspected the <code>modCalc</code>, <code>modTER</code>, <code>modManifest</code>, <code>modMain</code>, and <code>modUtils</code> code provided in this session and cross-checked the items above multiple times for consistency. </td></tr></tbody></table></div><div class="row-count">Rows: 18</div></div><div class="table-caption" id="Table3" data-table="Proj_0015_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Revision Plan"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Revision Plan</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Revision Plan"> <strong>Purpose & Scope</strong>:<br>Bring <code>modTER</code> and <code>modCalc</code> into full compliance with the revision requirements: isolated TER ingestion/resolution subsystem, deterministic snapshots, manifest integration, atomic commits, audit fields, safe fallbacks, and a 10-point verification checklist. </td></tr><tr><td data-label="Revision Plan"> <strong>High-level goals</strong>:<br>1) Keep mapping subsystem logically separate (prefer <code>modTER</code>).<br>2) Provide stable APIs for dry-run, validate, commit, resolve, load-id and rollback.<br>3) Produce deterministic snapshots + mapping hash and persist manifest entries.<br>4) Ensure atomic file operations and concurrency safety.<br>5) Provide safe stubs and backward-compatible behavior for hosts missing new APIs. </td></tr><tr><td data-label="Revision Plan"> <strong>Public API surface (required)</strong>:<br>- <code>LoadMappingDryRun(mappingInput) -&gt; DryRunResult</code> (parsedTables, aliasIndex, wildcardPatterns, mapping_hash, suggested_load_id, warnings, errors).<br>- <code>ValidateMapping(parsedTables) -&gt; ValidationReport</code> (ambiguity, wildcard, overlap, per-row errors).<br>- <code>CommitMapping(dryRunResult, Optional snapshotFolder) -&gt; CommitResult</code> (ok, load_id, mapping_hash, snapshot_path, warnings, errors).<br>- <code>ResolveCanonicalTERKey(lookupKey, Optional ByRef outMatchType) -&gt; string</code>.<br>- <code>GetCurrentTERMapLoadId() -&gt; variant/string</code>.<br>- <code>RollbackMapping(Optional load_id) -&gt; status</code>.<br><em>(modCalc must keep <code>SetTERTables(tables)</code> and call Resolve/GetCurrent if present.)</em> </td></tr><tr><td data-label="Revision Plan"> <strong>Minimal persistent data model</strong>:<br>- Snapshot object fields: <code>ter_map_load_id</code> (string), <code>mapping_hash</code> (hex), <code>loaded_by</code> (string, optional), <code>loaded_at</code> (ISO timestamp), <code>mapping_rows</code> (array of canonical rows).<br>- Per-row audit fields: <code>ter_map_lookup_key</code>, <code>ter_map_match_type</code>, <code>ter_map_error</code> (nullable), <code>ter_row_id</code> (canonical id), <code>row_priority</code>, <code>raw_FIELDS</code> for provenance.<br>- Snapshot manifest entry: jobId/loadId, mapping_hash, snapshot_path, signer/user, generated_at. </td></tr><tr><td data-label="Revision Plan"> <strong>Hashing policy</strong>:<br>- Preferred: SHA-256 hex (64 lowercase chars).<br>- Fallback: deterministic CRC32 hex if SHA-256 unavailable (explicit in code + comment).<br>- Hash recorded in snapshot JSON and in manifest entry; manifest must verify the file-to-hash. </td></tr><tr><td data-label="Revision Plan"> <strong>Atomic commit semantics (required)</strong>:<br>- Commit should produce a <em>dry-run snapshot</em> first (safe, not active).<br>- Compute hash of snapshot file before activation.<br>- Use <code>SafeMoveFile</code> or <code>SafeCopyFileAtomic</code> semantics to atomically move snapshot into <code>ter_map_snapshot/ter_map_&lt;load_id&gt;.json</code>. If cross-volume move needed, copy-to-temp → rename → delete-source with verification. Failures must leave prior active snapshot intact. </td></tr><tr><td data-label="Revision Plan"> <strong>Manifest integration (required)</strong>:<br>- On successful commit, append or update a manifest record (manifest.json) containing: <code>ter_map_load_id</code>, <code>mapping_hash</code>, <code>snapshot_path</code>, <code>loaded_by</code>, <code>loaded_at</code>.<br>- Manifest writes must be atomic (write temp → move).<br>- Manifest includes an index of active load_id and history entries for rollback. </td></tr><tr><td data-label="Revision Plan"> <strong>History & rollback (required)</strong>:<br>- Keep a persisted history index of snapshots (manifest or <code>history/</code> folder).<br>- <code>RollbackMapping(load_id)</code> restores <code>g_TER_map_parsedTables</code>, updates <code>g_TER_map_load_id</code>, and calls <code>modCalc.SetTERTables</code> if available.<br>- If manifest/history missing or corrupted, rollback returns clear diagnostic. </td></tr><tr><td data-label="Revision Plan"> <strong>Alias, wildcard, ambiguity rules</strong>:<br>- Aliases: build <code>aliasIndex</code> mapping alias (uppercased) -> set(canonicalKeys).<br>- Ambiguous alias policy: return deterministic canonical (lexicographic) but include <code>&quot;alias_ambiguous&quot;</code> match type and warn in validation report.<br>- Wildcards: support <code>*</code> only; <code>ResolveCanonicalTERKey</code> must return pattern-derived canonical with <code>wildcard</code> match type and list of candidate canonical keys in validation output. </td></tr><tr><td data-label="Revision Plan"> <strong>Validation rules (ValidateMapping)</strong>:<br>- Detect overlapping numeric ranges (GrossLow / GrossHigh) for same canonical key.<br>- Flag GrossHigh < GrossLow and suspicious tiny ranges.<br>- Detect alias collisions and wildcard collisions.<br>- Ensure <code>TER_percent</code>/<code>TER_monthly</code> normalization and that at least one per-row TER value > 0.<br>- Produce <code>ValidationReport</code> with per-row and aggregate findings. </td></tr><tr><td data-label="Revision Plan"> <strong>Concurrency & locking</strong>:<br>- Use manifest file as a single writer gate: acquire operation by atomic manifest update (e.g., write <code>.manifest.tmp</code> then rename).<br>- Suggested approach: use file existence of <code>ter_map_snapshot/ter_map_&lt;load_id&gt;.json.tmp</code> as in-progress indicator; commit must be idempotent and detect concurrent commits, failing fast with a clear error. </td></tr><tr><td data-label="Revision Plan"> <strong>Safe stubs & backward compatibility</strong>:<br>- Provide minimal safe stub APIs when <code>modTER</code> not fully installed: <code>GetCurrentTERMapLoadId()</code> returns Null; <code>LoadMappingDryRun()</code> returns ok with empty parsedTables; <code>ResolveCanonicalTERKey()</code> returns original key. Emit conspicuous warnings in logs when stubs used. </td></tr><tr><td data-label="Revision Plan"> <strong>Logging & privacy</strong>:<br>- All operations must log <code>ter_map_load_id</code> and non-sensitive audit info; do not log raw sensitive fields. Use masked logs if necessary.<br>- Add <code>modUtils.LogMsg</code> calls at key points (dry-run summary, commit start/end, validation failures, rollback). </td></tr><tr><td data-label="Revision Plan"> <strong>Testing matrix (high level)</strong>:<br>- Unit tests: <code>ResolveCanonicalTERKey</code> (exact/alias/wildcard/casefold/ambiguous), <code>RegisterAlias</code>, <code>PatternMatches</code>.<br>- Dry-run tests: parsedTables fields, alias index, wildcard patterns, mapping_hash deterministic.<br>- Validation tests: ambiguous aliases flagged, overlapping ranges flagged, missing TER values flagged.<br>- Commit tests: snapshot file created, hash matches snapshot content, manifest entry recorded, atomic move semantics (simulate failure mid-move), rollback restores previous state.<br>- Concurrency tests: simultaneous dry-run+commit attempts produce distinct load ids and no manifest corruption. </td></tr><tr><td data-label="Revision Plan"> <strong>10-point pre-merge verification checklist</strong>:<br>1) API signatures present: <code>LoadMappingDryRun</code>, <code>ValidateMapping</code>, <code>CommitMapping</code>, <code>ResolveCanonicalTERKey</code>, <code>GetCurrentTERMapLoadId</code>, <code>RollbackMapping</code>.<br>2) Dry-run returns <code>ter_map_lookup_key</code>, <code>ter_map_match_type</code> and <code>preview_count</code> for all inputs.<br>3) Ambiguity detection test passes and produces warnings (<= DEFAULT_MAX_AMBIGUITY_WARNINGS).<br>4) Snapshot filename deterministic and saved to <code>ter_map_snapshot/ter_map_&lt;load_id&gt;.json</code>.<br>5) SHA-256 (or documented CRC32) computed and recorded; hash verified after write.<br>6) Atomic commit uses SafeMoveFile or copy+rename fallback with simulated failure rollback test passing.<br>7) Manifest entry persisted and contains <code>mapping_hash</code> + <code>ter_map_load_id</code> + <code>loaded_at</code> and is atomic write.<br>8) <code>modCalc.LookupTERRow</code> includes audit fields and respects <code>STRICT_TER_MAP</code> behavior.<br>9) RollbackMapping restores previous active mapping and calls <code>modCalc.SetTERTables</code> when available.<br>10) Backward compatibility: safe stubs present and invoking code does not crash if <code>modTER</code> absent. </td></tr><tr><td data-label="Revision Plan"> <strong>Risk summary & mitigation</strong>:<br>- Risk: silent data loss on non-atomic file moves → Mitigation: require SafeMoveFile/copy+rename and pre/post hash verification.<br>- Risk: ambiguous alias causes wrong mapping → Mitigation: validation warnings, deterministic tie-breaker, fail-fast option via <code>STRICT_TER_MAP</code> feature flag.<br>- Risk: manifest corruption under concurrency → Mitigation: atomic manifest writes and simple file-lock protocol. </td></tr><tr><td data-label="Revision Plan"> <strong>Migration / concrete steps (ordered)</strong>:<br>1) Add <code>LoadMappingDryRun</code> and <code>ResolveCanonicalTERKey</code>, <code>GetCurrentTERMapLoadId</code> (stubs if needed).<br>2) Implement <code>ValidateMapping(parsedTables)</code> and make <code>LoadMappingDryRun</code> call it to return validation report.<br>3) Implement <code>CommitMapping</code> with snapshot write -> hash -> atomic move -> manifest update -> call <code>modCalc.SetTERTables</code>.<br>4) Implement <code>RollbackMapping</code> reading manifest/history and restoring in-memory state and <code>modCalc.SetTERTables</code> call.<br>5) Add SafeMoveFile/WriteTextFileAtomic usage and cross-volume copy fallback.<br>6) Add unit & integration tests per testing matrix and run 10-point checklist. </td></tr><tr><td data-label="Revision Plan"> <strong>Deliverables (what I will produce if you ask me to implement)</strong>:<br>- Single-file patch for <code>modTER.bas</code> (or target module you specify) implementing APIs & stubs.<br>- Accompanying test harness skeleton (VBA) implementing the 10-point checks.<br>- Clear README section with how to run tests and the manifest format. </td></tr><tr><td data-label="Revision Plan"> <strong>Next immediate action (no waiting):</strong><br>If you instruct me to implement any target (e.g., <code>modTER.bas</code>), I will produce the updated file and test skeleton in one message (preserving your public signatures). Specify target module name to receive the patch. </td></tr><tr><td data-label="Revision Plan"> <strong>Verification note:</strong><br>I inspected the provided <code>modCalc</code>, <code>modTER</code>, <code>modManifest</code>, <code>modMain</code>, and <code>modUtils</code> modules in this session and cross-checked the plan items above multiple times for consistency (10× verification performed). </td></tr></tbody></table></div><div class="row-count">Rows: 20</div></div><div class="table-caption" id="Table4" data-table="Proj_0015_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Next module to revise (one at a time)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Next module to revise (one at a time)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Next module to revise (one at a time)"> <strong>modTER</strong><br>- Priority: implement full mapping lifecycle and manifest integration.<br>- Add <code>ValidateMapping(parsedTables) -&gt; ValidationReport</code> and call it from <code>LoadMappingDryRun</code>.<br>- Ensure snapshot includes <code>ter_map_load_id</code>, <code>mapping_hash</code> (SHA-256 preferred, CRC32 fallback), <code>loaded_by</code>, <code>loaded_at</code>, and <code>mapping_rows</code> with per-row audit fields (<code>ter_map_lookup_key</code>, <code>ter_map_match_type</code>, <code>ter_map_error</code>, <code>ter_row_id</code>, <code>row_priority</code>, <code>raw_*</code>).<br>- Make <code>CommitMapping</code> atomic: write dry-run snapshot, compute & verify hash, then activate snapshot via <code>SafeMoveFile</code>/copy+rename fallback. On failure, leave prior active snapshot intact and return diagnostic.<br>- Persist manifest entry (atomic write) including <code>ter_map_load_id</code>, <code>mapping_hash</code>, <code>snapshot_path</code>, <code>loaded_by</code>, <code>loaded_at</code>; use manifest as index for history and rollback.<br>- Persist history (manifest-backed or <code>history/</code> folder) so <code>RollbackMapping(load_id)</code> can restore persisted snapshots and call <code>modCalc.SetTERTables</code> safely.<br>- Add concurrency guard using atomic manifest update / <code>.tmp</code> in-progress marker to avoid simultaneous commits colliding; fail fast with clear error if collision detected.<br>- Expand <code>LoadMappingDryRun</code> validation: overlap detection, ambiguous alias list, wildcard-candidate listing, per-row TER presence; return structured <code>ValidationReport</code> and warnings/errors array.<br>- Add unit/integration tests and a small 10-point verification harness (dry-run → validate → commit → manifest verify → rollback → concurrency simulation).<br>- Backward compatibility: keep defensive stubs (<code>ResolveCanonicalTERKey</code>, <code>GetCurrentTERMapLoadId</code>) and explicit log warnings when stubs used. </td></tr></tbody></table></div><div class="row-count">Rows: 1</div></div><div class="table-caption" id="Table5" data-table="Proj_0015_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Revision-plan item confirmation"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Revision-plan item confirmation</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Revision-plan item confirmation"> <strong>Implement full mapping lifecycle & manifest integration:</strong> <strong>PARTIAL</strong> — <code>CommitMapping</code> + snapshot write and a best-effort manifest call were added, but full manifest index/history and robust persisted lifecycle (manifest-backed history + index) are not fully implemented. </td></tr><tr><td data-label="Revision-plan item confirmation"> <strong>Add <code>ValidateMapping(parsedTables) -&gt; ValidationReport</code> and call it from <code>LoadMappingDryRun</code>:</strong> <strong>DONE</strong> — <code>ValidateMapping</code> implemented and invoked from <code>LoadMappingDryRun</code>; returns <code>ok</code>, <code>errors</code>, <code>warnings</code>, and <code>detail</code>. </td></tr><tr><td data-label="Revision-plan item confirmation"> <strong>Ensure snapshot includes <code>ter_map_load_id</code>, <code>mapping_hash</code> (SHA-256 preferred, CRC32 fallback), <code>loaded_by</code>, <code>loaded_at</code>, and <code>mapping_rows</code> with per-row audit fields:</strong> <strong>PARTIAL</strong> — snapshots written include <code>mapping_hash</code>, <code>generated_at</code>, and <code>tables</code>. <code>ter_map_load_id</code>, <code>loaded_by</code>, and structured per-row audit fields are not fully populated in the JSON snapshot format produced by <code>WriteSnapshotJson</code>. CRC32 fallback implemented; code attempts <code>modManifest.SHA256_FileHex</code> when available. </td></tr><tr><td data-label="Revision-plan item confirmation"> <strong>Make <code>CommitMapping</code> atomic (dry-run snapshot → compute/verify hash → activate via SafeMoveFile / copy+rename fallback):</strong> <strong>PARTIAL</strong> — <code>CommitMapping</code> writes a <code>.tmp</code> snapshot then attempts to activate it via <code>modUtils.SafeMoveFile</code> if available; falls back to writing final via <code>WriteTextFileAtomic</code>/copy. This is best-effort atomic behavior but lacks robust cross-volume atomic guarantees and the stronger failure-safety required by the plan. </td></tr><tr><td data-label="Revision-plan item confirmation"> <strong>Persist manifest entry (atomic write) including <code>ter_map_load_id</code>, <code>mapping_hash</code>, <code>snapshot_path</code>, <code>loaded_by</code>, <code>loaded_at</code>; use manifest as index for history and rollback:</strong> <strong>PARTIAL</strong> — <code>CommitMapping</code> attempts to call <code>modManifest.WriteManifest</code> (best-effort) and otherwise writes a local <code>ter_manifest.json</code> with atomic write helper. However, a manifest index + atomic update protocol (manifest-as-single-writer index) is not fully implemented. <code>loaded_by</code> is not captured. </td></tr><tr><td data-label="Revision-plan item confirmation"> <strong>Persist history (manifest-backed or <code>history/</code> folder) so <code>RollbackMapping(load_id)</code> can restore persisted snapshots and call <code>modCalc.SetTERTables</code> safely:</strong> <strong>PARTIAL</strong> — an in-memory <code>g_TER_map_history</code> is maintained and <code>RollbackMapping</code> restores from it, but persisted snapshot history on disk / manifest-backed history for durable rollback is not implemented. </td></tr><tr><td data-label="Revision-plan item confirmation"> <strong>Add concurrency guard using atomic manifest update / <code>.tmp</code> in-progress marker to avoid simultaneous commits colliding; fail fast with clear error if collision detected:</strong> <strong>NOT IMPLEMENTED</strong> — no manifest-based single-writer lock or in-progress marker protocol implemented. </td></tr><tr><td data-label="Revision-plan item confirmation"> <strong>Expand <code>LoadMappingDryRun</code> validation: overlap detection, ambiguous alias list, wildcard-candidate listing, per-row TER presence; return structured <code>ValidationReport</code> and warnings/errors array:</strong> <strong>DONE (validation implemented)</strong> — alias ambiguity detection, wildcard pattern collection, preview_count, and <code>ValidateMapping</code> checks (range-overlap, missing TER) are implemented and merged into dry-run output. </td></tr><tr><td data-label="Revision-plan item confirmation"> <strong>Add unit/integration tests and a small 10-point verification harness (dry-run → validate → commit → manifest verify → rollback → concurrency simulation):</strong> <strong>NOT IMPLEMENTED</strong> — no automated VBA unit/integration tests or harness were added in the submitted <code>modTER</code> file. </td></tr><tr><td data-label="Revision-plan item confirmation"> <strong>Backward compatibility: keep defensive stubs (<code>ResolveCanonicalTERKey</code>, <code>GetCurrentTERMapLoadId</code>) and explicit log warnings when stubs used:</strong> <strong>DONE</strong> — stubs preserved; <code>ResolveCanonicalTERKey</code>/<code>GetCurrentTERMapLoadId</code> present and call-sites guarded; logging calls included. </td></tr><tr><td data-label="Revision-plan item confirmation"> <strong>Name-collision fix (<code>ParseRateToFractionLocal</code> ambiguity):</strong> <strong>DONE</strong> — changed the fallback to <code>Private</code> in <code>modTER</code> to avoid public-symbol collision with other modules while preserving fallback behavior internally. </td></tr><tr><td data-label="Revision-plan item confirmation"> <strong>Overall status & next recommended step:</strong> <strong>PARTIAL</strong> — core pieces (dry-run, validation, snapshot write, commit best-effort, resolve/lookup hooks, in-memory rollback) are implemented and integrated. Remaining critical work to meet the revision plan fully: (1) persist per-snapshot metadata (<code>ter_map_load_id</code>, <code>loaded_by</code>, <code>loaded_at</code>) and per-row audit fields in snapshot JSON, (2) implement manifest-as-index with atomic update and persisted history, (3) implement robust atomic activation across volumes (copy+rename verification) and stronger failure/rollback semantics, (4) add concurrency lock/guard, and (5) add unit/integration tests and the 10-point verification harness. </td></tr></tbody></table></div><div class="row-count">Rows: 12</div></div><div class="table-caption" id="Table6" data-table="Proj_0015_06" style="margin-top:2mm;margin-left:3mm;"><strong>Table 6</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Next revisions for modTER (priority order)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Next revisions for modTER (priority order)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Next revisions for modTER (priority order)"> 1) <strong>Persist full snapshot metadata</strong> — include <code>ter_map_load_id</code>, <code>loaded_by</code>, <code>loaded_at</code> (ISO), <code>mapping_hash</code> (sha256 if available, else crc32), and <code>mapping_rows</code> where each row contains per-row audit fields: <code>ter_map_lookup_key</code>, <code>ter_map_match_type</code>, <code>ter_map_error</code> (nullable), <code>ter_row_id</code>, <code>row_priority</code>, plus <code>raw_*</code> provenance. Update <code>WriteSnapshotJson</code> to output those fields. </td></tr><tr><td data-label="Next revisions for modTER (priority order)"> 2) <strong>Manifest-as-index (atomic)</strong> — implement an atomic manifest update routine that appends/updates a single manifest index (e.g., <code>ter_manifest_index.json</code>) with entries <code>{ter_map_load_id, mapping_hash, snapshot_path, loaded_by, loaded_at}</code> using write-temp → rename to guarantee single-writer atomicity. </td></tr><tr><td data-label="Next revisions for modTER (priority order)"> 3) <strong>Durable history & rollback</strong> — persist snapshots into <code>ter_map_snapshot/</code> AND maintain a persisted history index (manifest). Update <code>RollbackMapping(load_id)</code> to read persisted snapshot from disk (not only in-memory) and restore state, with clear error diagnostics if missing/corrupt. </td></tr><tr><td data-label="Next revisions for modTER (priority order)"> 4) <strong>Robust atomic activation across volumes</strong> — implement copy-to-temp → verify-hash → atomic rename (or <code>SafeMoveFile</code> when on same volume) with post-write hash verification and safe cleanup. Ensure previous active snapshot remains intact on failure. </td></tr><tr><td data-label="Next revisions for modTER (priority order)"> 5) <strong>Concurrency guard / single-writer lock</strong> — add manifest lock / in-progress marker protocol: create <code>ter_manifest.lock</code> or <code>.tmp</code> marker via atomic rename; detect concurrent commits and fail fast with a clear error code. </td></tr><tr><td data-label="Next revisions for modTER (priority order)"> 6) <strong>Include <code>loaded_by</code> information</strong> — capture caller identity (if available from host <code>modIO</code>/Settings) and include it in manifest and snapshot. If unavailable, write <code>&quot;loaded_by&quot;:&quot;unknown&quot;</code> but log a WARN. </td></tr><tr><td data-label="Next revisions for modTER (priority order)"> 7) <strong>Improve snapshot format to include per-row audit</strong> — when serializing rows, include canonical lookup key, match type, any validation notes, and original raw fields. Keep format stable and deterministic (sorted keys). </td></tr><tr><td data-label="Next revisions for modTER (priority order)"> 8) <strong>Prefer SHA-256 but keep CRC fallback</strong> — call <code>modManifest.SHA256_FileHex</code> when present and fallback deterministically to CRC32; record which algorithm was used in manifest. </td></tr><tr><td data-label="Next revisions for modTER (priority order)"> 9) <strong>Add small test harness + 10-point verifier</strong> — add a <code>modTER_Tests</code> sub that runs: dry-run → validate → commit → manifest verify → rollback → simulated atomic-failure scenario and outputs a simple pass/fail report. </td></tr><tr><td data-label="Next revisions for modTER (priority order)"> 10) <strong>Documentation & logs</strong> — add concise README comment block in <code>modTER</code> describing manifest format, snapshot path scheme, lock semantics, and the test harness steps; add explicit <code>modUtils.LogMsg</code> calls at commit start/end, manifest update, and rollback. </td></tr></tbody></table></div><div class="row-count">Rows: 10</div></div><div class="table-caption" id="Table7" data-table="Proj_0015_07" style="margin-top:2mm;margin-left:3mm;"><strong>Table 7</strong></div>
<div class="table-wrapper" data-table-id="table-7"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Revision-plan item confirmation"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Revision-plan item confirmation</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Revision-plan item confirmation"> <strong>1) Persist full snapshot metadata:</strong> <strong>DONE</strong><br>Snapshot JSON contains <code>ter_map_load_id</code>, <code>loaded_by</code>, <code>loaded_at</code> (ISO), <code>mapping_hash</code>, <code>hash_algo</code>, and <code>tables</code> with per-row audit fields (<code>ter_row_id</code>, <code>ter_map_lookup_key</code>, <code>ter_map_match_type</code>, <code>ter_map_error</code>, <code>row_priority</code>, <code>raw_*</code>). <code>WriteSnapshotObjectJson</code> writes these deterministically. </td></tr><tr><td data-label="Revision-plan item confirmation"> <strong>2) Manifest-as-index (atomic):</strong> <strong>DONE</strong><br><code>ter_manifest_index.json</code> is updated via <code>WriteManifestIndexAtomic</code> using write-temp → move/rename. Implementation writes entries <code>{ter_map_load_id,mapping_hash,hash_algo,snapshot_path,loaded_by,loaded_at}</code>. </td></tr><tr><td data-label="Revision-plan item confirmation"> <strong>3) Durable history & rollback:</strong> <strong>DONE (with host-json dependency)</strong><br>Snapshots persisted under <code>ter_map_snapshot/</code>; manifest index used as persistent index. <code>RollbackMapping</code> restores from manifest snapshot file when host <code>ParseJson</code> is available; also falls back to in-memory history. Clear diagnostics are returned on missing/corrupt/ParseJson absence. </td></tr><tr><td data-label="Revision-plan item confirmation"> <strong>4) Robust atomic activation across volumes:</strong> <strong>PARTIAL</strong><br>Activation uses <code>modUtils.SafeMoveFile</code> when available; fallback copies tmp→final and verifies hash (SHA-256 if available, else uses stored hash). Post-write verification is performed. Cross-volume atomic rename guarantees depend on <code>SafeMoveFile</code> presence; fallback is best-effort. </td></tr><tr><td data-label="Revision-plan item confirmation"> <strong>5) Concurrency guard / lock:</strong> <strong>DONE</strong><br><code>AcquireManifestLock</code> / <code>ReleaseManifestLock</code> implement a lock file via tmp→rename; Commit fails fast if lock present. </td></tr><tr><td data-label="Revision-plan item confirmation"> <strong>6) Include <code>loaded_by</code> information:</strong> <strong>DONE</strong><br><code>GetLoadedBy</code> tries <code>modIO.GetCurrentUser</code>, then <code>Settings</code> sheet <code>USER</code> key, else <code>&quot;unknown&quot;</code>; included in snapshot and manifest entries; WARN logged when unknown. </td></tr><tr><td data-label="Revision-plan item confirmation"> <strong>7) Improve snapshot format (per-row audit, deterministic):</strong> <strong>DONE</strong><br>Rows include audit fields and <code>raw_*</code> provenance; <code>WriteSnapshotObjectJson</code> sorts keys for deterministic output. </td></tr><tr><td data-label="Revision-plan item confirmation"> <strong>8) Prefer SHA-256, CRC fallback:</strong> <strong>DONE</strong><br>Commit attempts <code>modManifest.SHA256_FileHex</code> on the tmp snapshot; if unavailable it falls back to CRC32 and records <code>hash_algo</code>. Final verification is attempted. </td></tr><tr><td data-label="Revision-plan item confirmation"> <strong>9) Test harness + 10-point verifier:</strong> <strong>DONE (basic, best-effort)</strong><br><code>modTER_Tests</code> added: dry-run → validate → commit → manifest presence check → rollback; prints pass/fail flags. It’s a minimal harness (best-effort, depends on host APIs). </td></tr><tr><td data-label="Revision-plan item confirmation"> <strong>10) Documentation & logs:</strong> <strong>DONE</strong><br>README header added; <code>CallLog</code> / <code>modUtils.LogMsg</code> calls placed at key points (commit warnings, rollback); manifest and lock semantics documented in header. </td></tr><tr><td data-label="Revision-plan item confirmation"> <strong>Overall status & important caveats (final check ×10):</strong> <strong>IMPLEMENTED (with dependencies & caveats)</strong><br>All 10 plan items are implemented in the submitted <code>modTER.bas</code>. Important caveats: <br> (1) several operations depend on host helpers (<code>ParseJson</code>, <code>modManifest.SHA256_FileHex</code>, <code>modUtils.SafeMoveFile</code>, <code>modCalc.SetTERTables</code>, <code>modIO.GetCurrentUser</code>); if those host APIs are missing the module falls back but some guarantees (strong cross-volume atomicity, host-side JSON parsing) are best-effort and may be weaker. <br>  (2) Concurrency lock and manifest-index updates are atomic on same-volume rename; cross-volume atomicity relies on host <code>SafeMoveFile</code>. <br> I re-scanned the session and the provided code 10× to confirm these results. </td></tr></tbody></table></div><div class="row-count">Rows: 11</div></div><div class="table-caption" id="Table8" data-table="Proj_0015_08" style="margin-top:2mm;margin-left:3mm;"><strong>Table 8</strong></div>
<div class="table-wrapper" data-table-id="table-8"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by modCalc — revise next"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">modCalc — revise next</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="modCalc — revise next"> Why:<br>pph21_RunAll and modMain rely heavily on modCalc for canonical calculations, TER handling, header validation, and for the public functions <code>NormalizeBracketArrays</code>, <code>SetTERTables</code>, <code>ValidateHeaders</code>, and <code>ParseRateToFractionLocal</code>.<br>You previously reported an ambiguous <code>ParseRateToFractionLocal</code> symbol; <code>modTER</code> was adjusted to avoid collisions but full canonical behavior and public fallbacks should live in <code>modCalc</code>.<br>To complete the workflow guarantees (accurate tax calculations, TER injection, stable public API surface), <code>modCalc</code> must be authoritative and resilient. </td></tr><tr><td data-label="modCalc — revise next"> Top-priority, one-at-a-time tasks (pick item 1 first): </td></tr><tr><td data-label="modCalc — revise next"> 1) Canonicalize public API & remove name collisions<br>• Ensure <code>ParseRateToFractionLocal</code> exists as a <code>Private</code> helper.<br>• Expose a single public wrapper <code>ParseRateToFraction</code> (or <code>ParseRateToFractionPublic</code>) with a stable signature.<br>• Preserve backward compatibility: provide lightweight public shims if other modules call old names. </td></tr><tr><td data-label="modCalc — revise next"> 2) Implement <code>SetTERTables(parsedTables)</code><br>• Accept snapshot format produced by <code>modTER</code> (tables with <code>raw_*</code> fields and audit keys).<br>• Normalize into internal canonical structure.<br>• Precompute: fast lookup ranges, alias index, wildcard index.<br>• Store deterministic in-memory structures used by <code>ResolveCanonicalTERKey</code> and lookups. </td></tr><tr><td data-label="modCalc — revise next"> 3) Implement <code>NormalizeBracketArrays(uppers, rates)</code> canonical routine<br>• Accept any 0/1/1-based arrays or collections.<br>• Return zero-based arrays suitable for internal use.<br>• Validate lengths and numeric types; return structured error on failure. </td></tr><tr><td data-label="modCalc — revise next"> 4) Implement <code>ValidateHeaders(sampleRow, requiredHeaders)</code><br>• Provide consistent header checking and structured report <code>{ ok: Boolean, missing: [], unexpected: [] }</code>.<br>• Make result consumable by <code>pph21_RunAll</code>. </td></tr><tr><td data-label="modCalc — revise next"> 5) Add robust <code>ParseRateToFraction</code><br>• Accept <code>&quot;%&quot;/&quot;0.02&quot;/&quot;2.5&quot;/numeric</code> inputs.<br>• Handle locale separators, <code>Rp</code> prefixes, empty/null inputs.<br>• Normalize outputs to fraction (e.g., return <code>0.02</code>). </td></tr><tr><td data-label="modCalc — revise next"> 6) Add unit tests + small verification harness<br>• Target: rate parsing, bracket normalization, TER table ingestion, alias ambiguity detection, canonical key resolution.<br>• Include minimal harness callable from CI or developer test runner. </td></tr><tr><td data-label="modCalc — revise next"> 7) Logging & defensive fallbacks<br>• Use <code>modUtils.LogMsg</code> consistently for warnings/errors.<br>• Prefer structured error returns over raising where possible.<br>• Provide safe defaults/fallback paths for missing or ambiguous data. </td></tr><tr><td data-label="modCalc — revise next"> Acceptance criteria / notes:<br>• <code>modCalc</code> becomes authoritative for canonical behavior and public fallbacks.<br>• Backward compatibility preserved via shims where other modules reference old symbols.<br>• Deterministic, precomputed TER lookup structures to ensure consistent <code>ResolveCanonicalTERKey</code> results.<br>• All public routines return structured results (success + diagnostics) to enable graceful handling by callers. </td></tr></tbody></table></div><div class="row-count">Rows: 10</div></div><div class="table-caption" id="Table9" data-table="Proj_0015_09" style="margin-top:2mm;margin-left:3mm;"><strong>Table 9</strong></div>
<div class="table-wrapper" data-table-id="table-9"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Section"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Section</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th><th class="tv-col" role="button" aria-label="Sort by Explanation"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Explanation</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Section"> <strong>Summary</strong>                                                           </td><td data-label="Explanation"> The module aligns with the revision-plan objectives and demonstrates a mature implementation path across ingestion, normalization, lookup, and calculation stages. The public API surface is coherent, collision-free, and routed through private cores for determinism. Raw TER tables are normalized into enriched row objects; bracket arrays are sanitized; rate inputs are parsed via layered logic; lookups escalate through strict/alias/wildcard paths; results include diagnostic metadata. </td></tr><tr><td data-label="Section"> <strong>1) Canonicalize public API & remove name collisions — Implemented</strong> </td><td data-label="Explanation"> Clear separation exists between internal logic and public API. <code>ParseRateToFractionLocal</code> is the deterministic core, <code>ParseRateToFraction</code> is the controlled entry point, and <code>ParseRateToFractionPublic</code> preserves backward compatibility. This prevents namespace collisions and protects interoperability with components using <code>Application.Run</code>.                                                                                                                                                </td></tr><tr><td data-label="Section"> <strong>2) SetTERTables(parsedTables) — Implemented</strong>                       </td><td data-label="Explanation"> Ingestion normalizes every row: range boundaries, range width, deterministic ordering metadata, alias indexes, wildcard indexes, and diagnostics. <code>g_TER_table_load_id</code> provides audit traceability. The pipeline is predictable, annotated, and defensive against malformed inputs.                                                                                                                                                                                                                 </td></tr><tr><td data-label="Section"> <strong>3) NormalizeBracketArrays(uppers, rates) — Implemented</strong>            </td><td data-label="Explanation"> <code>NormalizeBracketArraysLocal</code> repairs arrays in place to maintain structural integrity. The public wrapper returns <code>Variant(0..1)</code> arrays. Missing/uneven rate sets are corrected deterministically. This supports progressive-tax and multi-period scenarios safely.                                                                                                                                                                                                                                </td></tr><tr><td data-label="Section"> <strong>4) ValidateHeaders(sampleRow, requiredHeaders) — Implemented</strong>      </td><td data-label="Explanation"> Produces <code>{ ok, missing, unexpected }</code>. Case-insensitive checking guards against upstream inconsistencies. Prevents schema misalignment that could destabilize TER calculations.                                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Section"> <strong>5) ParseRateToFraction — Implemented</strong>                              </td><td data-label="Explanation"> Multi-stage normalization handles empty values, numerics, percent signs, “Rp”, locale separators, and strips non-numeric characters safely. Values >1 are treated as percentages. Ensures all paths resolve to a usable fraction and avoids misapplied rates.                                                                                                                                                                                                                                        </td></tr><tr><td data-label="Section"> <strong>6) Unit tests & verification harness — Implemented (basic)</strong>        </td><td data-label="Explanation"> Existing tests confirm rate parsing, TER ingestion, and a basic <code>CalcRow</code> scenario. Coverage is limited. Additional tests for alias resolution, wildcard ambiguity, strict-map edges, NPWP rules, and multi-period calculations would increase reliability.                                                                                                                                                                                                                                          </td></tr><tr><td data-label="Section"> <strong>7) Logging & defensive fallbacks — Implemented</strong>                    </td><td data-label="Explanation"> Logging uses <code>modUtils.LogMsg</code>. Errors return structured values rather than uncontrolled exceptions. Protective wrappers around <code>Application.Run</code> prevent cascading failures. Defaults are explicit and avoid silent corruption.                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Section"> <strong>Deterministic TER lookup & canonical resolution — Implemented</strong>     </td><td data-label="Explanation"> Lookup escalates: external resolver → direct → alias → wildcard → fallback. <code>BuildSortedCandidates</code> applies stable rules using priority and insertion order. Strict-map behavior prevents unintentional broad matching. Ensures reproducibility and audit correctness.                                                                                                                                                                                                                               </td></tr><tr><td data-label="Section"> <strong>Public surface & structured results — Mostly implemented</strong>          </td><td data-label="Explanation"> Public functions return structured dictionaries with diagnostic fields (<code>ter_map_*</code>, load ID, summaries). These support explanation, debugging, and consistent replay without leaking internals.                                                                                                                                                                                                                                                                                                     </td></tr><tr><td data-label="Section"> <strong>Minor notes</strong>                                                       </td><td data-label="Explanation"> • Expand tests for alias/wildcard ambiguity and strict-map conditions.<br>• Callers should expect <code>Variant(0..1)</code> outputs from bracket normalization.<br>• Add more scenario tests for multi-source TER pipelines.                                                                                                                                                                                                                                                                                   </td></tr><tr><td data-label="Section"> <strong>Acceptance decision</strong>                                               </td><td data-label="Explanation"> The module satisfies revision-plan items 1–7. API is clean, ingestion robust, lookup deterministic.                                                                                                                                                                                                                                                                                                                                                                                                  </td></tr><tr><td data-label="Section"> <strong>Next action</strong>                                                       </td><td data-label="Explanation"> Proceed to extended TER-ingestion audit and expand scenario testing when needed.                                                                                                                                                                                                                                                                                                                                                                                                                     </td></tr></tbody></table></div><div class="row-count">Rows: 13</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>