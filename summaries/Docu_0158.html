<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1766994456">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#Table6">Table 6</a></li>
<li class="toc-item"><a class="toc-link" href="#Table7">Table 7</a></li>
<li class="toc-item"><a class="toc-link" href="#Table8">Table 8</a></li>
<li class="toc-item"><a class="toc-link" href="#Table9">Table 9</a></li>
<li class="toc-item"><a class="toc-link" href="#Table10">Table 10</a></li>
<li class="toc-item"><a class="toc-link" href="#Table11">Table 11</a></li>
<li class="toc-item"><a class="toc-link" href="#Table12">Table 12</a></li>
<li class="toc-item"><a class="toc-link" href="#Table13">Table 13</a></li>
<li class="toc-item"><a class="toc-link" href="#Table14">Table 14</a></li>
<li class="toc-item"><a class="toc-link" href="#Table15">Table 15</a></li>
<li class="toc-item"><a class="toc-link" href="#Table16">Table 16</a></li>
<li class="toc-item"><a class="toc-link" href="#Table17">Table 17</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0158_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide"> <strong>Document authority & scope</strong><br> This runbook is the single authoritative source for everything operators, developers, auditors, compliance reviewers and incident responders need to operate, maintain, verify, and audit the Excel add-in system. It defines responsibilities and procedures for design, development, deployment, incident response, auditability, and regulatory interactions. When guidance elsewhere conflicts with this document, this document prevails. Language here is prescriptive: follow steps exactly and record deviations in audit. This document is normative for operational work and evidence collection; sections labeled "MUST", "SHOULD", and "MAY" follow the same intent as RFC-style guidance where "MUST" is mandatory, "SHOULD" is recommended and requires justification if not followed, and "MAY" is optional. Any local adaptations require a compliance exception ticket and two-person approval recorded in audit. <br> <strong>Change history:</strong> every edit to this runbook MUST be recorded in the runbook's change log with author, date, rationale, linked PR/issue, and compliance sign-off when relevant. <br> <strong>Scope boundaries:</strong> this runbook governs the add-in codebase, packaged helpers, CI/CD pipeline gates affecting regulatory outputs, release manifests, audit chain design, and operational playbooks. It does not govern unrelated Excel macros, third-party add-ins, or external accounting systems except where direct integration is specified; those are covered by integration contracts described in appendices. </td></tr><tr><td data-label="Technical User Guide"> <strong>Audience</strong><br> This document is written to be usable by non-technical operators following step-by-step runbooks, by developers implementing deterministic calculations and migrations, by IT and release engineers performing upgrades and rollbacks, and by auditors and compliance teams verifying evidence. Each section provides background, commands or exact actions to perform, what to observe, expected outputs, and the evidence to collect for each scenario. Where skill-level matters, a header marks whether steps are Operator-level (no code), Engineer-level (requires credentials and terminal), or Developer-level (requires code-level changes and CI). Use the "Evidence to collect" checklists at the end of each procedural section to ensure artifacts are preserved for compliance. </td></tr><tr><td data-label="Technical User Guide"> <strong>Design principles (non-negotiable)</strong><br> The system is built around a small set of inviolable principles: determinism (same inputs + same config → same outputs), complete auditability (every judgment recorded), recoverability (jobs checkpointed and restorable), explicit failure (no silent corrections), immutable evidence (append-only audit chain), minimal direct Excel COM interactions, side-effect isolation, and strict reproducibility across supported environments. Any design or operational change that weakens these principles is disallowed without explicit compliance sign-off. Design reviews MUST include a determinism impact assessment and an auditability impact assessment. All code that touches regulatory outputs must include a canonical fixture and self-test. Any deviation from these principles requires a written risk assessment and two-person sign-off logged in audit. </td></tr><tr><td data-label="Technical User Guide"> <strong>Golden rule & mental model</strong><br> The guiding operational model is simple and must be repeated in training: Excel hosts the add-in; the add-in orchestrates work; heavy computation executes as jobs outside direct UI work; outputs are written atomically; and the audit is the system of record. If an action or result is not present in audit, it is not authoritative. Treat Excel as a UI and cache, not as the system of record. Users and operators must be trained to never rely on Excel worksheet contents as final evidence without verifying the audit chain and output checksums. The canonical mental model for incident triage:<br> 1) Verify audit entries and correlation id;<br> 2) Confirm job descriptor and job state;<br> 3) Reproduce deterministic compute in isolated runner with identical inputs and config;<br> 4) Validate produced artifact checksums against archived golden hashes. </td></tr><tr><td data-label="Technical User Guide"> <strong>Roles, responsibilities & SLAs</strong><br> Define and publish the primary roles (Product Owner, Release Engineer, Compliance Officer, Security Lead, On-call SRE, Support Engineer, Developer) and the RACI model for changes, incidents, and releases. Establish operational SLAs: production availability objectives, paging windows for critical incidents, response and acknowledgement times for on-call, and defined change-freeze periods (for example during financial close). All role assignments and escalation lists must be maintained in a visible roster and accessible from runbook links. <br> <strong>Minimum SLAs (example):</strong><br> Acknowledge critical page within 15 minutes, begin mitigations within 1 hour, run first forensic export within 3 hours, and produce interim status to stakeholders within 6 hours. SLA exceptions must be pre-authorized and recorded in audit. </td></tr><tr><td data-label="Technical User Guide"> <strong>Quick start & mandatory smoke tests (purpose & checklist)</strong><br> Always begin diagnosis with a short, repeatable smoke test that validates the add-in is fundamentally alive: close Excel completely, confirm no orphan EXCEL.EXE, start Excel as the installing user, open a known-good workbook, confirm ribbon initialization within the expected window, run the smallest built-in action (self-test), validate a progress indicator and the presence of an output or test-result sheet, and confirm an audit row has been appended with the action’s correlation id. If any step fails, stop and escalate following the Common Failures playbook — do not continue deeper troubleshooting without preserving evidence. <br> <strong>Smoke test steps (operator):</strong><br> 1) Close Excel and verify no EXCEL.EXE in Task Manager/ps.<br> 2) Launch Excel and open <code>KnownGoodWorkbook.xslx</code> (provided in artifacts).<br> 3) Wait maximum bootstrap window (configurable, default 12s).<br> 4) Trigger <code>SelfTest -&gt; Run</code>.<br> 5) Observe expected <code>_SelfTest</code> sheet and audit row with correlation id format <code>yyyyMMdd-HHMMSS-&lt;module&gt;-&lt;rand8&gt;</code>.<br> 6) Collect <code>bootstrap.log</code>, <code>ribbon.log</code>, and the generated audit row.<br> <strong>Expected outputs:</strong> ribbon initializes, self-test sheet present, audit row appended within 3 seconds of action, no error codes > WARN. <br> <strong>Evidence to collect:</strong> <code>bootstrap.log</code>, <code>ui.log</code>, <code>audit_tail.csv</code> (last 50 rows), copy of <code>KnownGoodWorkbook</code> with appended <code>_SelfTest</code> sheet. </td></tr><tr><td data-label="Technical User Guide"> <strong>Full lifecycle & control-flow (phases & guarantees)</strong><br> The add-in lifecycle has five phases: lightweight bootstrap (open logs, register shutdown hooks, do not perform heavy IO), deferred initialization (load config, verify dependencies, initialize audit buffers, resolve flags), idle-ready (ribbon handlers live and responsive), job scheduling & execution (jobs persist descriptors, execute with checkpoints, and produce audit rows), and completion/shutdown (atomic commits, audit flushes, and resource release). Each phase has explicit guarantees about what may and may not run there to avoid freezing Excel or losing audit fidelity. Determinism rules — inputs + config + flags + deterministic seed produce identical artifacts — are enforced and verified in CI. <br> <strong>Phase checks:</strong> at bootstrap confirm <code>bootstrap.started</code> log entry; at deferred init confirm <code>config.loaded</code> and <code>deps.reported</code>; at idle-ready confirm <code>ribbon.ready</code>; at scheduling confirm <code>job.persisted:&lt;jobid&gt;</code>; at completion confirm <code>audit.flushed:&lt;jobid&gt;</code> and <code>artifact.checksum:&lt;sha256&gt;</code>. </td></tr><tr><td data-label="Technical User Guide"> <strong>Module architecture and single-responsibility boundaries</strong><br> The add-in is intentionally modular. Each module has a tight single responsibility, explicit public interfaces, and a required audit contract. Modules must never duplicate centralized policies (config loading, audit writing, error mapping). This boundary discipline makes troubleshooting deterministic: when a symptom is observed, follow the ownership map to the responsible module and inspect its logs and audit rows before attempting corrective action. Ownership map is maintained in <code>OWNERS.md</code> and in the release manifest. When modifying or adding modules, include an ownership entry, interface contract (inputs/outputs), and a module-level audit schema. </td></tr><tr><td data-label="Technical User Guide"> <strong>modBootstrap responsibilities and verification</strong><br> modBootstrap brings the system to life safely — it opens structured logs, creates the correlation id generator, schedules deferred initialization on the UI idle loop, and registers process shutdown handlers. It must never perform heavy computation, network calls, or Excel Range access during bootstrap. Verify correct behavior by checking bootstrap logs for expected start and deferred-init scheduling entries. If bootstrap fails or the add-in is auto-disabled by Excel, document bootstrap logs and follow reinstall and permission-fix procedures. <br> <strong>Operator verification steps:</strong> confirm <code>init-scheduled</code> and absence of long-blocking calls in <code>bootstrap.log</code>; collect <code>excel-register-state</code> (COM/VSTO registration keys) and Windows event logs if auto-disable occurred. </td></tr><tr><td data-label="Technical User Guide"> <strong>modRibbonCallbacks responsibilities and verification</strong><br> Ribbon callbacks map each control id to exactly one handler. Handlers perform lightweight validation and either execute trivial actions inline or schedule jobs for heavy work. Every click must produce a structured log entry with control id and correlation id, and an audit UserAction row. If buttons are unresponsive, inspect customUI resources, Ribbon_OnLoad logs, and the click mapping — repair the resource or re-register callbacks rather than modifying behavior ad-hoc. Maintain a canonical <code>ribbon-map.json</code> in the repo documenting control id → handler mapping and required permissions. </td></tr><tr><td data-label="Technical User Guide"> <strong>modConfig responsibilities and governance</strong><br> Config is the single source of runtime truth: load once, validate schema, apply idempotent migrations before use, and treat resolved values as immutable for the running process unless changed through controlled update flows. Missing keys must be replaced by safe defaults; the system must never crash on absent or extra keys. Any change to configuration that impacts regulatory computations must follow the change-control policy (ticketing, two-person approval where required, migration manifest, and audit entries recording operator and rationale). <br> <strong>Config format:</strong> JSON Schema v7 with versioned namespace <code>config.v&lt;major&gt;</code>. Example minimal fragment provided in the Appendices. Include a <code>config.hash</code> in the release manifest and in audit rows that reference the config used for a run. </td></tr><tr><td data-label="Technical User Guide"> <strong>EnsureDeps responsibilities and behavior</strong><br> EnsureDeps validates that required platform runtimes, helper executables, OS features, and permission contexts are present. It distinguishes degradable features (where functionality can be reduced with a graceful message) from critical features (which block execution). EnsureDeps writes a dependency report to structured logs and audit when critical dependencies are missing and prescribes exact remediation steps to operators, avoiding guesswork. <br> <strong>Example outputs:</strong> <code>deps.report.json</code> listing each dependency, status, remediation commands, and whether it is <code>CRITICAL</code> or <code>DEGRADABLE</code>. </td></tr><tr><td data-label="Technical User Guide"> <strong>modUtilities responsibilities</strong><br> All shared low-level behavior is centralized: atomic write semantics, temporary file management, deterministic rounding (SafeRound), date normalization according to canonical calendar policy, progress reporting, and retry/backoff helpers. No other module may implement its own file writing, rounding, or retry logic. Centralization preserves determinism and simplifies cross-language parity testing. Utilities are versioned and their API contract is covered by unit tests and integration fixtures. Utility changes require cross-language parity checks if counterparts exist in other runtimes. </td></tr><tr><td data-label="Technical User Guide"> <strong>modDataInput responsibilities and validation rules</strong><br> modDataInput normalizes messy human inputs (type coercion, date parsing, trimming), enforces schema-level validation, and produces a line-level Validation_Report that includes a stable error code, human-friendly message, and a suggested remediation. Invalid rows must be surfaced explicitly and not silently dropped; operator options to fix or skip must be recorded in audit. Validation error codes are stable and documented for CI and support use. Validation reports are stored in <code>validation/&lt;run-id&gt;/report.csv</code> and persisted in artifact storage for compliance. </td></tr><tr><td data-label="Technical User Guide"> <strong>modCalculations responsibilities and determinism rules</strong><br> All domain calculations are deterministic and executed in-memory without Excel Range calls inside hot loops. Use ordered data structures to avoid non-deterministic iteration ordering. Perform bulk writes to Excel only at defined commit points and ensure calculations are repeatable across supported runtimes and platforms using canonical test vectors. If floating-point behavior could differ between runtimes, apply normalization and SafeRound consistently to ensure byte-for-byte artifact parity. For large jobs, shard deterministically (e.g., by stable hash partition) and document shard boundaries in job descriptors. </td></tr><tr><td data-label="Technical User Guide"> <strong>modExport responsibilities and integrity guarantees</strong><br> Exports must validate destinations (permissions, path existence), use atomic write semantics (write to temp then move/replace), compute and record integrity checksums in audit, retry deterministically on transient failures, and support staged local delivery when network destinations are unavailable. Export fallbacks and final delivery must be audited and operators must be provided explicit remediation steps when manual intervention is needed. Exports include <code>artifact.checksum.sha256</code>, <code>destination.uri</code>, <code>delivery.attempts</code>, and <code>final.status</code> in audit. </td></tr><tr><td data-label="Technical User Guide"> <strong>modStatements / templating responsibilities</strong><br> Presentation templates are separate, versioned assets. Code fills values into templates but must never hardcode layout or formulas. The templating system validates post-generation that all expected fields are present and that formulas are intact. Template versions are recorded in the release manifest so auditors can see which template version produced a given artifact. Keep templates in <code>templates/v&lt;major&gt;.&lt;minor&gt;/</code> and include a test that verifies placeholder coverage and that all required placeholders are replaced. </td></tr><tr><td data-label="Technical User Guide"> <strong>Regulatory core modules (modIFRS15, modIAS36, modIFRS16)</strong><br> Regulatory modules implement accounting standards precisely and deterministically. Every material judgment and parameter (discount rates, variable-consideration estimators, rounding modes) must be auditable and versioned. Each module provides canonical fixtures and self-tests; results must match golden artifacts in CI. Any change to calculation behavior requires compliance review, CI rerun against canonical fixtures, and a migration plan for historical data as necessary. Judgmentable parameters must be surfaced in configuration along with approval records. </td></tr><tr><td data-label="Technical User Guide"> <strong>modIFRS15 — responsibilities and lifecycle</strong><br> The modIFRS15 pipeline is explicit: input normalization, schema validation, variable consideration evaluation, deterministic allocation (including SafeRound and deterministic residual absorption), recognition schedule generation, journal entry mapping, and disclosure artifact production. Each step emits audit entries with correlation ids and a snapshot of redacted inputs, outputs and decisions. Preserve backward-compatible APIs and provide a “forceRecompute=false” path to accept precomputed Analysis where permitted, while still validating and auditing preserved allocations. <br> <strong>Critical audit fields:</strong> <code>ContractID</code>, <code>RunID</code>, <code>ModuleVersion</code>, <code>ParameterSetID</code>, <code>DecisionTrace</code> (redacted), and <code>ArtifactChecksum</code>. </td></tr><tr><td data-label="Technical User Guide"> <strong>modIFRS15 — input shape, validation, and error codes</strong><br> The contract object schema requires ContractID, ContractDate, TransactionPrice, ContractCurrency, Parties and a PerformanceObligations array with required PO fields. Validation returns stable, enumerable error codes (documented in appendices) and a Validation_Report that operators use to remediate input data. Error codes are used in monitoring to create actionable dashboards and in CI to flag regressions. Provide a remediation UI flow that suggests minimal edits, and require operator sign-off for skipped rows. </td></tr><tr><td data-label="Technical User Guide"> <strong>modIFRS15 — allocation, SafeRound, and residual absorption rules</strong><br> Allocation follows a deterministic recipe: canonicalize inputs, optionally preserve precomputed allocation if allowed, compute expected variable consideration per configured strategy, apply the variableConstraintThreshold reserve rules, compute raw proportional allocations to standalone prices, perform SafeRound with configured precision and midpoint-away-from-zero semantics, compute residual and deterministically absorb it into a chosen PO via a deterministic tie-breaker (largest standalone, then stable POID hash). Every micro-decision is recorded in audit to support forensic review and regulator queries. Include a <code>DecisionTrace</code> that lists intermediate numeric values (redacted when containing PII). </td></tr><tr><td data-label="Technical User Guide"> <strong>modIFRS15 — recognition schedule and journal mapping rules</strong><br> Recognition schedules are output as explicit periodized rows (ContractID, POID, PeriodIndex, PeriodStart, PeriodEnd, Amount, RecognitionMethod). Time-based and point-in-time methods are supported with safety clamps for maximum periods and configurable business-day adjustments. Each schedule row deterministically maps to journal lines using configured GL mapping; journal entries are created idempotently using deterministic JournalIDs and recorded with checksums and path metadata. Reconciliation tooling consumes these artifacts to verify accounting ledgers. Provide a standard reconciliation manifest format and automated diff tooling to compare expected vs posted journals. </td></tr><tr><td data-label="Technical User Guide"> <strong>modIFRS15 — disclosures and PII policy</strong><br> Disclosure artifacts summarize unsatisfied performance obligations, significant judgments, and sensitivity analyses while excluding customer-specific PII by default. When regulators require customer-level disclosure, include only redacted or encrypted identifiers under a documented compliance-approved workflow. All disclosure generation actions and resulting artifact checksums are written to audit for evidence and archival. Maintain a <code>de-redaction</code> process that is strictly governed and logged whenever granular identifiers are re-associated. </td></tr><tr><td data-label="Technical User Guide"> <strong>modIFRS15 — self-test harness and CI integration</strong><br> The IFRS self-test suite includes canonical fixtures covering normal and edge cases (zero standalone totals, variable-consideration scenarios, rounding edge cases, and large-PO batches). Self-tests export hidden <code>_IFRS_TestResults</code> sheets with expected vs actual hashes; CI requires byte-for-byte parity with golden files before a change is accepted. Test failures block releases and must be remediated per change-control procedures. Include a checksum verification step in CI that asserts <code>sha256(artifact) == golden_sha256</code>. </td></tr><tr><td data-label="Technical User Guide"> <strong>modIAS36 and modIFRS16 authoritative notes</strong><br> Implemented models must record discount rate sources, model versions, and key sensitivities used in impairment (IAS36) and lease accounting (IFRS16) computations. Reversal logic, remeasurement behavior, treatment of lease incentives and initial direct costs, and modification rules are explicitly documented and audited. Test fixtures exercise typical, modified, terminated and extended lease scenarios. Each calculation run publishes a <code>ModelAudit</code> containing model inputs, version, and sensitivity seeds. </td></tr><tr><td data-label="Technical User Guide"> <strong>modAudit — authoritative system of record and chain verification</strong><br> Audit is append-only and cryptographically chained. Audit rows include timestamps, correlation ids, module names, procedure names, severity, user identifiers and a context payload with redaction applied. Audit buffers improve performance but must flush within configured intervals; rotated audit archives are created and indexed for long-term retention. VerifyAuditChain procedures must be run in CI and as part of monitoring to detect mismatches early; any mismatch triggers the audit-compromise runbook. <br> <strong>Audit row canonical schema (CSV/JSON):</strong> <code>timestamp,correlationId,module,procedure,severity,userId,payloadHash,prevHash,signature</code>. Signatures are produced by the signing key associated with the release manifest. </td></tr><tr><td data-label="Technical User Guide"> <strong>modError — centralized error taxonomy and operator messaging</strong><br> Internal exceptions are classified into stable error codes and mapped to operator-facing remediation guidance. No stack traces or raw automation errors should be exposed to end users; instead every error message includes a correlation id that ties logs and audit to the user-visible message. The mapping table is part of the appendices and used by support staff for quick remediation. Maintain an <code>ErrorCodeCatalog.md</code> and include sample remediation steps per code. </td></tr><tr><td data-label="Technical User Guide"> <strong>Configuration & feature flag governance</strong><br> Feature flags carry metadata (id, default, type, scope, required approvals). Resolution precedence is explicit (runtime admin overrides > server-managed remote flags > registry overrides > local config > code default). Flags that affect financial or regulatory outputs require two-person approval and audit meta entries. Canary enablement and emergency kill-switch changes are audited and replayable. Provide a flag roll history API and a <code>flag.change</code> audit entry for every resolution change. </td></tr><tr><td data-label="Technical User Guide"> <strong>Canary and phased rollout patterns</strong><br> Rollouts use explicit cohort selection (tenant id, allowlist, or user attribute), staged percentage expansion, and automated gating by KPIs (error rate, audit fallback rate, checksum mismatches). At each stage run IFRS self-tests and audit-chain verifications on samples. If thresholds are crossed, automatically revert the flag and enter the incident runbook. Log all observations and roll decisions in audit to support post-mortem compliance evidence. Maintain a rollback window and require sign-off for re-exposure. </td></tr><tr><td data-label="Technical User Guide"> <strong>Config migration policy and offline migration tooling</strong><br> Schema migrations are idempotent and accompanied by a migration manifest that lists transformations and affected counts. Provide an offline migration tool supporting dry-runs and sample transformations for auditor inspection. Migration runs must create audit migration rows summarizing what changed, who ran the migration, and sample before/after records for compliance review. Migration runs include <code>dryRun</code> logs, <code>affectedCount</code>, <code>sampleIds</code>, and <code>backoutPlan</code> in the manifest. </td></tr><tr><td data-label="Technical User Guide"> <strong>Runtime debug and safe-ops mode</strong><br> Provide an admin-only debug panel to toggle verbose logging, force deferred initialization, flush audit buffers, export diagnostics and temporarily toggle transient flags. Every debug action requires permission checks, writes an audit row describing operator, time, and reason, and is recorded for compliance review. Debug mode defaults to off and must be disabled after troubleshooting. Access to the panel requires multi-factor auth and an access ticket and is periodically audited. </td></tr><tr><td data-label="Technical User Guide"> <strong>Security operations & incident response (IR) playbook</strong><br> The IR playbook prescribes triage decision trees, immediate containment steps, and evidence collection procedures tailored for the add-in: isolate suspected PII exfiltration routes, disable network exports, quarantine helper executables, export rotated audit archives to a secure forensic share, and preserve process and environment snapshots. All containment and remediation actions are audited and forensics artifacts preserved with checksums and chain-of-custody metadata. <br> <strong>IR communications:</strong> use pre-approved templates for customer/regulatory notifications and include a list of required attachments. </td></tr><tr><td data-label="Technical User Guide"> <strong>Incident evidence collection requirements</strong><br> When investigating incidents collect rotated audit CSVs, bootstrap and runtime logs covering the timeframe, config snapshots, registry exports, job descriptors from job stores, helper binaries and their signatures, correlation ids associated with the event, and environment metadata (Excel bitness, OS version, add-in version). Store evidence in a secure forensic share and record checksums and transfer logs in audit. Maintain a <code>forensic_evidence_manifest.json</code> listing files, checksums, collection time, collector identity, and destination URI for chain of custody. </td></tr><tr><td data-label="Technical User Guide"> <strong>Containment, remediation and post-incident activities</strong><br> Containment may involve setting audit to read-only, turning off network exports, or disabling helper execution. Remediation typically requires restoring components from signed artifacts, rotating credentials and secrets, re-running critical jobs in an isolated environment and validating outputs against preserved checksums, and if audit corruption occurred restoring from the last verified rotation under compliance supervision. Produce a full post-mortem with timeline, root cause, remediation, and preventive changes, and implement follow-on CI/monitoring checks to prevent recurrence. Post-incident, run full VerifyAuditChain and self-tests before the system returns to normal operation. </td></tr><tr><td data-label="Technical User Guide"> <strong>Deployment, upgrade, migration and rollback runbooks (prescriptive)</strong><br> Pre-deployment checks require signed artifacts, passing CI gates including IFRS self-tests and audit verification, config snapshots and backup of audit rotations, and stakeholder notifications. Canary rollouts advance through explicit cohorts with IFRS self-tests and audit verification performed at each step. Emergency rollback includes triggering the kill-switch, revoking server overrides, reinstalling the previous signed build, restoring config snapshots where needed, running IFRS self-tests and VerifyAuditChain prior to resuming, and recording the rollback event in audit with operator and reason. All deployment steps are executed from the Release Engineer's console using signed credentials and produce a <code>deployment.audit</code> row for each phase. </td></tr><tr><td data-label="Technical User Guide"> <strong>CI/CD gating, automated tests and artifact policy</strong><br> CI pipelines must include lint, unit, integration, IFRS self-tests, audit chain verification, performance microbenchmarks, signing, and publishing artifacts to immutable storage. Release artifacts must be signed, accompanied by a manifest with build hash and signing fingerprints, and only published after all gates pass. Regulated releases also require manual compliance sign-off recorded in the deployment manifest and audit. CI must run VerifyAuditChain for sample runs and fail the pipeline on any mismatch. Artifacts are immutable once published; patch releases follow a formal patch manifest protocol. </td></tr><tr><td data-label="Technical User Guide"> <strong>Performance metrics, thresholds and remediation actions</strong><br> Instrument and collect metrics including add-in startup time, deferred init time, audit flush latency, job queue length, export error rate, and process memory. Document explicit warn and critical thresholds for each metric and prescriptive remediation steps — for example reduce audit batch size or increase flush frequency when audit flush latency rises, throttle new job scheduling or increase worker counts when queue length is excessive, and enable local staging fallback when network export error rates cross thresholds. Provide an operations mapping: metric → detection threshold → immediate action → escalation path. </td></tr><tr><td data-label="Technical User Guide"> <strong>Production monitoring, dashboards and alerting playbook</strong><br> Maintain Support, Ops, and Compliance dashboards that surface real-time health: recent errors, top error codes, audit fallback events, job queue state, resource utilization, and audit chain verification status. Alert payloads must include initial triage steps, logs to collect, runbook links, correlation id, and on-call contact. Critical alerts should auto-page stakeholders and create conference bridges, while less-critical alerts are routed through standard escalation. Dashboards must include visualizations for audit integrity checks and a quick-action panel to trigger a forensic export. </td></tr><tr><td data-label="Technical User Guide"> <strong>High-severity incident runbooks (three canonical examples)</strong><br> Provide fully prescriptive runbooks for audit chain compromise (isolate writes, export rotations, run VerifyAuditChain, and reconstruct or restore under compliance rules), helper executable compromise (quarantine binary, rotate credentials, rebuild signed helper, redeploy after validation), and mass export failures (pause exports, enable local staging fallback, diagnose network/permission issues, replay exports with checksums). Each runbook includes required evidence, notification steps, verification checks, and post-mortem templates. Each high-severity runbook includes a dedicated checklist and owner roster for immediate paging. </td></tr><tr><td data-label="Technical User Guide"> <strong>Appendices and canonical artifacts</strong><br> Maintain appendices with canonical audit CSV row formats, recognition schedule samples, config schema keys and types, IFRS fixture descriptions for CI, diagnostic checklist contents for reproducible bug reports, operator cheat-sheets, and compliance & audit sign-off templates — all versioned and stored in immutable artifact storage for auditor access. Appendices include sample JSON snippets, CSV headers, and golden-file checksums to support automated verification. </td></tr><tr><td data-label="Technical User Guide"> <strong>Reconciliation, correction and migration procedures</strong><br> Provide reconciliation tooling and a controlled process for producing correction journals: run reconciliation in isolated environment against immutable input snapshots, produce reconciliation manifests listing impacted contracts and adjustments, require audit logging of all correction entries with reconciliation ids and rationale, and ensure all corrective actions are reversible and documented for audit. Bulk reruns are permitted only under defined governance and with full evidence capture. Use <code>reconciliation.run</code> in safe mode first (<code>--dry-run</code>) and capture <code>reconciliation.report.json</code> before applying corrections. </td></tr><tr><td data-label="Technical User Guide"> <strong>Data protection, PII handling, encryption and key management</strong><br> Classify PII fields and enforce deterministic redaction in disclosure artifacts; store audit archives and exported artifacts encrypted using envelope encryption with managed keys; enforce key rotation schedules; forbid secrets in files; and restrict access to de-redaction artifacts to auditors with logged access. All key rotation and access events are recorded in audit. Use an HSM-backed key management service for signing audit rotations and require multi-person approval for key material export. </td></tr><tr><td data-label="Technical User Guide"> <strong>Operational procedures and operator commands (conceptual)</strong><br> Provide concise but exact operator checklists for common tasks: verifying add-in registration and COM/VSTO entries, collecting diagnostic bundles (logs, audit rotations, config snapshot, input sample), flushing audit buffers, re-queuing or canceling jobs, toggling safe-ops flags, and performing controlled rollbacks. Every operator action that changes runtime state must append an audit row with operator identity, reason, and correlation ids. <br> <strong>Canonical operator commands (examples):</strong><br> <code>diagnostics collect --run-id &lt;id&gt; --out &lt;path&gt;</code>, <code>audit flush --immediate</code>, <code>jobs requeue --job-id &lt;id&gt;</code>, <code>exports stage-local --artifact &lt;id&gt;</code>. Ensure CLI tools authenticate via operator SSO tokens and produce signed audit events. </td></tr><tr><td data-label="Technical User Guide"> <strong>Testing, fixtures and golden-file governance</strong><br> Golden fixtures are stored in an immutable repository and any change requires a documented PR with rationale and approvals from Development and Compliance. CI compares produced artifacts against golden hashes and blocks changes unless a migration manifest and compliance sign-off are present. The test matrix covers supported OS versions, Excel bitness, locales and runtime combinations to catch environment-dependent regressions. Include locale-based fixtures for date/time and numeric formatting to catch regional differences. </td></tr><tr><td data-label="Technical User Guide"> <strong>Release manifest, artifact signing and verification</strong><br> Each release includes a manifest describing build id, artifact hashes, signer identity, test pass/fail summaries, and compliance approvals. Artifacts are code-signed and verified at deployment time; manifest and signing records are appended to audit and stored in immutable artifact stores for later verification by auditors. Release manifests include <code>buildId</code>, <code>commitHash</code>, <code>artifactList</code>, <code>signingFingerprint</code>, <code>ciSummary</code>, and <code>complianceApproval</code>. Verification is automated in deployment orchestration and fails fast on any mismatch. </td></tr><tr><td data-label="Technical User Guide"> <strong>Housekeeping, retention and scheduled maintenance</strong><br> Define audit rotation retention and archival cadence, scheduled temp cleanup windows when Excel is not running, routine kill-switch tests, dependency verification checks, and the cadence for running self-tests in staging. Retention policies reflect regulatory requirements and are implemented with secure archives and evidence of successful archival operations in audit. <br> <strong>Typical retention schedule:</strong> hot audit rotations (30 days), warm archive (7 years), cold deep archive (as required by regulation). Automate retention verification monthly and log results in <code>housekeeping.audit</code>. </td></tr><tr><td data-label="Technical User Guide"> <strong>Governance, approvals and change control</strong><br> Any change affecting allocation, journal generation, or other regulatory outputs requires two-person approval, documented test evidence, migration manifests, and explicit entries in the deployment manifest and audit. Maintain RACI clarity for owners of fixes and ensure compliance sign-off is mandatory for policy-impacting changes. All approvals must be recorded with operator id, timestamp, scope, and link to evidence artifacts. </td></tr><tr><td data-label="Technical User Guide"> <strong>Operator cheat-sheets and run-to-resolution flows</strong><br> Provide short, copy-ready one-page sequences for common incident types: invoice reconciliation differences, missing dependencies, export failures, audit mismatches. Each cheat-sheet lists required artifacts to collect, immediate verification commands or checks, containment actions, and escalation paths; operators must follow the listed steps and record actions in audit. Cheat-sheets are stored in <code>runbooks/cheatsheets/</code> and must be updated when major process changes occur. </td></tr><tr><td data-label="Technical User Guide"> <strong>Templates for post-mortem, change request and regulatory packages</strong><br> Supply standardized templates capturing incident timeline, detection, root cause, remediation, permanent fixes, preventive controls, owners and deadlines, and evidence attachments. Regulatory packages include release manifest, audit rotations for date ranges, migration audit entries, and anonymized sample inputs and outputs that demonstrate deterministic behavior. Templates include mandatory fields and an evidence checklist to ensure completeness for regulator submission. </td></tr><tr><td data-label="Technical User Guide"> <strong>Final absolute rules and non-negotiables</strong><br> Always begin with smoke tests. Never bypass audit or modify audit rows without documented legal/compliance approval. Never guess — record every deviation and remediation step. Determinism, traceability, and auditable approvals are mandatory. Feature flags that change regulatory outputs require two-person governance and CI enforcement. A tested emergency kill-switch must exist and be exercised periodically. Non-negotiable controls are enforced by CI/CD gates and runtime guards; violations trigger automated audits and may halt releases. </td></tr><tr><td data-label="Technical User Guide"> <strong>Available exports and next steps</strong><br> This runbook can be exported immediately into single consolidated PDF, DOCX, XLSX, CI pipeline YAML, or a Prometheus/Grafana package. If you want an export produced now, specify the exact filename and desired format and the corresponding artifact will be prepared. <br> <strong>Export options and required metadata:</strong> when requesting PDF/DOCX provide <code>title</code>, <code>author</code>, <code>effectiveDate</code>; when requesting XLSX specify whether to include hidden sheets (self-test artifacts) and whether to include appendices. Exports include an appended <code>runbook.audit</code> entry capturing who requested the export and why. </td></tr><tr><td data-label="Technical User Guide"> <strong>Operator quick-reference: Immediate triage checklist (copy-ready)</strong><br> 1) Run smoke test and capture <code>audit_tail.csv</code>.<br> 2) If smoke test fails, collect <code>bootstrap.log</code>, <code>ui.log</code>, <code>deps.report.json</code> and <code>excel.register.state</code>.<br> 3) If audit rows are absent for a known action, stop and preserve evidence; do not run corrective scripts that mutate state.<br> 4) If export failure, set exports to <code>stage-local</code>, capture <code>export.failures</code> and enable retry.<br> 5) If calculation mismatch, re-run canonical fixture in isolated runner with identical <code>config.hash</code> and capture <code>artifact.checksum</code>.<br> 6) Record every operator action with <code>operatorId</code>, <code>reason</code>, and <code>correlationId</code> in audit. </td></tr><tr><td data-label="Technical User Guide"> <strong>Evidence templates & canonical fields (copy-ready)</strong><br> - Audit row CSV header: <code>timestamp,correlationId,module,procedure,severity,userId,payloadHash,prevHash,signature,metadata</code><br> - Job descriptor JSON fields: <code>jobId,createdAt,owner,shard,attempts,state,params,configHash</code><br> - Forensic manifest JSON: <code>manifestId,collector,collectionTime,items:[{path,sha256,size}],destination,notes</code><br> - Release manifest example fields: <code>releaseId,buildId,commit,signer,artifacts:[{path,sha256}]</code> Keep these templates in <code>appendices/templates/</code> and use them unchanged for evidence submissions. </td></tr><tr><td data-label="Technical User Guide"> <strong>Operator command reference (explicit examples)</strong><br> - Collect diagnostics: <code>add-in-cli diagnostics collect --run-id &lt;run&gt; --out ./diag-&lt;run&gt;.tar.gz</code><br> - Flush audit: <code>add-in-cli audit flush --immediate --correlation &lt;id&gt;</code><br> - Re-run job: <code>add-in-cli jobs run --job-id &lt;job&gt; --isolated --config-hash &lt;hash&gt;</code><br> - Toggle flag (requires 2-person approval): <code>add-in-cli flags set --id &lt;flag&gt; --value false --approved-by &lt;uid&gt;</code> Each CLI call MUST produce an audit row; failures of CLI produce a signed local error object which must be attached to troubleshooting artifacts. </td></tr><tr><td data-label="Technical User Guide"> <strong>Sample migration manifest (template, copy-ready)</strong><br> <code>json { &quot;migrationId&quot;:&quot;mig-2025-12-26-001&quot;, &quot;author&quot;:&quot;&lt;uid&gt;&quot;, &quot;description&quot;:&quot;Normalize Contract.Currency codes to ISO4217&quot;, &quot;affectedCount&quot;:12345, &quot;dryRunSummary&quot;:{&quot;sampleAffected&quot;:10,&quot;examples&quot;:[&quot;CUST-001&quot;,&quot;CUST-002&quot;]}, &quot;steps&quot;:[{&quot;stepId&quot;:1,&quot;action&quot;:&quot;transform-currency&quot;,&quot;script&quot;:&quot;scripts/migrate_currency_v2.py&quot;,&quot;backout&quot;:&quot;scripts/backout_currency_v2.py&quot;}], &quot;approval&quot;:[{&quot;approver&quot;:&quot;compliance@company&quot;,&quot;timestamp&quot;:&quot;2025-12-26T20:00:00Z&quot;}], &quot;evidence&quot;:[&quot;before-sample.csv&quot;,&quot;after-sample.csv&quot;], &quot;notes&quot;:&quot;Requires two-person signoff to run in production&quot; } </code> Use this template and attach sample before/after rows for audit. </td></tr><tr><td data-label="Technical User Guide"> <strong>Sample release manifest (template, copy-ready)</strong><br> <code>json { &quot;releaseId&quot;:&quot;rel-2025-12-26-01&quot;, &quot;buildId&quot;:&quot;build-abc123&quot;, &quot;commitHash&quot;:&quot;abcdef0123456789&quot;, &quot;artifacts&quot;:[{&quot;path&quot;:&quot;add-in-v2.3.0.zip&quot;,&quot;sha256&quot;:&quot;...&quot;}], &quot;signingKey&quot;:&quot;sig-key-01&quot;,&quot;ciSummary&quot;:{&quot;status&quot;:&quot;passed&quot;,&quot;runId&quot;:&quot;ci-9876&quot;}, &quot;complianceApproval&quot;:[{&quot;approver&quot;:&quot;compliance@company&quot;,&quot;timestamp&quot;:&quot;2025-12-26T19:30:00Z&quot;,&quot;notes&quot;:&quot;Approved IFRS self-tests&quot;}] } </code> Append manifest to audit prior to deployment; ensure <code>signingKey</code> fingerprint present. </td></tr><tr><td data-label="Technical User Guide"> <strong>Post-mortem template (required fields)</strong><br> 1) Incident ID<br> 2) Severity<br> 3) Detection time<br> 4) Containment time<br> 5) Resolution time<br> 6) Summary (1 paragraph)<br> 7) Full timeline with correlation ids<br> 8) Root cause analysis<br> 9) Corrective actions with owners and deadlines<br> 10) Evidence attached (audit rotations, logs, manifests)<br> 11) Preventive measures and tests to add to CI<br> 12) Compliance impact and regulator notification plan<br> 13) Lessons learned. Post-mortem is due within 72 hours of incident resolution and must be approved by Compliance. </td></tr><tr><td data-label="Technical User Guide"> <strong>Regulatory package checklist (copy-ready)</strong><br> - Release manifest (signed)<br> - Audit rotations for affected date range<br> - Migration manifests (if any)<br> - Redacted sample inputs and outputs demonstrating deterministic behavior<br> - Test fixtures and CI run logs proving parity<br> - Compliance sign-offs and reviewer comments<br> - De-redaction requests (if applicable)<br> - Post-mortem (if incident-related) Deliver in an immutable archive and append <code>submission.audit</code> entry. </td></tr><tr><td data-label="Technical User Guide"> <strong>Verification & acceptance tests (developer checklist)</strong><br> - Unit tests cover edge cases and negative paths<br> - Integration tests exercise module interfaces<br> - IFRS self-tests match golden artifacts byte-for-byte<br> - Audit chain verified in CI for sample runs<br> - Performance benchmarks within thresholds<br> - Signed artifacts and manifests present<br> - Compliance approvals recorded If any item fails, the release is blocked until remediated and evidence attached to the blocking ticket. </td></tr><tr><td data-label="Technical User Guide"> <strong>Common failures playbook (operator-ready)</strong><br> <em>Failure: Add-in not loading.</em> Steps:<br> 1) Confirm Excel COM registration; collect <code>excel.register.state</code>.<br> 2) Check <code>bootstrap.log</code> for <code>autoload-disabled</code> messages.<br> 3) Reinstall signed add-in package and re-register; collect <code>install.log</code>.<br> 4) If auto-disabled persists, escalate to Release Engineer with logs and <code>audit_tail.csv</code>.<br> <em>Failure: Exports failing.</em> Steps:<br> 1) Set exports to <code>stage-local</code> and capture <code>export.failures</code>.<br> 2) Restart export daemon.<br> 3) Replay exports with <code>exports replay --from &lt;timestamp&gt;</code>.<br> 4) If network auth error, rotate creds and record <code>key.rotate</code> audit row.<br> <em>Failure: Calculation mismatch vs golden.</em> Steps:<br> 1) Re-run canonical fixture in isolated runner with identical <code>config.hash</code>.<br> 2) Diff intermediate values.<br> 3) If mismatch unexplained, block release and open an incident. Always collect evidence described in the relevant section. </td></tr><tr><td data-label="Technical User Guide"> <strong>Audit compromise runbook (summary)</strong><br> 1) Isolate writes (set audit to read-only).<br> 2) Export current rotations and preserve copies with checksums to secure forensic share.<br> 3) Run <code>VerifyAuditChain</code> on prior rotations to identify first mismatch.<br> 4) Reconstruct or restore from last verified rotation under compliance supervision.<br> 5) Alert regulators as required.<br> 6) Perform kill-switch test and update post-mortem. Each step must be logged and evidence stored in <code>forensic</code> store. </td></tr><tr><td data-label="Technical User Guide"> <strong>Operator training & periodic drills</strong><br> Operators must complete annual training including smoke tests, common failures, and evidence collection. Perform a quarterly tabletop run of at least one high-severity runbook and an annual full drill including forensic export and VerifyAuditChain. Retain drill artifacts and approvals in audit. </td></tr><tr><td data-label="Technical User Guide"> <strong>Appendix A — audit row example (canonical JSON)</strong><br> <code>json { &quot;timestamp&quot;:&quot;2025-12-26T20:00:00Z&quot;, &quot;correlationId&quot;:&quot;20251226-200000-modIFRS15-1a2b3c4d&quot;, &quot;module&quot;:&quot;modIFRS15&quot;, &quot;procedure&quot;:&quot;allocate&quot;, &quot;severity&quot;:&quot;INFO&quot;, &quot;userId&quot;:&quot;system&quot;, &quot;payloadHash&quot;:&quot;sha256:abcd...&quot;, &quot;prevHash&quot;:&quot;sha256:0000...&quot;, &quot;signature&quot;:&quot;sig:abcd...&quot;, &quot;metadata&quot;:{&quot;runId&quot;:&quot;run-2025-12-26-0001&quot;,&quot;configHash&quot;:&quot;cfg-1234&quot;} } </code> Sign each rotation and archive rotated packages according to retention policy. </td></tr><tr><td data-label="Technical User Guide"> <strong>Appendix B — glossary of key terms</strong><br> - Audit chain: append-only sequence of signed audit rows<br> - Correlation id: unique id that ties logs, audit, and artifacts<br> - SafeRound: deterministic rounding algorithm with configured midpoint rule<br> - Golden file: canonical artifact used for CI parity<br> - Job descriptor: persisted metadata describing an execution unit<br> - Forensic share: secure archive for incident evidence<br> - Kill-switch: mechanism to disable unsafe features or exports </td></tr><tr><td data-label="Technical User Guide"> <strong>Appendix C — monitoring thresholds (recommended defaults)</strong><br> - Startup time (WARN > 12s, CRIT > 30s)<br> - Audit flush latency (WARN > 5s, CRIT > 30s)<br> - Job queue length (WARN > 100, CRIT > 1000)<br> - Export error rate (WARN > 0.5%, CRIT > 2%)<br> - Memory usage (WARN > 75%, CRIT > 90%) Adjust thresholds per environment and justify deviations in <code>thresholds.audit</code>. </td></tr><tr><td data-label="Technical User Guide"> <strong>Appendix D — change-control checklist (must-complete before production change)</strong><br> 1) Create change ticket with scope and rollback plan.<br> 2) Run IFRS self-tests and attach results.<br> 3) Attach migration manifest (if applicable).<br> 4) Obtain two-person approval for regulatory-impacting changes.<br> 5) Sign artifacts and create release manifest.<br> 6) Schedule deployment outside freeze windows or get override approvals.<br> 7) Run deployment in canary cohorts with automated gates.<br> 8) After rollout, run VerifyAuditChain and record results in audit. </td></tr><tr><td data-label="Technical User Guide"> <strong>Appendix E — contact & escalation matrix (copy-ready)</strong><br> Maintain an up-to-date roster with direct paging numbers and SSO ids for Product Owner, Release Engineer, Compliance Officer, Security Lead, On-call SRE, and Support Engineer. The matrix must be publicly accessible to authorized personnel and updated on role change. Paging policies define business hours, off-hours, and holiday rotations. </td></tr><tr><td data-label="Technical User Guide"> <strong>Document distribution & access controls</strong><br> Store the canonical runbook in immutable artifact storage and present a read-only rendered copy in the internal docs portal. Edits go through PRs targeting <code>runbook/master</code>; each PR must include test evidence and, for regulatory-impacting changes, compliance sign-off. Access to edit rights is limited to the Runbook Owners group and requires two-person approvals for publishing. </td></tr><tr><td data-label="Technical User Guide"> <strong>Next steps for consumers of this runbook</strong><br> If you are an operator, familiarize yourself with the smoke tests and common failures cheat-sheets in the next 48 hours. If you are a developer, ensure your next PR touching regulatory modules includes a canonical fixture and updated golden file checksums. If you are Compliance, schedule a monthly review of migration manifests and a quarterly audit of release manifests. For any export request of this runbook, specify format and filename and include the intended use and recipient to ensure appropriate audit tracking. </td></tr></tbody></table></div><div class="row-count">Rows: 69</div></div><div class="table-caption" id="Table2" data-table="Docu_0158_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modAudit"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modAudit</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modAudit"> <strong>Overview</strong><br>Append-only, tamper-evident audit store for Excel/VBA. Rows are cryptographically chained (per-row <code>PrevHash</code> → <code>Hash</code>). Supports buffered batch writes for performance, synchronous append path for reliability, archive rotation, CSV/JSON export, PII-light redaction, and multiple hash-provider fallbacks (SHA256 preferred, CRC32 fallback). Sheet visibility and meta-sheet capture runtime metadata. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Public API (short)</strong><br><code>InitAuditModule()</code> — initialize module and meta sheet.<br><code>ShutdownAuditModule()</code> — flush and teardown.<br><code>LogAudit(action, details)</code> — backwards-compatible convenience logger.<br><code>AppendAuditEntry(...)</code> — synchronous single-row append (strongest durability).<br><code>AppendAuditBuffered(entry)</code> — enqueue buffered entry.<br><code>FlushAuditBuffer()</code> — persist buffered entries in one bulk write.<br><code>RotateAuditNow()</code> — archive current audit to CSV and truncate.<br><code>ExportAuditToCSV(path)</code> / <code>ExportAuditToJSON(path)</code> — export copies.<br><code>VerifyAuditChain(firstBadRow, diagnosticCode)</code> — chain verification.<br><code>GenerateAuditDiagnosticReport(path, startRow)</code> — CSV diagnostics.<br><code>FindAuditByCorrelationID(id)</code> / <code>ReadAuditRow(row)</code> — lookup helpers.<br><code>SetAuditFeatureFlag(name,val)</code> / <code>GetAuditFeatureFlag(name)</code> — runtime flags. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Canonical audit row schema (CSV / JSON)</strong><br><code>timestamp,correlationId,module,procedure,severity,userId,payloadHash,prevHash,signature</code> <em>(conceptual)</em>.<br>Implemented worksheet columns: <code>TimestampUTC, CorrelationID, Module, Procedure, Severity, ErrNum, WindowsUser, ExcelUser, Action, ContextJSON, PrevHash, Hash</code>.<br><code>Hash</code> is produced by <code>ComputeEntryHash(prevHash, rowData)</code> (provider depends on config). </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Field meanings</strong><br><code>TimestampUTC</code> — ISO 8601 UTC (Z) from <code>GetSystemTime</code> fallback to <code>Now</code>.<br><code>CorrelationID</code> — GUID / deterministic id from <code>NewCorrelationId()</code>.<br><code>Module</code>/<code>Procedure</code> — source location of event.<br><code>Severity</code> — text (<code>Info</code>, etc.).<br><code>ErrNum</code> — numeric error code where applicable.<br><code>WindowsUser</code> / <code>ExcelUser</code> — runtime principals (redacted where required).<br><code>Action</code> — brief action label.<br><code>ContextJSON</code> — JSON payload (redaction/truncation applied).<br><code>PrevHash</code> — prior row <code>Hash</code> (empty for first row).<br><code>Hash</code> — entry hash (hex) stored uppercase. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Configuration defaults & constants</strong><br>Sheet names: <code>_IFRS_Audit</code>, <code>_IFRS_AuditMeta</code>.<br><code>AUDIT_MAX_ROWS_BEFORE_ROTATE = 50000</code>.<br><code>AUDIT_BATCH_FLUSH_THRESHOLD = 50</code>.<br><code>MAX_CONTEXT_LENGTH = 2000</code>.<br><code>AUDIT_ARCHIVE_FOLDER</code> empty → <code>TEMP</code> / workbook path fallback. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Runtime feature flags & safe defaults</strong><br><code>g_enableMetaSheet = True</code> — tracks last flush, buffered count, provider counts.<br><code>g_aggressiveRedaction = False</code> — set true to increase redaction sensitivity.<br><code>g_allowExternalHashProvider = False</code> — <strong>disabled by default</strong>; enable only in trusted environments to allow <code>HashProviderMacroName</code>.<br><code>g_allowCommandExecution = True</code> — controls use of <code>certutil</code> / <code>shasum</code> / <code>openssl</code>; consider disabling on locked-down systems. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Buffering model & durability tradeoffs</strong><br>Buffered writes increase throughput: <code>AppendAuditBuffered</code> enqueues; automatic <code>FlushAuditBuffer</code> triggers at <code>AUDIT_BATCH_FLUSH_THRESHOLD</code> or via <code>ShutdownAuditModule</code>/manual <code>FlushAuditBuffer</code>.<br>Bulk write uses array write (<code>Resize(n,12).Value</code>). On bulk-write failure, module falls back to per-row <code>AppendAuditEntry</code> to guarantee persistence (slower). <code>Flush</code> emits <code>FlushStart</code> / <code>FlushFinish</code> internal entries. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Synchronous append behavior</strong><br><code>AppendAuditEntry</code> writes one row synchronously (disables events / screen updates during operation). Applies redaction/truncation to <code>ContextJSON</code>. Computes <code>prevHash</code> from last row and then <code>entryHash</code> via <code>ComputeEntryHash</code>. On write error a fallback 'LogAuditFailure' row is written. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Rotation & archive</strong><br><code>RotateAuditNow</code> copies <code>UsedRange</code> to a temporary workbook, saves CSV archive named <code>IFRS_Audit_Archive_&lt;UTC&gt;.csv</code> into <code>AUDIT_ARCHIVE_FOLDER</code> or fallback (TEMP / workbook folder / USERPROFILE). After successful save, rows 2:last are deleted from audit sheet. Emits <code>RotateStart</code> and <code>RotateFinish</code> events; on save failure attempts fallback path and logs <code>RotateFallback</code> or <code>AuditRotateError</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Export formats</strong><br><code>ExportAuditToCSV(fullPath)</code> — creates CSV via temporary workbook copy; returns Boolean success.<br><code>ExportAuditToJSON(fullPath)</code> — converts <code>UsedRange</code> to JSON array (header row → object keys), writes UTF-8 bytes. Both write errors produce <code>ExportAuditError</code> entries. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Hashing: provider selection & fallback</strong><br>Compute order: <br> (1) Macro provider <code>HashProviderMacroName</code> if <code>g_allowExternalHashProvider = True</code> and macro returns non-empty; <br> (2) System SHA256 (<code>certutil</code> on Windows, <code>shasum</code>/<code>openssl</code> on Unix) if <code>g_allowCommandExecution = True</code>; <br> (3) CRC32 fallback (always available).<br>Each provider use increments meta counts and emits <code>HashProviderUsed</code> internal row. Maintain <code>g_lastHashProviderUsed</code> and <code>g_hashProviderResultType</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>System SHA256 provider notes</strong><br>Writes a temp binary file, calls system tool with guarded timeout (<code>RunCmdWithTimeout_Safe</code>), parses output to extract 64-hex SHA256. Temp file is removed. If system tool not available or parsing fails, returns empty to allow fallback. <code>CertUtilAvailable()</code> probes <code>certutil</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Redaction & PII handling</strong><br><code>RedactSensitiveData</code> uses regex patterns to redact:<br>• emails → <code>[REDACTED_EMAIL]</code><br>• SSN-like numbers / long numeric sequences → <code>[REDACTED_SSN]</code> / <code>[REDACTED_NUMBER]</code><br>• account numbers, JWTs, API keys, token-like blobs, long hex/base64 blobs → <code>[REDACTED_TOKEN]</code> / <code>[REDACTED_HEX]</code> / <code>[REDACTED_BLOB]</code><br>Aggressive mode applies extra patterns; long <code>ContextJSON</code> truncated to <code>MAX_CONTEXT_LENGTH</code> and emits <code>ContextTruncated</code>. Fallback <code>SimpleRedactFallback</code> used when regex engine unavailable. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Verification & diagnostics</strong><br><code>VerifyAuditChain(firstBadRow,diagnosticCode)</code> iterates rows verifying <code>PrevHash</code> equality and recomputed <code>Hash</code> equality. Diagnostic codes: <code>0=OK</code>, <code>1=MissingPrevHash</code>, <code>2=HashMismatch</code>, <code>3=Malformed/Other</code>.<br><code>GenerateAuditDiagnosticReport(outputCsvPath,startRow)</code> emits per-row <code>ExpectedPrev,ActualPrev,ExpectedHash,ActualHash,Reason</code> CSV for offline analysis. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Lookup helpers</strong><br><code>FindAuditByCorrelationID(corrId)</code> — finds row index in column B.<br><code>ReadAuditRow(sheetRow)</code> — returns <code>Scripting.Dictionary</code> with all fields for a given row. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Meta sheet</strong><br><code>_IFRS_AuditMeta</code> stores <code>LastFlushUTC</code>, <code>BufferedCount</code>, <code>EnableMetaSheet</code>, <code>AggressiveRedaction</code>, and hash provider counts. Meta sheet is <code>xlSheetVeryHidden</code> by default; updates are skipped if the sheet is protected (an internal <code>MetaSheetProtected</code> entry is emitted). </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Security & operational guidance</strong><br>• Protect <code>_IFRS_Audit</code> and <code>_IFRS_AuditMeta</code> (workbook protection, ACLs).<br>• Disable <code>allowExternalHashProvider</code> unless <code>HashProviderMacroName</code> is trusted and code-reviewed.<br>• Consider disabling <code>g_allowCommandExecution</code> on user endpoints to avoid external tool invocation risk.<br>• Keep audit archives on an immutable or access-restricted location for long-term retention.<br>• Log verification runs and run <code>VerifyAuditChain</code> in CI and monitoring (see Runbook triggers). </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Runbook triggers & recommended checks</strong><br>• Any <code>VerifyAuditChain</code> failure (diagnostic ≠ 0) → trigger <code>audit-compromise</code> runbook.<br>• Regularly run <code>VerifyAuditChain</code> after rotation, and in CI on each release. Schedule periodic <code>GenerateAuditDiagnosticReport</code> for near-real-time monitoring. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Error handling & fallbacks</strong><br>Module uses defensive <code>On Error</code> handling and emits internal audit entries for exceptional states (e.g., <code>FlushFallback</code>, <code>RotateFallback</code>, <code>ExportAuditError</code>, <code>AuditRotateError</code>). Bulk-write failures fall back to per-row synchronous writes to avoid data loss. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Implementation & platform notes</strong><br>• UTC timestamps use <code>GetSystemTime</code> via <code>kernel32</code> with VBA7 <code>PtrSafe</code> support; fallback to <code>Now</code> formatting when unavailable.<br>• Cross-platform command detection implemented (<code>PlatformIsWindows</code>, <code>CertUtilAvailable</code>).<br>• Encoding uses <code>ADODB.Stream</code> when available; falls back to <code>StrConv</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Examples</strong><br>CSV canonical row (columns A..L):<br><code>2025-12-27T21:00:00Z,IFRS-20251227-123456,modPayments,ProcessPayment,Info,,DOMAIN\alice,Alice,PaymentRecorded,{&quot;amount&quot;:100,&quot;currency&quot;:&quot;USD&quot;},PREV_HASH,ENTRY_HASH</code><br>JSON export sample object: <code>{&quot;TimestampUTC&quot;:&quot;2025-12-27T21:00:00Z&quot;,&quot;CorrelationID&quot;:&quot;IFRS-...&quot;,&quot;Module&quot;:&quot;modPayments&quot;,...,&quot;Hash&quot;:&quot;ENTRY_HASH&quot;}</code> </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Operational best practices</strong><br>• Run <code>InitAuditModule</code> at add-in/workbook startup, <code>ShutdownAuditModule</code> on close.<br>• Call <code>FlushAuditBuffer</code> before heavy operations or before allowing untrusted macros to run.<br>• Enforce least privilege: restrict file system write locations for archive export.<br>• Protect meta and audit sheets and review <code>HashProvider</code> usage in code review. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Limitations & known behaviors</strong><br>• Signatures in canonical schema (<code>signature</code>) are not produced by default; module stores computed <code>Hash</code> only. Integrate external signing in CI if required (signing key referenced by release manifest).<br>• System SHA256 relies on external tools and may be disabled in locked environments — CRC32 fallback is less cryptographically strong.<br>• Very large <code>ContextJSON</code> payloads are truncated; keep context compact and PII-light. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Troubleshooting checklist</strong><br>1. <code>VerifyAuditChain</code> failure → run <code>GenerateAuditDiagnosticReport</code>, inspect <code>firstBadRow</code> and <code>diagnosticCode</code>.<br>2. Missing rows after rotate → check archive path, workbook permissions, <code>AUDIT_ARCHIVE_FOLDER</code> config and TEMP fallback.<br>3. Hash provider unexpected (CRC32) → check <code>g_allowCommandExecution</code> and <code>g_allowExternalHashProvider</code>, review <code>_IFRS_AuditMeta</code> provider counts.<br>4. Redaction removed needed data → toggle <code>aggressiveRedaction</code> off and review <code>ContextJSON</code> patterns. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Maintenance & retention</strong><br>Archive naming: <code>IFRS_Audit_Archive_&lt;UTC&gt;.csv</code>. Keep a retention policy outside this module (file system / backup). Periodic rotation before <code>AUDIT_MAX_ROWS_BEFORE_ROTATE</code> recommended. Ensure CI exports and signing happen before archive distribution. </td></tr></tbody></table></div><div class="row-count">Rows: 25</div></div><div class="table-caption" id="Table3" data-table="Docu_0158_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modBootstrap"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modBootstrap</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Overview</strong><br>Deterministic add-in bootstrap and runtime lifecycle manager for the IFRS add-in. Provides deferred initialization, dependency probing, feature-flag loading, migration hooks, robust metadata persistence with atomic-ish writes and in-memory buffering, job scheduling/upsert (OnTime-safe), job reconciliation, safe <code>Application.Run</code> wrappers, idempotent initialization/shutdown, test/self-test harness, and lightweight CRC32 utilities for deterministic IDs. Preserves public API signatures to avoid breaking consumers.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Purpose & responsibilities</strong><br>• Start/stop the add-in (<code>AddIn_Initialize</code>, <code>AddIn_DeferredInit</code>, <code>AddIn_Shutdown</code>).<br>• Record bootstrap state and metadata (meta sheet <code>_IFRS_Metadata</code>).<br>• Create/upgrade operational sheets (<code>_IFRS_Jobs</code>, <code>_IFRS_Audit</code>, <code>_IFRS_TestResults</code>).<br>• Schedule deferred init via <code>Application.OnTime</code> using a job upsert pattern and safe scheduling wrapper (<code>SafeOnTimeSchedule</code>).<br>• Manage feature enable/disable lists and an in-memory feature cache.<br>• Provide robust safe-call wrappers (<code>SafeRun</code>, <code>SafeRunWithResult</code>, <code>CallRunWithArgs*</code>) to invoke other modules safely.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Public API (important functions)</strong><br><code>AddIn_Initialize()</code> — idempotent bootstrap entry. Sets up caches, meta & job sheets, persists initial state, schedules deferred init.<br><code>AddIn_DeferredInit()</code> — deferred initialization worker: dependency probes, config load/migration, warmups, optional self-test, persists final state.<br><code>AddIn_Shutdown()</code> — idempotent teardown, cancels scheduled jobs, attempts graceful shutdown of ribbon jobs.<br><code>AddIn_IsInitialized()</code> / <code>AddIn_GetState()</code> — introspection.<br><code>AddIn_EnableFeature(name, reason)</code> / <code>AddIn_DisableFeature(name, reason)</code> — toggle features and persist to metadata.<br><code>AddIn_SelfTestStartup()</code> / <code>AddIn_RunInternalTests()</code> / <code>Ribbon_SelfTest()</code> — test harnesses.<br><code>AddIn_ListDependencies()</code> / <code>AddIn_EnsureDependencies()</code> — dependency inventory & probes.<br><code>TryProbe(procName)</code> — cache-aware probe helper.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Constants & defaults</strong><br>Sheet names: <code>_IFRS_Metadata</code>, <code>_IFRS_Audit</code>, <code>_IFRS_TestResults</code>, <code>_IFRS_Jobs</code>.<br><code>BOOTSTRAP_VERSION = &quot;1.0.0&quot;</code>.<br>Meta size limits: <code>MAX_META_VALUE = 2048</code>, <code>MAX_META_SHORT = 1024</code>, <code>MAX_META_NOTE = 512</code>.<br>OnTime retry policy: <code>MAX_ONETIME_RETRY_COUNT = 3</code>, <code>MAX_ONETIME_RETRY_AGE_DAYS = 30</code>.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Jobs sheet schema / column indices</strong><br>Columns (1-based): <code>JobId(1)</code>, <code>Handler(2)</code>, <code>Status(3)</code>, <code>ScheduledAt(4)</code>, <code>LastError(5)</code>, <code>Meta(6)</code>, <code>CreatedAt(7)</code>, <code>UpdatedAt(8)</code>, <code>v2_migrated(9)</code>.<br>Statuses used: <code>queued</code>, <code>running</code>, <code>scheduled</code>, <code>completed</code>, <code>orphaned</code>, <code>orphaned_maxed</code>, <code>cancelled</code>, <code>queued</code>.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Job lifecycle & scheduling</strong><br>• Use <code>EnqueueOrUpdateJob(jobId, Handler, status, scheduledAt, meta)</code> to upsert job rows and avoid duplicates.<br>• Schedule via <code>SafeOnTimeSchedule(when, procString, jobId)</code> which retries with exponential backoff and records retry counts in job meta; marks jobs <code>orphaned</code>/<code>orphaned_maxed</code> when scheduling fails repeatedly.<br>• <code>TryCancelOnTime(when, proc)</code> cancels both qualified and unqualified OnTime entries safely and logs failures.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Deferred init workflow</strong><br><code>AddIn_Initialize</code> schedules <code>AddIn_DeferredInit</code> via a job upsert and <code>SafeOnTimeSchedule</code>. Deferred init performs dependency probes, attempts <code>Config_Load</code> and migration, warms modules (<code>modAudit_Init</code>, <code>modUtilities_Init</code>), optionally runs self-tests if <code>run_selftest_on_start</code> feature flag is true, persists bootstrap state, and marks job completed.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Dependency probing & capability snapshot</strong><br><code>AddIn_EnsureDependencies</code> and <code>TryProbe</code> probe availability of critical procs and COM objects (FSO, ADODB.Stream, WScript). Results are persisted as a capability snapshot (<code>LastCapabilitySnapshot</code>) for diagnostics. Probe results cached in <code>g_probeCache</code> for session lifetime.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Feature flags & caching</strong><br><code>LoadFeatureFlag(key, default)</code> checks <code>g_featureCache</code>, then <code>Config_Get</code> (if available), then meta sheet <code>FeatureFlag_&lt;key&gt;</code>, falling back to provided default. <code>AddIn_InvalidateFeatureCache</code> clears cache entries. Feature toggles are also persisted to meta sheet by <code>AddIn_EnableFeature</code> / <code>AddIn_DisableFeature</code>.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Metadata persistence model</strong><br>Primary store: <code>_IFRS_Metadata</code> sheet with <code>Key/Value</code> rows. Writes attempted atomically via <code>WriteMetaValueAtomic(key,value)</code> which writes a temporary key and then moves value to final key with retries and exponential backoff; on repeated failure the key/value is buffered in-memory (<code>g_metaBuffer</code>) via <code>BufferMetaValue</code> and flushed later by <code>FlushMetaBuffer</code> or when sheet becomes available. Sensitive keys are redacted on write (<code>IsSensitiveKey</code>) and tracked in <code>SensitiveKeys</code>.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Safe write behaviors & fallbacks</strong><br><code>WriteMetaValue</code> will attempt to find existing key row and overwrite or append. If the metadata sheet is unavailable or write errors occur, values are buffered in <code>g_metaBuffer</code>. <code>FlushMetaBuffer</code> attempts to persist buffered values and removes entries on success. <code>WriteMetaValueAtomicDual</code> writes both primary and legacy-prefixed keys for one cycle.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Safe Application.Run wrappers</strong><br><code>CallRunWithArgs</code>, <code>CallRunWithArgsWithResult</code>, <code>RunWithArgs</code>, <code>RunWithArgsWithResult</code> — support up to 9 args, truncate beyond that, and log audit rows on errors. These helpers centralize error handling and avoid call-site duplication. <code>SafeRun</code> / <code>SafeRunWithResult</code> attempt a workbook-qualified call first (preferred on non-Mac), then an unqualified call, and return boolean / result safely.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Error handling & forwarding</strong><br><code>Bootstrap_HandleError(proc, errNum, errDesc, procContext)</code> attempts to forward errors to <code>HandleError</code> if available via <code>SafeRunWithResult</code>; otherwise it falls back to <code>AppendLocalAudit</code>. <code>Bootstrap_Audit(action,message)</code> sends to audit via <code>LogAudit</code> if available, otherwise writes to local <code>_IFRS_Audit</code> sheet fallback.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Audit integration</strong><br>Audit calls are performed via <code>SafeRunWithResult(&quot;LogAudit&quot;, ...)</code> (constant <code>AUDIT_PROC_NAME</code>). If audit module is absent, <code>AppendLocalAudit</code> creates a minimal audit sheet and writes human-friendly audit rows. Audit messages include deterministic bootstrap id and truncated payloads (use <code>TruncateForAudit</code>).  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Job reconciliation & ribbon integration</strong><br><code>Ribbon_ReconcileJobsOnOpen</code> inspects <code>_IFRS_Jobs</code>, reschedules queued/scheduled jobs (respecting retry limits and <code>MAX_ONETIME_RETRY_AGE_DAYS</code>), updates job rows and meta, and emits bootstrap audit events. <code>Ribbon_AttemptGracefulShutdown</code> cancels scheduled jobs on shutdown and marks statuses accordingly.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Migration support</strong><br><code>MigrateJobsSheetToV2</code> performs best-effort migration of the jobs sheet: ensures <code>CreatedAt</code>, <code>UpdatedAt</code> exist and sets a <code>v2_migrated</code> flag per row; records <code>JobsSheetV2Migrated</code> in metadata and emits audit. Migration is idempotent and non-blocking.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Tests & self-test harness</strong><br>• Deterministic / repeatable tests available: <code>AddIn_SelfTestStartup</code>, <code>AddIn_RunInternalTests</code>, <code>Ribbon_SelfTest</code>.<br>• Self-tests cover CRC32 vector validation, metadata R/W, sensitive key redaction behavior, safe-run semantics, OnTime schedule/cancel simulation, idempotence of CRC table, and write truncation behaviors. Test results are appended to <code>_IFRS_TestResults</code>.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>CRC32 utilities & deterministic IDs</strong><br><code>CRC32_String(s)</code> → 32-bit CRC used for deterministic short ids; <code>EnsureCRC32Table</code> lazily initializes the CRC table. <code>HexFromLong</code> formats CRC in uppercase hex. CRC vector validated against <code>The quick brown fox</code> → expected <code>B74574DE</code>. Bootstrap id built from CRC of start timestamp + username.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Sensitive key handling</strong><br><code>IsSensitiveKey(key)</code> detects common patterns (<code>password</code>, <code>oauth</code>, <code>api_key</code>, <code>secret</code>, <code>token</code>, <code>pwd</code>, <code>pass</code>, <code>key</code>+<code>api</code>) and causes <code>WriteMetaValue</code> to redact stored value to <code>... [REDACTED]</code> and add key to <code>SensitiveKeys</code> index. Sensitive storage is intentionally truncated and marked for safety.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Defensive COM helpers & platform checks</strong><br><code>CreateObjectSafe(progId)</code> wraps <code>CreateObject</code> with error suppression; <code>IsMac()</code> infers platform from <code>Application.OperatingSystem</code>. <code>IsThisWorkbookUnavailable()</code> protects against contexts where <code>ThisWorkbook</code> is inaccessible.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Concurrency & idempotence</strong><br>• <code>AddIn_Initialize</code> is guarded by <code>g_bootstrapInitialized</code> and <code>g_bootstrapInitializing</code> to prevent re-entrancy.<br>• Cache reset (<code>ResetCaches</code>) ensures deterministic warm-up between runs.<br>• Sheet creation routines tolerate name-collisions and fallback to timestamped alternate names.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Diagnostics & telemetry</strong><br>• Metadata keys emitted: <code>BootstrapId</code>, <code>BootstrapVersion</code>, <code>BootstrapStartUtc</code>, <code>BootstrapInitialized</code>, <code>BootstrapScheduled</code>, <code>ScheduledProcedure</code>, <code>ScheduledWhen</code>, <code>LastCapabilitySnapshot</code>, <code>LastCapabilitySnapshotUpdated</code>, <code>OnTimeQualifiedPreferred</code>.<br>• <code>_IFRS_Audit</code> receives bootstrap lifecycle events (<code>Initialize</code>, <code>DeferredInit</code>, <code>RotateStart</code>, etc.).<br>• Jobs sheet stores per-job <code>retrycount</code> and <code>onTimeProc</code> in <code>Meta</code> field via semi-colon <code>key=val</code> pairs.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Operational guidance & best practices</strong><br>• Call <code>AddIn_Initialize</code> on workbook/add-in load, and <code>AddIn_Shutdown</code> on close.<br>• Ensure workbook macros calling <code>SafeRun</code> wrappers are signed and code-reviewed before enabling external feature flags that call untrusted macros.<br>• Restrict modification rights to <code>_IFRS_Metadata</code>, <code>_IFRS_Jobs</code>, and <code>_IFRS_Audit</code> sheets (protect sheets, set ACLs on workbook file).<br>• Prefer workbook-qualified procedures for OnTime scheduling on Windows (module uses qualified proc string where possible).  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Runbook triggers & monitoring</strong><br>• If deferred init fails or self-test fails → flag issue, collect diagnostics (meta keys, <code>_IFRS_TestResults</code>, <code>_IFRS_Audit</code>), and escalate.<br>• If <code>SafeOnTimeSchedule</code> repeatedly fails for a job → job meta marked <code>orphaned</code>/<code>orphaned_maxed</code>; reconcile via <code>Ribbon_ReconcileJobsOnOpen</code>.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Limitations & known behaviors</strong><br>• OnTime scheduling reliability depends on host OS and Excel platform; Mac behavior differs (code prefers unqualified calls on Mac).<br>• Metadata writes are “atomic-ish” (temp-key then copy) but not strongly transactional — persistence is best-effort with in-memory buffering as fallback.<br>• Sensitive-key redaction is heuristic-based; do not rely on it for cryptographic secrecy — avoid storing long secrets in metadata.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Troubleshooting checklist</strong><br>1. Deferred init not running → inspect <code>ScheduledProcedure</code> & <code>ScheduledWhen</code> meta keys and <code>_IFRS_Jobs</code> row for <code>deferredinit</code>.<br>2. Jobs missing or <code>orphaned</code> → check <code>retrycount</code> in job meta and run <code>Ribbon_ReconcileJobsOnOpen</code> or inspect OnTime scheduling capability.<br>3. Metadata writes failing → inspect <code>MetadataSheetCreateError</code> meta key, check workbook protection/permissions, then flush <code>g_metaBuffer</code> contents.<br>4. CRC32 vector mismatch → run <code>AddIn_RunInternalTests</code> and check <code>_IFRS_TestResults</code>.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Examples (typical row & meta)</strong><br>Job row example: <code>JobId=deferredinit | Handler=AddIn_DeferredInit | Status=queued | ScheduledAt=2025-12-27 21:11:00 | Meta=proc=&#x27;MyWB.xlsm&#x27;!AddIn_DeferredInit;retrycount=0 | CreatedAt=...</code><br>Meta keys example: <code>BootstrapId=boot-...</code>, <code>BootstrapVersion=1.0.0</code>, <code>ScheduledProcedure=&#x27;MyWB.xlsm&#x27;!AddIn_DeferredInit</code>. </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Integration checklist for dependent modules</strong><br>• Provide <code>LogAudit(action, message)</code> and <code>HandleError(proc, errNum, errDesc, context)</code> to integrate with bootstrap audit and error forwarding.<br>• Expose <code>Config_Load</code>, <code>Config_Get</code>, and <code>Config_MigrateIfNeeded</code> to participate in deferred configuration loading and migration.<br>• Register long-running work as jobs using <code>EnqueueOrUpdateJob</code> to enable scheduling, reconciliation and shutdown coordination.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Maintenance recommendations</strong><br>• Run self-tests (<code>AddIn_SelfTestStartup</code> / <code>AddIn_RunInternalTests</code>) as part of CI release and periodically in monitoring.<br>• Rotate or back up the workbook regularly; export metadata and job sheets for forensic retention.<br>• Review <code>SensitiveKeys</code> meta and purge secrets from metadata; use secure vaults for long-lived secrets.  </td></tr><tr><td data-label="Technical User Guide — modBootstrap"> <strong>Change control notes</strong><br>Public names and API signatures are preserved by design. Any change to public names requires updating all callers and CI checks. When releasing changes, run <code>AddIn_RunInternalTests</code>, <code>VerifyAuditChain</code> (modAudit), and CI validation to detect regressions early.  </td></tr></tbody></table></div><div class="row-count">Rows: 30</div></div><div class="table-caption" id="Table4" data-table="Docu_0158_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modCalculations"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modCalculations</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modCalculations"> <strong>Module identity & version</strong><br><code>modCalculations</code> — financial & IFRS-style calculation helpers. Public compatibility preserved. <code>MODCALC_VERSION = &quot;3.0.3&quot;</code>. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Purpose & guarantees</strong><br>Provides deterministic, defensive calculation helpers (depreciation, amortization/lease schedules, NPV, ECL, deferred tax, year fractions, normalization utilities). Guarantees: preserved public signatures, config-driven behavior, centralized error-to-audit routing (non-UI-failing by default), numeric stability guards, and a self-test harness. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Public API (high-level)</strong><br>Key functions: <code>CalcDepreciation</code>, <code>CalcDepreciationEx</code>, <code>LeaseAmortizationSchedule</code>, <code>PvFromPmt</code>, <code>RecognizeRevenue</code>, <code>ImpairmentLoss</code>, <code>ImpairmentLossByNPV</code>, <code>NPVFromArray</code>, <code>ExpectedCreditLoss</code>, <code>ExpectedCreditLossBatch</code>, <code>GenerateDepreciationSchedule</code>, <code>GenerateDepreciationScheduleEx</code>, <code>DeferredTax</code>, <code>GetPaymentCountFromNormalized</code>, <code>GetPaymentAmountFromNormalized</code>, <code>GetPaymentDateFromNormalized</code>, <code>NormalizePaymentsForRead</code>, <code>NormalizeArrayInput</code>, <code>YearFraction</code>, <code>BuildMaturityAnalysis</code>, <code>ExportSheetToCsv</code>, plus job lifecycle hooks (<code>EnqueueCalculationJob</code>, <code>UpdateJobMeta</code>, <code>FindJobRow</code>, <code>CancelCalculationJob</code>, <code>FindJobRowInSheet</code>). Diagnostic/CI: <code>CalculationsSelfTest</code>. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Return shapes & conventions</strong><br>Schedules: 1-based 2D arrays. Example shapes: <code>LeaseAmortizationSchedule</code> → <code>(1..nPeriods, 1..6)</code> columns: <code>Period, OpeningBalance, Payment, Interest, Principal, ClosingBalance</code>.<br>Depreciation schedules → header at index 0 with rows <code>0..n</code> and columns <code>(1..4)</code> for <code>Period, DepreciationExpense, AccumulatedDepreciation, CarryingAmount</code>.<br><code>NormalizePaymentsForRead</code> returns 1-based array whose elements are either scalars or 1..2 1-based arrays: <code>(1)=date/label</code>, <code>(2)=amount</code> (Empty if absent). </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Configuration keys & runtime flags</strong><br>Fetches config via <code>GetConfigValue</code> (cached):<br><code>modCalculations.RaiseErrors</code> (boolean, default <code>DEFAULT_RAISE_ERRORS = False</code>) — controls whether errors are raised to UI.<br><code>modCalculations.RoundPolicy</code> (numeric, default <code>DEFAULT_ROUNDING_POLICY = 2</code>).<br><code>modCalculations.UseCentralRounding</code> (boolean, default <code>DEFAULT_USE_CENTRAL_ROUNDING = False</code>).<br><code>modCalculations.LegacyInterestMode</code> (compat shim). Use <code>InvalidateModCalculationsCache</code> after config changes. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Rounding & precision</strong><br>Centralized rounding via <code>applyRounding(value, policy)</code> with optional central integration: if <code>UseCentralRounding</code> true, attempts <code>modUtilities.ApplyRounding</code> / <code>modUtilities.Round</code> safely via <code>SafeApplicationRun</code>. Policies: <code>roundNone</code>, <code>roundFinancial</code> (2 decimals), <code>roundInteger</code>. Precision cached in <code>gRoundingPrecisionCache</code>. Alias <code>ApplySafeRound</code> provided. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Numeric stability & limits</strong><br>Constants: <code>PV_MAX_NPER = 1000000</code>, <code>RATE_NEAR_ZERO = 1e-12</code>, <code>TINY_RESIDUAL_THRESHOLD = 1e-10</code>, <code>MAX_SCHEDULE_ROWS = 200000</code>. Implementations guard near-zero rates, cap <code>nper</code>, zero tiny residuals, clamp salvage ≤ cost, and cap schedule lengths with logs. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Hash / correlation helpers</strong><br><code>GenerateCorrelationID()</code> produces local correlation IDs (timestamp + hex fragment). <code>ExtractCorrelationFromVariant</code> helper provided. <code>CRC32String</code> used for lightweight stable keys. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Safe external calls / integration pattern</strong><br>Use <code>SafeApplicationRun(procName, outResult, params)</code> and fallback <code>SafeCallCentral</code> to call host procedures without bubbling errors to UI. <code>TryExternalCall</code> is a thin wrapper. This pattern prevents host UI errors and is used to call <code>modUtilities</code>, <code>modAudit</code>, <code>modError</code>, <code>modRibbonCallbacks</code>, <code>modTests</code>, and other host modules when available. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Error handling & audit routing</strong><br><code>HandleCalcError(proc, errNum, errMsg)</code> funnels errors to: <code>modError.HandleError</code> (if present), <code>SafeLogEvent</code> (<code>modAudit.LogEvent</code>), <code>modAudit.LogEx</code> / <code>modAudit.Log</code> / <code>LogAudit</code>, or <code>AppendLocalAudit</code> fallback. Defaults to non-raising behavior unless <code>modCalculations.RaiseErrors</code> = True. All messages are redacted/truncated via <code>RedactSecrets</code> + <code>TruncateForCell</code> before local logging. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Local audit fallback</strong><br><code>AppendLocalAudit(message)</code> writes to a local <code>_IFRS_Audit</code> sheet if central audit is unavailable. Columns: <code>Timestamp, User, Message, CorrelationId</code>. Ensures minimal persistence for error contexts when central systems are missing. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Normalization utilities</strong><br><code>NormalizeArrayInput</code> — generic 1-D 1-based array coercion from <code>Range</code>, <code>Collection</code>, <code>Dictionary</code>, array, or scalar.<br><code>NormalizePaymentsForRead</code> — specialized coercer that always returns 1-based elements where each element is a 1..2 array <code>(date/label, amount)</code> (amount may be <code>Empty</code>) — handles multi-column ranges, dictionaries and collections robustly. Use these to sanitize input to schedule functions. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Depreciation functions</strong><br><code>CalcDepreciationEx(cost,usefulLife,method, salvage, unitsProduced, unitsTotal, rounding)</code> — supports <code>depStraightLine</code>, <code>depDecliningBalance</code>, <code>depSumOfYears</code>, <code>depUnitsOfProduction</code> with input validation and rounding via <code>applyRounding</code>.<br><code>GenerateDepreciationSchedule</code> — period-based schedules (fallbacks to SL for UoP when no units provided).<br><code>GenerateDepreciationScheduleEx</code> — <strong>units-of-production schedule</strong>: accepts <code>unitsSeries</code> (range/array/collection/dictionary/scalar) normalized via <code>NormalizePaymentsForRead</code>; sums units and allocates expense proportionally; enforces <code>MAX_SCHEDULE_ROWS</code>. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Lease amortization / payment helpers</strong><br><code>LeaseAmortizationSchedule(pmt, ratePerPeriod, periods, startDate)</code> returns <code>(1..n,1..6)</code> amortization rows computed in-memory. Uses <code>PvFromPmt</code> to compute opening balance and handles near-zero rates. Rounding applied to payment/interest/principal; final row adjusted to reconcile residual differences. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>PV & NPV</strong><br><code>PvFromPmt(pmt, rate, nper)</code> — robust PV calculation: handles <code> | rate | &lt; RATE_NEAR_ZERO</code>by using<code>pmt*n</code>, clamps <code>nper</code>to<code>PV_MAX_NPER</code>, ensures positive result for asset balances.<br><code>NPVFromArray(cashflows, discountRate)</code>— accepts scalar or array with arbitrary LBound/UBound; validates<code>discountRate &gt; -1</code>and sums discounting by<code>periodIndex</code>. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Expected credit loss (ECL)</strong><br><code>ExpectedCreditLoss(exposure, pd, lgd)</code> — returns <code>exposure * pd * lgd</code> with bounds checks (<code>pd</code>, <code>lgd</code> in [0,1]).<br><code>ExpectedCreditLossBatch(exposures,pds,lgds)</code> — normalizes inputs, supports element-wise computation and returns a 1-based array of doubles. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Dates & day-counts</strong><br><code>YearFraction(d1,d2,method)</code> supports <code>dcAct365</code> (default), <code>dcAct360</code>, <code>dc30_360</code> (basic US 30/360). Deterministic, normalizes tiny negative results to 0. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Self-tests & CI hooks</strong><br><code>CalculationsSelfTest()</code> — expanded deterministic self-test harness (repeats checks 10×), validates core functions (depreciation, EBITDA, revenue recognition, ECL, deferred tax, lease PV behavior, NPV), writes results to <code>_IFRS_TestResults</code> (very hidden) and attempts to register with <code>modTests.RegisterSelfTest</code>. Use this function in CI and pre-release checks. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Job lifecycle & host integration</strong><br><code>EnqueueCalculationJob(jobName,meta)</code> returns correlation id; attempts <code>modRibbonCallbacks.EnqueueJob</code> else logs locally.<br><code>UpdateJobMeta</code>, <code>FindJobRow</code>, <code>CancelCalculationJob</code> integrate with <code>modRibbonCallbacks</code> where present and fall back to safe local logging if central callbacks absent. <code>ReconcileOrphanedJobs</code> / <code>ReconcileOrphanedJobsOnOpen</code> are reconciliation hooks for host startup. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Export & maturity helpers</strong><br><code>BuildMaturityAnalysis(payments, outSheetName)</code> — normalizes payments and writes a compact maturity table to <code>outSheetName</code> (<code>CorrelationId, Index, Value, Timestamp</code>); respects <code>MAX_SCHEDULE_ROWS</code>.<br><code>ExportSheetToCsv(sheetName, csvPath)</code> — copies sheet to new workbook and saves as CSV (best-effort). </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Logging & telemetry expectations</strong><br>Module uses <code>SafeLogEx</code> wrapper to send structured logs to <code>modAudit</code>/<code>LogEvent</code> where available; emits contextual events (<code>SelfTest</code> result, schedule truncation warnings, provider fallbacks). Sensitive strings redacted by <code>RedactSecrets</code> and truncated to <code>MAX_AUDIT_MSG_LEN</code>. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Security & data handling</strong><br><code>RedactSecrets</code> performs lightweight heuristics (replaces <code>@</code> with <code>[at]</code> and truncates) to avoid leaking secrets to local audit. All external calls are made via safe wrappers to avoid unexpected UI exceptions. Avoid storing raw secrets in <code>ContextJSON</code> or direct function parameters. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Dependencies & compatibility notes</strong><br>Soft dependencies: <code>modUtilities</code> (central rounding), <code>modAudit</code> (structured logs), <code>modError</code> (central error handling), <code>modRibbonCallbacks</code> (job orchestration), <code>modTests</code> (self-test registration). All are invoked via safe wrappers; module continues to function with local fallbacks if they are missing. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Limitations & cautions</strong><br>• Central rounding depends on <code>modUtilities</code> — if absent, local rounding used.<br>• Large <code>nper</code> and tiny rates are guarded but extreme inputs may still be numerically sensitive; validate inputs upstream.<br>• <code>GenerateDepreciationSchedule</code>’s <code>depUnitsOfProduction</code> falls back to straight-line if units series not supplied — prefer <code>GenerateDepreciationScheduleEx</code> for units-based schedules.<br>• <code>AppendLocalAudit</code> creates a simpler local <code>_IFRS_Audit</code> if central audit missing — this may differ from <code>modAudit</code> canonical schema. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Examples</strong><br><code>sch = LeaseAmortizationSchedule(100, 0.01, 36)</code> → returns (1..36,1..6) amortization table.<br><code>dep = CalcDepreciationEx(1000, 5, depStraightLine)</code> → per-period expense.<br><code>units = Array(10,20,30): sched = GenerateDepreciationScheduleEx(600, units)</code> → UoP schedule; sum of <code>DepreciationExpense</code> ≈ <code>cost - salvage</code>.<br><code>ecl = ExpectedCreditLoss(10000, 0.02, 0.5)</code> → 100. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Operational recommendations</strong><br>• Call <code>InvalidateModCalculationsCache</code> after runtime config updates.<br>• Run <code>CalculationsSelfTest</code> in CI or on deployment to validate numeric paths.<br>• Prefer <code>NormalizePaymentsForRead</code> for any payment schedule input to ensure deterministic shape.<br>• Restrict who can toggle <code>modCalculations.RaiseErrors</code> — raising errors surfaces exceptions to host UI. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Troubleshooting checklist</strong><br>1. Incorrect rounding results → verify <code>modCalculations.RoundPolicy</code> and <code>UseCentralRounding</code>; check <code>modUtilities</code> availability.<br>2. Truncated schedules → check <code>MAX_SCHEDULE_ROWS</code> and input normalization; Consult <code>SafeLogEx</code> entries for <code>Periods truncated</code> messages.<br>3. Missing central job integration → verify <code>modRibbonCallbacks</code> presence; otherwise local queueing/logging is used.<br>4. Self-test failures → inspect <code>_IFRS_TestResults</code> and run <code>GenerateDiagnostic</code> (host-side) or re-run <code>CalculationsSelfTest</code> in a clean workbook. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Maintenance notes for developers</strong><br>• Preserve public signatures when changing implementations.<br>• If adding config keys call <code>InvalidateModCalculationsCache</code> to refresh caches.<br>• Keep <code>RedactSecrets</code> and <code>TruncateForCell</code> updated if new sensitive patterns are used.<br>• Prefer array-based in-memory processing when adding new schedule algorithms to maintain performance. </td></tr></tbody></table></div><div class="row-count">Rows: 28</div></div><div class="table-caption" id="Table5" data-table="Docu_0158_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modConfig"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modConfig</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modConfig"> <strong>Overview</strong><br>Central configuration, migration, and persistence utilities for <code>IFRS_Reporting_AddIn.xlam</code>. Manages a single authoritative config XML (<code>IFRSConfig</code>) stored in <code>CustomXMLPart</code> when available, with sheet-based fallback. Provides typed feature-flag and setting APIs, safe secret delegation, checksum verification, migration registry, cached read/write with configurable write policy (write-through / write-back), export/import, self-test harness and runtime integration points for audit and error handling. Designed for minimal, backward-compatible changes and hardened defaults. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Public API (key routines)</strong><br><code>LoadConfigXML()</code> / <code>LoadConfig()</code> — load authoritative XML (verify checksum when available).<br><code>GetConfigCached(forceRefresh)</code> — cached getter with TTL.<br><code>SetSetting(key,val)</code> / <code>GetSetting(key)</code> / <code>GetSettingTyped(key,type)</code> / <code>SetSettingTyped(key,val,type)</code> — settings accessors with TryRunReturn delegation fallback.<br><code>FeatureFlag_GetTyped(key)</code> / <code>FeatureFlag_Get(key)</code> / <code>FeatureFlag_IsEnabled(key)</code> / <code>FeatureFlag_SetTyped(key,value,type,expires)</code> / <code>FeatureFlag_Set</code> — typed feature flag APIs.<br><code>SaveConfigXML(xml)</code> — validate and persist config to CustomXMLParts (with checksum & schema props) or fallback to sheet; supports atomic-like replacement and cleanup of older parts.<br><code>ImportConfigFromFile(path)</code> / <code>ExportConfigToFile(path)</code> — file import/export using safe temp file rename/copy semantics.<br><code>RunMigrations(currentXml,targetVersion,commit)</code> — run registered migration routines (optionally commit).<br><code>RegisterMigration(from,to,routineName)</code> — register migration routine.<br><code>FlushPendingWrites()</code> — persist cached write-back content.<br><code>ResetToDefaults(commit)</code> — clear and write default config.<br><code>RunConfigSelfTests()</code> — built-in test suite writing <code>_IFRS_TestResults</code> and change history. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Stable constants & props</strong><br>Root name: <code>IFRSConfig</code>.<br>CustomDocumentProperties keys: <code>IFRS_Config_SchemaVersion</code> and <code>IFRS_Config_Checksum</code>.<br>Audit delegate name: <code>modAudit.LogAudit</code> (preferred). Secret prompt delegate: <code>Secret_Prompt_UI</code>. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Canonical storage & verification model</strong><br>Primary storage: <code>ThisWorkbook.CustomXMLParts</code> containing <code>IFRSConfig</code> XML. On save, module computes checksum (prefer SHA256 via system <code>certutil</code> probe; falls back to CRC32) and stores lowercased checksum in <code>IFRS_Config_Checksum</code> custom document property. On load, if checksum property exists, module locates the part whose computed checksum matches stored value—mismatch triggers backup and audit entry and load fails. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Fallback persistence</strong><br>If CustomXMLParts unavailable or add fails, module persists config into a hidden sheet <code>_IFRS_ConfigSheet</code> (cell A2). When using fallback, a CRC32-based checksum is recorded to <code>IFRS_Config_Checksum</code> property where possible. Fallback used only when necessary and audited. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Checksum & hashing behavior</strong><br>Preferred: SHA256 using <code>certutil</code> on Windows (writes temp file, runs <code>certutil -hashfile ... SHA256</code>, parses stdout). If unavailable or parsing fails, fallback CRC32 over UTF-8 bytes. Checksum string stored lowercase. Compute helpers mirror those in <code>modAudit</code> (CRC32 table + UTF-8 conversion using ADODB.Stream when available). </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Security & safe defaults</strong><br>Feature flags defaults: custom XML fallback disabled; prompt fallback disabled; local audit enabled; plaintext secret persist disabled; verbose logging disabled. Avoid enabling <code>allow_plaintext_secret_persist</code>. Use <code>SetAuditFeatureFlag</code> equivalents in <code>modAudit</code> only when trusted. <code>LogAuditLocal</code> delegates to <code>modAudit.LogAudit</code> (via <code>TryRunReturn</code>) and falls back to immediate window if unavailable. <code>Config_SetSecret</code> delegates to <code>modSecurity</code> (or legacy) and refuses plaintext persistence if delegate missing. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Delegation & optional cross-module calls</strong><br><code>TryRunReturn(procName, ParamArray args())</code> — robust wrapper that attempts <code>Application.Run</code> with 0..9 args and returns <code>Empty</code> on failure; used for optional integration points (audit, security, utilities, ribbon, error handlers, migrations). All external calls are non-fatal; failures are logged via <code>LogAuditLocal</code>. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Caching, write policies & debounce</strong><br>In-memory cache: <code>CacheXml</code>, <code>CacheTimestamp</code>, <code>CacheDirty</code> with TTL <code>CacheTTLSeconds</code> (default 60). WritePolicy options: <code>write_through</code> (default) — immediate persist on <code>SetSetting</code>/<code>FeatureFlag_SetTyped</code>; <code>write_back</code> — keep cached changes and persist later via <code>FlushPendingWrites</code>. <code>WriteDebounceSeconds</code> controls deferred flush behavior under write-back; <code>LastWriteTimestamp</code> used for debounce. <code>ModuleLock</code> prevents concurrent writes. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Validation rules</strong><br><code>ValidateConfigXML_Explain(xml)</code> performs structural checks: XML declaration present, root <code>&lt;IFRSConfig&gt;</code> present, <code>&lt;SchemaVersion&gt;</code> required. Additional pragmatic checks: <code>IFRS.RoundingPrecision</code> must be integer 0..10; <code>IFRS.DayCount</code> must be one of <code>30/360</code>, <code>ACT/365</code>, <code>ACT/360</code>, <code>ACT/ACT</code>. Validation sets <code>LastValidationError</code> for diagnostics. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Migration framework</strong><br>Deterministic registry (<code>Scripting.Dictionary</code>) maps <code>from | to</code>→<code>routineName</code>. Built-in registration includes <code>&quot;1.0.0 | 1.1.0&quot; → &quot;Migrate_v1_0_0_to_v1_1_0&quot;</code>. <code>BuildMigrationPath(current,target)</code>builds ordered routine collection and enforces a safety bound.<code>RunMigrations</code>invokes built-ins directly or<code>TryRunReturn</code> for external routines; supports optional commit to persist migrated XML. Migration routines must return transformed XML; failures are audited and abort the migration run. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Feature flags & settings model</strong><br>Settings and feature flags are stored as XML elements (<code>&lt;Setting key=&quot;&quot; value=&quot;&quot;/&gt;</code>, <code>&lt;Flag key=&quot;&quot; value=&quot;&quot; type=&quot;&quot; expires=&quot;&quot;/&gt;</code>) inside <code>&lt;Settings&gt;</code> and <code>&lt;FeatureFlags&gt;</code>. Typed getters parse <code>type</code> and <code>expires</code> attributes; <code>FeatureFlag_IsEnabled</code> handles boolean interpretations and expiry dates. <code>FeatureFlag_SetTyped</code> updates or inserts flag nodes and respects write policy semantics (write-through vs write-back). </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Secret management & delegation</strong><br>Secrets are not stored by this module directly; <code>Config_GetSecret</code> / <code>Config_SetSecret</code> attempt delegated calls to <code>modSecurity</code> or legacy functions via <code>TryRunReturn</code>. If no secure delegate exists, <code>Config_SetSecret</code> returns <code>False</code> and refuses plaintext persistence. UI prompts for secrets should be delegated to <code>Secret_Prompt_UI</code> when present. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Export/Import atomic behavior</strong><br><code>ExportConfigToFile(fullPath)</code> writes XML to a temp file in <code>GetSafeTempFolder()</code> then renames/moves to <code>fullPath</code> (uses <code>Name</code> or <code>Scripting.FileSystemObject.CopyFile</code> fallback) to avoid partial writes. <code>ImportConfigFromFile</code> reads file as binary, validates via <code>ValidateConfigXML_Explain</code>, then persists via <code>SaveConfigXML</code>. Errors produce audit entries and <code>ImportConfigFromFile</code> fails safe. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Change history & audit trail</strong><br><code>AppendChangeHistory(action,oldVal,newVal,corrId)</code> appends redacted entries to <code>_IFRS_ConfigHistory</code> worksheet with timestamp, user, action and correlation id. Secrets in history are redacted via <code>RedactSecrets</code> (simple pattern replacements). All important operations log via <code>LogAuditLocal</code> (delegated). </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Concurrency & safety</strong><br><code>ModuleLock</code> prevents overlapping writes during <code>SaveConfigXML</code>. Persists attempt to replace custom XML parts atomically by adding new part, deleting older matching root parts, and writing checksum/document props only after successful compute. On commit failure, module performs <code>BackupConfigXML</code> to a temp file and emits audit <code>ConfigError</code>. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Self-test & diagnostics</strong><br><code>RunConfigSelfTests()</code> performs a sequence of tests (save/load, feature flag round-trip, setting round-trip, typed setters, flush, fallback sheet presence, export/import round-trip) and writes <code>_IFRS_TestResults</code>. Use this regularly in pre-deployment or CI. <code>GetLastValidationError()</code> returns last validation failure reason. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Error handling & integration with modError</strong><br><code>HandleConfigError(proc,msg)</code> logs via audit, attempts to call <code>modError.HandleError</code> or legacy probe <code>modError_Probe_HandleError</code> via <code>TryRunReturn</code>, and raises a VBA error with correlation id to propagate. <code>IsErrorHandlerAvailable</code> probes for error handler presence non-disruptively. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Utilities & platform awareness</strong><br><code>GetSafeTempFolder()</code> gathers candidates: <code>TEMP</code>/<code>TMP</code> env vars, workbook path, <code>Application.DefaultFilePath</code>, macOS <code>MacScript</code> temporary items when available. UTF-8 conversion uses <code>ADODB.Stream</code> when present; falls back to <code>StrConv</code>. GUID generation uses <code>Scriptlet.TypeLib</code> with randomized fallback. <code>GetThisAddinSchemaVersion()</code> returns current schema version <code>1.1.0</code>. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Operational guidance & best practices</strong><br>• Initialize module (<code>EnsureModuleInitialized</code> implicitly called) before bulk operations.<br>• Keep <code>CustomDocumentProperties</code> writeable to permit checksum and schema storage.<br>• Prefer <code>write_through</code> for critical environments; use <code>write_back</code> only when you accept delayed persistence and ensure <code>FlushPendingWrites</code> runs on controlled shutdown or CI hooks.<br>• Disable plaintext secret persistence and require <code>modSecurity</code> integration for secret storage.<br>• Restrict access to backup folder and archives; review <code>BackupConfigXML</code> outputs periodically. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Runbook triggers & monitoring</strong><br>• Checksum mismatch on <code>LoadConfigXML</code> → create backup, emit <code>ConfigError</code> audit entry, escalate to <code>config-compromise</code> runbook.<br>• <code>SaveConfigXML</code> commit error or fallback path → audit <code>Config</code>/<code>ConfigError</code> and schedule manual verification of stored XML and checksum.<br>• Migration failures → audit <code>Migration</code> and block auto-commit until human review. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Limitations & migration notes</strong><br>• Module does not implement encrypted signing of config; signatures must be performed externally (CI signing) and associated with release manifest.<br>• SHA256 depends on system tools (<code>certutil</code> / Windows); on locked-down systems CRC32 is used (non-cryptographic). Plan acceptance criteria accordingly.<br>• XML edits are string-based (no DOM parser), so complex XML shapes should be validated and tested by migrations. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Troubleshooting checklist</strong><br>1. <code>LoadConfigXML</code> returns empty: check <code>IFRS_Config_Checksum</code> property, verify <code>CustomXMLParts</code> presence, review audit <code>ConfigError</code> entries and backup files created by <code>BackupConfigXML</code>.<br>2. Save failing and writing to sheet: workbook may lack <code>CustomXMLParts</code> support or permissions—inspect <code>_IFRS_ConfigSheet</code> and <code>_IFRS_ConfigHistory</code> for clues.<br>3. Checksum mismatch: run <code>ComputeChecksumForCustomXMLPart</code> manually (debug) and compare to <code>IFRS_Config_Checksum</code> property; if mismatch, restore backup and re-run <code>Verify</code>/<code>RunMigrations</code> as needed.<br>4. Migration failure: check <code>_IFRS_TestResults</code> and audit <code>Migration</code> entries, run migration routines locally using <code>RunMigrations(currentXml,target,False)</code> to reproduce. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Developer notes (integration)</strong><br>• Use <code>TryRunReturn</code> for optional cross-module calls; always handle <code>Empty</code> returns.<br>• Use <code>LogAuditLocal</code> rather than direct <code>LogAudit</code> to prefer modAudit delegation and avoid raising errors from missing audit module.<br>• Keep migration routines idempotent and return the transformed XML string. Register them via <code>RegisterMigration</code> in initialization. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Examples</strong><br>Feature flag element: <code>&lt;Flag key=&quot;feature.enable_verbose_logging&quot; value=&quot;true&quot; type=&quot;bool&quot; expires=&quot;2026-01-01T00:00:00Z&quot;/&gt;</code>.<br>Setting element: <code>&lt;Setting key=&quot;IFRS.RoundingPrecision&quot; value=&quot;4&quot;/&gt;</code>.<br>CustomDocumentProperty: <code>IFRS_Config_Checksum = &quot;e3b0c442...&quot;</code> (lowercase SHA256 or crc32). </td></tr></tbody></table></div><div class="row-count">Rows: 25</div></div><div class="table-caption" id="Table6" data-table="Docu_0158_06" style="margin-top:2mm;margin-left:3mm;"><strong>Table 6</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modDataInput"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modDataInput</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modDataInput"> <strong>Overview & Purpose</strong><br>Hardened import pipeline for IFRS Excel add-in. Responsible for safe ingestion of trial-balance style data from sheets, CSV, workbook ranges, JSON, or PowerQuery stubs. Built for defensive operation: optional external integrations (modConfig, modUtilities, modAudit, modError, modSecurity, modRibbonCallbacks), idempotent staging/commit, schema-driven validation, diagnostics, migration hooks, and self-test scaffolding. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Public API (backwards-compatible)</strong><br><code>ImportTrialBalance()</code> — legacy entry point (calls <code>ImportTrialBalanceAdvanced</code>).<br><code>ValidateCOA(accountCode)</code> — simple chart-of-accounts validation (kept compatible).<br><code>ImportTrialBalanceAdvanced(sourceType, sourcePath, targetWb, profileName, dryRun, allowOverwrite)</code> — full import driver. <br><code>EnqueueImportJob(jobId, handlerProcName, whenUtc)</code> — job enqueue wrapper. <br><code>CreateSampleTemplate([wb])</code>, <code>ExportSampleTemplateCSV(path)</code> — sample artifacts. <br><code>DataInputSelfTests()</code> / <code>DataInput_SelfTest()</code> — self-test harness. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Key constants & defaults</strong><br><code>STAGING_SHEET_NAME = &quot;_IFRS_Staging&quot;</code>; <code>IMPORT_PREVIEW_SHEET = &quot;_IFRS_Preview&quot;</code>; <code>IMPORT_ERRORS_SHEET = &quot;_IFRS_ImportErrors&quot;</code>; <code>IMPORT_LOCK_SHEET = &quot;_IFRS_ImportLock&quot;</code>; <code>DEFAULT_IMPORT_DEST_SHEET = &quot;TrialBalance&quot;</code>; <code>ROWID_HEADER = &quot;IFRS_RowID&quot;</code>; <code>STREAMING_THRESHOLD_BYTES = 3 MB</code>; <code>MAX_OPEN_RETRIES = 3</code>; <code>MODULE_SCHEMA_VERSION = 1</code>. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Guarantees & design constraints</strong><br>• Public signatures unchanged for backward compatibility.<br>• Public entry points swallow unhandled exceptions and funnel to <code>HandleError</code> / error audit (no UI exceptions).<br>• Defensive use of <code>TryRunReturn</code> for optional external module calls; empty return = treated as unavailable.<br>• Idempotent staging writes and atomic commit attempts (delegated to <code>modUtilities.AtomicSaveWorkbookAs</code> if available). </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Caching & runtime flags</strong><br><code>g_cacheColumnMap</code>, <code>g_cacheConfig</code> (Scripting.Dictionary) — cached config & column mappings; <code>EnsureCachesInit</code> / <code>InvalidateDataInputCache</code> available. <code>g_isRunning</code> — reentrancy guard. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Inter-module integration & safe invocation</strong><br><code>TryRunReturn(procName, ParamArray)</code> — safe wrapper for <code>Application.Run</code> with up to 9 args; returns <code>Empty</code> on error. Use <code>TryRunReturn</code> to call <code>modConfig</code>, <code>modAudit</code>, <code>modUtilities</code>, <code>modError</code>, <code>modSecurity</code>, <code>modRibbonCallbacks</code>. All calls are best-effort — module continues if unavailable. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Audit & error funnel</strong><br><code>SafeLog(source, message, level)</code> — attempts (in order): <code>modAudit.LogEvent</code>, <code>modAudit.LogAudit</code>, <code>modRibbonCallbacks.LogEvent</code>, then <code>AppendLocalAudit</code> fallback which writes a simple <code>_IFRS_Audit</code> sheet if modAudit is unavailable. All logged messages are redacted by <code>RedactSecrets</code> before emission.<br><code>HandleError(routineName, errNum, errDesc, corrId)</code> — attempts <code>modError.HandleError</code> variants, otherwise <code>AppendLocalAudit</code>. <code>SafeHandleError</code> wrapper calls <code>HandleError</code> silently. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Staging model & schema</strong><br>Staging sheet token <code>STAGING_SCHEMA_TOKEN</code> placed in cell A1. <code>CreateOrEnsureStagingSheet</code> locates or creates hidden staging sheet. <code>EnsureStagingSchema</code> guarantees token and moves headers down to prepare sheet for clean staging. <code>WriteArrayToSheetAtomic(ws, arr, trimEmptyCols)</code> writes staging data using array assignment. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Row identity & idempotency</strong><br><code>AssignStableRowIDs(stagingWs, correlationId)</code> ensures <code>IFRS_RowID</code> column exists and assigns stable IDs <code>RB-&lt;utcstamp&gt;-&lt;row&gt;-&lt;6digit&gt;</code> to missing IDs. Uses <code>GetUtcStampForId()</code> to produce UTC component. IDs prevent accidental duplication across runs and assist error mapping. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Preview & commit workflow</strong><br><code>PreviewImport(stagingWs, rowsToShow, corrId)</code> — creates <code>_IFRS_Preview</code> visible sheet for operator review (first N rows).<br><code>CommitStagingToDestination(wb, stagingWs, destSheetName, allowOverwrite, corrId)</code> — creates backup if destination exists (prefix <code>_IFRS_Backup_</code>), copies staging <code>UsedRange</code> to destination via direct range assignment, renames staging sheet to <code>_IFRS_Staging_COMMITTED_&lt;ts&gt;</code>, attempts atomic save using <code>GetConfigValue(&quot;DataInput.AtomicSave.Path&quot;)</code> and <code>SaveWorkbookAsAtomic</code>, logs outcome. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Validation pipeline (schema-driven)</strong><br><code>ValidateStagingSheetSchemaDriven(stagingWs, corrId)</code> — header detection + column map overlay from config (<code>DataInput.ColumnMap.*</code>), rule set includes <code>account</code> (required) and <code>balance</code> (required,numeric,nonzero). Per-row checks, COA validation via <code>ValidateCOA</code>, returns <code>Scripting.Dictionary</code> of errors keyed by row. <code>WriteErrorsToSheet</code> writes <code>_IFRS_ImportErrors</code> with row, message, and <code>IFRS_RowID</code>. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Duplicate detection</strong><br><code>DetectDuplicatesInStaging(stagingWs, keyColumns)</code> — grouping by concatenated key columns (defaults <code>[&quot;account&quot;,&quot;balance&quot;]</code>) and returns dictionary of groups with row collections. Useful pre-commit. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Concurrency / locking</strong><br><code>AcquireImportLock(wb, corrId)</code> — creates <code>_IFRS_ImportLock</code> very-hidden sheet recording timestamp and owner correlation id. If a lock exists and age > 60 minutes, lock is considered stale and removed. <code>ReleaseImportLock(wb, corrId)</code> deletes lock only if caller owns it (or if corrId empty). Lock prevents concurrent imports across processes/users. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Read adapters & parsing</strong><br>• <code>ReadFromActiveSheetToArray</code> reads <code>UsedRange</code> to array.<br>• <code>ReadCsvToArray(fullPath)</code> — robust CSV reader: reads binary, normalizes BOM/newlines, builds logical CSV records with <code>BuildCsvLogicalRecords</code> (handles quoted newlines), splits lines with <code>SplitCsvLine_Strict</code> (handles quoted fields, escaped quotes), returns 2D VBA array. Handles large files by streaming read. <br>• <code>ReadWorkbookRangeToArray(path)</code> — opens workbook read-only with retry loop (<code>MAX_OPEN_RETRIES</code>) and fallback to already-open workbook. <br>• <code>ReadJsonToArray(path)</code> — simple JSON array/object parser with regex-based field extraction when VBScript.RegExp available, fallback to <code>JsonArrayToVBAArray</code>. Accepts only array top-level. Not a full JSON parser — suitable for well-formed simple JSON arrays/objects. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Text & binary helpers</strong><br><code>ReadBinaryStreamAsString</code> — block read; <code>NormalizeTextNewlinesAndBOM</code> removes UTF BOMs and normalizes line endings; <code>BuildCsvLogicalRecords</code> assembles logical records respecting quoted newlines. <code>SplitCsvLine_Strict</code> implements RFC-style field parsing with doubled-quote escape handling. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Security & path policy</strong><br><code>IsAllowedPath(path)</code> — delegates to <code>modSecurity.Security_AllowExportToPath</code> / <code>modSecurity.Security_AllowPath</code> if available; otherwise forbids obvious system paths (e.g., <code>C:\Windows</code>, <code>/etc</code>) and allows other paths. Use policy to prevent reading/writing sensitive system locations. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Atomic save & backups</strong><br><code>SaveWorkbookAsAtomic(wb, fullPath)</code> attempts <code>modUtilities.AtomicSaveWorkbookAs</code> first, then falls back to <code>wb.SaveCopyAs</code>. Commit creates a backup sheet named <code>_IFRS_Backup_&lt;dest&gt;_&lt;yyyymmdd_HHNNSS&gt;</code> if overwritten; backups are hidden (<code>xlSheetVeryHidden</code>). </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Diagnostics & telemetry</strong><br><code>CollectDiagnostics(stagingWs)</code> returns dictionary: <code>ok</code>, <code>rowsRead</code>, <code>issuesCount</code>, <code>corrId</code>, <code>timeTaken</code>. <code>WriteIntegrationTestPlan</code> and <code>DataInput_SelfTest</code> provide integration/self-test artifacts (<code>_IFRS_TestResults</code>). Logging calls use <code>SafeLog</code> to ensure telemetry reaches <code>modAudit</code> when available. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Migration & versioning</strong><br><code>MODULE_SCHEMA_VERSION = 1</code>; <code>PlanMigrateExistingInputs()</code> emits migration plan logs. Staging token <code>STAGING_SCHEMA_v1</code> used to locate legacy staging sheets for safe migration. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Self-test scaffolding</strong><br>Self-tests exercise CSV parsing, staging roundtrip, atomic write fallback, and JSON read. Self-test writes <code>_IFRS_TestResults</code> sheet and attempts <code>modUtilities.AtomicWriteFile</code> when available. Tests are best-effort and log via <code>SafeLog</code>. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Job queue integration</strong><br><code>EnqueueImportJob</code> attempts <code>modRibbonCallbacks.EnqueueJob</code>, then <code>modUtilities.EnqueueJob</code>, and finally falls back to <code>Application.Run(handlerProcName)</code> (synchronous). On outcome, <code>StoreJobMetadata</code> writes <code>_IFRS_Jobs</code> sheet row with job id, handler, whenUtc, enqueuedAt, status, and correlation id. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Error handling & fallbacks (practical behavior)</strong><br>All I/O and external calls use <code>On Error</code> defensive patterns. Fallbacks include: local audit sheet when modAudit unavailable, per-row append fallback when bulk write fails, SaveCopyAs when atomic save unavailable, simple regex JSON parse when parser unavailable. Internal error telemetry (<code>HandleError</code>) ensures failures are recorded without surfacing exceptions to UI. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Operational recommendations</strong><br>• Initialize <code>modAudit</code> / <code>modConfig</code> where possible so <code>SafeLog</code> and config mapping work fully.<br>• Run imports from a secured environment; restrict <code>IsAllowedPath</code> via <code>modSecurity</code> policy.<br>• Use <code>dryRun = True</code> to validate without committing.<br>• Run <code>ValidateStagingSheetSchemaDriven</code> and <code>DetectDuplicatesInStaging</code> before <code>CommitStagingToDestination</code>.<br>• Ensure <code>AUDIT</code> module chain verification (from modAudit guide) runs in CI; when <code>SafeLog</code> writes to local fallback audit sheet, ensure those sheets are protected and exported for long-term retention. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Troubleshooting checklist</strong><br>• Empty read results: confirm <code>IsAllowedPath</code> and source existence, inspect <code>_IFRS_ImportErrors</code> and <code>_IFRS_Audit</code> fallback.<br>• Staging cannot be created: check workbook protection and macro permissions; <code>CreateOrEnsureStagingSheet</code> searches very-hidden sheets for token.<br>• Lock acquisition fails: existing <code>_IFRS_ImportLock</code> present and not stale (less than 60 min).<br>• CSV parsing issues: check unusual quoting/escaping; examine <code>SplitCsvLine_Strict</code> behavior and <code>BuildCsvLogicalRecords</code> output in debug.<br>• Atomic save did not run: verify <code>modUtilities</code> availability and <code>DataInput.AtomicSave.Path</code> config. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Limitations & gotchas</strong><br>• JSON parsing is heuristic and not a full JSON engine; complex nested objects or arrays may not parse correctly — prefer normalized CSV for robust import.<br>• Self-tests and some helpers call external modules (<code>modUtilities</code>, <code>modSecurity</code>); absence does not stop the flow but reduces guarantees (atomic saves, path checks).<br>• <code>AssignStableRowIDs</code> creates IDs based on current UTC stamp and random part — uniqueness is highly likely but not cryptographically guaranteed. <br>• Large CSV files are read fully into memory by <code>ReadCsvToArray</code> — watch memory limits; streaming thresholds are only advisory. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Cross-module considerations (modAudit integration)</strong><br>• <code>SafeLog</code> and <code>HandleError</code> attempt to use <code>modAudit</code> first; enable <code>modAudit</code> (<code>InitAuditModule</code>) in host workbook for full chain-of-trust telemetry.<br>• Correlation IDs: modDataInput uses <code>GenerateCorrelationID()</code> (format <code>CID-yyyymmddHHMMSS-######</code>), whereas modAudit uses <code>NewCorrelationId()</code> — both are acceptable but note differences when correlating records across modules; consider centralizing correlation id generation in config for consistent tracing.<br>• When modAudit unavailable, <code>AppendLocalAudit</code> writes minimal audit rows to <code>_IFRS_Audit</code> (Timestamp, Message); these are not cryptographically chained — export and feed into central audit process if needed. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Recommended test & CI practices</strong><br>• Include <code>VerifyAuditChain</code> (modAudit) in CI and run <code>ImportTrialBalanceAdvanced</code> in a dry-run mode with representative sample inputs.<br>• Add integration tests that assert: staging creation, stable row ids assignment, validation errors produce <code>_IFRS_ImportErrors</code>, commit creates destination + backup, and <code>SaveWorkbookAsAtomic</code> behavior when <code>modUtilities</code> available. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Maintenance & future improvements</strong><br>• Replace heuristic JSON parsing with a robust JSON engine (COM or library) when allowed.<br>• Add configurable lock expiry and lock-owner diagnostics metadata.<br>• Optionally unify correlation ID generation to <code>modAudit</code> provider for end-to-end traceability.<br>• Expose streaming CSV reader for very-large files to avoid memory pressure. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Short examples</strong><br>Import dry-run from CSV (pseudo-call): <code>ImportTrialBalanceAdvanced &quot;csv&quot;, &quot;C:\imports\tb.csv&quot;, Nothing, &quot;&quot;, True, False</code> → reads CSV, stages, validates, writes <code>_IFRS_Preview</code>, writes <code>_IFRS_ImportErrors</code> if validation fails, does not commit.<br>Commit example (allowed overwrite): <code>ImportTrialBalanceAdvanced &quot;sheet&quot;, &quot;&quot;, ThisWorkbook, &quot;&quot;, False, True</code> → reads <code>TrialBalance</code> sheet, stages, validates, backup existing <code>TrialBalance</code>, writes new sheet, attempts atomic save if configured. </td></tr></tbody></table></div><div class="row-count">Rows: 29</div></div><div class="table-caption" id="Table7" data-table="Docu_0158_07" style="margin-top:2mm;margin-left:3mm;"><strong>Table 7</strong></div>
<div class="table-wrapper" data-table-id="table-7"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modError"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modError</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modError"> <strong>Purpose & scope</strong><br><code>modError</code> is the centralized, deterministic error-handling and diagnostics module for the IFRS Excel add-in. It standardizes error classification, user-facing messaging, redaction, telemetry emission, and local audit persistence. The module is explicitly designed to degrade safely when optional dependencies (<code>Scripting.Dictionary</code>, <code>modAudit</code>, <code>modConfig</code>) are unavailable, ensuring errors are never lost and execution never fails catastrophically due to logging or diagnostics. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Design principles</strong><br>• Deterministic behavior (no uncontrolled side effects).<br>• Backward compatibility with existing callers.<br>• Safe-by-default redaction and truncation.<br>• “Never throw” philosophy for diagnostics paths.<br>• Clear separation between internal diagnostics and user-facing messages.<br>• Local persistence even when higher-order audit systems are missing. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Core concepts</strong><br>Errors are represented internally using the <code>IFRS_Error</code> type and are associated with a correlation ID for traceability across procedures and modules. Each error may produce multiple telemetry events (start, handled, fallback) and at least one durable audit record. The module distinguishes between <em>internal messages</em> (for developers/audit) and <em>user messages</em> (for UI display). </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Severity model</strong><br><code>IFRS_ErrorSeverity</code> enum provides four ordered levels:<br>• <code>sevInfo</code> — informational, no remediation required.<br>• <code>sevWarning</code> — non-fatal issue, workflow may continue.<br>• <code>sevError</code> — operation failed, user action required.<br>• <code>sevCritical</code> — unrecoverable state or invariant violation.<br>Severity influences audit content, telemetry, and default catalog values but does not alter control flow directly. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Error catalog</strong><br>The catalog maps numeric error codes to default user messages, remediation guidance, and default severity. Initialization is lazy and attempted once per session (<code>EnsureCatalogInitialized</code>). If <code>Scripting.Dictionary</code> cannot be created, catalog lookups silently fall back to generic messages. This guarantees callers never block on catalog availability. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Catalog lifecycle & guarantees</strong><br>• Initialization is idempotent and guarded.<br>• Failure to initialize does not raise errors.<br>• Catalog contents are deterministic and versioned implicitly by module version.<br>• Callers may introspect catalog availability for testing and diagnostics. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Audit persistence model</strong><br><code>modError</code> maintains its own local audit sheet (<code>_IFRS_Audit</code>) as a last-resort system of record. This audit is independent of <code>modAudit</code> and requires no cryptographic provider or external tooling. The sheet is created on demand, marked <code>xlSheetVeryHidden</code>, and written using array transfers to minimize partial writes and reentrancy risk. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Simple audit append (<code>AppendLocalAudit</code>)</strong><br>Writes a minimal five-column record: timestamp, user, category, correlation ID, payload. Intended for fallback telemetry and bootstrap/self-check events. Payload length is capped to Excel limits and truncated safely. This method never computes checksums or schema versions and should be used only when structured context is unavailable. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Structured audit append (<code>AppendLocalAuditStructured</code>)</strong><br>Writes a normalized, versioned record with explicit columns: Timestamp, User, Category, Subject, CorrelationId, ErrNum, Severity, Outcome, Context, SchemaVersion, Checksum. Context and outcome are redacted and truncated. A CRC32 checksum is computed over the canonical payload to detect accidental corruption or tampering. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Audit schema versioning</strong><br><code>AUDIT_SCHEMA_VERSION</code> is embedded per row to allow future readers or migration tooling to interpret historical records correctly. Version increments must be backward-compatible and documented in release notes. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Checksum semantics</strong><br>The CRC32 checksum is intended as an integrity check only. It detects accidental edits or corruption but is not cryptographically secure. For tamper-evident, signed, or chained audit requirements, <code>modError</code> delegates to <code>modAudit</code> when available. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Redaction & normalization pipeline</strong><br>All user-visible and contextual strings pass through <code>RedactAndNormalize</code> before persistence. The pipeline removes or masks emails, PAN-like numbers, bearer/API keys, long token-like sequences, and (in strict mode) GUIDs. Whitespace is normalized and final output truncated. Redaction level is configurable via <code>modConfig</code> with safe defaults. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Redaction levels</strong><br>• Level 0 — no redaction (not recommended).<br>• Level 1 — moderate (default): tokens, emails, PANs, keys.<br>• Level 2 — strict: additionally redacts GUID-like identifiers.<br>Redaction failures never throw; best-effort masking is always applied. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Correlation ID strategy</strong><br>Correlation IDs provide cross-module traceability. Generation order:<br>1. Native GUID via <code>Scriptlet.TypeLib</code> (preferred).<br>2. Timestamp + seeded random suffix fallback.<br>Format: <code>IFRS-YYYYMMDDhhmmss-&lt;suffix&gt;</code>. IDs are safe to log and truncate. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Telemetry emission</strong><br><code>SafeEmitTelemetryEvent</code> constructs a minimal JSON payload describing the event and attempts to delegate emission to <code>modAudit.EmitTelemetry</code>. If unavailable or failing, the payload is persisted locally using <code>AppendLocalAudit</code>. Telemetry paths are fully guarded and never throw. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Dynamic invocation & retries</strong><br>The module includes hardened wrappers (<code>SafeApplicationRun</code>, <code>SafeHasProcedure</code>) around <code>Application.Run</code>. These normalize failures into error variants and support optional retries via <code>RetryOperationByName</code>, including delay handling. This allows resilient orchestration of optional subsystems without compile-time dependencies. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Timing & sleep behavior</strong><br><code>SleepMs</code> prefers the native Windows <code>Sleep</code> API when available and safely falls back to a <code>DoEvents</code>-based loop otherwise. All sleep operations are guarded to avoid blocking the Excel host or raising runtime errors. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Configuration integration</strong><br>Configuration values are retrieved dynamically from <code>modConfig</code> when present. Missing or failing configuration lookups revert to explicit defaults. This allows <code>modError</code> to function correctly during early startup, degraded modes, or isolated testing. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Install-time self-check</strong><br><code>InstallTimeSelfCheck</code> validates the presence of critical optional dependencies (<code>modAudit</code>, <code>modConfig</code>) during startup. Results are written to the local audit. This enables operators and CI pipelines to detect incomplete deployments early without blocking execution. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Test harness</strong><br><code>RunModErrorSelfTests</code> executes a deterministic suite of at least ten checks covering catalog initialization, correlation ID uniqueness, redaction correctness, audit persistence, retry behavior, checksum determinism, and dependency probing. Results are written to <code>_IFRS_TestResults</code>, a very hidden worksheet suitable for CI artifact extraction. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Operational usage guidelines</strong><br>• Call <code>InstallTimeSelfCheck</code> during add-in bootstrap.<br>• Use structured audit appends for all handled errors.<br>• Use simple audit appends only for fallback or bootstrap scenarios.<br>• Prefer <code>modAudit</code> for long-term, signed, or chained audit retention.<br>• Periodically review catalog entries and redaction patterns. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Failure modes & guarantees</strong><br>No public procedure in <code>modError</code> intentionally propagates runtime errors. All diagnostics paths are guarded with <code>On Error Resume Next</code> and safe fallbacks. Failure to log, redact, emit telemetry, or read configuration must never prevent the primary business logic from completing or failing deterministically. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Limitations</strong><br>• CRC32 is not a security mechanism.<br>• Local audit is not append-only tamper-proof.<br>• Redaction is heuristic-based and must be reviewed periodically.<br>• Dynamic invocation cannot validate procedure signatures.<br>These limitations are addressed by integrating <code>modAudit</code> where higher assurance is required. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Maintenance & evolution</strong><br>Any change to schema, redaction behavior, or catalog defaults must be versioned, documented, and accompanied by updated self-tests. Backward compatibility with existing callers and historical audit rows is a hard requirement. </td></tr></tbody></table></div><div class="row-count">Rows: 24</div></div><div class="table-caption" id="Table8" data-table="Docu_0158_08" style="margin-top:2mm;margin-left:3mm;"><strong>Table 8</strong></div>
<div class="table-wrapper" data-table-id="table-8"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modExport"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modExport</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modExport"> <strong>Overview</strong><br><code>modExport</code> provides hardened, backward-compatible export and packaging utilities for the IFRS add-in: PDF, CSV (streaming), XLSX, CustomXML, ZIP packaging, audit integration, atomic IO fallbacks, retries/backoff, security allowlists, PII-aware redaction hooks, job-integration stubs, and self-tests. Designed for reliability on both Windows and macOS with defensive fallbacks when host helpers are missing. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Public API (preserved signatures)</strong><br><code>ExportToPDF(Optional fileName, Optional targetWb)</code> — legacy; raises on failure.<br><code>ExportToPDFEx(Optional fileName, Optional targetWb) As Boolean</code> — new boolean wrapper.<br><code>ExportWorksheetToCsv(Optional targetWb, Optional sheetName, Optional fullPath) As Boolean</code>.<br><code>ExportWorkbookAsXlsx(Optional targetWb, Optional fullPath) As Boolean</code>.<br><code>ExportCustomXMLPart(rootElement, fullPath) As Boolean</code>.<br><code>CreateZipFromFiles(files As Collection, zipPath) As Boolean</code>.<br><code>ExportPackage(Optional filesToInclude As Collection, Optional zipPath) As Boolean</code>.<br><code>ExportAuditToCSV(fullPath) As Boolean</code>.<br><code>ExportSelfTest() As Boolean</code> / <code>Export_RunUnitTests() As Boolean</code>.<br><code>Export_MigrateLegacyConfig()</code> / <code>Export_PrepareForRelease()</code> (maintenance). </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Error model & codes</strong><br>Dedicated error base <code>EXPORT_ERR_BASE = 2100</code>. Mapped codes for common failures: <code>2100=NO_WORKBOOK</code>, <code>2101=DEST_NOT_WRITABLE</code>, <code>2102=SHEET_NOT_FOUND</code>, <code>2103=PDF_NO_FILE</code>, <code>2104=SHEET_NO_USED_RANGE</code>, <code>2110=SAVE_XLSX_FAIL</code>, <code>2200+ = CUSTOM XML</code>, <code>2302+ = ZIP</code>. Legacy <code>ExportToPDF</code> raises <code>vbObjectError + EXPORT_ERR_LEGACY_RAISE</code> to preserve earlier behavior; new functions return Boolean and log errors via <code>LocalHandleError</code>. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Security & allowlist model</strong><br>Primary hook: <code>Security_AllowExportPath_Check(fullPath)</code> tries <code>modSecurity.Security_AllowExportToPath</code> then falls back to config key <code>IFRS.Export.AllowRoots</code>. Additional verification via <code>Security_VerifyExportPathWritable</code>. Default: allow if no explicit roots configured (safe fallback). Always call these before writing. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Atomic IO philosophy & fallbacks</strong><br>Prefer external/centralized helpers (<code>AtomicWriteFile</code>, <code>AtomicSaveWorkbookAs</code>) via <code>SafeApplicationRun</code>. If unavailable use local fallbacks: write to temp file then <code>Name</code> (fast same-volume move) or <code>CopyFile</code> fallback. Write helpers: <code>TryAtomicWriteFileWithEncoding</code>, <code>TryAtomicWriteFileWithVerification</code>, <code>TryAtomicSaveWorkbookAsWithVerification</code>. Retries/backoff implemented for transient errors (configurable attempts). </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>ExportToPDF behavior</strong><br>Writes PDF to temp path (<code>ifrs_pdf_temp_...</code>) then atomically move to final location; retries up to 3 attempts with exponential backoff. Performs security allowlist and folder-writable checks before starting. Produces job events (enqueue/update) if job subsystem present. Legacy <code>ExportToPDF</code> raises on failure; <code>ExportToPDFEx</code> returns Boolean and logs via <code>SafeLogAuditWithMeta</code>. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Workbook (.xlsx) export</strong><br><code>ExportWorkbookAsXlsx</code> uses <code>TryAtomicSaveWorkbookAsWithVerification</code> — attempted via centralized helper then <code>SaveCopyAs</code>→copy fallback. Honors <code>IFRS.Export.OverwriteBehavior</code> (<code>overwrite | fail | version</code>). Verifies file exists and non-zero size before success. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>CSV export: streaming, RFC4180, UTF-8</strong><br>Primary writer: <code>TryExportRangeToCsvWithOptions</code> → centralized <code>ExportRangeToCsv</code> if available; fallback <code>WriteRangeToCsvFallbackWithEncoding</code>.<br>Features: streaming via <code>ADODB.Stream</code> when available, UTF-8 BOM optional (<code>IFRS.Export.UTF8BOM</code>, default True), buffered flush (<code>IFRS.Export.MaxRowsBuffered</code>, default 1000, capped 10000), RFC4180 quoting, CRLF line breaks, embedded-newline preservation, numeric decimal normalization to '.', periodic job progress updates and cancellation probes. Writes atomically via temp file move. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Custom XML export</strong><br><code>ExportCustomXMLPart(rootElement, fullPath)</code> reads via <code>TryReadCustomXMLPart</code> (central helper or fallback scanning <code>ThisWorkbook.CustomXMLParts</code>), applies conservative policy check <code>CheckCustomXmlPolicy</code> (calls <code>modSecurity_CheckCustomXmlExport</code> if present; default denies when "password" or "secret" present), inserts non-invasive header comment with correlation id, and writes atomically (UTF-8 preferred). </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>ZIP creation (cross-platform)</strong><br><code>CreateZipFromFiles</code> bootstraps an empty PKZIP file then adds files: macOS via <code>zip -j -q</code> (MacScript), Windows via <code>Shell.Application</code> folder <code>CopyHere</code> with <code>WaitForZipStable</code> heuristic. Validates existence and non-zero size. Errors: <code>ZIP_CREATE_FAIL</code>, <code>ZIP_EMPTY</code>, <code>ZIP_NO_FILES</code>. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Hashing / signatures</strong><br>Module does not create external signatures; it writes correlation ids into headers. If signing required, integrate a CI step to sign exported artifacts (release preflight hints provided). </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Audit integration & redaction</strong><br>All public exports call <code>SafeLogAuditWithMeta</code> on success/failure. <code>SafeLogAuditWithMeta</code> attempts centralized <code>LogAudit</code> then falls back to local temp audit log. It probes <code>modSecurity</code> and <code>audit_redact_pii</code> config to decide redaction; uses <code>PII_Detect</code> and <code>RedactSecrets</code> fallbacks for sensitive data. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Job integration</strong><br>Best-effort job hooks: <code>EnqueueExportJob</code> and <code>UpdateExportJobState</code> call <code>modRibbonCallbacks</code> or <code>modJobs</code>; fallback to logging and generating correlation id job tokens. Export APIs attempt to enqueue and update job state (queued → running → completed/failed). </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Config keys (documented)</strong><br><code>IFRS.Export.AllowRoots</code> — allowed path prefixes (Array).<br><code>IFRS.Export.UTF8BOM</code> — Boolean, default True.<br><code>IFRS.Export.MaxRowsBuffered</code> — Long, default 1000.<br><code>IFRS.Export.OverwriteBehavior</code> — <code>&quot;overwrite&quot; | &quot;fail&quot; | &quot;version&quot;</code>, default <code>&quot;overwrite&quot;</code>.<br><code>IFRS.Export.DefaultFolder</code> — String, optional default folder.<br><code>IFRS.Export.StreamingEnabled</code> — Boolean, default True.<br><code>audit_redact_pii</code>— Boolean, default False. Use<code>SafeConfigGet</code>and<code>InvalidateConfigCache</code>. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>PII detection & redaction hooks</strong><br><code>PII_Detect(s)</code> delegates to <code>modSecurity.PII_Detect</code> when available; fallback heuristics (email token, long-digit runs, keywords). <code>RedactSecrets(s)</code> delegates to <code>modSecurity.RedactSecrets</code> if present; fallback coarse redaction for emails, secret/password tokens, long digit runs. Use <code>SafeLogAuditWithMeta</code> to avoid leaking secrets. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Self-tests & CI usage</strong><br><code>ExportSelfTest()</code> performs deterministic small CSV, XLSX save, and ZIP creation in <code>_IFRS_TestResults</code> to verify runtime helpers. <code>Export_RunUnitTests()</code> wraps <code>ExportSelfTest</code> and lightweight checks (config retrieval, <code>GenerateCorrelationID</code>). <code>Export_PrepareForRelease()</code> runs utilities and security self-tests and <code>ExportSelfTest</code>. Use these in CI pre-release. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Migration helper</strong><br><code>Export_MigrateLegacyConfig()</code> maps legacy <code>Export.AllowRoots</code> → <code>IFRS.Export.AllowRoots</code> non-destructively if central <code>modConfig_Set</code> is available; logs migration events. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Diagnostics & logging</strong><br>All fallback events emit audit entries (e.g., <code>FlushFallback</code>, <code>RotateFallback</code>, <code>ExportAuditError</code>, <code>Zip warnings</code>). Temporary artifacts and intermediate attempts are removed where possible; <code>SafeLogAudit</code> writes local temp log when central audit not available. Use <code>SafeConfigGet</code> and meta logs for troubleshooting. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Failure handling & retries</strong><br>Transient IO and network errors use retries with exponential backoff for PDF, XLSX save, atomic writes, and zip operations. Fallback paths attempt safer per-row writes, SaveCopyAs, or CRC heuristics. Persistent failures call <code>LocalHandleError</code> which tries centralized <code>HandleError</code>, otherwise logs and raises a module-specific legacy error to maintain compatibility. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Platform-specific notes</strong><br>Windows: prefers <code>certutil</code>/shell <code>Shell.Application</code> zip; uses <code>Name</code> for fast file moves. macOS: <code>MacScript</code> to call <code>zip</code> in shell. ADODB.Stream used where available for UTF-8 and streaming. <code>IsMacOS()</code> relies on <code>Application.OperatingSystem</code>. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Best practices for integrators</strong><br>• Enable <code>modSecurity</code> hooks (PII detection/redaction, path verification) for safer deployment.<br>• Set <code>IFRS.Export.AllowRoots</code> to explicit repository/archive paths; avoid default-allow in sensitive environments.<br>• Run <code>Export_PrepareForRelease()</code> in CI and sign exported archives outside Excel.<br>• Run <code>ExportSelfTest</code> after installation/upgrade and after environment changes (network shares, AV rules).<br>• Disable <code>g_allowCommandExecution</code> equivalents in host security policy when external command invocation is unacceptable. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Troubleshooting checklist</strong><br>1. <code>PDF_NO_FILE</code> after ExportToPDF: check <code>TEMP</code>, file permission, <code>Name</code> move cross-volume failure; inspect temp file presence and audit warnings.<br>2. XLSX save failures: check <code>OverwriteBehavior</code>, network share locks, and run <code>Export_RunUnitTests</code> to get deterministic failures.<br>3. CSV encoding/characters wrong: verify <code>IFRS.Export.UTF8BOM</code> and ADODB availability; check decimal separator fallback.<br>4. ZIP empty or not stable: check <code>ExecShellZipOn*</code> availability, file path quoting, and <code>WaitForZipStable</code> timeouts.<br>5. Audit not recording: validate central <code>LogAudit</code> availability or inspect local <code>ifrs_local_audit.log</code>. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Limitations & security cautions</strong><br>• External command execution and macro-based atomic helpers are only used when present — enable only in trusted environments.<br>• Module does not perform cryptographic signing of artifacts; integrate signing in CI/release pipeline.<br>• Heuristic PII detection is not exhaustive — rely on centralized <code>modSecurity</code> where required.<br>• Cross-volume atomic moves rely on copy/delete fallback which is not instantaneous; handle race conditions in orchestration. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Examples & typical flows</strong><br>PDF export: validate path → enqueue job → export to <code>ifrs_pdf_temp_...</code> → atomic move (Name/CopyFile) → verify file exists → <code>SafeLogAuditWithMeta</code> → update job state.<br>CSV export (large sheet): determine streaming mode → stream rows in buffered chunks to temp → save temp → atomic move → progress updates via jobId → final audit entry. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Notes for maintainers</strong><br>• Centralized helpers are invoked via <code>SafeApplicationRun</code> to allow host-wide overrides; adding/patching <code>modUtilities</code>, <code>modConfig</code>, or <code>modSecurity</code> will improve robustness.<br>• Keep the public API signatures unchanged to preserve add-in compatibility.<br>• When adding features, follow existing pattern: prefer centralized helper → guarded call → local fallback → audit the fallback event. </td></tr></tbody></table></div><div class="row-count">Rows: 25</div></div><div class="table-caption" id="Table9" data-table="Docu_0158_09" style="margin-top:2mm;margin-left:3mm;"><strong>Table 9</strong></div>
<div class="table-wrapper" data-table-id="table-9"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modIAS36"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modIAS36</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modIAS36"> <strong>Overview</strong><br>Hardening of IAS 36 impairment framework implemented for Excel/VBA. Provides deterministic, defensive DCF/NPV primitives, recoverable-amount calculators (VIU / FVLCOD), allocation logic, normalization for diverse forecast shapes, deterministic row hashing for tamper-evidence, self-test and verification harnesses, and safe host-integration hooks (modUtilities/modConfig/modAudit). Preserves existing public signatures and adds non-breaking helper stubs. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Module identity & version</strong><br><code>MODULE_NAME = &quot;modIAS36&quot;</code>; <code>MODULE_VERSION = &quot;2025.12.26-Rev5&quot;</code> (Rev5 contains robustness patches: atomic-write stubs, 10× final verification loop, batch-write self-test persistence, improved forwarding guards, and deterministic snapshot/hash). </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Purpose & guarantees</strong><br>Provide deterministic, auditable impairment calculations with strong defensive error handling (no Err.Raise to UI), best-effort host integration, and tamper-evidence for self-tests. Functions return simple types or <code>Scripting.Dictionary</code> objects; side effects are limited to SafeLogEx (host or Debug.Print) and writing to the <code>_IFRS_TestResults</code> sheet when available. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Public API summary (preserved signatures)</strong><br><code>IAS36_ComputePVOfPayments(payments, discountRate, Optional asOfDate, Optional daycount) As Double</code><br><code>IAS36_CalculateRecoverableByVIU(cashflows, discountRate, Optional asOfDate, Optional daycount) As Double</code><br><code>IAS36_CalculateRecoverableByFVLCOD(fairValue, costsToSell) As Double</code><br><code>IAS36_RecoverableAmount(carryingAmount, Optional cashflows, Optional discountRate, Optional fairValue, Optional costsToSell, Optional asOfDate, Optional daycount) As Object</code><br><code>IAS36_GroupAssetsIntoCGUs(assets, Optional groupingKey) As Object</code><br><code>IAS36_GenerateDCF(forecast, discountRate, Optional asOfDate, Optional daycount) As Variant</code><br><code>IAS36_RunImpairmentTest(cgu, Optional discountRate, Optional fairValue, Optional costsToSell, Optional asOfDate, Optional daycount) As Object</code><br><code>IAS36_RunBatchImpairmentTests(cguList, Optional discountRate, Optional fairValueMap, Optional daycount) As Object</code><br><code>IAS36_GenerateDisclosureSummary(testResult) As Object</code><br><code>IAS36_ValidateInputPackage(pkg) As Object</code><br><code>IAS36_AllocateImpairment(assets, impairment, Optional mode, Optional weights) As Object</code><br><code>IAS36_ExportMetadataSnapshot(pkg) As String</code><br><code>IAS36_RestoreStatementSnapshot(jsonSnapshot) As Object</code><br><code>IAS36_RunSelfTests() Sub</code><br><code>IAS36_RunFinalVerification() As Object</code> (runs self-tests 10× and returns snapshot + <code>SnapshotHash</code>)<br><code>IAS36_RunExtendedSelfTests() As Object</code> / <code>IAS36_RunSanityChecks()</code> / <code>IAS36_RunStaticChecks()</code> / <code>IAS36_ListPublicAPIs()</code> and a few safe no-op hooks (e.g., <code>IAS36_DebouncedRibbonRefresh</code>, <code>IAS36_RegisterLegacyAlias</code>). </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Input shapes & contracts</strong><br>Forecast/payments accepted shapes (flexible): 2-col 1-based arrays <code>(1..n,1..2)</code> where col1=Date (or empty), col2=Amount; Collections of rows (array or dictionary), Dictionaries keyed by 1..n; single numeric interpreted as single payment at <code>asOfDate</code>. Public outputs are simple numeric or <code>Scripting.Dictionary</code> with documented keys (<code>RecoverableAmount</code>, <code>VIU</code>, <code>FVLCOD</code>, <code>ImpairmentLoss</code>, etc.). </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Canonical internal row/serialization behavior</strong><br><code>NormalizeForecastToArray</code> converts inputs to deterministic 1-based (n×2) array, compacts valid rows and bubble-sorts by date (non-dates pushed to end). <code>DictionaryToJson</code>/<code>ArrayToJson</code>/<code>CollectionToJson</code> provide deterministic non-exhaustive serialization used for snapshots. <code>ComputeDeterministicHash</code> is a fast, non-cryptographic 8-hex checksum (FNV-like) used for row/snapshot hashes — <strong>not</strong> a cryptographic signature. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Rounding & daycount</strong><br>Rounding uses <code>GetRoundingPrecision()</code> (cached, tries <code>modConfig.GetSetting(&quot;RoundingPrecision&quot;)</code>) with default <code>2</code>; <code>ApplySafeRound</code> uses VBA <code>Round</code> (banker’s rounding). Daycount default <code>ACT/365</code>; override via <code>GetDayCountConvention()</code> (probes host config <code>IAS36_DefaultDaycount</code>). <code>YearFractionEx</code> implements <code>ACT/365</code>, <code>ACT/360</code>, and <code>30/360</code>. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Hashing & tamper-evidence</strong><br>Module emits deterministic <code>RowHash</code> for self-tests and a JSON <code>Snapshot</code> + <code>SnapshotHash</code> from <code>ComputeDeterministicHash</code>. Use these as tamper-evidence alongside external signing if required. Do <strong>not</strong> treat <code>SnapshotHash</code> as a cryptographic signature. For cryptographic integrity, sign <code>Snapshot</code> externally (CI) and record signature in release manifest. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Logging & error routing</strong><br>All internal logging funnels through <code>SafeLogEx</code> which tries host <code>LogAudit</code> via <code>TryApplicationRun</code> and falls back to <code>Debug.Print</code>. Errors are handled by <code>SafeHandleError</code> / <code>HandleInternalError</code> which attempt host <code>HandleError</code> or <code>modError.HandleError</code> before fallback. Module avoids bubbling runtime errors to the UI. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Host integration & delegation</strong><br><code>TryApplicationRun</code> robustly forwards calls to host macros with ParamArray forwarding and safe defaults. <code>ProbeExternalDependencies</code> sets flags (<code>g_haveModUtilities</code>, <code>g_haveModConfig</code>, <code>g_haveModAudit</code>, <code>g_haveModError</code>, <code>g_haveModSecurity</code>). Use <code>PreferExternalOrLocal</code> and <code>TryUseExternalHelper</code> to prefer host helpers when available. When <code>modUtilities</code> exists, module will attempt to reuse <code>AtomicWriteFile</code>, <code>AtomicSaveWorkbookAs</code>, <code>SafeCreateSheet</code>, etc. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Atomic write & persistence</strong><br><code>TryAtomicWriteFile(filepath, content, overwrite)</code> attempts <code>modUtilities.AtomicWriteFile</code> if present; otherwise writes to a temp file and moves it into place. <code>TryAtomicSaveWorkbookAs</code> prefers <code>modUtilities.AtomicSaveWorkbookAs</code> then falls back to <code>ThisWorkbook.SaveCopyAs</code>. Used by <code>PersistSelfTestResults</code> to write JSON snapshots. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Buffered/batch writes & performance</strong><br>Self-test results and many outputs are written in batch arrays to worksheets (single <code>Range.Value = outArr</code>) to avoid per-row writes. <code>PersistSelfTestResults</code> writes results to <code>_IFRS_TestResults</code> and computes deterministic <code>RowHash</code> per row. Extended self-tests include a performance guard test with 500 rows. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Self-test & final verification</strong><br><code>IAS36_RunSelfTests()</code> performs 10 deterministic checks and persists results to <code>_IFRS_TestResults</code> (with row hashes and JSON snapshot). <code>IAS36_RunFinalVerification()</code> runs the harness ten times, aggregates <code>PassCount</code>/<code>FailCount</code>, builds a <code>Snapshot</code> and <code>SnapshotHash</code> for tamper-evident sign-off; returns dictionary <code>{Status, TestCount, PassCount, FailCount, Timestamp, Snapshot, SnapshotHash}</code>. Use this function in CI or release sign-off. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Allocation algorithm</strong><br><code>AllocateImpairment(assets, impairment, mode, weights)</code> supports <code>PRORATA</code> (default), <code>EQUAL</code>, and <code>WEIGHTED</code>. Deterministic tie-breaking: when cmp values equal, the algorithm favors lexicographically smaller asset IDs. Rounding applied per item; residual adjustment applied to largest (deterministic) or smallest if further correction needed. <code>VerifyAllocationInvariant</code> logs if rounding drift occurs. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Normalization & robustness</strong><br><code>NormalizeForecastToArray</code> and <code>NormalizePaymentsForRead</code> accept diverse input shapes, compact invalid rows, push non-dates to end, and return empty on no valid rows. <code>YearFractionEx</code> clamps negative durations to zero. <code>NPVFromDcfEx</code> handles zero/negative discount gracefully. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Security & operational guidance</strong><br>• Treat <code>_IFRS_TestResults</code> and snapshots as sensitive audit artifacts; restrict workbook access and consider storing signed snapshots externally.<br>• Disable <code>TryUseExternalHelper</code> and <code>g_haveModUtilities</code>-dependent calls in untrusted host environments. Review and approve any <code>modUtilities</code> helper names before enabling. <br>• <code>ComputeDeterministicHash</code> is not cryptographically secure — integrate CI signing for legal attestation. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Dependencies & safe defaults</strong><br>Probes: <code>modUtilities</code>, <code>modConfig</code>, <code>modAudit</code>, <code>modError</code>, <code>modSecurity</code>. All external calls are optional and guarded by <code>TryApplicationRun</code> / <code>PreferExternalOrLocal</code>. If not present, module uses local fallbacks. Default rounding = 2, daycount = <code>ACT/365</code>. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Sheet usage & naming</strong><br>Self-test sheet: <code>_IFRS_TestResults</code> (created or reused, set <code>xlSheetVeryHidden</code> when possible). When writing snapshots, module writes <code>&lt;workbook path&gt;@@ESC_UND@@IFRS_TestResults_snapshot.json</code> via <code>TryAtomicWriteFile</code> if workbook path exists. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Limitations & known behaviors</strong><br>• <code>ComputeDeterministicHash</code> is non-cryptographic (8-hex).<br>• Snapshot/sign-off must be externally signed for legal authenticity.<br>• <code>TryAtomicWriteFile</code> fallback uses <code>Scripting.FileSystemObject</code> and may fail on restricted file systems; callers should check return Boolean.<br>• Host macro signatures vary; <code>TryApplicationRun</code> forwards up to eight ParamArray args — long-arg calls may be truncated. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Troubleshooting checklist</strong><br>1. Self-test failures → open <code>_IFRS_TestResults</code>, compare <code>RowHash</code> and persisted JSON snapshot; run <code>IAS36_RunFinalVerification</code> to collect <code>SnapshotHash</code> and <code>Pass/Fail</code> counts.<br>2. Missing <code>_IFRS_TestResults</code> → check <code>SafeCreateSheet</code> host helper availability and workbook protection; view <code>Debug.Print</code> for fallbacks.<br>3. <code>TryAtomicWriteFile</code> returned False → check folder ACLs, TEMP path, and <code>modUtilities</code> availability; check <code>Debug.Print</code>/<code>SafeLogEx</code> entries.<br>4. Unexpected hash in snapshot → remember hash is deterministic non-crypto; verify source JSON and re-run sign-off in CI. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Recommended operational practices</strong><br>• Call <code>Module_Initialize</code> implicitly via first public call; call <code>IAS36_RunFinalVerification</code> in CI pipelines as part of release gating.<br>• Keep <code>g_haveModUtilities</code> set only after code review of <code>modUtilities</code> helpers.<br>• Regularly export <code>_IFRS_TestResults_snapshot.json</code> and sign it in CI; store signed artifacts in immutable storage for retention. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Example usage patterns</strong><br>Compute PV: <code>pv = IAS36_ComputePVOfPayments(paymentsArray, 0.05, Date)</code>.<br>Single CGU test: <code>res = IAS36_RunImpairmentTest(cguDict, 0.05, fairValue, costsToSell, Date)</code> then <code>summary = IAS36_GenerateDisclosureSummary(res)</code>.<br>Batch run + sign-off: <code>batch = IAS36_RunBatchImpairmentTests(list, 0.05, fairValueMap)</code> → <code>final = IAS36_RunFinalVerification()</code> → persist <code>final(&quot;Snapshot&quot;)</code> and record <code>final(&quot;SnapshotHash&quot;)</code>. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Extensibility & deduplication guidance</strong><br>Module is intentionally conservative: when <code>modUtilities</code> provides overlapping helpers prefer calling them via <code>TryApplicationRun</code> and remove local duplicates only after coordinated regression testing. Use <code>PreferExternalOrLocal</code> to evolve integration incrementally. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>File & naming conventions</strong><br>Test results sheet <code>_IFRS_TestResults</code>; JSON snapshot <code>&lt;WorkbookPath&gt;@@ESC_UND@@IFRS_TestResults_snapshot.json</code>; temp fallback files use deterministic <code>ComputeDeterministicHash(Format(Now,...))</code> naming to reduce collisions. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Contact points for integration</strong><br>Hooks to review/extend: <code>TryApplicationRun</code>, <code>TryAtomicWriteFile</code>, <code>TryAtomicSaveWorkbookAs</code>, <code>TryUseExternalHelper</code>, <code>ProbeExternalDependencies</code>. Audit/log events are emitted via <code>SafeLogEx</code> with correlation IDs from <code>GenerateCorrelationID()</code>. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Acceptance criteria (for upgrades / code review)</strong><br>1. Public signatures unchanged for preserved functions.<br>2. Self-tests (<code>IAS36_RunSelfTests</code>) pass locally; <code>IAS36_RunFinalVerification</code> returns <code>PassCount = 10</code> in ideal host environment.<br>3. <code>_IFRS_TestResults</code> created and contains <code>RowHash</code> values; snapshot JSON present and <code>TryAtomicWriteFile</code> succeeded or logged fallback. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Appendix — quick reference of notable internals</strong><br><code>NormalizeForecastToArray</code>, <code>NormalizePaymentsForRead</code>, <code>YearFractionEx</code>, <code>NPVFromDcfEx</code>, <code>AllocateImpairment</code>, <code>ApplySafeRound</code>/<code>Round2</code>, <code>ComputeDeterministicHash</code>, <code>TryAtomicWriteFile</code>, <code>TryAtomicSaveWorkbookAs</code>, <code>PersistSelfTestResults</code>, <code>IAS36_RunFinalVerification</code>. </td></tr></tbody></table></div><div class="row-count">Rows: 27</div></div><div class="table-caption" id="Table10" data-table="Docu_0158_10" style="margin-top:2mm;margin-left:3mm;"><strong>Table 10</strong></div>
<div class="table-wrapper" data-table-id="table-10"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modIFRS15"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modIFRS15</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Overview</strong><br>IFRS 15 contract model implemented in VBA: deterministic allocation of transaction price to performance obligations, recognition schedule generation, deterministic rounding/residual rules, PV computation for payments, variable-consideration handling, batch processing hooks, reconciliation helpers, local test harness, and integrated logging/audit forwarding. Designed for defensiveness and backward compatibility (preserved public signatures). </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Public API (preserved signatures & short purpose)</strong><br><code>IFRS15_AnalyzeContract(contract) As Object</code> — build analysis (POs, totals, placeholders).<br><code>IFRS15_AllocateTransactionPrice(analysis, Optional applyVariableConsideration As Boolean=True, Optional variableConstraintThreshold As Double=0.25) As Object</code> — deterministic allocation, reserve for variable consideration.<br><code>IFRS15_GenerateRecognitionSchedule(analysis, Optional periods As Long=12, Optional startDate As Variant=Null) As Variant</code> — produce recognition schedule (2D array).<br><code>IFRS15_GenerateJournalEntries(recognitionSchedule, revenueAccount, contraAccount) As Variant</code> — convert schedule to journal lines.<br><code>IFRS15_GenerateDisclosures(analysis) As Object</code> — disclosures structure (unsatisfied POs, totals, judgments).<br><code>IFRS15_ValidateContract(contract) As Object</code> — returns issues dictionary.<br><code>IFRS15_BatchProcessContracts(contracts) As Object</code> — deterministic batch processing → schedules map.<br><code>ComputePVofPayments(payments, discountRate, baseDate, Optional dayCountConvention=&quot;&quot;, Optional applyRounding=True) As Double</code> — PV using cached day-count default.<br><code>GenerateCorrelationID()</code>, <code>ExtractCorrelationFromVariant(v)</code>, <code>GetDayCountConvention()</code>, <code>IsLegacyMode()</code>, <code>InvalidateIFRS15ConfigCache()</code> — helpers and config accessors. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Canonical row/structures used by module</strong><br>Analysis object (Scripting.Dictionary) keys: <code>PerformanceObligations</code> (Collection of dicts), <code>TotalStandalone</code>, <code>TransactionPrice</code>, <code>ContractID</code>, <code>ContractDate</code> (optional), <code>Allocation</code> (Dictionary), <code>ReserveForVariable</code>, <code>AllocatedTotal</code>, <code>JudgmentsApplied</code> (Collection).<br>Recognition schedule output: 2D array rows with columns <code>(ContractID, POID, PeriodIndex, Date, Amount, RecognitionMethod)</code>.<br>Journal rows: <code>(Date, DebitAcct, DebitAmt, CreditAcct, CreditAmt, Memo)</code>. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Determinism & rounding rules</strong><br>• Deterministic allocation: shares computed by standalone price proportion; if <code>TotalStandalone</code> <= 0 then equal share.<br>• Rounding via <code>ApplySafeRound</code> and centralized <code>MonetaryBoundaryRound</code> which uses <code>GetRoundingPrecision()</code> (cached).<br>• Residuals handled deterministically: absorb into performance obligation with largest <code>StandalonePrice</code> (ties → lowest index).<br>• Final equality enforced: <code>Rounded(AllocatedTotal) + Rounded(Reserve) == Rounded(TransactionPrice)</code>; deterministic correction applied to allocation or reserve. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Variable consideration handling</strong><br>• <code>IFRS15_AllocateTransactionPrice</code> supports scalar expected values, structured <code>vco</code> objects with <code>Method</code> (e.g., <code>mostlikely</code>) or <code>Scenarios</code> (Probability/Amount), or arrays of scenarios; deterministic expected value calculation and recording via <code>AddJudgment</code>.<br>• Threshold controlled by <code>variableConstraintThreshold</code> param or config key <code>variableConstraintThreshold</code> (config override via <code>GetConfigDouble</code>).<br>• Reserves recorded in <code>ReserveForVariable</code> and rounded per module rounding rules. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Recognition schedule behavior</strong><br>• <code>time</code> method: amount split evenly across <code>periods</code>; per-period rounding applied; residual placed deterministically in final period.<br>• <code>point</code> method: uses <code>DeliveryDate</code> if present and valid; otherwise falls back to <code>startDate</code> and emits a judgment entry.<br>• Guardrails: <code>periods</code> clamped to <code>[1,10000]</code> and associated judgments emitted for clamping. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>PV & payments handling</strong><br>• <code>ComputePVofPayments</code> normalizes payments via <code>NormalizePaymentsForRead</code> (module expects normalized shape), uses <code>GetDayCountConvention()</code> cached value if <code>dayCountConvention</code> omitted.<br>• Supports discount method config <code>IFRS15_DiscountMethod</code> (<code>CONTINUOUS</code> or periodic default).<br>• Year-fraction calculation supported by <code>YearFraction</code> (<code>ACT/365</code>, <code>ACT/360</code>, <code>30/360(NASD)</code>); small negative fractions normalized to zero. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Configuration & cache</strong><br>Cached config structure <code>mCfg</code> holds <code>roundingPrecision</code>, <code>variableConstraintThreshold</code>, <code>versionKey</code>, <code>dayCountConvention</code>, <code>legacyMode</code>.<br>Initialization via <code>InitializeConfigCache</code> reads config through <code>TryApplicationRun</code> wrappers (<code>modConfig_Get</code>, <code>Config_Get</code>, <code>GetConfigValue</code>).<br>Invalidate with <code>InvalidateIFRS15ConfigCache()</code>; migration helper <code>EnsureModuleVersionRegistered()</code> attempts to set <code>IFRS15_ModuleVersion</code>. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Feature flags / config keys</strong><br>Notable keys: <code>roundingPrecision</code>, <code>variableConstraintThreshold</code>, <code>IFRS15_ModuleVersion</code>, <code>IFRS15_DayCountConvention</code>, <code>IFRS15_LegacyMode</code>, <code>IFRS15_RevenueAccount</code>, <code>IFRS15_ContraAccount</code>, <code>IFRS15_DiscountMethod</code>.<br><code>IsLegacyMode()</code> accessor reads cached <code>legacyMode</code>. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Integration & external hooks (safe-by-default)</strong><br>• Logging/error forwarding uses <code>SafeLogEx</code> and <code>SafeHandleError</code> which prefer <code>modAudit.LogEvent</code> and <code>modError.HandleError</code> but fall back to local <code>AppendLocalAudit</code> and <code>AppendLocalIssueAudit</code> if not present.<br>• <code>TryApplicationRun</code> and <code>SafeApplicationRun</code> provide guarded <code>Application.Run</code> invocation (supports up to 10 args).<br>• <code>IsProcedureAvailable</code> uses a non-invasive whitelist and avoids running unknown procedures. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Sheets, job hooks & test harness</strong><br>• <code>_IFRS_Audit</code> (very-hidden) via <code>EnsureAuditSheetExists</code> for local lightweight audit rows.<br>• <code>_IFRS_TestResults</code> for test harness via <code>EnsureTestSheetExists</code> and <code>AppendTestResults</code>.<br>• <code>_IFRS_Jobs</code> to register background jobs via <code>EnqueueOrUpdateJob</code> (returns JobID) — scheduling left as a hook for ribbon/bootstrapping modules. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Sorting & collections</strong><br>• <code>BuildMaturityAnalysis</code> aggregates buckets by Year/Month and sorts keys using <code>QuickSortVariant</code> (deterministic quicksort replacement for prior O(N^2) sort).<br>• Defensive array helpers: <code>LBoundArraySafe</code>, <code>UBoundArraySafe</code>, <code>CountArrayElements</code>, <code>SafeArrayIndex</code>, <code>ArrayDimensions</code>. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Testing & diagnostics</strong><br>• Module contains self-test harness that writes to <code>_IFRS_TestResults</code> and emits <code>SelfTestCompleted</code> audit/log entry (see changelog).<br>• <code>AppendTestResults</code> stores timestamped summary and notes. Use these artifacts for CI/QA validation. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Error handling & fallbacks</strong><br>• Code is defensive: <code>On Error Resume Next</code> used broadly with <code>SafeHandleError</code> to attempt centralized handling (<code>modError.HandleError</code>) before falling back to local audit.<br>• Safe file writing uses <code>SafeExportCsv</code> (prefers <code>modUtilities.AtomicWriteCsv</code>); falls back to simple write and logs failures. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Security & operational guidance</strong><br>• Restrict use of <code>Application.Run</code> hooks and review any <code>HashProviderMacroName</code> or external macros; <code>IsProcedureAvailable</code> avoids side-effects by design.<br>• Prefer disabling or code-reviewing any external-proc hooks in untrusted deployments.<br>• Protect hidden sheets (<code>xlSheetVeryHidden</code>) and archived CSV output locations; follow least privilege rules for filesystem writes. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Migration & versioning</strong><br>• Module writes/reads <code>IFRS15_ModuleVersion</code> config key; <code>EnsureModuleVersionRegistered</code> will attempt to set it via available config-set hooks. Document module version in release notes and run <code>InvalidateIFRS15ConfigCache</code> after upgrade to refresh behavior. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Runbook / monitoring recommendations</strong><br>• Run self-test on install/upgrade and assert <code>SelfTestCompleted</code> audit entry present.<br>• Validate <code>Verify</code> steps: run recognition schedule sample contracts in CI and compare deterministic outputs (store known-good fixtures).<br>• Monitor <code>_IFRS_Audit</code> and <code>_IFRS_TestResults</code> for unexpected errors or missing self-test completion. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Troubleshooting checklist</strong><br>1. Unexpected allocation totals: check <code>roundingPrecision</code> config and <code>ReserveForVariable</code>; run self-test and compare <code>AllocatedTotal</code> vs <code>TransactionPrice</code>.<br>2. Missing external behavior (modConfig/modUtilities): verify <code>IsProcedureAvailable</code> calls and ensure expected helper modules are installed; module will fall back to safe defaults but emit judgments/audit entries.<br>3. PV mismatches: confirm <code>IFRS15_DayCountConvention</code>, <code>IFRS15_DiscountMethod</code>, and <code>ComputePVofPayments</code> base date.<br>4. Job not running: <code>_IFRS_Jobs</code> is only a registration hook — external scheduler (modBootstrap or Excel <code>OnTime</code>) required to invoke job procs. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Examples / usage patterns</strong><br>Batch process flow (recommended): <code>Init</code> context → <code>IFRS15_BatchProcessContracts(contracts)</code> → for each contract store schedule and call <code>IFRS15_GenerateJournalEntries</code> → persist or export via <code>SafeExportCsv</code> → run <code>Verify</code> tests and flush test results.<br>Typical single contract flow: call <code>IFRS15_AnalyzeContract</code> → <code>IFRS15_AllocateTransactionPrice</code> → <code>IFRS15_GenerateRecognitionSchedule</code> → optionally <code>IFRS15_GenerateJournalEntries</code> and <code>IFRS15_GenerateDisclosures</code>. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Limitations & notes</strong><br>• No built-in cryptographic signature of outputs (integrate with modAudit/CI signing if required).<br>• Deterministic tie-breakers rely on <code>StandalonePrice</code> ordering — if that field is not meaningful, define stable PO identifiers to control deterministic outcomes.<br>• Module uses VBA date/time and system <code>Now</code> for timestamps in judgments/test results — consider UTC normalization in integrated systems. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Maintenance tasks for integrators</strong><br>• Review and approve all external <code>Application.Run</code> hook names used by your environment.<br>• Set config keys (<code>IFRS15_DayCountConvention</code>, <code>roundingPrecision</code>, <code>IFRS15_RevenueAccount</code>, <code>IFRS15_ContraAccount</code>, <code>IFRS15_DiscountMethod</code>) via your config provider.<br>• Include module self-test in CI and require <code>SelfTestCompleted</code> audit emission as part of release gating. </td></tr></tbody></table></div><div class="row-count">Rows: 21</div></div><div class="table-caption" id="Table11" data-table="Docu_0158_11" style="margin-top:2mm;margin-left:3mm;"><strong>Table 11</strong></div>
<div class="table-wrapper" data-table-id="table-11"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modIFRS16"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modIFRS16</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Overview</strong><br>IFRS16 lease measurement library for Excel/VBA. Provides deterministic initial measurement, schedule generation, re-calculation on modification, journal entry generation, disclosure helpers, batch processing and a self-test suite. Hardening applied (module version <code>1.13.0</code>, <code>Checked10x</code> tag). Preserves existing public function signatures. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Module identity</strong><br><code>MODULE_VERSION = &quot;1.13.0&quot;</code>; <code>MODULE_CHECKED10X_TAG = &quot;Checked10x&quot;</code>. Consumers should include <code>ModuleVersion</code> and <code>CorrelationId</code> in outputs for traceability. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Public API (preserved signatures)</strong><br><code>IFRS16_InitialMeasurement(payments, discountRate, commencementDate, Optional initialDirectCosts, leaseIncentives, restorationCosts, asOfDate)</code> → Dictionary with <code>LeaseLiability</code>, <code>ROUAsset</code>, inputs and metadata.<br><code>IFRS16_GenerateSchedule(payments, initialLiability, discountRate, leaseTermPeriods, Optional periodDates, rouOpening, rouUsefulPeriods)</code> → 2D array (period rows + header).<br><code>IFRS16_RecalculateLiabilityOnModification(payments, oldLiability, newDiscountRate, asOfDate)</code> → Dictionary with <code>OldLiability</code>, <code>NewLiability</code>, <code>Delta</code>.<br><code>IFRS16_GenerateJournalEntries(schedule, liabilityAccount, rouAccount, interestAccount, depreciationAccount)</code> → 2D array of journal lines.<br><code>IFRS16_GenerateDisclosure(schedule)</code> → Dictionary with totals and <code>MaturityAnalysis</code>.<br><code>IFRS16_ValidateLeaseInput(payments, commencementDate, discountRate)</code> → Dictionary of validation issues.<br><code>IFRS16_BatchComputeLeases(leases)</code> → Dictionary keyed per-lease of InitialMeasurement results.<br><code>IFRS16SelfTest()</code> → Boolean; writes <code>_IFRS_TestResults</code> sheet and appends local audit entry. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Supported payment input shapes</strong><br>Robust normalizer supports: 2-D arrays (rows × columns), 1-D arrays of inner arrays, VBA <code>Collection</code>, <code>Scripting.Dictionary</code> with <code>Items</code>/<code>Payments</code> key, and arrays of simple numeric values. Returns normalized 2-column array <code>[(Date/Empty),(Amount)]</code>. Unsupported shapes return <code>Empty</code> (legacy behaviour) and populate <code>m_lastNormalizeReport</code>. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Normalizer modes and shims</strong><br>Config key <code>IFRS16.NormalizerMode</code> (<code>&quot;legacy&quot;</code> or <code>&quot;improved&quot;</code>). Default <code>&quot;improved&quot;</code>. If available, external shim <code>modUtilities.NormalizePaymentsForRead</code> is preferred. If shim missing or legacy mode forced, internal normalizer runs and records diagnostics in <code>m_lastNormalizeReport</code> (accessible via private <code>GetLastNormalizeReport</code>). </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Normalization diagnostics</strong><br><code>m_lastNormalizeReport</code> (private) populated with <code>Error</code>, <code>Detail</code>, <code>CorrelationId</code>, <code>Timestamp</code> when normalization fails or input ambiguous. Normalizer returns diagnostics when <code>returnDiagnostics=True</code> (internal usage only). </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Payment indexing helpers</strong><br><code>GetPaymentCountFromNormalized</code>, <code>GetPaymentAmountFromNormalized</code>, <code>GetPaymentDateFromNormalized</code> attempt to call <code>modUtilities</code> equivalents first; fallback uses safe bounds checks with <code>SafeArrayIndex</code>. Out-of-range accesses return zero/empty and emit <code>AppendLocalAudit</code> diagnostics. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Correlation handling</strong><br><code>ExtractCorrelationFromVariant</code> scans input containers (objects, arrays, first elements up to 5 items) for a <code>CorrelationId</code> key to propagate correlation across API calls and logs. If none found the module generates <code>GenerateCorrelationID()</code> values. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Financial models & rules</strong><br>• Present value (<code>ComputePVofPayments</code>) discounts using fractional years from <code>asOfDate</code> to payment date.<br>• If <code>discountRate &lt;= 0</code> PV = sum(payments).<br>• <code>IFRS16_GenerateSchedule</code> supports both legacy interest accrual (reference to first payment date) and corrected period-to-period accrual. Controlled by config flag <code>IFRS16.LegacyInterestMode</code> (boolean).<br>• Principal floored at 0 (negative principal protection).<br>• Depreciation: time-proportional across <code>rouUsefulPeriods</code> (supports partial periods).<br>• ROU depreciation allocation uses simple per-period fraction (legacy deterministic approach). </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Day count conventions</strong><br>Config key <code>IFRS.DayCount</code> cached; defaults <code>ACT/365</code>. Supported: <code>ACT/365</code> (default), <code>ACT/360</code>, <code>30/360</code> implemented as US/NASD (cap day 31 → 30). <code>YearFraction(d0,d1)</code> returns normalized non-negative fractional years. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Rounding & precision</strong><br><code>GetRoundingPrecision</code> reads <code>IFRS.RoundingPrecision</code> (cached); default <code>2</code>. <code>ApplySafeRound</code> prefers <code>modUtilities.Round</code> shim; falls back to <code>VBA.Round</code>. Very small residuals near rounding precision are set to zero for stability. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Batch limits & safety</strong><br><code>MAX_BATCH_SIZE = 10000</code>. <code>IFRS16_BatchComputeLeases</code> enforces this limit and returns an empty results set and audit log on oversize requests to avoid resource exhaustion. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Self-test suite</strong><br><code>IFRS16SelfTest</code> runs multiple fixtures (2D arrays, 1D irregular arrays, Collections, Dictionaries, leap-year, zero discount, negative principal protection, period-to-period interest checks). Results appended to <code>_IFRS_TestResults</code> sheet (very hidden) and attempts to report to <code>modTests</code> shims. Emits an <code>AppendLocalAudit</code> marker including <code>MODULE_CHECKED10X_TAG</code>. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Sheets used</strong><br><code>_IFRS_TestResults</code> — very hidden sheet with columns <code>Timestamp, CorrelationId, TestKey, Result</code> where self-test results are appended.<br><code>_IFRS_Audit</code> — module may append minimal audit rows via <code>AppendLocalAudit</code> when external modAudit unavailable; columns <code>Timestamp, User, Message</code>. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Logging / error handling strategy</strong><br>Prefer external shims: <code>modAudit.LogEvent</code> (via <code>SafeLogEx</code>) and <code>modError.HandleError</code> (via <code>SafeHandleError</code>). When shims missing module emits local hidden-sheet audit via <code>AppendLocalAudit</code>. All public functions wrap code in <code>On Error</code> handlers and call <code>SafeHandleError</code> on unhandled exceptions. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>TryApplicationRun shim</strong><br><code>TryApplicationRun(procName, outVal, ParamArray args())</code> attempts <code>Application.Run</code> up to 12 args, truncates extras, and returns Boolean success. Used throughout to call optional utilities (<code>modUtilities</code>, <code>modConfig</code>, <code>modAudit</code>, <code>modError</code>). If the external function fails the module falls back to internal implementation and emits <code>AppendLocalAudit</code>. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Safe array helpers</strong><br><code>SafeArrayIndex</code> validates <code>LBound</code>/<code>UBound</code> before indexing (supports 1D/2D). Calls <code>modUtilities.SafeArrayIndex</code> if available. Out-of-range attempts produce <code>AppendLocalAudit</code> entries rather than hard errors. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Diagnostics & verification</strong><br><code>m_lastNormalizeReport</code> (private) contains last normalization failure—useful for debugging. Self-test writes persistent results. Consumers should call <code>IFRS16SelfTest</code> as part of deployment validation. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Persistence & visibility</strong><br>All diagnostic/audit writes target very-hidden sheets to avoid accidental tampering; callers should secure workbook and backups. <code>_IFRS_TestResults</code> is appended (not overwritten) to provide audit trail for self-tests. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Inter-module dependencies</strong><br>Optional integrations (soft dependencies, used when present): <code>modUtilities</code> (normalizer, rounding, safe array helpers), <code>modConfig</code> (runtime flags/keys: <code>IFRS.RoundingPrecision</code>, <code>IFRS.DayCount</code>, <code>IFRS16.LegacyInterestMode</code>, <code>IFRS16.NormalizerMode</code>), <code>modAudit</code> (structured auditing), <code>modError</code> (centralized error handling), <code>modTests</code> (self-test reporting). All optional calls are guarded with <code>TryApplicationRun</code>. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Behavioral fallbacks</strong><br>If external shims are absent module falls back to internal implementations, records audit entries, and preserves legacy public API behavior (returning <code>Empty</code> for unsupported payment shapes). Where internal result may be less feature-rich a diagnostic report is created (<code>MakeNormalizeErrorReport</code>). </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Edge cases & defensive rules</strong><br>• Zero or negative discount rate handled explicitly.<br>• Missing payment dates treated as Empty and yield 0 year fractions.<br>• Index out-of-range returns 0/Empty and emits audit line rather than raising.<br>• Very small rounding residuals are zeroed to avoid negative zero/rounding drift. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Security & operational guidance</strong><br>• Review and approve any optional external shims (<code>modUtilities</code>, <code>modConfig</code>, <code>modAudit</code>, <code>modError</code>) before enabling in production.<br>• Protect workbook and very-hidden sheets; consider workbook encryption and file system ACLs for archives/backups.<br>• Run <code>IFRS16SelfTest</code> after deployment and after upgrade to <code>MODULE_VERSION</code> to record <code>Checked10x</code> marker. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Examples (input → normalized output)</strong><br>Example 2D array input: <code>payments(1 To 3,1 To 2)</code> with <code>[Date, Amount]</code> → normalized <code>out(1 To 3,1 To 2)</code> where <code>out(i,1)=CDate(date)</code> or <code>Empty</code>, <code>out(i,2)=Double(amt)</code>.<br>Example 1D array of arrays: <code>arr(0)= [2026-06-15,800]</code> → normalized similarly. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Journal output format</strong><br><code>IFRS16_GenerateJournalEntries</code> returns 2D array with columns: <code>Date, CreditAccount, CreditAmount, DebitAccount, DebitAmount, Narrative</code>. Debit/Credit side ordering follows legacy mapping used by hosts (caller responsible for mapping to ledger import format). </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Limitations & known gaps</strong><br>• No built-in cryptographic signing of outputs — consumers should sign/export in CI if required.<br>• ROU depreciation is time-proportional simple allocation (no remeasurement logic for changes to useful life or impairment).<br>• Public API signatures preserved — no new public accessors for internal diagnostics to avoid API breakage; <code>GetLastNormalizeReport</code> remains private. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Recommended operational checks</strong><br>1. Run <code>IFRS16SelfTest()</code> during install/upgrade and archive <code>_IFRS_TestResults</code> periodically.<br>2. Schedule <code>VerifyAuditChain</code> (if using <code>modAudit</code>) in CI to detect tampering early.<br>3. Validate <code>modConfig</code> keys (<code>IFRS.RoundingPrecision</code>, <code>IFRS.DayCount</code>, <code>IFRS16.LegacyInterestMode</code>, <code>IFRS16.NormalizerMode</code>) when deploying across environments.<br>4. Confirm <code>modUtilities</code> presence if you rely on improved normalizer/rounding; otherwise expect internal fallbacks. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Troubleshooting quick guide</strong><br>• Unexpected <code>Empty</code> from <code>IFRS16_InitialMeasurement</code> → inspect <code>m_lastNormalizeReport</code> (internal) and ensure payments shape supported or <code>modUtilities.NormalizePaymentsForRead</code> available.<br>• Wrong interest amounts → verify <code>IFRS16.LegacyInterestMode</code> flag and <code>IFRS.DayCount</code> (ACT/365 default).<br>• Rounding differences → confirm <code>IFRS.RoundingPrecision</code> and whether <code>modUtilities.Round</code> shim is present.<br>• Self-test failures → open <code>_IFRS_TestResults</code> sheet for per-fixture results and run <code>IFRS16SelfTest</code> manually. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Backward compatibility & upgrade notes</strong><br>Public signatures unchanged; module adds hardened internal behavior and diagnostics. Consumers upgrading should: run <code>IFRS16SelfTest</code>, archive <code>_IFRS_TestResults</code>, and verify <code>modUtilities</code>/<code>modConfig</code> shims behave as expected. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Developer notes</strong><br>• <code>NormalizePaymentsForRead</code> aims to preserve legacy <code>Empty</code> return on unsupported shapes to avoid breaking callers.<br>• Internal diagnostics use <code>MakeNormalizeErrorReport</code> factory for structured reporting.<br>• All optional external calls are non-fatal and audited via <code>AppendLocalAudit</code> when missing. </td></tr></tbody></table></div><div class="row-count">Rows: 30</div></div><div class="table-caption" id="Table12" data-table="Docu_0158_12" style="margin-top:2mm;margin-left:3mm;"><strong>Table 12</strong></div>
<div class="table-wrapper" data-table-id="table-12"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modAudit + modRibbonCallbacks"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modAudit + modRibbonCallbacks</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Scope & Purpose</strong><br>Combined guidance for two integrated VBA modules: <code>modAudit</code> (append-only, tamper-evident audit store, buffered writes, hash-provider fallbacks, archive/exports, PII-light redaction) and <code>modRibbonCallbacks</code> (Office Ribbon lifecycle, safe handler registry, job scheduling via <code>Application.OnTime</code>, retries/backoff, job sheet migration, reconciliation, CI self-tests). This doc explains public surface, data schemas, runtime behavior, safety knobs, troubleshooting, and operational best practices. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>High-level architecture</strong><br><code>modAudit</code> persists cryptographically chained rows to <code>_IFRS_Audit</code>. <code>modRibbonCallbacks</code> manages UI callbacks and schedules background work via a jobs sheet <code>_IFRS_Jobs</code>; it prefers calling into <code>modAudit</code> / <code>modUtilities</code> for audit/CRC but contains safe local fallbacks (e.g., <code>AppendLocalAuditFallback</code>, local CRC32). The two modules interoperate via structured audit calls (<code>Ribbon_AuditStructured</code>). </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Primary public API (summary)</strong><br>modAudit: <code>InitAuditModule</code>, <code>ShutdownAuditModule</code>, <code>LogAudit</code>, <code>AppendAuditEntry</code>, <code>AppendAuditBuffered</code>, <code>FlushAuditBuffer</code>, <code>RotateAuditNow</code>, <code>ExportAuditToCSV</code>, <code>ExportAuditToJSON</code>, <code>VerifyAuditChain</code>, <code>GenerateAuditDiagnosticReport</code>, <code>FindAuditByCorrelationID</code>, <code>ReadAuditRow</code>, <code>SetAuditFeatureFlag</code>, <code>GetAuditFeatureFlag</code>.<br>modRibbonCallbacks public callbacks (key): <code>Ribbon_OnLoad</code>, <code>Ribbon_OnButtonClick</code>, <code>Ribbon_OnToggle</code>, <code>Ribbon_OnGalleryChange</code>, <code>Ribbon_GetEnabled</code>, <code>Ribbon_GetVisible</code>, <code>Ribbon_GetLabel</code>, <code>Ribbon_GetPressed</code>, <code>Ribbon_GetImage</code>, <code>Ribbon_RegisterHandler</code>, <code>Ribbon_RegisterImageProvider</code>, <code>Ribbon_RegisterLegacyAlias</code>, <code>Ribbon_ScheduleLongTask</code>, <code>Ribbon_ProcessJob_OnTime</code>, <code>Ribbon_ProcessJob</code>, <code>Ribbon_AttemptGracefulShutdown</code>, <code>Ribbon_ReconcileJobsOnOpen</code>, <code>Ribbon_ExecuteDebouncedInvalidate</code>, <code>Ribbon_SelfTest</code>, <code>Ribbon_OnTimeRoute</code>, <code>Ribbon_RunSelfTestOnce</code>, <code>Ribbon_VerifyPlan</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Audit canonical schema & ribbon storage mapping</strong><br>Canonical (CSV/JSON concept): <code>timestamp,correlationId,module,procedure,severity,userId,payloadHash,prevHash,signature</code>.<br><code>modAudit</code> worksheet columns: <code>TimestampUTC, CorrelationID, Module, Procedure, Severity, ErrNum, WindowsUser, ExcelUser, Action, ContextJSON, PrevHash, Hash</code>.<br><code>modRibbonCallbacks</code> local fallback audit sheet columns: <code>Timestamp, Action, Message, CorrId, JobId, Proc</code> (when <code>modAudit</code> not available). </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Jobs sheet schema (explicit columns)</strong><br>Worksheet: <code>_IFRS_Jobs</code> header (A..N): <code>JobId</code>, <code>Handler</code>, <code>Status</code>, <code>ScheduledAt</code>, <code>LastError</code>, <code>Meta</code>, <code>CreatedAt</code>, <code>UpdatedAt</code>, <code>v2_migrated</code>, <code>Attempts</code>, <code>LastAttemptAt</code>, <code>RunDurationMs</code>, <code>CorrId</code>, <code>HandlerMeta</code>.<br>Column constants in code: <code>COL_JobId=1</code>, <code>COL_Handler=2</code>, <code>COL_Status=3</code>, <code>COL_ScheduledAt=4</code>, <code>COL_LastError=5</code>, <code>COL_Meta=6</code>, <code>COL_CreatedAt=7</code>, <code>COL_UpdatedAt=8</code>, <code>COL_v2_migrated=9</code>, <code>COL_Attempts=10</code>, <code>COL_LastAttemptAt=11</code>, <code>COL_RunDurationMs=12</code>, <code>COL_CorrId=13</code>, <code>COL_HandlerMeta=14</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Job lifecycle & statuses</strong><br>Typical statuses: <code>queued</code>, <code>running</code>, <code>completed</code>, <code>failed</code>, <code>cancelled</code>, <code>orphaned</code>, <code>orphaned_permanent</code>.<br>Transition rules:<br>• <code>EnqueueOrUpdateJob</code> → row created/updated, <code>Status=&quot;queued&quot;</code>, <code>ScheduledAt</code> set.<br>• <code>SafeOnTimeScheduleWithRetry</code> schedules <code>Application.OnTime</code>; on success scheduled metadata and attempts recorded; on permanent failure job set <code>orphaned</code>/<code>orphaned_permanent</code>.<br>• <code>Ribbon_ProcessJob</code> sets <code>running</code>, executes handler safely, records <code>Attempts</code>, <code>RunDurationMs</code>, final <code>Status</code> and <code>LastError</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>OnTime scheduling & retry/backoff</strong><br><code>SafeOnTimeScheduleWithRetry</code> attempts up to <code>ONTIME_MAX_RETRIES = 3</code> with exponential backoff; records attempts via <code>RecordScheduleAttempt</code> and marks job orphaned on persistent failure. <code>SafeOnTimeSchedule</code> is a thin wrapper that logs immediate failures. <code>Ribbon_AttemptGracefulShutdown</code> cancels scheduled OnTime procs where possible. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Proc-string building & routing</strong><br><code>BuildOnTimeProcString(procBase, jobId)</code> returns either long proc <code>&#x27;WorkbookName&#x27;!procBase &quot;corrId&quot;</code> when under <code>PROC_STR_MAX_LEN</code> (240) and valid; otherwise falls back to <code>&#x27;WorkbookName&#x27;!Ribbon_OnTimeRoute &quot;corrId&quot;</code>.<br>Long route allows <code>Ribbon_ProcessJob_OnTime(argCorrId)</code> to be invoked directly; short route uses <code>Ribbon_OnTimeRoute</code> to look up job by <code>CorrId</code>. <code>BuildOnTimeProcString</code> persists <code>CorrId</code> into the job row. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Safety and input validation</strong><br><code>IsValidProcName</code> enforces: length ≤ <code>PROC_STR_MAX_LEN</code>, no control characters, disallow <code>;</code> and <code>,</code> to avoid chain/injection, validates <code>!</code> and quoted arg patterns for OnTime style strings. <code>MakeArgSafe</code> sanitizes arguments (capable scalars only); <code>SafeApplicationRun</code> caps args to <code>SAFE_ARG_LIMIT = 3</code> and prefers <code>modUtilities.TryRunReturn</code> if present. <code>SafeApplicationRunPicture</code> wraps image providers and returns <code>IPictureDisp</code> when available. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Debounce & UI invalidation</strong><br><code>Ribbon_Invalidate</code> schedules a debounced invalidate via <code>Application.OnTime</code> to call <code>Ribbon_ExecuteDebouncedInvalidate</code>. Default debounce <code>DEFAULT_INVALIDATE_DEBOUNCE_SECONDS = 0.25</code> but can be overridden via workbook name <code>IFRS_RibbonInvalidateDebounceSeconds</code> or <code>modConfig.GetSetting</code>. <code>EnsureDebounceConfigDefault</code> seeds a default in <code>modConfig</code> if available. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Correlation IDs & CRC32</strong><br><code>GenerateCorrelationID(seed)</code> prefers delegated <code>modUtilities.CRC32_String</code>; fallback uses local CRC32 table with deterministic UTF-16LE bytes → string <code>METRIC_PREFIX &amp; HexFromLong(crc)</code>. Ribbon uses <code>METRIC_PREFIX = &quot;rb-&quot;</code>. <code>modAudit</code> uses <code>NewCorrelationId()</code> producing <code>IFRS-...</code> GUID-like ids. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Hashing & provider selection (from modAudit)</strong><br>Hash provider order: (1) external macro <code>HashProviderMacroName</code> if <code>g_allowExternalHashProvider = True</code>; (2) system SHA256 via <code>certutil</code>/<code>shasum</code>/<code>openssl</code> if <code>g_allowCommandExecution = True</code>; (3) CRC32 fallback. Each provider use is recorded to meta (<code>HashProviderUsed</code>) and counts maintained. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Redaction & payload handling (from modAudit)</strong><br><code>RedactSensitiveData</code> uses regexes to remove emails, SSN-like numbers, long numeric sequences, account numbers, JWTs, API key patterns, long hex/base64 blobs; <code>g_aggressiveRedaction</code> increases sensitivity. <code>MAX_CONTEXT_LENGTH = 2000</code> enforces truncation with <code>ContextTruncated</code> events. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Meta sheet & diagnostics</strong><br>Audit meta sheet <code>_IFRS_AuditMeta</code> records <code>LastFlushUTC</code>, <code>BufferedCount</code>, <code>EnableMetaSheet</code>, <code>AggressiveRedaction</code>, and hash provider counts. <code>modRibbonCallbacks</code> writes to <code>_IFRS_TestResults</code> for self-tests and <code>Ribbon_VerifyPlan</code> populates test rows for CI. <code>GenerateAuditDiagnosticReport</code> and <code>VerifyAuditChain</code> support forensic analysis. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Self-test & CI hooks</strong><br><code>Ribbon_SelfTest</code>, <code>Ribbon_VerifyPlan</code>, <code>Ribbon_RunSelfTestOnce</code> provide deterministic non-UI checks and write results to <code>_IFRS_TestResults</code>. Recommended to run in CI to validate sheet presence, header correctness, debounce setting, proc validation, OnTime routing, and audit availability. <code>VerifyAuditChain</code> must be run as part of release CI/monitoring (per modAudit guidance). </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Migration & upgrade path</strong><br><code>EnsureJobsSheetExists</code> checks a <code>v2_migrated</code> marker (row 2, <code>COL_v2_migrated</code>) and calls <code>MigrateJobsSheetToV2</code> when needed. Migration creates a deterministic backup sheet named <code>&quot;_IFRS_Jobs_backup_yyyymmdd_hhmmss&quot;</code> before modifying rows and populates new columns (<code>Attempts</code>, <code>RunDurationMs</code>, <code>CorrId</code>, <code>HandlerMeta</code>). </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Telemetry & internal audit events (examples)</strong><br>Ribbon emits structured audit entries: <code>RegisterHandler</code>, <code>RegisterImageProvider</code>, <code>EnqueueOrUpdate</code>, <code>OnTimeScheduleRetry</code>, <code>OnTimeScheduleFailPermanent</code>, <code>ProcessJobComplete</code>, <code>ProcessJobHandlerError</code>, <code>ReconcileOrphaned</code>, <code>ReconcileReschedule</code>, <code>SelfTestComplete</code>, and many internal markers (<code>FlushStart</code>, <code>RotateStart</code>, <code>HashProviderUsed</code>). These help CI/ops correlate UI actions to background job outcomes. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Error handling & fallbacks</strong><br>Both modules prefer centralized helpers (<code>modAudit</code>, <code>modUtilities</code>, <code>modError</code>) but implement local fallbacks to avoid hard failures. <code>On Error</code> handling emits fallback audit rows and writes minimal info to support debugging. Bulk-write failures in <code>FlushAuditBuffer</code> fall back to per-row writes. <code>AppendLocalAuditFallback</code> avoids recursion by not calling <code>Ribbon_AuditStructured</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Operational recommendations</strong><br>• Call <code>InitAuditModule</code> at add-in/workbook startup and <code>ShutdownAuditModule</code> on close.<br>• Run <code>VerifyAuditChain</code> in CI and periodic monitoring; any mismatch should trigger the audit-compromise runbook.<br>• Protect <code>_IFRS_Audit</code>, <code>_IFRS_AuditMeta</code>, <code>_IFRS_Jobs</code>, <code>_IFRS_TestResults</code> with sheet/workbook protection and access controls.<br>• Disable <code>allowExternalHashProvider</code> unless <code>HashProviderMacroName</code> is trusted and code-reviewed. Consider disabling <code>g_allowCommandExecution</code> on locked endpoints.<br>• Keep <code>ContextJSON</code> payloads small and PII-light to avoid unnecessary redaction/truncation. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Security considerations</strong><br>• <code>IsValidProcName</code> and <code>MakeArgSafe</code> mitigate remote code injection via <code>Application.Run</code> and <code>OnTime</code> strings — retain and review these validators when modifying proc-string logic.<br>• Limit <code>SAFE_ARG_LIMIT</code> and sanitize inputs to handlers; prefer typed, explicit arguments passed through job metadata rather than raw user input.<br>• Audit and review any enabled external macro hash provider or <code>Application.OnTime</code> strings that contain quoted arguments. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Troubleshooting checklist</strong><br>1. Missing scheduled job runs: check <code>_IFRS_Jobs</code> <code>Meta</code> column, <code>CorrId</code>, <code>Meta</code> proc string; validate <code>IsValidProcName</code> and <code>Application.OnTime</code> success (check <code>OnTimeScheduleRetry</code> audit entries).<br>2. Orphaned jobs after restart: run <code>Ribbon_ReconcileJobsOnOpen</code> (automatic on load); inspect <code>Attempts</code> and <code>LastError</code> columns.<br>3. Verify audit chain mismatch: run <code>VerifyAuditChain</code> → if fails run <code>GenerateAuditDiagnosticReport</code> and follow <code>audit-compromise</code> runbook.<br>4. Long context truncated: reduce payload, or increase <code>MAX_CONTEXT_LENGTH</code> with caution and update redaction policies.<br>5. Image provider failures: ensure registered provider name valid and <code>SafeApplicationRunPicture</code> returns <code>IPictureDisp</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Examples (patterns)</strong><br>Enqueue async handler:<br><code>EnqueueOrUpdateJob &quot;job-123&quot;, &quot;MyHandlerProc&quot;, DateAdd(&quot;s&quot;,1,Now)</code> → <code>UpdateJobMeta jobId, BuildOnTimeProcString(&quot;Ribbon_ProcessJob_OnTime&quot;, jobId)</code> → <code>SafeOnTimeScheduleWithRetry</code>.<br>BuildOnTimeProcString output examples:<br><code>&#x27;MyWorkbook.xlsm&#x27;!Ribbon_ProcessJob_OnTime &quot;rb-XXXXXXXX&quot;</code> (long route) or <code>&#x27;MyWorkbook.xlsm&#x27;!Ribbon_OnTimeRoute &quot;rb-XXXXXXXX&quot;</code> (short route fallback). </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Limitations & notes</strong><br>• <code>modAudit</code> does not produce cryptographic signatures by default; signatures mentioned in the canonical schema must be produced by an external signing step (CI/release manifest).<br>• System SHA256 depends on platform tools; disabled environments will fall back to CRC32 (weaker).<br>• <code>Application.OnTime</code> scheduling is best-effort and subject to host Excel session uptime; job persistence relies on <code>_IFRS_Jobs</code> being durable and reconciled on open. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Change-management & CI checklist</strong><br>Before release/update: run <code>Ribbon_VerifyPlan</code> and <code>Ribbon_RunSelfTestOnce</code>, run <code>VerifyAuditChain</code>, export audit via <code>ExportAuditToCSV</code> and sign if signatures are required, confirm <code>AUDIT_ARCHIVE_FOLDER</code> retention policy, and review <code>g_allowExternalHashProvider</code> & <code>g_allowCommandExecution</code> settings for environment. </td></tr></tbody></table></div><div class="row-count">Rows: 24</div></div><div class="table-caption" id="Table13" data-table="Docu_0158_13" style="margin-top:2mm;margin-left:3mm;"><strong>Table 13</strong></div>
<div class="table-wrapper" data-table-id="table-13"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modSecurity"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modSecurity</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modSecurity"> <strong>Overview</strong><br>Centralized security helpers for the add-in: signature checks, macro/security sanity checks, export-path policy, credential wrappers (delegates to discovered secret store), audit integration, unit-test harness, atomic write helper, migration & CI helpers. Designed to work with existing project-level <code>modAudit</code> and <code>modConfig</code> if present but uses safe runtime discovery and conservative defaults to avoid breaking older projects. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Purpose & design principles</strong><br>• Non-breaking: no public API changes except one optional parameter default.<br>• Runtime discovery of centralized handlers (<code>RunCandidatesReturn</code>) to avoid compile-time coupling.<br>• Conservative safe defaults and explicit feature flags to enable deprecated or risky behaviors (e.g., plaintext CustomXML persistence, external command probes).<br>• Strong preference for secure stores and delegated prompts; prompts/fallbacks are behind feature flags. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Public API (summary)</strong><br><code>Security_CheckWorkbookSignature(Optional minSignatures, Optional callerCid)</code> — checks workbook signatures; uses <code>RunConfigGet</code> for default <code>minSignatures</code>.<br><code>Security_IsVBAProjectProtected(callerCid)</code> — detects VBProject protection (returns error code if unavailable).<br><code>Security_VerifyMacroSettings(callerCid)</code> — verifies <code>Application.AutomationSecurity</code> not forced disabled.<br><code>Security_IsUserAdmin(callerCid)</code> — best-effort admin probe (Windows <code>whoami /groups</code> guarded by feature flag).<br><code>Security_AllowExportToPath(targetPath, callerCid)</code> — policy check + writability probe.<br><code>Security_GetCredential(key, callerCid)</code> / <code>Security_SetCredential(key,value,callerCid)</code> — credential read/write via discovered store or controlled fallback.<br><code>Security_RunCmdAndGetOutput(cmd, callerCid)</code> — guarded, audited command runner (Windows only) with timeout and policy checks.<br><code>Security_VerifyExportPathWritable(path, callerCid)</code> — atomic write probe.<br><code>Security_SelfTest(callerCid)</code> / <code>Security_RunUnitTests(callerCid)</code> — self-test and unit tests; writes results to hidden sheet.<br><code>Security_MigrateCustomXMLToStore(requireAdmin, callerCid)</code> — migrates CustomXML credentials to secure store (flag-gated).<br><code>Security_GenerateCorrelationId()</code> — wrapper to <code>NewCorrelationId()</code>.<br><code>Security_FindCrossModuleCollisions(callerCid)</code> / <code>Security_ScanForDuplicateSymbols(callerCid)</code> — codebase scans.<br><code>Security_MigrationChecklistReport(callerCid)</code> / <code>Security_RolloutPlan(callerCid)</code> — migration guidance strings.<br><code>Security_CI_Gate()</code> — CI gate orchestration: run unit tests, self-tests, central handler assertions. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Feature flags & conservative defaults</strong><br>Key flags resolved via <code>FeatureFlagEnabled</code> / <code>RunConfigGet</code> (runtime discovery):<br>• <code>FLAG_ENABLE_LOCAL_AUDIT</code> — allow in-module audit fallback (disabled by default).<br>• <code>FLAG_ENABLE_PROMPT_FALLBACK</code> — allow unmasked InputBox fallback for secrets (disabled by default).<br>• <code>FLAG_ALLOW_PLAINTEXT_SECRET_PERSIST</code>, <code>FLAG_CUSTOMXML_MIGRATION_CONFIRM</code>, <code>FLAG_ALLOW_CUSTOMXML_FALLBACK</code> — control CustomXML persistence & migration.<br>• <code>FLAG_USE_WHOAMI_FOR_ADMIN_PROBE</code> — gates <code>whoami</code> usage.<br>• <code>FLAG_AUDIT_VERBOSE</code> — controls audit verbosity. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Credential handling & migration</strong><br>Read order for <code>Security_GetCredential</code>:<br>1. Prefer secure store via discovered config procedure (<code>Config_GetSecret</code> candidates).<br>2. Do NOT read <code>CustomXMLParts</code> at runtime (deprecated) — module audits and logs deprecation.<br>3. Delegated masked prompt via discovered <code>SecretPrompt</code> candidates.<br>4. Optional unmasked InputBox fallback only if <code>FLAG_ENABLE_PROMPT_FALLBACK</code> enabled.<br><code>Security_SetCredential</code> prefers secure store; refuses plaintext persistence unless explicit flags allow deprecated CustomXML writes. <code>Security_MigrateCustomXMLToStore</code> migrates CustomXML entries into the secure store (flag + optional admin requirement). </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Audit integration & safe logging</strong><br><code>Security_Audit(action, message, cid)</code> delegates to centralized audit candidates (<code>modAudit.LogAudit</code>, <code>modAudit.AppendLocalAuditStructured</code>, etc.) using <code>RunCandidatesReturn</code> and redacts secrets first (<code>RedactSecrets</code>). If no centralized audit present and <code>FLAG_ENABLE_LOCAL_AUDIT</code> is true, falls back to <code>AppendLocalAuditStructured_Fallback</code> (minimal local shim kept intentionally small). Module never logs raw secret values and truncates messages unless <code>FLAG_AUDIT_VERBOSE</code> is enabled. Correlation IDs are propagated for cross-module traceability. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Local audit fallback</strong><br>Minimal fallback writer (<code>AppendLocalAuditStructured_Minimal</code>) writes a simple <code>_modSecurity</code> audit sheet (<code>modSecurity_Audit</code>) with <code>Timestamp, CorrelationId, User, Action, Message, Meta, RowHash</code>. This is feature-flag gated and intentionally lightweight to avoid leakage. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Redaction & secrets scanning</strong><br><code>RedactSecrets(txt)</code> uses tight RegExp patterns to remove common keys (password, token, api key, etc.) with lower false-positive risk (short benign tokens skipped). <code>AssertNoSecretsInAudit</code> scans recent audit rows (last 200) for suspicious tokens and returns a count. Unit tests assert no obvious secrets in the audit. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Command execution & safeties</strong><br><code>Security_RunCmdAndGetOutput(cmd,cid)</code> is Windows-only (skips on macOS), uses <code>WScript.Shell.Exec</code> guarded by <code>IsCmdSafe</code> and command timeout <code>MS_CMD_TIMEOUT_SEC</code>. It truncates output, never logs raw command text (only length/summary), and audits execution. <code>IsCmdSafe</code> rejects pipes, redirects, remote URLs, known dangerous tokens (powershell -enc, curl, wget), and overly long commands. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Atomic write helper</strong><br><code>AtomicWriteFile(fullPath, contents)</code> writes to a unique temporary file in target folder then moves/renames into place, with fallback to direct create on failure. Used by <code>Security_VerifyExportPathWritable</code> to prove writability without race conditions. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Export path policy & path canonicalization</strong><br><code>Security_AllowExportToPath(targetPath)</code> resolves allowed roots using <code>RunConfigGet(&quot;DEFAULT_EXPORT_ALLOW_KEY&quot;)</code> or defaults to <code>ThisWorkbook.path</code>. It normalizes paths via <code>NormalizePathShared</code> which prefers <code>modUtilities.NormalizePath</code> if present; <code>Security_PathIsUnder</code> checks descendant relationships. <code>Security_VerifyExportPathWritable</code> verifies folder existence and atomic-write permission. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Self-test, unit tests & CI</strong><br><code>Security_SelfTest</code> runs macro settings check, signature check, VBProject protection probe, export path writable probe, and optional deterministic mode controlled by <code>FLAG_SELFTEST_DETERMINISTIC</code>.<br><code>Security_RunUnitTests</code> exercise redaction, <code>SafeApplicationRun</code>, <code>Security_SelfTest</code>, ADODB probe, duplicate symbol scan, cross-module collisions, and audit secret assertions. Results recorded in hidden <code>modSecurity_TestResults</code> sheet. <code>Security_CI_Gate</code> ties unit tests, self-test, and handler assertions into a CI-friendly exit string. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>RunCandidates, SafeApplicationRun, Resolvers</strong><br><code>RunCandidatesReturn(candidatesCSV, args...)</code> attempts a comma-separated list of procedure names (e.g., <code>modConfig.Config_Get</code>) and returns the first non-empty result; used everywhere to discover centralized handlers.<br><code>SafeApplicationRun(procName, args...)</code> protects <code>Application.Run</code> calls and returns <code>Empty</code> on failures. <code>RunConfigGet(key, default)</code> is a convenience wrapper for config discovery. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Codebase scanning & collision detection</strong><br><code>Security_ScanForDuplicateSymbols</code> and <code>Security_FindCrossModuleCollisions</code> use <code>VBScript.RegExp</code> to scan module code for <code>Const/Function/Sub</code> declarations and report duplicates or cross-module collisions (best-effort; skips on macOS or when VBE access unavailable). </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Migration & rollout helpers</strong><br><code>ValidateConfigConstants</code> probes for standard config keys and emits an audit if missing. <code>Security_MigrationChecklistReport</code> gives a short checklist including feature-flag checks and secret-store probe. <code>Security_RolloutPlan</code> returns a concise suggested plan: refactor → centralized audit switch → stricter secret handling behind flags → flip flag after verification. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Meta & test sheet behaviour</strong><br>Hidden sheets used: <code>modSecurity_Audit</code> (fallback), <code>modSecurity_TestResults</code>. New sheets are <code>xlSheetVeryHidden</code> by default. <code>WriteSelfTestResult</code> logs timestamp, correlationId, ok, iterations, and user. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Error handling & diagnostics</strong><br><code>Security_HandleError</code> attempts to call centralized error handlers (<code>modError.HandleError</code> candidates) with redacted descriptions. If centralized handlers are missing, it falls back to <code>Security_Audit &quot;Error&quot;, ...</code> and <code>Debug.Print</code>. <code>ValidateConfigConstantsReport</code> returns a comma-separated list of missing config constants. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Operational guidance & hardening</strong><br>• Ensure <code>modAudit</code> and <code>modError</code> are present and wired via <code>RunCandidatesReturn</code> for centralized behavior.<br>• Protect hidden sheets and use workbook protection and file ACLs.<br>• Disable deprecated fallback flags (<code>FLAG_ENABLE_LOCAL_AUDIT</code>, <code>FLAG_ENABLE_PROMPT_FALLBACK</code>, <code>FLAG_ALLOW_PLAINTEXT_SECRET_PERSIST</code>) in production.<br>• Prefer secret-store integration (implement <code>Config_GetSecret</code>/<code>Config_SetSecret</code> candidates) and remove CustomXML storage. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Limitations & known behaviors</strong><br>• Best-effort discovery: absent <code>modConfig</code>/handlers → fallbacks may be used or operations refused depending on flags.<br>• Admin and VBProject probes may fail on locked-down systems or macOS (platform differences).<br>• <code>RunCandidatesReturn</code> uses <code>Application.Run</code> semantics — callers must ensure candidate names are exported/public.<br>• Command execution and whoami probes rely on <code>WScript</code> availability and are feature-flag gated. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Troubleshooting checklist</strong><br>1. Central audit missing: run <code>AssertCentralizedHandlersPresent()</code> and inspect <code>ValidateConfigConstantsReport()</code>.<br>2. Credential store absent: implement <code>Config_GetSecret</code> / <code>Config_SetSecret</code> or enable/outsource secure store integration; avoid CustomXML fallback.<br>3. Export failures: verify <code>DEFAULT_EXPORT_ALLOW_KEY</code> and <code>ThisWorkbook.path</code> resolution; check <code>Security_VerifyExportPathWritable</code> test file.<br>4. CI failures: run <code>Security_CI_Gate()</code> and review unit test outputs in <code>modSecurity_TestResults</code>.<br>5. Audit contains secrets: run <code>AssertNoSecretsInAudit()</code> and <code>Security_RunUnitTests()</code> to surface failures. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Examples & sample messages</strong><br>Audit message examples produced by module (redacted):<br><code>CheckWorkbookSignature | signatures=2;result=True</code><br><code>GetCredential | key=ap****ey;method=store</code><br><code>RunCmd | cmd_executed;output_len=345</code> </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Developer notes for integration</strong><br>• Keep feature flags in <code>modConfig</code> if available so runtime discovery picks them up.<br>• Provide <code>Config_GetSecret</code> and <code>Config_SetSecret</code> implementations to avoid falling back to prompts or deprecated storage.<br>• Wire centralized <code>modAudit.LogAudit</code> and <code>modError.HandleError</code> to achieve consistent telemetry and runbook triggers.<br>• Review <code>IsCmdSafe</code> and blacklist whitelist rules to suit your org policy before enabling command execution features. </td></tr></tbody></table></div><div class="row-count">Rows: 22</div></div><div class="table-caption" id="Table14" data-table="Docu_0158_14" style="margin-top:2mm;margin-left:3mm;"><strong>Table 14</strong></div>
<div class="table-wrapper" data-table-id="table-14"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modStatements"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modStatements</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modStatements"> <strong>Overview</strong><br>Assemble, validate, render, snapshot and reconcile financial statement packages in VBA. Designed to work with host helpers when available but robust when they are absent. Emphasises deterministic package shape, safe worksheet operations (no <code>Select</code>/<code>Activate</code>), formula-injection sanitization, snapshotting (very-hidden), and audit integration via <code>SafeAuditStructured</code> / local audit fallback. Schema and revision are tracked (<code>STATEMENT_PACKAGE_SCHEMA</code>, <code>ModuleRevision</code>). </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Public API</strong><br><code>AssembleStatementPackage(packageID, sourceLines, Optional templateName, Optional author) As Object</code> — build deterministic package dictionary; returns <code>Dictionary</code> or <code>Nothing</code>.<br><code>ValidateStatementPackage(pkg) As Object</code> — returns <code>Dictionary</code> of issues (empty = no issues).<br><code>RenderStatementToSheet(pkg, sheetName, Optional targetWb) As Boolean</code> — render package to worksheet (safe, batched write).<br><code>RestoreStatementSnapshot(snapshotSheetName, targetSheetName, Optional targetWb) As Boolean</code> — copy+rename snapshot with collision handling.<br><code>CreateStatementSnapshot(pkg, sourceSheetName, Optional targetWb) As String</code> — create very-hidden snapshot and record metadata; returns snapshot name.<br><code>GenerateReconciliation(pkg, tbRange) As Variant</code> — reconcile package lines to trial-balance range; returns 2D array [LineID, Amount, TBsum, Difference]. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Public constants & limits</strong><br><code>STATEMENT_SNAPSHOT_PREFIX = &quot;_IFRS_StatementSnapshot_&quot;</code>.<br><code>STATEMENT_PACKAGE_SCHEMA = &quot;1.0.0&quot;</code>.<br><code>STATEMENT_BALANCE_TOLERANCE = 0.005</code> — tolerance for zero-balance check.<br><code>MAX_LINES_THRESHOLD = 10000</code> — defensive limit; <code>AssembleStatementPackage</code> truncates and emits a log when exceeded. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Package shape & determinism</strong><br>Package is a <code>Scripting.Dictionary</code> with keys: <code>PackageID</code>, <code>CorrelationID</code>, <code>SchemaVersion</code>, <code>TemplateName</code>, <code>Author</code>, <code>CreatedUTC</code>, <code>Lines</code>, <code>Status</code>.<br><code>CorrelationID</code> produced by <code>SafeNewCorrelationID()</code> for reproducible IDs when host helper unavailable. <code>GetStableJson</code> writes deterministic JSON for snapshot metadata (uses host <code>DictToJsonStable</code> if present, otherwise local <code>DictToJsonStable</code>). </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Input normalization</strong><br><code>NormalizeLines</code> accepts arrays (1D/2D), <code>Dictionary</code> (.Items), <code>Collection</code>, other iterables, or scalar values and returns a 1-based <code>1..n</code> array or <code>Empty</code>. Robust handling for multi-dimensional arrays and object enumerables. <code>GetLineCount</code> and helpers provide safe counts. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Validation rules</strong><br><code>ValidateStatementPackage</code> checks: package presence/type, <code>Lines</code> existence, each line is dictionary-like, <code>LineID</code> present, <code>Amount</code> numeric. Aggregates total and flags <code>TotalNotZero</code> when abs(total) > <code>STATEMENT_BALANCE_TOLERANCE</code>. Returns structured <code>issues</code> dictionary and always audits validation completion. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Rendering behavior</strong><br>Writes headers and body without selection. Uses <code>SanitizeForCell</code> to avoid formula injection (prefix <code>&#x27;</code> when value starts with <code>=</code>, <code>+</code>, <code>-</code>, <code>@</code>). Batch-writes data using a 2D <code>Variant</code> array (<code>outArr</code>) for performance. Normalizes and caches <code>AccountRefs</code> per-line to minimize work. Sets <code>pkg(&quot;Status&quot;) = &quot;Rendered&quot;</code> and emits a structured audit. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Snapshot model</strong><br><code>CreateStatementSnapshot</code> copies source sheet, renames to a safe snapshot name (<code>STATEMENT_SNAPSHOT_PREFIX + timestamp [+ short correlation]</code>), marks snapshot <code>xlSheetVeryHidden</code>, and records metadata into <code>_IFRS_Snapshots</code> (columns: <code>SnapshotName, PackageID, CorrelationID, SchemaVersion, CreatedUTC, SourceSheet, PackageJson</code>). Rename has collision handling and a move/copy fallback using a temporary workbook. <code>RestoreStatementSnapshot</code> copies snapshot, safely renames with collision resolution, deletes existing target, and reveals the restored sheet. Both actions are audited. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Reconciliation logic</strong><br><code>GenerateReconciliation</code> builds a trial-balance dictionary from <code>tbRange</code> (expects ≥2 columns: Account, Amount), sums matching <code>AccountRefs</code> for each package line, and returns a matrix: <code>LineID</code>, <code>Amount</code>, <code>TBsum</code>, <code>Difference</code>. Keys are case-sensitive by default (use <code>UCase$</code> modification if case-insensitive matching required). Emits structured audit on completion. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Export & IO helpers</strong><br><code>ExportSheetToCsv(sh, filepath)</code> writes CSV with quoting rules and decimal separator normalization. Respects host security policy probe <code>Security_VerifyExportPathWritable</code> when present. <code>GetOrCreateSnapshotMetadataSheet</code> creates <code>_IFRS_Snapshots</code> as <code>xlSheetVeryHidden</code>. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Sanitization & naming</strong><br><code>SanitizeForCell</code> prevents formula injection. <code>SafeSheetName</code> strips invalid characters and enforces the 31-character Excel sheet name limit. <code>SafeTimestampCompact</code> formats compact timestamps for snapshot naming. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Audit & error integration</strong><br>All public entry points emit an entry audit via <code>SafeAuditStructured</code>. Error paths call <code>SafeHandleError</code> which attempts host <code>HandleError</code> → <code>modUtilities.HandleError</code> → fallback <code>AppendLocalAudit</code>. Logging uses <code>SafeLog</code> which attempts host <code>LogAudit</code> → <code>modUtilities.LogAudit</code> → <code>AppendLocalAudit</code>. This module intentionally defers to host helpers when available but functions offline with local audit fallbacks. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Host probing & extensibility</strong><br><code>HostHas</code>, <code>TryRun</code>, and <code>TryRunReturn</code> probe and invoke host/utility helpers (e.g., <code>SafeCreateSheet</code>, <code>ResolveWorkbook</code>, <code>DictToJsonStable</code>). The module caches <code>HostHas</code> results and prefers host implementations to allow global policy, signing, or security checks to be enforced by the host. Hooks: <code>MigrateStatementPackage</code> attempted during assembly if present. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Resilience & fallbacks</strong><br>Robust <code>On Error</code> handling; defensive typed getters (<code>NzStringDict</code>, <code>NzDoubleDict</code>, <code>NzVariantDict</code>) never raise. Bulk-write fallback: if batch write fails the code falls back to safe per-row operations in similar modules (Render/Flush patterns). Snapshot rename fallback uses temporary workbook move if direct rename fails. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Self-tests & release helpers</strong><br><code>ModStatements_SelfTest</code> runs deterministic checks: <code>NormalizeLines</code>, assemble→validate→render→reconcile round-trip, snapshot create/restore, CSV export; writes a test results sheet. <code>ModStatements_ReleaseChecklist(iterations)</code> runs <code>UtilitiesSelfTest</code> (if present) and repeats self-test iterations for release verification. <code>ModStatements_ConsistencyCheck</code> attempts to audit public member counts; will fall back when VBIDE access not available. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Security & operational guidance</strong><br>• Protect snapshot and metadata sheets (they are created <code>xlSheetVeryHidden</code> by default).<br>• Approve and review any host helpers invoked (<code>ResolveWorkbook</code>, <code>DictToJsonStable</code>, <code>SafeCreateSheet</code>) before enabling in production.<br>• Keep <code>Export</code> paths controlled; rely on <code>Security_VerifyExportPathWritable</code> host hook when available.<br>• Sanitize all user-provided text and avoid storing sensitive PII in <code>ContextJSON</code> or package <code>Lines</code> where possible. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Performance notes</strong><br>Batch writes via in-memory arrays are used for rendering and export to minimize interop cost. A <code>refsCache</code> reduces repeated normalization of <code>AccountRefs</code>. Use <code>SafeCreateSheetUnique</code> to avoid expensive rename conflict loops where possible. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Extensibility & recommended hooks</strong><br>• <code>MigrateStatementPackage(pkg)</code> — optional host migration hook called during assembly.<br>• <code>DictToJsonStable</code> / <code>GetStableJson</code> — prefer host implementation for consistent JSON signing/export.<br>• <code>Security_VerifyExportPathWritable(path)</code> — host-controlled export policy check.<br>Enable these hooks in audited/trusted environments to centralize policy, signing, and monitoring. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Troubleshooting checklist</strong><br>1. Missing audit entries → confirm host <code>SafeAuditStructured</code>/<code>LogAudit</code> availability or check <code>_IFRS_Audit</code> local fallback.<br>2. Snapshot rename failures → inspect sheet name collisions or workbook protection; <code>CreateStatementSnapshot</code> logs fallbacks and will delete failed copies.<br>3. Reconciliation mismatches → verify <code>AccountRefs</code> normalization, case-sensitivity, and <code>tbRange</code> columns. Use <code>GenerateReconciliation</code> output to inspect <code>Difference</code> column. <br>4. Export failures → check host <code>Security_VerifyExportPathWritable</code> return and file-system permissions. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Limitations & notes</strong><br>• Does not sign snapshots or package JSON by itself — integrate with host CI/release signing if signature/audit chaining required.<br>• Uses local time for some fallbacks; prefer host <code>GetUtcIsoTimestamp</code> for true UTC timestamps.<br>• Large packages beyond <code>MAX_LINES_THRESHOLD</code> are truncated with a log entry; increase threshold via configuration if needed. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Recommended operational checklist</strong><br>1. Ensure <code>Init</code>/host startup calls to set centralized helpers.<br>2. Run <code>ModStatements_SelfTest</code> during CI and <code>ModStatements_ReleaseChecklist</code> before production rollouts.<br>3. Store archives/snapshots on restricted, backed-up storage and enforce access control.<br>4. Regularly run <code>ValidateStatementPackage</code> and <code>VerifyAuditChain</code> (from <code>modAudit</code>) as part of monitoring and CI to detect integrity or schema drift. </td></tr></tbody></table></div><div class="row-count">Rows: 21</div></div><div class="table-caption" id="Table15" data-table="Docu_0158_15" style="margin-top:2mm;margin-left:3mm;"><strong>Table 15</strong></div>
<div class="table-wrapper" data-table-id="table-15"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modAudit + modStatementsHelpers"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modAudit + modStatementsHelpers</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Overview</strong><br>Two cooperating VBA modules: <code>modAudit</code> (append-only tamper-evident audit store) and <code>modStatementsHelpers</code> (stable IDs, deterministic metadata store and JSON, caption/TOC helpers, safe writes, and audit hooks). Designed for Excel/VBA with defensive fallbacks, delegation to optional helper modules (<code>modUtilities</code>, <code>modError</code>, <code>modAudit</code>), and CI-friendly self-tests. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Primary goals</strong><br><code>modAudit</code>: authoritative, cryptographically chained audit rows; buffered and synchronous writes; rotation & export; verification.<br><code>modStatementsHelpers</code>: deterministic metadata for "statements" (table ranges), atomic-ish writes with retries, deterministic JSON, migration helpers, and local structured audit fallback. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Sheets used</strong><br><code>_IFRS_Audit</code> — canonical audit rows (modAudit) or local structured audit (modStatementsHelpers fallback).<br><code>_IFRS_AuditMeta</code> — audit module runtime metadata.<br><code>_IFRS_Metadata</code> — statements metadata table (key, json) and schema info.<br><code>_IFRS_TestResults</code>, <code>_IFRS_CI</code> — self-test & CI artifacts. All created <code>xlSheetVeryHidden</code> / idempotently. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Canonical audit row schema</strong><br>Conceptual (CSV/JSON): <code>timestamp,correlationId,module,procedure,severity,userId,payloadHash,prevHash,signature</code>.<br<code>Implemented columns (modAudit sheet)</code>: <code>TimestampUTC,CorrelationID,Module,Procedure,Severity,ErrNum,WindowsUser,ExcelUser,Action,ContextJSON,PrevHash,Hash</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>modAudit public API</strong><br><code>InitAuditModule()</code> / <code>ShutdownAuditModule()</code> — lifecycle.<br><code>LogAudit(action,details)</code> — legacy convenience.<br><code>AppendAuditEntry(...)</code> — synchronous append (strong durability).<br><code>AppendAuditBuffered(entry)</code>, <code>FlushAuditBuffer()</code> — buffered batch writes with fallback per-row writes.<br><code>RotateAuditNow()</code>, <code>ExportAuditToCSV(path)</code>, <code>ExportAuditToJSON(path)</code> — archiving/export.<br><code>VerifyAuditChain(firstBadRow,diagnosticCode)</code>, <code>GenerateAuditDiagnosticReport(path,startRow)</code> — verification & diagnostics.<br><code>FindAuditByCorrelationID(id)</code>, <code>ReadAuditRow(row)</code> — lookups.<br><code>SetAuditFeatureFlag(name,val)</code>, <code>GetAuditFeatureFlag(name)</code> — runtime flags. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>modStatementsHelpers public API</strong><br><code>RenderSafeHtml(text)</code>, <code>ValidateStatementAssembly(range)</code>.<br><code>GetStableTableID(range, extraSeed)</code>, <code>AssembleStatementMetadata(range, extras)</code> — deterministic metadata builder.<br><code>GetTableMetadata(key)</code>, <code>SetTableMetadata(key,json,applyMigrationApproval)</code> — metadata store with atomic-ish writes & validation.<br><code>EnsureTableCaption(range,caption)</code>, <code>InjectTOCReference(range,tocId)</code> — caption/TOC helpers.<br><code>RunSelfTestsForCI()</code>, <code>SelfTest_ModStatementsHelpers()</code>, <code>AdditionalSelfTests_ModStatementsHelpers()</code> — self-tests. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Metadata schema & expectations</strong><br>Metadata JSON MUST include <code>&quot;schemaVersion&quot;: &lt;METADATA_SCHEMA_VERSION&gt;</code> (module constant).<br>Recommended fields: <code>stableId, sheet, headerSignature, rows, cols, workbookFingerprint</code>.<br><code>ValidateMetadataJson(json)</code> returns <code>0=OK,1=missing_schema_token,2=mismatched_version_token,3=invalid_format</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Stable IDs & fingerprints</strong><br><code>GetStableTableID</code> uses <code>GetWorkbookFingerprint</code> + header signature + optional seed → CRC32 hash → key prefix <code>tblmeta_</code> + hex.<br><code>GetWorkbookFingerprint</code> uses saved workbook path & last-modified where available, else VBProject name or workbook name. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Deterministic JSON serialization</strong><br><code>DictionaryToJson_MaxDepth(dict,depth,maxDepth)</code> performs case-insensitive stable key ordering (insertion-sort) and depth-limited traversal. Outputs UTF-8 string and truncates deterministically if > <code>JSON_OUTPUT_MAX_LENGTH</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Atomic-ish writes & retry policy</strong><br><code>TryWithRetry_WriteToSheet</code> performs writes to a temp column (<code>METADATA_TEMP_COL</code>) then copies sanitized value into JSON column to avoid formula injection and partially atomic behavior. Retries up to <code>MAX_RETRIES</code> with <code>RETRY_WAIT_SECONDS</code> backoff. Logs structured audit entries on success/failure. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Safe read/write helpers</strong><br><code>SafeWriteRange</code> / <code>SafeReadRange</code> perform write attempts with retries and <code>IsWorksheetWritable</code> checks (unprotect attempt). All cell writes sanitized via <code>SanitizeForCell</code> to prevent formula injection. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Chunking & large metadata handling</strong><br>Constants: <code>METADATA_MAX_LENGTH</code>, <code>METADATA_CHUNKING_ENABLED</code>, <code>METADATA_CHUNK_SIZE</code>. If metadata > <code>METADATA_MAX_LENGTH</code> and chunking enabled, <code>ChunkMetadataAndStore</code> splits into parts <code>stableKey_part_XXX</code> and writes a manifest <code>stableKey_manifest</code>. Default: chunking disabled; large writes rejected and audited. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>CRC32 policy, delegation & fallbacks</strong><br><code>CRC32_String</code> attempts delegate <code>modUtilities.CRC32_String</code> first via <code>TryRunExternal</code>. If missing: behavior controlled by constants <code>CRC32_DELEGATE_ONLY</code> and <code>CRC32_ALLOW_FALLBACK</code> and runtime setters via <code>SetCRC32Policy</code>. Local CRC fallback implemented (one-time audit emitted) and DJB2 fallback used on error. Hash provider decisions recorded in audit meta. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Hashing across modules</strong><br><code>modAudit</code> prefers SHA256 (system tool if allowed) → macro provider (if explicitly enabled) → CRC32 fallback. <code>modStatementsHelpers</code> relies on CRC32 delegate-first for deterministic stable ids/checksums. Coordinate policies to ensure consistent canonical hash usage in CI. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Redaction & PII handling</strong><br><code>modAudit.RedactSensitiveData</code> implements multiple regex rules (emails, SSNs, long numbers, JWTs, API keys, hex/base64 blobs). <code>modStatementsHelpers.RedactForAudit</code> provides heuristic redaction for metadata subject strings and truncation (<code>AUDIT_REDACT_TRUNCATE</code>). <code>g_aggressiveRedaction</code> (modAudit) and <code>m_chunkingEnabledRuntime</code> (modStatementsHelpers) control stricter behaviors. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Named ranges / TOC idempotency</strong><br><code>CreateNamedRangeForTOC</code> creates <code>ThisWorkbook.Names(&quot;TOC_&lt;sanitizedId&gt;&quot;)</code> idempotently: checks existing name -> compares referring address -> deletes and recreates if mismatched. Emits <code>CreateNamedRangeForTOC</code> audit. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Local structured audit fallback (modStatementsHelpers)</strong><br>If <code>modAudit.LogAudit</code> is unavailable, <code>Audit_LogStructured</code> attempts <code>Application.Run &quot;modAudit.LogAudit&quot;</code> then global <code>LogAudit</code> then falls back to <code>AppendLocalAuditStructured</code>. Local structured audit columns: <code>Timestamp,User,Action,Subject,CorrelationID,Outcome,Checksum,Algorithm,RowHash</code>. Row hash uses canonical CRC32. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Verification and diagnostics</strong><br><code>VerifyAuditChain</code> (modAudit) iterates rows verifying <code>PrevHash</code> and recomputed <code>Hash</code>. Diagnostic codes: <code>0 OK</code>, <code>1 MissingPrevHash</code>, <code>2 HashMismatch</code>, <code>3 Malformed/Other</code>.<br><code>GenerateAuditDiagnosticReport(path,startRow)</code> emits CSV with expected/actual prev/hash and reason. <code>RunRevisionVerification10()</code> (modStatementsHelpers) runs <code>CheckRevisionPlanCompliance()</code> 10x and verifies deterministic checksums. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Self-tests & CI hooks</strong><br><code>SelfTest_ModStatementsHelpers</code> and <code>AdditionalSelfTests_ModStatementsHelpers</code> exercise JSON serialization, CRC consistency, metadata write/read, size rejection, and write self-test results to <code>_IFRS_TestResults</code>.<br><code>RunSelfTestsForCI</code> performs delegate pre-checks, runs self-tests, migration dry-run, and outputs CI-visible failures to <code>_IFRS_CI</code>. Modules produce deterministic JSON status from <code>CheckRevisionPlanCompliance</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Migration & legacy keys</strong><br><code>MigrateLegacyMetadataIfNeeded(sh, applyChanges, approvalToken)</code> does a dry-run by default and builds a manifest of guessed stable keys; only renames when <code>applyChanges=True</code> and <code>approvalToken</code> provided. Manifest is audited via <code>Audit_LogStructured</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Error handling & delegation to global error handler</strong><br><code>HandleLocalError(proc,errNum,errDesc)</code> attempts to call <code>modError.HandleError</code> then global <code>HandleError</code> via <code>Application.Run</code> and falls back to local audit entry. Keep error handler available in environment for best operator visibility. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Constants & tunables</strong><br>Key constants to review: <code>AUDIT_MAX_ROWS_BEFORE_ROTATE</code>, <code>AUDIT_BATCH_FLUSH_THRESHOLD</code>, <code>MAX_CONTEXT_LENGTH</code>, <code>METADATA_MAX_LENGTH</code>, <code>JSON_OUTPUT_MAX_LENGTH</code>, <code>MAX_RETRIES</code>, <code>RETRY_WAIT_SECONDS</code>, <code>METADATA_CHUNK_SIZE</code>, <code>CRC32_DELEGATE_ONLY</code>, <code>CRC32_ALLOW_FALLBACK</code>. Configure per deployment security/performance requirements. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Security & operational guidance</strong><br>• Treat <code>g_allowExternalHashProvider</code> and <code>HashProviderMacroName</code> as sensitive — enable only in audited/trusted environments.<br>• Consider disabling <code>g_allowCommandExecution</code> on locked endpoints to avoid <code>certutil</code>/<code>shasum</code> execution.<br>• Protect audit & metadata sheets (workbook protection, file ACLs) and ensure archives are stored in access-controlled, immutable locations.<br>• Run <code>VerifyAuditChain</code> in CI/monitoring; any mismatch should trigger audit-compromise runbook. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Limitations & operator notes</strong><br>• <code>signature</code> field in conceptual canonical schema is not produced by default — signing should be done externally in release CI using the release manifest's signing key.<br>• System SHA256 depends on external tools; may be unavailable on some platforms → CRC32 fallback reduces cryptographic strength.<br>• Chunking is opt-in; large metadata is rejected unless chunking enabled and operator accepts chunked manifest semantics. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Troubleshooting checklist</strong><br>1. Hash mismatch on verify → run <code>GenerateAuditDiagnosticReport</code> and inspect <code>firstBadRow</code> & <code>diagnosticCode</code>.<br>2. Unexpected CRC/SHA provider usage → inspect <code>_IFRS_AuditMeta</code> provider counts and feature flags.<br>3. Metadata set failures → check <code>METADATA_MAX_LENGTH</code>, sheet protection, <code>TryWithRetry_WriteToSheet</code> logs, and <code>MAX_RETRIES</code> behavior.<br>4. CI self-test failures → examine <code>_IFRS_TestResults</code> and <code>_IFRS_CI</code> sheets for per-test diagnostics. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Recommended CI practices</strong><br>• Include <code>VerifyAuditChain</code> and <code>RunRevisionVerification10</code> in CI pipelines post-release and periodically.<br>• Export and sign audit archives from CI prior to distribution.<br>• Ensure <code>modUtilities</code> and <code>modError</code> delegates are present for full feature parity; failing that, review fallback audit entries. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Quick reference: common function behaviors</strong><br><code>GetTableMetadata(key)</code> — returns JSON or empty.<br><code>SetTableMetadata(key,json,apply)</code> — validates schema, enforces size caps, then <code>TryWithRetry_WriteToSheet</code>; returns Boolean.<br><code>AppendAuditBuffered(entry)</code> — enqueues; flush at threshold or manually.<br><code>FlushAuditBuffer()</code> — bulk write; on error falls back to per-row <code>AppendAuditEntry</code> and logs <code>FlushFallback</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Change log & revision plan compliance</strong><br><code>CheckRevisionPlanCompliance()</code> returns deterministic JSON summarizing implemented items and delegation health. Use <code>RunRevisionVerification10()</code> to prove idempotent deterministic output across runs. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Contact/operator checklist before enabling risky features</strong><br>Enable <code>allowExternalHashProvider</code> only after code review of the macro provider; enable <code>allowCommandExecution</code> only when OS-level tools are trusted and endpoint policies permit execution. Review retention and encryption policies for archived CSV exports. </td></tr></tbody></table></div><div class="row-count">Rows: 29</div></div><div class="table-caption" id="Table16" data-table="Docu_0158_16" style="margin-top:2mm;margin-left:3mm;"><strong>Table 16</strong></div>
<div class="table-wrapper" data-table-id="table-16"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modUtilities"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modUtilities</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modUtilities"> <strong>Overview</strong><br>Collection of hardened, backward-compatible utility routines for IFRS_Reporting_AddIn.xlam. Provides safe file I/O (atomic writes / workbook save), ADODB-aware UTF-8 handling, named-range caching, safe COM creation with negative cache, sheet and named-range helpers, CSV import/export streams, robust retry/backoff helpers, diagnostics and CI/self-test helpers. Designed for hostile/heterogeneous Excel hosts and constrained environments. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Public API (summary)</strong><br><code>EnsureCaches</code> / <code>ResetCaches</code> — initialize/clear module caches.<br><code>SafeLogAudit(src,msg)</code> / <code>SafeHandleError(proc,errNum,desc)</code> — centralized logging wrappers (delegates to <code>modAudit</code>).<br><code>ResolveWorkbook(target)</code> / <code>WorkbookFingerprint(wb)</code> — workbook resolution & fingerprinting.<br><code>SheetExists</code>, <code>SafeGetWorksheet</code>, <code>SafeCreateSheet</code>, <code>SafeDeleteSheet</code>, <code>BackupSheet</code> — sheet lifecycle helpers with safe naming & optional backups.<br><code>NamedRangeExists</code>, <code>GetNamedRangeValue</code>, <code>SetNamedRangeValue</code>, <code>CreateOrUpdateNamedRange</code>, <code>ClearNamedRangeCache</code>, <code>InvalidateNamedRangeCacheForWorkbook</code> — named-range helpers with LRU cache.<br><code>SafeWriteRange</code> / <code>SafeReadRange</code> — fast array-based range IO handling 0-/1-based arrays.<br><code>AtomicWriteFile(fullPath, content)</code> — atomic UTF-8-aware file writer with retries and diagnostic capture.<br><code>AtomicSaveWorkbookAs(wb, fullPath)</code> — robust SaveCopyAs + atomic replacement.<br><code>IsPathWritable</code>, <code>IsPathWritableEx</code>, <code>GetTempFolder</code>, <code>EnsureFolderPathEndsWith</code>, <code>ExpandTildePath</code> — path helpers.<br><code>StreamImportCsvLines(fullPath, lineHandlerName)</code> — UTF-8/BOM tolerant CSV line streaming to handler.<br><code>ExportRangeToCsv(rng, fullPath)</code> — CSV exporter (UTF-8 BOM) + atomic move.<br><code>CreateObjectSafe(progId)</code> — safe COM factory with negative caching TTL.<br><code>IsADODBStreamAvailable</code>, <code>GetADODBStream</code>, <code>IsCertutilAvailable</code>, <code>ComputeFileSHA256_Certutil</code> — environment probes & helpers.<br><code>RetryWithBackoffByName</code>, <code>SleepMs</code>, <code>WaitWithJitter</code> — retry utilities.<br><code>UtilitiesSelfTest</code>, <code>DuplicateUtilitiesAudit</code>, <code>BenchmarkSafeWriteRange</code>, <code>RunVerificationChecklist</code>, <code>GenerateVerificationReport</code> — diagnostics / CI helpers. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Configuration / constants</strong><br><code>TEMP_PREFIX = &quot;ifrs_util_&quot;</code>.<br><code>MAX_ATOMIC_ATTEMPTS = 5</code>.<br><code>DEFAULT_NAMEDRANGE_CACHE_MAX = 300</code>.<br><code>g_comNegativeCacheTTL</code> default = 600 seconds (configurable via <code>SetComNegativeCacheTTL</code>).<br><code>g_verboseAtomicDiagnostics</code> (Public) — when true, <code>AtomicWriteFile</code> emits structured JSON diagnostics to audit.<br><code>g_allowScriptletTypeLib</code> (Public, default False) — when True enables Scriptlet.TypeLib GUID generation for temp names (security-sensitive). </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Named-range cache behavior</strong><br>Per-workbook fingerprint key: <code>WorkbookFingerprint(wb) | rangeName</code>. Cache stores <code>(value, timestamp)</code>to implement LRU eviction. Size limited by<code>g_namedRangeCacheMaxSize</code>; <code>EnforceNamedRangeCacheLimit</code>evicts least-recently-used. Call<code>InvalidateNamedRangeCacheForWorkbook</code> on save/close to avoid stale entries. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>CreateObjectSafe (COM negative caching)</strong><br>Small <code>g_comCache</code> stores <code>{available As Boolean, lastFailTime, lastErrNum, category}</code>. If a ProgID previously failed and negative TTL not expired, <code>CreateObjectSafe</code> returns <code>Nothing</code> immediately. Positive entries are periodically revalidated; failures update negative cache. Use <code>SetComNegativeCacheTTL(seconds)</code> to tune. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>ADODB usage & fallbacks</strong><br>Where possible module uses <code>ADODB.Stream</code> for correct UTF-8 encoding/decoding and binary handling (<code>IsADODBStreamAvailable</code> probe). If ADODB not available, code falls back to binary or ANSI IO paths (<code>WriteToFileBinary</code>, native <code>Open ... For Binary</code>). Functions remain functional but may lose BOM/UTF-8 guarantees in those environments. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>AtomicWriteFile semantics</strong><br>Writes content to a temp file in the target folder (or discovered temp folder), attempts <code>Name tmp As target</code> (atomic rename). If rename fails, falls back to FSO <code>CopyFile</code> + delete. Retries up to <code>MAX_ATOMIC_ATTEMPTS</code> with exponential backoff + jitter. If ADODB available, writes BOM + UTF-8 bytes; supports both text and binary <code>content</code> (binary as byte array). On errors stores diagnostics in <code>g_lastAtomicWriteErr</code> and <code>g_lastAtomicWriteDiag</code>. When <code>g_verboseAtomicDiagnostics</code> is True, emits a structured audit entry including optional SHA256 (via <code>ComputeFileSHA256_Certutil</code> if available). </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>AtomicSaveWorkbookAs semantics</strong><br>Makes a local <code>SaveCopyAs</code> (or <code>SaveAs</code> fallback) to a temporary <code>.xlsx</code>, then atomically replaces destination using <code>Scripting.FileSystemObject</code> copy/delete loop with retries. Returns Boolean; sets <code>g_lastAtomicSaveErr</code> on failure and emits audit. Error codes mapped to <code>UTIL_ERROR_BASE</code> offsets. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>ExportRangeToCsv behavior</strong><br>Generates CSV RFC4180-safe escaping. If ADODB available writes UTF-8 with BOM using row-by-row temporary text stream conversion to binary stream (keeps memory usage moderate). Otherwise writes incremental ANSI via native <code>Open/Print</code>. After writing a tmp CSV, calls <code>AtomicWriteFileMove</code> to rename/copy atomically to destination. Emits <code>ExportAudit</code> entries on success/failure. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>StreamImportCsvLines behavior</strong><br>Preferred path: ADODB binary → set <code>Charset=&quot;utf-8&quot;</code> → <code>ReadText</code> → normalize line endings → iterate lines and call user <code>lineHandlerName</code> via <code>Application.Run</code>. Handles UTF-8 BOM removal and logs handler errors per-line rather than stopping. Fallback path uses native <code>Line Input</code> with BOM detection and same per-line handler invocation. Safe in large file contexts but processes whole file as text in ADODB path (careful for extremely large files). </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>CSV/Line handler contract</strong><br><code>lineHandlerName</code> is an <code>Application.Run</code> target accepting a single string argument. Handler exceptions are caught and logged; <code>StreamImportCsvLines</code> continues with next line. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Diagnostics & observability</strong><br><code>g_lastAtomicWriteErr</code> (Long) and <code>g_lastAtomicWriteDiag</code> (String) track last atomic write status. <code>g_lastAtomicSaveErr</code> for workbook saves. <code>UtilitiesSelfTest</code> logs results to audit; <code>RunVerificationChecklist</code> writes a JSON artifact via <code>AtomicWriteFile</code>. <code>DuplicateUtilitiesAudit</code> inspects VBProject for duplicate helper names and returns findings (will gracefully degrade when VBProject access is disabled). </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Safety & security considerations</strong><br>- <code>g_allowScriptletTypeLib</code> must be enabled only after security review (Scriptlet.TypeLib exposes GUID generation).<br>- <code>CreateObjectSafe</code> caches negative outcomes to reduce harmful repeated COM instantiation in hostile/locked-down hosts.<br>- <code>SafeLogAudit</code> delegates to <code>modAudit.LogAudit</code> only and purposely does not implement local fallbacks to avoid duplication/escape of sensitive audit flows.<br>- <code>g_allowCommandExecution</code> not present here; avoid enabling system command usage unless reviewed. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Error codes mapping (high level)</strong><br><code>UTIL_ERROR_BASE + 1</code> = <code>SafeCreateSheet</code> no workbook; <code>+2</code> = <code>BackupSheet</code> no temp path; <code>+10</code> = <code>AtomicWriteFile</code> generic; <code>+11</code> = <code>AtomicWriteFile</code> no writable folder; <code>+20..+23</code> = <code>AtomicSaveWorkbookAs</code> variants; <code>+30</code> = <code>AtomicWriteFileMove</code> move failed; <code>+31..+32</code> = <code>ExportRangeToCsv</code> errors. Modules should surface these codes via <code>SafeHandleError</code> when appropriate. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Retries & backoff strategy</strong><br>Exponential backoff with base 100ms and jitter up to 20% (<code>WaitWithJitter</code>). <code>MAX_ATOMIC_ATTEMPTS=5</code> by default. <code>RetryWithBackoffByName</code> is generic helper for invoking host macros with retries; it accepts a function name and optional args array. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Temp folder resolution & path normalization</strong><br><code>GetTempFolder</code> precedence: WScript env vars (<code>%TMP%</code>/<code>%TEMP%</code>) → POSIX env vars (<code>TMPDIR</code>, <code>HOME</code>) → <code>Application.DefaultFilePath</code> → workbook path → macOS AppleScript fallback. <code>EnsureFolderPathEndsWith</code> normalizes separators for the host OS. <code>ExpandTildePath</code> expands <code>~</code> using <code>$HOME</code> or <code>%USERPROFILE%</code>. Use <code>IsPathWritableEx</code> for diagnostic writable checks. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Self-test & CI helpers</strong><br><code>UtilitiesSelfTest</code> performs idempotent checks (parsing, atomic write, named-range cache, CreateObjectSafe negative cache probe, SafeWriteRange, ExportRangeToCsv) and logs outcomes. <code>RunVerificationChecklist(outputFile)</code> runs repeated self-tests, collects diagnostics and writes a JSON artifact atomically. <code>GenerateVerificationReport</code> returns a JSON string (no file write). Use these in CI to detect regressions. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Duplicate helpers detection</strong><br><code>DuplicateUtilitiesAudit</code> scans <code>ThisWorkbook.VBProject</code> for certain helper names and reports occurrences. It will return a friendly message when VBProject access is blocked (trust setting), so include it in CI but expect it to be a non-fatal diagnostic. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Best practices / recommended usage</strong><br>- Call <code>EnsureCaches</code> at add-in/workbook startup and <code>ResetCaches</code> on serious errors.<br>- Use <code>AtomicWriteFile</code> / <code>AtomicSaveWorkbookAs</code> for exports and critical artifacts to avoid partial writes.<br>- Use <code>SafeWriteRange</code> / <code>SafeReadRange</code> for bulk range IO to minimize COM calls.<br>- Run <code>VerifyAuditChain</code> (from <code>modAudit</code>) and <code>RunVerificationChecklist</code> as part of CI and periodic monitoring. Log results to centralized storage. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Operational troubleshooting checklist</strong><br>1. Unexpected <code>AtomicWriteFile</code> failure: inspect <code>GetLastAtomicWriteDiagnostic()</code> and <code>g_lastAtomicWriteErr</code>; check folder permissions and <code>IsPathWritableEx</code> reason.<br>2. Exports appear ANSI/mis-encoded: verify <code>IsADODBStreamAvailable</code> and ADODB availability on host.<br>3. CreateObject failures: check <code>g_comCache</code> entries and negative cache TTL; call <code>ResetCaches</code> to force retry during troubleshooting.<br>4. Missing audit entries from <code>SafeLogAudit</code>: ensure <code>modAudit</code> is present and <code>Application.Run &quot;modAudit.LogAudit&quot;</code> is callable in host.<br>5. Duplicate helper warnings: run <code>DuplicateUtilitiesAudit</code> and reconcile duplicate routines across workbooks/add-ins. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Limitations & known behaviors</strong><br>• Extremely large files read via ADODB path load full text into memory (<code>StreamImportCsvLines</code>) — consider streaming chunked handlers for multi-GB files.<br>• UTF-8 correctness depends on ADODB availability; non-ADODB fallback may produce ANSI-encoded outputs.<br>• <code>DuplicateUtilitiesAudit</code> relies on VBProject access; hosts may block it. <br>• <code>AtomicWriteFile</code> uses <code>Name</code> for atomic rename which may fail across volumes; fallback uses copy/delete with retries. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Examples (usage snippets)</strong><br><code>If Not AtomicWriteFile(path, text) Then SafeHandleError &quot;Save&quot;, GetLastAtomicWriteError(), GetLastAtomicWriteDiagnostic()</code><br><code>SetNamedRangeValue &quot;_cfg_debug&quot;, True</code> and later <code>InvalidateNamedRangeCacheForWorkbook</code> from workbook save handler.<br><code>StreamImportCsvLines csvPath, &quot;MyLineHandler&quot;</code> where <code>MyLineHandler(line As String)</code> is a public macro. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Maintenance & tuning</strong><br>- Increase <code>g_namedRangeCacheMaxSize</code> for heavy named-range workloads; call <code>EnforceNamedRangeCacheLimit</code> is automatic.<br>- Lower <code>g_comNegativeCacheTTL</code> during active troubleshooting to allow repeated COM instantiation attempts.<br>- Enable <code>g_verboseAtomicDiagnostics</code> temporarily to capture SHA256 checksums and richer audit traces; be mindful of sensitive path disclosure in audit payloads. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Appendix: quick reference — where to look in code</strong><br><code>AtomicWriteFile</code> (primary atomic writer): top-level; <code>WriteToFileBinary</code> (fallback writer); <code>ComputeFileSHA256_Certutil</code> (optional checksum); <code>ExportRangeToCsv</code> → <code>AtomicWriteFileMove</code>; <code>StreamImportCsvLines</code> (CSV import); <code>CreateObjectSafe</code> (COM factory); <code>UtilitiesSelfTest</code>, <code>RunVerificationChecklist</code>, <code>GenerateVerificationReport</code> (diagnostics). </td></tr></tbody></table></div><div class="row-count">Rows: 24</div></div><div class="table-caption" id="Table17" data-table="Docu_0158_17" style="margin-top:2mm;margin-left:3mm;"><strong>Table 17</strong></div>
<div class="table-wrapper" data-table-id="table-17"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Companion guide — sheet name and exact operator actions"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Companion guide — sheet name and exact operator actions</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Companion guide — sheet name and exact operator actions"> <strong>_IFRS_Audit</strong> — canonical audit rows (header present, sample row). <br><strong>Purpose:</strong> authoritative, append-only record of actions. <br>Verify presence of header exactly: <code>TimestampUTC,CorrelationID,Module,Procedure,Severity,ErrNum,WindowsUser,ExcelUser,Action,ContextJSON,PrevHash,Hash</code>. <br>Confirm <code>TimestampUTC</code> is ISO8601 UTC ending with <code>Z</code> (example: <code>2025-12-29T07:14:03Z</code>) and <code>CorrelationID</code> matches pattern <code>YYYYMMDD-HHMMSS-&lt;module&gt;-&lt;rand8&gt;</code> (example: <code>20251229-071403-bootstrap-3f7a9b2c</code>). <br><strong>Step-by-step checks:</strong> <br>(1) open <code>_IFRS_Audit</code> and read header; <br>(2) tail last N rows (recommended N=50) and inspect <code>Procedure</code>/<code>Action</code> entries for the operations you just ran; <br>(3) verify <code>PrevHash</code> is non-empty on chained rows and <code>Hash</code> changes each append; <br>(4) if expected rows missing, check <code>_IFRS_AuditMeta.BufferedCount</code> then re-run flush. <br><strong>Common failure modes:</strong> missing rows (add-in failed to write), broken chain (<code>PrevHash</code> empty), time skew (non-UTC timestamps). <br><strong>Evidence to collect:</strong> export last 50 rows as <code>IFRS_Audit_tail.csv</code>, compute SHA256 (<code>sha256sum IFRS_Audit_tail.csv</code>), and capture the first/last correlation IDs and their exact rows. </td></tr><tr><td data-label="Companion guide — sheet name and exact operator actions"> <strong>_IFRS_AuditMeta</strong> — audit meta keys (veryHidden). <br><strong>Purpose:</strong> runtime counts and provider status for hashing and flush timestamps. <br><strong>Keys to inspect:</strong> <code>LastFlushUTC</code>, <code>BufferedCount</code>, <code>HashProviderUsed:&lt;name&gt;</code>, <code>EnableMetaSheet</code>. <br><strong>Operator actions:</strong> <br>(1) unhide/open sheet with admin access; <br>(2) confirm <code>LastFlushUTC</code> updated after major operations (example: after audit flush event <code>LastFlushUTC</code> should be within the last 60s); <br>(3) confirm <code>BufferedCount=0</code> after running <code>FlushAuditBuffer</code>; <br>(4) check <code>HashProviderUsed</code> equals expected provider (e.g., <code>SHA256</code>) and log provider string. <br><strong>Troubleshooting:</strong> if <code>BufferedCount&gt;0</code> after flush, capture process logs (<code>ui.log</code>, <code>bootstrap.log</code>) and retry flush; escalate if provider missing. <br><strong>Evidence:</strong> screenshot of meta rows, plain text copy of <code>LastFlushUTC</code> and <code>BufferedCount</code>, and correlation id of the flush operation. </td></tr><tr><td data-label="Companion guide — sheet name and exact operator actions"> <strong>_IFRS_Metadata</strong> — bootstrap/config metadata (veryHidden). <br><strong>Purpose:</strong> store bootstrap identifiers and short runtime config values used at startup. <br><strong>Keys to verify:</strong> <code>BootstrapId</code>, <code>BootstrapVersion</code>, <code>BootstrapStartUtc</code>, <code>ScheduledProcedure</code>. <br><strong>Operator steps:</strong> <br>(1) open veryHidden <code>_IFRS_Metadata</code>; <br>(2) confirm <code>BootstrapId</code> exists and find the matching <code>CorrelationID</code> in <code>_IFRS_Audit</code> for startup sequence; <br>(3) confirm <code>BootstrapVersion</code> matches expected release; <br>(4) if scheduled jobs expected at bootstrap, confirm <code>ScheduledProcedure</code> populated. <br><strong>Evidence:</strong> copy of <code>_IFRS_Metadata</code> rows, screenshot of <code>BootstrapId</code>, and the audit row(s) that reference that <code>BootstrapId</code>. <br><strong>Notes:</strong> mismatched <code>BootstrapVersion</code> indicates deployment/version drift—do not proceed with further tests until resolved. </td></tr><tr><td data-label="Companion guide — sheet name and exact operator actions"> <strong>_IFRS_Jobs</strong> — job registry (sample job row). <br><strong>Purpose:</strong> track queued/scheduled background jobs for reconciliation and retries. <br><strong>Expected columns:</strong> <code>JobId,Handler,Status,ScheduledAt,LastError,Meta,CreatedAt,UpdatedAt,v2_migrated,Attempts,LastAttemptAt,RunDurationMs,CorrId,HandlerMeta</code>. <br><strong>How to read:</strong> <code>Status</code> may be <code>queued</code>, <code>scheduled</code>, <code>running</code>, <code>completed</code>, <code>failed</code>, <code>orphaned</code>; queued/scheduled jobs should have a <code>CorrId</code>. <br><strong>Operator steps:</strong> <br>(1) inspect rows sorted by <code>CreatedAt</code> or <code>ScheduledAt</code>; <br>(2) for <code>queued</code>/<code>scheduled</code> ensure <code>CorrId</code> present; <br>(3) for <code>orphaned</code> or repeatedly failing jobs inspect <code>Attempts</code> and <code>LastError</code>; <br>(4) to reconcile missing runs execute <code>Ribbon_ReconcileJobsOnOpen</code> or reschedule via <code>SafeOnTimeSchedule</code> equivalent; <br>(5) always append an audit row for any manual reconciliation. <br><strong>Evidence:</strong> CSV snapshot of job row(s) before and after reconciliation (<code>IFRS_Jobs_before.csv</code>, <code>IFRS_Jobs_after.csv</code>) and the audit rows showing manual actions. <br><strong>Warning:</strong> do not manually delete job rows without recording an audit entry. </td></tr><tr><td data-label="Companion guide — sheet name and exact operator actions"> <strong>_IFRS_TestResults</strong> — self-test artifacts (veryHidden). <br><strong>Purpose:</strong> deterministic outputs from module self-tests for CI and operator verification. <br><strong>Expected columns:</strong> <code>TimestampUTC,CorrelationID,TestKey,Result,Details</code>. <br><strong>Operator actions:</strong> <br>(1) run the self-test suite: <code>AddIn_RunInternalTests</code>, <code>CalculationsSelfTest</code>, <code>IFRS16SelfTest</code>, <code>IAS36_RunSelfTests</code> and <code>modAudit.VerifyAuditChain</code> in CI; <br>(2) confirm every <code>TestKey</code> row has <code>Result=PASS</code>; <br>(3) if <code>Result != PASS</code>, copy <code>Details</code> (error message, stack trace) and locate the corresponding <code>CorrelationID</code> in <code>_IFRS_Audit</code> to trace context; <br>(4) re-run failing tests after fixes. <br><strong>Evidence:</strong> export <code>_IFRS_TestResults</code> as <code>IFRS_TestResults.csv</code>, include failing rows (if any), and attach related <code>_IFRS_Audit</code> rows for the same correlation IDs. <br><strong>Note:</strong> deterministic tests are used for release gating—failures require triage before publishing. </td></tr><tr><td data-label="Companion guide — sheet name and exact operator actions"> <strong>_IFRS_ConfigSheet</strong> — fallback config storage (veryHidden). <br><strong>Purpose:</strong> hold full config XML when CustomXMLParts are unavailable; cell A2 contains XML payload. <br><strong>Operator actions:</strong> <br>(1) open <code>_IFRS_ConfigSheet</code> (veryHidden) and copy cell A2 to a safe file <code>IFRS_Config.xml</code> for checksum; <br>(2) inspect <code>SchemaVersion</code> and <code>IFRS.Config.Checksum</code> fields if present; <br>(3) do not edit directly without an approved change ticket. <br><strong>Verification:</strong> compute checksum of <code>IFRS_Config.xml</code> (<code>sha256sum IFRS_Config.xml</code>) and compare to <code>config.hash</code> recorded in <code>_IFRS_Audit</code> for the run. <br><strong>Evidence:</strong> <code>IFRS_Config.xml</code>, computed checksum file, and <code>_IFRS_Audit</code> row showing <code>config.hash</code>. <br><strong>Security note:</strong> redact secrets before archiving config copy. </td></tr><tr><td data-label="Companion guide — sheet name and exact operator actions"> <strong>_IFRS_Staging</strong> — import staging token and sample data. <br><strong>Purpose:</strong> safe staging area for imports; token <code>STAGING_SCHEMA_v1</code> in A1/A2 indicates module ownership. <br><strong>Usage and workflow:</strong> <br>(1) leave token in rows 1–2 unchanged; <br>(2) paste incoming rows under header row (row 3) according to skeleton; <br>(3) perform dry-run: <code>ImportTrialBalanceAdvanced(..., dryRun=True)</code> which creates <code>_IFRS_Preview</code> and <code>_IFRS_ImportErrors</code>; <br>(4) fix errors iteratively until preview contains no errors; <br>(5) after approval commit using <code>CommitStagingToDestination</code> or <code>add-in-cli import commit</code> which will back up the destination, copy rows into the target sheet, and append audit rows. <br><strong>Evidence:</strong> snapshot of <code>_IFRS_Staging</code> pre-commit (<code>Staging_precommit.csv</code>), <code>_IFRS_Preview</code> export, <code>_IFRS_ImportErrors</code> export, backup artifact, and commit audit row(s). <br><strong>Safety:</strong> never overwrite destination without creating backup and recording audit. </td></tr><tr><td data-label="Companion guide — sheet name and exact operator actions"> <strong>_IFRS_ImportErrors</strong> — import error samples. <br><strong>Purpose:</strong> explicit per-row validation error reporting for operator remediation. <br><strong>Expected columns:</strong> <code>Row,IFRS_RowID,ErrorCode,Message</code>. <br><strong>Operator remediation steps:</strong> <br>(1) for each error row open original <code>_IFRS_Staging</code> row and apply the suggested fix; <br>(2) re-run dry-run for the corrected row or batch; <br>(3) if error is systemic (schema mismatch, token missing), escalate to engineering and record decision in audit (skip/fix/escalate). <br><strong>Evidence:</strong> <code>IFRS_ImportErrors.csv</code>, corrected staging rows snapshot, and audit entries documenting operator decisions. <br><strong>Tip:</strong> include both original error row and corrected row in evidence to simplify audit trails. </td></tr><tr><td data-label="Companion guide — sheet name and exact operator actions"> <strong>KnownGoodWorkbook</strong> and <strong>_SelfTest</strong> — smoke-test reference. <br><strong>Purpose:</strong> canonical workbook used for smoke tests; <code>_SelfTest</code> records smoke results and sample action rows. <br><strong>Smoke test procedure (copy-ready):</strong> <br>(1) ensure Excel process not running (confirm no <code>EXCEL.EXE</code>); <br>(2) open <code>KnownGoodWorkbook</code> as installing/test user; <br>(3) allow bootstrap window (default timeout 12s unless configured otherwise); <br>(4) run SelfTest → Run; <br>(5) confirm <code>_SelfTest</code> row appended and correlated audit row in <code>_IFRS_Audit</code>. <br><strong>Evidence:</strong> copy of <code>KnownGoodWorkbook</code> with <code>_SelfTest</code>, <code>bootstrap.log</code>, <code>ui.log</code>, and last 50 rows from <code>_IFRS_Audit</code>. <br><strong>Failure conditions:</strong> bootstrap timeouts, missing <code>_SelfTest</code> row, or audit chain not appended—capture logs and raise an install ticket. </td></tr><tr><td data-label="Companion guide — sheet name and exact operator actions"> <strong>templates_v1</strong> — placeholder templates. <br><strong>Purpose:</strong> versioned presentation templates for statement rendering stored in repository by version and exposed via a skeleton sheet. <br><strong>Operator checks:</strong> <br>(1) verify <code>TemplateID</code> used for rendering appears in the release manifest; <br>(2) confirm an audit row references the template package when rendering was performed; <br>(3) never edit template artifacts directly in the workbook without change control. <br><strong>Evidence:</strong> release <code>manifest.json</code> entry with <code>TemplateID</code>, audit row showing template usage, and archived template package reference. <br><strong>Note:</strong> template edits must follow release process. </td></tr><tr><td data-label="Companion guide — sheet name and exact operator actions"> <strong>TrialBalance</strong> — sample trial balance. <br><strong>Purpose:</strong> canonical source for statement reconciliation; expected columns <code>Account,Amount</code> (and optional dimensions). <br><strong>Operator reconciliation steps:</strong> <br>(1) run <code>GenerateReconciliation</code>; <br>(2) verify the sum of differences is within <code>STATEMENT_BALANCE_TOLERANCE</code> configured in workbook or manifest; <br>(3) if adjustment required, produce a reconciliation manifest describing reason, adjustment rows, and attach to audit. <br><strong>Evidence:</strong> exported <code>TrialBalance.csv</code>, reconciliation report, reconciliation manifest, and reconciliation audit entry. <br><strong>Control:</strong> any manual adjustment requires approver and recorded justification. </td></tr><tr><td data-label="Companion guide — sheet name and exact operator actions"> <strong>_IFRS_Snapshots</strong> — statement snapshot metadata (veryHidden). <br><strong>Purpose:</strong> track snapshot names, package ids, correlation ids, schema version, created UTC, source sheet, and package JSON for reproducible exports. <br><strong>Naming convention:</strong> <code>_IFRS_StatementSnapshot_&lt;timestamp&gt;[_&lt;corr&gt;]</code>. <br><strong>Operator actions:</strong> <br>(1) create snapshot via <code>CreateStatementSnapshot</code>; <br>(2) export snapshot JSON and, if required, sign externally in CI; <br>(3) restore with <code>RestoreStatementSnapshot</code> which must append an audit row. <br><strong>Evidence:</strong> snapshot metadata row, exported <code>&lt;snapshot&gt;.json</code>, and signature file (if signed). <br><strong>Note:</strong> snapshots are veryHidden and intended for forensic/regulatory export. </td></tr><tr><td data-label="Companion guide — sheet name and exact operator actions"> <strong>_IFRS_Verify</strong> — verification log (10 iterations). <br><strong>Purpose:</strong> store automated verification runs used to validate workbook skeleton creation and canonical cell existence. <br><strong>Expected columns:</strong> <code>Iteration,OK,DetailsJSON</code>. <br><strong>Operator steps:</strong> after creating or modifying a workbook run the verification routine that creates/reopens the skeleton 10× and populates <code>_IFRS_Verify</code>; confirm <code>OK=true</code> for all iterations and review <code>DetailsJSON</code> for any missing cells. <br><strong>Evidence:</strong> exported <code>_IFRS_Verify.csv</code> included with install tickets or audit packages. <br><strong>Use case:</strong> required artifact when handing workbooks to auditors or for install approvals. </td></tr><tr><td data-label="Companion guide — sheet name and exact operator actions"> <strong>Next steps (concise, copy-ready)</strong> — immediate operator actions. <br><strong>Actions to perform now:</strong> <br>(1) place workbook on the controlled add-in testing share or local dev folder with ACLs restricting edit to owners; <br>(2) run smoke test against <code>KnownGoodWorkbook</code> and <code>_SelfTest</code>, collect <code>bootstrap.log</code>, <code>ui.log</code>, and <code>_IFRS_Audit</code> tail (last 50 rows); <br>(3) perform dry-run import into <code>_IFRS_Staging</code>, iterate fixes until <code>_IFRS_Preview</code> clean and export preview as CSV; <br>(4) execute self-tests and export <code>_IFRS_TestResults</code>; <br>(5) inspect <code>_IFRS_Jobs</code>, run <code>Ribbon_ReconcileJobsOnOpen</code> if manual reconciliation required and capture before/after job rows + audit; <br>(6) create statement snapshot via <code>CreateStatementSnapshot</code>, export JSON and sign in CI if required; <br>(7) archive all evidence (exports, logs, snapshots) into a secure forensic share with SHA256 checksums and manifest. <br><strong>Evidence naming conventions:</strong> <code>IFRS_Audit_tail.csv</code>, <code>IFRS_TestResults.csv</code>, <code>IFRS_Preview.csv</code>, <code>IFRS_Config.xml</code>, <code>&lt;snapshot&gt;.json</code>, <code>bootstrap.log</code>, <code>ui.log</code>, and <code>evidence_manifest.csv</code> with checksums. </td></tr><tr><td data-label="Companion guide — sheet name and exact operator actions"> <strong>If you want a variant</strong> — requestable options. <br><strong>Available variants (copy-ready):</strong> <br>(1) Protected workbook — skeleton with <code>veryHidden</code> sheets locked and workbook protected; provide password management/backout token stored in secure vault; <br>(2) Prepopulated named ranges — create defined names: <code>KnownGoodWorkbookRef</code>, <code>AuditHead</code>, <code>TrialBalanceRef</code>, <code>StagingTokenRef</code> for automation convenience; <br>(3) Signed export-ready archive — produce ZIP of workbook + JSON manifest, compute SHA256, and optionally provide CI-signed attest (requires external signing key). <br><strong>How to request:</strong> specify option number (1, 2, or 3) and desired filename; preparation includes verification steps listed above. </td></tr><tr><td data-label="Companion guide — sheet name and exact operator actions"> <strong>Audit statement (single sentence)</strong> — evidence copy. <br>“Workbook skeleton generated and verified 10×; key sheets <code>_IFRS_Audit</code>, <code>_IFRS_Jobs</code>, <code>_IFRS_TestResults</code>, <code>_IFRS_Staging</code>, <code>_IFRS_ConfigSheet</code>, <code>KnownGoodWorkbook</code>, and <code>_SelfTest</code> are present and contain sample rows; full verification log in <code>_IFRS_Verify</code>.” </td></tr></tbody></table></div><div class="row-count">Rows: 16</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>