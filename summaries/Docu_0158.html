<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>Tables Viewer v2.1</title>
<style>:root{--main-header-height:56px;} .table-wrapper{opacity:0;min-height:24px;transition:opacity .12s linear}</style>
<link rel="stylesheet" href="assets/style.css?v=1759925496">
<link rel="stylesheet" href="assets/overrides.css?v=1766850682">
</head><body>
<div id="tables-viewer" role="region" aria-label="Tables viewer">
<div id="stickyMainHeader">
<div id="tv-header">
<div><h1>Tables Viewer v2.1</h1></div>
<div style="display:flex;gap:8px;align-items:center;">
<input id="searchBox" class="tv-search" type="search" placeholder="Search" aria-label="Search tables" />
<button id="modeBtn" type="button" onclick="toggleMode()" aria-label="Toggle theme">Theme</button>
<button id="toggleAllBtn" type="button" aria-label="Toggle all" onclick="toggleAllTables()">Collapse All Tables</button>
<button id="copyAllPlainBtn" class="copy-btn" type="button" onclick="copyAllTablesPlain()" aria-label="Copy all tables as plain text">Copy All Tables (Plain Text)</button>
<button id="copyAllTablesBtn" class="copy-all-btn" type="button" onclick="copyAllTablesMarkdown()" aria-label="Copy All Tables (Markdown)">Copy All Tables (Markdown)</button>
<button id="copyAllMdBtn" style="display:none" aria-hidden="true"></button>
<button id="resetAllBtn" type="button" onclick="resetAllTables()" aria-label="Reset All Tables">Reset All Tables</button>
</div></div>
<script>
(function(){
  function ensureDelegation(){
    try {
      var vis = document.getElementById('copyAllTablesBtn');
      var alias = document.getElementById('copyAllMdBtn');
      if(!vis || !alias) return;
      alias.addEventListener = function(type, listener, options){
        vis.addEventListener(type, listener, options);
      };
      alias.removeEventListener = function(type, listener, options){
        vis.removeEventListener(type, listener, options);
      };
      Object.defineProperty(alias, 'onclick', {
        set: function(fn){ vis.onclick = fn; },
        get: function(){ return vis.onclick; },
        configurable: true
      });
      alias.focus = function(){ vis.focus(); };
      alias.blur = function(){ vis.blur(); };
    } catch(e) {
      try{ console && console.warn && console.warn('alias delegation failed', e); }catch(_){} 
    }
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ensureDelegation);
  } else {
    ensureDelegation();
  }
})();
</script>
<noscript><div style='color:#b91c1c'>JavaScript is disabled. Tables will be shown statically. For large tables enable JS for virtualization.</div></noscript>
<div id="tocBar" role="navigation" aria-label="Table of contents"><ul><li class="toc-item"><a class="toc-link" href="#Table1">Table 1</a></li>
<li class="toc-item"><a class="toc-link" href="#Table2">Table 2</a></li>
<li class="toc-item"><a class="toc-link" href="#Table3">Table 3</a></li>
<li class="toc-item"><a class="toc-link" href="#Table4">Table 4</a></li>
<li class="toc-item"><a class="toc-link" href="#Table5">Table 5</a></li>
<li class="toc-item"><a class="toc-link" href="#Table6">Table 6</a></li>
<li class="toc-item"><a class="toc-link" href="#Table7">Table 7</a></li>
<li class="toc-item"><a class="toc-link" href="#Table8">Table 8</a></li>
<li class="toc-item"><a class="toc-link" href="#Table9">Table 9</a></li>
<li class="toc-item"><a class="toc-link" href="#Table10">Table 10</a></li>
<li class="toc-item"><a class="toc-link" href="#Table11">Table 11</a></li>
<li class="toc-item"><a class="toc-link" href="#Table12">Table 12</a></li>
<li class="toc-item"><a class="toc-link" href="#Table13">Table 13</a></li>
<li class="toc-item"><a class="toc-link" href="#Table14">Table 14</a></li>
<li class="toc-item"><a class="toc-link" href="#Table15">Table 15</a></li>
<li class="toc-item"><a class="toc-link" href="#Table16">Table 16</a></li>
<li class="toc-item"><a class="toc-link" href="#Table17">Table 17</a></li>
<li class="toc-item"><a class="toc-link" href="#Table18">Table 18</a></li></ul></div></div>
<div class="table-caption" id="Table1" data-table="Docu_0158_01" style="margin-top:2mm;margin-left:3mm;"><strong>Table 1</strong></div>
<div class="table-wrapper" data-table-id="table-1"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide"> <strong>Document authority & scope</strong><br> This runbook is the single authoritative source for everything operators, developers, auditors, compliance reviewers and incident responders need to operate, maintain, verify, and audit the Excel add-in system. It defines responsibilities and procedures for design, development, deployment, incident response, auditability, and regulatory interactions. When guidance elsewhere conflicts with this document, this document prevails. Language here is prescriptive: follow steps exactly and record deviations in audit. This document is normative for operational work and evidence collection; sections labeled "MUST", "SHOULD", and "MAY" follow the same intent as RFC-style guidance where "MUST" is mandatory, "SHOULD" is recommended and requires justification if not followed, and "MAY" is optional. Any local adaptations require a compliance exception ticket and two-person approval recorded in audit. <br> <strong>Change history:</strong> every edit to this runbook MUST be recorded in the runbook's change log with author, date, rationale, linked PR/issue, and compliance sign-off when relevant. <br> <strong>Scope boundaries:</strong> this runbook governs the add-in codebase, packaged helpers, CI/CD pipeline gates affecting regulatory outputs, release manifests, audit chain design, and operational playbooks. It does not govern unrelated Excel macros, third-party add-ins, or external accounting systems except where direct integration is specified; those are covered by integration contracts described in appendices. </td></tr><tr><td data-label="Technical User Guide"> <strong>Audience</strong><br> This document is written to be usable by non-technical operators following step-by-step runbooks, by developers implementing deterministic calculations and migrations, by IT and release engineers performing upgrades and rollbacks, and by auditors and compliance teams verifying evidence. Each section provides background, commands or exact actions to perform, what to observe, expected outputs, and the evidence to collect for each scenario. Where skill-level matters, a header marks whether steps are Operator-level (no code), Engineer-level (requires credentials and terminal), or Developer-level (requires code-level changes and CI). Use the "Evidence to collect" checklists at the end of each procedural section to ensure artifacts are preserved for compliance. </td></tr><tr><td data-label="Technical User Guide"> <strong>Design principles (non-negotiable)</strong><br> The system is built around a small set of inviolable principles: determinism (same inputs + same config → same outputs), complete auditability (every judgment recorded), recoverability (jobs checkpointed and restorable), explicit failure (no silent corrections), immutable evidence (append-only audit chain), minimal direct Excel COM interactions, side-effect isolation, and strict reproducibility across supported environments. Any design or operational change that weakens these principles is disallowed without explicit compliance sign-off. Design reviews MUST include a determinism impact assessment and an auditability impact assessment. All code that touches regulatory outputs must include a canonical fixture and self-test. Any deviation from these principles requires a written risk assessment and two-person sign-off logged in audit. </td></tr><tr><td data-label="Technical User Guide"> <strong>Golden rule & mental model</strong><br> The guiding operational model is simple and must be repeated in training: Excel hosts the add-in; the add-in orchestrates work; heavy computation executes as jobs outside direct UI work; outputs are written atomically; and the audit is the system of record. If an action or result is not present in audit, it is not authoritative. Treat Excel as a UI and cache, not as the system of record. Users and operators must be trained to never rely on Excel worksheet contents as final evidence without verifying the audit chain and output checksums. The canonical mental model for incident triage:<br> 1) Verify audit entries and correlation id;<br> 2) Confirm job descriptor and job state;<br> 3) Reproduce deterministic compute in isolated runner with identical inputs and config;<br> 4) Validate produced artifact checksums against archived golden hashes. </td></tr><tr><td data-label="Technical User Guide"> <strong>Roles, responsibilities & SLAs</strong><br> Define and publish the primary roles (Product Owner, Release Engineer, Compliance Officer, Security Lead, On-call SRE, Support Engineer, Developer) and the RACI model for changes, incidents, and releases. Establish operational SLAs: production availability objectives, paging windows for critical incidents, response and acknowledgement times for on-call, and defined change-freeze periods (for example during financial close). All role assignments and escalation lists must be maintained in a visible roster and accessible from runbook links. <br> <strong>Minimum SLAs (example):</strong><br> Acknowledge critical page within 15 minutes, begin mitigations within 1 hour, run first forensic export within 3 hours, and produce interim status to stakeholders within 6 hours. SLA exceptions must be pre-authorized and recorded in audit. </td></tr><tr><td data-label="Technical User Guide"> <strong>Quick start & mandatory smoke tests (purpose & checklist)</strong><br> Always begin diagnosis with a short, repeatable smoke test that validates the add-in is fundamentally alive: close Excel completely, confirm no orphan EXCEL.EXE, start Excel as the installing user, open a known-good workbook, confirm ribbon initialization within the expected window, run the smallest built-in action (self-test), validate a progress indicator and the presence of an output or test-result sheet, and confirm an audit row has been appended with the action’s correlation id. If any step fails, stop and escalate following the Common Failures playbook — do not continue deeper troubleshooting without preserving evidence. <br> <strong>Smoke test steps (operator):</strong><br> 1) Close Excel and verify no EXCEL.EXE in Task Manager/ps.<br> 2) Launch Excel and open <code>KnownGoodWorkbook.xslx</code> (provided in artifacts).<br> 3) Wait maximum bootstrap window (configurable, default 12s).<br> 4) Trigger <code>SelfTest -&gt; Run</code>.<br> 5) Observe expected <code>_SelfTest</code> sheet and audit row with correlation id format <code>yyyyMMdd-HHMMSS-&lt;module&gt;-&lt;rand8&gt;</code>.<br> 6) Collect <code>bootstrap.log</code>, <code>ribbon.log</code>, and the generated audit row.<br> <strong>Expected outputs:</strong> ribbon initializes, self-test sheet present, audit row appended within 3 seconds of action, no error codes > WARN. <br> <strong>Evidence to collect:</strong> <code>bootstrap.log</code>, <code>ui.log</code>, <code>audit_tail.csv</code> (last 50 rows), copy of <code>KnownGoodWorkbook</code> with appended <code>_SelfTest</code> sheet. </td></tr><tr><td data-label="Technical User Guide"> <strong>Full lifecycle & control-flow (phases & guarantees)</strong><br> The add-in lifecycle has five phases: lightweight bootstrap (open logs, register shutdown hooks, do not perform heavy IO), deferred initialization (load config, verify dependencies, initialize audit buffers, resolve flags), idle-ready (ribbon handlers live and responsive), job scheduling & execution (jobs persist descriptors, execute with checkpoints, and produce audit rows), and completion/shutdown (atomic commits, audit flushes, and resource release). Each phase has explicit guarantees about what may and may not run there to avoid freezing Excel or losing audit fidelity. Determinism rules — inputs + config + flags + deterministic seed produce identical artifacts — are enforced and verified in CI. <br> <strong>Phase checks:</strong> at bootstrap confirm <code>bootstrap.started</code> log entry; at deferred init confirm <code>config.loaded</code> and <code>deps.reported</code>; at idle-ready confirm <code>ribbon.ready</code>; at scheduling confirm <code>job.persisted:&lt;jobid&gt;</code>; at completion confirm <code>audit.flushed:&lt;jobid&gt;</code> and <code>artifact.checksum:&lt;sha256&gt;</code>. </td></tr><tr><td data-label="Technical User Guide"> <strong>Module architecture and single-responsibility boundaries</strong><br> The add-in is intentionally modular. Each module has a tight single responsibility, explicit public interfaces, and a required audit contract. Modules must never duplicate centralized policies (config loading, audit writing, error mapping). This boundary discipline makes troubleshooting deterministic: when a symptom is observed, follow the ownership map to the responsible module and inspect its logs and audit rows before attempting corrective action. Ownership map is maintained in <code>OWNERS.md</code> and in the release manifest. When modifying or adding modules, include an ownership entry, interface contract (inputs/outputs), and a module-level audit schema. </td></tr><tr><td data-label="Technical User Guide"> <strong>modBootstrap responsibilities and verification</strong><br> modBootstrap brings the system to life safely — it opens structured logs, creates the correlation id generator, schedules deferred initialization on the UI idle loop, and registers process shutdown handlers. It must never perform heavy computation, network calls, or Excel Range access during bootstrap. Verify correct behavior by checking bootstrap logs for expected start and deferred-init scheduling entries. If bootstrap fails or the add-in is auto-disabled by Excel, document bootstrap logs and follow reinstall and permission-fix procedures. <br> <strong>Operator verification steps:</strong> confirm <code>init-scheduled</code> and absence of long-blocking calls in <code>bootstrap.log</code>; collect <code>excel-register-state</code> (COM/VSTO registration keys) and Windows event logs if auto-disable occurred. </td></tr><tr><td data-label="Technical User Guide"> <strong>modRibbonCallbacks responsibilities and verification</strong><br> Ribbon callbacks map each control id to exactly one handler. Handlers perform lightweight validation and either execute trivial actions inline or schedule jobs for heavy work. Every click must produce a structured log entry with control id and correlation id, and an audit UserAction row. If buttons are unresponsive, inspect customUI resources, Ribbon_OnLoad logs, and the click mapping — repair the resource or re-register callbacks rather than modifying behavior ad-hoc. Maintain a canonical <code>ribbon-map.json</code> in the repo documenting control id → handler mapping and required permissions. </td></tr><tr><td data-label="Technical User Guide"> <strong>modConfig responsibilities and governance</strong><br> Config is the single source of runtime truth: load once, validate schema, apply idempotent migrations before use, and treat resolved values as immutable for the running process unless changed through controlled update flows. Missing keys must be replaced by safe defaults; the system must never crash on absent or extra keys. Any change to configuration that impacts regulatory computations must follow the change-control policy (ticketing, two-person approval where required, migration manifest, and audit entries recording operator and rationale). <br> <strong>Config format:</strong> JSON Schema v7 with versioned namespace <code>config.v&lt;major&gt;</code>. Example minimal fragment provided in the Appendices. Include a <code>config.hash</code> in the release manifest and in audit rows that reference the config used for a run. </td></tr><tr><td data-label="Technical User Guide"> <strong>EnsureDeps responsibilities and behavior</strong><br> EnsureDeps validates that required platform runtimes, helper executables, OS features, and permission contexts are present. It distinguishes degradable features (where functionality can be reduced with a graceful message) from critical features (which block execution). EnsureDeps writes a dependency report to structured logs and audit when critical dependencies are missing and prescribes exact remediation steps to operators, avoiding guesswork. <br> <strong>Example outputs:</strong> <code>deps.report.json</code> listing each dependency, status, remediation commands, and whether it is <code>CRITICAL</code> or <code>DEGRADABLE</code>. </td></tr><tr><td data-label="Technical User Guide"> <strong>modUtilities responsibilities</strong><br> All shared low-level behavior is centralized: atomic write semantics, temporary file management, deterministic rounding (SafeRound), date normalization according to canonical calendar policy, progress reporting, and retry/backoff helpers. No other module may implement its own file writing, rounding, or retry logic. Centralization preserves determinism and simplifies cross-language parity testing. Utilities are versioned and their API contract is covered by unit tests and integration fixtures. Utility changes require cross-language parity checks if counterparts exist in other runtimes. </td></tr><tr><td data-label="Technical User Guide"> <strong>modDataInput responsibilities and validation rules</strong><br> modDataInput normalizes messy human inputs (type coercion, date parsing, trimming), enforces schema-level validation, and produces a line-level Validation_Report that includes a stable error code, human-friendly message, and a suggested remediation. Invalid rows must be surfaced explicitly and not silently dropped; operator options to fix or skip must be recorded in audit. Validation error codes are stable and documented for CI and support use. Validation reports are stored in <code>validation/&lt;run-id&gt;/report.csv</code> and persisted in artifact storage for compliance. </td></tr><tr><td data-label="Technical User Guide"> <strong>modCalculations responsibilities and determinism rules</strong><br> All domain calculations are deterministic and executed in-memory without Excel Range calls inside hot loops. Use ordered data structures to avoid non-deterministic iteration ordering. Perform bulk writes to Excel only at defined commit points and ensure calculations are repeatable across supported runtimes and platforms using canonical test vectors. If floating-point behavior could differ between runtimes, apply normalization and SafeRound consistently to ensure byte-for-byte artifact parity. For large jobs, shard deterministically (e.g., by stable hash partition) and document shard boundaries in job descriptors. </td></tr><tr><td data-label="Technical User Guide"> <strong>modExport responsibilities and integrity guarantees</strong><br> Exports must validate destinations (permissions, path existence), use atomic write semantics (write to temp then move/replace), compute and record integrity checksums in audit, retry deterministically on transient failures, and support staged local delivery when network destinations are unavailable. Export fallbacks and final delivery must be audited and operators must be provided explicit remediation steps when manual intervention is needed. Exports include <code>artifact.checksum.sha256</code>, <code>destination.uri</code>, <code>delivery.attempts</code>, and <code>final.status</code> in audit. </td></tr><tr><td data-label="Technical User Guide"> <strong>modStatements / templating responsibilities</strong><br> Presentation templates are separate, versioned assets. Code fills values into templates but must never hardcode layout or formulas. The templating system validates post-generation that all expected fields are present and that formulas are intact. Template versions are recorded in the release manifest so auditors can see which template version produced a given artifact. Keep templates in <code>templates/v&lt;major&gt;.&lt;minor&gt;/</code> and include a test that verifies placeholder coverage and that all required placeholders are replaced. </td></tr><tr><td data-label="Technical User Guide"> <strong>Regulatory core modules (modIFRS15, modIAS36, modIFRS16)</strong><br> Regulatory modules implement accounting standards precisely and deterministically. Every material judgment and parameter (discount rates, variable-consideration estimators, rounding modes) must be auditable and versioned. Each module provides canonical fixtures and self-tests; results must match golden artifacts in CI. Any change to calculation behavior requires compliance review, CI rerun against canonical fixtures, and a migration plan for historical data as necessary. Judgmentable parameters must be surfaced in configuration along with approval records. </td></tr><tr><td data-label="Technical User Guide"> <strong>modIFRS15 — responsibilities and lifecycle</strong><br> The modIFRS15 pipeline is explicit: input normalization, schema validation, variable consideration evaluation, deterministic allocation (including SafeRound and deterministic residual absorption), recognition schedule generation, journal entry mapping, and disclosure artifact production. Each step emits audit entries with correlation ids and a snapshot of redacted inputs, outputs and decisions. Preserve backward-compatible APIs and provide a “forceRecompute=false” path to accept precomputed Analysis where permitted, while still validating and auditing preserved allocations. <br> <strong>Critical audit fields:</strong> <code>ContractID</code>, <code>RunID</code>, <code>ModuleVersion</code>, <code>ParameterSetID</code>, <code>DecisionTrace</code> (redacted), and <code>ArtifactChecksum</code>. </td></tr><tr><td data-label="Technical User Guide"> <strong>modIFRS15 — input shape, validation, and error codes</strong><br> The contract object schema requires ContractID, ContractDate, TransactionPrice, ContractCurrency, Parties and a PerformanceObligations array with required PO fields. Validation returns stable, enumerable error codes (documented in appendices) and a Validation_Report that operators use to remediate input data. Error codes are used in monitoring to create actionable dashboards and in CI to flag regressions. Provide a remediation UI flow that suggests minimal edits, and require operator sign-off for skipped rows. </td></tr><tr><td data-label="Technical User Guide"> <strong>modIFRS15 — allocation, SafeRound, and residual absorption rules</strong><br> Allocation follows a deterministic recipe: canonicalize inputs, optionally preserve precomputed allocation if allowed, compute expected variable consideration per configured strategy, apply the variableConstraintThreshold reserve rules, compute raw proportional allocations to standalone prices, perform SafeRound with configured precision and midpoint-away-from-zero semantics, compute residual and deterministically absorb it into a chosen PO via a deterministic tie-breaker (largest standalone, then stable POID hash). Every micro-decision is recorded in audit to support forensic review and regulator queries. Include a <code>DecisionTrace</code> that lists intermediate numeric values (redacted when containing PII). </td></tr><tr><td data-label="Technical User Guide"> <strong>modIFRS15 — recognition schedule and journal mapping rules</strong><br> Recognition schedules are output as explicit periodized rows (ContractID, POID, PeriodIndex, PeriodStart, PeriodEnd, Amount, RecognitionMethod). Time-based and point-in-time methods are supported with safety clamps for maximum periods and configurable business-day adjustments. Each schedule row deterministically maps to journal lines using configured GL mapping; journal entries are created idempotently using deterministic JournalIDs and recorded with checksums and path metadata. Reconciliation tooling consumes these artifacts to verify accounting ledgers. Provide a standard reconciliation manifest format and automated diff tooling to compare expected vs posted journals. </td></tr><tr><td data-label="Technical User Guide"> <strong>modIFRS15 — disclosures and PII policy</strong><br> Disclosure artifacts summarize unsatisfied performance obligations, significant judgments, and sensitivity analyses while excluding customer-specific PII by default. When regulators require customer-level disclosure, include only redacted or encrypted identifiers under a documented compliance-approved workflow. All disclosure generation actions and resulting artifact checksums are written to audit for evidence and archival. Maintain a <code>de-redaction</code> process that is strictly governed and logged whenever granular identifiers are re-associated. </td></tr><tr><td data-label="Technical User Guide"> <strong>modIFRS15 — self-test harness and CI integration</strong><br> The IFRS self-test suite includes canonical fixtures covering normal and edge cases (zero standalone totals, variable-consideration scenarios, rounding edge cases, and large-PO batches). Self-tests export hidden <code>_IFRS_TestResults</code> sheets with expected vs actual hashes; CI requires byte-for-byte parity with golden files before a change is accepted. Test failures block releases and must be remediated per change-control procedures. Include a checksum verification step in CI that asserts <code>sha256(artifact) == golden_sha256</code>. </td></tr><tr><td data-label="Technical User Guide"> <strong>modIAS36 and modIFRS16 authoritative notes</strong><br> Implemented models must record discount rate sources, model versions, and key sensitivities used in impairment (IAS36) and lease accounting (IFRS16) computations. Reversal logic, remeasurement behavior, treatment of lease incentives and initial direct costs, and modification rules are explicitly documented and audited. Test fixtures exercise typical, modified, terminated and extended lease scenarios. Each calculation run publishes a <code>ModelAudit</code> containing model inputs, version, and sensitivity seeds. </td></tr><tr><td data-label="Technical User Guide"> <strong>modAudit — authoritative system of record and chain verification</strong><br> Audit is append-only and cryptographically chained. Audit rows include timestamps, correlation ids, module names, procedure names, severity, user identifiers and a context payload with redaction applied. Audit buffers improve performance but must flush within configured intervals; rotated audit archives are created and indexed for long-term retention. VerifyAuditChain procedures must be run in CI and as part of monitoring to detect mismatches early; any mismatch triggers the audit-compromise runbook. <br> <strong>Audit row canonical schema (CSV/JSON):</strong> <code>timestamp,correlationId,module,procedure,severity,userId,payloadHash,prevHash,signature</code>. Signatures are produced by the signing key associated with the release manifest. </td></tr><tr><td data-label="Technical User Guide"> <strong>modError — centralized error taxonomy and operator messaging</strong><br> Internal exceptions are classified into stable error codes and mapped to operator-facing remediation guidance. No stack traces or raw automation errors should be exposed to end users; instead every error message includes a correlation id that ties logs and audit to the user-visible message. The mapping table is part of the appendices and used by support staff for quick remediation. Maintain an <code>ErrorCodeCatalog.md</code> and include sample remediation steps per code. </td></tr><tr><td data-label="Technical User Guide"> <strong>Configuration & feature flag governance</strong><br> Feature flags carry metadata (id, default, type, scope, required approvals). Resolution precedence is explicit (runtime admin overrides > server-managed remote flags > registry overrides > local config > code default). Flags that affect financial or regulatory outputs require two-person approval and audit meta entries. Canary enablement and emergency kill-switch changes are audited and replayable. Provide a flag roll history API and a <code>flag.change</code> audit entry for every resolution change. </td></tr><tr><td data-label="Technical User Guide"> <strong>Canary and phased rollout patterns</strong><br> Rollouts use explicit cohort selection (tenant id, allowlist, or user attribute), staged percentage expansion, and automated gating by KPIs (error rate, audit fallback rate, checksum mismatches). At each stage run IFRS self-tests and audit-chain verifications on samples. If thresholds are crossed, automatically revert the flag and enter the incident runbook. Log all observations and roll decisions in audit to support post-mortem compliance evidence. Maintain a rollback window and require sign-off for re-exposure. </td></tr><tr><td data-label="Technical User Guide"> <strong>Config migration policy and offline migration tooling</strong><br> Schema migrations are idempotent and accompanied by a migration manifest that lists transformations and affected counts. Provide an offline migration tool supporting dry-runs and sample transformations for auditor inspection. Migration runs must create audit migration rows summarizing what changed, who ran the migration, and sample before/after records for compliance review. Migration runs include <code>dryRun</code> logs, <code>affectedCount</code>, <code>sampleIds</code>, and <code>backoutPlan</code> in the manifest. </td></tr><tr><td data-label="Technical User Guide"> <strong>Runtime debug and safe-ops mode</strong><br> Provide an admin-only debug panel to toggle verbose logging, force deferred initialization, flush audit buffers, export diagnostics and temporarily toggle transient flags. Every debug action requires permission checks, writes an audit row describing operator, time, and reason, and is recorded for compliance review. Debug mode defaults to off and must be disabled after troubleshooting. Access to the panel requires multi-factor auth and an access ticket and is periodically audited. </td></tr><tr><td data-label="Technical User Guide"> <strong>Security operations & incident response (IR) playbook</strong><br> The IR playbook prescribes triage decision trees, immediate containment steps, and evidence collection procedures tailored for the add-in: isolate suspected PII exfiltration routes, disable network exports, quarantine helper executables, export rotated audit archives to a secure forensic share, and preserve process and environment snapshots. All containment and remediation actions are audited and forensics artifacts preserved with checksums and chain-of-custody metadata. <br> <strong>IR communications:</strong> use pre-approved templates for customer/regulatory notifications and include a list of required attachments. </td></tr><tr><td data-label="Technical User Guide"> <strong>Incident evidence collection requirements</strong><br> When investigating incidents collect rotated audit CSVs, bootstrap and runtime logs covering the timeframe, config snapshots, registry exports, job descriptors from job stores, helper binaries and their signatures, correlation ids associated with the event, and environment metadata (Excel bitness, OS version, add-in version). Store evidence in a secure forensic share and record checksums and transfer logs in audit. Maintain a <code>forensic_evidence_manifest.json</code> listing files, checksums, collection time, collector identity, and destination URI for chain of custody. </td></tr><tr><td data-label="Technical User Guide"> <strong>Containment, remediation and post-incident activities</strong><br> Containment may involve setting audit to read-only, turning off network exports, or disabling helper execution. Remediation typically requires restoring components from signed artifacts, rotating credentials and secrets, re-running critical jobs in an isolated environment and validating outputs against preserved checksums, and if audit corruption occurred restoring from the last verified rotation under compliance supervision. Produce a full post-mortem with timeline, root cause, remediation, and preventive changes, and implement follow-on CI/monitoring checks to prevent recurrence. Post-incident, run full VerifyAuditChain and self-tests before the system returns to normal operation. </td></tr><tr><td data-label="Technical User Guide"> <strong>Deployment, upgrade, migration and rollback runbooks (prescriptive)</strong><br> Pre-deployment checks require signed artifacts, passing CI gates including IFRS self-tests and audit verification, config snapshots and backup of audit rotations, and stakeholder notifications. Canary rollouts advance through explicit cohorts with IFRS self-tests and audit verification performed at each step. Emergency rollback includes triggering the kill-switch, revoking server overrides, reinstalling the previous signed build, restoring config snapshots where needed, running IFRS self-tests and VerifyAuditChain prior to resuming, and recording the rollback event in audit with operator and reason. All deployment steps are executed from the Release Engineer's console using signed credentials and produce a <code>deployment.audit</code> row for each phase. </td></tr><tr><td data-label="Technical User Guide"> <strong>CI/CD gating, automated tests and artifact policy</strong><br> CI pipelines must include lint, unit, integration, IFRS self-tests, audit chain verification, performance microbenchmarks, signing, and publishing artifacts to immutable storage. Release artifacts must be signed, accompanied by a manifest with build hash and signing fingerprints, and only published after all gates pass. Regulated releases also require manual compliance sign-off recorded in the deployment manifest and audit. CI must run VerifyAuditChain for sample runs and fail the pipeline on any mismatch. Artifacts are immutable once published; patch releases follow a formal patch manifest protocol. </td></tr><tr><td data-label="Technical User Guide"> <strong>Performance metrics, thresholds and remediation actions</strong><br> Instrument and collect metrics including add-in startup time, deferred init time, audit flush latency, job queue length, export error rate, and process memory. Document explicit warn and critical thresholds for each metric and prescriptive remediation steps — for example reduce audit batch size or increase flush frequency when audit flush latency rises, throttle new job scheduling or increase worker counts when queue length is excessive, and enable local staging fallback when network export error rates cross thresholds. Provide an operations mapping: metric → detection threshold → immediate action → escalation path. </td></tr><tr><td data-label="Technical User Guide"> <strong>Production monitoring, dashboards and alerting playbook</strong><br> Maintain Support, Ops, and Compliance dashboards that surface real-time health: recent errors, top error codes, audit fallback events, job queue state, resource utilization, and audit chain verification status. Alert payloads must include initial triage steps, logs to collect, runbook links, correlation id, and on-call contact. Critical alerts should auto-page stakeholders and create conference bridges, while less-critical alerts are routed through standard escalation. Dashboards must include visualizations for audit integrity checks and a quick-action panel to trigger a forensic export. </td></tr><tr><td data-label="Technical User Guide"> <strong>High-severity incident runbooks (three canonical examples)</strong><br> Provide fully prescriptive runbooks for audit chain compromise (isolate writes, export rotations, run VerifyAuditChain, and reconstruct or restore under compliance rules), helper executable compromise (quarantine binary, rotate credentials, rebuild signed helper, redeploy after validation), and mass export failures (pause exports, enable local staging fallback, diagnose network/permission issues, replay exports with checksums). Each runbook includes required evidence, notification steps, verification checks, and post-mortem templates. Each high-severity runbook includes a dedicated checklist and owner roster for immediate paging. </td></tr><tr><td data-label="Technical User Guide"> <strong>Appendices and canonical artifacts</strong><br> Maintain appendices with canonical audit CSV row formats, recognition schedule samples, config schema keys and types, IFRS fixture descriptions for CI, diagnostic checklist contents for reproducible bug reports, operator cheat-sheets, and compliance & audit sign-off templates — all versioned and stored in immutable artifact storage for auditor access. Appendices include sample JSON snippets, CSV headers, and golden-file checksums to support automated verification. </td></tr><tr><td data-label="Technical User Guide"> <strong>Reconciliation, correction and migration procedures</strong><br> Provide reconciliation tooling and a controlled process for producing correction journals: run reconciliation in isolated environment against immutable input snapshots, produce reconciliation manifests listing impacted contracts and adjustments, require audit logging of all correction entries with reconciliation ids and rationale, and ensure all corrective actions are reversible and documented for audit. Bulk reruns are permitted only under defined governance and with full evidence capture. Use <code>reconciliation.run</code> in safe mode first (<code>--dry-run</code>) and capture <code>reconciliation.report.json</code> before applying corrections. </td></tr><tr><td data-label="Technical User Guide"> <strong>Data protection, PII handling, encryption and key management</strong><br> Classify PII fields and enforce deterministic redaction in disclosure artifacts; store audit archives and exported artifacts encrypted using envelope encryption with managed keys; enforce key rotation schedules; forbid secrets in files; and restrict access to de-redaction artifacts to auditors with logged access. All key rotation and access events are recorded in audit. Use an HSM-backed key management service for signing audit rotations and require multi-person approval for key material export. </td></tr><tr><td data-label="Technical User Guide"> <strong>Operational procedures and operator commands (conceptual)</strong><br> Provide concise but exact operator checklists for common tasks: verifying add-in registration and COM/VSTO entries, collecting diagnostic bundles (logs, audit rotations, config snapshot, input sample), flushing audit buffers, re-queuing or canceling jobs, toggling safe-ops flags, and performing controlled rollbacks. Every operator action that changes runtime state must append an audit row with operator identity, reason, and correlation ids. <br> <strong>Canonical operator commands (examples):</strong><br> <code>diagnostics collect --run-id &lt;id&gt; --out &lt;path&gt;</code>, <code>audit flush --immediate</code>, <code>jobs requeue --job-id &lt;id&gt;</code>, <code>exports stage-local --artifact &lt;id&gt;</code>. Ensure CLI tools authenticate via operator SSO tokens and produce signed audit events. </td></tr><tr><td data-label="Technical User Guide"> <strong>Testing, fixtures and golden-file governance</strong><br> Golden fixtures are stored in an immutable repository and any change requires a documented PR with rationale and approvals from Development and Compliance. CI compares produced artifacts against golden hashes and blocks changes unless a migration manifest and compliance sign-off are present. The test matrix covers supported OS versions, Excel bitness, locales and runtime combinations to catch environment-dependent regressions. Include locale-based fixtures for date/time and numeric formatting to catch regional differences. </td></tr><tr><td data-label="Technical User Guide"> <strong>Release manifest, artifact signing and verification</strong><br> Each release includes a manifest describing build id, artifact hashes, signer identity, test pass/fail summaries, and compliance approvals. Artifacts are code-signed and verified at deployment time; manifest and signing records are appended to audit and stored in immutable artifact stores for later verification by auditors. Release manifests include <code>buildId</code>, <code>commitHash</code>, <code>artifactList</code>, <code>signingFingerprint</code>, <code>ciSummary</code>, and <code>complianceApproval</code>. Verification is automated in deployment orchestration and fails fast on any mismatch. </td></tr><tr><td data-label="Technical User Guide"> <strong>Housekeeping, retention and scheduled maintenance</strong><br> Define audit rotation retention and archival cadence, scheduled temp cleanup windows when Excel is not running, routine kill-switch tests, dependency verification checks, and the cadence for running self-tests in staging. Retention policies reflect regulatory requirements and are implemented with secure archives and evidence of successful archival operations in audit. <br> <strong>Typical retention schedule:</strong> hot audit rotations (30 days), warm archive (7 years), cold deep archive (as required by regulation). Automate retention verification monthly and log results in <code>housekeeping.audit</code>. </td></tr><tr><td data-label="Technical User Guide"> <strong>Governance, approvals and change control</strong><br> Any change affecting allocation, journal generation, or other regulatory outputs requires two-person approval, documented test evidence, migration manifests, and explicit entries in the deployment manifest and audit. Maintain RACI clarity for owners of fixes and ensure compliance sign-off is mandatory for policy-impacting changes. All approvals must be recorded with operator id, timestamp, scope, and link to evidence artifacts. </td></tr><tr><td data-label="Technical User Guide"> <strong>Operator cheat-sheets and run-to-resolution flows</strong><br> Provide short, copy-ready one-page sequences for common incident types: invoice reconciliation differences, missing dependencies, export failures, audit mismatches. Each cheat-sheet lists required artifacts to collect, immediate verification commands or checks, containment actions, and escalation paths; operators must follow the listed steps and record actions in audit. Cheat-sheets are stored in <code>runbooks/cheatsheets/</code> and must be updated when major process changes occur. </td></tr><tr><td data-label="Technical User Guide"> <strong>Templates for post-mortem, change request and regulatory packages</strong><br> Supply standardized templates capturing incident timeline, detection, root cause, remediation, permanent fixes, preventive controls, owners and deadlines, and evidence attachments. Regulatory packages include release manifest, audit rotations for date ranges, migration audit entries, and anonymized sample inputs and outputs that demonstrate deterministic behavior. Templates include mandatory fields and an evidence checklist to ensure completeness for regulator submission. </td></tr><tr><td data-label="Technical User Guide"> <strong>Final absolute rules and non-negotiables</strong><br> Always begin with smoke tests. Never bypass audit or modify audit rows without documented legal/compliance approval. Never guess — record every deviation and remediation step. Determinism, traceability, and auditable approvals are mandatory. Feature flags that change regulatory outputs require two-person governance and CI enforcement. A tested emergency kill-switch must exist and be exercised periodically. Non-negotiable controls are enforced by CI/CD gates and runtime guards; violations trigger automated audits and may halt releases. </td></tr><tr><td data-label="Technical User Guide"> <strong>Available exports and next steps</strong><br> This runbook can be exported immediately into single consolidated PDF, DOCX, XLSX, CI pipeline YAML, or a Prometheus/Grafana package. If you want an export produced now, specify the exact filename and desired format and the corresponding artifact will be prepared. <br> <strong>Export options and required metadata:</strong> when requesting PDF/DOCX provide <code>title</code>, <code>author</code>, <code>effectiveDate</code>; when requesting XLSX specify whether to include hidden sheets (self-test artifacts) and whether to include appendices. Exports include an appended <code>runbook.audit</code> entry capturing who requested the export and why. </td></tr><tr><td data-label="Technical User Guide"> <strong>Operator quick-reference: Immediate triage checklist (copy-ready)</strong><br> 1) Run smoke test and capture <code>audit_tail.csv</code>.<br> 2) If smoke test fails, collect <code>bootstrap.log</code>, <code>ui.log</code>, <code>deps.report.json</code> and <code>excel.register.state</code>.<br> 3) If audit rows are absent for a known action, stop and preserve evidence; do not run corrective scripts that mutate state.<br> 4) If export failure, set exports to <code>stage-local</code>, capture <code>export.failures</code> and enable retry.<br> 5) If calculation mismatch, re-run canonical fixture in isolated runner with identical <code>config.hash</code> and capture <code>artifact.checksum</code>.<br> 6) Record every operator action with <code>operatorId</code>, <code>reason</code>, and <code>correlationId</code> in audit. </td></tr><tr><td data-label="Technical User Guide"> <strong>Evidence templates & canonical fields (copy-ready)</strong><br> - Audit row CSV header: <code>timestamp,correlationId,module,procedure,severity,userId,payloadHash,prevHash,signature,metadata</code><br> - Job descriptor JSON fields: <code>jobId,createdAt,owner,shard,attempts,state,params,configHash</code><br> - Forensic manifest JSON: <code>manifestId,collector,collectionTime,items:[{path,sha256,size}],destination,notes</code><br> - Release manifest example fields: <code>releaseId,buildId,commit,signer,artifacts:[{path,sha256}]</code> Keep these templates in <code>appendices/templates/</code> and use them unchanged for evidence submissions. </td></tr><tr><td data-label="Technical User Guide"> <strong>Operator command reference (explicit examples)</strong><br> - Collect diagnostics: <code>add-in-cli diagnostics collect --run-id &lt;run&gt; --out ./diag-&lt;run&gt;.tar.gz</code><br> - Flush audit: <code>add-in-cli audit flush --immediate --correlation &lt;id&gt;</code><br> - Re-run job: <code>add-in-cli jobs run --job-id &lt;job&gt; --isolated --config-hash &lt;hash&gt;</code><br> - Toggle flag (requires 2-person approval): <code>add-in-cli flags set --id &lt;flag&gt; --value false --approved-by &lt;uid&gt;</code> Each CLI call MUST produce an audit row; failures of CLI produce a signed local error object which must be attached to troubleshooting artifacts. </td></tr><tr><td data-label="Technical User Guide"> <strong>Sample migration manifest (template, copy-ready)</strong><br> <code>json { &quot;migrationId&quot;:&quot;mig-2025-12-26-001&quot;, &quot;author&quot;:&quot;&lt;uid&gt;&quot;, &quot;description&quot;:&quot;Normalize Contract.Currency codes to ISO4217&quot;, &quot;affectedCount&quot;:12345, &quot;dryRunSummary&quot;:{&quot;sampleAffected&quot;:10,&quot;examples&quot;:[&quot;CUST-001&quot;,&quot;CUST-002&quot;]}, &quot;steps&quot;:[{&quot;stepId&quot;:1,&quot;action&quot;:&quot;transform-currency&quot;,&quot;script&quot;:&quot;scripts/migrate_currency_v2.py&quot;,&quot;backout&quot;:&quot;scripts/backout_currency_v2.py&quot;}], &quot;approval&quot;:[{&quot;approver&quot;:&quot;compliance@company&quot;,&quot;timestamp&quot;:&quot;2025-12-26T20:00:00Z&quot;}], &quot;evidence&quot;:[&quot;before-sample.csv&quot;,&quot;after-sample.csv&quot;], &quot;notes&quot;:&quot;Requires two-person signoff to run in production&quot; } </code> Use this template and attach sample before/after rows for audit. </td></tr><tr><td data-label="Technical User Guide"> <strong>Sample release manifest (template, copy-ready)</strong><br> <code>json { &quot;releaseId&quot;:&quot;rel-2025-12-26-01&quot;, &quot;buildId&quot;:&quot;build-abc123&quot;, &quot;commitHash&quot;:&quot;abcdef0123456789&quot;, &quot;artifacts&quot;:[{&quot;path&quot;:&quot;add-in-v2.3.0.zip&quot;,&quot;sha256&quot;:&quot;...&quot;}], &quot;signingKey&quot;:&quot;sig-key-01&quot;,&quot;ciSummary&quot;:{&quot;status&quot;:&quot;passed&quot;,&quot;runId&quot;:&quot;ci-9876&quot;}, &quot;complianceApproval&quot;:[{&quot;approver&quot;:&quot;compliance@company&quot;,&quot;timestamp&quot;:&quot;2025-12-26T19:30:00Z&quot;,&quot;notes&quot;:&quot;Approved IFRS self-tests&quot;}] } </code> Append manifest to audit prior to deployment; ensure <code>signingKey</code> fingerprint present. </td></tr><tr><td data-label="Technical User Guide"> <strong>Post-mortem template (required fields)</strong><br> 1) Incident ID<br> 2) Severity<br> 3) Detection time<br> 4) Containment time<br> 5) Resolution time<br> 6) Summary (1 paragraph)<br> 7) Full timeline with correlation ids<br> 8) Root cause analysis<br> 9) Corrective actions with owners and deadlines<br> 10) Evidence attached (audit rotations, logs, manifests)<br> 11) Preventive measures and tests to add to CI<br> 12) Compliance impact and regulator notification plan<br> 13) Lessons learned. Post-mortem is due within 72 hours of incident resolution and must be approved by Compliance. </td></tr><tr><td data-label="Technical User Guide"> <strong>Regulatory package checklist (copy-ready)</strong><br> - Release manifest (signed)<br> - Audit rotations for affected date range<br> - Migration manifests (if any)<br> - Redacted sample inputs and outputs demonstrating deterministic behavior<br> - Test fixtures and CI run logs proving parity<br> - Compliance sign-offs and reviewer comments<br> - De-redaction requests (if applicable)<br> - Post-mortem (if incident-related) Deliver in an immutable archive and append <code>submission.audit</code> entry. </td></tr><tr><td data-label="Technical User Guide"> <strong>Verification & acceptance tests (developer checklist)</strong><br> - Unit tests cover edge cases and negative paths<br> - Integration tests exercise module interfaces<br> - IFRS self-tests match golden artifacts byte-for-byte<br> - Audit chain verified in CI for sample runs<br> - Performance benchmarks within thresholds<br> - Signed artifacts and manifests present<br> - Compliance approvals recorded If any item fails, the release is blocked until remediated and evidence attached to the blocking ticket. </td></tr><tr><td data-label="Technical User Guide"> <strong>Common failures playbook (operator-ready)</strong><br> <em>Failure: Add-in not loading.</em> Steps:<br> 1) Confirm Excel COM registration; collect <code>excel.register.state</code>.<br> 2) Check <code>bootstrap.log</code> for <code>autoload-disabled</code> messages.<br> 3) Reinstall signed add-in package and re-register; collect <code>install.log</code>.<br> 4) If auto-disabled persists, escalate to Release Engineer with logs and <code>audit_tail.csv</code>.<br> <em>Failure: Exports failing.</em> Steps:<br> 1) Set exports to <code>stage-local</code> and capture <code>export.failures</code>.<br> 2) Restart export daemon.<br> 3) Replay exports with <code>exports replay --from &lt;timestamp&gt;</code>.<br> 4) If network auth error, rotate creds and record <code>key.rotate</code> audit row.<br> <em>Failure: Calculation mismatch vs golden.</em> Steps:<br> 1) Re-run canonical fixture in isolated runner with identical <code>config.hash</code>.<br> 2) Diff intermediate values.<br> 3) If mismatch unexplained, block release and open an incident. Always collect evidence described in the relevant section. </td></tr><tr><td data-label="Technical User Guide"> <strong>Audit compromise runbook (summary)</strong><br> 1) Isolate writes (set audit to read-only).<br> 2) Export current rotations and preserve copies with checksums to secure forensic share.<br> 3) Run <code>VerifyAuditChain</code> on prior rotations to identify first mismatch.<br> 4) Reconstruct or restore from last verified rotation under compliance supervision.<br> 5) Alert regulators as required.<br> 6) Perform kill-switch test and update post-mortem. Each step must be logged and evidence stored in <code>forensic</code> store. </td></tr><tr><td data-label="Technical User Guide"> <strong>Operator training & periodic drills</strong><br> Operators must complete annual training including smoke tests, common failures, and evidence collection. Perform a quarterly tabletop run of at least one high-severity runbook and an annual full drill including forensic export and VerifyAuditChain. Retain drill artifacts and approvals in audit. </td></tr><tr><td data-label="Technical User Guide"> <strong>Appendix A — audit row example (canonical JSON)</strong><br> <code>json { &quot;timestamp&quot;:&quot;2025-12-26T20:00:00Z&quot;, &quot;correlationId&quot;:&quot;20251226-200000-modIFRS15-1a2b3c4d&quot;, &quot;module&quot;:&quot;modIFRS15&quot;, &quot;procedure&quot;:&quot;allocate&quot;, &quot;severity&quot;:&quot;INFO&quot;, &quot;userId&quot;:&quot;system&quot;, &quot;payloadHash&quot;:&quot;sha256:abcd...&quot;, &quot;prevHash&quot;:&quot;sha256:0000...&quot;, &quot;signature&quot;:&quot;sig:abcd...&quot;, &quot;metadata&quot;:{&quot;runId&quot;:&quot;run-2025-12-26-0001&quot;,&quot;configHash&quot;:&quot;cfg-1234&quot;} } </code> Sign each rotation and archive rotated packages according to retention policy. </td></tr><tr><td data-label="Technical User Guide"> <strong>Appendix B — glossary of key terms</strong><br> - Audit chain: append-only sequence of signed audit rows<br> - Correlation id: unique id that ties logs, audit, and artifacts<br> - SafeRound: deterministic rounding algorithm with configured midpoint rule<br> - Golden file: canonical artifact used for CI parity<br> - Job descriptor: persisted metadata describing an execution unit<br> - Forensic share: secure archive for incident evidence<br> - Kill-switch: mechanism to disable unsafe features or exports </td></tr><tr><td data-label="Technical User Guide"> <strong>Appendix C — monitoring thresholds (recommended defaults)</strong><br> - Startup time (WARN > 12s, CRIT > 30s)<br> - Audit flush latency (WARN > 5s, CRIT > 30s)<br> - Job queue length (WARN > 100, CRIT > 1000)<br> - Export error rate (WARN > 0.5%, CRIT > 2%)<br> - Memory usage (WARN > 75%, CRIT > 90%) Adjust thresholds per environment and justify deviations in <code>thresholds.audit</code>. </td></tr><tr><td data-label="Technical User Guide"> <strong>Appendix D — change-control checklist (must-complete before production change)</strong><br> 1) Create change ticket with scope and rollback plan.<br> 2) Run IFRS self-tests and attach results.<br> 3) Attach migration manifest (if applicable).<br> 4) Obtain two-person approval for regulatory-impacting changes.<br> 5) Sign artifacts and create release manifest.<br> 6) Schedule deployment outside freeze windows or get override approvals.<br> 7) Run deployment in canary cohorts with automated gates.<br> 8) After rollout, run VerifyAuditChain and record results in audit. </td></tr><tr><td data-label="Technical User Guide"> <strong>Appendix E — contact & escalation matrix (copy-ready)</strong><br> Maintain an up-to-date roster with direct paging numbers and SSO ids for Product Owner, Release Engineer, Compliance Officer, Security Lead, On-call SRE, and Support Engineer. The matrix must be publicly accessible to authorized personnel and updated on role change. Paging policies define business hours, off-hours, and holiday rotations. </td></tr><tr><td data-label="Technical User Guide"> <strong>Document distribution & access controls</strong><br> Store the canonical runbook in immutable artifact storage and present a read-only rendered copy in the internal docs portal. Edits go through PRs targeting <code>runbook/master</code>; each PR must include test evidence and, for regulatory-impacting changes, compliance sign-off. Access to edit rights is limited to the Runbook Owners group and requires two-person approvals for publishing. </td></tr><tr><td data-label="Technical User Guide"> <strong>Next steps for consumers of this runbook</strong><br> If you are an operator, familiarize yourself with the smoke tests and common failures cheat-sheets in the next 48 hours. If you are a developer, ensure your next PR touching regulatory modules includes a canonical fixture and updated golden file checksums. If you are Compliance, schedule a monthly review of migration manifests and a quarterly audit of release manifests. For any export request of this runbook, specify format and filename and include the intended use and recipient to ensure appropriate audit tracking. </td></tr></tbody></table></div><div class="row-count">Rows: 69</div></div><div class="table-caption" id="Table2" data-table="Docu_0158_02" style="margin-top:2mm;margin-left:3mm;"><strong>Table 2</strong></div>
<div class="table-wrapper" data-table-id="table-2"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modAudit"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modAudit</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modAudit"> <strong>Overview</strong><br>Append-only, tamper-evident audit store for Excel/VBA. Rows are cryptographically chained (per-row <code>PrevHash</code> → <code>Hash</code>). Supports buffered batch writes for performance, synchronous append path for reliability, archive rotation, CSV/JSON export, PII-light redaction, and multiple hash-provider fallbacks (SHA256 preferred, CRC32 fallback). Sheet visibility and meta-sheet capture runtime metadata. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Public API (short)</strong><br><code>InitAuditModule()</code> — initialize module and meta sheet.<br><code>ShutdownAuditModule()</code> — flush and teardown.<br><code>LogAudit(action, details)</code> — backwards-compatible convenience logger.<br><code>AppendAuditEntry(...)</code> — synchronous single-row append (strongest durability).<br><code>AppendAuditBuffered(entry)</code> — enqueue buffered entry.<br><code>FlushAuditBuffer()</code> — persist buffered entries in one bulk write.<br><code>RotateAuditNow()</code> — archive current audit to CSV and truncate.<br><code>ExportAuditToCSV(path)</code> / <code>ExportAuditToJSON(path)</code> — export copies.<br><code>VerifyAuditChain(firstBadRow, diagnosticCode)</code> — chain verification.<br><code>GenerateAuditDiagnosticReport(path, startRow)</code> — CSV diagnostics.<br><code>FindAuditByCorrelationID(id)</code> / <code>ReadAuditRow(row)</code> — lookup helpers.<br><code>SetAuditFeatureFlag(name,val)</code> / <code>GetAuditFeatureFlag(name)</code> — runtime flags. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Canonical audit row schema (CSV / JSON)</strong><br><code>timestamp,correlationId,module,procedure,severity,userId,payloadHash,prevHash,signature</code> <em>(conceptual)</em>.<br>Implemented worksheet columns: <code>TimestampUTC, CorrelationID, Module, Procedure, Severity, ErrNum, WindowsUser, ExcelUser, Action, ContextJSON, PrevHash, Hash</code>.<br><code>Hash</code> is produced by <code>ComputeEntryHash(prevHash, rowData)</code> (provider depends on config). </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Field meanings</strong><br><code>TimestampUTC</code> — ISO 8601 UTC (Z) from <code>GetSystemTime</code> fallback to <code>Now</code>.<br><code>CorrelationID</code> — GUID / deterministic id from <code>NewCorrelationId()</code>.<br><code>Module</code>/<code>Procedure</code> — source location of event.<br><code>Severity</code> — text (<code>Info</code>, etc.).<br><code>ErrNum</code> — numeric error code where applicable.<br><code>WindowsUser</code> / <code>ExcelUser</code> — runtime principals (redacted where required).<br><code>Action</code> — brief action label.<br><code>ContextJSON</code> — JSON payload (redaction/truncation applied).<br><code>PrevHash</code> — prior row <code>Hash</code> (empty for first row).<br><code>Hash</code> — entry hash (hex) stored uppercase. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Configuration defaults & constants</strong><br>Sheet names: <code>_IFRS_Audit</code>, <code>_IFRS_AuditMeta</code>.<br><code>AUDIT_MAX_ROWS_BEFORE_ROTATE = 50000</code>.<br><code>AUDIT_BATCH_FLUSH_THRESHOLD = 50</code>.<br><code>MAX_CONTEXT_LENGTH = 2000</code>.<br><code>AUDIT_ARCHIVE_FOLDER</code> empty → <code>TEMP</code> / workbook path fallback. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Runtime feature flags & safe defaults</strong><br><code>g_enableMetaSheet = True</code> — tracks last flush, buffered count, provider counts.<br><code>g_aggressiveRedaction = False</code> — set true to increase redaction sensitivity.<br><code>g_allowExternalHashProvider = False</code> — <strong>disabled by default</strong>; enable only in trusted environments to allow <code>HashProviderMacroName</code>.<br><code>g_allowCommandExecution = True</code> — controls use of <code>certutil</code> / <code>shasum</code> / <code>openssl</code>; consider disabling on locked-down systems. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Buffering model & durability tradeoffs</strong><br>Buffered writes increase throughput: <code>AppendAuditBuffered</code> enqueues; automatic <code>FlushAuditBuffer</code> triggers at <code>AUDIT_BATCH_FLUSH_THRESHOLD</code> or via <code>ShutdownAuditModule</code>/manual <code>FlushAuditBuffer</code>.<br>Bulk write uses array write (<code>Resize(n,12).Value</code>). On bulk-write failure, module falls back to per-row <code>AppendAuditEntry</code> to guarantee persistence (slower). <code>Flush</code> emits <code>FlushStart</code> / <code>FlushFinish</code> internal entries. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Synchronous append behavior</strong><br><code>AppendAuditEntry</code> writes one row synchronously (disables events / screen updates during operation). Applies redaction/truncation to <code>ContextJSON</code>. Computes <code>prevHash</code> from last row and then <code>entryHash</code> via <code>ComputeEntryHash</code>. On write error a fallback 'LogAuditFailure' row is written. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Rotation & archive</strong><br><code>RotateAuditNow</code> copies <code>UsedRange</code> to a temporary workbook, saves CSV archive named <code>IFRS_Audit_Archive_&lt;UTC&gt;.csv</code> into <code>AUDIT_ARCHIVE_FOLDER</code> or fallback (TEMP / workbook folder / USERPROFILE). After successful save, rows 2:last are deleted from audit sheet. Emits <code>RotateStart</code> and <code>RotateFinish</code> events; on save failure attempts fallback path and logs <code>RotateFallback</code> or <code>AuditRotateError</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Export formats</strong><br><code>ExportAuditToCSV(fullPath)</code> — creates CSV via temporary workbook copy; returns Boolean success.<br><code>ExportAuditToJSON(fullPath)</code> — converts <code>UsedRange</code> to JSON array (header row → object keys), writes UTF-8 bytes. Both write errors produce <code>ExportAuditError</code> entries. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Hashing: provider selection & fallback</strong><br>Compute order: <br> (1) Macro provider <code>HashProviderMacroName</code> if <code>g_allowExternalHashProvider = True</code> and macro returns non-empty; <br> (2) System SHA256 (<code>certutil</code> on Windows, <code>shasum</code>/<code>openssl</code> on Unix) if <code>g_allowCommandExecution = True</code>; <br> (3) CRC32 fallback (always available).<br>Each provider use increments meta counts and emits <code>HashProviderUsed</code> internal row. Maintain <code>g_lastHashProviderUsed</code> and <code>g_hashProviderResultType</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>System SHA256 provider notes</strong><br>Writes a temp binary file, calls system tool with guarded timeout (<code>RunCmdWithTimeout_Safe</code>), parses output to extract 64-hex SHA256. Temp file is removed. If system tool not available or parsing fails, returns empty to allow fallback. <code>CertUtilAvailable()</code> probes <code>certutil</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Redaction & PII handling</strong><br><code>RedactSensitiveData</code> uses regex patterns to redact:<br>• emails → <code>[REDACTED_EMAIL]</code><br>• SSN-like numbers / long numeric sequences → <code>[REDACTED_SSN]</code> / <code>[REDACTED_NUMBER]</code><br>• account numbers, JWTs, API keys, token-like blobs, long hex/base64 blobs → <code>[REDACTED_TOKEN]</code> / <code>[REDACTED_HEX]</code> / <code>[REDACTED_BLOB]</code><br>Aggressive mode applies extra patterns; long <code>ContextJSON</code> truncated to <code>MAX_CONTEXT_LENGTH</code> and emits <code>ContextTruncated</code>. Fallback <code>SimpleRedactFallback</code> used when regex engine unavailable. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Verification & diagnostics</strong><br><code>VerifyAuditChain(firstBadRow,diagnosticCode)</code> iterates rows verifying <code>PrevHash</code> equality and recomputed <code>Hash</code> equality. Diagnostic codes: <code>0=OK</code>, <code>1=MissingPrevHash</code>, <code>2=HashMismatch</code>, <code>3=Malformed/Other</code>.<br><code>GenerateAuditDiagnosticReport(outputCsvPath,startRow)</code> emits per-row <code>ExpectedPrev,ActualPrev,ExpectedHash,ActualHash,Reason</code> CSV for offline analysis. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Lookup helpers</strong><br><code>FindAuditByCorrelationID(corrId)</code> — finds row index in column B.<br><code>ReadAuditRow(sheetRow)</code> — returns <code>Scripting.Dictionary</code> with all fields for a given row. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Meta sheet</strong><br><code>_IFRS_AuditMeta</code> stores <code>LastFlushUTC</code>, <code>BufferedCount</code>, <code>EnableMetaSheet</code>, <code>AggressiveRedaction</code>, and hash provider counts. Meta sheet is <code>xlSheetVeryHidden</code> by default; updates are skipped if the sheet is protected (an internal <code>MetaSheetProtected</code> entry is emitted). </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Security & operational guidance</strong><br>• Protect <code>_IFRS_Audit</code> and <code>_IFRS_AuditMeta</code> (workbook protection, ACLs).<br>• Disable <code>allowExternalHashProvider</code> unless <code>HashProviderMacroName</code> is trusted and code-reviewed.<br>• Consider disabling <code>g_allowCommandExecution</code> on user endpoints to avoid external tool invocation risk.<br>• Keep audit archives on an immutable or access-restricted location for long-term retention.<br>• Log verification runs and run <code>VerifyAuditChain</code> in CI and monitoring (see Runbook triggers). </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Runbook triggers & recommended checks</strong><br>• Any <code>VerifyAuditChain</code> failure (diagnostic ≠ 0) → trigger <code>audit-compromise</code> runbook.<br>• Regularly run <code>VerifyAuditChain</code> after rotation, and in CI on each release. Schedule periodic <code>GenerateAuditDiagnosticReport</code> for near-real-time monitoring. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Error handling & fallbacks</strong><br>Module uses defensive <code>On Error</code> handling and emits internal audit entries for exceptional states (e.g., <code>FlushFallback</code>, <code>RotateFallback</code>, <code>ExportAuditError</code>, <code>AuditRotateError</code>). Bulk-write failures fall back to per-row synchronous writes to avoid data loss. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Implementation & platform notes</strong><br>• UTC timestamps use <code>GetSystemTime</code> via <code>kernel32</code> with VBA7 <code>PtrSafe</code> support; fallback to <code>Now</code> formatting when unavailable.<br>• Cross-platform command detection implemented (<code>PlatformIsWindows</code>, <code>CertUtilAvailable</code>).<br>• Encoding uses <code>ADODB.Stream</code> when available; falls back to <code>StrConv</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Examples</strong><br>CSV canonical row (columns A..L):<br><code>2025-12-27T21:00:00Z,IFRS-20251227-123456,modPayments,ProcessPayment,Info,,DOMAIN\alice,Alice,PaymentRecorded,{&quot;amount&quot;:100,&quot;currency&quot;:&quot;USD&quot;},PREV_HASH,ENTRY_HASH</code><br>JSON export sample object: <code>{&quot;TimestampUTC&quot;:&quot;2025-12-27T21:00:00Z&quot;,&quot;CorrelationID&quot;:&quot;IFRS-...&quot;,&quot;Module&quot;:&quot;modPayments&quot;,...,&quot;Hash&quot;:&quot;ENTRY_HASH&quot;}</code> </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Operational best practices</strong><br>• Run <code>InitAuditModule</code> at add-in/workbook startup, <code>ShutdownAuditModule</code> on close.<br>• Call <code>FlushAuditBuffer</code> before heavy operations or before allowing untrusted macros to run.<br>• Enforce least privilege: restrict file system write locations for archive export.<br>• Protect meta and audit sheets and review <code>HashProvider</code> usage in code review. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Limitations & known behaviors</strong><br>• Signatures in canonical schema (<code>signature</code>) are not produced by default; module stores computed <code>Hash</code> only. Integrate external signing in CI if required (signing key referenced by release manifest).<br>• System SHA256 relies on external tools and may be disabled in locked environments — CRC32 fallback is less cryptographically strong.<br>• Very large <code>ContextJSON</code> payloads are truncated; keep context compact and PII-light. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Troubleshooting checklist</strong><br>1. <code>VerifyAuditChain</code> failure → run <code>GenerateAuditDiagnosticReport</code>, inspect <code>firstBadRow</code> and <code>diagnosticCode</code>.<br>2. Missing rows after rotate → check archive path, workbook permissions, <code>AUDIT_ARCHIVE_FOLDER</code> config and TEMP fallback.<br>3. Hash provider unexpected (CRC32) → check <code>g_allowCommandExecution</code> and <code>g_allowExternalHashProvider</code>, review <code>_IFRS_AuditMeta</code> provider counts.<br>4. Redaction removed needed data → toggle <code>aggressiveRedaction</code> off and review <code>ContextJSON</code> patterns. </td></tr><tr><td data-label="Technical User Guide — modAudit"> <strong>Maintenance & retention</strong><br>Archive naming: <code>IFRS_Audit_Archive_&lt;UTC&gt;.csv</code>. Keep a retention policy outside this module (file system / backup). Periodic rotation before <code>AUDIT_MAX_ROWS_BEFORE_ROTATE</code> recommended. Ensure CI exports and signing happen before archive distribution. </td></tr></tbody></table></div><div class="row-count">Rows: 25</div></div><div class="table-caption" id="Table3" data-table="Docu_0158_03" style="margin-top:2mm;margin-left:3mm;"><strong>Table 3</strong></div>
<div class="table-wrapper" data-table-id="table-3"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Unnamed: 0"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Unnamed: 0</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Unnamed: 0"> <strong>Overview</strong><br>Deterministic add-in bootstrap and runtime lifecycle manager for the IFRS add-in. Provides deferred initialization, dependency probing, feature-flag loading, migration hooks, robust metadata persistence with atomic-ish writes and in-memory buffering, job scheduling/upsert (OnTime-safe), job reconciliation, safe <code>Application.Run</code> wrappers, idempotent initialization/shutdown, test/self-test harness, and lightweight CRC32 utilities for deterministic IDs. Preserves public API signatures to avoid breaking consumers.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Purpose & responsibilities</strong><br>• Start/stop the add-in (<code>AddIn_Initialize</code>, <code>AddIn_DeferredInit</code>, <code>AddIn_Shutdown</code>).<br>• Record bootstrap state and metadata (meta sheet <code>_IFRS_Metadata</code>).<br>• Create/upgrade operational sheets (<code>_IFRS_Jobs</code>, <code>_IFRS_Audit</code>, <code>_IFRS_TestResults</code>).<br>• Schedule deferred init via <code>Application.OnTime</code> using a job upsert pattern and safe scheduling wrapper (<code>SafeOnTimeSchedule</code>).<br>• Manage feature enable/disable lists and an in-memory feature cache.<br>• Provide robust safe-call wrappers (<code>SafeRun</code>, <code>SafeRunWithResult</code>, <code>CallRunWithArgs*</code>) to invoke other modules safely.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Public API (important functions)</strong><br><code>AddIn_Initialize()</code> — idempotent bootstrap entry. Sets up caches, meta & job sheets, persists initial state, schedules deferred init.<br><code>AddIn_DeferredInit()</code> — deferred initialization worker: dependency probes, config load/migration, warmups, optional self-test, persists final state.<br><code>AddIn_Shutdown()</code> — idempotent teardown, cancels scheduled jobs, attempts graceful shutdown of ribbon jobs.<br><code>AddIn_IsInitialized()</code> / <code>AddIn_GetState()</code> — introspection.<br><code>AddIn_EnableFeature(name, reason)</code> / <code>AddIn_DisableFeature(name, reason)</code> — toggle features and persist to metadata.<br><code>AddIn_SelfTestStartup()</code> / <code>AddIn_RunInternalTests()</code> / <code>Ribbon_SelfTest()</code> — test harnesses.<br><code>AddIn_ListDependencies()</code> / <code>AddIn_EnsureDependencies()</code> — dependency inventory & probes.<br><code>TryProbe(procName)</code> — cache-aware probe helper.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Constants & defaults</strong><br>Sheet names: <code>_IFRS_Metadata</code>, <code>_IFRS_Audit</code>, <code>_IFRS_TestResults</code>, <code>_IFRS_Jobs</code>.<br><code>BOOTSTRAP_VERSION = &quot;1.0.0&quot;</code>.<br>Meta size limits: <code>MAX_META_VALUE = 2048</code>, <code>MAX_META_SHORT = 1024</code>, <code>MAX_META_NOTE = 512</code>.<br>OnTime retry policy: <code>MAX_ONETIME_RETRY_COUNT = 3</code>, <code>MAX_ONETIME_RETRY_AGE_DAYS = 30</code>.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Jobs sheet schema / column indices</strong><br>Columns (1-based): <code>JobId(1)</code>, <code>Handler(2)</code>, <code>Status(3)</code>, <code>ScheduledAt(4)</code>, <code>LastError(5)</code>, <code>Meta(6)</code>, <code>CreatedAt(7)</code>, <code>UpdatedAt(8)</code>, <code>v2_migrated(9)</code>.<br>Statuses used: <code>queued</code>, <code>running</code>, <code>scheduled</code>, <code>completed</code>, <code>orphaned</code>, <code>orphaned_maxed</code>, <code>cancelled</code>, <code>queued</code>.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Job lifecycle & scheduling</strong><br>• Use <code>EnqueueOrUpdateJob(jobId, Handler, status, scheduledAt, meta)</code> to upsert job rows and avoid duplicates.<br>• Schedule via <code>SafeOnTimeSchedule(when, procString, jobId)</code> which retries with exponential backoff and records retry counts in job meta; marks jobs <code>orphaned</code>/<code>orphaned_maxed</code> when scheduling fails repeatedly.<br>• <code>TryCancelOnTime(when, proc)</code> cancels both qualified and unqualified OnTime entries safely and logs failures.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Deferred init workflow</strong><br><code>AddIn_Initialize</code> schedules <code>AddIn_DeferredInit</code> via a job upsert and <code>SafeOnTimeSchedule</code>. Deferred init performs dependency probes, attempts <code>Config_Load</code> and migration, warms modules (<code>modAudit_Init</code>, <code>modUtilities_Init</code>), optionally runs self-tests if <code>run_selftest_on_start</code> feature flag is true, persists bootstrap state, and marks job completed.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Dependency probing & capability snapshot</strong><br><code>AddIn_EnsureDependencies</code> and <code>TryProbe</code> probe availability of critical procs and COM objects (FSO, ADODB.Stream, WScript). Results are persisted as a capability snapshot (<code>LastCapabilitySnapshot</code>) for diagnostics. Probe results cached in <code>g_probeCache</code> for session lifetime.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Feature flags & caching</strong><br><code>LoadFeatureFlag(key, default)</code> checks <code>g_featureCache</code>, then <code>Config_Get</code> (if available), then meta sheet <code>FeatureFlag_&lt;key&gt;</code>, falling back to provided default. <code>AddIn_InvalidateFeatureCache</code> clears cache entries. Feature toggles are also persisted to meta sheet by <code>AddIn_EnableFeature</code> / <code>AddIn_DisableFeature</code>.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Metadata persistence model</strong><br>Primary store: <code>_IFRS_Metadata</code> sheet with <code>Key/Value</code> rows. Writes attempted atomically via <code>WriteMetaValueAtomic(key,value)</code> which writes a temporary key and then moves value to final key with retries and exponential backoff; on repeated failure the key/value is buffered in-memory (<code>g_metaBuffer</code>) via <code>BufferMetaValue</code> and flushed later by <code>FlushMetaBuffer</code> or when sheet becomes available. Sensitive keys are redacted on write (<code>IsSensitiveKey</code>) and tracked in <code>SensitiveKeys</code>.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Safe write behaviors & fallbacks</strong><br><code>WriteMetaValue</code> will attempt to find existing key row and overwrite or append. If the metadata sheet is unavailable or write errors occur, values are buffered in <code>g_metaBuffer</code>. <code>FlushMetaBuffer</code> attempts to persist buffered values and removes entries on success. <code>WriteMetaValueAtomicDual</code> writes both primary and legacy-prefixed keys for one cycle.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Safe Application.Run wrappers</strong><br><code>CallRunWithArgs</code>, <code>CallRunWithArgsWithResult</code>, <code>RunWithArgs</code>, <code>RunWithArgsWithResult</code> — support up to 9 args, truncate beyond that, and log audit rows on errors. These helpers centralize error handling and avoid call-site duplication. <code>SafeRun</code> / <code>SafeRunWithResult</code> attempt a workbook-qualified call first (preferred on non-Mac), then an unqualified call, and return boolean / result safely.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Error handling & forwarding</strong><br><code>Bootstrap_HandleError(proc, errNum, errDesc, procContext)</code> attempts to forward errors to <code>HandleError</code> if available via <code>SafeRunWithResult</code>; otherwise it falls back to <code>AppendLocalAudit</code>. <code>Bootstrap_Audit(action,message)</code> sends to audit via <code>LogAudit</code> if available, otherwise writes to local <code>_IFRS_Audit</code> sheet fallback.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Audit integration</strong><br>Audit calls are performed via <code>SafeRunWithResult(&quot;LogAudit&quot;, ...)</code> (constant <code>AUDIT_PROC_NAME</code>). If audit module is absent, <code>AppendLocalAudit</code> creates a minimal audit sheet and writes human-friendly audit rows. Audit messages include deterministic bootstrap id and truncated payloads (use <code>TruncateForAudit</code>).  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Job reconciliation & ribbon integration</strong><br><code>Ribbon_ReconcileJobsOnOpen</code> inspects <code>_IFRS_Jobs</code>, reschedules queued/scheduled jobs (respecting retry limits and <code>MAX_ONETIME_RETRY_AGE_DAYS</code>), updates job rows and meta, and emits bootstrap audit events. <code>Ribbon_AttemptGracefulShutdown</code> cancels scheduled jobs on shutdown and marks statuses accordingly.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Migration support</strong><br><code>MigrateJobsSheetToV2</code> performs best-effort migration of the jobs sheet: ensures <code>CreatedAt</code>, <code>UpdatedAt</code> exist and sets a <code>v2_migrated</code> flag per row; records <code>JobsSheetV2Migrated</code> in metadata and emits audit. Migration is idempotent and non-blocking.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Tests & self-test harness</strong><br>• Deterministic / repeatable tests available: <code>AddIn_SelfTestStartup</code>, <code>AddIn_RunInternalTests</code>, <code>Ribbon_SelfTest</code>.<br>• Self-tests cover CRC32 vector validation, metadata R/W, sensitive key redaction behavior, safe-run semantics, OnTime schedule/cancel simulation, idempotence of CRC table, and write truncation behaviors. Test results are appended to <code>_IFRS_TestResults</code>.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>CRC32 utilities & deterministic IDs</strong><br><code>CRC32_String(s)</code> → 32-bit CRC used for deterministic short ids; <code>EnsureCRC32Table</code> lazily initializes the CRC table. <code>HexFromLong</code> formats CRC in uppercase hex. CRC vector validated against <code>The quick brown fox</code> → expected <code>B74574DE</code>. Bootstrap id built from CRC of start timestamp + username.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Sensitive key handling</strong><br><code>IsSensitiveKey(key)</code> detects common patterns (<code>password</code>, <code>oauth</code>, <code>api_key</code>, <code>secret</code>, <code>token</code>, <code>pwd</code>, <code>pass</code>, <code>key</code>+<code>api</code>) and causes <code>WriteMetaValue</code> to redact stored value to <code>... [REDACTED]</code> and add key to <code>SensitiveKeys</code> index. Sensitive storage is intentionally truncated and marked for safety.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Defensive COM helpers & platform checks</strong><br><code>CreateObjectSafe(progId)</code> wraps <code>CreateObject</code> with error suppression; <code>IsMac()</code> infers platform from <code>Application.OperatingSystem</code>. <code>IsThisWorkbookUnavailable()</code> protects against contexts where <code>ThisWorkbook</code> is inaccessible.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Concurrency & idempotence</strong><br>• <code>AddIn_Initialize</code> is guarded by <code>g_bootstrapInitialized</code> and <code>g_bootstrapInitializing</code> to prevent re-entrancy.<br>• Cache reset (<code>ResetCaches</code>) ensures deterministic warm-up between runs.<br>• Sheet creation routines tolerate name-collisions and fallback to timestamped alternate names.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Diagnostics & telemetry</strong><br>• Metadata keys emitted: <code>BootstrapId</code>, <code>BootstrapVersion</code>, <code>BootstrapStartUtc</code>, <code>BootstrapInitialized</code>, <code>BootstrapScheduled</code>, <code>ScheduledProcedure</code>, <code>ScheduledWhen</code>, <code>LastCapabilitySnapshot</code>, <code>LastCapabilitySnapshotUpdated</code>, <code>OnTimeQualifiedPreferred</code>.<br>• <code>_IFRS_Audit</code> receives bootstrap lifecycle events (<code>Initialize</code>, <code>DeferredInit</code>, <code>RotateStart</code>, etc.).<br>• Jobs sheet stores per-job <code>retrycount</code> and <code>onTimeProc</code> in <code>Meta</code> field via semi-colon <code>key=val</code> pairs.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Operational guidance & best practices</strong><br>• Call <code>AddIn_Initialize</code> on workbook/add-in load, and <code>AddIn_Shutdown</code> on close.<br>• Ensure workbook macros calling <code>SafeRun</code> wrappers are signed and code-reviewed before enabling external feature flags that call untrusted macros.<br>• Restrict modification rights to <code>_IFRS_Metadata</code>, <code>_IFRS_Jobs</code>, and <code>_IFRS_Audit</code> sheets (protect sheets, set ACLs on workbook file).<br>• Prefer workbook-qualified procedures for OnTime scheduling on Windows (module uses qualified proc string where possible).  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Runbook triggers & monitoring</strong><br>• If deferred init fails or self-test fails → flag issue, collect diagnostics (meta keys, <code>_IFRS_TestResults</code>, <code>_IFRS_Audit</code>), and escalate.<br>• If <code>SafeOnTimeSchedule</code> repeatedly fails for a job → job meta marked <code>orphaned</code>/<code>orphaned_maxed</code>; reconcile via <code>Ribbon_ReconcileJobsOnOpen</code>.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Limitations & known behaviors</strong><br>• OnTime scheduling reliability depends on host OS and Excel platform; Mac behavior differs (code prefers unqualified calls on Mac).<br>• Metadata writes are “atomic-ish” (temp-key then copy) but not strongly transactional — persistence is best-effort with in-memory buffering as fallback.<br>• Sensitive-key redaction is heuristic-based; do not rely on it for cryptographic secrecy — avoid storing long secrets in metadata.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Troubleshooting checklist</strong><br>1. Deferred init not running → inspect <code>ScheduledProcedure</code> & <code>ScheduledWhen</code> meta keys and <code>_IFRS_Jobs</code> row for <code>deferredinit</code>.<br>2. Jobs missing or <code>orphaned</code> → check <code>retrycount</code> in job meta and run <code>Ribbon_ReconcileJobsOnOpen</code> or inspect OnTime scheduling capability.<br>3. Metadata writes failing → inspect <code>MetadataSheetCreateError</code> meta key, check workbook protection/permissions, then flush <code>g_metaBuffer</code> contents.<br>4. CRC32 vector mismatch → run <code>AddIn_RunInternalTests</code> and check <code>_IFRS_TestResults</code>.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Examples (typical row & meta)</strong><br>Job row example: <code>JobId=deferredinit | Handler=AddIn_DeferredInit | Status=queued | ScheduledAt=2025-12-27 21:11:00 | Meta=proc=&#x27;MyWB.xlsm&#x27;!AddIn_DeferredInit;retrycount=0 | CreatedAt=...</code><br>Meta keys example: <code>BootstrapId=boot-...</code>, <code>BootstrapVersion=1.0.0</code>, <code>ScheduledProcedure=&#x27;MyWB.xlsm&#x27;!AddIn_DeferredInit</code>. </td></tr><tr><td data-label="Unnamed: 0"> <strong>Integration checklist for dependent modules</strong><br>• Provide <code>LogAudit(action, message)</code> and <code>HandleError(proc, errNum, errDesc, context)</code> to integrate with bootstrap audit and error forwarding.<br>• Expose <code>Config_Load</code>, <code>Config_Get</code>, and <code>Config_MigrateIfNeeded</code> to participate in deferred configuration loading and migration.<br>• Register long-running work as jobs using <code>EnqueueOrUpdateJob</code> to enable scheduling, reconciliation and shutdown coordination.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Maintenance recommendations</strong><br>• Run self-tests (<code>AddIn_SelfTestStartup</code> / <code>AddIn_RunInternalTests</code>) as part of CI release and periodically in monitoring.<br>• Rotate or back up the workbook regularly; export metadata and job sheets for forensic retention.<br>• Review <code>SensitiveKeys</code> meta and purge secrets from metadata; use secure vaults for long-lived secrets.  </td></tr><tr><td data-label="Unnamed: 0"> <strong>Change control notes</strong><br>Public names and API signatures are preserved by design. Any change to public names requires updating all callers and CI checks. When releasing changes, run <code>AddIn_RunInternalTests</code>, <code>VerifyAuditChain</code> (modAudit), and CI validation to detect regressions early.  </td></tr></tbody></table></div><div class="row-count">Rows: 30</div></div><div class="table-caption" id="Table4" data-table="Docu_0158_04" style="margin-top:2mm;margin-left:3mm;"><strong>Table 4</strong></div>
<div class="table-wrapper" data-table-id="table-4"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modCalculations"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modCalculations</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modCalculations"> <strong>Module identity & version</strong><br><code>modCalculations</code> — financial & IFRS-style calculation helpers. Public compatibility preserved. <code>MODCALC_VERSION = &quot;3.0.3&quot;</code>. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Purpose & guarantees</strong><br>Provides deterministic, defensive calculation helpers (depreciation, amortization/lease schedules, NPV, ECL, deferred tax, year fractions, normalization utilities). Guarantees: preserved public signatures, config-driven behavior, centralized error-to-audit routing (non-UI-failing by default), numeric stability guards, and a self-test harness. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Public API (high-level)</strong><br>Key functions: <code>CalcDepreciation</code>, <code>CalcDepreciationEx</code>, <code>LeaseAmortizationSchedule</code>, <code>PvFromPmt</code>, <code>RecognizeRevenue</code>, <code>ImpairmentLoss</code>, <code>ImpairmentLossByNPV</code>, <code>NPVFromArray</code>, <code>ExpectedCreditLoss</code>, <code>ExpectedCreditLossBatch</code>, <code>GenerateDepreciationSchedule</code>, <code>GenerateDepreciationScheduleEx</code>, <code>DeferredTax</code>, <code>GetPaymentCountFromNormalized</code>, <code>GetPaymentAmountFromNormalized</code>, <code>GetPaymentDateFromNormalized</code>, <code>NormalizePaymentsForRead</code>, <code>NormalizeArrayInput</code>, <code>YearFraction</code>, <code>BuildMaturityAnalysis</code>, <code>ExportSheetToCsv</code>, plus job lifecycle hooks (<code>EnqueueCalculationJob</code>, <code>UpdateJobMeta</code>, <code>FindJobRow</code>, <code>CancelCalculationJob</code>, <code>FindJobRowInSheet</code>). Diagnostic/CI: <code>CalculationsSelfTest</code>. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Return shapes & conventions</strong><br>Schedules: 1-based 2D arrays. Example shapes: <code>LeaseAmortizationSchedule</code> → <code>(1..nPeriods, 1..6)</code> columns: <code>Period, OpeningBalance, Payment, Interest, Principal, ClosingBalance</code>.<br>Depreciation schedules → header at index 0 with rows <code>0..n</code> and columns <code>(1..4)</code> for <code>Period, DepreciationExpense, AccumulatedDepreciation, CarryingAmount</code>.<br><code>NormalizePaymentsForRead</code> returns 1-based array whose elements are either scalars or 1..2 1-based arrays: <code>(1)=date/label</code>, <code>(2)=amount</code> (Empty if absent). </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Configuration keys & runtime flags</strong><br>Fetches config via <code>GetConfigValue</code> (cached):<br><code>modCalculations.RaiseErrors</code> (boolean, default <code>DEFAULT_RAISE_ERRORS = False</code>) — controls whether errors are raised to UI.<br><code>modCalculations.RoundPolicy</code> (numeric, default <code>DEFAULT_ROUNDING_POLICY = 2</code>).<br><code>modCalculations.UseCentralRounding</code> (boolean, default <code>DEFAULT_USE_CENTRAL_ROUNDING = False</code>).<br><code>modCalculations.LegacyInterestMode</code> (compat shim). Use <code>InvalidateModCalculationsCache</code> after config changes. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Rounding & precision</strong><br>Centralized rounding via <code>applyRounding(value, policy)</code> with optional central integration: if <code>UseCentralRounding</code> true, attempts <code>modUtilities.ApplyRounding</code> / <code>modUtilities.Round</code> safely via <code>SafeApplicationRun</code>. Policies: <code>roundNone</code>, <code>roundFinancial</code> (2 decimals), <code>roundInteger</code>. Precision cached in <code>gRoundingPrecisionCache</code>. Alias <code>ApplySafeRound</code> provided. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Numeric stability & limits</strong><br>Constants: <code>PV_MAX_NPER = 1000000</code>, <code>RATE_NEAR_ZERO = 1e-12</code>, <code>TINY_RESIDUAL_THRESHOLD = 1e-10</code>, <code>MAX_SCHEDULE_ROWS = 200000</code>. Implementations guard near-zero rates, cap <code>nper</code>, zero tiny residuals, clamp salvage ≤ cost, and cap schedule lengths with logs. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Hash / correlation helpers</strong><br><code>GenerateCorrelationID()</code> produces local correlation IDs (timestamp + hex fragment). <code>ExtractCorrelationFromVariant</code> helper provided. <code>CRC32String</code> used for lightweight stable keys. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Safe external calls / integration pattern</strong><br>Use <code>SafeApplicationRun(procName, outResult, params)</code> and fallback <code>SafeCallCentral</code> to call host procedures without bubbling errors to UI. <code>TryExternalCall</code> is a thin wrapper. This pattern prevents host UI errors and is used to call <code>modUtilities</code>, <code>modAudit</code>, <code>modError</code>, <code>modRibbonCallbacks</code>, <code>modTests</code>, and other host modules when available. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Error handling & audit routing</strong><br><code>HandleCalcError(proc, errNum, errMsg)</code> funnels errors to: <code>modError.HandleError</code> (if present), <code>SafeLogEvent</code> (<code>modAudit.LogEvent</code>), <code>modAudit.LogEx</code> / <code>modAudit.Log</code> / <code>LogAudit</code>, or <code>AppendLocalAudit</code> fallback. Defaults to non-raising behavior unless <code>modCalculations.RaiseErrors</code> = True. All messages are redacted/truncated via <code>RedactSecrets</code> + <code>TruncateForCell</code> before local logging. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Local audit fallback</strong><br><code>AppendLocalAudit(message)</code> writes to a local <code>_IFRS_Audit</code> sheet if central audit is unavailable. Columns: <code>Timestamp, User, Message, CorrelationId</code>. Ensures minimal persistence for error contexts when central systems are missing. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Normalization utilities</strong><br><code>NormalizeArrayInput</code> — generic 1-D 1-based array coercion from <code>Range</code>, <code>Collection</code>, <code>Dictionary</code>, array, or scalar.<br><code>NormalizePaymentsForRead</code> — specialized coercer that always returns 1-based elements where each element is a 1..2 array <code>(date/label, amount)</code> (amount may be <code>Empty</code>) — handles multi-column ranges, dictionaries and collections robustly. Use these to sanitize input to schedule functions. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Depreciation functions</strong><br><code>CalcDepreciationEx(cost,usefulLife,method, salvage, unitsProduced, unitsTotal, rounding)</code> — supports <code>depStraightLine</code>, <code>depDecliningBalance</code>, <code>depSumOfYears</code>, <code>depUnitsOfProduction</code> with input validation and rounding via <code>applyRounding</code>.<br><code>GenerateDepreciationSchedule</code> — period-based schedules (fallbacks to SL for UoP when no units provided).<br><code>GenerateDepreciationScheduleEx</code> — <strong>units-of-production schedule</strong>: accepts <code>unitsSeries</code> (range/array/collection/dictionary/scalar) normalized via <code>NormalizePaymentsForRead</code>; sums units and allocates expense proportionally; enforces <code>MAX_SCHEDULE_ROWS</code>. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Lease amortization / payment helpers</strong><br><code>LeaseAmortizationSchedule(pmt, ratePerPeriod, periods, startDate)</code> returns <code>(1..n,1..6)</code> amortization rows computed in-memory. Uses <code>PvFromPmt</code> to compute opening balance and handles near-zero rates. Rounding applied to payment/interest/principal; final row adjusted to reconcile residual differences. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>PV & NPV</strong><br><code>PvFromPmt(pmt, rate, nper)</code> — robust PV calculation: handles <code> | rate | &lt; RATE_NEAR_ZERO</code>by using<code>pmt*n</code>, clamps <code>nper</code>to<code>PV_MAX_NPER</code>, ensures positive result for asset balances.<br><code>NPVFromArray(cashflows, discountRate)</code>— accepts scalar or array with arbitrary LBound/UBound; validates<code>discountRate &gt; -1</code>and sums discounting by<code>periodIndex</code>. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Expected credit loss (ECL)</strong><br><code>ExpectedCreditLoss(exposure, pd, lgd)</code> — returns <code>exposure * pd * lgd</code> with bounds checks (<code>pd</code>, <code>lgd</code> in [0,1]).<br><code>ExpectedCreditLossBatch(exposures,pds,lgds)</code> — normalizes inputs, supports element-wise computation and returns a 1-based array of doubles. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Dates & day-counts</strong><br><code>YearFraction(d1,d2,method)</code> supports <code>dcAct365</code> (default), <code>dcAct360</code>, <code>dc30_360</code> (basic US 30/360). Deterministic, normalizes tiny negative results to 0. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Self-tests & CI hooks</strong><br><code>CalculationsSelfTest()</code> — expanded deterministic self-test harness (repeats checks 10×), validates core functions (depreciation, EBITDA, revenue recognition, ECL, deferred tax, lease PV behavior, NPV), writes results to <code>_IFRS_TestResults</code> (very hidden) and attempts to register with <code>modTests.RegisterSelfTest</code>. Use this function in CI and pre-release checks. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Job lifecycle & host integration</strong><br><code>EnqueueCalculationJob(jobName,meta)</code> returns correlation id; attempts <code>modRibbonCallbacks.EnqueueJob</code> else logs locally.<br><code>UpdateJobMeta</code>, <code>FindJobRow</code>, <code>CancelCalculationJob</code> integrate with <code>modRibbonCallbacks</code> where present and fall back to safe local logging if central callbacks absent. <code>ReconcileOrphanedJobs</code> / <code>ReconcileOrphanedJobsOnOpen</code> are reconciliation hooks for host startup. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Export & maturity helpers</strong><br><code>BuildMaturityAnalysis(payments, outSheetName)</code> — normalizes payments and writes a compact maturity table to <code>outSheetName</code> (<code>CorrelationId, Index, Value, Timestamp</code>); respects <code>MAX_SCHEDULE_ROWS</code>.<br><code>ExportSheetToCsv(sheetName, csvPath)</code> — copies sheet to new workbook and saves as CSV (best-effort). </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Logging & telemetry expectations</strong><br>Module uses <code>SafeLogEx</code> wrapper to send structured logs to <code>modAudit</code>/<code>LogEvent</code> where available; emits contextual events (<code>SelfTest</code> result, schedule truncation warnings, provider fallbacks). Sensitive strings redacted by <code>RedactSecrets</code> and truncated to <code>MAX_AUDIT_MSG_LEN</code>. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Security & data handling</strong><br><code>RedactSecrets</code> performs lightweight heuristics (replaces <code>@</code> with <code>[at]</code> and truncates) to avoid leaking secrets to local audit. All external calls are made via safe wrappers to avoid unexpected UI exceptions. Avoid storing raw secrets in <code>ContextJSON</code> or direct function parameters. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Dependencies & compatibility notes</strong><br>Soft dependencies: <code>modUtilities</code> (central rounding), <code>modAudit</code> (structured logs), <code>modError</code> (central error handling), <code>modRibbonCallbacks</code> (job orchestration), <code>modTests</code> (self-test registration). All are invoked via safe wrappers; module continues to function with local fallbacks if they are missing. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Limitations & cautions</strong><br>• Central rounding depends on <code>modUtilities</code> — if absent, local rounding used.<br>• Large <code>nper</code> and tiny rates are guarded but extreme inputs may still be numerically sensitive; validate inputs upstream.<br>• <code>GenerateDepreciationSchedule</code>’s <code>depUnitsOfProduction</code> falls back to straight-line if units series not supplied — prefer <code>GenerateDepreciationScheduleEx</code> for units-based schedules.<br>• <code>AppendLocalAudit</code> creates a simpler local <code>_IFRS_Audit</code> if central audit missing — this may differ from <code>modAudit</code> canonical schema. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Examples</strong><br><code>sch = LeaseAmortizationSchedule(100, 0.01, 36)</code> → returns (1..36,1..6) amortization table.<br><code>dep = CalcDepreciationEx(1000, 5, depStraightLine)</code> → per-period expense.<br><code>units = Array(10,20,30): sched = GenerateDepreciationScheduleEx(600, units)</code> → UoP schedule; sum of <code>DepreciationExpense</code> ≈ <code>cost - salvage</code>.<br><code>ecl = ExpectedCreditLoss(10000, 0.02, 0.5)</code> → 100. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Operational recommendations</strong><br>• Call <code>InvalidateModCalculationsCache</code> after runtime config updates.<br>• Run <code>CalculationsSelfTest</code> in CI or on deployment to validate numeric paths.<br>• Prefer <code>NormalizePaymentsForRead</code> for any payment schedule input to ensure deterministic shape.<br>• Restrict who can toggle <code>modCalculations.RaiseErrors</code> — raising errors surfaces exceptions to host UI. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Troubleshooting checklist</strong><br>1. Incorrect rounding results → verify <code>modCalculations.RoundPolicy</code> and <code>UseCentralRounding</code>; check <code>modUtilities</code> availability.<br>2. Truncated schedules → check <code>MAX_SCHEDULE_ROWS</code> and input normalization; Consult <code>SafeLogEx</code> entries for <code>Periods truncated</code> messages.<br>3. Missing central job integration → verify <code>modRibbonCallbacks</code> presence; otherwise local queueing/logging is used.<br>4. Self-test failures → inspect <code>_IFRS_TestResults</code> and run <code>GenerateDiagnostic</code> (host-side) or re-run <code>CalculationsSelfTest</code> in a clean workbook. </td></tr><tr><td data-label="Technical User Guide — modCalculations"> <strong>Maintenance notes for developers</strong><br>• Preserve public signatures when changing implementations.<br>• If adding config keys call <code>InvalidateModCalculationsCache</code> to refresh caches.<br>• Keep <code>RedactSecrets</code> and <code>TruncateForCell</code> updated if new sensitive patterns are used.<br>• Prefer array-based in-memory processing when adding new schedule algorithms to maintain performance. </td></tr></tbody></table></div><div class="row-count">Rows: 28</div></div><div class="table-caption" id="Table5" data-table="Docu_0158_05" style="margin-top:2mm;margin-left:3mm;"><strong>Table 5</strong></div>
<div class="table-wrapper" data-table-id="table-5"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — **modConfig**"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — <strong>modConfig</strong></div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modConfig"> <strong>Overview</strong><br>Central configuration, migration, and persistence utilities for <code>IFRS_Reporting_AddIn.xlam</code>. Manages a single authoritative config XML (<code>IFRSConfig</code>) stored in <code>CustomXMLPart</code> when available, with sheet-based fallback. Provides typed feature-flag and setting APIs, safe secret delegation, checksum verification, migration registry, cached read/write with configurable write policy (write-through / write-back), export/import, self-test harness and runtime integration points for audit and error handling. Designed for minimal, backward-compatible changes and hardened defaults. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Public API (key routines)</strong><br><code>LoadConfigXML()</code> / <code>LoadConfig()</code> — load authoritative XML (verify checksum when available).<br><code>GetConfigCached(forceRefresh)</code> — cached getter with TTL.<br><code>SetSetting(key,val)</code> / <code>GetSetting(key)</code> / <code>GetSettingTyped(key,type)</code> / <code>SetSettingTyped(key,val,type)</code> — settings accessors with TryRunReturn delegation fallback.<br><code>FeatureFlag_GetTyped(key)</code> / <code>FeatureFlag_Get(key)</code> / <code>FeatureFlag_IsEnabled(key)</code> / <code>FeatureFlag_SetTyped(key,value,type,expires)</code> / <code>FeatureFlag_Set</code> — typed feature flag APIs.<br><code>SaveConfigXML(xml)</code> — validate and persist config to CustomXMLParts (with checksum & schema props) or fallback to sheet; supports atomic-like replacement and cleanup of older parts.<br><code>ImportConfigFromFile(path)</code> / <code>ExportConfigToFile(path)</code> — file import/export using safe temp file rename/copy semantics.<br><code>RunMigrations(currentXml,targetVersion,commit)</code> — run registered migration routines (optionally commit).<br><code>RegisterMigration(from,to,routineName)</code> — register migration routine.<br><code>FlushPendingWrites()</code> — persist cached write-back content.<br><code>ResetToDefaults(commit)</code> — clear and write default config.<br><code>RunConfigSelfTests()</code> — built-in test suite writing <code>_IFRS_TestResults</code> and change history. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Stable constants & props</strong><br>Root name: <code>IFRSConfig</code>.<br>CustomDocumentProperties keys: <code>IFRS_Config_SchemaVersion</code> and <code>IFRS_Config_Checksum</code>.<br>Audit delegate name: <code>modAudit.LogAudit</code> (preferred). Secret prompt delegate: <code>Secret_Prompt_UI</code>. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Canonical storage & verification model</strong><br>Primary storage: <code>ThisWorkbook.CustomXMLParts</code> containing <code>IFRSConfig</code> XML. On save, module computes checksum (prefer SHA256 via system <code>certutil</code> probe; falls back to CRC32) and stores lowercased checksum in <code>IFRS_Config_Checksum</code> custom document property. On load, if checksum property exists, module locates the part whose computed checksum matches stored value—mismatch triggers backup and audit entry and load fails. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Fallback persistence</strong><br>If CustomXMLParts unavailable or add fails, module persists config into a hidden sheet <code>_IFRS_ConfigSheet</code> (cell A2). When using fallback, a CRC32-based checksum is recorded to <code>IFRS_Config_Checksum</code> property where possible. Fallback used only when necessary and audited. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Checksum & hashing behavior</strong><br>Preferred: SHA256 using <code>certutil</code> on Windows (writes temp file, runs <code>certutil -hashfile ... SHA256</code>, parses stdout). If unavailable or parsing fails, fallback CRC32 over UTF-8 bytes. Checksum string stored lowercase. Compute helpers mirror those in <code>modAudit</code> (CRC32 table + UTF-8 conversion using ADODB.Stream when available). </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Security & safe defaults</strong><br>Feature flags defaults: custom XML fallback disabled; prompt fallback disabled; local audit enabled; plaintext secret persist disabled; verbose logging disabled. Avoid enabling <code>allow_plaintext_secret_persist</code>. Use <code>SetAuditFeatureFlag</code> equivalents in <code>modAudit</code> only when trusted. <code>LogAuditLocal</code> delegates to <code>modAudit.LogAudit</code> (via <code>TryRunReturn</code>) and falls back to immediate window if unavailable. <code>Config_SetSecret</code> delegates to <code>modSecurity</code> (or legacy) and refuses plaintext persistence if delegate missing. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Delegation & optional cross-module calls</strong><br><code>TryRunReturn(procName, ParamArray args())</code> — robust wrapper that attempts <code>Application.Run</code> with 0..9 args and returns <code>Empty</code> on failure; used for optional integration points (audit, security, utilities, ribbon, error handlers, migrations). All external calls are non-fatal; failures are logged via <code>LogAuditLocal</code>. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Caching, write policies & debounce</strong><br>In-memory cache: <code>CacheXml</code>, <code>CacheTimestamp</code>, <code>CacheDirty</code> with TTL <code>CacheTTLSeconds</code> (default 60). WritePolicy options: <code>write_through</code> (default) — immediate persist on <code>SetSetting</code>/<code>FeatureFlag_SetTyped</code>; <code>write_back</code> — keep cached changes and persist later via <code>FlushPendingWrites</code>. <code>WriteDebounceSeconds</code> controls deferred flush behavior under write-back; <code>LastWriteTimestamp</code> used for debounce. <code>ModuleLock</code> prevents concurrent writes. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Validation rules</strong><br><code>ValidateConfigXML_Explain(xml)</code> performs structural checks: XML declaration present, root <code>&lt;IFRSConfig&gt;</code> present, <code>&lt;SchemaVersion&gt;</code> required. Additional pragmatic checks: <code>IFRS.RoundingPrecision</code> must be integer 0..10; <code>IFRS.DayCount</code> must be one of <code>30/360</code>, <code>ACT/365</code>, <code>ACT/360</code>, <code>ACT/ACT</code>. Validation sets <code>LastValidationError</code> for diagnostics. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Migration framework</strong><br>Deterministic registry (<code>Scripting.Dictionary</code>) maps <code>from | to</code>→<code>routineName</code>. Built-in registration includes <code>&quot;1.0.0 | 1.1.0&quot; → &quot;Migrate_v1_0_0_to_v1_1_0&quot;</code>. <code>BuildMigrationPath(current,target)</code>builds ordered routine collection and enforces a safety bound.<code>RunMigrations</code>invokes built-ins directly or<code>TryRunReturn</code> for external routines; supports optional commit to persist migrated XML. Migration routines must return transformed XML; failures are audited and abort the migration run. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Feature flags & settings model</strong><br>Settings and feature flags are stored as XML elements (<code>&lt;Setting key=&quot;&quot; value=&quot;&quot;/&gt;</code>, <code>&lt;Flag key=&quot;&quot; value=&quot;&quot; type=&quot;&quot; expires=&quot;&quot;/&gt;</code>) inside <code>&lt;Settings&gt;</code> and <code>&lt;FeatureFlags&gt;</code>. Typed getters parse <code>type</code> and <code>expires</code> attributes; <code>FeatureFlag_IsEnabled</code> handles boolean interpretations and expiry dates. <code>FeatureFlag_SetTyped</code> updates or inserts flag nodes and respects write policy semantics (write-through vs write-back). </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Secret management & delegation</strong><br>Secrets are not stored by this module directly; <code>Config_GetSecret</code> / <code>Config_SetSecret</code> attempt delegated calls to <code>modSecurity</code> or legacy functions via <code>TryRunReturn</code>. If no secure delegate exists, <code>Config_SetSecret</code> returns <code>False</code> and refuses plaintext persistence. UI prompts for secrets should be delegated to <code>Secret_Prompt_UI</code> when present. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Export/Import atomic behavior</strong><br><code>ExportConfigToFile(fullPath)</code> writes XML to a temp file in <code>GetSafeTempFolder()</code> then renames/moves to <code>fullPath</code> (uses <code>Name</code> or <code>Scripting.FileSystemObject.CopyFile</code> fallback) to avoid partial writes. <code>ImportConfigFromFile</code> reads file as binary, validates via <code>ValidateConfigXML_Explain</code>, then persists via <code>SaveConfigXML</code>. Errors produce audit entries and <code>ImportConfigFromFile</code> fails safe. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Change history & audit trail</strong><br><code>AppendChangeHistory(action,oldVal,newVal,corrId)</code> appends redacted entries to <code>_IFRS_ConfigHistory</code> worksheet with timestamp, user, action and correlation id. Secrets in history are redacted via <code>RedactSecrets</code> (simple pattern replacements). All important operations log via <code>LogAuditLocal</code> (delegated). </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Concurrency & safety</strong><br><code>ModuleLock</code> prevents overlapping writes during <code>SaveConfigXML</code>. Persists attempt to replace custom XML parts atomically by adding new part, deleting older matching root parts, and writing checksum/document props only after successful compute. On commit failure, module performs <code>BackupConfigXML</code> to a temp file and emits audit <code>ConfigError</code>. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Self-test & diagnostics</strong><br><code>RunConfigSelfTests()</code> performs a sequence of tests (save/load, feature flag round-trip, setting round-trip, typed setters, flush, fallback sheet presence, export/import round-trip) and writes <code>_IFRS_TestResults</code>. Use this regularly in pre-deployment or CI. <code>GetLastValidationError()</code> returns last validation failure reason. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Error handling & integration with modError</strong><br><code>HandleConfigError(proc,msg)</code> logs via audit, attempts to call <code>modError.HandleError</code> or legacy probe <code>modError_Probe_HandleError</code> via <code>TryRunReturn</code>, and raises a VBA error with correlation id to propagate. <code>IsErrorHandlerAvailable</code> probes for error handler presence non-disruptively. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Utilities & platform awareness</strong><br><code>GetSafeTempFolder()</code> gathers candidates: <code>TEMP</code>/<code>TMP</code> env vars, workbook path, <code>Application.DefaultFilePath</code>, macOS <code>MacScript</code> temporary items when available. UTF-8 conversion uses <code>ADODB.Stream</code> when present; falls back to <code>StrConv</code>. GUID generation uses <code>Scriptlet.TypeLib</code> with randomized fallback. <code>GetThisAddinSchemaVersion()</code> returns current schema version <code>1.1.0</code>. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Operational guidance & best practices</strong><br>• Initialize module (<code>EnsureModuleInitialized</code> implicitly called) before bulk operations.<br>• Keep <code>CustomDocumentProperties</code> writeable to permit checksum and schema storage.<br>• Prefer <code>write_through</code> for critical environments; use <code>write_back</code> only when you accept delayed persistence and ensure <code>FlushPendingWrites</code> runs on controlled shutdown or CI hooks.<br>• Disable plaintext secret persistence and require <code>modSecurity</code> integration for secret storage.<br>• Restrict access to backup folder and archives; review <code>BackupConfigXML</code> outputs periodically. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Runbook triggers & monitoring</strong><br>• Checksum mismatch on <code>LoadConfigXML</code> → create backup, emit <code>ConfigError</code> audit entry, escalate to <code>config-compromise</code> runbook.<br>• <code>SaveConfigXML</code> commit error or fallback path → audit <code>Config</code>/<code>ConfigError</code> and schedule manual verification of stored XML and checksum.<br>• Migration failures → audit <code>Migration</code> and block auto-commit until human review. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Limitations & migration notes</strong><br>• Module does not implement encrypted signing of config; signatures must be performed externally (CI signing) and associated with release manifest.<br>• SHA256 depends on system tools (<code>certutil</code> / Windows); on locked-down systems CRC32 is used (non-cryptographic). Plan acceptance criteria accordingly.<br>• XML edits are string-based (no DOM parser), so complex XML shapes should be validated and tested by migrations. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Troubleshooting checklist</strong><br>1. <code>LoadConfigXML</code> returns empty: check <code>IFRS_Config_Checksum</code> property, verify <code>CustomXMLParts</code> presence, review audit <code>ConfigError</code> entries and backup files created by <code>BackupConfigXML</code>.<br>2. Save failing and writing to sheet: workbook may lack <code>CustomXMLParts</code> support or permissions—inspect <code>_IFRS_ConfigSheet</code> and <code>_IFRS_ConfigHistory</code> for clues.<br>3. Checksum mismatch: run <code>ComputeChecksumForCustomXMLPart</code> manually (debug) and compare to <code>IFRS_Config_Checksum</code> property; if mismatch, restore backup and re-run <code>Verify</code>/<code>RunMigrations</code> as needed.<br>4. Migration failure: check <code>_IFRS_TestResults</code> and audit <code>Migration</code> entries, run migration routines locally using <code>RunMigrations(currentXml,target,False)</code> to reproduce. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Developer notes (integration)</strong><br>• Use <code>TryRunReturn</code> for optional cross-module calls; always handle <code>Empty</code> returns.<br>• Use <code>LogAuditLocal</code> rather than direct <code>LogAudit</code> to prefer modAudit delegation and avoid raising errors from missing audit module.<br>• Keep migration routines idempotent and return the transformed XML string. Register them via <code>RegisterMigration</code> in initialization. </td></tr><tr><td data-label="Technical User Guide — modConfig"> <strong>Examples</strong><br>Feature flag element: <code>&lt;Flag key=&quot;feature.enable_verbose_logging&quot; value=&quot;true&quot; type=&quot;bool&quot; expires=&quot;2026-01-01T00:00:00Z&quot;/&gt;</code>.<br>Setting element: <code>&lt;Setting key=&quot;IFRS.RoundingPrecision&quot; value=&quot;4&quot;/&gt;</code>.<br>CustomDocumentProperty: <code>IFRS_Config_Checksum = &quot;e3b0c442...&quot;</code> (lowercase SHA256 or crc32). </td></tr></tbody></table></div><div class="row-count">Rows: 25</div></div><div class="table-caption" id="Table6" data-table="Docu_0158_06" style="margin-top:2mm;margin-left:3mm;"><strong>Table 6</strong></div>
<div class="table-wrapper" data-table-id="table-6"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modDataInput"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modDataInput</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modDataInput"> <strong>Overview & Purpose</strong><br>Hardened import pipeline for IFRS Excel add-in. Responsible for safe ingestion of trial-balance style data from sheets, CSV, workbook ranges, JSON, or PowerQuery stubs. Built for defensive operation: optional external integrations (modConfig, modUtilities, modAudit, modError, modSecurity, modRibbonCallbacks), idempotent staging/commit, schema-driven validation, diagnostics, migration hooks, and self-test scaffolding. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Public API (backwards-compatible)</strong><br><code>ImportTrialBalance()</code> — legacy entry point (calls <code>ImportTrialBalanceAdvanced</code>).<br><code>ValidateCOA(accountCode)</code> — simple chart-of-accounts validation (kept compatible).<br><code>ImportTrialBalanceAdvanced(sourceType, sourcePath, targetWb, profileName, dryRun, allowOverwrite)</code> — full import driver. <br><code>EnqueueImportJob(jobId, handlerProcName, whenUtc)</code> — job enqueue wrapper. <br><code>CreateSampleTemplate([wb])</code>, <code>ExportSampleTemplateCSV(path)</code> — sample artifacts. <br><code>DataInputSelfTests()</code> / <code>DataInput_SelfTest()</code> — self-test harness. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Key constants & defaults</strong><br><code>STAGING_SHEET_NAME = &quot;_IFRS_Staging&quot;</code>; <code>IMPORT_PREVIEW_SHEET = &quot;_IFRS_Preview&quot;</code>; <code>IMPORT_ERRORS_SHEET = &quot;_IFRS_ImportErrors&quot;</code>; <code>IMPORT_LOCK_SHEET = &quot;_IFRS_ImportLock&quot;</code>; <code>DEFAULT_IMPORT_DEST_SHEET = &quot;TrialBalance&quot;</code>; <code>ROWID_HEADER = &quot;IFRS_RowID&quot;</code>; <code>STREAMING_THRESHOLD_BYTES = 3 MB</code>; <code>MAX_OPEN_RETRIES = 3</code>; <code>MODULE_SCHEMA_VERSION = 1</code>. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Guarantees & design constraints</strong><br>• Public signatures unchanged for backward compatibility.<br>• Public entry points swallow unhandled exceptions and funnel to <code>HandleError</code> / error audit (no UI exceptions).<br>• Defensive use of <code>TryRunReturn</code> for optional external module calls; empty return = treated as unavailable.<br>• Idempotent staging writes and atomic commit attempts (delegated to <code>modUtilities.AtomicSaveWorkbookAs</code> if available). </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Caching & runtime flags</strong><br><code>g_cacheColumnMap</code>, <code>g_cacheConfig</code> (Scripting.Dictionary) — cached config & column mappings; <code>EnsureCachesInit</code> / <code>InvalidateDataInputCache</code> available. <code>g_isRunning</code> — reentrancy guard. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Inter-module integration & safe invocation</strong><br><code>TryRunReturn(procName, ParamArray)</code> — safe wrapper for <code>Application.Run</code> with up to 9 args; returns <code>Empty</code> on error. Use <code>TryRunReturn</code> to call <code>modConfig</code>, <code>modAudit</code>, <code>modUtilities</code>, <code>modError</code>, <code>modSecurity</code>, <code>modRibbonCallbacks</code>. All calls are best-effort — module continues if unavailable. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Audit & error funnel</strong><br><code>SafeLog(source, message, level)</code> — attempts (in order): <code>modAudit.LogEvent</code>, <code>modAudit.LogAudit</code>, <code>modRibbonCallbacks.LogEvent</code>, then <code>AppendLocalAudit</code> fallback which writes a simple <code>_IFRS_Audit</code> sheet if modAudit is unavailable. All logged messages are redacted by <code>RedactSecrets</code> before emission.<br><code>HandleError(routineName, errNum, errDesc, corrId)</code> — attempts <code>modError.HandleError</code> variants, otherwise <code>AppendLocalAudit</code>. <code>SafeHandleError</code> wrapper calls <code>HandleError</code> silently. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Staging model & schema</strong><br>Staging sheet token <code>STAGING_SCHEMA_TOKEN</code> placed in cell A1. <code>CreateOrEnsureStagingSheet</code> locates or creates hidden staging sheet. <code>EnsureStagingSchema</code> guarantees token and moves headers down to prepare sheet for clean staging. <code>WriteArrayToSheetAtomic(ws, arr, trimEmptyCols)</code> writes staging data using array assignment. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Row identity & idempotency</strong><br><code>AssignStableRowIDs(stagingWs, correlationId)</code> ensures <code>IFRS_RowID</code> column exists and assigns stable IDs <code>RB-&lt;utcstamp&gt;-&lt;row&gt;-&lt;6digit&gt;</code> to missing IDs. Uses <code>GetUtcStampForId()</code> to produce UTC component. IDs prevent accidental duplication across runs and assist error mapping. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Preview & commit workflow</strong><br><code>PreviewImport(stagingWs, rowsToShow, corrId)</code> — creates <code>_IFRS_Preview</code> visible sheet for operator review (first N rows).<br><code>CommitStagingToDestination(wb, stagingWs, destSheetName, allowOverwrite, corrId)</code> — creates backup if destination exists (prefix <code>_IFRS_Backup_</code>), copies staging <code>UsedRange</code> to destination via direct range assignment, renames staging sheet to <code>_IFRS_Staging_COMMITTED_&lt;ts&gt;</code>, attempts atomic save using <code>GetConfigValue(&quot;DataInput.AtomicSave.Path&quot;)</code> and <code>SaveWorkbookAsAtomic</code>, logs outcome. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Validation pipeline (schema-driven)</strong><br><code>ValidateStagingSheetSchemaDriven(stagingWs, corrId)</code> — header detection + column map overlay from config (<code>DataInput.ColumnMap.*</code>), rule set includes <code>account</code> (required) and <code>balance</code> (required,numeric,nonzero). Per-row checks, COA validation via <code>ValidateCOA</code>, returns <code>Scripting.Dictionary</code> of errors keyed by row. <code>WriteErrorsToSheet</code> writes <code>_IFRS_ImportErrors</code> with row, message, and <code>IFRS_RowID</code>. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Duplicate detection</strong><br><code>DetectDuplicatesInStaging(stagingWs, keyColumns)</code> — grouping by concatenated key columns (defaults <code>[&quot;account&quot;,&quot;balance&quot;]</code>) and returns dictionary of groups with row collections. Useful pre-commit. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Concurrency / locking</strong><br><code>AcquireImportLock(wb, corrId)</code> — creates <code>_IFRS_ImportLock</code> very-hidden sheet recording timestamp and owner correlation id. If a lock exists and age > 60 minutes, lock is considered stale and removed. <code>ReleaseImportLock(wb, corrId)</code> deletes lock only if caller owns it (or if corrId empty). Lock prevents concurrent imports across processes/users. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Read adapters & parsing</strong><br>• <code>ReadFromActiveSheetToArray</code> reads <code>UsedRange</code> to array.<br>• <code>ReadCsvToArray(fullPath)</code> — robust CSV reader: reads binary, normalizes BOM/newlines, builds logical CSV records with <code>BuildCsvLogicalRecords</code> (handles quoted newlines), splits lines with <code>SplitCsvLine_Strict</code> (handles quoted fields, escaped quotes), returns 2D VBA array. Handles large files by streaming read. <br>• <code>ReadWorkbookRangeToArray(path)</code> — opens workbook read-only with retry loop (<code>MAX_OPEN_RETRIES</code>) and fallback to already-open workbook. <br>• <code>ReadJsonToArray(path)</code> — simple JSON array/object parser with regex-based field extraction when VBScript.RegExp available, fallback to <code>JsonArrayToVBAArray</code>. Accepts only array top-level. Not a full JSON parser — suitable for well-formed simple JSON arrays/objects. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Text & binary helpers</strong><br><code>ReadBinaryStreamAsString</code> — block read; <code>NormalizeTextNewlinesAndBOM</code> removes UTF BOMs and normalizes line endings; <code>BuildCsvLogicalRecords</code> assembles logical records respecting quoted newlines. <code>SplitCsvLine_Strict</code> implements RFC-style field parsing with doubled-quote escape handling. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Security & path policy</strong><br><code>IsAllowedPath(path)</code> — delegates to <code>modSecurity.Security_AllowExportToPath</code> / <code>modSecurity.Security_AllowPath</code> if available; otherwise forbids obvious system paths (e.g., <code>C:\Windows</code>, <code>/etc</code>) and allows other paths. Use policy to prevent reading/writing sensitive system locations. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Atomic save & backups</strong><br><code>SaveWorkbookAsAtomic(wb, fullPath)</code> attempts <code>modUtilities.AtomicSaveWorkbookAs</code> first, then falls back to <code>wb.SaveCopyAs</code>. Commit creates a backup sheet named <code>_IFRS_Backup_&lt;dest&gt;_&lt;yyyymmdd_HHNNSS&gt;</code> if overwritten; backups are hidden (<code>xlSheetVeryHidden</code>). </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Diagnostics & telemetry</strong><br><code>CollectDiagnostics(stagingWs)</code> returns dictionary: <code>ok</code>, <code>rowsRead</code>, <code>issuesCount</code>, <code>corrId</code>, <code>timeTaken</code>. <code>WriteIntegrationTestPlan</code> and <code>DataInput_SelfTest</code> provide integration/self-test artifacts (<code>_IFRS_TestResults</code>). Logging calls use <code>SafeLog</code> to ensure telemetry reaches <code>modAudit</code> when available. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Migration & versioning</strong><br><code>MODULE_SCHEMA_VERSION = 1</code>; <code>PlanMigrateExistingInputs()</code> emits migration plan logs. Staging token <code>STAGING_SCHEMA_v1</code> used to locate legacy staging sheets for safe migration. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Self-test scaffolding</strong><br>Self-tests exercise CSV parsing, staging roundtrip, atomic write fallback, and JSON read. Self-test writes <code>_IFRS_TestResults</code> sheet and attempts <code>modUtilities.AtomicWriteFile</code> when available. Tests are best-effort and log via <code>SafeLog</code>. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Job queue integration</strong><br><code>EnqueueImportJob</code> attempts <code>modRibbonCallbacks.EnqueueJob</code>, then <code>modUtilities.EnqueueJob</code>, and finally falls back to <code>Application.Run(handlerProcName)</code> (synchronous). On outcome, <code>StoreJobMetadata</code> writes <code>_IFRS_Jobs</code> sheet row with job id, handler, whenUtc, enqueuedAt, status, and correlation id. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Error handling & fallbacks (practical behavior)</strong><br>All I/O and external calls use <code>On Error</code> defensive patterns. Fallbacks include: local audit sheet when modAudit unavailable, per-row append fallback when bulk write fails, SaveCopyAs when atomic save unavailable, simple regex JSON parse when parser unavailable. Internal error telemetry (<code>HandleError</code>) ensures failures are recorded without surfacing exceptions to UI. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Operational recommendations</strong><br>• Initialize <code>modAudit</code> / <code>modConfig</code> where possible so <code>SafeLog</code> and config mapping work fully.<br>• Run imports from a secured environment; restrict <code>IsAllowedPath</code> via <code>modSecurity</code> policy.<br>• Use <code>dryRun = True</code> to validate without committing.<br>• Run <code>ValidateStagingSheetSchemaDriven</code> and <code>DetectDuplicatesInStaging</code> before <code>CommitStagingToDestination</code>.<br>• Ensure <code>AUDIT</code> module chain verification (from modAudit guide) runs in CI; when <code>SafeLog</code> writes to local fallback audit sheet, ensure those sheets are protected and exported for long-term retention. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Troubleshooting checklist</strong><br>• Empty read results: confirm <code>IsAllowedPath</code> and source existence, inspect <code>_IFRS_ImportErrors</code> and <code>_IFRS_Audit</code> fallback.<br>• Staging cannot be created: check workbook protection and macro permissions; <code>CreateOrEnsureStagingSheet</code> searches very-hidden sheets for token.<br>• Lock acquisition fails: existing <code>_IFRS_ImportLock</code> present and not stale (less than 60 min).<br>• CSV parsing issues: check unusual quoting/escaping; examine <code>SplitCsvLine_Strict</code> behavior and <code>BuildCsvLogicalRecords</code> output in debug.<br>• Atomic save did not run: verify <code>modUtilities</code> availability and <code>DataInput.AtomicSave.Path</code> config. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Limitations & gotchas</strong><br>• JSON parsing is heuristic and not a full JSON engine; complex nested objects or arrays may not parse correctly — prefer normalized CSV for robust import.<br>• Self-tests and some helpers call external modules (<code>modUtilities</code>, <code>modSecurity</code>); absence does not stop the flow but reduces guarantees (atomic saves, path checks).<br>• <code>AssignStableRowIDs</code> creates IDs based on current UTC stamp and random part — uniqueness is highly likely but not cryptographically guaranteed. <br>• Large CSV files are read fully into memory by <code>ReadCsvToArray</code> — watch memory limits; streaming thresholds are only advisory. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Cross-module considerations (modAudit integration)</strong><br>• <code>SafeLog</code> and <code>HandleError</code> attempt to use <code>modAudit</code> first; enable <code>modAudit</code> (<code>InitAuditModule</code>) in host workbook for full chain-of-trust telemetry.<br>• Correlation IDs: modDataInput uses <code>GenerateCorrelationID()</code> (format <code>CID-yyyymmddHHMMSS-######</code>), whereas modAudit uses <code>NewCorrelationId()</code> — both are acceptable but note differences when correlating records across modules; consider centralizing correlation id generation in config for consistent tracing.<br>• When modAudit unavailable, <code>AppendLocalAudit</code> writes minimal audit rows to <code>_IFRS_Audit</code> (Timestamp, Message); these are not cryptographically chained — export and feed into central audit process if needed. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Recommended test & CI practices</strong><br>• Include <code>VerifyAuditChain</code> (modAudit) in CI and run <code>ImportTrialBalanceAdvanced</code> in a dry-run mode with representative sample inputs.<br>• Add integration tests that assert: staging creation, stable row ids assignment, validation errors produce <code>_IFRS_ImportErrors</code>, commit creates destination + backup, and <code>SaveWorkbookAsAtomic</code> behavior when <code>modUtilities</code> available. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Maintenance & future improvements</strong><br>• Replace heuristic JSON parsing with a robust JSON engine (COM or library) when allowed.<br>• Add configurable lock expiry and lock-owner diagnostics metadata.<br>• Optionally unify correlation ID generation to <code>modAudit</code> provider for end-to-end traceability.<br>• Expose streaming CSV reader for very-large files to avoid memory pressure. </td></tr><tr><td data-label="Technical User Guide — modDataInput"> <strong>Short examples</strong><br>Import dry-run from CSV (pseudo-call): <code>ImportTrialBalanceAdvanced &quot;csv&quot;, &quot;C:\imports\tb.csv&quot;, Nothing, &quot;&quot;, True, False</code> → reads CSV, stages, validates, writes <code>_IFRS_Preview</code>, writes <code>_IFRS_ImportErrors</code> if validation fails, does not commit.<br>Commit example (allowed overwrite): <code>ImportTrialBalanceAdvanced &quot;sheet&quot;, &quot;&quot;, ThisWorkbook, &quot;&quot;, False, True</code> → reads <code>TrialBalance</code> sheet, stages, validates, backup existing <code>TrialBalance</code>, writes new sheet, attempts atomic save if configured. </td></tr></tbody></table></div><div class="row-count">Rows: 29</div></div><div class="table-caption" id="Table7" data-table="Docu_0158_07" style="margin-top:2mm;margin-left:3mm;"><strong>Table 7</strong></div>
<div class="table-wrapper" data-table-id="table-7"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modError"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modError</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modError"> <strong>Purpose & scope</strong><br><code>modError</code> is the centralized, deterministic error-handling and diagnostics module for the IFRS Excel add-in. It standardizes error classification, user-facing messaging, redaction, telemetry emission, and local audit persistence. The module is explicitly designed to degrade safely when optional dependencies (<code>Scripting.Dictionary</code>, <code>modAudit</code>, <code>modConfig</code>) are unavailable, ensuring errors are never lost and execution never fails catastrophically due to logging or diagnostics. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Design principles</strong><br>• Deterministic behavior (no uncontrolled side effects).<br>• Backward compatibility with existing callers.<br>• Safe-by-default redaction and truncation.<br>• “Never throw” philosophy for diagnostics paths.<br>• Clear separation between internal diagnostics and user-facing messages.<br>• Local persistence even when higher-order audit systems are missing. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Core concepts</strong><br>Errors are represented internally using the <code>IFRS_Error</code> type and are associated with a correlation ID for traceability across procedures and modules. Each error may produce multiple telemetry events (start, handled, fallback) and at least one durable audit record. The module distinguishes between <em>internal messages</em> (for developers/audit) and <em>user messages</em> (for UI display). </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Severity model</strong><br><code>IFRS_ErrorSeverity</code> enum provides four ordered levels:<br>• <code>sevInfo</code> — informational, no remediation required.<br>• <code>sevWarning</code> — non-fatal issue, workflow may continue.<br>• <code>sevError</code> — operation failed, user action required.<br>• <code>sevCritical</code> — unrecoverable state or invariant violation.<br>Severity influences audit content, telemetry, and default catalog values but does not alter control flow directly. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Error catalog</strong><br>The catalog maps numeric error codes to default user messages, remediation guidance, and default severity. Initialization is lazy and attempted once per session (<code>EnsureCatalogInitialized</code>). If <code>Scripting.Dictionary</code> cannot be created, catalog lookups silently fall back to generic messages. This guarantees callers never block on catalog availability. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Catalog lifecycle & guarantees</strong><br>• Initialization is idempotent and guarded.<br>• Failure to initialize does not raise errors.<br>• Catalog contents are deterministic and versioned implicitly by module version.<br>• Callers may introspect catalog availability for testing and diagnostics. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Audit persistence model</strong><br><code>modError</code> maintains its own local audit sheet (<code>_IFRS_Audit</code>) as a last-resort system of record. This audit is independent of <code>modAudit</code> and requires no cryptographic provider or external tooling. The sheet is created on demand, marked <code>xlSheetVeryHidden</code>, and written using array transfers to minimize partial writes and reentrancy risk. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Simple audit append (<code>AppendLocalAudit</code>)</strong><br>Writes a minimal five-column record: timestamp, user, category, correlation ID, payload. Intended for fallback telemetry and bootstrap/self-check events. Payload length is capped to Excel limits and truncated safely. This method never computes checksums or schema versions and should be used only when structured context is unavailable. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Structured audit append (<code>AppendLocalAuditStructured</code>)</strong><br>Writes a normalized, versioned record with explicit columns: Timestamp, User, Category, Subject, CorrelationId, ErrNum, Severity, Outcome, Context, SchemaVersion, Checksum. Context and outcome are redacted and truncated. A CRC32 checksum is computed over the canonical payload to detect accidental corruption or tampering. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Audit schema versioning</strong><br><code>AUDIT_SCHEMA_VERSION</code> is embedded per row to allow future readers or migration tooling to interpret historical records correctly. Version increments must be backward-compatible and documented in release notes. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Checksum semantics</strong><br>The CRC32 checksum is intended as an integrity check only. It detects accidental edits or corruption but is not cryptographically secure. For tamper-evident, signed, or chained audit requirements, <code>modError</code> delegates to <code>modAudit</code> when available. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Redaction & normalization pipeline</strong><br>All user-visible and contextual strings pass through <code>RedactAndNormalize</code> before persistence. The pipeline removes or masks emails, PAN-like numbers, bearer/API keys, long token-like sequences, and (in strict mode) GUIDs. Whitespace is normalized and final output truncated. Redaction level is configurable via <code>modConfig</code> with safe defaults. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Redaction levels</strong><br>• Level 0 — no redaction (not recommended).<br>• Level 1 — moderate (default): tokens, emails, PANs, keys.<br>• Level 2 — strict: additionally redacts GUID-like identifiers.<br>Redaction failures never throw; best-effort masking is always applied. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Correlation ID strategy</strong><br>Correlation IDs provide cross-module traceability. Generation order:<br>1. Native GUID via <code>Scriptlet.TypeLib</code> (preferred).<br>2. Timestamp + seeded random suffix fallback.<br>Format: <code>IFRS-YYYYMMDDhhmmss-&lt;suffix&gt;</code>. IDs are safe to log and truncate. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Telemetry emission</strong><br><code>SafeEmitTelemetryEvent</code> constructs a minimal JSON payload describing the event and attempts to delegate emission to <code>modAudit.EmitTelemetry</code>. If unavailable or failing, the payload is persisted locally using <code>AppendLocalAudit</code>. Telemetry paths are fully guarded and never throw. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Dynamic invocation & retries</strong><br>The module includes hardened wrappers (<code>SafeApplicationRun</code>, <code>SafeHasProcedure</code>) around <code>Application.Run</code>. These normalize failures into error variants and support optional retries via <code>RetryOperationByName</code>, including delay handling. This allows resilient orchestration of optional subsystems without compile-time dependencies. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Timing & sleep behavior</strong><br><code>SleepMs</code> prefers the native Windows <code>Sleep</code> API when available and safely falls back to a <code>DoEvents</code>-based loop otherwise. All sleep operations are guarded to avoid blocking the Excel host or raising runtime errors. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Configuration integration</strong><br>Configuration values are retrieved dynamically from <code>modConfig</code> when present. Missing or failing configuration lookups revert to explicit defaults. This allows <code>modError</code> to function correctly during early startup, degraded modes, or isolated testing. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Install-time self-check</strong><br><code>InstallTimeSelfCheck</code> validates the presence of critical optional dependencies (<code>modAudit</code>, <code>modConfig</code>) during startup. Results are written to the local audit. This enables operators and CI pipelines to detect incomplete deployments early without blocking execution. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Test harness</strong><br><code>RunModErrorSelfTests</code> executes a deterministic suite of at least ten checks covering catalog initialization, correlation ID uniqueness, redaction correctness, audit persistence, retry behavior, checksum determinism, and dependency probing. Results are written to <code>_IFRS_TestResults</code>, a very hidden worksheet suitable for CI artifact extraction. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Operational usage guidelines</strong><br>• Call <code>InstallTimeSelfCheck</code> during add-in bootstrap.<br>• Use structured audit appends for all handled errors.<br>• Use simple audit appends only for fallback or bootstrap scenarios.<br>• Prefer <code>modAudit</code> for long-term, signed, or chained audit retention.<br>• Periodically review catalog entries and redaction patterns. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Failure modes & guarantees</strong><br>No public procedure in <code>modError</code> intentionally propagates runtime errors. All diagnostics paths are guarded with <code>On Error Resume Next</code> and safe fallbacks. Failure to log, redact, emit telemetry, or read configuration must never prevent the primary business logic from completing or failing deterministically. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Limitations</strong><br>• CRC32 is not a security mechanism.<br>• Local audit is not append-only tamper-proof.<br>• Redaction is heuristic-based and must be reviewed periodically.<br>• Dynamic invocation cannot validate procedure signatures.<br>These limitations are addressed by integrating <code>modAudit</code> where higher assurance is required. </td></tr><tr><td data-label="Technical User Guide — modError"> <strong>Maintenance & evolution</strong><br>Any change to schema, redaction behavior, or catalog defaults must be versioned, documented, and accompanied by updated self-tests. Backward compatibility with existing callers and historical audit rows is a hard requirement. </td></tr></tbody></table></div><div class="row-count">Rows: 24</div></div><div class="table-caption" id="Table8" data-table="Docu_0158_08" style="margin-top:2mm;margin-left:3mm;"><strong>Table 8</strong></div>
<div class="table-wrapper" data-table-id="table-8"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modExport"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modExport</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modExport"> <strong>Overview</strong><br><code>modExport</code> provides hardened, backward-compatible export and packaging utilities for the IFRS add-in: PDF, CSV (streaming), XLSX, CustomXML, ZIP packaging, audit integration, atomic IO fallbacks, retries/backoff, security allowlists, PII-aware redaction hooks, job-integration stubs, and self-tests. Designed for reliability on both Windows and macOS with defensive fallbacks when host helpers are missing. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Public API (preserved signatures)</strong><br><code>ExportToPDF(Optional fileName, Optional targetWb)</code> — legacy; raises on failure.<br><code>ExportToPDFEx(Optional fileName, Optional targetWb) As Boolean</code> — new boolean wrapper.<br><code>ExportWorksheetToCsv(Optional targetWb, Optional sheetName, Optional fullPath) As Boolean</code>.<br><code>ExportWorkbookAsXlsx(Optional targetWb, Optional fullPath) As Boolean</code>.<br><code>ExportCustomXMLPart(rootElement, fullPath) As Boolean</code>.<br><code>CreateZipFromFiles(files As Collection, zipPath) As Boolean</code>.<br><code>ExportPackage(Optional filesToInclude As Collection, Optional zipPath) As Boolean</code>.<br><code>ExportAuditToCSV(fullPath) As Boolean</code>.<br><code>ExportSelfTest() As Boolean</code> / <code>Export_RunUnitTests() As Boolean</code>.<br><code>Export_MigrateLegacyConfig()</code> / <code>Export_PrepareForRelease()</code> (maintenance). </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Error model & codes</strong><br>Dedicated error base <code>EXPORT_ERR_BASE = 2100</code>. Mapped codes for common failures: <code>2100=NO_WORKBOOK</code>, <code>2101=DEST_NOT_WRITABLE</code>, <code>2102=SHEET_NOT_FOUND</code>, <code>2103=PDF_NO_FILE</code>, <code>2104=SHEET_NO_USED_RANGE</code>, <code>2110=SAVE_XLSX_FAIL</code>, <code>2200+ = CUSTOM XML</code>, <code>2302+ = ZIP</code>. Legacy <code>ExportToPDF</code> raises <code>vbObjectError + EXPORT_ERR_LEGACY_RAISE</code> to preserve earlier behavior; new functions return Boolean and log errors via <code>LocalHandleError</code>. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Security & allowlist model</strong><br>Primary hook: <code>Security_AllowExportPath_Check(fullPath)</code> tries <code>modSecurity.Security_AllowExportToPath</code> then falls back to config key <code>IFRS.Export.AllowRoots</code>. Additional verification via <code>Security_VerifyExportPathWritable</code>. Default: allow if no explicit roots configured (safe fallback). Always call these before writing. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Atomic IO philosophy & fallbacks</strong><br>Prefer external/centralized helpers (<code>AtomicWriteFile</code>, <code>AtomicSaveWorkbookAs</code>) via <code>SafeApplicationRun</code>. If unavailable use local fallbacks: write to temp file then <code>Name</code> (fast same-volume move) or <code>CopyFile</code> fallback. Write helpers: <code>TryAtomicWriteFileWithEncoding</code>, <code>TryAtomicWriteFileWithVerification</code>, <code>TryAtomicSaveWorkbookAsWithVerification</code>. Retries/backoff implemented for transient errors (configurable attempts). </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>ExportToPDF behavior</strong><br>Writes PDF to temp path (<code>ifrs_pdf_temp_...</code>) then atomically move to final location; retries up to 3 attempts with exponential backoff. Performs security allowlist and folder-writable checks before starting. Produces job events (enqueue/update) if job subsystem present. Legacy <code>ExportToPDF</code> raises on failure; <code>ExportToPDFEx</code> returns Boolean and logs via <code>SafeLogAuditWithMeta</code>. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Workbook (.xlsx) export</strong><br><code>ExportWorkbookAsXlsx</code> uses <code>TryAtomicSaveWorkbookAsWithVerification</code> — attempted via centralized helper then <code>SaveCopyAs</code>→copy fallback. Honors <code>IFRS.Export.OverwriteBehavior</code> (<code>overwrite | fail | version</code>). Verifies file exists and non-zero size before success. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>CSV export: streaming, RFC4180, UTF-8</strong><br>Primary writer: <code>TryExportRangeToCsvWithOptions</code> → centralized <code>ExportRangeToCsv</code> if available; fallback <code>WriteRangeToCsvFallbackWithEncoding</code>.<br>Features: streaming via <code>ADODB.Stream</code> when available, UTF-8 BOM optional (<code>IFRS.Export.UTF8BOM</code>, default True), buffered flush (<code>IFRS.Export.MaxRowsBuffered</code>, default 1000, capped 10000), RFC4180 quoting, CRLF line breaks, embedded-newline preservation, numeric decimal normalization to '.', periodic job progress updates and cancellation probes. Writes atomically via temp file move. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Custom XML export</strong><br><code>ExportCustomXMLPart(rootElement, fullPath)</code> reads via <code>TryReadCustomXMLPart</code> (central helper or fallback scanning <code>ThisWorkbook.CustomXMLParts</code>), applies conservative policy check <code>CheckCustomXmlPolicy</code> (calls <code>modSecurity_CheckCustomXmlExport</code> if present; default denies when "password" or "secret" present), inserts non-invasive header comment with correlation id, and writes atomically (UTF-8 preferred). </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>ZIP creation (cross-platform)</strong><br><code>CreateZipFromFiles</code> bootstraps an empty PKZIP file then adds files: macOS via <code>zip -j -q</code> (MacScript), Windows via <code>Shell.Application</code> folder <code>CopyHere</code> with <code>WaitForZipStable</code> heuristic. Validates existence and non-zero size. Errors: <code>ZIP_CREATE_FAIL</code>, <code>ZIP_EMPTY</code>, <code>ZIP_NO_FILES</code>. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Hashing / signatures</strong><br>Module does not create external signatures; it writes correlation ids into headers. If signing required, integrate a CI step to sign exported artifacts (release preflight hints provided). </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Audit integration & redaction</strong><br>All public exports call <code>SafeLogAuditWithMeta</code> on success/failure. <code>SafeLogAuditWithMeta</code> attempts centralized <code>LogAudit</code> then falls back to local temp audit log. It probes <code>modSecurity</code> and <code>audit_redact_pii</code> config to decide redaction; uses <code>PII_Detect</code> and <code>RedactSecrets</code> fallbacks for sensitive data. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Job integration</strong><br>Best-effort job hooks: <code>EnqueueExportJob</code> and <code>UpdateExportJobState</code> call <code>modRibbonCallbacks</code> or <code>modJobs</code>; fallback to logging and generating correlation id job tokens. Export APIs attempt to enqueue and update job state (queued → running → completed/failed). </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Config keys (documented)</strong><br><code>IFRS.Export.AllowRoots</code> — allowed path prefixes (Array).<br><code>IFRS.Export.UTF8BOM</code> — Boolean, default True.<br><code>IFRS.Export.MaxRowsBuffered</code> — Long, default 1000.<br><code>IFRS.Export.OverwriteBehavior</code> — <code>&quot;overwrite&quot; | &quot;fail&quot; | &quot;version&quot;</code>, default <code>&quot;overwrite&quot;</code>.<br><code>IFRS.Export.DefaultFolder</code> — String, optional default folder.<br><code>IFRS.Export.StreamingEnabled</code> — Boolean, default True.<br><code>audit_redact_pii</code>— Boolean, default False. Use<code>SafeConfigGet</code>and<code>InvalidateConfigCache</code>. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>PII detection & redaction hooks</strong><br><code>PII_Detect(s)</code> delegates to <code>modSecurity.PII_Detect</code> when available; fallback heuristics (email token, long-digit runs, keywords). <code>RedactSecrets(s)</code> delegates to <code>modSecurity.RedactSecrets</code> if present; fallback coarse redaction for emails, secret/password tokens, long digit runs. Use <code>SafeLogAuditWithMeta</code> to avoid leaking secrets. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Self-tests & CI usage</strong><br><code>ExportSelfTest()</code> performs deterministic small CSV, XLSX save, and ZIP creation in <code>_IFRS_TestResults</code> to verify runtime helpers. <code>Export_RunUnitTests()</code> wraps <code>ExportSelfTest</code> and lightweight checks (config retrieval, <code>GenerateCorrelationID</code>). <code>Export_PrepareForRelease()</code> runs utilities and security self-tests and <code>ExportSelfTest</code>. Use these in CI pre-release. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Migration helper</strong><br><code>Export_MigrateLegacyConfig()</code> maps legacy <code>Export.AllowRoots</code> → <code>IFRS.Export.AllowRoots</code> non-destructively if central <code>modConfig_Set</code> is available; logs migration events. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Diagnostics & logging</strong><br>All fallback events emit audit entries (e.g., <code>FlushFallback</code>, <code>RotateFallback</code>, <code>ExportAuditError</code>, <code>Zip warnings</code>). Temporary artifacts and intermediate attempts are removed where possible; <code>SafeLogAudit</code> writes local temp log when central audit not available. Use <code>SafeConfigGet</code> and meta logs for troubleshooting. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Failure handling & retries</strong><br>Transient IO and network errors use retries with exponential backoff for PDF, XLSX save, atomic writes, and zip operations. Fallback paths attempt safer per-row writes, SaveCopyAs, or CRC heuristics. Persistent failures call <code>LocalHandleError</code> which tries centralized <code>HandleError</code>, otherwise logs and raises a module-specific legacy error to maintain compatibility. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Platform-specific notes</strong><br>Windows: prefers <code>certutil</code>/shell <code>Shell.Application</code> zip; uses <code>Name</code> for fast file moves. macOS: <code>MacScript</code> to call <code>zip</code> in shell. ADODB.Stream used where available for UTF-8 and streaming. <code>IsMacOS()</code> relies on <code>Application.OperatingSystem</code>. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Best practices for integrators</strong><br>• Enable <code>modSecurity</code> hooks (PII detection/redaction, path verification) for safer deployment.<br>• Set <code>IFRS.Export.AllowRoots</code> to explicit repository/archive paths; avoid default-allow in sensitive environments.<br>• Run <code>Export_PrepareForRelease()</code> in CI and sign exported archives outside Excel.<br>• Run <code>ExportSelfTest</code> after installation/upgrade and after environment changes (network shares, AV rules).<br>• Disable <code>g_allowCommandExecution</code> equivalents in host security policy when external command invocation is unacceptable. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Troubleshooting checklist</strong><br>1. <code>PDF_NO_FILE</code> after ExportToPDF: check <code>TEMP</code>, file permission, <code>Name</code> move cross-volume failure; inspect temp file presence and audit warnings.<br>2. XLSX save failures: check <code>OverwriteBehavior</code>, network share locks, and run <code>Export_RunUnitTests</code> to get deterministic failures.<br>3. CSV encoding/characters wrong: verify <code>IFRS.Export.UTF8BOM</code> and ADODB availability; check decimal separator fallback.<br>4. ZIP empty or not stable: check <code>ExecShellZipOn*</code> availability, file path quoting, and <code>WaitForZipStable</code> timeouts.<br>5. Audit not recording: validate central <code>LogAudit</code> availability or inspect local <code>ifrs_local_audit.log</code>. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Limitations & security cautions</strong><br>• External command execution and macro-based atomic helpers are only used when present — enable only in trusted environments.<br>• Module does not perform cryptographic signing of artifacts; integrate signing in CI/release pipeline.<br>• Heuristic PII detection is not exhaustive — rely on centralized <code>modSecurity</code> where required.<br>• Cross-volume atomic moves rely on copy/delete fallback which is not instantaneous; handle race conditions in orchestration. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Examples & typical flows</strong><br>PDF export: validate path → enqueue job → export to <code>ifrs_pdf_temp_...</code> → atomic move (Name/CopyFile) → verify file exists → <code>SafeLogAuditWithMeta</code> → update job state.<br>CSV export (large sheet): determine streaming mode → stream rows in buffered chunks to temp → save temp → atomic move → progress updates via jobId → final audit entry. </td></tr><tr><td data-label="Technical User Guide — modExport"> <strong>Notes for maintainers</strong><br>• Centralized helpers are invoked via <code>SafeApplicationRun</code> to allow host-wide overrides; adding/patching <code>modUtilities</code>, <code>modConfig</code>, or <code>modSecurity</code> will improve robustness.<br>• Keep the public API signatures unchanged to preserve add-in compatibility.<br>• When adding features, follow existing pattern: prefer centralized helper → guarded call → local fallback → audit the fallback event. </td></tr></tbody></table></div><div class="row-count">Rows: 25</div></div><div class="table-caption" id="Table9" data-table="Docu_0158_09" style="margin-top:2mm;margin-left:3mm;"><strong>Table 9</strong></div>
<div class="table-wrapper" data-table-id="table-9"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modIAS36"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modIAS36</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modIAS36"> <strong>Overview</strong><br>Hardening of IAS 36 impairment framework implemented for Excel/VBA. Provides deterministic, defensive DCF/NPV primitives, recoverable-amount calculators (VIU / FVLCOD), allocation logic, normalization for diverse forecast shapes, deterministic row hashing for tamper-evidence, self-test and verification harnesses, and safe host-integration hooks (modUtilities/modConfig/modAudit). Preserves existing public signatures and adds non-breaking helper stubs. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Module identity & version</strong><br><code>MODULE_NAME = &quot;modIAS36&quot;</code>; <code>MODULE_VERSION = &quot;2025.12.26-Rev5&quot;</code> (Rev5 contains robustness patches: atomic-write stubs, 10× final verification loop, batch-write self-test persistence, improved forwarding guards, and deterministic snapshot/hash). </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Purpose & guarantees</strong><br>Provide deterministic, auditable impairment calculations with strong defensive error handling (no Err.Raise to UI), best-effort host integration, and tamper-evidence for self-tests. Functions return simple types or <code>Scripting.Dictionary</code> objects; side effects are limited to SafeLogEx (host or Debug.Print) and writing to the <code>_IFRS_TestResults</code> sheet when available. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Public API summary (preserved signatures)</strong><br><code>IAS36_ComputePVOfPayments(payments, discountRate, Optional asOfDate, Optional daycount) As Double</code><br><code>IAS36_CalculateRecoverableByVIU(cashflows, discountRate, Optional asOfDate, Optional daycount) As Double</code><br><code>IAS36_CalculateRecoverableByFVLCOD(fairValue, costsToSell) As Double</code><br><code>IAS36_RecoverableAmount(carryingAmount, Optional cashflows, Optional discountRate, Optional fairValue, Optional costsToSell, Optional asOfDate, Optional daycount) As Object</code><br><code>IAS36_GroupAssetsIntoCGUs(assets, Optional groupingKey) As Object</code><br><code>IAS36_GenerateDCF(forecast, discountRate, Optional asOfDate, Optional daycount) As Variant</code><br><code>IAS36_RunImpairmentTest(cgu, Optional discountRate, Optional fairValue, Optional costsToSell, Optional asOfDate, Optional daycount) As Object</code><br><code>IAS36_RunBatchImpairmentTests(cguList, Optional discountRate, Optional fairValueMap, Optional daycount) As Object</code><br><code>IAS36_GenerateDisclosureSummary(testResult) As Object</code><br><code>IAS36_ValidateInputPackage(pkg) As Object</code><br><code>IAS36_AllocateImpairment(assets, impairment, Optional mode, Optional weights) As Object</code><br><code>IAS36_ExportMetadataSnapshot(pkg) As String</code><br><code>IAS36_RestoreStatementSnapshot(jsonSnapshot) As Object</code><br><code>IAS36_RunSelfTests() Sub</code><br><code>IAS36_RunFinalVerification() As Object</code> (runs self-tests 10× and returns snapshot + <code>SnapshotHash</code>)<br><code>IAS36_RunExtendedSelfTests() As Object</code> / <code>IAS36_RunSanityChecks()</code> / <code>IAS36_RunStaticChecks()</code> / <code>IAS36_ListPublicAPIs()</code> and a few safe no-op hooks (e.g., <code>IAS36_DebouncedRibbonRefresh</code>, <code>IAS36_RegisterLegacyAlias</code>). </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Input shapes & contracts</strong><br>Forecast/payments accepted shapes (flexible): 2-col 1-based arrays <code>(1..n,1..2)</code> where col1=Date (or empty), col2=Amount; Collections of rows (array or dictionary), Dictionaries keyed by 1..n; single numeric interpreted as single payment at <code>asOfDate</code>. Public outputs are simple numeric or <code>Scripting.Dictionary</code> with documented keys (<code>RecoverableAmount</code>, <code>VIU</code>, <code>FVLCOD</code>, <code>ImpairmentLoss</code>, etc.). </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Canonical internal row/serialization behavior</strong><br><code>NormalizeForecastToArray</code> converts inputs to deterministic 1-based (n×2) array, compacts valid rows and bubble-sorts by date (non-dates pushed to end). <code>DictionaryToJson</code>/<code>ArrayToJson</code>/<code>CollectionToJson</code> provide deterministic non-exhaustive serialization used for snapshots. <code>ComputeDeterministicHash</code> is a fast, non-cryptographic 8-hex checksum (FNV-like) used for row/snapshot hashes — <strong>not</strong> a cryptographic signature. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Rounding & daycount</strong><br>Rounding uses <code>GetRoundingPrecision()</code> (cached, tries <code>modConfig.GetSetting(&quot;RoundingPrecision&quot;)</code>) with default <code>2</code>; <code>ApplySafeRound</code> uses VBA <code>Round</code> (banker’s rounding). Daycount default <code>ACT/365</code>; override via <code>GetDayCountConvention()</code> (probes host config <code>IAS36_DefaultDaycount</code>). <code>YearFractionEx</code> implements <code>ACT/365</code>, <code>ACT/360</code>, and <code>30/360</code>. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Hashing & tamper-evidence</strong><br>Module emits deterministic <code>RowHash</code> for self-tests and a JSON <code>Snapshot</code> + <code>SnapshotHash</code> from <code>ComputeDeterministicHash</code>. Use these as tamper-evidence alongside external signing if required. Do <strong>not</strong> treat <code>SnapshotHash</code> as a cryptographic signature. For cryptographic integrity, sign <code>Snapshot</code> externally (CI) and record signature in release manifest. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Logging & error routing</strong><br>All internal logging funnels through <code>SafeLogEx</code> which tries host <code>LogAudit</code> via <code>TryApplicationRun</code> and falls back to <code>Debug.Print</code>. Errors are handled by <code>SafeHandleError</code> / <code>HandleInternalError</code> which attempt host <code>HandleError</code> or <code>modError.HandleError</code> before fallback. Module avoids bubbling runtime errors to the UI. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Host integration & delegation</strong><br><code>TryApplicationRun</code> robustly forwards calls to host macros with ParamArray forwarding and safe defaults. <code>ProbeExternalDependencies</code> sets flags (<code>g_haveModUtilities</code>, <code>g_haveModConfig</code>, <code>g_haveModAudit</code>, <code>g_haveModError</code>, <code>g_haveModSecurity</code>). Use <code>PreferExternalOrLocal</code> and <code>TryUseExternalHelper</code> to prefer host helpers when available. When <code>modUtilities</code> exists, module will attempt to reuse <code>AtomicWriteFile</code>, <code>AtomicSaveWorkbookAs</code>, <code>SafeCreateSheet</code>, etc. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Atomic write & persistence</strong><br><code>TryAtomicWriteFile(filepath, content, overwrite)</code> attempts <code>modUtilities.AtomicWriteFile</code> if present; otherwise writes to a temp file and moves it into place. <code>TryAtomicSaveWorkbookAs</code> prefers <code>modUtilities.AtomicSaveWorkbookAs</code> then falls back to <code>ThisWorkbook.SaveCopyAs</code>. Used by <code>PersistSelfTestResults</code> to write JSON snapshots. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Buffered/batch writes & performance</strong><br>Self-test results and many outputs are written in batch arrays to worksheets (single <code>Range.Value = outArr</code>) to avoid per-row writes. <code>PersistSelfTestResults</code> writes results to <code>_IFRS_TestResults</code> and computes deterministic <code>RowHash</code> per row. Extended self-tests include a performance guard test with 500 rows. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Self-test & final verification</strong><br><code>IAS36_RunSelfTests()</code> performs 10 deterministic checks and persists results to <code>_IFRS_TestResults</code> (with row hashes and JSON snapshot). <code>IAS36_RunFinalVerification()</code> runs the harness ten times, aggregates <code>PassCount</code>/<code>FailCount</code>, builds a <code>Snapshot</code> and <code>SnapshotHash</code> for tamper-evident sign-off; returns dictionary <code>{Status, TestCount, PassCount, FailCount, Timestamp, Snapshot, SnapshotHash}</code>. Use this function in CI or release sign-off. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Allocation algorithm</strong><br><code>AllocateImpairment(assets, impairment, mode, weights)</code> supports <code>PRORATA</code> (default), <code>EQUAL</code>, and <code>WEIGHTED</code>. Deterministic tie-breaking: when cmp values equal, the algorithm favors lexicographically smaller asset IDs. Rounding applied per item; residual adjustment applied to largest (deterministic) or smallest if further correction needed. <code>VerifyAllocationInvariant</code> logs if rounding drift occurs. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Normalization & robustness</strong><br><code>NormalizeForecastToArray</code> and <code>NormalizePaymentsForRead</code> accept diverse input shapes, compact invalid rows, push non-dates to end, and return empty on no valid rows. <code>YearFractionEx</code> clamps negative durations to zero. <code>NPVFromDcfEx</code> handles zero/negative discount gracefully. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Security & operational guidance</strong><br>• Treat <code>_IFRS_TestResults</code> and snapshots as sensitive audit artifacts; restrict workbook access and consider storing signed snapshots externally.<br>• Disable <code>TryUseExternalHelper</code> and <code>g_haveModUtilities</code>-dependent calls in untrusted host environments. Review and approve any <code>modUtilities</code> helper names before enabling. <br>• <code>ComputeDeterministicHash</code> is not cryptographically secure — integrate CI signing for legal attestation. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Dependencies & safe defaults</strong><br>Probes: <code>modUtilities</code>, <code>modConfig</code>, <code>modAudit</code>, <code>modError</code>, <code>modSecurity</code>. All external calls are optional and guarded by <code>TryApplicationRun</code> / <code>PreferExternalOrLocal</code>. If not present, module uses local fallbacks. Default rounding = 2, daycount = <code>ACT/365</code>. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Sheet usage & naming</strong><br>Self-test sheet: <code>_IFRS_TestResults</code> (created or reused, set <code>xlSheetVeryHidden</code> when possible). When writing snapshots, module writes <code>&lt;workbook path&gt;@@ESC_UND@@IFRS_TestResults_snapshot.json</code> via <code>TryAtomicWriteFile</code> if workbook path exists. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Limitations & known behaviors</strong><br>• <code>ComputeDeterministicHash</code> is non-cryptographic (8-hex).<br>• Snapshot/sign-off must be externally signed for legal authenticity.<br>• <code>TryAtomicWriteFile</code> fallback uses <code>Scripting.FileSystemObject</code> and may fail on restricted file systems; callers should check return Boolean.<br>• Host macro signatures vary; <code>TryApplicationRun</code> forwards up to eight ParamArray args — long-arg calls may be truncated. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Troubleshooting checklist</strong><br>1. Self-test failures → open <code>_IFRS_TestResults</code>, compare <code>RowHash</code> and persisted JSON snapshot; run <code>IAS36_RunFinalVerification</code> to collect <code>SnapshotHash</code> and <code>Pass/Fail</code> counts.<br>2. Missing <code>_IFRS_TestResults</code> → check <code>SafeCreateSheet</code> host helper availability and workbook protection; view <code>Debug.Print</code> for fallbacks.<br>3. <code>TryAtomicWriteFile</code> returned False → check folder ACLs, TEMP path, and <code>modUtilities</code> availability; check <code>Debug.Print</code>/<code>SafeLogEx</code> entries.<br>4. Unexpected hash in snapshot → remember hash is deterministic non-crypto; verify source JSON and re-run sign-off in CI. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Recommended operational practices</strong><br>• Call <code>Module_Initialize</code> implicitly via first public call; call <code>IAS36_RunFinalVerification</code> in CI pipelines as part of release gating.<br>• Keep <code>g_haveModUtilities</code> set only after code review of <code>modUtilities</code> helpers.<br>• Regularly export <code>_IFRS_TestResults_snapshot.json</code> and sign it in CI; store signed artifacts in immutable storage for retention. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Example usage patterns</strong><br>Compute PV: <code>pv = IAS36_ComputePVOfPayments(paymentsArray, 0.05, Date)</code>.<br>Single CGU test: <code>res = IAS36_RunImpairmentTest(cguDict, 0.05, fairValue, costsToSell, Date)</code> then <code>summary = IAS36_GenerateDisclosureSummary(res)</code>.<br>Batch run + sign-off: <code>batch = IAS36_RunBatchImpairmentTests(list, 0.05, fairValueMap)</code> → <code>final = IAS36_RunFinalVerification()</code> → persist <code>final(&quot;Snapshot&quot;)</code> and record <code>final(&quot;SnapshotHash&quot;)</code>. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Extensibility & deduplication guidance</strong><br>Module is intentionally conservative: when <code>modUtilities</code> provides overlapping helpers prefer calling them via <code>TryApplicationRun</code> and remove local duplicates only after coordinated regression testing. Use <code>PreferExternalOrLocal</code> to evolve integration incrementally. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>File & naming conventions</strong><br>Test results sheet <code>_IFRS_TestResults</code>; JSON snapshot <code>&lt;WorkbookPath&gt;@@ESC_UND@@IFRS_TestResults_snapshot.json</code>; temp fallback files use deterministic <code>ComputeDeterministicHash(Format(Now,...))</code> naming to reduce collisions. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Contact points for integration</strong><br>Hooks to review/extend: <code>TryApplicationRun</code>, <code>TryAtomicWriteFile</code>, <code>TryAtomicSaveWorkbookAs</code>, <code>TryUseExternalHelper</code>, <code>ProbeExternalDependencies</code>. Audit/log events are emitted via <code>SafeLogEx</code> with correlation IDs from <code>GenerateCorrelationID()</code>. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Acceptance criteria (for upgrades / code review)</strong><br>1. Public signatures unchanged for preserved functions.<br>2. Self-tests (<code>IAS36_RunSelfTests</code>) pass locally; <code>IAS36_RunFinalVerification</code> returns <code>PassCount = 10</code> in ideal host environment.<br>3. <code>_IFRS_TestResults</code> created and contains <code>RowHash</code> values; snapshot JSON present and <code>TryAtomicWriteFile</code> succeeded or logged fallback. </td></tr><tr><td data-label="Technical User Guide — modIAS36"> <strong>Appendix — quick reference of notable internals</strong><br><code>NormalizeForecastToArray</code>, <code>NormalizePaymentsForRead</code>, <code>YearFractionEx</code>, <code>NPVFromDcfEx</code>, <code>AllocateImpairment</code>, <code>ApplySafeRound</code>/<code>Round2</code>, <code>ComputeDeterministicHash</code>, <code>TryAtomicWriteFile</code>, <code>TryAtomicSaveWorkbookAs</code>, <code>PersistSelfTestResults</code>, <code>IAS36_RunFinalVerification</code>. </td></tr></tbody></table></div><div class="row-count">Rows: 27</div></div><div class="table-caption" id="Table10" data-table="Docu_0158_10" style="margin-top:2mm;margin-left:3mm;"><strong>Table 10</strong></div>
<div class="table-wrapper" data-table-id="table-10"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modIFRS15"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modIFRS15</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Overview</strong><br>IFRS 15 contract model implemented in VBA: deterministic allocation of transaction price to performance obligations, recognition schedule generation, deterministic rounding/residual rules, PV computation for payments, variable-consideration handling, batch processing hooks, reconciliation helpers, local test harness, and integrated logging/audit forwarding. Designed for defensiveness and backward compatibility (preserved public signatures). </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Public API (preserved signatures & short purpose)</strong><br><code>IFRS15_AnalyzeContract(contract) As Object</code> — build analysis (POs, totals, placeholders).<br><code>IFRS15_AllocateTransactionPrice(analysis, Optional applyVariableConsideration As Boolean=True, Optional variableConstraintThreshold As Double=0.25) As Object</code> — deterministic allocation, reserve for variable consideration.<br><code>IFRS15_GenerateRecognitionSchedule(analysis, Optional periods As Long=12, Optional startDate As Variant=Null) As Variant</code> — produce recognition schedule (2D array).<br><code>IFRS15_GenerateJournalEntries(recognitionSchedule, revenueAccount, contraAccount) As Variant</code> — convert schedule to journal lines.<br><code>IFRS15_GenerateDisclosures(analysis) As Object</code> — disclosures structure (unsatisfied POs, totals, judgments).<br><code>IFRS15_ValidateContract(contract) As Object</code> — returns issues dictionary.<br><code>IFRS15_BatchProcessContracts(contracts) As Object</code> — deterministic batch processing → schedules map.<br><code>ComputePVofPayments(payments, discountRate, baseDate, Optional dayCountConvention=&quot;&quot;, Optional applyRounding=True) As Double</code> — PV using cached day-count default.<br><code>GenerateCorrelationID()</code>, <code>ExtractCorrelationFromVariant(v)</code>, <code>GetDayCountConvention()</code>, <code>IsLegacyMode()</code>, <code>InvalidateIFRS15ConfigCache()</code> — helpers and config accessors. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Canonical row/structures used by module</strong><br>Analysis object (Scripting.Dictionary) keys: <code>PerformanceObligations</code> (Collection of dicts), <code>TotalStandalone</code>, <code>TransactionPrice</code>, <code>ContractID</code>, <code>ContractDate</code> (optional), <code>Allocation</code> (Dictionary), <code>ReserveForVariable</code>, <code>AllocatedTotal</code>, <code>JudgmentsApplied</code> (Collection).<br>Recognition schedule output: 2D array rows with columns <code>(ContractID, POID, PeriodIndex, Date, Amount, RecognitionMethod)</code>.<br>Journal rows: <code>(Date, DebitAcct, DebitAmt, CreditAcct, CreditAmt, Memo)</code>. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Determinism & rounding rules</strong><br>• Deterministic allocation: shares computed by standalone price proportion; if <code>TotalStandalone</code> <= 0 then equal share.<br>• Rounding via <code>ApplySafeRound</code> and centralized <code>MonetaryBoundaryRound</code> which uses <code>GetRoundingPrecision()</code> (cached).<br>• Residuals handled deterministically: absorb into performance obligation with largest <code>StandalonePrice</code> (ties → lowest index).<br>• Final equality enforced: <code>Rounded(AllocatedTotal) + Rounded(Reserve) == Rounded(TransactionPrice)</code>; deterministic correction applied to allocation or reserve. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Variable consideration handling</strong><br>• <code>IFRS15_AllocateTransactionPrice</code> supports scalar expected values, structured <code>vco</code> objects with <code>Method</code> (e.g., <code>mostlikely</code>) or <code>Scenarios</code> (Probability/Amount), or arrays of scenarios; deterministic expected value calculation and recording via <code>AddJudgment</code>.<br>• Threshold controlled by <code>variableConstraintThreshold</code> param or config key <code>variableConstraintThreshold</code> (config override via <code>GetConfigDouble</code>).<br>• Reserves recorded in <code>ReserveForVariable</code> and rounded per module rounding rules. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Recognition schedule behavior</strong><br>• <code>time</code> method: amount split evenly across <code>periods</code>; per-period rounding applied; residual placed deterministically in final period.<br>• <code>point</code> method: uses <code>DeliveryDate</code> if present and valid; otherwise falls back to <code>startDate</code> and emits a judgment entry.<br>• Guardrails: <code>periods</code> clamped to <code>[1,10000]</code> and associated judgments emitted for clamping. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>PV & payments handling</strong><br>• <code>ComputePVofPayments</code> normalizes payments via <code>NormalizePaymentsForRead</code> (module expects normalized shape), uses <code>GetDayCountConvention()</code> cached value if <code>dayCountConvention</code> omitted.<br>• Supports discount method config <code>IFRS15_DiscountMethod</code> (<code>CONTINUOUS</code> or periodic default).<br>• Year-fraction calculation supported by <code>YearFraction</code> (<code>ACT/365</code>, <code>ACT/360</code>, <code>30/360(NASD)</code>); small negative fractions normalized to zero. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Configuration & cache</strong><br>Cached config structure <code>mCfg</code> holds <code>roundingPrecision</code>, <code>variableConstraintThreshold</code>, <code>versionKey</code>, <code>dayCountConvention</code>, <code>legacyMode</code>.<br>Initialization via <code>InitializeConfigCache</code> reads config through <code>TryApplicationRun</code> wrappers (<code>modConfig_Get</code>, <code>Config_Get</code>, <code>GetConfigValue</code>).<br>Invalidate with <code>InvalidateIFRS15ConfigCache()</code>; migration helper <code>EnsureModuleVersionRegistered()</code> attempts to set <code>IFRS15_ModuleVersion</code>. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Feature flags / config keys</strong><br>Notable keys: <code>roundingPrecision</code>, <code>variableConstraintThreshold</code>, <code>IFRS15_ModuleVersion</code>, <code>IFRS15_DayCountConvention</code>, <code>IFRS15_LegacyMode</code>, <code>IFRS15_RevenueAccount</code>, <code>IFRS15_ContraAccount</code>, <code>IFRS15_DiscountMethod</code>.<br><code>IsLegacyMode()</code> accessor reads cached <code>legacyMode</code>. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Integration & external hooks (safe-by-default)</strong><br>• Logging/error forwarding uses <code>SafeLogEx</code> and <code>SafeHandleError</code> which prefer <code>modAudit.LogEvent</code> and <code>modError.HandleError</code> but fall back to local <code>AppendLocalAudit</code> and <code>AppendLocalIssueAudit</code> if not present.<br>• <code>TryApplicationRun</code> and <code>SafeApplicationRun</code> provide guarded <code>Application.Run</code> invocation (supports up to 10 args).<br>• <code>IsProcedureAvailable</code> uses a non-invasive whitelist and avoids running unknown procedures. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Sheets, job hooks & test harness</strong><br>• <code>_IFRS_Audit</code> (very-hidden) via <code>EnsureAuditSheetExists</code> for local lightweight audit rows.<br>• <code>_IFRS_TestResults</code> for test harness via <code>EnsureTestSheetExists</code> and <code>AppendTestResults</code>.<br>• <code>_IFRS_Jobs</code> to register background jobs via <code>EnqueueOrUpdateJob</code> (returns JobID) — scheduling left as a hook for ribbon/bootstrapping modules. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Sorting & collections</strong><br>• <code>BuildMaturityAnalysis</code> aggregates buckets by Year/Month and sorts keys using <code>QuickSortVariant</code> (deterministic quicksort replacement for prior O(N^2) sort).<br>• Defensive array helpers: <code>LBoundArraySafe</code>, <code>UBoundArraySafe</code>, <code>CountArrayElements</code>, <code>SafeArrayIndex</code>, <code>ArrayDimensions</code>. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Testing & diagnostics</strong><br>• Module contains self-test harness that writes to <code>_IFRS_TestResults</code> and emits <code>SelfTestCompleted</code> audit/log entry (see changelog).<br>• <code>AppendTestResults</code> stores timestamped summary and notes. Use these artifacts for CI/QA validation. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Error handling & fallbacks</strong><br>• Code is defensive: <code>On Error Resume Next</code> used broadly with <code>SafeHandleError</code> to attempt centralized handling (<code>modError.HandleError</code>) before falling back to local audit.<br>• Safe file writing uses <code>SafeExportCsv</code> (prefers <code>modUtilities.AtomicWriteCsv</code>); falls back to simple write and logs failures. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Security & operational guidance</strong><br>• Restrict use of <code>Application.Run</code> hooks and review any <code>HashProviderMacroName</code> or external macros; <code>IsProcedureAvailable</code> avoids side-effects by design.<br>• Prefer disabling or code-reviewing any external-proc hooks in untrusted deployments.<br>• Protect hidden sheets (<code>xlSheetVeryHidden</code>) and archived CSV output locations; follow least privilege rules for filesystem writes. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Migration & versioning</strong><br>• Module writes/reads <code>IFRS15_ModuleVersion</code> config key; <code>EnsureModuleVersionRegistered</code> will attempt to set it via available config-set hooks. Document module version in release notes and run <code>InvalidateIFRS15ConfigCache</code> after upgrade to refresh behavior. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Runbook / monitoring recommendations</strong><br>• Run self-test on install/upgrade and assert <code>SelfTestCompleted</code> audit entry present.<br>• Validate <code>Verify</code> steps: run recognition schedule sample contracts in CI and compare deterministic outputs (store known-good fixtures).<br>• Monitor <code>_IFRS_Audit</code> and <code>_IFRS_TestResults</code> for unexpected errors or missing self-test completion. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Troubleshooting checklist</strong><br>1. Unexpected allocation totals: check <code>roundingPrecision</code> config and <code>ReserveForVariable</code>; run self-test and compare <code>AllocatedTotal</code> vs <code>TransactionPrice</code>.<br>2. Missing external behavior (modConfig/modUtilities): verify <code>IsProcedureAvailable</code> calls and ensure expected helper modules are installed; module will fall back to safe defaults but emit judgments/audit entries.<br>3. PV mismatches: confirm <code>IFRS15_DayCountConvention</code>, <code>IFRS15_DiscountMethod</code>, and <code>ComputePVofPayments</code> base date.<br>4. Job not running: <code>_IFRS_Jobs</code> is only a registration hook — external scheduler (modBootstrap or Excel <code>OnTime</code>) required to invoke job procs. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Examples / usage patterns</strong><br>Batch process flow (recommended): <code>Init</code> context → <code>IFRS15_BatchProcessContracts(contracts)</code> → for each contract store schedule and call <code>IFRS15_GenerateJournalEntries</code> → persist or export via <code>SafeExportCsv</code> → run <code>Verify</code> tests and flush test results.<br>Typical single contract flow: call <code>IFRS15_AnalyzeContract</code> → <code>IFRS15_AllocateTransactionPrice</code> → <code>IFRS15_GenerateRecognitionSchedule</code> → optionally <code>IFRS15_GenerateJournalEntries</code> and <code>IFRS15_GenerateDisclosures</code>. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Limitations & notes</strong><br>• No built-in cryptographic signature of outputs (integrate with modAudit/CI signing if required).<br>• Deterministic tie-breakers rely on <code>StandalonePrice</code> ordering — if that field is not meaningful, define stable PO identifiers to control deterministic outcomes.<br>• Module uses VBA date/time and system <code>Now</code> for timestamps in judgments/test results — consider UTC normalization in integrated systems. </td></tr><tr><td data-label="Technical User Guide — modIFRS15"> <strong>Maintenance tasks for integrators</strong><br>• Review and approve all external <code>Application.Run</code> hook names used by your environment.<br>• Set config keys (<code>IFRS15_DayCountConvention</code>, <code>roundingPrecision</code>, <code>IFRS15_RevenueAccount</code>, <code>IFRS15_ContraAccount</code>, <code>IFRS15_DiscountMethod</code>) via your config provider.<br>• Include module self-test in CI and require <code>SelfTestCompleted</code> audit emission as part of release gating. </td></tr></tbody></table></div><div class="row-count">Rows: 21</div></div><div class="table-caption" id="Table11" data-table="Docu_0158_11" style="margin-top:2mm;margin-left:3mm;"><strong>Table 11</strong></div>
<div class="table-wrapper" data-table-id="table-11"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modIFRS16"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modIFRS16</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Overview</strong><br>IFRS16 lease measurement library for Excel/VBA. Provides deterministic initial measurement, schedule generation, re-calculation on modification, journal entry generation, disclosure helpers, batch processing and a self-test suite. Hardening applied (module version <code>1.13.0</code>, <code>Checked10x</code> tag). Preserves existing public function signatures. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Module identity</strong><br><code>MODULE_VERSION = &quot;1.13.0&quot;</code>; <code>MODULE_CHECKED10X_TAG = &quot;Checked10x&quot;</code>. Consumers should include <code>ModuleVersion</code> and <code>CorrelationId</code> in outputs for traceability. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Public API (preserved signatures)</strong><br><code>IFRS16_InitialMeasurement(payments, discountRate, commencementDate, Optional initialDirectCosts, leaseIncentives, restorationCosts, asOfDate)</code> → Dictionary with <code>LeaseLiability</code>, <code>ROUAsset</code>, inputs and metadata.<br><code>IFRS16_GenerateSchedule(payments, initialLiability, discountRate, leaseTermPeriods, Optional periodDates, rouOpening, rouUsefulPeriods)</code> → 2D array (period rows + header).<br><code>IFRS16_RecalculateLiabilityOnModification(payments, oldLiability, newDiscountRate, asOfDate)</code> → Dictionary with <code>OldLiability</code>, <code>NewLiability</code>, <code>Delta</code>.<br><code>IFRS16_GenerateJournalEntries(schedule, liabilityAccount, rouAccount, interestAccount, depreciationAccount)</code> → 2D array of journal lines.<br><code>IFRS16_GenerateDisclosure(schedule)</code> → Dictionary with totals and <code>MaturityAnalysis</code>.<br><code>IFRS16_ValidateLeaseInput(payments, commencementDate, discountRate)</code> → Dictionary of validation issues.<br><code>IFRS16_BatchComputeLeases(leases)</code> → Dictionary keyed per-lease of InitialMeasurement results.<br><code>IFRS16SelfTest()</code> → Boolean; writes <code>_IFRS_TestResults</code> sheet and appends local audit entry. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Supported payment input shapes</strong><br>Robust normalizer supports: 2-D arrays (rows × columns), 1-D arrays of inner arrays, VBA <code>Collection</code>, <code>Scripting.Dictionary</code> with <code>Items</code>/<code>Payments</code> key, and arrays of simple numeric values. Returns normalized 2-column array <code>[(Date/Empty),(Amount)]</code>. Unsupported shapes return <code>Empty</code> (legacy behaviour) and populate <code>m_lastNormalizeReport</code>. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Normalizer modes and shims</strong><br>Config key <code>IFRS16.NormalizerMode</code> (<code>&quot;legacy&quot;</code> or <code>&quot;improved&quot;</code>). Default <code>&quot;improved&quot;</code>. If available, external shim <code>modUtilities.NormalizePaymentsForRead</code> is preferred. If shim missing or legacy mode forced, internal normalizer runs and records diagnostics in <code>m_lastNormalizeReport</code> (accessible via private <code>GetLastNormalizeReport</code>). </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Normalization diagnostics</strong><br><code>m_lastNormalizeReport</code> (private) populated with <code>Error</code>, <code>Detail</code>, <code>CorrelationId</code>, <code>Timestamp</code> when normalization fails or input ambiguous. Normalizer returns diagnostics when <code>returnDiagnostics=True</code> (internal usage only). </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Payment indexing helpers</strong><br><code>GetPaymentCountFromNormalized</code>, <code>GetPaymentAmountFromNormalized</code>, <code>GetPaymentDateFromNormalized</code> attempt to call <code>modUtilities</code> equivalents first; fallback uses safe bounds checks with <code>SafeArrayIndex</code>. Out-of-range accesses return zero/empty and emit <code>AppendLocalAudit</code> diagnostics. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Correlation handling</strong><br><code>ExtractCorrelationFromVariant</code> scans input containers (objects, arrays, first elements up to 5 items) for a <code>CorrelationId</code> key to propagate correlation across API calls and logs. If none found the module generates <code>GenerateCorrelationID()</code> values. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Financial models & rules</strong><br>• Present value (<code>ComputePVofPayments</code>) discounts using fractional years from <code>asOfDate</code> to payment date.<br>• If <code>discountRate &lt;= 0</code> PV = sum(payments).<br>• <code>IFRS16_GenerateSchedule</code> supports both legacy interest accrual (reference to first payment date) and corrected period-to-period accrual. Controlled by config flag <code>IFRS16.LegacyInterestMode</code> (boolean).<br>• Principal floored at 0 (negative principal protection).<br>• Depreciation: time-proportional across <code>rouUsefulPeriods</code> (supports partial periods).<br>• ROU depreciation allocation uses simple per-period fraction (legacy deterministic approach). </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Day count conventions</strong><br>Config key <code>IFRS.DayCount</code> cached; defaults <code>ACT/365</code>. Supported: <code>ACT/365</code> (default), <code>ACT/360</code>, <code>30/360</code> implemented as US/NASD (cap day 31 → 30). <code>YearFraction(d0,d1)</code> returns normalized non-negative fractional years. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Rounding & precision</strong><br><code>GetRoundingPrecision</code> reads <code>IFRS.RoundingPrecision</code> (cached); default <code>2</code>. <code>ApplySafeRound</code> prefers <code>modUtilities.Round</code> shim; falls back to <code>VBA.Round</code>. Very small residuals near rounding precision are set to zero for stability. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Batch limits & safety</strong><br><code>MAX_BATCH_SIZE = 10000</code>. <code>IFRS16_BatchComputeLeases</code> enforces this limit and returns an empty results set and audit log on oversize requests to avoid resource exhaustion. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Self-test suite</strong><br><code>IFRS16SelfTest</code> runs multiple fixtures (2D arrays, 1D irregular arrays, Collections, Dictionaries, leap-year, zero discount, negative principal protection, period-to-period interest checks). Results appended to <code>_IFRS_TestResults</code> sheet (very hidden) and attempts to report to <code>modTests</code> shims. Emits an <code>AppendLocalAudit</code> marker including <code>MODULE_CHECKED10X_TAG</code>. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Sheets used</strong><br><code>_IFRS_TestResults</code> — very hidden sheet with columns <code>Timestamp, CorrelationId, TestKey, Result</code> where self-test results are appended.<br><code>_IFRS_Audit</code> — module may append minimal audit rows via <code>AppendLocalAudit</code> when external modAudit unavailable; columns <code>Timestamp, User, Message</code>. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Logging / error handling strategy</strong><br>Prefer external shims: <code>modAudit.LogEvent</code> (via <code>SafeLogEx</code>) and <code>modError.HandleError</code> (via <code>SafeHandleError</code>). When shims missing module emits local hidden-sheet audit via <code>AppendLocalAudit</code>. All public functions wrap code in <code>On Error</code> handlers and call <code>SafeHandleError</code> on unhandled exceptions. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>TryApplicationRun shim</strong><br><code>TryApplicationRun(procName, outVal, ParamArray args())</code> attempts <code>Application.Run</code> up to 12 args, truncates extras, and returns Boolean success. Used throughout to call optional utilities (<code>modUtilities</code>, <code>modConfig</code>, <code>modAudit</code>, <code>modError</code>). If the external function fails the module falls back to internal implementation and emits <code>AppendLocalAudit</code>. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Safe array helpers</strong><br><code>SafeArrayIndex</code> validates <code>LBound</code>/<code>UBound</code> before indexing (supports 1D/2D). Calls <code>modUtilities.SafeArrayIndex</code> if available. Out-of-range attempts produce <code>AppendLocalAudit</code> entries rather than hard errors. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Diagnostics & verification</strong><br><code>m_lastNormalizeReport</code> (private) contains last normalization failure—useful for debugging. Self-test writes persistent results. Consumers should call <code>IFRS16SelfTest</code> as part of deployment validation. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Persistence & visibility</strong><br>All diagnostic/audit writes target very-hidden sheets to avoid accidental tampering; callers should secure workbook and backups. <code>_IFRS_TestResults</code> is appended (not overwritten) to provide audit trail for self-tests. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Inter-module dependencies</strong><br>Optional integrations (soft dependencies, used when present): <code>modUtilities</code> (normalizer, rounding, safe array helpers), <code>modConfig</code> (runtime flags/keys: <code>IFRS.RoundingPrecision</code>, <code>IFRS.DayCount</code>, <code>IFRS16.LegacyInterestMode</code>, <code>IFRS16.NormalizerMode</code>), <code>modAudit</code> (structured auditing), <code>modError</code> (centralized error handling), <code>modTests</code> (self-test reporting). All optional calls are guarded with <code>TryApplicationRun</code>. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Behavioral fallbacks</strong><br>If external shims are absent module falls back to internal implementations, records audit entries, and preserves legacy public API behavior (returning <code>Empty</code> for unsupported payment shapes). Where internal result may be less feature-rich a diagnostic report is created (<code>MakeNormalizeErrorReport</code>). </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Edge cases & defensive rules</strong><br>• Zero or negative discount rate handled explicitly.<br>• Missing payment dates treated as Empty and yield 0 year fractions.<br>• Index out-of-range returns 0/Empty and emits audit line rather than raising.<br>• Very small rounding residuals are zeroed to avoid negative zero/rounding drift. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Security & operational guidance</strong><br>• Review and approve any optional external shims (<code>modUtilities</code>, <code>modConfig</code>, <code>modAudit</code>, <code>modError</code>) before enabling in production.<br>• Protect workbook and very-hidden sheets; consider workbook encryption and file system ACLs for archives/backups.<br>• Run <code>IFRS16SelfTest</code> after deployment and after upgrade to <code>MODULE_VERSION</code> to record <code>Checked10x</code> marker. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Examples (input → normalized output)</strong><br>Example 2D array input: <code>payments(1 To 3,1 To 2)</code> with <code>[Date, Amount]</code> → normalized <code>out(1 To 3,1 To 2)</code> where <code>out(i,1)=CDate(date)</code> or <code>Empty</code>, <code>out(i,2)=Double(amt)</code>.<br>Example 1D array of arrays: <code>arr(0)= [2026-06-15,800]</code> → normalized similarly. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Journal output format</strong><br><code>IFRS16_GenerateJournalEntries</code> returns 2D array with columns: <code>Date, CreditAccount, CreditAmount, DebitAccount, DebitAmount, Narrative</code>. Debit/Credit side ordering follows legacy mapping used by hosts (caller responsible for mapping to ledger import format). </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Limitations & known gaps</strong><br>• No built-in cryptographic signing of outputs — consumers should sign/export in CI if required.<br>• ROU depreciation is time-proportional simple allocation (no remeasurement logic for changes to useful life or impairment).<br>• Public API signatures preserved — no new public accessors for internal diagnostics to avoid API breakage; <code>GetLastNormalizeReport</code> remains private. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Recommended operational checks</strong><br>1. Run <code>IFRS16SelfTest()</code> during install/upgrade and archive <code>_IFRS_TestResults</code> periodically.<br>2. Schedule <code>VerifyAuditChain</code> (if using <code>modAudit</code>) in CI to detect tampering early.<br>3. Validate <code>modConfig</code> keys (<code>IFRS.RoundingPrecision</code>, <code>IFRS.DayCount</code>, <code>IFRS16.LegacyInterestMode</code>, <code>IFRS16.NormalizerMode</code>) when deploying across environments.<br>4. Confirm <code>modUtilities</code> presence if you rely on improved normalizer/rounding; otherwise expect internal fallbacks. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Troubleshooting quick guide</strong><br>• Unexpected <code>Empty</code> from <code>IFRS16_InitialMeasurement</code> → inspect <code>m_lastNormalizeReport</code> (internal) and ensure payments shape supported or <code>modUtilities.NormalizePaymentsForRead</code> available.<br>• Wrong interest amounts → verify <code>IFRS16.LegacyInterestMode</code> flag and <code>IFRS.DayCount</code> (ACT/365 default).<br>• Rounding differences → confirm <code>IFRS.RoundingPrecision</code> and whether <code>modUtilities.Round</code> shim is present.<br>• Self-test failures → open <code>_IFRS_TestResults</code> sheet for per-fixture results and run <code>IFRS16SelfTest</code> manually. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Backward compatibility & upgrade notes</strong><br>Public signatures unchanged; module adds hardened internal behavior and diagnostics. Consumers upgrading should: run <code>IFRS16SelfTest</code>, archive <code>_IFRS_TestResults</code>, and verify <code>modUtilities</code>/<code>modConfig</code> shims behave as expected. </td></tr><tr><td data-label="Technical User Guide — modIFRS16"> <strong>Developer notes</strong><br>• <code>NormalizePaymentsForRead</code> aims to preserve legacy <code>Empty</code> return on unsupported shapes to avoid breaking callers.<br>• Internal diagnostics use <code>MakeNormalizeErrorReport</code> factory for structured reporting.<br>• All optional external calls are non-fatal and audited via <code>AppendLocalAudit</code> when missing. </td></tr></tbody></table></div><div class="row-count">Rows: 30</div></div><div class="table-caption" id="Table12" data-table="Docu_0158_12" style="margin-top:2mm;margin-left:3mm;"><strong>Table 12</strong></div>
<div class="table-wrapper" data-table-id="table-12"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modAudit + modRibbonCallbacks"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modAudit + modRibbonCallbacks</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Scope & Purpose</strong><br>Combined guidance for two integrated VBA modules: <code>modAudit</code> (append-only, tamper-evident audit store, buffered writes, hash-provider fallbacks, archive/exports, PII-light redaction) and <code>modRibbonCallbacks</code> (Office Ribbon lifecycle, safe handler registry, job scheduling via <code>Application.OnTime</code>, retries/backoff, job sheet migration, reconciliation, CI self-tests). This doc explains public surface, data schemas, runtime behavior, safety knobs, troubleshooting, and operational best practices. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>High-level architecture</strong><br><code>modAudit</code> persists cryptographically chained rows to <code>_IFRS_Audit</code>. <code>modRibbonCallbacks</code> manages UI callbacks and schedules background work via a jobs sheet <code>_IFRS_Jobs</code>; it prefers calling into <code>modAudit</code> / <code>modUtilities</code> for audit/CRC but contains safe local fallbacks (e.g., <code>AppendLocalAuditFallback</code>, local CRC32). The two modules interoperate via structured audit calls (<code>Ribbon_AuditStructured</code>). </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Primary public API (summary)</strong><br>modAudit: <code>InitAuditModule</code>, <code>ShutdownAuditModule</code>, <code>LogAudit</code>, <code>AppendAuditEntry</code>, <code>AppendAuditBuffered</code>, <code>FlushAuditBuffer</code>, <code>RotateAuditNow</code>, <code>ExportAuditToCSV</code>, <code>ExportAuditToJSON</code>, <code>VerifyAuditChain</code>, <code>GenerateAuditDiagnosticReport</code>, <code>FindAuditByCorrelationID</code>, <code>ReadAuditRow</code>, <code>SetAuditFeatureFlag</code>, <code>GetAuditFeatureFlag</code>.<br>modRibbonCallbacks public callbacks (key): <code>Ribbon_OnLoad</code>, <code>Ribbon_OnButtonClick</code>, <code>Ribbon_OnToggle</code>, <code>Ribbon_OnGalleryChange</code>, <code>Ribbon_GetEnabled</code>, <code>Ribbon_GetVisible</code>, <code>Ribbon_GetLabel</code>, <code>Ribbon_GetPressed</code>, <code>Ribbon_GetImage</code>, <code>Ribbon_RegisterHandler</code>, <code>Ribbon_RegisterImageProvider</code>, <code>Ribbon_RegisterLegacyAlias</code>, <code>Ribbon_ScheduleLongTask</code>, <code>Ribbon_ProcessJob_OnTime</code>, <code>Ribbon_ProcessJob</code>, <code>Ribbon_AttemptGracefulShutdown</code>, <code>Ribbon_ReconcileJobsOnOpen</code>, <code>Ribbon_ExecuteDebouncedInvalidate</code>, <code>Ribbon_SelfTest</code>, <code>Ribbon_OnTimeRoute</code>, <code>Ribbon_RunSelfTestOnce</code>, <code>Ribbon_VerifyPlan</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Audit canonical schema & ribbon storage mapping</strong><br>Canonical (CSV/JSON concept): <code>timestamp,correlationId,module,procedure,severity,userId,payloadHash,prevHash,signature</code>.<br><code>modAudit</code> worksheet columns: <code>TimestampUTC, CorrelationID, Module, Procedure, Severity, ErrNum, WindowsUser, ExcelUser, Action, ContextJSON, PrevHash, Hash</code>.<br><code>modRibbonCallbacks</code> local fallback audit sheet columns: <code>Timestamp, Action, Message, CorrId, JobId, Proc</code> (when <code>modAudit</code> not available). </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Jobs sheet schema (explicit columns)</strong><br>Worksheet: <code>_IFRS_Jobs</code> header (A..N): <code>JobId</code>, <code>Handler</code>, <code>Status</code>, <code>ScheduledAt</code>, <code>LastError</code>, <code>Meta</code>, <code>CreatedAt</code>, <code>UpdatedAt</code>, <code>v2_migrated</code>, <code>Attempts</code>, <code>LastAttemptAt</code>, <code>RunDurationMs</code>, <code>CorrId</code>, <code>HandlerMeta</code>.<br>Column constants in code: <code>COL_JobId=1</code>, <code>COL_Handler=2</code>, <code>COL_Status=3</code>, <code>COL_ScheduledAt=4</code>, <code>COL_LastError=5</code>, <code>COL_Meta=6</code>, <code>COL_CreatedAt=7</code>, <code>COL_UpdatedAt=8</code>, <code>COL_v2_migrated=9</code>, <code>COL_Attempts=10</code>, <code>COL_LastAttemptAt=11</code>, <code>COL_RunDurationMs=12</code>, <code>COL_CorrId=13</code>, <code>COL_HandlerMeta=14</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Job lifecycle & statuses</strong><br>Typical statuses: <code>queued</code>, <code>running</code>, <code>completed</code>, <code>failed</code>, <code>cancelled</code>, <code>orphaned</code>, <code>orphaned_permanent</code>.<br>Transition rules:<br>• <code>EnqueueOrUpdateJob</code> → row created/updated, <code>Status=&quot;queued&quot;</code>, <code>ScheduledAt</code> set.<br>• <code>SafeOnTimeScheduleWithRetry</code> schedules <code>Application.OnTime</code>; on success scheduled metadata and attempts recorded; on permanent failure job set <code>orphaned</code>/<code>orphaned_permanent</code>.<br>• <code>Ribbon_ProcessJob</code> sets <code>running</code>, executes handler safely, records <code>Attempts</code>, <code>RunDurationMs</code>, final <code>Status</code> and <code>LastError</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>OnTime scheduling & retry/backoff</strong><br><code>SafeOnTimeScheduleWithRetry</code> attempts up to <code>ONTIME_MAX_RETRIES = 3</code> with exponential backoff; records attempts via <code>RecordScheduleAttempt</code> and marks job orphaned on persistent failure. <code>SafeOnTimeSchedule</code> is a thin wrapper that logs immediate failures. <code>Ribbon_AttemptGracefulShutdown</code> cancels scheduled OnTime procs where possible. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Proc-string building & routing</strong><br><code>BuildOnTimeProcString(procBase, jobId)</code> returns either long proc <code>&#x27;WorkbookName&#x27;!procBase &quot;corrId&quot;</code> when under <code>PROC_STR_MAX_LEN</code> (240) and valid; otherwise falls back to <code>&#x27;WorkbookName&#x27;!Ribbon_OnTimeRoute &quot;corrId&quot;</code>.<br>Long route allows <code>Ribbon_ProcessJob_OnTime(argCorrId)</code> to be invoked directly; short route uses <code>Ribbon_OnTimeRoute</code> to look up job by <code>CorrId</code>. <code>BuildOnTimeProcString</code> persists <code>CorrId</code> into the job row. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Safety and input validation</strong><br><code>IsValidProcName</code> enforces: length ≤ <code>PROC_STR_MAX_LEN</code>, no control characters, disallow <code>;</code> and <code>,</code> to avoid chain/injection, validates <code>!</code> and quoted arg patterns for OnTime style strings. <code>MakeArgSafe</code> sanitizes arguments (capable scalars only); <code>SafeApplicationRun</code> caps args to <code>SAFE_ARG_LIMIT = 3</code> and prefers <code>modUtilities.TryRunReturn</code> if present. <code>SafeApplicationRunPicture</code> wraps image providers and returns <code>IPictureDisp</code> when available. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Debounce & UI invalidation</strong><br><code>Ribbon_Invalidate</code> schedules a debounced invalidate via <code>Application.OnTime</code> to call <code>Ribbon_ExecuteDebouncedInvalidate</code>. Default debounce <code>DEFAULT_INVALIDATE_DEBOUNCE_SECONDS = 0.25</code> but can be overridden via workbook name <code>IFRS_RibbonInvalidateDebounceSeconds</code> or <code>modConfig.GetSetting</code>. <code>EnsureDebounceConfigDefault</code> seeds a default in <code>modConfig</code> if available. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Correlation IDs & CRC32</strong><br><code>GenerateCorrelationID(seed)</code> prefers delegated <code>modUtilities.CRC32_String</code>; fallback uses local CRC32 table with deterministic UTF-16LE bytes → string <code>METRIC_PREFIX &amp; HexFromLong(crc)</code>. Ribbon uses <code>METRIC_PREFIX = &quot;rb-&quot;</code>. <code>modAudit</code> uses <code>NewCorrelationId()</code> producing <code>IFRS-...</code> GUID-like ids. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Hashing & provider selection (from modAudit)</strong><br>Hash provider order: (1) external macro <code>HashProviderMacroName</code> if <code>g_allowExternalHashProvider = True</code>; (2) system SHA256 via <code>certutil</code>/<code>shasum</code>/<code>openssl</code> if <code>g_allowCommandExecution = True</code>; (3) CRC32 fallback. Each provider use is recorded to meta (<code>HashProviderUsed</code>) and counts maintained. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Redaction & payload handling (from modAudit)</strong><br><code>RedactSensitiveData</code> uses regexes to remove emails, SSN-like numbers, long numeric sequences, account numbers, JWTs, API key patterns, long hex/base64 blobs; <code>g_aggressiveRedaction</code> increases sensitivity. <code>MAX_CONTEXT_LENGTH = 2000</code> enforces truncation with <code>ContextTruncated</code> events. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Meta sheet & diagnostics</strong><br>Audit meta sheet <code>_IFRS_AuditMeta</code> records <code>LastFlushUTC</code>, <code>BufferedCount</code>, <code>EnableMetaSheet</code>, <code>AggressiveRedaction</code>, and hash provider counts. <code>modRibbonCallbacks</code> writes to <code>_IFRS_TestResults</code> for self-tests and <code>Ribbon_VerifyPlan</code> populates test rows for CI. <code>GenerateAuditDiagnosticReport</code> and <code>VerifyAuditChain</code> support forensic analysis. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Self-test & CI hooks</strong><br><code>Ribbon_SelfTest</code>, <code>Ribbon_VerifyPlan</code>, <code>Ribbon_RunSelfTestOnce</code> provide deterministic non-UI checks and write results to <code>_IFRS_TestResults</code>. Recommended to run in CI to validate sheet presence, header correctness, debounce setting, proc validation, OnTime routing, and audit availability. <code>VerifyAuditChain</code> must be run as part of release CI/monitoring (per modAudit guidance). </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Migration & upgrade path</strong><br><code>EnsureJobsSheetExists</code> checks a <code>v2_migrated</code> marker (row 2, <code>COL_v2_migrated</code>) and calls <code>MigrateJobsSheetToV2</code> when needed. Migration creates a deterministic backup sheet named <code>&quot;_IFRS_Jobs_backup_yyyymmdd_hhmmss&quot;</code> before modifying rows and populates new columns (<code>Attempts</code>, <code>RunDurationMs</code>, <code>CorrId</code>, <code>HandlerMeta</code>). </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Telemetry & internal audit events (examples)</strong><br>Ribbon emits structured audit entries: <code>RegisterHandler</code>, <code>RegisterImageProvider</code>, <code>EnqueueOrUpdate</code>, <code>OnTimeScheduleRetry</code>, <code>OnTimeScheduleFailPermanent</code>, <code>ProcessJobComplete</code>, <code>ProcessJobHandlerError</code>, <code>ReconcileOrphaned</code>, <code>ReconcileReschedule</code>, <code>SelfTestComplete</code>, and many internal markers (<code>FlushStart</code>, <code>RotateStart</code>, <code>HashProviderUsed</code>). These help CI/ops correlate UI actions to background job outcomes. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Error handling & fallbacks</strong><br>Both modules prefer centralized helpers (<code>modAudit</code>, <code>modUtilities</code>, <code>modError</code>) but implement local fallbacks to avoid hard failures. <code>On Error</code> handling emits fallback audit rows and writes minimal info to support debugging. Bulk-write failures in <code>FlushAuditBuffer</code> fall back to per-row writes. <code>AppendLocalAuditFallback</code> avoids recursion by not calling <code>Ribbon_AuditStructured</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Operational recommendations</strong><br>• Call <code>InitAuditModule</code> at add-in/workbook startup and <code>ShutdownAuditModule</code> on close.<br>• Run <code>VerifyAuditChain</code> in CI and periodic monitoring; any mismatch should trigger the audit-compromise runbook.<br>• Protect <code>_IFRS_Audit</code>, <code>_IFRS_AuditMeta</code>, <code>_IFRS_Jobs</code>, <code>_IFRS_TestResults</code> with sheet/workbook protection and access controls.<br>• Disable <code>allowExternalHashProvider</code> unless <code>HashProviderMacroName</code> is trusted and code-reviewed. Consider disabling <code>g_allowCommandExecution</code> on locked endpoints.<br>• Keep <code>ContextJSON</code> payloads small and PII-light to avoid unnecessary redaction/truncation. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Security considerations</strong><br>• <code>IsValidProcName</code> and <code>MakeArgSafe</code> mitigate remote code injection via <code>Application.Run</code> and <code>OnTime</code> strings — retain and review these validators when modifying proc-string logic.<br>• Limit <code>SAFE_ARG_LIMIT</code> and sanitize inputs to handlers; prefer typed, explicit arguments passed through job metadata rather than raw user input.<br>• Audit and review any enabled external macro hash provider or <code>Application.OnTime</code> strings that contain quoted arguments. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Troubleshooting checklist</strong><br>1. Missing scheduled job runs: check <code>_IFRS_Jobs</code> <code>Meta</code> column, <code>CorrId</code>, <code>Meta</code> proc string; validate <code>IsValidProcName</code> and <code>Application.OnTime</code> success (check <code>OnTimeScheduleRetry</code> audit entries).<br>2. Orphaned jobs after restart: run <code>Ribbon_ReconcileJobsOnOpen</code> (automatic on load); inspect <code>Attempts</code> and <code>LastError</code> columns.<br>3. Verify audit chain mismatch: run <code>VerifyAuditChain</code> → if fails run <code>GenerateAuditDiagnosticReport</code> and follow <code>audit-compromise</code> runbook.<br>4. Long context truncated: reduce payload, or increase <code>MAX_CONTEXT_LENGTH</code> with caution and update redaction policies.<br>5. Image provider failures: ensure registered provider name valid and <code>SafeApplicationRunPicture</code> returns <code>IPictureDisp</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Examples (patterns)</strong><br>Enqueue async handler:<br><code>EnqueueOrUpdateJob &quot;job-123&quot;, &quot;MyHandlerProc&quot;, DateAdd(&quot;s&quot;,1,Now)</code> → <code>UpdateJobMeta jobId, BuildOnTimeProcString(&quot;Ribbon_ProcessJob_OnTime&quot;, jobId)</code> → <code>SafeOnTimeScheduleWithRetry</code>.<br>BuildOnTimeProcString output examples:<br><code>&#x27;MyWorkbook.xlsm&#x27;!Ribbon_ProcessJob_OnTime &quot;rb-XXXXXXXX&quot;</code> (long route) or <code>&#x27;MyWorkbook.xlsm&#x27;!Ribbon_OnTimeRoute &quot;rb-XXXXXXXX&quot;</code> (short route fallback). </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Limitations & notes</strong><br>• <code>modAudit</code> does not produce cryptographic signatures by default; signatures mentioned in the canonical schema must be produced by an external signing step (CI/release manifest).<br>• System SHA256 depends on platform tools; disabled environments will fall back to CRC32 (weaker).<br>• <code>Application.OnTime</code> scheduling is best-effort and subject to host Excel session uptime; job persistence relies on <code>_IFRS_Jobs</code> being durable and reconciled on open. </td></tr><tr><td data-label="Technical User Guide — modAudit + modRibbonCallbacks"> <strong>Change-management & CI checklist</strong><br>Before release/update: run <code>Ribbon_VerifyPlan</code> and <code>Ribbon_RunSelfTestOnce</code>, run <code>VerifyAuditChain</code>, export audit via <code>ExportAuditToCSV</code> and sign if signatures are required, confirm <code>AUDIT_ARCHIVE_FOLDER</code> retention policy, and review <code>g_allowExternalHashProvider</code> & <code>g_allowCommandExecution</code> settings for environment. </td></tr></tbody></table></div><div class="row-count">Rows: 24</div></div><div class="table-caption" id="Table13" data-table="Docu_0158_13" style="margin-top:2mm;margin-left:3mm;"><strong>Table 13</strong></div>
<div class="table-wrapper" data-table-id="table-13"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modSecurity"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modSecurity</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modSecurity"> <strong>Overview</strong><br>Centralized security helpers for the add-in: signature checks, macro/security sanity checks, export-path policy, credential wrappers (delegates to discovered secret store), audit integration, unit-test harness, atomic write helper, migration & CI helpers. Designed to work with existing project-level <code>modAudit</code> and <code>modConfig</code> if present but uses safe runtime discovery and conservative defaults to avoid breaking older projects. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Purpose & design principles</strong><br>• Non-breaking: no public API changes except one optional parameter default.<br>• Runtime discovery of centralized handlers (<code>RunCandidatesReturn</code>) to avoid compile-time coupling.<br>• Conservative safe defaults and explicit feature flags to enable deprecated or risky behaviors (e.g., plaintext CustomXML persistence, external command probes).<br>• Strong preference for secure stores and delegated prompts; prompts/fallbacks are behind feature flags. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Public API (summary)</strong><br><code>Security_CheckWorkbookSignature(Optional minSignatures, Optional callerCid)</code> — checks workbook signatures; uses <code>RunConfigGet</code> for default <code>minSignatures</code>.<br><code>Security_IsVBAProjectProtected(callerCid)</code> — detects VBProject protection (returns error code if unavailable).<br><code>Security_VerifyMacroSettings(callerCid)</code> — verifies <code>Application.AutomationSecurity</code> not forced disabled.<br><code>Security_IsUserAdmin(callerCid)</code> — best-effort admin probe (Windows <code>whoami /groups</code> guarded by feature flag).<br><code>Security_AllowExportToPath(targetPath, callerCid)</code> — policy check + writability probe.<br><code>Security_GetCredential(key, callerCid)</code> / <code>Security_SetCredential(key,value,callerCid)</code> — credential read/write via discovered store or controlled fallback.<br><code>Security_RunCmdAndGetOutput(cmd, callerCid)</code> — guarded, audited command runner (Windows only) with timeout and policy checks.<br><code>Security_VerifyExportPathWritable(path, callerCid)</code> — atomic write probe.<br><code>Security_SelfTest(callerCid)</code> / <code>Security_RunUnitTests(callerCid)</code> — self-test and unit tests; writes results to hidden sheet.<br><code>Security_MigrateCustomXMLToStore(requireAdmin, callerCid)</code> — migrates CustomXML credentials to secure store (flag-gated).<br><code>Security_GenerateCorrelationId()</code> — wrapper to <code>NewCorrelationId()</code>.<br><code>Security_FindCrossModuleCollisions(callerCid)</code> / <code>Security_ScanForDuplicateSymbols(callerCid)</code> — codebase scans.<br><code>Security_MigrationChecklistReport(callerCid)</code> / <code>Security_RolloutPlan(callerCid)</code> — migration guidance strings.<br><code>Security_CI_Gate()</code> — CI gate orchestration: run unit tests, self-tests, central handler assertions. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Feature flags & conservative defaults</strong><br>Key flags resolved via <code>FeatureFlagEnabled</code> / <code>RunConfigGet</code> (runtime discovery):<br>• <code>FLAG_ENABLE_LOCAL_AUDIT</code> — allow in-module audit fallback (disabled by default).<br>• <code>FLAG_ENABLE_PROMPT_FALLBACK</code> — allow unmasked InputBox fallback for secrets (disabled by default).<br>• <code>FLAG_ALLOW_PLAINTEXT_SECRET_PERSIST</code>, <code>FLAG_CUSTOMXML_MIGRATION_CONFIRM</code>, <code>FLAG_ALLOW_CUSTOMXML_FALLBACK</code> — control CustomXML persistence & migration.<br>• <code>FLAG_USE_WHOAMI_FOR_ADMIN_PROBE</code> — gates <code>whoami</code> usage.<br>• <code>FLAG_AUDIT_VERBOSE</code> — controls audit verbosity. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Credential handling & migration</strong><br>Read order for <code>Security_GetCredential</code>:<br>1. Prefer secure store via discovered config procedure (<code>Config_GetSecret</code> candidates).<br>2. Do NOT read <code>CustomXMLParts</code> at runtime (deprecated) — module audits and logs deprecation.<br>3. Delegated masked prompt via discovered <code>SecretPrompt</code> candidates.<br>4. Optional unmasked InputBox fallback only if <code>FLAG_ENABLE_PROMPT_FALLBACK</code> enabled.<br><code>Security_SetCredential</code> prefers secure store; refuses plaintext persistence unless explicit flags allow deprecated CustomXML writes. <code>Security_MigrateCustomXMLToStore</code> migrates CustomXML entries into the secure store (flag + optional admin requirement). </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Audit integration & safe logging</strong><br><code>Security_Audit(action, message, cid)</code> delegates to centralized audit candidates (<code>modAudit.LogAudit</code>, <code>modAudit.AppendLocalAuditStructured</code>, etc.) using <code>RunCandidatesReturn</code> and redacts secrets first (<code>RedactSecrets</code>). If no centralized audit present and <code>FLAG_ENABLE_LOCAL_AUDIT</code> is true, falls back to <code>AppendLocalAuditStructured_Fallback</code> (minimal local shim kept intentionally small). Module never logs raw secret values and truncates messages unless <code>FLAG_AUDIT_VERBOSE</code> is enabled. Correlation IDs are propagated for cross-module traceability. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Local audit fallback</strong><br>Minimal fallback writer (<code>AppendLocalAuditStructured_Minimal</code>) writes a simple <code>_modSecurity</code> audit sheet (<code>modSecurity_Audit</code>) with <code>Timestamp, CorrelationId, User, Action, Message, Meta, RowHash</code>. This is feature-flag gated and intentionally lightweight to avoid leakage. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Redaction & secrets scanning</strong><br><code>RedactSecrets(txt)</code> uses tight RegExp patterns to remove common keys (password, token, api key, etc.) with lower false-positive risk (short benign tokens skipped). <code>AssertNoSecretsInAudit</code> scans recent audit rows (last 200) for suspicious tokens and returns a count. Unit tests assert no obvious secrets in the audit. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Command execution & safeties</strong><br><code>Security_RunCmdAndGetOutput(cmd,cid)</code> is Windows-only (skips on macOS), uses <code>WScript.Shell.Exec</code> guarded by <code>IsCmdSafe</code> and command timeout <code>MS_CMD_TIMEOUT_SEC</code>. It truncates output, never logs raw command text (only length/summary), and audits execution. <code>IsCmdSafe</code> rejects pipes, redirects, remote URLs, known dangerous tokens (powershell -enc, curl, wget), and overly long commands. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Atomic write helper</strong><br><code>AtomicWriteFile(fullPath, contents)</code> writes to a unique temporary file in target folder then moves/renames into place, with fallback to direct create on failure. Used by <code>Security_VerifyExportPathWritable</code> to prove writability without race conditions. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Export path policy & path canonicalization</strong><br><code>Security_AllowExportToPath(targetPath)</code> resolves allowed roots using <code>RunConfigGet(&quot;DEFAULT_EXPORT_ALLOW_KEY&quot;)</code> or defaults to <code>ThisWorkbook.path</code>. It normalizes paths via <code>NormalizePathShared</code> which prefers <code>modUtilities.NormalizePath</code> if present; <code>Security_PathIsUnder</code> checks descendant relationships. <code>Security_VerifyExportPathWritable</code> verifies folder existence and atomic-write permission. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Self-test, unit tests & CI</strong><br><code>Security_SelfTest</code> runs macro settings check, signature check, VBProject protection probe, export path writable probe, and optional deterministic mode controlled by <code>FLAG_SELFTEST_DETERMINISTIC</code>.<br><code>Security_RunUnitTests</code> exercise redaction, <code>SafeApplicationRun</code>, <code>Security_SelfTest</code>, ADODB probe, duplicate symbol scan, cross-module collisions, and audit secret assertions. Results recorded in hidden <code>modSecurity_TestResults</code> sheet. <code>Security_CI_Gate</code> ties unit tests, self-test, and handler assertions into a CI-friendly exit string. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>RunCandidates, SafeApplicationRun, Resolvers</strong><br><code>RunCandidatesReturn(candidatesCSV, args...)</code> attempts a comma-separated list of procedure names (e.g., <code>modConfig.Config_Get</code>) and returns the first non-empty result; used everywhere to discover centralized handlers.<br><code>SafeApplicationRun(procName, args...)</code> protects <code>Application.Run</code> calls and returns <code>Empty</code> on failures. <code>RunConfigGet(key, default)</code> is a convenience wrapper for config discovery. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Codebase scanning & collision detection</strong><br><code>Security_ScanForDuplicateSymbols</code> and <code>Security_FindCrossModuleCollisions</code> use <code>VBScript.RegExp</code> to scan module code for <code>Const/Function/Sub</code> declarations and report duplicates or cross-module collisions (best-effort; skips on macOS or when VBE access unavailable). </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Migration & rollout helpers</strong><br><code>ValidateConfigConstants</code> probes for standard config keys and emits an audit if missing. <code>Security_MigrationChecklistReport</code> gives a short checklist including feature-flag checks and secret-store probe. <code>Security_RolloutPlan</code> returns a concise suggested plan: refactor → centralized audit switch → stricter secret handling behind flags → flip flag after verification. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Meta & test sheet behaviour</strong><br>Hidden sheets used: <code>modSecurity_Audit</code> (fallback), <code>modSecurity_TestResults</code>. New sheets are <code>xlSheetVeryHidden</code> by default. <code>WriteSelfTestResult</code> logs timestamp, correlationId, ok, iterations, and user. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Error handling & diagnostics</strong><br><code>Security_HandleError</code> attempts to call centralized error handlers (<code>modError.HandleError</code> candidates) with redacted descriptions. If centralized handlers are missing, it falls back to <code>Security_Audit &quot;Error&quot;, ...</code> and <code>Debug.Print</code>. <code>ValidateConfigConstantsReport</code> returns a comma-separated list of missing config constants. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Operational guidance & hardening</strong><br>• Ensure <code>modAudit</code> and <code>modError</code> are present and wired via <code>RunCandidatesReturn</code> for centralized behavior.<br>• Protect hidden sheets and use workbook protection and file ACLs.<br>• Disable deprecated fallback flags (<code>FLAG_ENABLE_LOCAL_AUDIT</code>, <code>FLAG_ENABLE_PROMPT_FALLBACK</code>, <code>FLAG_ALLOW_PLAINTEXT_SECRET_PERSIST</code>) in production.<br>• Prefer secret-store integration (implement <code>Config_GetSecret</code>/<code>Config_SetSecret</code> candidates) and remove CustomXML storage. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Limitations & known behaviors</strong><br>• Best-effort discovery: absent <code>modConfig</code>/handlers → fallbacks may be used or operations refused depending on flags.<br>• Admin and VBProject probes may fail on locked-down systems or macOS (platform differences).<br>• <code>RunCandidatesReturn</code> uses <code>Application.Run</code> semantics — callers must ensure candidate names are exported/public.<br>• Command execution and whoami probes rely on <code>WScript</code> availability and are feature-flag gated. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Troubleshooting checklist</strong><br>1. Central audit missing: run <code>AssertCentralizedHandlersPresent()</code> and inspect <code>ValidateConfigConstantsReport()</code>.<br>2. Credential store absent: implement <code>Config_GetSecret</code> / <code>Config_SetSecret</code> or enable/outsource secure store integration; avoid CustomXML fallback.<br>3. Export failures: verify <code>DEFAULT_EXPORT_ALLOW_KEY</code> and <code>ThisWorkbook.path</code> resolution; check <code>Security_VerifyExportPathWritable</code> test file.<br>4. CI failures: run <code>Security_CI_Gate()</code> and review unit test outputs in <code>modSecurity_TestResults</code>.<br>5. Audit contains secrets: run <code>AssertNoSecretsInAudit()</code> and <code>Security_RunUnitTests()</code> to surface failures. </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Examples & sample messages</strong><br>Audit message examples produced by module (redacted):<br><code>CheckWorkbookSignature | signatures=2;result=True</code><br><code>GetCredential | key=ap****ey;method=store</code><br><code>RunCmd | cmd_executed;output_len=345</code> </td></tr><tr><td data-label="Technical User Guide — modSecurity"> <strong>Developer notes for integration</strong><br>• Keep feature flags in <code>modConfig</code> if available so runtime discovery picks them up.<br>• Provide <code>Config_GetSecret</code> and <code>Config_SetSecret</code> implementations to avoid falling back to prompts or deprecated storage.<br>• Wire centralized <code>modAudit.LogAudit</code> and <code>modError.HandleError</code> to achieve consistent telemetry and runbook triggers.<br>• Review <code>IsCmdSafe</code> and blacklist whitelist rules to suit your org policy before enabling command execution features. </td></tr></tbody></table></div><div class="row-count">Rows: 22</div></div><div class="table-caption" id="Table14" data-table="Docu_0158_14" style="margin-top:2mm;margin-left:3mm;"><strong>Table 14</strong></div>
<div class="table-wrapper" data-table-id="table-14"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modStatements"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modStatements</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modStatements"> <strong>Overview</strong><br>Assemble, validate, render, snapshot and reconcile financial statement packages in VBA. Designed to work with host helpers when available but robust when they are absent. Emphasises deterministic package shape, safe worksheet operations (no <code>Select</code>/<code>Activate</code>), formula-injection sanitization, snapshotting (very-hidden), and audit integration via <code>SafeAuditStructured</code> / local audit fallback. Schema and revision are tracked (<code>STATEMENT_PACKAGE_SCHEMA</code>, <code>ModuleRevision</code>). </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Public API</strong><br><code>AssembleStatementPackage(packageID, sourceLines, Optional templateName, Optional author) As Object</code> — build deterministic package dictionary; returns <code>Dictionary</code> or <code>Nothing</code>.<br><code>ValidateStatementPackage(pkg) As Object</code> — returns <code>Dictionary</code> of issues (empty = no issues).<br><code>RenderStatementToSheet(pkg, sheetName, Optional targetWb) As Boolean</code> — render package to worksheet (safe, batched write).<br><code>RestoreStatementSnapshot(snapshotSheetName, targetSheetName, Optional targetWb) As Boolean</code> — copy+rename snapshot with collision handling.<br><code>CreateStatementSnapshot(pkg, sourceSheetName, Optional targetWb) As String</code> — create very-hidden snapshot and record metadata; returns snapshot name.<br><code>GenerateReconciliation(pkg, tbRange) As Variant</code> — reconcile package lines to trial-balance range; returns 2D array [LineID, Amount, TBsum, Difference]. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Public constants & limits</strong><br><code>STATEMENT_SNAPSHOT_PREFIX = &quot;_IFRS_StatementSnapshot_&quot;</code>.<br><code>STATEMENT_PACKAGE_SCHEMA = &quot;1.0.0&quot;</code>.<br><code>STATEMENT_BALANCE_TOLERANCE = 0.005</code> — tolerance for zero-balance check.<br><code>MAX_LINES_THRESHOLD = 10000</code> — defensive limit; <code>AssembleStatementPackage</code> truncates and emits a log when exceeded. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Package shape & determinism</strong><br>Package is a <code>Scripting.Dictionary</code> with keys: <code>PackageID</code>, <code>CorrelationID</code>, <code>SchemaVersion</code>, <code>TemplateName</code>, <code>Author</code>, <code>CreatedUTC</code>, <code>Lines</code>, <code>Status</code>.<br><code>CorrelationID</code> produced by <code>SafeNewCorrelationID()</code> for reproducible IDs when host helper unavailable. <code>GetStableJson</code> writes deterministic JSON for snapshot metadata (uses host <code>DictToJsonStable</code> if present, otherwise local <code>DictToJsonStable</code>). </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Input normalization</strong><br><code>NormalizeLines</code> accepts arrays (1D/2D), <code>Dictionary</code> (.Items), <code>Collection</code>, other iterables, or scalar values and returns a 1-based <code>1..n</code> array or <code>Empty</code>. Robust handling for multi-dimensional arrays and object enumerables. <code>GetLineCount</code> and helpers provide safe counts. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Validation rules</strong><br><code>ValidateStatementPackage</code> checks: package presence/type, <code>Lines</code> existence, each line is dictionary-like, <code>LineID</code> present, <code>Amount</code> numeric. Aggregates total and flags <code>TotalNotZero</code> when abs(total) > <code>STATEMENT_BALANCE_TOLERANCE</code>. Returns structured <code>issues</code> dictionary and always audits validation completion. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Rendering behavior</strong><br>Writes headers and body without selection. Uses <code>SanitizeForCell</code> to avoid formula injection (prefix <code>&#x27;</code> when value starts with <code>=</code>, <code>+</code>, <code>-</code>, <code>@</code>). Batch-writes data using a 2D <code>Variant</code> array (<code>outArr</code>) for performance. Normalizes and caches <code>AccountRefs</code> per-line to minimize work. Sets <code>pkg(&quot;Status&quot;) = &quot;Rendered&quot;</code> and emits a structured audit. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Snapshot model</strong><br><code>CreateStatementSnapshot</code> copies source sheet, renames to a safe snapshot name (<code>STATEMENT_SNAPSHOT_PREFIX + timestamp [+ short correlation]</code>), marks snapshot <code>xlSheetVeryHidden</code>, and records metadata into <code>_IFRS_Snapshots</code> (columns: <code>SnapshotName, PackageID, CorrelationID, SchemaVersion, CreatedUTC, SourceSheet, PackageJson</code>). Rename has collision handling and a move/copy fallback using a temporary workbook. <code>RestoreStatementSnapshot</code> copies snapshot, safely renames with collision resolution, deletes existing target, and reveals the restored sheet. Both actions are audited. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Reconciliation logic</strong><br><code>GenerateReconciliation</code> builds a trial-balance dictionary from <code>tbRange</code> (expects ≥2 columns: Account, Amount), sums matching <code>AccountRefs</code> for each package line, and returns a matrix: <code>LineID</code>, <code>Amount</code>, <code>TBsum</code>, <code>Difference</code>. Keys are case-sensitive by default (use <code>UCase$</code> modification if case-insensitive matching required). Emits structured audit on completion. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Export & IO helpers</strong><br><code>ExportSheetToCsv(sh, filepath)</code> writes CSV with quoting rules and decimal separator normalization. Respects host security policy probe <code>Security_VerifyExportPathWritable</code> when present. <code>GetOrCreateSnapshotMetadataSheet</code> creates <code>_IFRS_Snapshots</code> as <code>xlSheetVeryHidden</code>. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Sanitization & naming</strong><br><code>SanitizeForCell</code> prevents formula injection. <code>SafeSheetName</code> strips invalid characters and enforces the 31-character Excel sheet name limit. <code>SafeTimestampCompact</code> formats compact timestamps for snapshot naming. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Audit & error integration</strong><br>All public entry points emit an entry audit via <code>SafeAuditStructured</code>. Error paths call <code>SafeHandleError</code> which attempts host <code>HandleError</code> → <code>modUtilities.HandleError</code> → fallback <code>AppendLocalAudit</code>. Logging uses <code>SafeLog</code> which attempts host <code>LogAudit</code> → <code>modUtilities.LogAudit</code> → <code>AppendLocalAudit</code>. This module intentionally defers to host helpers when available but functions offline with local audit fallbacks. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Host probing & extensibility</strong><br><code>HostHas</code>, <code>TryRun</code>, and <code>TryRunReturn</code> probe and invoke host/utility helpers (e.g., <code>SafeCreateSheet</code>, <code>ResolveWorkbook</code>, <code>DictToJsonStable</code>). The module caches <code>HostHas</code> results and prefers host implementations to allow global policy, signing, or security checks to be enforced by the host. Hooks: <code>MigrateStatementPackage</code> attempted during assembly if present. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Resilience & fallbacks</strong><br>Robust <code>On Error</code> handling; defensive typed getters (<code>NzStringDict</code>, <code>NzDoubleDict</code>, <code>NzVariantDict</code>) never raise. Bulk-write fallback: if batch write fails the code falls back to safe per-row operations in similar modules (Render/Flush patterns). Snapshot rename fallback uses temporary workbook move if direct rename fails. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Self-tests & release helpers</strong><br><code>ModStatements_SelfTest</code> runs deterministic checks: <code>NormalizeLines</code>, assemble→validate→render→reconcile round-trip, snapshot create/restore, CSV export; writes a test results sheet. <code>ModStatements_ReleaseChecklist(iterations)</code> runs <code>UtilitiesSelfTest</code> (if present) and repeats self-test iterations for release verification. <code>ModStatements_ConsistencyCheck</code> attempts to audit public member counts; will fall back when VBIDE access not available. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Security & operational guidance</strong><br>• Protect snapshot and metadata sheets (they are created <code>xlSheetVeryHidden</code> by default).<br>• Approve and review any host helpers invoked (<code>ResolveWorkbook</code>, <code>DictToJsonStable</code>, <code>SafeCreateSheet</code>) before enabling in production.<br>• Keep <code>Export</code> paths controlled; rely on <code>Security_VerifyExportPathWritable</code> host hook when available.<br>• Sanitize all user-provided text and avoid storing sensitive PII in <code>ContextJSON</code> or package <code>Lines</code> where possible. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Performance notes</strong><br>Batch writes via in-memory arrays are used for rendering and export to minimize interop cost. A <code>refsCache</code> reduces repeated normalization of <code>AccountRefs</code>. Use <code>SafeCreateSheetUnique</code> to avoid expensive rename conflict loops where possible. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Extensibility & recommended hooks</strong><br>• <code>MigrateStatementPackage(pkg)</code> — optional host migration hook called during assembly.<br>• <code>DictToJsonStable</code> / <code>GetStableJson</code> — prefer host implementation for consistent JSON signing/export.<br>• <code>Security_VerifyExportPathWritable(path)</code> — host-controlled export policy check.<br>Enable these hooks in audited/trusted environments to centralize policy, signing, and monitoring. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Troubleshooting checklist</strong><br>1. Missing audit entries → confirm host <code>SafeAuditStructured</code>/<code>LogAudit</code> availability or check <code>_IFRS_Audit</code> local fallback.<br>2. Snapshot rename failures → inspect sheet name collisions or workbook protection; <code>CreateStatementSnapshot</code> logs fallbacks and will delete failed copies.<br>3. Reconciliation mismatches → verify <code>AccountRefs</code> normalization, case-sensitivity, and <code>tbRange</code> columns. Use <code>GenerateReconciliation</code> output to inspect <code>Difference</code> column. <br>4. Export failures → check host <code>Security_VerifyExportPathWritable</code> return and file-system permissions. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Limitations & notes</strong><br>• Does not sign snapshots or package JSON by itself — integrate with host CI/release signing if signature/audit chaining required.<br>• Uses local time for some fallbacks; prefer host <code>GetUtcIsoTimestamp</code> for true UTC timestamps.<br>• Large packages beyond <code>MAX_LINES_THRESHOLD</code> are truncated with a log entry; increase threshold via configuration if needed. </td></tr><tr><td data-label="Technical User Guide — modStatements"> <strong>Recommended operational checklist</strong><br>1. Ensure <code>Init</code>/host startup calls to set centralized helpers.<br>2. Run <code>ModStatements_SelfTest</code> during CI and <code>ModStatements_ReleaseChecklist</code> before production rollouts.<br>3. Store archives/snapshots on restricted, backed-up storage and enforce access control.<br>4. Regularly run <code>ValidateStatementPackage</code> and <code>VerifyAuditChain</code> (from <code>modAudit</code>) as part of monitoring and CI to detect integrity or schema drift. </td></tr></tbody></table></div><div class="row-count">Rows: 21</div></div><div class="table-caption" id="Table15" data-table="Docu_0158_15" style="margin-top:2mm;margin-left:3mm;"><strong>Table 15</strong></div>
<div class="table-wrapper" data-table-id="table-15"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modAudit + modStatementsHelpers"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modAudit + modStatementsHelpers</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Overview</strong><br>Two cooperating VBA modules: <code>modAudit</code> (append-only tamper-evident audit store) and <code>modStatementsHelpers</code> (stable IDs, deterministic metadata store and JSON, caption/TOC helpers, safe writes, and audit hooks). Designed for Excel/VBA with defensive fallbacks, delegation to optional helper modules (<code>modUtilities</code>, <code>modError</code>, <code>modAudit</code>), and CI-friendly self-tests. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Primary goals</strong><br><code>modAudit</code>: authoritative, cryptographically chained audit rows; buffered and synchronous writes; rotation & export; verification.<br><code>modStatementsHelpers</code>: deterministic metadata for "statements" (table ranges), atomic-ish writes with retries, deterministic JSON, migration helpers, and local structured audit fallback. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Sheets used</strong><br><code>_IFRS_Audit</code> — canonical audit rows (modAudit) or local structured audit (modStatementsHelpers fallback).<br><code>_IFRS_AuditMeta</code> — audit module runtime metadata.<br><code>_IFRS_Metadata</code> — statements metadata table (key, json) and schema info.<br><code>_IFRS_TestResults</code>, <code>_IFRS_CI</code> — self-test & CI artifacts. All created <code>xlSheetVeryHidden</code> / idempotently. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Canonical audit row schema</strong><br>Conceptual (CSV/JSON): <code>timestamp,correlationId,module,procedure,severity,userId,payloadHash,prevHash,signature</code>.<br<code>Implemented columns (modAudit sheet)</code>: <code>TimestampUTC,CorrelationID,Module,Procedure,Severity,ErrNum,WindowsUser,ExcelUser,Action,ContextJSON,PrevHash,Hash</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>modAudit public API</strong><br><code>InitAuditModule()</code> / <code>ShutdownAuditModule()</code> — lifecycle.<br><code>LogAudit(action,details)</code> — legacy convenience.<br><code>AppendAuditEntry(...)</code> — synchronous append (strong durability).<br><code>AppendAuditBuffered(entry)</code>, <code>FlushAuditBuffer()</code> — buffered batch writes with fallback per-row writes.<br><code>RotateAuditNow()</code>, <code>ExportAuditToCSV(path)</code>, <code>ExportAuditToJSON(path)</code> — archiving/export.<br><code>VerifyAuditChain(firstBadRow,diagnosticCode)</code>, <code>GenerateAuditDiagnosticReport(path,startRow)</code> — verification & diagnostics.<br><code>FindAuditByCorrelationID(id)</code>, <code>ReadAuditRow(row)</code> — lookups.<br><code>SetAuditFeatureFlag(name,val)</code>, <code>GetAuditFeatureFlag(name)</code> — runtime flags. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>modStatementsHelpers public API</strong><br><code>RenderSafeHtml(text)</code>, <code>ValidateStatementAssembly(range)</code>.<br><code>GetStableTableID(range, extraSeed)</code>, <code>AssembleStatementMetadata(range, extras)</code> — deterministic metadata builder.<br><code>GetTableMetadata(key)</code>, <code>SetTableMetadata(key,json,applyMigrationApproval)</code> — metadata store with atomic-ish writes & validation.<br><code>EnsureTableCaption(range,caption)</code>, <code>InjectTOCReference(range,tocId)</code> — caption/TOC helpers.<br><code>RunSelfTestsForCI()</code>, <code>SelfTest_ModStatementsHelpers()</code>, <code>AdditionalSelfTests_ModStatementsHelpers()</code> — self-tests. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Metadata schema & expectations</strong><br>Metadata JSON MUST include <code>&quot;schemaVersion&quot;: &lt;METADATA_SCHEMA_VERSION&gt;</code> (module constant).<br>Recommended fields: <code>stableId, sheet, headerSignature, rows, cols, workbookFingerprint</code>.<br><code>ValidateMetadataJson(json)</code> returns <code>0=OK,1=missing_schema_token,2=mismatched_version_token,3=invalid_format</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Stable IDs & fingerprints</strong><br><code>GetStableTableID</code> uses <code>GetWorkbookFingerprint</code> + header signature + optional seed → CRC32 hash → key prefix <code>tblmeta_</code> + hex.<br><code>GetWorkbookFingerprint</code> uses saved workbook path & last-modified where available, else VBProject name or workbook name. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Deterministic JSON serialization</strong><br><code>DictionaryToJson_MaxDepth(dict,depth,maxDepth)</code> performs case-insensitive stable key ordering (insertion-sort) and depth-limited traversal. Outputs UTF-8 string and truncates deterministically if > <code>JSON_OUTPUT_MAX_LENGTH</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Atomic-ish writes & retry policy</strong><br><code>TryWithRetry_WriteToSheet</code> performs writes to a temp column (<code>METADATA_TEMP_COL</code>) then copies sanitized value into JSON column to avoid formula injection and partially atomic behavior. Retries up to <code>MAX_RETRIES</code> with <code>RETRY_WAIT_SECONDS</code> backoff. Logs structured audit entries on success/failure. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Safe read/write helpers</strong><br><code>SafeWriteRange</code> / <code>SafeReadRange</code> perform write attempts with retries and <code>IsWorksheetWritable</code> checks (unprotect attempt). All cell writes sanitized via <code>SanitizeForCell</code> to prevent formula injection. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Chunking & large metadata handling</strong><br>Constants: <code>METADATA_MAX_LENGTH</code>, <code>METADATA_CHUNKING_ENABLED</code>, <code>METADATA_CHUNK_SIZE</code>. If metadata > <code>METADATA_MAX_LENGTH</code> and chunking enabled, <code>ChunkMetadataAndStore</code> splits into parts <code>stableKey_part_XXX</code> and writes a manifest <code>stableKey_manifest</code>. Default: chunking disabled; large writes rejected and audited. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>CRC32 policy, delegation & fallbacks</strong><br><code>CRC32_String</code> attempts delegate <code>modUtilities.CRC32_String</code> first via <code>TryRunExternal</code>. If missing: behavior controlled by constants <code>CRC32_DELEGATE_ONLY</code> and <code>CRC32_ALLOW_FALLBACK</code> and runtime setters via <code>SetCRC32Policy</code>. Local CRC fallback implemented (one-time audit emitted) and DJB2 fallback used on error. Hash provider decisions recorded in audit meta. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Hashing across modules</strong><br><code>modAudit</code> prefers SHA256 (system tool if allowed) → macro provider (if explicitly enabled) → CRC32 fallback. <code>modStatementsHelpers</code> relies on CRC32 delegate-first for deterministic stable ids/checksums. Coordinate policies to ensure consistent canonical hash usage in CI. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Redaction & PII handling</strong><br><code>modAudit.RedactSensitiveData</code> implements multiple regex rules (emails, SSNs, long numbers, JWTs, API keys, hex/base64 blobs). <code>modStatementsHelpers.RedactForAudit</code> provides heuristic redaction for metadata subject strings and truncation (<code>AUDIT_REDACT_TRUNCATE</code>). <code>g_aggressiveRedaction</code> (modAudit) and <code>m_chunkingEnabledRuntime</code> (modStatementsHelpers) control stricter behaviors. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Named ranges / TOC idempotency</strong><br><code>CreateNamedRangeForTOC</code> creates <code>ThisWorkbook.Names(&quot;TOC_&lt;sanitizedId&gt;&quot;)</code> idempotently: checks existing name -> compares referring address -> deletes and recreates if mismatched. Emits <code>CreateNamedRangeForTOC</code> audit. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Local structured audit fallback (modStatementsHelpers)</strong><br>If <code>modAudit.LogAudit</code> is unavailable, <code>Audit_LogStructured</code> attempts <code>Application.Run &quot;modAudit.LogAudit&quot;</code> then global <code>LogAudit</code> then falls back to <code>AppendLocalAuditStructured</code>. Local structured audit columns: <code>Timestamp,User,Action,Subject,CorrelationID,Outcome,Checksum,Algorithm,RowHash</code>. Row hash uses canonical CRC32. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Verification and diagnostics</strong><br><code>VerifyAuditChain</code> (modAudit) iterates rows verifying <code>PrevHash</code> and recomputed <code>Hash</code>. Diagnostic codes: <code>0 OK</code>, <code>1 MissingPrevHash</code>, <code>2 HashMismatch</code>, <code>3 Malformed/Other</code>.<br><code>GenerateAuditDiagnosticReport(path,startRow)</code> emits CSV with expected/actual prev/hash and reason. <code>RunRevisionVerification10()</code> (modStatementsHelpers) runs <code>CheckRevisionPlanCompliance()</code> 10x and verifies deterministic checksums. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Self-tests & CI hooks</strong><br><code>SelfTest_ModStatementsHelpers</code> and <code>AdditionalSelfTests_ModStatementsHelpers</code> exercise JSON serialization, CRC consistency, metadata write/read, size rejection, and write self-test results to <code>_IFRS_TestResults</code>.<br><code>RunSelfTestsForCI</code> performs delegate pre-checks, runs self-tests, migration dry-run, and outputs CI-visible failures to <code>_IFRS_CI</code>. Modules produce deterministic JSON status from <code>CheckRevisionPlanCompliance</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Migration & legacy keys</strong><br><code>MigrateLegacyMetadataIfNeeded(sh, applyChanges, approvalToken)</code> does a dry-run by default and builds a manifest of guessed stable keys; only renames when <code>applyChanges=True</code> and <code>approvalToken</code> provided. Manifest is audited via <code>Audit_LogStructured</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Error handling & delegation to global error handler</strong><br><code>HandleLocalError(proc,errNum,errDesc)</code> attempts to call <code>modError.HandleError</code> then global <code>HandleError</code> via <code>Application.Run</code> and falls back to local audit entry. Keep error handler available in environment for best operator visibility. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Constants & tunables</strong><br>Key constants to review: <code>AUDIT_MAX_ROWS_BEFORE_ROTATE</code>, <code>AUDIT_BATCH_FLUSH_THRESHOLD</code>, <code>MAX_CONTEXT_LENGTH</code>, <code>METADATA_MAX_LENGTH</code>, <code>JSON_OUTPUT_MAX_LENGTH</code>, <code>MAX_RETRIES</code>, <code>RETRY_WAIT_SECONDS</code>, <code>METADATA_CHUNK_SIZE</code>, <code>CRC32_DELEGATE_ONLY</code>, <code>CRC32_ALLOW_FALLBACK</code>. Configure per deployment security/performance requirements. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Security & operational guidance</strong><br>• Treat <code>g_allowExternalHashProvider</code> and <code>HashProviderMacroName</code> as sensitive — enable only in audited/trusted environments.<br>• Consider disabling <code>g_allowCommandExecution</code> on locked endpoints to avoid <code>certutil</code>/<code>shasum</code> execution.<br>• Protect audit & metadata sheets (workbook protection, file ACLs) and ensure archives are stored in access-controlled, immutable locations.<br>• Run <code>VerifyAuditChain</code> in CI/monitoring; any mismatch should trigger audit-compromise runbook. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Limitations & operator notes</strong><br>• <code>signature</code> field in conceptual canonical schema is not produced by default — signing should be done externally in release CI using the release manifest's signing key.<br>• System SHA256 depends on external tools; may be unavailable on some platforms → CRC32 fallback reduces cryptographic strength.<br>• Chunking is opt-in; large metadata is rejected unless chunking enabled and operator accepts chunked manifest semantics. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Troubleshooting checklist</strong><br>1. Hash mismatch on verify → run <code>GenerateAuditDiagnosticReport</code> and inspect <code>firstBadRow</code> & <code>diagnosticCode</code>.<br>2. Unexpected CRC/SHA provider usage → inspect <code>_IFRS_AuditMeta</code> provider counts and feature flags.<br>3. Metadata set failures → check <code>METADATA_MAX_LENGTH</code>, sheet protection, <code>TryWithRetry_WriteToSheet</code> logs, and <code>MAX_RETRIES</code> behavior.<br>4. CI self-test failures → examine <code>_IFRS_TestResults</code> and <code>_IFRS_CI</code> sheets for per-test diagnostics. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Recommended CI practices</strong><br>• Include <code>VerifyAuditChain</code> and <code>RunRevisionVerification10</code> in CI pipelines post-release and periodically.<br>• Export and sign audit archives from CI prior to distribution.<br>• Ensure <code>modUtilities</code> and <code>modError</code> delegates are present for full feature parity; failing that, review fallback audit entries. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Quick reference: common function behaviors</strong><br><code>GetTableMetadata(key)</code> — returns JSON or empty.<br><code>SetTableMetadata(key,json,apply)</code> — validates schema, enforces size caps, then <code>TryWithRetry_WriteToSheet</code>; returns Boolean.<br><code>AppendAuditBuffered(entry)</code> — enqueues; flush at threshold or manually.<br><code>FlushAuditBuffer()</code> — bulk write; on error falls back to per-row <code>AppendAuditEntry</code> and logs <code>FlushFallback</code>. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Change log & revision plan compliance</strong><br><code>CheckRevisionPlanCompliance()</code> returns deterministic JSON summarizing implemented items and delegation health. Use <code>RunRevisionVerification10()</code> to prove idempotent deterministic output across runs. </td></tr><tr><td data-label="Technical User Guide — modAudit + modStatementsHelpers"> <strong>Contact/operator checklist before enabling risky features</strong><br>Enable <code>allowExternalHashProvider</code> only after code review of the macro provider; enable <code>allowCommandExecution</code> only when OS-level tools are trusted and endpoint policies permit execution. Review retention and encryption policies for archived CSV exports. </td></tr></tbody></table></div><div class="row-count">Rows: 29</div></div><div class="table-caption" id="Table16" data-table="Docu_0158_16" style="margin-top:2mm;margin-left:3mm;"><strong>Table 16</strong></div>
<div class="table-wrapper" data-table-id="table-16"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical User Guide — modUtilities"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical User Guide — modUtilities</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical User Guide — modUtilities"> <strong>Overview</strong><br>Collection of hardened, backward-compatible utility routines for IFRS_Reporting_AddIn.xlam. Provides safe file I/O (atomic writes / workbook save), ADODB-aware UTF-8 handling, named-range caching, safe COM creation with negative cache, sheet and named-range helpers, CSV import/export streams, robust retry/backoff helpers, diagnostics and CI/self-test helpers. Designed for hostile/heterogeneous Excel hosts and constrained environments. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Public API (summary)</strong><br><code>EnsureCaches</code> / <code>ResetCaches</code> — initialize/clear module caches.<br><code>SafeLogAudit(src,msg)</code> / <code>SafeHandleError(proc,errNum,desc)</code> — centralized logging wrappers (delegates to <code>modAudit</code>).<br><code>ResolveWorkbook(target)</code> / <code>WorkbookFingerprint(wb)</code> — workbook resolution & fingerprinting.<br><code>SheetExists</code>, <code>SafeGetWorksheet</code>, <code>SafeCreateSheet</code>, <code>SafeDeleteSheet</code>, <code>BackupSheet</code> — sheet lifecycle helpers with safe naming & optional backups.<br><code>NamedRangeExists</code>, <code>GetNamedRangeValue</code>, <code>SetNamedRangeValue</code>, <code>CreateOrUpdateNamedRange</code>, <code>ClearNamedRangeCache</code>, <code>InvalidateNamedRangeCacheForWorkbook</code> — named-range helpers with LRU cache.<br><code>SafeWriteRange</code> / <code>SafeReadRange</code> — fast array-based range IO handling 0-/1-based arrays.<br><code>AtomicWriteFile(fullPath, content)</code> — atomic UTF-8-aware file writer with retries and diagnostic capture.<br><code>AtomicSaveWorkbookAs(wb, fullPath)</code> — robust SaveCopyAs + atomic replacement.<br><code>IsPathWritable</code>, <code>IsPathWritableEx</code>, <code>GetTempFolder</code>, <code>EnsureFolderPathEndsWith</code>, <code>ExpandTildePath</code> — path helpers.<br><code>StreamImportCsvLines(fullPath, lineHandlerName)</code> — UTF-8/BOM tolerant CSV line streaming to handler.<br><code>ExportRangeToCsv(rng, fullPath)</code> — CSV exporter (UTF-8 BOM) + atomic move.<br><code>CreateObjectSafe(progId)</code> — safe COM factory with negative caching TTL.<br><code>IsADODBStreamAvailable</code>, <code>GetADODBStream</code>, <code>IsCertutilAvailable</code>, <code>ComputeFileSHA256_Certutil</code> — environment probes & helpers.<br><code>RetryWithBackoffByName</code>, <code>SleepMs</code>, <code>WaitWithJitter</code> — retry utilities.<br><code>UtilitiesSelfTest</code>, <code>DuplicateUtilitiesAudit</code>, <code>BenchmarkSafeWriteRange</code>, <code>RunVerificationChecklist</code>, <code>GenerateVerificationReport</code> — diagnostics / CI helpers. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Configuration / constants</strong><br><code>TEMP_PREFIX = &quot;ifrs_util_&quot;</code>.<br><code>MAX_ATOMIC_ATTEMPTS = 5</code>.<br><code>DEFAULT_NAMEDRANGE_CACHE_MAX = 300</code>.<br><code>g_comNegativeCacheTTL</code> default = 600 seconds (configurable via <code>SetComNegativeCacheTTL</code>).<br><code>g_verboseAtomicDiagnostics</code> (Public) — when true, <code>AtomicWriteFile</code> emits structured JSON diagnostics to audit.<br><code>g_allowScriptletTypeLib</code> (Public, default False) — when True enables Scriptlet.TypeLib GUID generation for temp names (security-sensitive). </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Named-range cache behavior</strong><br>Per-workbook fingerprint key: <code>WorkbookFingerprint(wb) | rangeName</code>. Cache stores <code>(value, timestamp)</code>to implement LRU eviction. Size limited by<code>g_namedRangeCacheMaxSize</code>; <code>EnforceNamedRangeCacheLimit</code>evicts least-recently-used. Call<code>InvalidateNamedRangeCacheForWorkbook</code> on save/close to avoid stale entries. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>CreateObjectSafe (COM negative caching)</strong><br>Small <code>g_comCache</code> stores <code>{available As Boolean, lastFailTime, lastErrNum, category}</code>. If a ProgID previously failed and negative TTL not expired, <code>CreateObjectSafe</code> returns <code>Nothing</code> immediately. Positive entries are periodically revalidated; failures update negative cache. Use <code>SetComNegativeCacheTTL(seconds)</code> to tune. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>ADODB usage & fallbacks</strong><br>Where possible module uses <code>ADODB.Stream</code> for correct UTF-8 encoding/decoding and binary handling (<code>IsADODBStreamAvailable</code> probe). If ADODB not available, code falls back to binary or ANSI IO paths (<code>WriteToFileBinary</code>, native <code>Open ... For Binary</code>). Functions remain functional but may lose BOM/UTF-8 guarantees in those environments. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>AtomicWriteFile semantics</strong><br>Writes content to a temp file in the target folder (or discovered temp folder), attempts <code>Name tmp As target</code> (atomic rename). If rename fails, falls back to FSO <code>CopyFile</code> + delete. Retries up to <code>MAX_ATOMIC_ATTEMPTS</code> with exponential backoff + jitter. If ADODB available, writes BOM + UTF-8 bytes; supports both text and binary <code>content</code> (binary as byte array). On errors stores diagnostics in <code>g_lastAtomicWriteErr</code> and <code>g_lastAtomicWriteDiag</code>. When <code>g_verboseAtomicDiagnostics</code> is True, emits a structured audit entry including optional SHA256 (via <code>ComputeFileSHA256_Certutil</code> if available). </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>AtomicSaveWorkbookAs semantics</strong><br>Makes a local <code>SaveCopyAs</code> (or <code>SaveAs</code> fallback) to a temporary <code>.xlsx</code>, then atomically replaces destination using <code>Scripting.FileSystemObject</code> copy/delete loop with retries. Returns Boolean; sets <code>g_lastAtomicSaveErr</code> on failure and emits audit. Error codes mapped to <code>UTIL_ERROR_BASE</code> offsets. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>ExportRangeToCsv behavior</strong><br>Generates CSV RFC4180-safe escaping. If ADODB available writes UTF-8 with BOM using row-by-row temporary text stream conversion to binary stream (keeps memory usage moderate). Otherwise writes incremental ANSI via native <code>Open/Print</code>. After writing a tmp CSV, calls <code>AtomicWriteFileMove</code> to rename/copy atomically to destination. Emits <code>ExportAudit</code> entries on success/failure. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>StreamImportCsvLines behavior</strong><br>Preferred path: ADODB binary → set <code>Charset=&quot;utf-8&quot;</code> → <code>ReadText</code> → normalize line endings → iterate lines and call user <code>lineHandlerName</code> via <code>Application.Run</code>. Handles UTF-8 BOM removal and logs handler errors per-line rather than stopping. Fallback path uses native <code>Line Input</code> with BOM detection and same per-line handler invocation. Safe in large file contexts but processes whole file as text in ADODB path (careful for extremely large files). </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>CSV/Line handler contract</strong><br><code>lineHandlerName</code> is an <code>Application.Run</code> target accepting a single string argument. Handler exceptions are caught and logged; <code>StreamImportCsvLines</code> continues with next line. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Diagnostics & observability</strong><br><code>g_lastAtomicWriteErr</code> (Long) and <code>g_lastAtomicWriteDiag</code> (String) track last atomic write status. <code>g_lastAtomicSaveErr</code> for workbook saves. <code>UtilitiesSelfTest</code> logs results to audit; <code>RunVerificationChecklist</code> writes a JSON artifact via <code>AtomicWriteFile</code>. <code>DuplicateUtilitiesAudit</code> inspects VBProject for duplicate helper names and returns findings (will gracefully degrade when VBProject access is disabled). </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Safety & security considerations</strong><br>- <code>g_allowScriptletTypeLib</code> must be enabled only after security review (Scriptlet.TypeLib exposes GUID generation).<br>- <code>CreateObjectSafe</code> caches negative outcomes to reduce harmful repeated COM instantiation in hostile/locked-down hosts.<br>- <code>SafeLogAudit</code> delegates to <code>modAudit.LogAudit</code> only and purposely does not implement local fallbacks to avoid duplication/escape of sensitive audit flows.<br>- <code>g_allowCommandExecution</code> not present here; avoid enabling system command usage unless reviewed. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Error codes mapping (high level)</strong><br><code>UTIL_ERROR_BASE + 1</code> = <code>SafeCreateSheet</code> no workbook; <code>+2</code> = <code>BackupSheet</code> no temp path; <code>+10</code> = <code>AtomicWriteFile</code> generic; <code>+11</code> = <code>AtomicWriteFile</code> no writable folder; <code>+20..+23</code> = <code>AtomicSaveWorkbookAs</code> variants; <code>+30</code> = <code>AtomicWriteFileMove</code> move failed; <code>+31..+32</code> = <code>ExportRangeToCsv</code> errors. Modules should surface these codes via <code>SafeHandleError</code> when appropriate. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Retries & backoff strategy</strong><br>Exponential backoff with base 100ms and jitter up to 20% (<code>WaitWithJitter</code>). <code>MAX_ATOMIC_ATTEMPTS=5</code> by default. <code>RetryWithBackoffByName</code> is generic helper for invoking host macros with retries; it accepts a function name and optional args array. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Temp folder resolution & path normalization</strong><br><code>GetTempFolder</code> precedence: WScript env vars (<code>%TMP%</code>/<code>%TEMP%</code>) → POSIX env vars (<code>TMPDIR</code>, <code>HOME</code>) → <code>Application.DefaultFilePath</code> → workbook path → macOS AppleScript fallback. <code>EnsureFolderPathEndsWith</code> normalizes separators for the host OS. <code>ExpandTildePath</code> expands <code>~</code> using <code>$HOME</code> or <code>%USERPROFILE%</code>. Use <code>IsPathWritableEx</code> for diagnostic writable checks. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Self-test & CI helpers</strong><br><code>UtilitiesSelfTest</code> performs idempotent checks (parsing, atomic write, named-range cache, CreateObjectSafe negative cache probe, SafeWriteRange, ExportRangeToCsv) and logs outcomes. <code>RunVerificationChecklist(outputFile)</code> runs repeated self-tests, collects diagnostics and writes a JSON artifact atomically. <code>GenerateVerificationReport</code> returns a JSON string (no file write). Use these in CI to detect regressions. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Duplicate helpers detection</strong><br><code>DuplicateUtilitiesAudit</code> scans <code>ThisWorkbook.VBProject</code> for certain helper names and reports occurrences. It will return a friendly message when VBProject access is blocked (trust setting), so include it in CI but expect it to be a non-fatal diagnostic. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Best practices / recommended usage</strong><br>- Call <code>EnsureCaches</code> at add-in/workbook startup and <code>ResetCaches</code> on serious errors.<br>- Use <code>AtomicWriteFile</code> / <code>AtomicSaveWorkbookAs</code> for exports and critical artifacts to avoid partial writes.<br>- Use <code>SafeWriteRange</code> / <code>SafeReadRange</code> for bulk range IO to minimize COM calls.<br>- Run <code>VerifyAuditChain</code> (from <code>modAudit</code>) and <code>RunVerificationChecklist</code> as part of CI and periodic monitoring. Log results to centralized storage. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Operational troubleshooting checklist</strong><br>1. Unexpected <code>AtomicWriteFile</code> failure: inspect <code>GetLastAtomicWriteDiagnostic()</code> and <code>g_lastAtomicWriteErr</code>; check folder permissions and <code>IsPathWritableEx</code> reason.<br>2. Exports appear ANSI/mis-encoded: verify <code>IsADODBStreamAvailable</code> and ADODB availability on host.<br>3. CreateObject failures: check <code>g_comCache</code> entries and negative cache TTL; call <code>ResetCaches</code> to force retry during troubleshooting.<br>4. Missing audit entries from <code>SafeLogAudit</code>: ensure <code>modAudit</code> is present and <code>Application.Run &quot;modAudit.LogAudit&quot;</code> is callable in host.<br>5. Duplicate helper warnings: run <code>DuplicateUtilitiesAudit</code> and reconcile duplicate routines across workbooks/add-ins. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Limitations & known behaviors</strong><br>• Extremely large files read via ADODB path load full text into memory (<code>StreamImportCsvLines</code>) — consider streaming chunked handlers for multi-GB files.<br>• UTF-8 correctness depends on ADODB availability; non-ADODB fallback may produce ANSI-encoded outputs.<br>• <code>DuplicateUtilitiesAudit</code> relies on VBProject access; hosts may block it. <br>• <code>AtomicWriteFile</code> uses <code>Name</code> for atomic rename which may fail across volumes; fallback uses copy/delete with retries. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Examples (usage snippets)</strong><br><code>If Not AtomicWriteFile(path, text) Then SafeHandleError &quot;Save&quot;, GetLastAtomicWriteError(), GetLastAtomicWriteDiagnostic()</code><br><code>SetNamedRangeValue &quot;_cfg_debug&quot;, True</code> and later <code>InvalidateNamedRangeCacheForWorkbook</code> from workbook save handler.<br><code>StreamImportCsvLines csvPath, &quot;MyLineHandler&quot;</code> where <code>MyLineHandler(line As String)</code> is a public macro. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Maintenance & tuning</strong><br>- Increase <code>g_namedRangeCacheMaxSize</code> for heavy named-range workloads; call <code>EnforceNamedRangeCacheLimit</code> is automatic.<br>- Lower <code>g_comNegativeCacheTTL</code> during active troubleshooting to allow repeated COM instantiation attempts.<br>- Enable <code>g_verboseAtomicDiagnostics</code> temporarily to capture SHA256 checksums and richer audit traces; be mindful of sensitive path disclosure in audit payloads. </td></tr><tr><td data-label="Technical User Guide — modUtilities"> <strong>Appendix: quick reference — where to look in code</strong><br><code>AtomicWriteFile</code> (primary atomic writer): top-level; <code>WriteToFileBinary</code> (fallback writer); <code>ComputeFileSHA256_Certutil</code> (optional checksum); <code>ExportRangeToCsv</code> → <code>AtomicWriteFileMove</code>; <code>StreamImportCsvLines</code> (CSV import); <code>CreateObjectSafe</code> (COM factory); <code>UtilitiesSelfTest</code>, <code>RunVerificationChecklist</code>, <code>GenerateVerificationReport</code> (diagnostics). </td></tr></tbody></table></div><div class="row-count">Rows: 24</div></div><div class="table-caption" id="Table17" data-table="Docu_0158_17" style="margin-top:2mm;margin-left:3mm;"><strong>Table 17</strong></div>
<div class="table-wrapper" data-table-id="table-17"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical breakdown (modAudit)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical breakdown (modAudit)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical breakdown (modAudit)"> <strong>Overview:</strong> Production-ready, append-only audit module for an Excel Add-in implemented in VBA. Goals: tamper-evident chain of rows, UTC ISO8601 timestamps, deterministic bulk/batched writes, pluggable hash provider (macro / certutil SHA256 / CRC32 fallback), buffered writes with atomic Range assignment, safe rotation/export, PII-light redaction, meta-sheet observability, and a backwards-compatible public API. Row schema (cols 1..12): <code>TimestampUTC | CorrelationID | Module | Procedure | Severity | ErrNum | WindowsUser | ExcelUser | Action | ContextJSON | PrevHash | Hash</code>. Canonical payload for hashing: <code>PrevHash | TimestampUTC | CorrelationID | Module | Procedure | Severity | ErrNum | WindowsUser | ExcelUser | Action | ContextJSON</code> (UTF-8). Public API (stable signatures): <code>InitAuditModule</code>, <code>ShutdownAuditModule</code>, <code>LogAudit</code>, <code>AppendAuditEntry</code>, <code>AppendAuditBuffered</code>, <code>FlushAuditBuffer</code>, <code>RotateAuditNow</code>, <code>ExportAuditToCSV</code>, <code>ExportAuditToJSON</code>, <code>VerifyAuditChain</code>, <code>GenerateAuditDiagnosticReport</code>, <code>FindAuditByCorrelationID</code>, <code>ReadAuditRow</code>, <code>CreateAuditSheetIfMissing</code>, <code>SetAuditFeatureFlag</code>, <code>GetAuditFeatureFlag</code>, plus <code>HashProviderMacroName</code> injection point. Use this table as authoritative inline documentation; tests and invariants are listed per-function. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>InitAuditModule</strong> — <em>initialize runtime state and meta-sheet</em><br><strong>Purpose:</strong> Initialize module-level state (buffer, locks, flags), ensure meta-sheet if enabled, record an init observation in the buffer. Designed to be idempotent and safe to call multiple times.<br><strong>Signature:</strong> <code>Public Sub InitAuditModule()</code><br><strong>Behavior:</strong> If already initialized, exits. Allocates <code>g_auditBuffer</code> (Collection), sets <code>g_batchWriteLock=False</code>, records <code>g_lastHashProviderUsed = &quot;&quot;</code>, sets <code>g_auditInitialized=True</code>. Calls <code>CreateAuditMetaSheetIfMissing</code> if <code>g_enableMetaSheet</code>. Appends an <code>AuditInit</code> buffered entry with a newly-created correlation id via <code>AppendAuditBuffered Entry_Row(...)</code>.<br><strong>Complexity:</strong> O(1).<br><strong>Side-effects:</strong> Creates meta-sheet (very-hidden) if enabled; adds one buffered entry; may set workbook state (hidden worksheet).<br><strong>Invariants:</strong> After return, <code>g_auditInitialized=True</code> and <code>g_auditBuffer</code> is non-Null. Idempotent: multiple calls harmless.<br><strong>Failure modes:</strong> Errors suppressed with <code>On Error Resume Next</code>; failure to create sheets means module still marks initialized and may log fallback entries. Caller should check <code>CreateAuditSheetIfMissing</code> returns a worksheet if they need it.<br><strong>Security/Privacy:</strong> None beyond existing module behaviors. Initialization entry contains no sensitive payload.<br><strong>Recommended tests:</strong> Call twice to verify idempotence; validate meta-sheet created when flag enabled; ensure a buffered <code>AuditInit</code> row is produced on flush. <br><strong>Notes:</strong> Must be called before any buffered append; public API methods auto-call if not initialized. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>ShutdownAuditModule</strong> — <em>flush and clean shutdown</em><br><strong>Purpose:</strong> Gracefully flush buffer, append shutdown observability, clear resources and update meta-sheet.<br><strong>Signature:</strong> <code>Public Sub ShutdownAuditModule()</code><br><strong>Behavior:</strong> Appends <code>AuditShutdown</code> buffered row, calls <code>FlushAuditBuffer</code>, sets <code>g_auditBuffer = Nothing</code>, resets locks and flags, writes final meta-sheet state with <code>UpdateAuditMetaSheet</code> if enabled.<br><strong>Complexity:</strong> O(n) where n is buffered entries (due to <code>FlushAuditBuffer</code>).<br><strong>Side-effects:</strong> Persists buffered entries to worksheet; updates meta sheet; may perform per-row writes in fallback. <br><strong>Invariants:</strong> After call, <code>g_auditInitialized=False</code>, buffer cleared or persisted. <br><strong>Failure modes:</strong> If <code>FlushAuditBuffer</code> fails, <code>ShutdownAuditModule</code> will attempt per-row fallback (see <code>FlushAuditBuffer</code> behavior). Errors are swallowed with best-effort persistence logged. <br><strong>Recommended tests:</strong> Ensure buffered entries are persisted after shutdown; simulate bulk write failure (force by mocking Range assignment) and verify fallback per-row writes recorded. <br><strong>Notes:</strong> Safe to call during application closing; caller should not assume synchronous disk visibility beyond workbook state. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>SetAuditFeatureFlag / GetAuditFeatureFlag</strong> — <em>runtime feature flags</em><br><strong>Purpose:</strong> Toggle runtime flags <code>EnableMetaSheet</code> and <code>AggressiveRedaction</code> and persist unknown flags to meta-sheet for visibility. Provide read access to flags.<br><strong>Signature:</strong> <code>Public Sub SetAuditFeatureFlag(ByVal flagName As String, ByVal flagValue As Boolean)</code> / <code>Public Function GetAuditFeatureFlag(ByVal flagName As String) As Variant</code><br><strong>Behavior:</strong> Recognizes <code>&quot;EnableMetaSheet&quot;</code> and <code>&quot;AggressiveRedaction&quot;</code> (case-insensitive). When enabling meta-sheet, creates meta sheet. Unknown flags are appended to the meta-sheet (if enabled) as rows for auditing. <code>GetAuditFeatureFlag</code> returns current in-memory value or <code>Empty</code> for unknown flags.<br><strong>Complexity:</strong> O(1) (except writing a row to meta-sheet O(1) per append).<br><strong>Side-effects:</strong> May create/update meta sheet and write a new row for unknown flags. Updates in-memory flag values only; not persisted elsewhere unless consumer writes meta-sheet to file or inspects it.<br><strong>Invariants:</strong> Flags live in module-level variables; meta-sheet mirrors them when enabled. <br><strong>Failure modes:</strong> IO errors when writing meta-sheet are swallowed; unknown-flag persistence may fail silently. <br><strong>Recommended tests:</strong> Toggle both supported flags, verify <code>GetAuditFeatureFlag</code> returns expected values, and that meta-sheet entries appear for unknown flags. <br><strong>Notes:</strong> Feature flags are intentionally only runtime; persistent feature storage not implemented by default. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>LogAudit</strong> — <em>compatibility logger (simple API)</em><br><strong>Purpose:</strong> Backwards-compatible convenience wrapper that generates a correlation id and appends a buffered entry (preserves older call-sites). Provides synchronous fallback on error.<br><strong>Signature:</strong> <code>Public Sub LogAudit(ByVal action As String, ByVal details As String)</code><br><strong>Behavior:</strong> Ensures module initialized; creates a correlation id; calls <code>AppendAuditBuffered Entry_Row(action, details, corr)</code>. On error, falls back to synchronous <code>AppendAuditEntry</code> to avoid data loss (keeps backwards-compatibility with callers expecting immediate logging).<br><strong>Complexity:</strong> O(1) amortized. <br><strong>Side-effects:</strong> Adds buffered entry. On severe errors, writes a synchronous fallback row. <br><strong>Invariants:</strong> Does not throw; always best-effort logs. <br><strong>Failure modes:</strong> If initialization or buffer creation fails, fallback may still write minimal failure row. <br><strong>Tests:</strong> Call with normal inputs; simulate <code>g_auditInitialized=False</code>; simulate error inside <code>AppendAuditBuffered</code> to validate fallback synchronous write. <br><strong>Notes:</strong> Signature intentionally minimal to preserve old integrations. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>CreateAuditSheetIfMissing</strong> — <em>create stable audit worksheet</em><br><strong>Purpose:</strong> Ensure <code>_IFRS_Audit</code> worksheet exists and has canonical header row. Returns the worksheet object or <code>Nothing</code> on failure.<br><strong>Signature:</strong> <code>Public Function CreateAuditSheetIfMissing() As Worksheet</code><br><strong>Behavior:</strong> Searches workbook sheets by name (case-insensitive). If not found, adds a new worksheet at the end, names it <code>_IFRS_Audit</code> (best-effort), writes header columns 1..12 (TimestampUTC ... Hash), bolds header, sets sheet to <code>xlSheetVeryHidden</code>. Returns the worksheet reference. Catches errors and returns <code>Nothing</code> on failure. <br><strong>Complexity:</strong> O(sheets). <br><strong>Side-effects:</strong> Adds a worksheet and sets visibility. <br><strong>Invariants:</strong> Created sheet contains canonical header row in row 1. <br><strong>Failure modes:</strong> Naming collision, workbook protections, or restricted macro permissions may prevent creation. Returns <code>Nothing</code> to callers, which must handle it. <br><strong>Security:</strong> Being <code>VeryHidden</code> prevents casual user edits but does not prevent malicious tampering. <br><strong>Tests:</strong> Remove <code>_IFRS_Audit</code> and call function; verify header correctness, sheet visibility, and that subsequent calls return same sheet. Test behavior under workbook-protection and when adding sheets is disallowed. <br><strong>Notes:</strong> Keep sheet name stable; changing it breaks external tools and exports. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>AppendAuditEntry</strong> — <em>synchronous single-row append (back-compat)</em><br><strong>Purpose:</strong> Immediate append to audit worksheet for callers that require synchronous persistence. Performs redaction and computes hash for new row, updates PrevHash and Hash columns, and triggers rotation when threshold crossed.<br><strong>Signature:</strong> <code>Public Sub AppendAuditEntry(ByVal action As String, ByVal details As String, Optional ByVal moduleName As String = &quot;&quot;, Optional ByVal procName As String = &quot;&quot;, Optional ByVal severity As String = &quot;Info&quot;, Optional ByVal errNum As Long = 0, Optional ByVal correlationID As String = &quot;&quot;, Optional ByVal contextJson As String = &quot;&quot;)</code><br><strong>Behavior (detailed):</strong> Ensures audit sheet; fills defaults (correlation id, module/proc names). Redacts <code>contextJson</code> via <code>RedactSensitiveData</code>, truncates if over <code>MAX_CONTEXT_LENGTH</code> and emits a <code>ContextTruncated</code> buffered entry. Captures <code>prevHash</code> via <code>GetLastAuditHash(ws)</code>, builds canonical <code>rowData</code> string, calculates <code>entryHash</code> via <code>ComputeEntryHash(prevHash, rowData)</code>. Writes all 12 columns into nextRow using cell-by-cell assignments (synchronous). Sets sheet VeryHidden and calls <code>RotateAuditNow</code> if threshold reached. Updates meta-sheet if enabled. Error handler writes fallback minimal row describing logging failure. <br><strong>Complexity:</strong> O(1) per row write; hash computation cost depends on provider (certutil external process or CRC32 loop). <br><strong>Side-effects:</strong> Immediate worksheet modification; calls external tools for SHA256 (proc execution), modifies meta-sheet. <br><strong>Invariants:</strong> After a successful call, the appended row's PrevHash equals previous last row's Hash; the new row Hash equals <code>ComputeEntryHash(prevHash,rowData)</code>. <br><strong>Failure modes:</strong> File/worksheet locked, workbook protection, or certutil failures. Error handler attempts best-effort minimal failure logging. Race conditions possible if multiple threads/processes write concurrently (VBA single-threaded in-process mitigates some risks but external Excel automation could race). <br><strong>Security:</strong> <code>contextJson</code> is redacted; writes use <code>text</code> cells only. <br><strong>Recommended tests:</strong> Append with large context (>MAX_CONTEXT_LENGTH) and verify truncation and redaction entries; simulate certutil missing to observe CRC32 fallback; verify PrevHash/Hash chain property across multiple appends. <br><strong>Notes:</strong> This function must remain stable for backward compatibility with older callers expecting synchronous persistence. Consider locking at higher level when used concurrently by external automation. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>EnsureBuffer / Entry_Row</strong> — <em>buffer helpers & canonical buffered entry creation</em><br><strong>Purpose:</strong> <code>EnsureBuffer</code> lazily allocates <code>g_auditBuffer</code>. <code>Entry_Row</code> creates a canonical 10-element array representing a buffered row (columns subset) with redaction applied and defensive truncation; used by buffered API.<br><strong>Signatures:</strong> <code>Private Sub EnsureBuffer()</code> / <code>Private Function Entry_Row(ByVal action As String, ByVal details As String, ByVal corrId As String) As Variant</code><br><strong>Behavior:</strong> <code>EnsureBuffer</code> checks <code>g_auditBuffer</code> and instantiates a new <code>Collection</code> if <code>Nothing</code>. <code>Entry_Row</code> fills a 1..10 variant array with timestamp, correlation id, default module/proc/severity, user names, action, and redacted/truncated context. If redaction changed input content, it emits a buffered <code>RedactionApplied</code> entry (recursive but safe because the entry emitted is itself an <code>Entry_Row</code> of a short note). <br><strong>Complexity:</strong> O(len(details)) for redaction regexes. <br><strong>Side-effects:</strong> May recursively append small audit entries describing redaction. <br><strong>Failure modes:</strong> Over-recursion risk if <code>Entry_Row</code> keeps finding differences — mitigated because redaction produces stable shorter strings; but if redaction function misbehaves it could loop. <br><strong>Tests:</strong> Create entries that trigger <code>RedactionApplied</code> and <code>ContextTruncated</code> to ensure recursion depth is limited and the resultant buffer contains both the original event and the redaction notice. <br><strong>Notes:</strong> Keep the array layout stable — buffered code depends on fixed indexes. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>AppendAuditBuffered</strong> — <em>add an entry to in-memory buffer</em><br><strong>Purpose:</strong> Add pre-built entry arrays (from <code>Entry_Row</code>) into <code>g_auditBuffer</code> and trigger <code>FlushAuditBuffer</code> when threshold reached; update meta-sheet observability.<br><strong>Signature:</strong> <code>Public Sub AppendAuditBuffered(entry As Variant)</code><br><strong>Behavior:</strong> Ensures module initialized, ensures buffer exists, adds <code>entry</code> to <code>g_auditBuffer</code>, updates meta-sheet if enabled, and if buffered count >= <code>AUDIT_BATCH_FLUSH_THRESHOLD</code> calls <code>FlushAuditBuffer</code>. Error handler falls back to synchronous <code>AppendAuditEntry</code> for the entry to avoid silent loss.<br><strong>Complexity:</strong> O(1) per append + potential flush cost. <br><strong>Side-effects:</strong> May trigger <code>FlushAuditBuffer</code>. <br><strong>Failure modes:</strong> If buffer allocation fails, fallback per-row append is attempted. <br><strong>Tests:</strong> Append <code>AUDIT_BATCH_FLUSH_THRESHOLD</code> items and verify <code>FlushAuditBuffer</code> runs and buffer cleared. Test fallback by forcing an error (e.g., by making <code>CreateAuditSheetIfMissing</code> return Nothing). <br><strong>Notes:</strong> Buffer contains arrays with positions tied to <code>FlushAuditBuffer</code> ordering. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>FlushAuditBuffer</strong> — <em>deterministic bulk write with fallback per-row</em><br><strong>Purpose:</strong> Atomically persist buffered entries into the audit worksheet with a single <code>Range.Value</code> assignment where possible; compute chained hashes deterministically; preserve buffer on failure via safe per-row fallback; provide observability entries for start/finish/fallback.<br><strong>Signature:</strong> <code>Public Sub FlushAuditBuffer()</code><br><strong>Behavior (detailed):</strong> No-op if buffer empty. Idempotent guard via <code>g_batchWriteLock</code>. Appends a <code>FlushStart</code> buffered observation, obtains worksheet, computes <code>startRow</code>, pre-allocates a 2D <code>outArr(1 To n,1 To 12)</code> and iterates buffered entries computing rowData and each row's hash using <code>ComputeEntryHash(prevHash,rowData)</code>. Writes the whole <code>outArr</code> at once to <code>ws.Cells(startRow,1).Resize(n,12).Value</code>. On success, appends <code>FlushFinish</code> buffered observation, replaces buffer with new Collection, updates meta-sheet and triggers rotation if needed. On error, falls back to iterating buffered entries and calling <code>AppendAuditEntry</code> per entry (idempotent but slower), emits <code>FlushFallback</code> buffered observation and clears buffer. Locks released at end. Error handler also emits <code>FlushFallback</code> detail and clears buffer. <br><strong>Complexity:</strong> O(n + cost of hash per entry). Bulk write reduces round-trips to Excel COM from O(n) to 1. Fallback is O(n * COM writes). <br><strong>Side-effects:</strong> May execute external certutil commands during hash computation when provider is SHA256 (expensive); modifies worksheet and meta-sheet; may write many cells at once. <br><strong>Invariants:</strong> On success, the worksheet rows from <code>startRow..startRow+n-1</code> contain PrevHash/Hash chain consistent with <code>ComputeEntryHash</code>. Buffer cleared only after successful write or after safe per-row fallback. <br><strong>Failure modes:</strong> COM Range.Write failure (e.g., protected workbook) triggers fallback; external certutil may block or fail; long-running certutil calls may cause UI hang (function uses Exec + DoEvents). On fallback, if per-row writes fail, error handler attempts to log the write failure to the sheet. <br><strong>Security:</strong> Uses only text writes; context redaction already applied. <br><strong>Recommended tests:</strong> Stress tests with n >> threshold; simulate Range.Value failure to exercise fallback loop; test concurrent calls (should be serialized by the lock). Also validate correct PrevHash chaining for batch writes and after fallback. <br><strong>Notes:</strong> Bulk Range assignment is crucial for performance; keep <code>AUDIT_BATCH_FLUSH_THRESHOLD</code> tuned. Consider additional locking across processes if external automation might write concurrently. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>RotateAuditNow</strong> — <em>archive then truncate primary audit sheet</em><br><strong>Purpose:</strong> Archive the current <code>_IFRS_Audit</code> content to CSV in a chosen folder (configurable) and delete archived rows from the live sheet to reset the audit ledger; emit rotation observability entries.<br><strong>Signature:</strong> <code>Public Sub RotateAuditNow()</code><br><strong>Behavior:</strong> Computes archive folder using <code>AUDIT_ARCHIVE_FOLDER</code>, <code>TEMP</code>, workbook path, or user profile as fallback. Creates folder if missing (FSO), builds filename <code>IFRS_Audit_Archive_&lt;utcnow&gt;.csv</code>. Creates a temporary workbook, copies <code>ws.UsedRange</code> and pastes values into <code>tmpWB</code>, saves as CSV to <code>fname</code> via <code>tmpWB.SaveAs</code> (csv format). On success, deletes rows 2..lastRow from main sheet (preserving header), appends <code>RotateFinish</code> with archive path and rows archived. On Save failure, attempts fallback save in TEMP and records <code>RotateFallback</code>. Errors emit <code>AuditRotateError</code>. <br><strong>Complexity:</strong> O(#rows archived) for copy & delete. <br><strong>Side-effects:</strong> Writes file to disk, deletes rows from audit sheet (destructive operation), creates tmp workbooks. <br><strong>Invariants:</strong> After successful rotation, live audit sheet contains only header row and new writes start from row 2. <br><strong>Failure modes:</strong> Unable to save CSV due to permissions; <code>SaveAs</code> may fail on non-writable paths. Delete of rows may fail if sheet or workbook protected. Robust error handling attempts fallback and logs. <br><strong>Security:</strong> Archive files contain the full audit contents including redacted contexts; ensure file storage is secure. <br><strong>Recommended tests:</strong> Rotate with small and large row counts; test failure path by pointing archive folder to unwritable location; validate deletion only occurs after successful save. <br><strong>Notes:</strong> Rotation is destructive — keep backups and consider incremental archival (e.g., append-mode) if required. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>ExportAuditToCSV / ExportAuditToJSON</strong> — <em>hard exports for off-line analysis</em><br><strong>Purpose:</strong> Export full audit sheet to CSV or JSON at specified path for external analysis or ingestion.<br><strong>Signatures:</strong> <code>Public Function ExportAuditToCSV(ByVal fullPath As String) As Boolean</code> / <code>Public Function ExportAuditToJSON(ByVal fullPath As String) As Boolean</code><br><strong>Behavior (CSV):</strong> Copies <code>ws.UsedRange</code> into a temporary workbook and <code>SaveAs</code> CSV to <code>fullPath</code>. Creates folders if missing using FSO. Returns True on success; logs <code>ExportAuditError</code> on failure. <br><strong>Behavior (JSON):</strong> Reads <code>ws.UsedRange.Value</code> into a variant, iterates rows/cols to build JSON array of objects using header row as keys, writes JSON to <code>fullPath</code> via textual <code>Open For Binary</code> and <code>Put</code>. Returns True on success and logs <code>ExportAuditError</code> on exceptions. <br><strong>Complexity:</strong> O(rows * cols) to read and serialize. <br><strong>Side-effects:</strong> Creates file on disk. <br><strong>Failure modes:</strong> File system permissions, large datasets memory pressure when building JSON; note JSON builder builds a full string in memory. <br><strong>Security:</strong> JSON/CSV export preserves whatever is in the audit sheet (including contexts, albeit already redacted). Protect exported files appropriately. <br><strong>Tests:</strong> Export with no rows, with many rows, with special characters in cells (commas, quotes, newlines). Verify JSON structural correctness and escaping (tested via <code>EscapeJson</code>/<code>EscapeCsv</code>). <br><strong>Notes:</strong> For very large audit tables, consider streaming write rather than building the whole JSON string in memory. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>VerifyAuditChain</strong> — <em>verify PrevHash / Hash chain integrity</em><br><strong>Purpose:</strong> Validate that each row's <code>PrevHash</code> matches the reconstructed chain and that the computed hash equals stored <code>Hash</code>. Returns boolean and optionally reports first bad row and diagnostic code (0 OK, 1 MissingPrevHash, 2 HashMismatch, 3 Malformed/Other).<br><strong>Signature:</strong> <code>Public Function VerifyAuditChain(Optional ByRef firstBadRow As Long, Optional ByRef diagnosticCode As Long) As Boolean</code><br><strong>Behavior:</strong> Loads <code>ws.UsedRange</code> into array <code>data</code>. Iterates rows 2..rows and for each builds canonical <code>rowData</code> from columns 1..10, checks stored PrevHash equals <code>prevHash</code> (empty for first row), computes <code>expectedHash = ComputeEntryHash(prevHash,rowData)</code>, compares <code>expectedHash</code> to stored hash col 12, and updates <code>prevHash = expectedHash</code>. On mismatch sets output params and returns False. Returns True if all rows OK. Errors set diagnosticCode=3 and False. <br><strong>Complexity:</strong> O(rows * hashCost). Hash cost dominated by provider. <br><strong>Side-effects:</strong> None (read-only). <br><strong>Failure modes:</strong> Malformed rows, missing expected columns, or inability to compute hash (hash provider failures will cause mismatch). <br><strong>Security:</strong> Useful for tamper detection. However, verification depends on same <code>ComputeEntryHash</code> implementation — if provider behavior differs (macro provider returns different canonicalization) false positives may occur. <br><strong>Recommended tests:</strong> Tamper a single row PrevHash or Hash and verify the returned firstBadRow and diagnosticCode. Test with different hash providers and ensure consistent canonical payload encoding (UTF-8). <br><strong>Notes:</strong> Consider exposing an option to supply a deterministic hash provider for verification (e.g., an in-module pure-VBA fallback consistent with CRC32 path). </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>GenerateAuditDiagnosticReport</strong> — <em>row-level diagnostic CSV</em><br><strong>Purpose:</strong> Produce a CSV summarising expected vs actual prev/hash for each row offering a forensic export for auditors; suitable for bulk analysis outside Excel.<br><strong>Signature:</strong> <code>Public Function GenerateAuditDiagnosticReport(ByVal outputCsvPath As String, Optional ByVal startRow As Long = 2) As Boolean</code><br><strong>Behavior:</strong> Opens <code>outputCsvPath</code> for binary write, writes header, iterates rows <code>startRow..lastRow</code>, recomputes expected prev/hash via <code>ComputeEntryHash</code>, writes CSV lines <code>Row,ExpectedPrev,ActualPrev,ExpectedHash,ActualHash,Reason</code>. Returns True on success or False and logs an <code>ExportAuditError</code>. <br><strong>Complexity:</strong> O(rows * hashCost). <br><strong>Side-effects:</strong> Writes file to disk. <br><strong>Failure modes:</strong> File I/O errors. <br><strong>Recommended tests:</strong> Generate report on a valid sheet; validate CSV fields contain expected values for both OK and deliberately tampered rows. <br><strong>Notes:</strong> CSV contains full hash values — treat as sensitive output. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>FindAuditByCorrelationID</strong> — <em>lookup helper</em><br><strong>Purpose:</strong> Find the first row where column B (CorrelationID) equals provided id and return row number; returns 0 if not found.<br><strong>Signature:</strong> <code>Public Function FindAuditByCorrelationID(ByVal corrId As String) As Long</code><br><strong>Behavior:</strong> Uses <code>ws.Range(&quot;B:B&quot;).Find(what:=corrId, LookIn:=xlValues, LookAt:=xlWhole)</code>; returns <code>.Row</code> or 0 on not found. Handles errors returning 0. <br><strong>Complexity:</strong> Excel Find is optimized — expected O(1) average but worst-case O(rows). <br><strong>Side-effects:</strong> None. <br><strong>Failure modes:</strong> If sheet missing returns 0. <br><strong>Tests:</strong> Insert a row with known corrId and assert return row; search non-existent id returns 0. <br><strong>Notes:</strong> Find returns first match; if duplicates exist, consumer must handle multiples. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>ReadAuditRow</strong> — <em>read-back structured row</em><br><strong>Purpose:</strong> Return a <code>Scripting.Dictionary</code> object mapping column names to values for a requested sheet row. Useful for programmatic inspection or export by other modules.<br><strong>Signature:</strong> <code>Public Function ReadAuditRow(ByVal sheetRow As Long) As Object</code><br><strong>Behavior:</strong> Validates <code>sheetRow</code> in bounds, creates <code>Scripting.Dictionary</code>, populates keys <code>TimestampUTC, CorrelationID, Module, Procedure, Severity, ErrNum, WindowsUser, ExcelUser, Action, ContextJSON, PrevHash, Hash</code> from the row, and returns dictionary. Returns <code>Nothing</code> on invalid input or error. <br><strong>Complexity:</strong> O(1). <br><strong>Side-effects:</strong> None. <br><strong>Tests:</strong> Read a row and verify dictionary fields equal cells; invalid row returns <code>Nothing</code>. <br><strong>Notes:</strong> Caller must release COM objects if used extensively. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>GetLastAuditHash</strong> — <em>helper to fetch current chain tail</em><br><strong>Purpose:</strong> Return the hash value from the last audit row (col 12) or empty string if none. Used by append functions to compute <code>PrevHash</code> for the next row.<br><strong>Signature:</strong> <code>Private Function GetLastAuditHash(ws As Worksheet) As String</code><br><strong>Behavior:</strong> If ws omitted, resolves by calling <code>CreateAuditSheetIfMissing</code>. Determines <code>lastRow = ws.Cells(ws.Rows.Count,1).End(xlUp).Row</code>. If <code>lastRow &lt; 2</code> returns <code>&quot;&quot;</code> else returns <code>CStr(ws.Cells(lastRow,12).Value)</code>. <br><strong>Complexity:</strong> O(1). <br><strong>Failure modes:</strong> Sheet missing -> returns "". <br><strong>Notes:</strong> Small but central helper — any change to column layout affects this function. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>ComputeEntryHash</strong> — <em>hash provider orchestration (pluggable)</em><br><strong>Purpose:</strong> Produce the hash string for a canonical payload; tries injected macro provider first, then <code>certutil</code> SHA256, then CRC32 fallback. Emits <code>HashProviderUsed</code> buffered observation when a provider succeeds.<br><strong>Signature:</strong> <code>Private Function ComputeEntryHash(ByVal prevHash As String, ByVal rowData As String) As String</code><br><strong>Behavior:</strong> Constructs <code>payload = prevHash &amp; &quot;|&quot; &amp; rowData</code>. If <code>HashProviderMacroName</code> set, calls <code>Application.Run(HashProviderMacroName, payload)</code> and if non-empty, returns provider output. Else tries <code>ComputeSHA256_UsingCertUtil(payload)</code>; if returns value, uses it. Otherwise calls <code>ComputeCRC32String(payload)</code> (fast pure-VBA fallback) and returns 8-hex CRC string. Sets <code>g_lastHashProviderUsed</code> accordingly and records an observability buffered entry <code>HashProviderUsed</code> with provider name. <br><strong>Complexity:</strong> CRC32 O(len(bytes)); certutil path involves writing a file and blocking process execution; macro path complexity depends on user-provided macro.<br><strong>Side-effects:</strong> May call external process <code>certutil</code> and create/delete temp files; may call arbitrary public macro via <code>Application.Run</code> which could execute arbitrary workbook code (trust boundary). Appends <code>HashProviderUsed</code> entries to buffer. <br><strong>Invariants:</strong> Returned hash string must be stable for identical <code>payload</code> and provider. <br><strong>Failure modes:</strong> Macro provider may throw or be malicious; certutil may be unavailable (non-Windows or restricted); ADODB Stream may be absent; fallback ensures a non-empty hash is always returned (CRC32). <br><strong>Security:</strong> Macro provider is a trust boundary — if an external macro returns unpredictable values or blocks, the chain's security is reduced. <code>certutil</code> path is only available on Windows environments with certutil in PATH. <br><strong>Recommended tests:</strong> Replace <code>HashProviderMacroName</code> with test double macro to confirm invocation and fallbacks; run on non-Windows machine to enforce CRC32 fallback; test determinism across identical inputs. <br><strong>Notes:</strong> Encourage consumers to provide a cryptographic provider for production (HSM or signed macro) where regulatory compliance requires stronger hashing. The <code>certutil</code> exec uses <code>WScript.Shell.Exec</code> and <code>DoEvents</code> loop — this blocks the thread until completion; beware UI hangs for large payloads. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>ComputeSHA256_UsingCertUtil</strong> — <em>Windows certutil-based SHA256</em><br><strong>Purpose:</strong> Compute SHA256 by writing payload to a binary temp file and calling <code>certutil -hashfile &lt;file&gt; SHA256</code>, parsing stdout for the 64-hex digest. Designed as a higher-strength option when available.<br><strong>Signature:</strong> <code>Private Function ComputeSHA256_UsingCertUtil(ByVal s As String) As String</code><br><strong>Behavior:</strong> Determine temp path heuristically (<code>TEMP</code>, workbook path, or userprofile). Compose unique filename, write UTF-8 bytes from <code>StrToUtf8Bytes(s)</code> into file (Binary write). Create <code>WScript.Shell</code> and <code>Exec</code> <code>certutil -hashfile &quot;fname&quot; SHA256</code>. Poll <code>execObj.Status</code> in a <code>DoEvents</code> loop until complete. Read <code>StdOut.ReadAll</code>, kill temp file, parse lines for token with >=64 hex chars, return first 64-char token. On any error returns empty string and deletes tmp file when possible. <br><strong>Complexity:</strong> Dominated by external process runtime and I/O; writing payload to disk is O(len(s)). <br><strong>Side-effects:</strong> Creates temp file; executes external OS command; may block UI until finished. <br><strong>Failure modes:</strong> <code>WScript.Shell</code> unavailable (e.g., in locked-down environments), <code>certutil</code> absent, <code>Exec</code> returns Nothing, or parsing fails. In these cases returns <code>&quot;&quot;</code>. <br><strong>Security/Privacy:</strong> Payload written to disk in cleartext momentarily — treat temp dir carefully and use secure storage when required. Recommend secure temp storage and immediate deletion (module attempts to delete). <br><strong>Tests:</strong> Run on Windows with <code>certutil</code> present; test with varying payload sizes; verify deletion of temp file on normal and exceptional paths. <br><strong>Notes:</strong> Not portable to macOS/Linux. Use only when platform constraints are known. Consider adding an in-memory hashing provider via COM or PowerShell for better portability if required. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>ComputeCRC32String / CRC32Table</strong> — <em>pure-VBA CRC32 fallback</em><br><strong>Purpose:</strong> Deterministic CRC32 hex string fallback when no cryptographic provider is available. Ensures chain can still be computed and verified even in restricted environments.<br><strong>Signatures:</strong> <code>Private Function ComputeCRC32String(ByVal s As String) As String</code> / <code>Private Function CRC32Table() As Long()</code><br><strong>Behavior:</strong> <code>StrToUtf8Bytes</code> converts payload to bytes; CRC computed by standard table-driven algorithm; final value xor'ed and returned as 8-char hex uppercase. <code>CRC32Table</code> builds the 256-entry table. <br><strong>Complexity:</strong> O(len(bytes)). <br><strong>Security:</strong> CRC32 is non-cryptographic; vulnerable to collisions — suitable for tamper-evidence only when combined with environment protections or as last resort. Document this explicitly. <br><strong>Tests:</strong> Validate known vectors, ensure hex formatting <code>Right$(&quot;00000000&quot; &amp; Hex$(crc),8)</code>. <br><strong>Notes:</strong> Keep implementation deterministic across different VBA variants (use Long arithmetic carefully). Consider exposing function for offline verification when cryptographic hashing not required. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>StrToUtf8Bytes</strong> — <em>UTF-8 conversion helper</em><br><strong>Purpose:</strong> Return byte array of UTF-8 encoded string using ADODB.Stream when available; fallback to <code>StrConv</code> when not available.<br><strong>Signature:</strong> <code>Private Function StrToUtf8Bytes(ByVal s As String) As Byte()</code><br><strong>Behavior:</strong> Attempts to create <code>ADODB.Stream</code>, set <code>Type=2</code> (text), <code>Charset=&quot;utf-8&quot;</code>, write text, switch to binary and <code>Read</code> to return bytes. On failure returns <code>StrConv(s, vbFromUnicode)</code> (system code page bytes). <br><strong>Complexity:</strong> O(len(s)). <br><strong>Failure modes:</strong> <code>ADODB.Stream</code> may be unavailable causing fallback to non-UTF8 bytes; this can change hash semantics (UTF-8 vs system code page). <br><strong>Tests:</strong> Test round-trip expected UTF-8 bytes; verify that when ADODB available output length > 0 and matches expected UTF-8 sequences for non-ASCII. <br><strong>Notes:</strong> Hash canonicalization requires consistent UTF-8 encoding; where ADODB not available, document impact on cross-machine verification. Consider packaging a pure-VBA UTF-8 encoder for stricter determinism. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>GetUtcIsoTimestamp / UtcNowForFilename</strong> — <em>UTC timestamp helpers</em><br><strong>Purpose:</strong> Produce consistent ISO8601 UTC timestamps using <code>GetSystemTime</code> Win32 API when available; provide compact filename-safe UTC string too.<br><strong>Signatures:</strong> <code>Private Function GetUtcIsoTimestamp() As String</code> / <code>Private Function UtcNowForFilename() As String</code><br><strong>Behavior:</strong> <code>GetUtcIsoTimestamp</code> calls <code>GetSystemTime</code> (PtrSafe for VBA7) and formats <code>YYYY-MM-DDTHH:MM:SSZ</code>. Fallback uses <code>Now</code> local time formatted and appends <code>Z</code> (less accurate). <code>UtcNowForFilename</code> removes punctuation to create filename-safe string. <br><strong>Complexity:</strong> O(1). <br><strong>Failure modes:</strong> On non-Windows platforms <code>GetSystemTime</code> Windows API may be unavailable; function falls back to <code>Now</code>. <br><strong>Tests:</strong> Verify formatting and that <code>UtcNowForFilename</code> contains no colons or hyphens. <br><strong>Notes:</strong> For strict UTC correctness on non-Windows hosts, consider retrieving UTC via <code>CDate(Format(Now, ...)) - TimeZoneBias</code> if TimeZone known; current fallback is acceptable for many use cases but be explicit in docs. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>RedactSensitiveData</strong> — <em>PII-light redaction engine (regex heuristics)</em><br><strong>Purpose:</strong> Heuristic-based redaction of sensitive tokens (card numbers, SSNs, emails, long tokens, account numbers) from JSON-like text. Designed to be conservative and reduce PII risk before persisting contexts to audit storage or export.<br><strong>Signature:</strong> <code>Private Function RedactSensitiveData(ByVal inputJson As String) As String</code><br><strong>Behavior:</strong> If input empty returns immediately. Uses <code>VBScript.RegExp</code> with a series of global regex replacements: long contiguous digits (13-19) replaced by <code>[REDACTED_NUMBER]</code>, grouped card patterns, SSN patterns, account-number-like patterns, email addresses replaced with <code>[REDACTED_EMAIL]</code>, long token-like base64/hex strings replaced by <code>[REDACTED_TOKEN]</code>. If <code>g_aggressiveRedaction</code> enabled, applies more aggressive patterns for keys like <code>token|apikey|secret|password</code>. Truncates to <code>MAX_CONTEXT_LENGTH</code> if too long. Returns redacted string. <br><strong>Complexity:</strong> O(len(input)) times number of regex passes. <br><strong>Side-effects:</strong> None. <br><strong>Failure modes:</strong> Regex false-positives may redact non-sensitive content; false-negatives leave PII in logs. Regex engine variations across hosts may behave differently. <br><strong>Security:</strong> This is heuristic — do not rely on it for compliance-level masking. For highly sensitive environments, require strict schema-based redaction before logging (application-level). <br><strong>Recommended tests:</strong> Provide test corpus with emails, card numbers (with spaces/dashes), SSNs, tokens, account keys, and ensure replacements occur; test <code>g_aggressiveRedaction</code> toggle. <br><strong>Notes:</strong> Keep redaction rules conservative and document limitations to auditors. Consider pluggable redaction function to allow enterprise-specific patterns. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>NewCorrelationId</strong> — <em>GUID/unique id creation</em><br><strong>Purpose:</strong> Create correlation identifiers for events. Uses <code>Scriptlet.TypeLib</code> GUID when available; falls back to pseudo-random timestamp-rand string prefixed <code>IFRS-</code> otherwise.<br><strong>Signature:</strong> <code>Private Function NewCorrelationId() As String</code><br><strong>Behavior:</strong> Attempts to create <code>Scriptlet.TypeLib</code> COM object and uses <code>.Guid</code> with braces stripped. If fails, constructs <code>IFRS-&lt;yyyymmddHHMMSS&gt;-&lt;random&gt;</code> string. <br><strong>Complexity:</strong> O(1). <br><strong>Tests:</strong> Confirm returned string is non-empty and unique across multiple calls; ensure GUID format when <code>Scriptlet.TypeLib</code> available. <br><strong>Notes:</strong> If enterprise requires standard UUID format, prefer to inject a provider macro or use OS-level UUID generator. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>EscapeJson / EscapeCsv / EscapeCsvField / NzValue</strong> — <em>text escaping & defensive helpers</em><br><strong>Purpose:</strong> Helper functions to escape JSON strings, CSV fields, and to coalesce Null/Empty/Errors into safe strings. Used during export and diagnostic report generation. <br><strong>Signatures:</strong> <code>Private Function EscapeJson(ByVal s As String) As String</code> / <code>Private Function EscapeCsv(ByVal s As String) As String</code> / <code>Private Function EscapeCsvField(ByVal s As String) As String</code> / <code>Private Function NzValue(v As Variant) As String</code><br><strong>Behavior:</strong> <code>EscapeJson</code> escapes backslashes, quotes, slashes and normalizes newlines to <code>\n</code>. <code>EscapeCsv</code> doubles internal quotes; <code>EscapeCsvField</code> wraps value in quotes and doubles quotes. <code>NzValue</code> converts Error/Null/Empty to empty string or <code>CStr</code> otherwise. <br><strong>Complexity:</strong> O(len(s)). <br><strong>Tests:</strong> Round-trip tests: ensure CSV fields containing quotes are escaped correctly; JSON escapes correct characters. <br><strong>Notes:</strong> Keep JSON escaping in sync with export and any external consumers. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>CreateAuditMetaSheetIfMissing / UpdateAuditMetaSheet</strong> — <em>observability & small state store</em><br><strong>Purpose:</strong> Provide a <code>VeryHidden</code> meta sheet <code>_IFRS_AuditMeta</code> with small key/value rows (LastFlushUTC, BufferedCount, EnableMetaSheet, AggressiveRedaction) and allow the module to update observability metrics there for administrators.<br><strong>Signatures:</strong> <code>Private Function CreateAuditMetaSheetIfMissing() As Worksheet</code> / <code>Private Sub UpdateAuditMetaSheet()</code><br><strong>Behavior:</strong> Create meta sheet with key/value header and initial rows. <code>UpdateAuditMetaSheet</code> writes <code>LastFlushUTC</code>, <code>BufferedCount</code>, and flag states to rows and keeps sheet <code>VeryHidden</code>. Both functions swallow errors and return <code>Nothing</code>/no-op on failure. <br><strong>Complexity:</strong> O(1). <br><strong>Side-effects:</strong> Adds/updates meta-sheet. <br><strong>Security:</strong> Meta-sheet visibility is <code>VeryHidden</code> but still present in workbook file — treat as sensitive. <br><strong>Tests:</strong> Toggle <code>g_enableMetaSheet</code> and confirm sheet presence and values updated after appends/flush. <br><strong>Notes:</strong> This is purposely minimal; consumers may extend the meta sheet to add additional observability keys. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>Utility time/encoding/diagnostic helpers</strong> — <em>misc helpers used by module</em><br><strong>Purpose:</strong> Misc small helpers: <code>EscapeCsvField</code> used in diagnostics, <code>GetSystemTime</code> declarations for Win32 interop and fallback, <code>UtcNowForFilename</code>. They are implementation primitives used by larger functions.<br><strong>Behavior & Tests:</strong> See calling functions. <br><strong>Notes:</strong> Keep these stable; changes change serialization and thus hash payloads. </td></tr><tr><td data-label="Technical breakdown (modAudit)"> <strong>Maintenance & Integration notes (global)</strong> <br> - <strong>Canonicalization</strong>: Hash correctness depends critically on canonical encoding: order of fields, UTF-8 encoding of payload, and deterministic redaction/truncation. Any change to <code>ComputeEntryHash</code> payload composition, <code>StrToUtf8Bytes</code>, or <code>RedactSensitiveData</code> will break verification across existing audit files. Treat these functions as high-stability APIs and include migration strategy when changing. <br> - <strong>Provider trust boundary</strong>: <code>HashProviderMacroName</code> allows workbook macros to supply hashes. This is a trust boundary — document that external macros may execute arbitrary code; prefer signed macros or a vetted provider. <br> - <strong>Platform portability</strong>: <code>ComputeSHA256_UsingCertUtil</code> requires Windows & <code>certutil</code>; <code>ADODB.Stream</code> may not exist in some hosts leading to <code>StrConv</code> fallback and different byte encodings. If cross-machine verification is required, add a pure-VBA UTF-8 encoder and/or a pure-VBA SHA256 implementation. <br> - <strong>Atomicity & concurrency</strong>: Bulk <code>Range.Value</code> write reduces COM overhead and is atomic from VBA perspective but not atomic across multiple Excel instances. If multiple processes may edit the same workbook concurrently, implement external coordination (file locks) to avoid race conditions. <br> - <strong>Observability</strong>: Module emits small buffered events (<code>FlushStart</code>, <code>FlushFinish</code>, <code>RotateStart</code>, <code>HashProviderUsed</code>, etc.) to aid debugging. These are appended to buffer and flushed like normal entries. <br> - <strong>Security & Compliance</strong>: Redaction is heuristic — should not be relied upon for legal compliance without higher-assurance redaction. Exported CSV/JSON may contain sensitive data and should be protected. <br> - <strong>Performance</strong>: Keep <code>AUDIT_BATCH_FLUSH_THRESHOLD</code> tuned; bulk writes are essential for high-throughput usage. Consider <code>maxParallelFetches</code> equivalent if other modules do heavy IO. <br> - <strong>Testing matrix</strong>: Unit tests should cover: canonicalization and cross-provider hash parity; certutil path; CRC32 fallback; bulk write vs fallback; rotation atomicity; export correctness; VerifyAuditChain detection of tamper; redaction behavior; meta-sheet updates. <br> - <strong>Backwards compatibility</strong>: Public function signatures are intentionally stable. Any breaking changes require bumping integration contracts and migration helpers. </td></tr></tbody></table></div><div class="row-count">Rows: 28</div></div><div class="table-caption" id="Table18" data-table="Docu_0158_18" style="margin-top:2mm;margin-left:3mm;"><strong>Table 18</strong></div>
<div class="table-wrapper" data-table-id="table-18"><div class="table-heading-bar" aria-label="Table heading"></div><div class="table-container"><div class="table-header-wrapper" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;"><div class="copy-buttons"><button type="button" class="copy-plain-btn" data-action="copy-plain" onclick="copyTablePlain(this)">Copy Plain Table</button><button type="button" class="copy-markdown-btn" data-action="copy-markdown" onclick="copyTableMarkdown(this)">Copy Markdown Table</button><button type="button" class="export-csv-btn" data-action="export-csv" onclick="exportTableCSV(this)">Export CSV</button><button type="button" class="export-json-btn" data-action="export-json" onclick="exportTableJSON(this)">Export JSON</button><button type="button" class="export-xlsx-btn" data-action="export-xlsx" onclick="exportTableXLSX(this)">Export XLSX</button><button type="button" class="export-pdf-btn" data-action="export-pdf" onclick="exportTablePDF(this)">Export PDF</button><button type="button" class="export-markdown-btn export-markdown-initial" data-action="export-markdown" onclick="exportTableMarkdown(this)" style="display:none" data-initial-hidden="1">Export Markdown</button></div><div style="display:flex; align-items:center;"><button type="button" class="toggle-table-btn" data-action="toggle-collapse" onclick="toggleTable(this)">Collapse Table</button></div></div><table class="tv-table" role="table"><thead><tr><th class="tv-col-left" role="button" aria-label="Sort by Technical breakdown (modBootstrap)"><div class="th-with-sort"><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Technical breakdown (modBootstrap)</div><button class="sort-btn sort-state-0" title="Toggle sort" aria-label="Toggle sort"><span class="sort-icon" aria-hidden="true"></span></button></div></th></tr></thead><tbody><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>Overview:</strong> Exhaustive per-function technical breakdown of the <code>modBootstrap</code> VBA module you provided. Each entry documents: purpose, signature, inputs/outputs, internal behaviour, complexity, side-effects, invariants, failure modes, security/privacy considerations, recommended tests, and maintainer notes. Treat this as authoritative inline documentation for reviewers and QA. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>AddIn_Initialize()</strong> — <em>idempotent entrypoint; schedule deferred init; prepare metadata & feature state</em><br><strong>Purpose:</strong> Called at workbook open to create deterministic bootstrap id, prepare feature dictionaries, ensure metadata persistence sheet, persist initial state, and schedule <code>AddIn_DeferredInit</code> via <code>Application.OnTime</code> in a tolerant, cross-host way.<br><strong>Signature:</strong> <code>Public Sub AddIn_Initialize()</code> — no args, no return.<br><strong>Behavior:</strong> Idempotency check via <code>g_bootstrapInitialized</code>. Records <code>g_bootstrapStartUtc</code> and computes <code>g_bootstrapId</code> using CRC32 of a timestamp + user string. Attempts to create scripting dictionaries for <code>g_disabledFeatures</code> and <code>g_enabledFeatures</code> with <code>CreateObjectSafe</code>. Ensures metadata sheet exists (<code>EnsureMetadataSheetExists</code>) and writes initial meta values. Performs basic environment sanity check (Application.Version) and may disable "core" feature on failure. Schedules deferred init at <code>g_deferredWhen = Now + 1s</code> via <code>Application.OnTime</code>, trying workbook-qualified procedure first (Windows) then unqualified fallback (Mac or when workbook unavailable). Sets <code>g_bootstrapScheduled</code>, <code>g_bootstrapInitialized</code>, and logs via <code>Bootstrap_Audit</code>. Uses structured error-handling and forwards errors to <code>Bootstrap_HandleError</code>.<br><strong>Complexity:</strong> O(1) runtime; a few COM creations. Scheduling is O(1).<br><strong>Side-effects:</strong> Creates metadata sheet, writes persistent metadata entries, modifies module-level state, schedules OnTime jobs, writes audit rows (local or remote).<br><strong>Invariants:</strong> Sets <code>g_bootstrapInitialized = True</code> on successful call (idempotent). <code>g_bootstrapId</code> persists if non-empty. <code>g_deferredWhen</code> contains scheduled time when scheduling succeeded.<br><strong>Failure modes:</strong> <code>Application.OnTime</code> may fail (workbook unavailable, Mac restrictions); <code>CreateObject</code> may fail (no Scripting.Dictionary); metadata sheet creation can be prevented by protected workbook or insufficient permissions. All failures are handled best-effort and audited. If scheduling fails completely, <code>g_bootstrapScheduled</code> is False and bootstrap is still considered initialized. <br><strong>Security/Privacy:</strong> Does not store secrets here; writes masked markers for sensitive keys later. Computes checksum-based id (not cryptographically secure).<br><strong>Recommended tests:</strong> Run on Windows and Mac host emulators; simulate workbook unavailable; validate bootstrap id written to metadata; assert idempotency by running twice; verify OnTime scheduled (mock or inspect OnTime calls).<br><strong>Notes for maintainers:</strong> Preserve public signature. Avoid changing id format without migration because other modules may read <code>BootstrapId</code>. Keep workbook-qualified scheduling for Windows for determinism. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>AddIn_DeferredInit()</strong> — <em>deferred startup: capability snapshot, config load/migrate, warm-up services, optional self-test</em><br><strong>Purpose:</strong> Runs after <code>AddIn_Initialize</code> (via OnTime) to probe dependencies, attempt safe config load and migration, warm-up lightweight modules, optionally run startup self-tests, persist final bootstrap state and diagnostics, and audit timings.<br><strong>Signature:</strong> <code>Public Sub AddIn_DeferredInit()</code> — no args, no return.<br><strong>Behavior:</strong> Ensures <code>g_bootstrapInitialized</code> true, calls <code>AddIn_EnsureDependencies()</code> to build capability snapshot and persist it. Uses <code>SafeRun</code> and <code>SafeRunWithResult</code> to call <code>Config_Load</code>, <code>Config_MigrateIfNeeded</code> and other modules (<code>modAudit_Init</code>, <code>modUtilities_Init</code>) in a non-fatal manner. Reads <code>run_selftest_on_start</code> flag from <code>Config_Get</code> and conditionally calls <code>AddIn_SelfTestStartup</code>. On success writes <code>PersistBootstrapState &quot;finished&quot;,&quot;ok&quot;</code>, records <code>DeferredInitDurationSeconds</code> and audit messages. On any error it calls <code>Bootstrap_HandleError</code>, persists <code>&quot;finished&quot;,&quot;partial&quot;</code> and clears scheduled flag. Idempotent-safe (sets <code>g_bootstrapInitialized</code> if not set).<br><strong>Complexity:</strong> O(1) for orchestration; cost depends on invoked SafeRun targets (IO, config parse).<br><strong>Side-effects:</strong> Calls other modules (config, audit, utilities), may alter configuration via migration, writes metadata and audit rows, starts additional module-level initialization side-effects.<br><strong>Invariants:</strong> If successful, final persisted bootstrap state reflects <code>&quot;finished&quot; : &quot;ok&quot;</code>. The <code>DeferredInitDurationSeconds</code> is set to wall-clock seconds of the run. <code>g_bootstrapScheduled</code> should be set to False at end.<br><strong>Failure modes:</strong> <code>SafeRun</code> calls may be unavailable or throw; <code>Config_Get</code> may return Empty and be interpreted as False. Long-running migrations risk blocking UI if host is sensitive. Self-test may return failures — flagged and cause feature disable for <code>selftest</code> if failing. Errors are logged and handled gracefully.<br><strong>Security/Privacy:</strong> Config migration and loads may touch sensitive data — <code>WriteMetaValue</code> redacts sensitive keys. Ensure <code>Config_*</code> implementations also respect redaction.<br><strong>Recommended tests:</strong> Simulate <code>Config_Load</code> present/missing; simulate failing <code>Config_MigrateIfNeeded</code>; verify <code>DeferredInitDurationSeconds</code> written; verify that an unavailable <code>modAudit_Init</code> is tolerated and logged; test self-test true/false paths.<br><strong>Notes for maintainers:</strong> Keep SafeRun usage; avoid turning <code>AddIn_DeferredInit</code> into a heavy synchronous block — if you add heavy tasks, consider splitting into smaller safe-run steps. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>AddIn_Shutdown()</strong> — <em>idempotent shutdown / cancel scheduled jobs / final persistence</em><br><strong>Purpose:</strong> Clean shutdown entrypoint: cancel OnTime schedule, persist shutdown state, and log audit row.<br><strong>Signature:</strong> <code>Public Sub AddIn_Shutdown()</code> — no args, no return.<br><strong>Behavior:</strong> Calls <code>TryCancelOnTime</code> (which tries both workbook-qualified and unqualified cancellation) to cancel scheduled <code>AddIn_DeferredInit</code> and swallows errors. Sets <code>g_bootstrapScheduled = False</code>, persists <code>PersistBootstrapState &quot;shutdown&quot;,&quot;&quot;</code>, and logs via <code>Bootstrap_Audit</code>. Errors forwarded to <code>Bootstrap_HandleError</code>.<br><strong>Complexity:</strong> O(1).<br><strong>Side-effects:</strong> Writes to metadata, cancels scheduled OnTime events, writes audit rows.<br><strong>Invariants:</strong> After run <code>g_bootstrapScheduled</code> false and metadata contains <code>&quot;BootstrapLastStatus&quot; = &quot;shutdown&quot;</code>.<br><strong>Failure modes:</strong> OnTime cancel may fail if original time or proc name mismatched; workbook closed; errors are logged but shutdown remains best-effort.<br><strong>Security/Privacy:</strong> No special concerns.<br><strong>Recommended tests:</strong> Schedule AddIn_DeferredInit, call AddIn_Shutdown and assert OnTime is cancelled; call shutdown multiple times to assert idempotency. <br><strong>Notes:</strong> Keep cancellation tolerant to host differences; do not rely solely on <code>g_bootstrapScheduled</code> flag for cancellation. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>AddIn_IsInitialized()</strong> — <em>query</em><br><strong>Purpose:</strong> Return bootstrap initialization boolean for external callers.<br><strong>Signature:</strong> <code>Public Function AddIn_IsInitialized() As Boolean</code> → returns module-level <code>g_bootstrapInitialized</code>.<br><strong>Behavior:</strong> Simple accessor.<br><strong>Complexity:</strong> O(1).<br><strong>Side-effects:</strong> None.<br><strong>Invariants:</strong> Mirrors internal state. <br><strong>Failure modes:</strong> None.<br><strong>Tests:</strong> Toggle <code>g_bootstrapInitialized</code> and verify return value. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>AddIn_GetState()</strong> — <em>return bootstrap state snapshot as Scripting.Dictionary</em><br><strong>Purpose:</strong> Provide external callers with a snapshot object containing bootstrapId, startUtc, scheduled flag, enabled/disabled feature lists.<br><strong>Signature:</strong> <code>Public Function AddIn_GetState() As Object</code> → returns <code>Scripting.Dictionary</code> or <code>Nothing</code> on failure.<br><strong>Behavior:</strong> Creates a <code>Scripting.Dictionary</code> via <code>CreateObjectSafe</code> and populates keys: <code>bootstrapId</code>, <code>startUtc</code>, <code>scheduled</code>, <code>enabledFeatures</code> (array from dict safe), <code>disabledFeatures</code> (array with values). If dictionary creation fails returns <code>Nothing</code>. Errors handled via <code>Bootstrap_HandleError</code> and returns <code>Nothing</code> on exceptions.<br><strong>Complexity:</strong> O(Nfeatures) to produce arrays.<br><strong>Side-effects:</strong> None persistent; creates transient COM object.<br><strong>Invariants:</strong> Arrays produced are safe-cloned snapshots (not live refs). If dictionaries are missing returns empty arrays.<br><strong>Failure modes:</strong> COM unavailable → returns <code>Nothing</code>. <br><strong>Tests:</strong> With feature dicts populated, verify structure and content. <br><strong>Notes:</strong> Keep return shape stable for consumers. Consider switching to a VBA <code>Collection</code> only if consumers cannot handle Scripting.Dictionary. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>AddIn_SelfTestStartup()</strong> — <em>repeated lightweight self-test harness used optionally at start-up</em><br><strong>Purpose:</strong> Run repeated sanity checks (dependency availability and TestRunner) to surface bootstrap-level issues early, but treat many failures as benign. Designed to run in a loop (10 iterations) to detect intermittent issues.<br><strong>Signature:</strong> <code>Public Function AddIn_SelfTestStartup() As Boolean</code> → returns Boolean success summary.<br><strong>Behavior:</strong> Loops 10 iterations; each iteration calls <code>AddIn_EnsureDependencies()</code> and expects <code>coreAvailable</code> true. Also calls <code>TestRunner_SelfTest</code> via <code>SafeRunWithResult</code> if available (otherwise treats missing TestRunner as benign). Uses <code>DoEvents</code> to yield. Collects boolean <code>ok</code> and audits result. On error forwards to <code>Bootstrap_HandleError</code> and returns False.<br><strong>Complexity:</strong> O(iterations * cost of dependency checks). Each iteration is O(1) unless dependencies are heavy.<br><strong>Side-effects:</strong> Calls <code>AddIn_EnsureDependencies</code> which persists capability snapshot; logs audit. May mark <code>ok</code> false on failures.<br><strong>Invariants:</strong> Deterministic: 10 cycles as written. Returns True only if all checks passed deemed essential.<br><strong>Failure modes:</strong> False negatives if TestRunner missing (treated benign); intermittent dependencies may transiently fail. On exception returns False and logs. <br><strong>Security:</strong> None special.<br><strong>Recommended tests:</strong> Force <code>AddIn_EnsureDependencies</code> to return incomplete capabilities; simulate TestRunner returning false; verify function returns false and audit logged. <br><strong>Notes:</strong> Conservative: avoids failing bootstrap on missing TestRunner. If this function becomes heavy, consider reducing iterations or splitting into async checks. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>AddIn_EnableFeature(featureName As String)</strong> — <em>enable feature (in-memory + persist)</em><br><strong>Purpose:</strong> Mark a feature enabled in <code>g_enabledFeatures</code> and remove from <code>g_disabledFeatures</code>. If dictionaries unavailable, persists a pending marker to metadata for later reconciliation.<br><strong>Signature:</strong> <code>Public Sub AddIn_EnableFeature(ByVal featureName As String)</code> — no return.<br><strong>Behavior:</strong> Ensures dictionaries exist (best-effort via <code>CreateObjectSafe</code>). If dictionaries unavailable writes <code>FeatureEnablePending</code> meta key. Otherwise removes feature from disabled and sets enabled=true in the enabled dictionary. Calls <code>PersistBootstrapState</code> to persist records. Errors forwarded to <code>Bootstrap_HandleError</code>.<br><strong>Complexity:</strong> O(1).<br><strong>Side-effects:</strong> Mutates in-memory dicts and writes metadata. <br><strong>Invariants:</strong> <code>g_enabledFeatures</code> contains featureName with True and <code>g_disabledFeatures</code> does not.<br><strong>Failure modes:</strong> Dictionaries unavailable; metadata write failure. Both are best-effort and recorded. <br><strong>Tests:</strong> Toggle enable/disable sequences; confirm metadata entries and in-memory dictionaries align. <br><strong>Notes:</strong> Keep feature name length bounded (persist uses Left$(…,256)). </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>AddIn_DisableFeature(featureName As String, reason As String)</strong> — <em>disable feature with reason (in-memory + persist)</em><br><strong>Purpose:</strong> Mark a feature disabled (and store reason string) and remove from enabled dict. If dictionaries missing, persist pending disable marker to metadata.<br><strong>Signature:</strong> <code>Public Sub AddIn_DisableFeature(ByVal featureName As String, ByVal reason As String)</code> — no return.<br><strong>Behavior:</strong> Ensures dictionaries exist via <code>CreateObjectSafe</code>. If unavailable writes <code>FeatureDisablePending</code> meta key combining featureName and reason. Otherwise removes feature from enabledFeatures and writes featureName→reason in disabledFeatures. Persists via <code>PersistBootstrapState</code> with <code>feature_disabled</code> note including reason. Errors handled.<br><strong>Complexity:</strong> O(1).<br><strong>Side-effects:</strong> Mutates dicts and metadata.<br><strong>Invariants:</strong> <code>g_disabledFeatures(featureName)</code> exists with truncated reason ≤256 chars. <code>g_enabledFeatures</code> does not contain it.<br><strong>Failure modes:</strong> Missing dictionary; metadata writes fail. <br><strong>Tests:</strong> Disable feature with long reason; assert truncated reason saved and marker present. <br><strong>Notes:</strong> Use this to gate features at runtime; ensure consumers check disabled dict before using optional APIs. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>AddIn_EnsureDependencies()</strong> — <em>build & persist capability snapshot</em><br><strong>Purpose:</strong> Probe host capabilities and COM availability (FSO, ADODB.Stream, WScript), signature accessibility, host OS, and produce a <code>Scripting.Dictionary</code> snapshot persisted via <code>PersistCapabilitySnapshot</code> and returned to caller.<br><strong>Signature:</strong> <code>Public Function AddIn_EnsureDependencies() As Object</code> → returns <code>Scripting.Dictionary</code> (or Nothing on fatal error).<br><strong>Behavior:</strong> Attempts <code>CreateObjectSafe(&quot;Scripting.FileSystemObject&quot;)</code>, <code>CreateObjectSafe(&quot;ADODB.Stream&quot;)</code>, and <code>CreateObjectSafe(&quot;WScript.Shell&quot;)</code>. Checks <code>ThisWorkbook.Signatures.Count</code> in a guarded <code>On Error</code> block (handles host differences). Sets <code>excelVersion</code>, <code>coreAvailable</code> true, <code>hostOperatingSystem</code>, <code>isMac</code>. Calls <code>PersistCapabilitySnapshot</code> to write a serialized (k=v;) string to metadata. Returns dictionary.<br><strong>Complexity:</strong> O(1) COM creations. <br><strong>Side-effects:</strong> Writes LastCapabilitySnapshot metadata. <br><strong>Invariants:</strong> Returned dictionary contains boolean flags for key capabilities; persisted string limited to 1024 characters. <br><strong>Failure modes:</strong> COM instantiation fails → flags false; workbook unavailability prevents signature checks. Such failures are expected on constrained hosts and are handled gracefully. <br><strong>Security:</strong> None beyond normal. <br><strong>Tests:</strong> Run in environment variations: normal Windows Excel, protected workbook, Mac host, remove ADODB.Stream registration; verify flags reflect environment. <br><strong>Notes:</strong> Keep this function cheap and side-effect-limited. Avoid heavy probing. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>PersistBootstrapState(status As String, note As String)</strong> — <em>write a set of bootstrap metadata keys to metadata sheet</em><br><strong>Purpose:</strong> Centralized metadata persistence for bootstrap lifecycle: id, start time, last status, note, last updated timestamp, and feature list serialization.<br><strong>Signature:</strong> <code>Private Sub PersistBootstrapState(ByVal status As String, ByVal note As String)</code> — no return.<br><strong>Behavior:</strong> Calls <code>EnsureMetadataSheetExists()</code>. Writes <code>BootstrapId</code>, <code>BootstrapStartUtc</code>, <code>BootstrapLastStatus</code>, <code>BootstrapLastNote</code>, <code>BootstrapLastUpdated</code>. Serializes enabled & disabled arrays (via helper functions) and writes <code>EnabledFeatures</code>, <code>DisabledFeatures</code> truncated to 1024 chars. Uses <code>WriteMetaValue</code> for each key. Error handling via <code>Bootstrap_HandleError</code>.<br><strong>Complexity:</strong> O(Nfeatures).<br><strong>Side-effects:</strong> Mutates metadata worksheet rows, may create sheet. <br><strong>Invariants:</strong> Key names consistent; values truncated to safe sizes. <br><strong>Failure modes:</strong> Worksheet creation or write may fail on protected workbooks or missing permissions. Failures logged via <code>Bootstrap_HandleError</code>. <br><strong>Security:</strong> Uses <code>WriteMetaValue</code> which redacts sensitive keys. <br><strong>Tests:</strong> Populate feature dicts and call persist; verify sheet values and truncation. <br><strong>Notes:</strong> Keep truncation rules aligned with other consumers. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>PersistCapabilitySnapshot(dict As Object)</strong> — <em>write capability serialized string to metadata</em><br><strong>Purpose:</strong> Convert capability dictionary into small serialized string and write <code>LastCapabilitySnapshot</code> and <code>LastCapabilitySnapshotUpdated</code> keys.<br><strong>Signature:</strong> <code>Private Sub PersistCapabilitySnapshot(ByVal dict As Object)</code> — no return.<br><strong>Behavior:</strong> Iterates dict keys building <code>key=value;</code> pairs up to 1024 chars, writes via <code>WriteMetaValue</code>. Errors logged to Debug.Print and swallowed to avoid breaking bootstrap. <br><strong>Complexity:</strong> O(Nkeys).<br><strong>Side-effects:</strong> Writes metadata. <br><strong>Invariants:</strong> Snapshot truncated to 1024 chars. <br><strong>Failure modes:</strong> Write failure is non-fatal and logged. <br><strong>Tests:</strong> Build dict of capabilities and call; inspect metadata. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>WriteMetaValue(key As String, value As String)</strong> — <em>persist a metadata key/value in metadata sheet; redact sensitive keys</em><br><strong>Purpose:</strong> Single place to write metadata with redaction logic, row lookup, create or update semantics, and size truncation. Adds sensitive key markers when necessary.<br><strong>Signature:</strong> <code>Private Sub WriteMetaValue(ByVal key As String, ByVal value As String)</code> — no return.<br><strong>Behavior:</strong> Ensures metadata sheet exists, truncates value to 2048 chars, checks <code>IsSensitiveKey(key)</code> and if sensitive replaces stored value tail with <code>[REDACTED]</code> and records the key via <code>AddSensitiveKeyMarker</code>. Locates key via <code>Find</code> on column 1; if found updates column2; else appends a new row (never overwrites header row). Uses On Error guards and logs to audit on failure. <br><strong>Complexity:</strong> O(number of rows) due to <code>.Find</code> usage (fast in Excel). <br><strong>Side-effects:</strong> Mutates metadata sheet rows, may create rows and change visible properties. <br><strong>Invariants:</strong> Sensitive keys not written raw in full; <code>SensitiveKeys</code> list contains the key summary. <br><strong>Failure modes:</strong> <code>.Find</code> may throw on unusual worksheets; write operations may be blocked by protection; function logs failures to audit. <br><strong>Security/Privacy:</strong> Central redaction strategy; ensure <code>IsSensitiveKey</code> covers all secret patterns. <br><strong>Recommended tests:</strong> Test key insertion/update for normal key and sensitive key; verify <code>SensitiveKeys</code> list and redaction text. <br><strong>Notes:</strong> This is critical for PII/secret safety. Keep size truncation conservative. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>ReadMetaValue(key As String) As String</strong> — <em>read persisted value from metadata sheet</em><br><strong>Purpose:</strong> Safely read a meta key from metadata sheet and return its string value (or empty string when missing or on error).<br><strong>Signature:</strong> <code>Private Function ReadMetaValue(ByVal key As String) As String</code> → string.<br><strong>Behavior:</strong> Calls <code>EnsureMetadataSheetExists()</code>, uses <code>.Find</code> in column 1 and returns column2 value if found. Errors return empty string. Uses <code>On Error</code> guards.<br><strong>Complexity:</strong> O(1) average (Find).<br><strong>Side-effects:</strong> None. <br><strong>Failure modes:</strong> Sheet missing → returns empty string; <code>.Find</code> errors swallowed. <br><strong>Tests:</strong> Write keys and read them back; test missing key returns empty. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>EnsureMetadataSheetExists() As Worksheet</strong> — <em>create or return the metadata worksheet; hide it</em><br><strong>Purpose:</strong> Guarantee the presence of a hidden metadata worksheet with header row and safe name; create with robust fallback name strategy and mark as VeryHidden when possible.<br><strong>Signature:</strong> <code>Private Function EnsureMetadataSheetExists() As Worksheet</code> → Worksheet or Nothing on failure.<br><strong>Behavior:</strong> Attempts to access <code>ThisWorkbook.Worksheets(&quot;_IFRS_Metadata&quot;)</code> (guarded for workbook-unavailable). If not present and workbook available it adds a new worksheet at end, attempts to name it <code>_IFRS_Metadata</code> and, if that fails, append a timestamp suffix. Attempts to set <code>Visible = xlSheetVeryHidden</code> with fallback numeric constant <code>2</code> if constant unsupported. Ensures header cells "Key" and "Value" are in row 1. Returns Worksheet object. Errors write Debug.Print and return Nothing if workbook unavailable.<br><strong>Complexity:</strong> O(1).<br><strong>Side-effects:</strong> May add worksheet and set visibility.<br><strong>Invariants:</strong> Returned sheet has headers in row 1. <br><strong>Failure modes:</strong> Workbook unavailable or protected workbook preventing sheet creation. Function returns Nothing in that case. <br><strong>Security:</strong> Sheet is made VeryHidden to reduce user tampering. <br><strong>Tests:</strong> Call from workbook with and without existing metadata sheet; simulate inability to rename; check visibility flags. <br><strong>Notes:</strong> Keep name constant in source; if you change <code>METADATA_SHEET_NAME</code>, update consumers. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>ArrayFromDictSafe(dict As Object) As Variant</strong> — <em>convert dictionary keys → array safely</em><br><strong>Purpose:</strong> Produce array of keys from a Scripting.Dictionary, defensively handling Nothing and exceptions.<br><strong>Signature:</strong> <code>Private Function ArrayFromDictSafe(ByVal dict As Object) As Variant</code> → Variant array (or empty Array on failure).<br><strong>Behavior:</strong> If <code>dict</code> is Nothing or <code>dict.Count=0</code> returns empty array. Otherwise ReDims string array of size dict.Count and iterates keys into array. Errors return empty array.<br><strong>Complexity:</strong> O(N).<br><strong>Side-effects:</strong> None.<br><strong>Failure modes:</strong> COM exceptions → returns empty. <br><strong>Tests:</strong> Pass non-empty dict, empty, and Nothing and assert outputs. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>ArrayFromDictWithValuesSafe(dict As Object) As Variant</strong> — <em>convert dictionary key/value → "k=v" array safely</em><br><strong>Purpose:</strong> Like previous, but returns <code>key=value</code> strings for each entry.<br><strong>Signature:</strong> <code>Private Function ArrayFromDictWithValuesSafe(ByVal dict As Object) As Variant</code> → Variant array.<br><strong>Behavior:</strong> Similar guard logic; builds arr(i) = key & "=" & dict(key). Uses On Error guards. <br><strong>Complexity:</strong> O(N).<br><strong>Tests:</strong> Verify for typical dictionary. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>SafeJoinArray(arr As Variant, sep As String) As String</strong> — <em>join array defensively</em><br><strong>Purpose:</strong> Safe wrapper around <code>Join</code> that checks for array-ness and bounds to avoid runtime errors on empty arrays.<br><strong>Signature:</strong> <code>Private Function SafeJoinArray(ByVal arr As Variant, ByVal sep As String) As String</code> → string.<br><strong>Behavior:</strong> If <code>IsArray(arr)</code> and length >0 returns <code>Join(arr, sep)</code> else returns empty string. Exceptions return empty string. <br><strong>Complexity:</strong> O(N total string length).<br><strong>Tests:</strong> array, empty array, non-array inputs. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>SafeString(v As Variant) As String</strong> — <em>defensive variant→string normalization</em><br><strong>Purpose:</strong> Convert variant to string safely: treat Error/Null/Empty as empty string; otherwise CStr.<br><strong>Signature:</strong> <code>Private Function SafeString(ByVal v As Variant) As String</code> → string.<br><strong>Behavior:</strong> On Error Resume Next, checks <code>IsError</code>, <code>IsNull</code>, <code>IsEmpty</code> and returns <code>&quot;&quot;</code> for those; else <code>CStr</code>. Clears Err afterwards. <br><strong>Complexity:</strong> O(1).<br><strong>Tests:</strong> Provide Error, Null, Empty, numeric, string. <br><strong>Notes:</strong> Use widely to avoid propagation of variant errors to callers. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>IsThisWorkbookUnavailable() As Boolean</strong> — <em>safe check whether ThisWorkbook is accessible</em><br><strong>Purpose:</strong> Detect hosts or contexts where <code>ThisWorkbook</code> throws when accessed (protected host, VSTO edge cases), returning True if unavailable.<br><strong>Signature:</strong> <code>Private Function IsThisWorkbookUnavailable() As Boolean</code> → Boolean.<br><strong>Behavior:</strong> Tries <code>Set tmp = ThisWorkbook</code> under On Error; if Err.Number<>0 or tmp is Nothing returns True; else False. Clears Err and releases tmp. <br><strong>Complexity:</strong> O(1).<br><strong>Tests:</strong> Run in contexts where ThisWorkbook accessible and in Office host tests where it deliberately throws. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>TruncateForAudit(s As String, Optional maxLen As Long = 512) As String</strong> — <em>truncate long messages for audit storage</em><br><strong>Purpose:</strong> Truncate strings for audit/logging to prevent runaway cells and keep logs readable.<br><strong>Signature:</strong> <code>Private Function TruncateForAudit(ByVal s As String, Optional ByVal maxLen As Long = 512) As String</code> → string.<br><strong>Behavior:</strong> If length <= maxLen returns s; else returns Left$(s, maxLen-3) & "...". Uses SafeString wrapper. <br><strong>Complexity:</strong> O(len(s)).<br><strong>Tests:</strong> Strings around the boundary. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>CRC32_String(s As String) As Long</strong> — <em>CRC32 checksum helper (byte-wise over UTF-8 bytes)</em><br><strong>Purpose:</strong> Compute a CRC32-style checksum from a string for deterministic id creation (non-crypto). Uses lazy-initialized CRC table (<code>EnsureCRC32Table</code>).<br><strong>Signature:</strong> <code>Private Function CRC32_String(ByVal s As String) As Long</code> → Long (32-bit masked).<br><strong>Behavior:</strong> If input empty returns 0. Calls <code>EnsureCRC32Table</code> to initialize <code>CRC_TABLE</code> lazily. Converts <code>s</code> to bytes via <code>StrConv(..., vbFromUnicode)</code> (UTF-16→byte sequence in host code page), iterates bytes and updates <code>crc</code> using lookup. Returns final CRC masked as 32-bit unsigned integer. <br><strong>Complexity:</strong> O(len(bytes)).<br><strong>Side-effects:</strong> Initializes CRC_TABLE on first call. <br><strong>Failure modes:</strong> Very long strings may loop long but expected safe. Behavior depends on <code>StrConv</code> encoding specifics per host. <br><strong>Security:</strong> Not cryptographic; do not use for secrets hashing. <br><strong>Tests:</strong> Validate known vector and internal table initialization. Example test: <code>CRC32_String(&quot;The quick brown fox&quot;)</code> non-zero. <br><strong>Notes:</strong> Keep table consistent if migrating to other languages; small endian/byte mapping details matter when comparing cross-platform. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>EnsureCRC32Table()</strong> — <em>initialize CRC_TABLE once</em><br><strong>Purpose:</strong> Populate <code>CRC_TABLE(0..255)</code> with polynomial <code>0xEDB88320</code> algorithm and set <code>CRC_TABLE_INIT = True</code>.<br><strong>Signature:</strong> <code>Private Sub EnsureCRC32Table()</code> — no return.<br><strong>Behavior:</strong> ReDim CRC_TABLE and compute values; sets <code>CRC_TABLE_INIT</code> to True. Idempotent-check at top. <br><strong>Complexity:</strong> O(256 * 8) = O(1).<br><strong>Notes:</strong> Keep as private to avoid external dependency. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>HexFromLong(l As Long) As String</strong> — <em>format helper to 8-digit hex string</em><br><strong>Purpose:</strong> Return 8-character zero-padded uppercase hex string for a 32-bit Long value.<br><strong>Signature:</strong> <code>Private Function HexFromLong(ByVal l As Long) As String</code> → string.<br><strong>Behavior:</strong> Masks with <code>&amp;HFFFFFFFF</code> and formats with <code>Hex$</code>, pads to 8 characters rightmost. <code>On Error Resume Next</code> guard. <br><strong>Complexity:</strong> O(1).<br><strong>Tests:</strong> Border cases for negative/large Longs. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>Bootstrap_Audit(action As String, message As String)</strong> — <em>audit dispatcher: Try remote AUDIT_PROC_NAME via SafeRun, fallback to local audit sheet</em><br><strong>Purpose:</strong> Central audit call for bootstrap actions. Attempts to call remote audit procedure (<code>LogAudit</code>) via <code>SafeRunWithResult</code>; if remote call returns non-empty then treat as handled. Else append to local audit sheet via <code>AppendLocalAudit</code>.<br><strong>Signature:</strong> <code>Private Sub Bootstrap_Audit(ByVal action As String, ByVal message As String)</code> — no return.<br><strong>Behavior:</strong> Composes string <code>bootstrapId | action | truncated message</code>. Calls <code>SafeRunWithResult(AUDIT_PROC_NAME, action, composed)</code> and if non-empty returns. Otherwise appends to local audit sheet via <code>AppendLocalAudit</code>. Errors printed to Debug.Print. <br><strong>Complexity:</strong> O(1) plus cost of <code>SafeRunWithResult</code>. <br><strong>Side-effects:</strong> May call external module or mutate audit sheet. <br><strong>Invariants:</strong> If remote audit handler exists and returns non-empty, local append is skipped. <br><strong>Failure modes:</strong> Remote audit may be absent; local audit sheet may be uncreatable — errors logged to Immediate window. <br><strong>Security:</strong> Audit messages are truncated and should avoid storing PII. <br><strong>Tests:</strong> Mock remote audit procedure to return non-empty and verify no local append; remove remote procedure and verify local audit appended. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>CallSafeRunAudit(action, message)</strong> — <em>best-effort non-blocking fire of audit via SafeRun</em><br><strong>Purpose:</strong> Convenience wrapper calling <code>SafeRun AUDIT_PROC_NAME</code> and ignoring errors. Used when audit should not block bootstrap.<br><strong>Signature:</strong> <code>Private Sub CallSafeRunAudit(ByVal action As String, ByVal message As String)</code> — no return.<br><strong>Behavior:</strong> <code>On Error Resume Next</code> then <code>SafeRun AUDIT_PROC_NAME, action, truncated message</code>. <br><strong>Complexity:</strong> O(1).<br><strong>Notes:</strong> Use when audit failure is non-critical. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>AppendLocalAudit(message As String)</strong> — <em>append an audit row to local <code>_IFRS_Audit</code> sheet</em><br><strong>Purpose:</strong> Fallback audit target when remote audit not available. Ensures sheet exists (creates hidden sheet if needed) and appends timestamp, user, message, bootstrapId with headers.<br><strong>Signature:</strong> <code>Private Sub AppendLocalAudit(ByVal message As String)</code> — no return.<br><strong>Behavior:</strong> Creates/gets <code>_IFRS_Audit</code> worksheet, ensures headers for Timestamp, User, Message, bootstrapId, appends new row with current timestamp, Application.UserName, truncated message, and current <code>g_bootstrapId</code>. Uses On Error guards; if sheet creation fails silently exits. <br><strong>Complexity:</strong> O(1) row append. <br><strong>Side-effects:</strong> Creates/updates audit worksheet. <br><strong>Failure modes:</strong> Sheet creation may fail; function exits silently in that case. <br><strong>Security/Privacy:</strong> Audit sheet may contain PII (UserName); store only what's necessary; ensure workbook-level protections if required. <br><strong>Tests:</strong> Validate header creation and row append; test behavior when workbook unavailable. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>Bootstrap_HandleError(procName As String, errNum As Long, errDesc As String)</strong> — <em>centralized error forwarding with SafeRun forwarding and fallback to local audit</em><br><strong>Purpose:</strong> Centralize error handling: attempt to forward errors to a centralized error handler (<code>HandleError</code>) via <code>SafeRunWithResult</code>; if error handler handled it (non-empty result) then return; else append a local audit entry and Debug.Print the error.<br><strong>Signature:</strong> <code>Private Sub Bootstrap_HandleError(ByVal procName As String, ByVal errNum As Long, ByVal errDesc As String)</code> — no return.<br><strong>Behavior:</strong> Composes <code>proc=.. | err=.. | msg=..</code> payload. Calls <code>SafeRunWithResult(ERROR_PROC_NAME, procName, errNum, truncated errDesc)</code> and if not Empty returns. Else falls back to Debug.Print and <code>AppendLocalAudit &quot;Error|proc:err|desc&quot;</code>. <code>On Error</code> guards ensure this function never raises further exceptions. <br><strong>Complexity:</strong> O(1).<br><strong>Side-effects:</strong> May call external error handler or write local audit row. <br><strong>Invariants:</strong> Does not throw. <br><strong>Failure modes:</strong> Remote error handler may be absent; fallback must succeed. <br><strong>Tests:</strong> Simulate remote <code>HandleError</code> presence and absence and ensure fallback. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>SafeRun(procName As String, ParamArray args() As Variant) As Boolean</strong> — <em>robust Application.Run wrapper (no result expected)</em><br><strong>Purpose:</strong> Safely call an external procedure by attempting workbook-qualified first (on Windows) and falling back to unqualified procedure. Handles up to 9 args. Returns True if call succeeded (no error), otherwise False. Non-fatal design for optional handlers.<br><strong>Signature:</strong> <code>Private Function SafeRun(ByVal procName As String, ParamArray args() As Variant) As Boolean</code> → Boolean.<br><strong>Behavior:</strong> If <code>procName</code> empty returns False. If not <code>IsMac</code> and <code>ThisWorkbook</code> available attempts <code>CallRunWithArgs</code> with <code>&quot;&#x27;ThisWorkbookName&#x27;!proc&quot;</code>. If that fails tries unqualified <code>procName</code>. Uses <code>On Error</code> to detect success. Returns boolean success. <br><strong>Complexity:</strong> O(1) plus cost of invoked proc. <br><strong>Side-effects:</strong> May execute arbitrary public procedures in workbook (side-effects depend on those procs). <br><strong>Invariants:</strong> Returns true only when a call completes without error. <br><strong>Failure modes:</strong> Application.Run can error when proc missing or has different signature; SafeRun catches and returns False. <br><strong>Security:</strong> Calling arbitrary code—callers must trust invoked procedure. Avoid using with user-controlled proc names. <br><strong>Tests:</strong> Call existing and non-existing procedure; verify behavior on Mac/Windows. <br><strong>Notes:</strong> Supports up to the first 9 params explicitly. If you expect more args, extend the dispatcher. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>SafeRunWithResult(procName As String, ParamArray args() As Variant) As Variant</strong> — <em>Application.Run wrapper returning result or Empty</em><br><strong>Purpose:</strong> Like <code>SafeRun</code> but expects and returns a result from <code>Application.Run</code> or <code>Empty</code> on failure. Tries workbook-qualified first (not on Mac) then unqualified. Handles errors and returns <code>Empty</code> on failure.<br><strong>Signature:</strong> <code>Private Function SafeRunWithResult(ByVal procName As String, ParamArray args() As Variant) As Variant</code> → Variant or Empty.<br><strong>Behavior:</strong> Attempts qualified/unqualified <code>CallRunWithArgsWithResult</code>. On error returns Empty. <br><strong>Complexity:</strong> O(1) plus cost of invoked proc. <br><strong>Side-effects:</strong> Executes remote procedure. <br><strong>Tests:</strong> Call known function returning value; call missing proc -> returns Empty. <br><strong>Notes:</strong> Use when remote API may return information; always check <code>IsEmpty</code> before CBool conversions. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>CallRunWithArgs(proc As String, args() As Variant)</strong> — <em>explicit Application.Run arg dispatcher (no result)</em><br><strong>Purpose:</strong> Dispatch <code>Application.Run</code> calls with explicit cases for 0..9 arguments to avoid runtime argument array issues and limit risk of late-binding errors.<br><strong>Signature:</strong> <code>Private Sub CallRunWithArgs(ByVal proc As String, ByVal args() As Variant)</code> — no return.<br><strong>Behavior:</strong> Counts args using <code>ParamCount</code> and uses <code>Select Case</code> to call <code>Application.Run proc[,args...]</code> with appropriate explicit parameter count. For >9 args passes first 9 only (documented). Uses <code>On Error Resume Next</code> in the dispatch. <br><strong>Complexity:</strong> O(1).<br><strong>Notes:</strong> This dispatcher intentionally caps at 9 args to remain simple and predictable. If you rely on vararg > 9, update carefully and test. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>CallRunWithArgsWithResult(proc As String, args() As Variant) As Variant</strong> — <em>explicit Application.Run dispatcher returning result</em><br><strong>Purpose:</strong> Same as <code>CallRunWithArgs</code> but returns value from <code>Application.Run</code>, with guard for Err.Number to return Empty on error.<br><strong>Signature:</strong> <code>Private Function CallRunWithArgsWithResult(ByVal proc As String, ByVal args() As Variant) As Variant</code> → Variant.<br><strong>Behavior:</strong> Dispatches <code>Application.Run</code> per <code>ParamCount</code> and sets <code>CallRunWithArgsWithResult = Application.Run(...)</code>. If <code>Err.Number &lt;&gt; 0</code> sets result Empty and clears error. <br><strong>Complexity:</strong> O(1).<br><strong>Tests:</strong> Verify with procs that return primitives and objects. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>ParamCount(args() As Variant) As Long</strong> — <em>safe ParamArray length helper</em><br><strong>Purpose:</strong> Return number of elements passed in a ParamArray while guarding against Empty/UBound errors.<br><strong>Signature:</strong> <code>Private Function ParamCount(ByVal args() As Variant) As Long</code> → Long.<br><strong>Behavior:</strong> If <code>Not IsEmpty(args)</code> attempts <code>UBound-LBound+1</code> under On Error. Returns 0 on any error or when empty. <br><strong>Complexity:</strong> O(1).<br><strong>Tests:</strong> Call with 0..n args and ensure result correct. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>CreateObjectSafe(progId As String) As Object</strong> — <em>defensive CreateObject wrapper</em><br><strong>Purpose:</strong> Try <code>CreateObject(progId)</code> and return object or Nothing on failure, swallowing errors. Simplifies optional COM creation logic across module.<br><strong>Signature:</strong> <code>Private Function CreateObjectSafe(ByVal progId As String) As Object</code> → Object or Nothing.<br><strong>Behavior:</strong> <code>On Error GoTo ErrHandler</code> attempts CreateObject, returns object; on error clears Err and returns Nothing. <br><strong>Complexity:</strong> O(1).<br><strong>Tests:</strong> Test with known registered COM progId and an invalid string. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>IsMac() As Boolean</strong> — <em>OS hint helper</em><br><strong>Purpose:</strong> Return True when <code>Application.OperatingSystem</code> appears to contain "Mac" to help branch host-specific code paths (OnTime scheduling, qualified proc names).<br><strong>Signature:</strong> <code>Private Function IsMac() As Boolean</code> → Boolean.<br><strong>Behavior:</strong> Calls <code>SafeString(Application.OperatingSystem)</code> and <code>InStr(...,&quot;Mac&quot;,vbTextCompare)&gt;0</code>. Errors are cleared. <br><strong>Complexity:</strong> O(1).<br><strong>Tests:</strong> Mock Application.OperatingSystem containing "Mac" and other strings. <br><strong>Notes:</strong> OS string parsing is heuristic; keep central for consistent behavior. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>TryCancelOnTime(whenTime As Date, procName As String)</strong> — <em>idempotent OnTime cancellation helper</em><br><strong>Purpose:</strong> Cancel <code>Application.OnTime</code> scheduled calls; attempt workbook-qualified cancellation first (Windows) then unqualified; tolerant to errors and multiple calls.<br><strong>Signature:</strong> <code>Private Sub TryCancelOnTime(ByVal whenTime As Date, ByVal procName As String)</code> — no return.<br><strong>Behavior:</strong> If <code>procName</code> empty returns. If not IsMac and <code>ThisWorkbook</code> accessible tries qualified cancellation: <code>Application.OnTime EarliestTime:=whenTime, Procedure:=&quot;&#x27;ThisWorkbook.Name&#x27;!procName&quot;, Schedule:=False</code>. Always attempts unqualified cancellation afterwards. Swallows errors. <br><strong>Complexity:</strong> O(1).<br><strong>Side-effects:</strong> Cancels scheduled OnTime if matching parameters found. <br><strong>Tests:</strong> Schedule and then cancel; call twice to validate idempotency. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>IsSensitiveKey(key As String) As Boolean</strong> — <em>heuristic sensitive key detector</em><br><strong>Purpose:</strong> Detect keys that likely contain secrets (password, token, api key, pwd) to trigger redaction in <code>WriteMetaValue</code>.<br><strong>Signature:</strong> <code>Private Function IsSensitiveKey(ByVal key As String) As Boolean</code> → Boolean.<br><strong>Behavior:</strong> Lowercases key and tests <code>InStr</code> for patterns <code>&quot;pass&quot;</code>, <code>&quot;secret&quot;</code>, <code>&quot;token&quot;</code>, <code>&quot;api&quot; &amp; &quot;key&quot;</code>, <code>&quot;pwd&quot;</code>. Returns True if any matched. <br><strong>Complexity:</strong> O(len(key)).<br><strong>Failure modes:</strong> Heuristic may miss or false-positive some keys; maintain carefully. <br><strong>Tests:</strong> Provide keys like <code>&quot;ApiKey&quot;</code>, <code>&quot;password&quot;</code>, <code>&quot;user_token&quot;</code> and confirm detection. <br><strong>Notes:</strong> If adding other secret patterns add here and include test coverage. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>AddSensitiveKeyMarker(key As String)</strong> — <em>record sensitive key name in <code>SensitiveKeys</code> meta value</em><br><strong>Purpose:</strong> Maintain an index of sensitive keys stored in metadata (not raw value) so operators can review masked entries.<br><strong>Signature:</strong> <code>Private Sub AddSensitiveKeyMarker(ByVal key As String)</code> — no return.<br><strong>Behavior:</strong> Reads existing <code>SensitiveKeys</code> meta via <code>ReadMetaValue</code>, performs case-insensitive containment check, appends the key if not present, and writes back via <code>WriteMetaValue</code>. <code>On Error Resume Next</code> guards. <br><strong>Complexity:</strong> O(1).<br><strong>Side-effects:</strong> Writes metadata. <br><strong>Tests:</strong> Add multiple keys and confirm non-duplication and presence. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>AddIn_RunInternalTests()</strong> — <em>developer/internal CI-style lightweight tests runner</em><br><strong>Purpose:</strong> Run small built-in tests for CRC table, metadata read/write, SafeRun behaviour and write results to <code>_IFRS_TestResults</code> sheet. Designed for manual or CI invocation.<br><strong>Signature:</strong> <code>Public Sub AddIn_RunInternalTests()</code> — no return.<br><strong>Behavior:</strong> Builds <code>results()</code> array with tests: CRC basic vector non-zero, Metadata R/W test (<code>WriteMetaValue</code> + <code>ReadMetaValue</code>), SafeRun non-existent proc check expected False. Appends results via <code>AppendTestResult</code> and audits completion. Handles errors via <code>Bootstrap_HandleError</code>.<br><strong>Complexity:</strong> O(1) plus I/O to metadata/test sheet. <br><strong>Side-effects:</strong> Writes to <code>_IFRS_TestResults</code> sheet and metadata. <br><strong>Failure modes:</strong> Sheet creation may fail, tests might assume environment features; handle gracefully. <br><strong>Recommended tests:</strong> Already built-in; maintain expected pass/fail semantics. <br><strong>Notes:</strong> Keep tests stable and non-destructive; avoid tests that mutate production data. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>AppendTestResult(text As String)</strong> — <em>append a result row into <code>_IFRS_TestResults</code> sheet</em><br><strong>Purpose:</strong> Helper to persist test run rows with timestamp and result text (used by <code>AddIn_RunInternalTests</code>).<br><strong>Signature:</strong> <code>Private Sub AppendTestResult(ByVal text As String)</code> — no return.<br><strong>Behavior:</strong> Ensures <code>_IFRS_TestResults</code> exists, sets it VeryHidden if possible, ensures headers, and appends <code>Timestamp</code> and <code>Result</code> rows. Errors printed to Debug.Print. <br><strong>Complexity:</strong> O(1).<br><strong>Tests:</strong> Run <code>AddIn_RunInternalTests</code> and verify appended rows. </td></tr><tr><td data-label="Technical breakdown (modBootstrap)"> <strong>Misc notes: cross-cutting behaviors & maintainers checklist</strong><br>- <strong>Idempotency:</strong> Public lifecycle entrypoints (<code>AddIn_Initialize</code>, <code>AddIn_DeferredInit</code>, <code>AddIn_Shutdown</code>) are defensive and idempotent; maintain that property when changing behaviour.<br>- <strong>SafeRun contract:</strong> <code>SafeRun</code> and <code>SafeRunWithResult</code> are canonical external-call gates — use them for all optional cross-module calls to avoid hard dependencies. Maintain the workbook-qualified-first strategy for deterministic resolution on Windows.<br>- <strong>Metadata safety:</strong> <code>WriteMetaValue</code> performs size truncation and redaction for sensitive keys. Keep <code>IsSensitiveKey</code> heuristics up-to-date if new secret patterns appear.<br>- <strong>Audit / Error forwarding:</strong> Audit attempts remote <code>LogAudit</code> and <code>HandleError</code> via <code>SafeRun</code> and falls back to local worksheets. This dual-path design ensures offline safety but requires operators to inspect <code>_IFRS_Audit</code> when remote logging fails.<br>- <strong>COM & host differences:</strong> All COM calls are guarded via <code>CreateObjectSafe</code> and <code>On Error</code> to tolerate limited hosts (e.g., Excel for Mac, protected workbooks, or constrained runtime). Do not add unguarded COM calls.<br>- <strong>Worker expectations & public API stability:</strong> Public functions and their signatures (listed near top) must not be renamed without updating callers. In particular <code>AddIn_Initialize</code>, <code>AddIn_DeferredInit</code>, <code>AddIn_Shutdown</code>, <code>AddIn_GetState</code>, <code>AddIn_RunInternalTests</code> are part of the public surface.<br>- <strong>Telemetry & PII:</strong> Audit logs include <code>Application.UserName</code>; decide whether to redact or avoid depending on privacy policy. Metadata may contain masked sensitive keys but indices to them (<code>SensitiveKeys</code>) are preserved for operator visibility.<br>- <strong>Testing matrix:</strong> Unit tests should verify all host branches: typical Excel desktop Windows, Excel for Mac, protected workbook (simulate permission failure), and COM absence (e.g., ADODB unregistered). Also add CI check that runs <code>AddIn_RunInternalTests</code> in a sandboxed environment.<br>- <strong>Migration caution:</strong> CRC-derived <code>g_bootstrapId</code> is used in many persisted audit rows and metadata; changing id composition will break historical correlation. Document any change and add migration mapping if necessary. </td></tr></tbody></table></div><div class="row-count">Rows: 41</div></div><script src="assets/xlsx.full.min.js?v=1758605028" defer></script>
<script src="assets/script.js?v=1759748863" defer></script>
<script src="assets/worker.js?v=1758331710" defer></script>
<script>
(function(){
  const template = "{table}_{date}";
  const userVal = "";
  const hrefPrefix = "assets";
  function formatName(tableName) {
    const date = (new Date()).toISOString().slice(0,10);
    return template.replace('{table}', tableName).replace('{date}', date).replace('{user}', userVal);
  }
  const btn = document.getElementById('exportBtn');
  if(btn) {
    btn.addEventListener('click', async function() {
      try {
        const html = document.documentElement.outerHTML;
        if(html.length > 2000000) { alert('Export refused: html too large'); return; }
        if(window.Worker) {
          const workerUrl = (function(){ try{ return hrefPrefix + '/worker.js'; }catch(e){ return null; } })();
          if(workerUrl) {
            try {
              const worker = new Worker(workerUrl);
              worker.postMessage({html: html, format: 'pdf'});
              worker.onmessage = function(e) { console.log('worker:', e.data); alert('Worker replied: '+(e.data.msg||e.data.status)); };
            } catch(err) { console.warn('Worker create failed', err); alert('Worker not available'); }
          } else { alert('Worker not available'); }
        } else { alert('Export worker not supported in this environment.'); }
      } catch(err) { console.warn('Export failed', err); alert('Export worker not available. See console for details.'); }
    });
  }
})();
window.addEventListener('load', function(){ try{ document.querySelectorAll('.table-wrapper').forEach(function(e){ e.style.opacity='1'; }); }catch(e){} });
</script>
</div>
</body>
</html>